import{a as V}from"./chunk-QFLALGDP.js";import{a as R,b as _,c as B}from"./chunk-AKJLP3M7.js";import{a as H}from"./chunk-DB4Z3R2Q.js";import{a as K}from"./chunk-6KWLTABS.js";import{a as W}from"./chunk-3O3XXTRY.js";import{a as z}from"./chunk-T4GATEJX.js";import{a as L}from"./chunk-MIAUYZNE.js";import{a as v}from"./chunk-TM5LHTOQ.js";import{a as w}from"./chunk-4YTM754S.js";import{b as G}from"./chunk-NX5B6XBR.js";import{b as d,c as Z}from"./chunk-6RBQSBA2.js";import{a as A}from"./chunk-E7AX56GD.js";import{a as P}from"./chunk-MIS6QMFE.js";import{a as F}from"./chunk-7F5DJLJT.js";import{b as E}from"./chunk-BAEF3CT6.js";import{o as j}from"./chunk-AUAZP44J.js";import{f as D}from"./chunk-CCJU4DSH.js";import{a as f}from"./chunk-QGVBCWUY.js";import{e as S}from"./chunk-NFIPKH6V.js";import{l as M}from"./chunk-5QEXLALV.js";import{o as y,u as N}from"./chunk-4PTIEWMT.js";import{a as n,b as m,f as l}from"./chunk-VTHXE323.js";function we(t,e,s,r,o){return l(this,null,function*(){let a={},i={},c=[];return ae(r,c,a),G(c).then(b=>{let{outSpatialReference:h,processExtent:g,processSpatialReference:u,returnColumnName:J,returnFeatureCollection:O,returnM:Q,returnZ:X}=s,{path:Y}=d(t);for(let U in a){let[re,se]=a[U];i[U]=b.slice(re,se)}let k=h?h.wkid||h:null,q=u?u.wkid||u:null,ee=e==="execute"?{returnColumnName:J||void 0,returnFeatureCollection:O||void 0,returnM:Q||void 0,returnZ:X||void 0}:null,te=T(m(n(n(n({},g?{context:{extent:g,outSR:k,processSR:q}}:{"env:outSR":k,"env:processSR":q}),r),ee),{f:"json"}),null,i),oe=m(n({},o),{query:te});return j(`${Y}/${e}`,oe)})})}function ae(t,e,s){for(let r in t){let o=t[r];if(o&&typeof o=="object"&&o instanceof w){let{features:a}=o;s[r]=[e.length,e.length+a.length],a.forEach(i=>{e.push(i.geometry)})}}}function x(t,e){return l(this,null,function*(){switch(t){case"areal-unit":return L.fromJSON(e);case"boolean":case"double":case"long":case"string":case"value-table":return e;case"date":return new Date(e);case"data-file":return v.fromJSON(e);case"linear-unit":return V.fromJSON(e);case"feature-record-set-layer":if("url"in e)return v.fromJSON(e);if("layerDefinition"in e){let s=new(yield import("./chunk-BMWHS32V.js")).default,{layerDefinition:r,featureSet:o}=e;return s.read({layerDefinition:r,featureSet:o},{origin:"portal-item"}),s.spatialReference=F.fromJSON(o.spatialReference??r.spatialReference??r.extent.spatialReference),s}return w.fromJSON(e);case"record-set":return"url"in e?v.fromJSON(e):w.fromJSON(e);case"raster-data":case"raster-data-layer":return"mapImage"in e?z.fromJSON(e.mapImage):H.fromJSON(e);case"field":return A.fromJSON(e)}})}function ie(t){return t.startsWith(R)}function ne(t){return t.replace(R,"")}function ce(t,e){return l(this,null,function*(){let s=ne(t),r=s==="composite"?e.map(o=>x(_.fromJSON(o.dataType),o.value)):e.map(o=>x(s,o));return Promise.all(r)})}function I(t){return l(this,null,function*(){let e=_.fromJSON(t.dataType),{paramName:s}=t,r=ie(e)?yield ce(e,t.value):yield x(e,t.value);return new B({dataType:e,paramName:s,value:r})})}function T(t,e,s){for(let r in t){let o=t[r];Array.isArray(o)?t[r]=JSON.stringify(o.map(a=>T({item:a},!0).item)):o instanceof Date&&(t[r]=o.getTime())}return Z(t,e,s)}var C,le=E()({esriJobCancelled:"job-cancelled",esriJobCancelling:"job-cancelling",esriJobDeleted:"job-deleted",esriJobDeleting:"job-deleting",esriJobTimedOut:"job-timed-out",esriJobExecuting:"job-executing",esriJobFailed:"job-failed",esriJobNew:"job-new",esriJobSubmitted:"job-submitted",esriJobSucceeded:"job-succeeded",esriJobWaiting:"job-waiting"},{ignoreUnknown:!1}),$=1e3,p=C=class extends D{constructor(t){super(t),this.jobId=null,this.jobStatus=null,this.messages=null,this.progress=null,this.requestOptions=null,this.sourceUrl=null,this._cancelJobTimer=void 0,this._jobCompletionTimer=void 0}cancelJob(t){return l(this,null,function*(){let{jobId:e,sourceUrl:s}=this,{path:r}=d(s),o=m(n(n({},this.requestOptions),t),{query:{f:"json"}}),a=`${r}/jobs/${e}/cancel`,{data:i}=yield j(a,o),{messages:c,jobStatus:b,progress:h}=C.fromJSON(i);return this.set({messages:c,jobStatus:b,progress:h}),b==="job-cancelled"?this:new Promise((g,u)=>{N(o.signal,()=>{this.clearCancelJobTimer(),u(y())}),this.clearCancelJobTimer();let J=()=>{this._cancelJobTimer||u(y()),this.checkJobStatus(t).then(({jobStatus:O})=>{switch(O){case"job-cancelling":default:this._cancelJobTimer=setTimeout(J,$);break;case"job-deleted":case"job-deleting":case"job-executing":case"job-failed":case"job-new":case"job-submitted":case"job-succeeded":case"job-timed-out":case"job-waiting":u(this);break;case"job-cancelled":g(this)}})};this._cancelJobTimer=setTimeout(J,$)})})}destroy(){clearInterval(this._cancelJobTimer),clearInterval(this._jobCompletionTimer)}checkJobStatus(t){return l(this,null,function*(){let{path:e}=d(this.sourceUrl),s=m(n(n({},this.requestOptions),t),{query:{f:"json"}}),r=`${e}/jobs/${this.jobId}`,{data:o}=yield j(r,s),{messages:a,jobStatus:i,progress:c}=C.fromJSON(o);return this.set({messages:a,jobStatus:i,progress:c}),this})}fetchResultData(t,e,s){return l(this,null,function*(){e=W.from(e||{});let{returnColumnName:r,returnFeatureCollection:o,returnM:a,returnZ:i,outSpatialReference:c}=e,{path:b}=d(this.sourceUrl),h=T({returnColumnName:r||null,returnFeatureCollection:o||null,returnM:a||null,returnZ:i||null,outSR:c,returnType:"data",f:"json"},null),g=m(n(n({},this.requestOptions),s),{query:h}),u=`${b}/jobs/${this.jobId}/results/${t}`,{data:J}=yield j(u,g);return I(J)})}fetchResultImage(t,e,s){return l(this,null,function*(){let{path:r}=d(this.sourceUrl),o=m(n({},e.toJSON()),{f:"json"}),a=T(o),i=m(n(n({},this.requestOptions),s),{query:a}),c=`${r}/jobs/${this.jobId}/results/${t}`,{data:b}=yield j(c,i);return I(b)})}fetchResultMapImageLayer(){return l(this,null,function*(){let{path:t}=d(this.sourceUrl),e=t.indexOf("/GPServer/"),s=`${t.slice(0,Math.max(0,e))}/MapServer/jobs/${this.jobId}`;return new(yield import("./chunk-CXAJY6IL.js")).default({url:s})})}waitForJobCompletion(){return l(this,arguments,function*(t={}){let{interval:e=$,signal:s,statusCallback:r}=t;return new Promise((o,a)=>{N(s,()=>{this.clearJobCompletionTimer(),a(y())}),this.clearJobCompletionTimer();let i=()=>{this._jobCompletionTimer||a(y()),this.checkJobStatus().then(({jobStatus:c})=>{switch(c){case"job-succeeded":o(this);break;case"job-executing":case"job-new":case"job-submitted":case"job-waiting":r&&r(this),this._jobCompletionTimer=setTimeout(i,e);break;case"job-cancelled":case"job-cancelling":case"job-deleted":case"job-deleting":case"job-failed":case"job-timed-out":a(this);break;default:this._jobCompletionTimer=setTimeout(i,e)}}).catch(c=>{a(c)})};this._jobCompletionTimer=setTimeout(i,e)})})}clearCancelJobTimer(){clearTimeout(this._cancelJobTimer),this._cancelJobTimer=void 0}clearJobCompletionTimer(){clearTimeout(this._jobCompletionTimer),this._jobCompletionTimer=void 0}};f([S()],p.prototype,"jobId",void 0),f([P(le,{ignoreUnknown:!1})],p.prototype,"jobStatus",void 0),f([S({type:[K]})],p.prototype,"messages",void 0),f([S()],p.prototype,"progress",void 0),f([S()],p.prototype,"requestOptions",void 0),f([S({json:{write:!0}})],p.prototype,"sourceUrl",void 0),p=C=f([M("esri.rest.support.JobInfo")],p);var Ae=p;export{we as a,I as b,Ae as c};
