import{a as w}from"./chunk-QPTUNF56.js";import{a as L}from"./chunk-GAHBFBUT.js";import{a as O,b as C,d as b,g as B,i as V,j as I,k as D}from"./chunk-7XT4ARBK.js";import{a as F}from"./chunk-BJOICJ5R.js";import{a as x}from"./chunk-TFO72JMF.js";import{a as _}from"./chunk-LORHDXEB.js";import{a as u,e as g,j as v}from"./chunk-TG45K3WR.js";import{b as d}from"./chunk-ACP3S2CH.js";import{a as s}from"./chunk-QGVBCWUY.js";import{H as y}from"./chunk-MYO4NP2N.js";import{e as r}from"./chunk-NFIPKH6V.js";import{l as p}from"./chunk-5QEXLALV.js";import{y as f}from"./chunk-4PTIEWMT.js";import{g as S}from"./chunk-XRGPJ3QY.js";import{f as c}from"./chunk-VTHXE323.js";var l=class extends y{constructor(e){super(e),this.id="root",this.parent=null,this.children=new d,this.layers=new d,this.level=0,this._childIds=new Set,this._layerUniqueIds=new Set}initialize(){this.addHandles([this.layers.on("before-add",e=>{this._layerUniqueIds.has(e.item.uid)?e.preventDefault():this._layerUniqueIds.add(e.item.uid)}),this.layers.on("after-add",({item:e})=>{this.addHandles([u(()=>e.visible,()=>this.notifyChange("visible"),v),u(()=>e.title,()=>this.notifyChange("title"),v)],e.uid)}),this.layers.on("before-remove",({item:e})=>{this.removeHandles(e.uid),this.notifyChange("title"),this.notifyChange("visible")}),this.children.on("before-add",e=>{this._childIds.has(e.item.id)?e.preventDefault():(e.item._set("parent",this),this._childIds.add(e.item.id))})])}destroy(){this.children.forEach(e=>e.destroy())}get hasChildren(){return this.children.length>0}get isDiscipline(){return this.level===1}get visible(){return H(this.layers,e=>e.visible)}get title(){return H(this.layers,e=>e.title)||this.layers.items.map(e=>e.title).join(", ")||null}toggleVisibility(e){let t=e===void 0?!this.visible:e;this.layers.forEach(i=>{i.visible=t}),t&&this.parent!=null&&this.parent.toggleVisibility(!0)}toggleAllSiblingsVisibility(e){let t=e===void 0?!this.visible:e;this.toggleVisibility(t),this.parent!=null&&(this.parent.toggleVisibility(t),this.parent.children.forEach(i=>i.toggleVisibility(t)))}};function H(e,t){let i=null;for(let o of e.items){let a=t(o);if(i!=null&&i!==a)return null;i=a}return i}s([r({nonNullable:!0})],l.prototype,"id",void 0),s([r()],l.prototype,"parent",void 0),s([r({nonNullable:!0,readOnly:!0})],l.prototype,"children",void 0),s([r({nonNullable:!0,readOnly:!0})],l.prototype,"layers",void 0),s([r({nonNullable:!0})],l.prototype,"level",void 0),s([r({readOnly:!0})],l.prototype,"hasChildren",null),s([r({readOnly:!0})],l.prototype,"isDiscipline",null),s([r({readOnly:!0})],l.prototype,"visible",null),s([r({readOnly:!0})],l.prototype,"title",null),l=s([p("esri.widgets.BuildingExplorer.support.LayerTreeNode")],l);var m=class extends y{constructor(e){super(e),this.root=new l,this.state="disabled",this._loadLayers=b(),this.layers=new d}initialize(){this.addHandles(this.layers.on("change",()=>this._onLayersChange())),this._onLayersChange()}destroy(){this._set("state","disabled"),this.root.destroy()}set layers(e){let t=this._get("layers");this._set("layers",_(e,t))}_updateLayerTree(){this.root.destroy(),this._set("root",new l);let e=new Map,t=this.layers.length>1?"modelName":"id";return this.layers.forEach(i=>{let o=O(i);this._addNodesForSublayers(o??i,this.root,e,t)}),this}_addNodeForLayer(e,t,i,o){let a=String(e[o]).toLowerCase();if(a==null||e.isEmpty)return;let N=`${t.id}/${a}`,h=i.get(N);h||(h=new l({id:a,level:t.level+1}),i.set(N,h)),h.layers.push(e),t.children.push(h),this._addNodesForSublayers(e,h,i,o)}_addNodesForSublayers(e,t,i,o){(e.type==="building-scene"||e.type==="building-group"&&!e.isEmpty)&&e.sublayers.forEach(a=>this._addNodeForLayer(a,t,i,o))}_onLayersChange(){return c(this,null,function*(){if(this._set("state","loading"),this.layers.length!==0)try{yield this._loadLayers(this.layers),this._updateLayerTree(),this._set("state","ready")}catch(e){f(e)||this._set("state","failed")}})}};s([r({readOnly:!0})],m.prototype,"root",void 0),s([r({type:d,nonNullable:!0})],m.prototype,"layers",null),s([r({readOnly:!0,nonNullable:!0})],m.prototype,"state",void 0),m=s([p("esri.widgets.BuildingExplorer.BuildingDisciplinesViewModel")],m);var E=m;var n=class extends y{constructor(e){super(e),this.view=null,this.state="disabled",this.level=new w,this.phase=new L,this.disciplines=new E,this._loadLayers=b(),this.layers=new d}initialize(){this.addHandles([this.layers.on("change",()=>this._onLayersChange()),u(()=>({state:this.state,layers:this.layers,filter:this._filter}),({state:e,layers:t,filter:i})=>{e==="ready"&&V(t,i)},{initial:!0})]),this._onLayersChange()}destroy(){this.level.destroyed||this.level.destroy(),this.phase.destroyed||this.phase.destroy(),this.disciplines.destroyed||this.disciplines.destroy()}get isSupported(){return this.view?.type==="3d"}get layers(){return this._get("layers")}set layers(e){let t=e.filter(i=>i instanceof F);t.length!==e.length&&S.getLogger(this).error("Some layers are not BuildingSceneLayers but only BuildingSceneLayers can be passed to the widget."),this._set("layers",_(t,this._get("layers")))}get _filter(){let e=this.level.filterExpressions,t=this.phase.filterExpressions,i=[],o=D([e.solid,t.solid]);o!=null&&i.push(o);let a=I([e.xRay,t.xRay]);return a!=null&&i.push(a),i.length===0?null:new x({id:B(),name:"Building Explorer Filter",filterBlocks:i})}_onLayersChange(){return c(this,null,function*(){let e=this.layers;if(this.level.layers=e,this.phase.layers=e,this.disciplines.layers=e,e.length!==0){this._set("state","loading");try{yield this._loadLayers(e),yield Promise.all([g(()=>this.level.state==="ready"),g(()=>this.phase.state==="ready"),g(()=>this.disciplines.state==="ready")]),e.forEach(C),this._set("state","ready")}catch(t){f(t)||this._set("state","failed")}}else this._set("state","disabled")})}};s([r({value:null})],n.prototype,"view",void 0),s([r()],n.prototype,"isSupported",null),s([r({type:d,nonNullable:!0})],n.prototype,"layers",null),s([r({readOnly:!0})],n.prototype,"state",void 0),s([r({readOnly:!0,type:w})],n.prototype,"level",void 0),s([r({readOnly:!0,type:L})],n.prototype,"phase",void 0),s([r({readOnly:!0,type:E})],n.prototype,"disciplines",void 0),s([r()],n.prototype,"_filter",null),n=s([p("esri.widgets.BuildingExplorer.BuildingExplorerViewModel")],n);var Fe=n;export{l as a,Fe as b};
