import{a as Y}from"./chunk-4RIP5SWC.js";import{b as X}from"./chunk-VEL25CVB.js";import{a as te}from"./chunk-ISXQQRNZ.js";import{a as V,b}from"./chunk-Y7IXEVFJ.js";import{a as I}from"./chunk-6IXNUXNR.js";import{a as ee}from"./chunk-KNAABRJH.js";import{a as w}from"./chunk-RVXDLN3U.js";import{a as d}from"./chunk-EBLTZITF.js";import{a as H}from"./chunk-XB5YLDHB.js";import{a as Q}from"./chunk-H7EBUK3L.js";import{a as q}from"./chunk-5JVT33KX.js";import{a as z}from"./chunk-PPBOBNTL.js";import{a as M}from"./chunk-F7UGNZLD.js";import{a as C}from"./chunk-JAM5M2OZ.js";import{a as y}from"./chunk-WDTJILD4.js";import{a as W}from"./chunk-H25DKJGS.js";import{a as D}from"./chunk-BEONHHQH.js";import{g as Z}from"./chunk-6DALCDDU.js";import{a as _}from"./chunk-CELWVZPW.js";import{a as G}from"./chunk-2GJBUR2F.js";import{a as K}from"./chunk-DKGGDYJI.js";import{a as J}from"./chunk-IR6XCBC4.js";import{a as v}from"./chunk-PEW2PLAN.js";import{i as $}from"./chunk-Q6Y4JG7Q.js";import{a as S}from"./chunk-7F5DJLJT.js";import{a as c}from"./chunk-CX5IFQZJ.js";import{a as N}from"./chunk-4N4D2YQX.js";import{c as j}from"./chunk-KNVXE32P.js";import{E as R,H as T,_ as E}from"./chunk-76ATOSLU.js";import{c as F}from"./chunk-CCJU4DSH.js";import{e as B}from"./chunk-TG45K3WR.js";import{b as k}from"./chunk-ACP3S2CH.js";import{a as s}from"./chunk-QGVBCWUY.js";import{e as p}from"./chunk-NFIPKH6V.js";import{l as L}from"./chunk-5QEXLALV.js";import{K as U,b as O}from"./chunk-4PTIEWMT.js";import{b as f}from"./chunk-YOFFGXOB.js";import{g}from"./chunk-XRGPJ3QY.js";import{y as x}from"./chunk-QBWJMFH5.js";import{a as u,b as h,f as m}from"./chunk-VTHXE323.js";function re(e,t){return t.resourceInfo?ie(t,t.resourceInfo,{origin:e.origin}):t.portalItem?.id?ne(e,t,t.portalItem):Promise.resolve()}function ie(e,t,r){let i={context:h(u({},r),{layerContainerType:"operational-layers"})};return e.portalItem&&(i.context.portal=e.portalItem.portal||K.getDefault()),import("./chunk-4PI6XTSR.js").then(({populateOperationalLayers:o})=>{let n=[],l=t.operationalLayers;l?.length&&n.push(o(e.layers,l,i));let A=h(u({},i),{context:h(u({},i.context),{layerContainerType:"tables"}),defaultLayerType:"ArcGISFeatureLayer"}),P=t.tables;return P?.length&&n.push(o(e.tables,P,A)),Promise.allSettled(n).then(()=>{})})}function ne(e,t,r){return m(this,null,function*(){if(yield r.load().catch(l=>{throw new f(`${e.name}:load-portal-item`,"Failed to load portal item",{error:l})}),r.type!==e.itemType)throw new f(`${e.name}:invalid-portal-item`,`Invalid portal item type '${r.type}', expected '${e.itemType}'`,{type:r.type});let i=yield r.fetchData();t.resourceInfo=i;let o=D(r,e.origin);yield ae(e,t,i,o),t.resourceReferences={portalItem:r,paths:o.readResourcePaths};let n=yield le(t.initialViewProperties,r,g.getLogger(t));if(n){let l=t.initialViewProperties?.clone()??e.createInitialViewProperties();l.viewpoint=n,t.initialViewProperties=l}})}function ae(e,t,r,i){let o=se(e,r);return t.read(o,i),ie(t,o,i)}function se(e,t){let r=e.parseVersion(t.version||"",e.name);return e.currentVersion.validate(r),t.version=`${r.major}.${r.minor}`,t}function le(e,t,r){return m(this,null,function*(){if(e?.viewpoint?.targetGeometry)return null;let o=yield pe(e,t,r);return o?new d({targetGeometry:o}):null})}function pe(e,t,r){return m(this,null,function*(){let i=e?.spatialReference,o=t?.extent;if(!i||!o)return null;if(i.isWGS84)return o.clone();if(i.isWebMercator)return $(o);let{getGeometryServiceURL:n}=yield import("./chunk-AHOTZDCZ.js");try{let l=yield n(t),A=new C({geometries:[o],outSpatialReference:i});return(yield z(l,A))[0]}catch(l){r.error("Error projecting item's extent:",l)}return null})}var oe=k.ofType(te),me=new Map([["image/jpeg","jpeg"],["image/jpg","jpg"],["image/png","png"],["image/gif","gif"]]),ue="ArcGIS Pro",he=Z.JSAPI,a=class extends W(J.LoadableMixin(N.EsriPromiseMixin(Q))){constructor(e){super(e),this._isAuthoringAppSetByUser=!1,this._isAuthoringAppVersionSetByUser=!1,this._thumbnailFilename=null,this._updateFromPromise=null,this.resourceReferences={portalItem:null,paths:[]},this.applicationProperties=null,this.bookmarks=new oe,this.floorInfo=null,this.initialViewProperties=new b,this.portalItem=null,this.sourceVersion=null,this.widgets=null,this._debouncedSaveOperations=U((t,r,i)=>m(this,null,function*(){let{save:o,saveAs:n}=yield import("./chunk-URL27GFK.js");switch(t){case y.SAVE:return o(this.context,this,r);case y.SAVE_AS:return n(this.context,this,i,r)}})),this.authoringApp=this.authoringAppVersion=null,this._isAuthoringAppSetByUser=this._isAuthoringAppVersionSetByUser=!1}destroy(){this.portalItem=O(this.portalItem)}initialize(){if(this.when().catch(e=>{g.getLogger(this).error("#load()","Failed to load web map",e)}),this.resourceInfo){let e;try{e=this._validateJSON(this.resourceInfo)}catch(t){return void this.addResolvingPromise(Promise.reject(t))}this.read(e)}}set authoringApp(e){this._isAuthoringAppSetByUser=!0,this._set("authoringApp",e)}writeAuthoringApp(e,t){e&&this._isAuthoringAppSetByUser?t.authoringApp=e:t.authoringApp=he}set authoringAppVersion(e){this._isAuthoringAppVersionSetByUser=!0,this._set("authoringAppVersion",e)}writeAuthoringAppVersion(e,t){e&&this._isAuthoringAppVersionSetByUser?t.authoringAppVersion=e:t.authoringAppVersion=j}readInitialViewProperties(e,t){let r=new b;t.background&&(r.background=I.fromJSON(t.background));let i=t.initialState?.timeExtent;i&&(r.timeExtent=_.fromArray(i));let o=t.initialState?.viewpoint;return o&&(o.rotation&&w.parse(t.version||"","webmap").lessThan(2,20)&&t.authoringApp===ue&&(o.rotation*=-1),r.viewpoint=d.fromJSON(o)),t.mapRangeInfo&&(r.rangeInfo=V.fromJSON(t.mapRangeInfo)),t.spatialReference&&(r.spatialReference=S.fromJSON(t.spatialReference)),t.timeZone&&(r.timeZone=t.timeZone),r}writeInitialViewProperties(e,t,r,i){if(!e)return;e.background?.color&&(t.background=e.background.write({},i));let{timeExtent:o,viewpoint:n}=e;if(n||o){let l={};n&&(l.viewpoint=n.write({},i)),o&&(l.timeExtent=o.toArray()),t.initialState=l}e.rangeInfo&&(t.mapRangeInfo=e.rangeInfo.toJSON(i)),e.spatialReference&&(t.spatialReference=e.spatialReference.write({},i)),t.timeZone=e.timeZone}writeLayers(e,t,r,i){t[r]=this._writeLayers(e,i,"operational-layers")}readSourceVersion(e,t){let[r,i]=t.version.split(".");return new w(parseInt(r,10),parseInt(i,10))}writeSourceVersion(e,t,r){t[r]=`${this.context.currentVersion.major}.${this.context.currentVersion.minor}`}writeTables(e,t,r,i){let o=this._writeLayers(e,i,"tables");o.length&&(t[r]=o)}get thumbnailUrl(){return this.portalItem?.thumbnailUrl||null}set thumbnailUrl(e){e?(this._override("thumbnailUrl",e),this._thumbnailFilename=this._generateCustomThumbnailFilename(e)):this._clearThumbnailOverride()}get updatingFromView(){return!!this._updateFromPromise}load(e){return this.addResolvingPromise(re(this.context,this)),Promise.resolve(this)}loadAll(){return M(this,e=>{e(this.ground,this.basemap,this.layers,this.tables)})}read(e,t){t=h(u({},t),{origin:this.context.origin});let r=this._getAuthoringPropsState();F(this,e,i=>super.read(e,i),t),this._restoreAuthoringPropsFromState(r)}write(e,t){if(this.loadStatus!=="loaded"){let r=new f("webmap:not-loaded","Web map must be loaded before it can be serialized");throw g.getLogger(this).error("#toJSON()","Web map must be loaded before it can be serialized",this.loadError||this.loadStatus),r}return this._removeDanglingLayerRefs(),t=h(u({},t),{origin:this.context.origin,restrictedWebMapWriting:!0,webmap:this}),super.write(e,t)}save(e){return m(this,null,function*(){return this._debouncedSaveOperations(y.SAVE,e)})}saveAs(e,t){return m(this,null,function*(){return this._debouncedSaveOperations(y.SAVE_AS,t,e)})}updateFrom(e,t){return m(this,null,function*(){let r=this._updateFromInternal(e,t);this._updateFromPromise=r,yield r,r===this._updateFromPromise&&(this._updateFromPromise=null)})}getLayerJSONFromResourceInfo(e){let t=this.resourceInfo;return this._collectAllLayersJSON([...t?.baseMap?.baseMapLayers||[],...t?.operationalLayers||[],...this.basemap?.resourceInfo?.data?.baseMapLayers||[]]).find(r=>r.id===e.id)}updateItemThumbnail(){return m(this,null,function*(){this.thumbnailUrl&&this._isOverridden("thumbnailUrl")&&(yield this.portalItem?.updateThumbnail({thumbnail:this.thumbnailUrl,filename:this._thumbnailFilename}),this._clearThumbnailOverride())})}getThumbnailState(){let e=this.thumbnailUrl;return e&&(e=this._isOverridden("thumbnailUrl")?e:E(e,"w","8192")),{thumbnailUrl:e,filename:this._thumbnailFilename}}restoreThumbnailFromState(e){this.thumbnailUrl=e.thumbnailUrl,this._thumbnailFilename=e.filename}_collectAllLayersJSON(e){return e.reduce((t,r)=>(t.push(r),r.layerType==="GroupLayer"&&(t=t.concat(this._collectAllLayersJSON(r.layers||[]))),t),[])}_writeLayers(e,t,r){return t=h(u({},t),{layerContainerType:r}),e.map(i=>q(i,r==="tables"?null:this.getLayerJSONFromResourceInfo(i),t)).filter(x).toArray()}_validateJSON(e){let t=w.parse(e.version||"","webmap");return this.context.currentVersion.validate(t),e.version=`${t.major}.${t.minor}`,e}_removeDanglingLayerRefs(){let e=this.applicationProperties,t=e?.viewing?.search,r=n=>this.allLayers.some(l=>l.id===n);if(t?.layers&&(t.layers=t.layers.filter(n=>r(n.id))),t?.tables&&(t.tables=t.tables.filter(n=>this.tables.some(l=>l.id===n.id))),e){let n=e.editing?.locationTracking;n?.info&&!r(n.info.layerId)&&(e.editing=null)}let i="presentation"in this?this.presentation:null,o=i?.slides;o&&o.forEach(n=>{n.visibleLayers&&(n.visibleLayers=n.visibleLayers.filter(l=>r(l.id)))})}_updateFromInternal(e,t){return m(this,null,function*(){if(t??={},yield B(()=>e.ready),this._updateInitialViewProperties(e,t),e.map===this)for(let r of e.allLayerViews)"visible"in r&&"visible"in r.layer&&r._isOverridden("visible")&&(r.layer.visible=r.visible),"featureEffect"in r&&"featureEffect"in r.layer&&r._isOverridden("featureEffect")&&(r.layer.featureEffect=r.featureEffect);yield this._updateThumbnailUrl(e,t)})}_updateInitialViewProperties(e,t){if(t.backgroundExcluded||(this.initialViewProperties.background=e.background?.clone()),this.initialViewProperties.spatialReference=e.spatialReference?.clone(),this.initialViewProperties.timeZone=e.timeZone,t.viewpointExcluded||(this.initialViewProperties.viewpoint=new d({rotation:e.rotation,scale:t.scalePreserved?e.scale:null,targetGeometry:this._getViewExtent(e)})),!t.widgetsExcluded)for(let r of e.persistableViewModels)r.updateWebDocument(this)}_getViewExtent(e){let t=e.center.clone().normalize(),r=e.extent.clone(),i=r.width/2;return r.xmin=t.x-i,r.xmax=t.x+i,r}_updateThumbnailUrl(e,t){return m(this,null,function*(){if(t.thumbnailExcluded)return;let r=Y(e,t.thumbnailSize),i=yield e.takeScreenshot({format:"png",width:r.width,height:r.height});this._setAutoGeneratedThumbnail(i.dataUrl)})}_setAutoGeneratedThumbnail(e){this.thumbnailUrl=e,this._thumbnailFilename=null}_clearThumbnailOverride(){this._clearOverride("thumbnailUrl"),this.clear("thumbnailUrl","user"),this._thumbnailFilename=null}_generateCustomThumbnailFilename(e){if(R(e)){let t=T(e),r=t?.mediaType,i=r&&me.get(r.toLowerCase())||null,o=`thumbnail${Date.now()}`;return i?`${o}.${i}`:o}return null}_getAuthoringPropsState(){return{authoringApp:this.authoringApp,authoringAppVersion:this.authoringAppVersion,isAuthoringAppSetByUser:this._isAuthoringAppSetByUser,isAuthoringAppVersionSetByUser:this._isAuthoringAppVersionSetByUser}}_restoreAuthoringPropsFromState(e){e.isAuthoringAppSetByUser?this.authoringApp=e.authoringApp:this._isAuthoringAppSetByUser=!1,e.isAuthoringAppVersionSetByUser?this.authoringAppVersion=e.authoringAppVersion:this._isAuthoringAppVersionSetByUser=!1}};s([p()],a.prototype,"_updateFromPromise",void 0),s([p({type:ee,json:{write:!0}})],a.prototype,"applicationProperties",void 0),s([p({type:String,json:{write:{allowNull:!0,ignoreOrigin:!0}}})],a.prototype,"authoringApp",null),s([c("authoringApp")],a.prototype,"writeAuthoringApp",null),s([p({type:String,json:{write:{allowNull:!0,ignoreOrigin:!0}}})],a.prototype,"authoringAppVersion",null),s([c("authoringAppVersion")],a.prototype,"writeAuthoringAppVersion",null),s([p({type:oe,json:{write:{overridePolicy:e=>({enabled:!!(e&&e.length>0),ignoreOrigin:!0})}}})],a.prototype,"bookmarks",void 0),s([p({type:H,json:{name:"mapFloorInfo",write:!0}})],a.prototype,"floorInfo",void 0),s([p({type:b,nonNullable:!0,json:{read:{source:["background","initialState.timeExtent","initialState.viewpoint","mapRangeInfo","spatialReference","timeZone"]},write:{ignoreOrigin:!0,target:{background:{type:I},"initialState.timeExtent":{type:_},"initialState.viewpoint":{type:d},mapRangeInfo:{type:V},spatialReference:{type:S},"timeZone:":{type:String}}}}})],a.prototype,"initialViewProperties",void 0),s([v("initialViewProperties")],a.prototype,"readInitialViewProperties",null),s([c("initialViewProperties")],a.prototype,"writeInitialViewProperties",null),s([p({json:{read:!1,write:{target:"operationalLayers",ignoreOrigin:!0}}})],a.prototype,"layers",void 0),s([c("layers")],a.prototype,"writeLayers",null),s([p({type:G})],a.prototype,"portalItem",void 0),s([p()],a.prototype,"resourceInfo",void 0),s([p({readOnly:!0,type:w,json:{read:{source:"version"},write:{allowNull:!0,ignoreOrigin:!0,target:"version",isRequired:!0}}})],a.prototype,"sourceVersion",void 0),s([v("sourceVersion")],a.prototype,"readSourceVersion",null),s([c("sourceVersion")],a.prototype,"writeSourceVersion",null),s([p({json:{read:!1,write:{ignoreOrigin:!0}}})],a.prototype,"tables",void 0),s([c("tables")],a.prototype,"writeTables",null),s([p()],a.prototype,"thumbnailUrl",null),s([p()],a.prototype,"updatingFromView",null),s([p({type:X,json:{write:!0}})],a.prototype,"widgets",void 0),a=s([L("esri.WebDocument2D")],a);var st=a;export{st as a};
