import{a as J}from"./chunk-LXYWEX2U.js";import{a as ze}from"./chunk-IBSCSNYA.js";import{d as Ge}from"./chunk-5H7NDIGP.js";import{a as We}from"./chunk-2GLWK7ZW.js";import{c as Je}from"./chunk-XACQ2RJ5.js";import{a as K}from"./chunk-CX3G2QWN.js";import{h as Q}from"./chunk-YTAJKLRN.js";import{a as je}from"./chunk-3ZJ4NMBE.js";import{a as Ke}from"./chunk-HH3C3QEN.js";import{a as Y}from"./chunk-FSW536RM.js";import{e as Pe}from"./chunk-MPI26GZ3.js";import{g as qe,h as ke}from"./chunk-VSD74FMI.js";import{h as Ye}from"./chunk-J5AEP4US.js";import{a as ce}from"./chunk-YHRLMRSO.js";import{a as F}from"./chunk-XKFJ6GWH.js";import{a as w}from"./chunk-L56OBJFS.js";import{a as C}from"./chunk-YEXMIDOT.js";import{b as Ue}from"./chunk-QSQIQSC6.js";import{a as He,b as Be}from"./chunk-T6WMVIUG.js";import{d as Le,e as Re}from"./chunk-XLL67PCY.js";import{F as Se,l as re,s as Ee,t as be}from"./chunk-GJ2QRXGN.js";import{a as W}from"./chunk-S52JRLJC.js";import{b as q}from"./chunk-E2QKN2KY.js";import{a as m}from"./chunk-PDQQY7RQ.js";import{a as o}from"./chunk-RWCIDBNQ.js";import{r as k}from"./chunk-HM5RIVQC.js";import{a as we,d as Fe,e as Ne}from"./chunk-DJW5LMRG.js";import{a as Ve}from"./chunk-DEH76MSI.js";import{a as L}from"./chunk-ALWV3RJ2.js";import{b as De,c as oe,d as j,e as D,h as he,k as Me,l as xe,m as le,p as M}from"./chunk-2ZFXOJDB.js";import{c as Oe,e as P,v as ne,y as x}from"./chunk-6B5XFA6F.js";import{a as Ce,c as O}from"./chunk-PTZYZULI.js";import{g as Te}from"./chunk-ZTOZWLEE.js";import{a as S}from"./chunk-BOVYXYHK.js";import{a as ve}from"./chunk-T7DXJKX7.js";import{a as p}from"./chunk-QGVBCWUY.js";import{H as Ae}from"./chunk-MYO4NP2N.js";import{e as I}from"./chunk-NFIPKH6V.js";import{l as z}from"./chunk-5QEXLALV.js";import{a as Ie,c as ye}from"./chunk-P6QFA5MM.js";import{b as ge,p as U,r as G}from"./chunk-4PTIEWMT.js";import{b as ae}from"./chunk-YOFFGXOB.js";import{d as H,e as _e,f as pe,y as B}from"./chunk-QBWJMFH5.js";import{f as V}from"./chunk-VTHXE323.js";var Z=class{constructor(e,i,s){this._elementSize=i,this._buffer=K.createVertex(e,k.STATIC_DRAW),this.resize(s)}destroy(){this._buffer.dispose()}get elementSize(){return this._elementSize}get capacity(){return this._capacity}get array(){return this._array}get buffer(){return this._buffer}get usedMemory(){return this._array.byteLength+this._buffer.usedMemory}copyRange(e,i,s,a=0){let r=new Uint8Array(this.array,e*this.elementSize,(i-e)*this.elementSize);new Uint8Array(s.array,a*this.elementSize).set(r)}transferAll(){this._buffer.setData(this._array)}transferRange(e,i){let s=e*this._elementSize,a=i*this._elementSize;this._buffer.setSubData(new Uint8Array(this._array),s,s,a)}resize(e){let i=e*this._elementSize,s=new ArrayBuffer(i);this._array&&(e>=this._capacity?new Uint8Array(s).set(new Uint8Array(this._array)):new Uint8Array(s).set(new Uint8Array(this._array).subarray(0,e*this._elementSize))),this._array=s,this._buffer.setSize(i),this._capacity=e}};var de=class{constructor(e){this.modelOriginHi=e.getField(o.INSTANCEMODELORIGINHI,oe),this.modelOriginLo=e.getField(o.INSTANCEMODELORIGINLO,oe),this.model=e.getField(o.INSTANCEMODEL,D),this.modelNormal=e.getField(o.INSTANCEMODELNORMAL,D),this.featureAttribute=e.getField(o.INSTANCEFEATUREATTRIBUTE,j),this.color=e.getField(o.INSTANCECOLOR,M),this.objectAndLayerIdColor=e.getField(o.INSTANCEOBJECTANDLAYERIDCOLOR,M)}},$=class{constructor(e,i){this._rctx=e,this._instanceBufferLayout=i,this._headIndex=0,this._tailIndex=0,this._firstIndex=null,this._captureFirstIndex=!0,this._updating=!1,this._prevHeadIndex=0,this._resized=!1,this._capacity=1}destroy(){this._buffer&&this._buffer.destroy()}get buffer(){return this._buffer.buffer}get view(){return this._view}get capacity(){return this._capacity}get size(){let e=this._headIndex,i=this._tailIndex;return e>=i?e-i:e+this._capacity-i}get isEmpty(){return this._headIndex===this._tailIndex}get isFull(){return this._tailIndex===(this._headIndex+1)%this._capacity}get headIndex(){return this._headIndex}get tailIndex(){return this._tailIndex}get firstIndex(){return this._firstIndex}get usedMemory(){return this._buffer?.usedMemory??0}reset(){this._headIndex=0,this._tailIndex=0,this._firstIndex=null}startUpdateCycle(){this._captureFirstIndex=!0}beginUpdate(){m(!this._updating,"already updating"),this._updating=!0,this._prevHeadIndex=this._headIndex}endUpdate(){m(this._updating,"not updating"),this.size<pe*this.capacity&&this._shrink(),this._resized?(this._buffer.transferAll(),this._resized=!1):this._transferRange(this._prevHeadIndex,this._headIndex),this._updating=!1}allocateHead(){m(this._updating,"not updating"),this.isFull&&this._grow();let e=this.headIndex;return this._captureFirstIndex&&(this._firstIndex=e,this._captureFirstIndex=!1),this._incrementHead(),m(this._headIndex!==this._tailIndex,"invalid pointers"),e}freeTail(){m(this._updating,"not updating"),m(this.size>0,"invalid size");let e=this._tailIndex===this._firstIndex;this._incrementTail(),e&&(this._firstIndex=this._tailIndex)}_grow(){let e=Math.max(N,Math.floor(this._capacity*H));this._resize(e)}_shrink(){let e=Math.max(N,Math.floor(this._capacity*_e));this._resize(e)}_resize(e){if(m(this._updating,"not updating"),e===this._capacity)return;let i=new Z(this._rctx,this._instanceBufferLayout.stride,e);if(this._buffer){this._firstIndex&&(this._firstIndex=(this._firstIndex+this._capacity-this._tailIndex)%this._capacity);let s=this.size,a=this._compactInstances(i);m(a===s,"invalid compaction"),this._buffer.destroy(),this._tailIndex=0,this._headIndex=a,this._prevHeadIndex=0}this._resized=!0,this._capacity=e,this._buffer=i,this._view=new de(this._instanceBufferLayout.createView(this._buffer.array))}_compactInstances(e){let i=this._headIndex,s=this._tailIndex;return s<i?(this._buffer.copyRange(s,i,e),i-s):s>i?(this._buffer.copyRange(s,this._capacity,e),i>0&&this._buffer.copyRange(0,i,e,this._capacity-s),i+(this._capacity-s)):0}_incrementHead(e=1){this._headIndex=(this._headIndex+e)%this._capacity}_incrementTail(e=1){this._tailIndex=(this._tailIndex+e)%this._capacity}_transferRange(e,i){e<i?this._buffer.transferRange(e,i):e>i&&(i>0&&this._buffer.transferRange(0,i),this._buffer.transferRange(e,this._capacity))}},N=64;var l;function rt(t){let e=q().mat4f64(o.LOCALTRANSFORM).mat4f64(o.GLOBALTRANSFORM).vec4f64(o.BOUNDINGSPHERE).vec3f64(o.MODELORIGIN).mat3f(o.INSTANCEMODEL).mat3f(o.INSTANCEMODELNORMAL).vec2f(o.MODELSCALEFACTORS);return t.includes(o.FEATUREATTRIBUTE)&&(e=e.vec4f(o.FEATUREATTRIBUTE)),t.includes(o.COLOR)&&(e=e.vec4u8(o.COLOR)),t.includes(o.OBJECTANDLAYERIDCOLOR)&&(e=e.vec4u8(o.OBJECTANDLAYERIDCOLOR)),e=e.u8(o.STATE).u8(o.LODLEVEL),e}(function(t){t[t.ALLOCATED=1]="ALLOCATED",t[t.DEFAULT_ACTIVE=2]="DEFAULT_ACTIVE",t[t.VISIBLE=4]="VISIBLE",t[t.HIGHLIGHT=8]="HIGHLIGHT",t[t.HIGHLIGHT_ACTIVE=16]="HIGHLIGHT_ACTIVE",t[t.REMOVE=32]="REMOVE",t[t.TRANSFORM_CHANGED=64]="TRANSFORM_CHANGED",t[t.ACTIVE=18]="ACTIVE"})(l||(l={}));var X=class{constructor(e){this.localTransform=e.getField(o.LOCALTRANSFORM,he),this.globalTransform=e.getField(o.GLOBALTRANSFORM,he),this.modelOrigin=e.getField(o.MODELORIGIN,Me),this.model=e.getField(o.INSTANCEMODEL,D),this.modelNormal=e.getField(o.INSTANCEMODELNORMAL,D),this.modelScaleFactors=e.getField(o.MODELSCALEFACTORS,De),this.boundingSphere=e.getField(o.BOUNDINGSPHERE,xe),this.featureAttribute=e.getField(o.FEATUREATTRIBUTE,j),this.color=e.getField(o.COLOR,M),this.objectAndLayerIdColor=e.getField(o.OBJECTANDLAYERIDCOLOR,M),this.state=e.getField(o.STATE,le),this.lodLevel=e.getField(o.LODLEVEL,le)}},R=class extends Ae{constructor(t,e){super(t),this.events=new ve,this._capacity=0,this._size=0,this._next=0,this._highlightOptionsMap=new Map,this._highlightOptionsMapPrev=new Map,this._layout=rt(e),this._capacity=N,this._buffer=this._layout.createBuffer(this._capacity),this._view=new X(this._buffer)}get capacity(){return this._capacity}get size(){return this._size}get view(){return this._view}addInstance(){this._size+1>this._capacity&&this._grow();let t=this._findSlot();return this._view.state.set(t,l.ALLOCATED),this._size++,this.events.emit("instances-changed"),t}removeInstance(t){let e=this._view.state;m(t>=0&&t<this._capacity&&!!(e.get(t)&l.ALLOCATED),"invalid instance handle"),this._getStateFlag(t,l.ACTIVE)?this._setStateFlags(t,l.REMOVE):this.freeInstance(t),this.events.emit("instances-changed")}freeInstance(t){let e=this._view.state;m(t>=0&&t<this._capacity&&!!(e.get(t)&l.ALLOCATED),"invalid instance handle"),e.set(t,0),this._size--}setLocalTransform(t,e,i=!0){this._view.localTransform.setMat(t,e),i&&this.updateModelTransform(t)}getLocalTransform(t,e){this._view.localTransform.getMat(t,e)}setGlobalTransform(t,e,i=!0){this._view.globalTransform.setMat(t,e),i&&this.updateModelTransform(t)}getGlobalTransform(t,e){this._view.globalTransform.getMat(t,e)}updateModelTransform(t){let e=this._view,i=y,s=v;e.localTransform.getMat(t,Qe),e.globalTransform.getMat(t,ue);let a=Te(ue,ue,Qe);Oe(i,a[12],a[13],a[14]),e.modelOrigin.setVec(t,i),we(s,a),e.model.setMat(t,s);let r=Be(y,a);r.sort(),e.modelScaleFactors.set(t,0,r[1]),e.modelScaleFactors.set(t,1,r[2]),Ne(s,s),Fe(s,s),e.modelNormal.setMat(t,s),this._setStateFlags(t,l.TRANSFORM_CHANGED),this.events.emit("instance-transform-changed",{index:t})}getModelTransform(t,e){let i=this._view;i.model.getMat(t,v),i.modelOrigin.getVec(t,y),e[0]=v[0],e[1]=v[1],e[2]=v[2],e[3]=0,e[4]=v[3],e[5]=v[4],e[6]=v[5],e[7]=0,e[8]=v[6],e[9]=v[7],e[10]=v[8],e[11]=0,e[12]=y[0],e[13]=y[1],e[14]=y[2],e[15]=1}applyShaderTransformation(t,e){this.shaderTransformation!=null&&this.shaderTransformation.applyTransform(this,t,e)}getCombinedModelTransform(t,e){return this.getModelTransform(t,e),this.shaderTransformation!=null&&this.shaderTransformation.applyTransform(this,t,e),e}getCombinedLocalTransform(t,e){this._view.localTransform.getMat(t,e),this.shaderTransformation!=null&&this.shaderTransformation.applyTransform(this,t,e)}getCombinedMaxScaleFactor(t){let e=this._view.modelScaleFactors.get(t,1);return this.shaderTransformation!=null&&(this.shaderTransformation.scaleFactor(y,this,t),e*=Math.max(y[0],y[1],y[2])),e}getCombinedMedianScaleFactor(t){let e=this._view.modelScaleFactors.get(t,0);return this.shaderTransformation!=null&&(this.shaderTransformation.scaleFactor(y,this,t),e*=nt(y[0],y[1],y[2])),e}getModel(t,e){this._view.model.getMat(t,e)}setFeatureAttribute(t,e){this._view.featureAttribute.setVec(t,e)}getFeatureAttribute(t,e){this._view.featureAttribute.getVec(t,e)}setColor(t,e){this._view.color.setVec(t,e)}setObjectAndLayerIdColor(t,e){this._view.objectAndLayerIdColor.setVec(t,e)}setVisible(t,e){e!==this.getVisible(t)&&(this._setStateFlag(t,l.VISIBLE,e),this.events.emit("instance-visibility-changed",{index:t}))}getVisible(t){return this._getStateFlag(t,l.VISIBLE)}setHighlight(t,e){let{_highlightOptionsMap:i}=this,s=i.get(t);e?e!==s&&(i.set(t,e),this._setStateFlag(t,l.HIGHLIGHT,!0),this.events.emit("instance-highlight-changed")):s&&(i.delete(t),this._setStateFlag(t,l.HIGHLIGHT,!1),this.events.emit("instance-highlight-changed"))}get highlightOptionsMap(){return this._highlightOptionsMap}getHighlightStateFlag(t){return this._getStateFlag(t,l.HIGHLIGHT)}geHighlightOptionsPrev(t){let e=this._highlightOptionsMapPrev.get(t)??null;return this._highlightOptionsMapPrev.delete(t),e}getHighlightName(t){let e=this.highlightOptionsMap.get(t)??null;return e?this._highlightOptionsMapPrev.set(t,e):this._highlightOptionsMapPrev.delete(t),e}getState(t){return this._view.state.get(t)}getLodLevel(t){return this._view.lodLevel.get(t)}countFlags(t){let e=0;for(let i=0;i<this._capacity;++i)this.getState(i)&t&&++e;return e}_setStateFlags(t,e){let i=this._view.state;e=i.get(t)|e,i.set(t,e)}_clearStateFlags(t,e){let i=this._view.state;e=i.get(t)&~e,i.set(t,e)}_setStateFlag(t,e,i){i?this._setStateFlags(t,e):this._clearStateFlags(t,e)}_getStateFlag(t,e){return!!(this._view.state.get(t)&e)}_grow(){this._capacity=Math.max(N,Math.floor(this._capacity*H)),this._buffer=this._layout.createBuffer(this._capacity).copyFrom(this._buffer),this._view=new X(this._buffer)}_findSlot(){let t=this._view.state,e=this._next;for(;t.get(e)&l.ALLOCATED;)e=e+1===this._capacity?0:e+1;return this._next=e+1===this._capacity?0:e+1,e}};function nt(t,e,i){return Math.max(Math.min(t,e),Math.min(Math.max(t,e),i))}p([I({constructOnly:!0})],R.prototype,"shaderTransformation",void 0),p([I()],R.prototype,"_size",void 0),p([I({readOnly:!0})],R.prototype,"size",null),R=p([z("esri.views.3d.webgl-engine.lib.lodRendering.InstanceData")],R);var y=S(),v=Ve(),Qe=L(),ue=L();var ee=class extends w{constructor(e,i){super(s=>this._instanceData.view.boundingSphere.getVec(s,this._tmpSphere),{maximumDepth:25}),this._instanceData=e,this._boundingSphere=i,this._tmpSphere=Ue(),this._tmpMat4=L()}addInstance(e){let i=this._instanceData.view.boundingSphere,s=this._instanceData.getCombinedModelTransform(e,this._tmpMat4);x(this._tmpSphere,this._boundingSphere.center,s),this._tmpSphere[3]=this._boundingSphere.radius*He(s),i.setVec(e,this._tmpSphere),this.add([e])}removeInstance(e){this.remove([e])}};var te=class{constructor(e,i){this._worldSpaceRadius=e,this._minScreenSpaceRadii=i}selectLevel(e,i,s){let a=s.computeScreenPixelSizeAt(e),r=this._worldSpaceRadius*i/a,n=0;for(let d=1;d<this._minScreenSpaceRadii.length;++d)r>=this._minScreenSpaceRadii[d]&&(n=d);return n}};var ie=class{constructor(e,i){let s=e.renderContext.rctx,a=i.geometry,r=i.geometry.getRenderGeometry(),n=r.material;this._materials=e.materials,n.setParameters({instancedDoublePrecision:!0}),this.geometry=a,this.material=n,this.glMaterials=new ze(n,this._materials),this.vertexBufferLayout=r.vertexBufferLayout,this.vbo=K.createVertex(s,k.STATIC_DRAW,r.buffer),this.vao=new We(s,F,new Map([["geometry",W(r.vertexBufferLayout)]]),new Map([["geometry",this.vbo]])),this.vertexCount=r.elementCount}destroy(){this.glMaterials.dispose(),this.vbo.dispose(),this.vao.dispose()}get boundingInfo(){return this.geometry.boundingInfo}get triangleCount(){return this.vertexCount/3}get usedMemory(){return 128+this.vbo.usedMemory+this.vao.usedMemory}intersect(e,i,s,a,r,n,d,h){return this.geometry.intersect(e,i,s,a,r,n,d,h)}};var se=class t{static create(e,i,s){return V(this,null,function*(){let a=yield Promise.allSettled(i.components.map(n=>e.controller.schedule(()=>new ie(e,n),s))),r=a.map(n=>n.status==="fulfilled"?n.value:null).filter(B);if(G(s)||r.length!==a.length){r.forEach(n=>n.destroy()),U(s);for(let n of a)if(n.status==="rejected")throw n.reason}return new t(i.minScreenSpaceRadius,r)})}constructor(e,i){this.minScreenSpaceRadius=e,this.components=i}destroy(){this.components.forEach(e=>e.destroy())}intersect(e,i,s,a,r,n,d){this.components.forEach(h=>h.intersect(e,i,s,a,r,n,this.boundingSphere,d))}get boundingBox(){if(this._boundingBox==null){let e=Se();this.components.forEach(i=>{i.boundingInfo!=null&&(re(e,i.boundingInfo.bbMin),re(e,i.boundingInfo.bbMax))}),this._boundingBox=e}return this._boundingBox}get boundingSphere(){if(this._boundingSphere==null){let e=this.boundingBox,i=S();be(e,i),this._boundingSphere={center:i,radius:.5*Ee(e)}}return this._boundingSphere}get triangleCount(){return this.components.reduce((e,i)=>e+i.triangleCount,0)}};var ot=t=>{let e=t.baseBoundingSphere.radius,i=t.levels.map(s=>s.minScreenSpaceRadius);return new te(e,i)},T=class extends Ge{constructor(t,e){super(t),this.type=je.LOD,this.isGround=!1,this._levels=[],this._defaultRenderInstanceData=new Array,this._highlightRenderInstanceDataMap=new Map,this._instanceIndex=0,this._cycleStartIndex=0,this._slicePlane=!1,this._camera=new Pe,this._updateCyclesWithStaticCamera=-1,this._needFullCycle=!1,this.produces=new Map([[Y.OPAQUE_MATERIAL,i=>this._produces(i)],[Y.TRANSPARENT_MATERIAL,i=>!!this._hasTransparentLevels()&&this._produces(i)]]),this._instanceData=new R({shaderTransformation:t.shaderTransformation},t.optionalFields),this.addHandles(e.registerTask(Le.LOD_RENDERER,this))}initialize(){this._instanceBufferLayout=lt(this.optionalFields),this._glInstanceBufferLayout=W(this._instanceBufferLayout,1),this.addHandles([this._instanceData.events.on("instances-changed",()=>this._requestUpdateCycle()),this._instanceData.events.on("instance-transform-changed",({index:t})=>{this._requestUpdateCycle(),this.metadata.notifyGraphicGeometryChanged(t)}),this._instanceData.events.on("instance-visibility-changed",({index:t})=>{this._requestUpdateCycle(!0),this.metadata.notifyGraphicVisibilityChanged(t)}),this._instanceData.events.on("instance-highlight-changed",()=>this._requestUpdateCycle(!0))])}get _allRenderInstanceData(){let t=[this._defaultRenderInstanceData];for(let e of this._highlightRenderInstanceDataMap)t.push(e[1]);return t}get _allRenderInstanceDataExceptHighlightShadow(){let t=[this._defaultRenderInstanceData];for(let e of this._highlightRenderInstanceDataMap)e[0]!==Q&&t.push(e[1]);return t}hasHighlightOptions(t){return this._highlightRenderInstanceDataMap.has(t)}get _enableLevelSelection(){return this.symbol.levels.length>1}get levels(){return this._levels}get baseBoundingBox(){return this._levels[this._levels.length-1].boundingBox}get baseBoundingSphere(){return this._levels[this._levels.length-1].boundingSphere}get baseMaterial(){return this._levels[this._levels.length-1].components[0].material}get slicePlaneEnabled(){return this._slicePlane}set slicePlaneEnabled(t){this._slicePlane=t}get layerUid(){return this.metadata.layerUid}get instanceData(){return this._instanceData}get hasEmissions(){return this._levels.some(t=>t.components.some(e=>e.material.hasEmissions))}get usedMemory(){return this._allRenderInstanceData.reduce((t,e)=>e.reduce((i,s)=>i+s.usedMemory,t),this._levels.reduce((t,e)=>t+e.components.reduce((i,s)=>i+s.usedMemory,0),0))}get renderStats(){let t=this._instanceData.size,e=[];return this._levels.forEach((i,s)=>{let a=this._allRenderInstanceData[0][s].size+this._allRenderInstanceData[1][s].size,r=i.triangleCount;e.push({renderedInstances:a,renderedTriangles:a*r,trianglesPerInstance:r})}),{totalInstances:t,renderedInstances:e.reduce((i,s)=>i+s.renderedInstances,0),renderedTriangles:e.reduce((i,s)=>i+s.renderedTriangles,0),levels:e}}_createRenderInstanceDataArray(t=[]){let{rctx:e}=this._context.renderContext;return this.symbol.levels.map(i=>{t.push(new $(e,this._instanceBufferLayout))}),t}initializeRenderContext(t,e){return V(this,null,function*(){this._context=t,this._createRenderInstanceDataArray(this._defaultRenderInstanceData);let i=yield Promise.allSettled(this.symbol.levels.map(a=>se.create(t,a,e))),s=i.map(a=>a.status==="fulfilled"?a.value:null).filter(B);if(G(e)||s.length!==i.length){s.forEach(a=>a.destroy()),U(e);for(let a of i)if(a.status==="rejected")throw a.reason}this._levels=s,this._levelSelector=ot(this)})}uninitializeRenderContext(){this._invalidateOctree(),this._levels.forEach(t=>t.destroy()),this._defaultRenderInstanceData.forEach(t=>t.destroy()),this._highlightRenderInstanceDataMap.forEach(t=>t.forEach(e=>e.destroy()))}_hasTransparentLevels(){return this._levels.some(t=>t.components.some(e=>e.material.produces.get(Y.TRANSPARENT_MATERIAL)?.(C.Color)))}hasHighlights(){return Ie(this._highlightRenderInstanceDataMap,t=>t.some(e=>e.size>0))}_produces(t){return(t!==C.Highlight||this.hasHighlights())&&(t!==C.ShadowHighlight||this.hasHighlightOptions(Q))}prepareRender(t){if(!ce.LOD_INSTANCE_RENDERER_DISABLE_UPDATES){if(this._enableLevelSelection){let e=t.bind.contentCamera.equals(this._camera);this._camera.copyFrom(t.bind.contentCamera),e||this._requestUpdateCycle()}this._needFullCycle&&(this.runTask(Re),this._needFullCycle=!1)}}acquireTechniques(t){if(!this.baseMaterial.visible||!this.baseMaterial.isVisibleForOutput(t.output))return null;let e=this._getInstanceDatas(t);if(!e)return null;let i=new Array,s=this.levels;return e.forEach(a=>s.forEach(({components:r},n)=>r.forEach(d=>i.push(this._beginComponent(t,a[n],d))))),i}render(t,e){let i=this._getInstanceDatas(t);if(!i||e==null)return;let s=0;t.rctx.bindVAO();let a=this.levels;i.forEach(r=>a.forEach(({components:n},d)=>n.forEach(h=>this._renderComponent(t,e[s++],r[d],h,d))))}_getInstanceDatas(t){let{output:e,bind:i}=t,s=e===C.Highlight,a=e===C.ShadowHighlight,r=!s&&!a,n=e!==C.ShadowExcludeHighlight;if(r)return n?this._allRenderInstanceData:this._allRenderInstanceDataExceptHighlightShadow;if(n){if(s){let h=i.highlight?.name;if(!h)return null;let u=this._highlightRenderInstanceDataMap.get(h);return u?[u]:null}let d=this._highlightRenderInstanceDataMap.get(Q);return a?d?[d]:null:Array.from(this._highlightRenderInstanceDataMap.values())}return null}intersect(t,e,i,s){if(!this.baseMaterial.visible||this._octree==null)return;let a=S();P(a,s,i);let r=n=>{this._instanceData.getCombinedModelTransform(n,Xe),t.transform.set(Xe),x(et,i,t.transform.inverse),x(tt,s,t.transform.inverse);let d=this._instanceData.getState(n),h=this._instanceData.getLodLevel(n),u=this._levels.length;m(!!(d&l.ACTIVE),"invalid instance state"),m(h>=0&&h<u,"invaid lod level"),this._levels[h].intersect(t,e,et,tt,n,this.metadata,u)};this.baseMaterial.parameters.verticalOffset?this._octree.forEach(r):this._octree.forEachAlongRay(i,a,r)}notifyShaderTransformationChanged(){this._invalidateOctree(),this._requestUpdateCycle()}get _octree(){if(this._octreeCached==null){let t=this._instanceData,e=t.view?.state;if(!e)return null;this._octreeCached=new ee(t,this.baseBoundingSphere);for(let i=0;i<t.capacity;++i)e.get(i)&l.ACTIVE&&this._octreeCached.addInstance(i)}return this._octreeCached}_invalidateOctree(){this._octreeCached=ge(this._octreeCached)}queryDepthRange(t){if(this._octree==null)return new J;let e=t.viewForward,i=this._octree.findClosest(e,w.DepthOrder.FRONT_TO_BACK,t.frustum),s=this._octree.findClosest(e,w.DepthOrder.BACK_TO_FRONT,t.frustum);if(i==null||s==null)return new J;let a=t.eye,r=this._instanceData.view;r.boundingSphere.getVec(i,b),P(b,b,a);let n=ne(b,e)-b[3];r.boundingSphere.getVec(s,b),P(b,b,a);let d=ne(b,e)+b[3];return new J(n,d)}_requestUpdateCycle(t=!1){this._updateCyclesWithStaticCamera=-1,this._cycleStartIndex=this._instanceIndex,t&&(this._needFullCycle=!0,this._context.requestRender())}_startUpdateCycle(){this._updateCyclesWithStaticCamera++,this._allRenderInstanceData.forEach(t=>t.forEach(e=>e.startUpdateCycle()))}get running(){return this._instanceData.size>0&&this._updateCyclesWithStaticCamera<1}runTask(t){let{_enableLevelSelection:e,_camera:i,_levelSelector:s}=this;this._allRenderInstanceData.forEach(f=>f.forEach(c=>c.beginUpdate()));let a=this._instanceData,r=a.view,n=a.size,d=a.capacity,h=this._instanceIndex,u=Math.ceil(d/500);for(let f=0;f<n&&!t.done;++f){h===this._cycleStartIndex&&this._startUpdateCycle();let c=r.state.get(h),E=0;if(!(c&l.ALLOCATED)){h=h+1===d?0:h+1,n++;continue}let g=r.lodLevel.get(h);if(c&l.DEFAULT_ACTIVE&&this._defaultRenderInstanceData[g].freeTail(),c&l.HIGHLIGHT_ACTIVE){let _=a.geHighlightOptionsPrev(h);if(_){let A=this._highlightRenderInstanceDataMap.get(_);if(!A)throw new ae("Internal error in lodRenderer");A[g].freeTail()}}if(c&l.REMOVE)a.freeInstance(h);else if(c&l.VISIBLE){let _=0;if(e&&(r.modelOrigin.getVec(h,$e),_=s.selectLevel($e,a.getCombinedMedianScaleFactor(h),i)),E=c&~(l.ACTIVE|l.TRANSFORM_CHANGED),_>=0)if(c&l.HIGHLIGHT){let A=a.getHighlightName(h);if(A){let st=()=>{let me=this._createRenderInstanceDataArray();return me.forEach(at=>at.beginUpdate()),me},fe=ye(this._highlightRenderInstanceDataMap,A,st);if(_>=fe.length)throw new ae(`LodRenderer internal error - missing lodLevel ${_}`);Ze(fe[_],r,h)}E|=l.HIGHLIGHT_ACTIVE}else Ze(this._defaultRenderInstanceData[_],r,h),E|=l.DEFAULT_ACTIVE;r.state.set(h,E),r.lodLevel.set(h,_)}else E=c&~(l.ACTIVE|l.TRANSFORM_CHANGED),r.state.set(h,E);if(this._octreeCached!=null){let _=!!(c&l.ACTIVE),A=!!(E&l.ACTIVE);!_&&A?this._octreeCached.addInstance(h):_&&!A?this._octreeCached.removeInstance(h):_&&A&&c&l.TRANSFORM_CHANGED&&(this._octreeCached.removeInstance(h),this._octreeCached.addInstance(h))}h=h+1===d?0:h+1,h%u==0&&t.madeProgress()}this._instanceIndex=h,this._allRenderInstanceData.forEach(f=>f.forEach(c=>c.endUpdate())),this._context.requestRender()}_beginComponent(t,e,i){return e.size===0?null:i.glMaterials.load(t.rctx,t.bind.slot,t.output)?.beginSlot(t.bind)}_renderComponent(t,e,i,s,a){if(!e)return;let{bind:r,rctx:n}=t;n.runAppleAmdDriverHelper();let d=n.bindTechnique(e,r,s.material.parameters,ct);n.bindVAO(s.vao),e.ensureAttributeLocations(s.vao),ce.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&t.output===C.Color&&(d.setUniform4fv("externalColor",it[Math.min(a,it.length-1)]),d.setUniform1i("colorMixMode",Ye.replace));let h=i.capacity,u=i.headIndex,f=i.tailIndex,c=i.firstIndex,E=this._glInstanceBufferLayout,g=(_,A)=>{qe(n,F,i.buffer,E,_),n.drawArraysInstanced(e.primitiveType,0,s.vertexCount,A-_),ke(n,F,i.buffer,E)};s.material.parameters.transparent&&c!=null?u>f?(m(c>=f&&c<=u,"invalid firstIndex"),g(c,u),g(f,c)):u<f&&(c<=u?(m(c>=0&&c<=u,"invalid firstIndex"),g(c,u),g(f,h),g(0,c)):(m(c>=f&&c<=h,"invalid firstIndex"),g(c,h),g(0,u),g(f,c))):u>f?g(f,u):u<f&&(g(0,u),g(f,h)),n.bindVAO(null)}};function Ze(t,e,i){let s=t.allocateHead();ht(e,i,t.view,s)}function ht(t,e,i,s){Je(t.modelOrigin,e,i.modelOriginHi,i.modelOriginLo,s),i.model.copyFrom(s,t.model,e),i.modelNormal.copyFrom(s,t.modelNormal,e),t.color&&i.color&&i.color.copyFrom(s,t.color,e),t.objectAndLayerIdColor&&i.objectAndLayerIdColor&&i.objectAndLayerIdColor.copyFrom(s,t.objectAndLayerIdColor,e),t.featureAttribute&&i.featureAttribute&&i.featureAttribute.copyFrom(s,t.featureAttribute,e)}function lt(t){let e=q().vec3f(o.INSTANCEMODELORIGINHI).vec3f(o.INSTANCEMODELORIGINLO).mat3f(o.INSTANCEMODEL).mat3f(o.INSTANCEMODELNORMAL);return t!=null&&t.includes("featureAttribute")&&(e=e.vec4f(o.INSTANCEFEATUREATTRIBUTE)),t!=null&&t.includes("color")&&(e=e.vec4u8(o.INSTANCECOLOR)),t!=null&&t.includes("objectAndLayerIdColor")&&(e=e.vec4u8(o.INSTANCEOBJECTANDLAYERIDCOLOR)),e}p([I({constructOnly:!0})],T.prototype,"symbol",void 0),p([I({constructOnly:!0})],T.prototype,"optionalFields",void 0),p([I({constructOnly:!0})],T.prototype,"metadata",void 0),p([I({constructOnly:!0})],T.prototype,"shaderTransformation",void 0),p([I()],T.prototype,"_instanceData",void 0),p([I()],T.prototype,"_cycleStartIndex",void 0),p([I({readOnly:!0})],T.prototype,"_enableLevelSelection",null),p([I()],T.prototype,"_updateCyclesWithStaticCamera",void 0),p([I({readOnly:!0})],T.prototype,"running",null),T=p([z("esri.views.3d.webgl-engine.lib.lodRendering.LodRenderer")],T);var $e=S(),b=Ce(),Xe=L(),et=S(),tt=S(),it=[O(1,0,1,1),O(0,0,1,1),O(0,1,0,1),O(1,1,0,1),O(1,0,0,1)],ct=new Ke;export{T as a};
