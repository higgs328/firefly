import{c as G}from"./chunk-EBPH32GC.js";import{a as A}from"./chunk-UZ6X2SIU.js";import{a as Ge}from"./chunk-IDSQ2YJ4.js";import{a as te,b as j,c as re}from"./chunk-O5NYCH42.js";import{d as Te,e as Ae,l as ee}from"./chunk-XR2NZIN5.js";import{a as B}from"./chunk-342NGUMP.js";import{h as L}from"./chunk-QSQIQSC6.js";import{a as Ce}from"./chunk-J4JQLN5L.js";import{a as Me}from"./chunk-4YTM754S.js";import{b as Qe}from"./chunk-2HYVVLKS.js";import{c as je}from"./chunk-S7U4DSGB.js";import{a as ve}from"./chunk-Y7GY5YIF.js";import{a as W}from"./chunk-LMGYHZE3.js";import{G as _e,b as Re,d as O}from"./chunk-GJ2QRXGN.js";import{c as K,d as J,z as P}from"./chunk-6B5XFA6F.js";import{f as Oe,g as Y}from"./chunk-DA3SDKGO.js";import{a as xe}from"./chunk-ZAZJB7CV.js";import{c as V}from"./chunk-BOVYXYHK.js";import{a as Se,d as Ee,h as we,i as Ie,v as be}from"./chunk-KVM6SHDX.js";import{e as Fe}from"./chunk-33RXTDEX.js";import{b as ge}from"./chunk-EQZWYK27.js";import{m as he}from"./chunk-ZQIC5NFT.js";import{f as X}from"./chunk-Q6Y4JG7Q.js";import{a as $}from"./chunk-7F5DJLJT.js";import{B as me,fa as fe,j as de,m as ye}from"./chunk-NJWTSROP.js";import{a as pe}from"./chunk-ARRCN5K3.js";import{e as ue}from"./chunk-TG45K3WR.js";import{a as ce}from"./chunk-T7DXJKX7.js";import{a as c}from"./chunk-QGVBCWUY.js";import{H as T}from"./chunk-MYO4NP2N.js";import{e as p}from"./chunk-NFIPKH6V.js";import{l as C}from"./chunk-5QEXLALV.js";import{b as le}from"./chunk-4PTIEWMT.js";import{b as Z}from"./chunk-YOFFGXOB.js";import{g as ae}from"./chunk-XRGPJ3QY.js";import{p as se,q as oe}from"./chunk-QBWJMFH5.js";import{f as k}from"./chunk-VTHXE323.js";var ke="esri.views.3d.layers.i3s.I3SMeshViewFilter",N=()=>ae.getLogger(ke),f=class extends T{constructor(e){super(e),this._projectionEngineLoaded=!1}initialize(){ue(()=>this.viewFilter?.geometry||this.layerFilter!=null).then(()=>this.loadAsyncModule(import("./chunk-4LHG6LX4.js").then(e=>{this.destroyed||(this._geometryEngine=e)})))}get sortedObjectIds(){if(this.viewFilter?.objectIds==null)return null;let e=Re(this.viewFilter.objectIds);return e.sort(),e}get parsedWhereClause(){let e=this.viewFilter?.where;if(e==null||!e)return null;try{return Fe.create(e,{fieldsIndex:this.layerFieldsIndex})}catch(t){N().error(`Failed to parse filter where clause: ${t}`)}return null}addFilters(e,t,r,s){let i=this.sortedObjectIds;i!=null&&e.push(a=>Ae(i,!0,a)),this.addSqlFilter(e,this.parsedWhereClause),this.addTimeFilter(e,this.viewFilter?.timeExtent);let n=j(this._layerMaskGeometries),o=this._geometryEngine;if(n!=null&&this.layerFilter!=null&&o!=null){let a=this.layerFilter.spatialRelationship;e.push((u,m)=>De(o,u,m,s,t,r,n,a))}let l=j(this._viewMaskGeometries);if(l!=null&&this.viewFilter!=null&&o!=null){let a=this.viewFilter.spatialRelationship;e.push((u,m)=>De(o,u,m,s,t,r,l,a))}}isMBSGeometryVisible(e,t,r){let s=j(this._layerMaskGeometries),i=this._geometryEngine;if(s!=null&&this.layerFilter!=null&&i!=null){let o=this.layerFilter.spatialRelationship,l=s[0].spatialReference||t;return A(e,r,D,l)?Ne(i,D,s,l,o):(N().warnOnce("SceneLayer.mask geometry is using unsupported SpatialReference, skipping geometry filter for MBS"),!0)}let n=j(this._viewMaskGeometries);if(n!=null&&this.viewFilter!=null&&i!=null){let o=this.viewFilter.spatialRelationship,l=n[0].spatialReference||t;return A(e,r,D,l)?Ne(i,D,n,l,o):(N().warnOnce("SceneLayerView.filter.geometry is using unsupported SpatialReference, skipping geometry filter for MBS"),!0)}return!0}get parsedGeometry(){let e=j(this._viewMaskGeometries),t=j(this._layerMaskGeometries);return e==null||t==null?e||t:t.concat(e)}get _layerMaskGeometries(){let e=this.layerFilter;return e==null?null:this._geometryEngine==null?te:e.spatialRelationship==="disjoint"?e.geometries.map(t=>({type:"polygon",rings:t.rings,spatialReference:t.spatialReference,cache:{}})):[e.geometries.reduce((t,r)=>(t.rings=[...t.rings,...r.rings],t),{type:"polygon",rings:[],spatialReference:e.geometries[0].spatialReference,cache:{}})]}get _viewMaskGeometries(){if(this.viewFilter==null)return null;let{geometry:e}=this.viewFilter;if(e==null)return null;if(this.viewFilter==null||this._geometryEngine==null)return te;let{distance:t,units:r}=this.viewFilter,s=this.viewFilter.spatialRelationship,i=e.type==="mesh"?e.extent:e;if(t==null||t===0)return q(this._geometryEngine,i,s);let n=r||fe(i.spatialReference);if(i.spatialReference.isWGS84){let a=this._geometryEngine.geodesicBuffer(i,t,n);return q(this._geometryEngine,a,s)}let o=X(i,$.WGS84);if(o!=null){let a=X(this._geometryEngine.geodesicBuffer(o,t,n),i.spatialReference);return q(this._geometryEngine,a,s)}if(!this._projectionEngineLoaded&&(this.loadAsyncModule(Oe().then(()=>this._projectionEngineLoaded=!0)),!this._projectionEngineLoaded))return null;let l=null;try{l=Y(i,$.WGS84)}catch{}if(l)try{l=Y(this._geometryEngine.geodesicBuffer(l,t,n),i.spatialReference)}catch{l=null}return l||N().error(`Filter by geodesic buffer (distance) unsupported, failed to project input geometry (${i.spatialReference.wkid}) to WGS84.`),q(this._geometryEngine,l,s)}get updating(){return re(this._layerMaskGeometries)||re(this._viewMaskGeometries)}static checkSupport(e){return e!=null&&(!!Ue(e.spatialRelationship)||(N().warn(`Filters with spatialRelationship other than ${Ve.join(", ")} are not supported for mesh scene layers`),!1))}};c([p()],f.prototype,"layerFilter",void 0),c([p({type:Ce})],f.prototype,"viewFilter",void 0),c([p()],f.prototype,"layerFieldsIndex",void 0),c([p()],f.prototype,"loadAsyncModule",void 0),c([p()],f.prototype,"addSqlFilter",void 0),c([p()],f.prototype,"addTimeFilter",void 0),c([p({readOnly:!0})],f.prototype,"sortedObjectIds",null),c([p({readOnly:!0})],f.prototype,"parsedWhereClause",null),c([p({readOnly:!0})],f.prototype,"parsedGeometry",null),c([p({readOnly:!0})],f.prototype,"_layerMaskGeometries",null),c([p({readOnly:!0})],f.prototype,"_viewMaskGeometries",null),c([p()],f.prototype,"updating",null),c([p()],f.prototype,"_projectionEngineLoaded",void 0),c([p()],f.prototype,"_geometryEngine",void 0),f=c([C(ke)],f);var Ve=(e=>e)(["contains","intersects","disjoint"]);function Ue(e){return e!=null&&Ve.includes(e)}var y;function q(e,t,r){if(t==null)return null;if(r==="disjoint"&&t.type==="polygon"){let s=t.rings.length,i=t.spatialReference,n=new Array(s);for(let a=0;a<s;++a){let u=Ee(1/0,1/0,-1/0,-1/0);Ie(u,t.rings[a]),n[a]={type:"polygon",rings:[t.rings[a]],spatialReference:i,cache:{},aabr:u}}n.sort((a,u)=>a.aabr[0]-u.aabr[0]);let o=new Set,l=new se;for(let a=0;a<n.length;++a){let u=n[a],m=u.aabr[0];o.forEach(d=>{if(m>=d.aabr[2])return void o.delete(d);if(u.aabr[1]>d.aabr[3]||u.aabr[3]<d.aabr[1]||!e.intersects(u,d))return;u.rings=u.rings.concat(d.rings),we(u.aabr,d.aabr,u.aabr),u.cache={},o.delete(d);let g=oe(n,d,n.length,l);n.splice(g,1)}),o.add(u)}for(let a of n)a.aabr=void 0;return n}return[t]}function Ne(e,t,r,s,i){if(t[3]>=.5*(t[2]+me(s).radius))return!0;let n=Je(e,t,s);return r.every(o=>Pe(e,o,n,i)!==y.DISCARD)}function De(e,t,r,s,i,n,o,l){let a=o[0].spatialReference||i.spatialReference;if(!A(r.node.serviceMbsInIndexSR,n,D,a))return void N().warnOnce("SceneLayerView.filter.geometry is using unsupported SpatialReference, skipping geometry filter");let u=Je(e,D,a),m=ze(l,i,a,s,r.objectHandle);for(let d of o){if(t.length===0)return;switch(Pe(e,d,u,l)){case y.DISCARD:return void(t.length=0);case y.KEEP:continue}Te(t,r.featureIds,g=>He(e,d,g,m))}}(function(e){e[e.KEEP=0]="KEEP",e[e.DISCARD=1]="DISCARD",e[e.TEST=2]="TEST"})(y||(y={}));var D=L(0,0,0,0);function ze(e,t,r,s,i){let n=t.renderSpatialReference,o=new Map,l={type:"polygon",rings:[[[0,0,0],[0,0,0],[0,0,0],[0,0,0]]],spatialReference:r};l.rings[0][3]=l.rings[0][0];let a={indices:null,data:null,stride:0,startIndex:0,endIndex:0},u,m;switch(e){case"intersects":u=(d,g,b)=>d.intersects(g,b)?y.KEEP:y.TEST,m=ie;break;case"contains":u=(d,g,b)=>d.contains(g,b)?y.TEST:y.DISCARD,m=ie;break;default:u=(d,g,b)=>d.disjoint(g,b)?y.TEST:y.DISCARD,m=Be}return{collection:s,object:i,type:e,maskSR:r,renderSR:n,aabbCache:o,triangle:l,positions:a,triangleTest:u,geometryTest:m}}function Je(e,t,r){let s={type:"point",x:t[0],y:t[1],hasZ:!1,hasM:!1,spatialReference:r},i=!de(r)&&!ye(r),n=Number.isNaN(t[3])?0:ge(t[3],0,2*pe.radius),o=i?e.buffer(s,n,1):e.geodesicBuffer(s,n,1);return o.type="polygon",o}function Pe(e,t,r,s){switch(s){case"intersects":case"contains":return ie(e,t,r);case"disjoint":return Be(e,t,r)}}function ie(e,t,r){return e.intersects(t,r)?e.contains(t,r)?y.KEEP:y.TEST:y.DISCARD}function Be(e,t,r){return e.intersects(t,r)?e.contains(t,r)?y.DISCARD:y.TEST:y.KEEP}function He(e,t,r,s){let{collection:i,object:n,renderSR:o,maskSR:l,geometryTest:a,aabbCache:u}=s,m=u.get(r);if(!m){let F=i.getObjectTransform(n);i.getComponentAabb(n,r,I);let S=[V(I[0],I[1],0),V(I[0],I[4],0),V(I[3],I[4],0),V(I[3],I[1],0)];for(let h=0;h<4;++h)P(S[h],S[h],F.rotationScale),J(S[h],S[h],F.position),B(S[h],o,S[h],l);m={type:"polygon",rings:[S],spatialReference:l,cache:{}},m.rings[0][4]=m.rings[0][0],u.set(r,m)}switch(a(e,t,m)){case y.DISCARD:return!1;case y.KEEP:return!0}let{triangle:d,triangleTest:g,positions:b}=s,_=d.rings[0][0],v=d.rings[0][1],x=d.rings[0][2],M=i.getObjectTransform(n);i.getComponentPositions(n,r,b);let{indices:U,data:w,stride:z,startIndex:Le,endIndex:qe}=b;for(let F=Le;F<qe;F+=3){let S=z*U[F],h=z*U[F+1],H=z*U[F+2];switch(K(_,w[S],w[S+1],w[S+2]),K(v,w[h],w[h+1],w[h+2]),K(x,w[H],w[H+1],w[H+2]),P(_,_,M.rotationScale),P(v,v,M.rotationScale),P(x,x,M.rotationScale),J(_,_,M.position),J(v,v,M.position),J(x,x,M.position),B(_,o,_,l),B(v,o,v,l),B(x,o,x,l),g(e,t,d)){case y.DISCARD:return!1;case y.KEEP:return!0}}return s.type!=="intersects"}var I=O();var Ze=je,R=class extends T{constructor(e){super(e)}initialize(){this.addHandles(this.layerView.on("visible-geometry-changed",()=>this.spatialIndex.events.emit("changed")))}destroy(){this._dataQueryEngineInstance=le(this._dataQueryEngineInstance),this._set("layerView",null)}get spatialReference(){return this.layerView.view.spatialReference}get layer(){return this.layerView.i3slayer}get defaultQueryJSON(){return new Qe({outSpatialReference:this.spatialReference}).toJSON()}get _dataQueryEngine(){return this._ensureDataQueryEngine()}executeQueryForCount(e,t){return k(this,null,function*(){return this._dataQueryEngine.executeQueryForCount(this._ensureQueryJSON(e),t)})}executeQueryForExtent(e,t){return k(this,null,function*(){let{count:r,extent:s}=yield this._dataQueryEngine.executeQueryForExtent(this._ensureQueryJSON(e),t);return{count:r,extent:he.fromJSON(s)}})}executeQueryForIds(e,t){return k(this,null,function*(){return this._dataQueryEngine.executeQueryForIds(this._ensureQueryJSON(e),t)})}executeQuery(e,t){return k(this,null,function*(){let r=this._ensureQueryJSON(e);if(r.returnGeometry)throw new Z("unsupported-query","returnGeometry is not supported when querying a mesh scene layer view, it is only supported when directly querying a scene layer");if(r.returnCentroid)throw new Z("unsupported-query","returnCentroid is not yet supported for mesh scene layer queries");let s=yield this._dataQueryEngine.executeQuery(r,t),i=Me.fromJSON(s);return i.features.forEach(n=>n.geometry=null),i})}_ensureQueryJSON(e){return e==null?this.defaultQueryJSON:e.toJSON()}_ensureDataQueryEngine(){if(this._dataQueryEngineInstance)return this._dataQueryEngineInstance;let e=this.layer.objectIdField||Ge,t="esriGeometryPolygon",r=this.layer.fieldsIndex?.toJSON()||new xe([]),s=this.layerView.view.resourceController.scheduler,i=this.spatialReference.toJSON(),n=this.priority,o=this.spatialIndex;return this._dataQueryEngineInstance=new Ze({hasZ:!0,hasM:!1,geometryType:t,fieldsIndex:r,timeInfo:null,spatialReference:i,objectIdField:e,featureStore:o,scheduler:s,priority:n}),this._dataQueryEngineInstance}};c([p({constructOnly:!0})],R.prototype,"layerView",void 0),c([p({constructOnly:!0})],R.prototype,"priority",void 0),c([p({constructOnly:!0})],R.prototype,"spatialIndex",void 0),c([p()],R.prototype,"spatialReference",null),c([p()],R.prototype,"layer",null),c([p()],R.prototype,"defaultQueryJSON",null),R=c([C("esri.views.3d.layers.i3s.I3SQueryEngine")],R);var We=class{constructor(t){this._objectIdField=t.objectIdField,this._getFeatureExtent=t.getFeatureExtent}getObjectId(t){return t.id}getAttributes(t){let{meta:r,index:s}=t,i={};this._objectIdField&&(i[this._objectIdField]=t.id);let n=r.attributeInfo?.attributeData;if(n!=null)for(let o of Object.keys(n))i[o]=ee(n[o],s);return i}getAttribute(t,r){if(r===this._objectIdField)return t.id;let{meta:s,index:i}=t,n=s.attributeInfo?.attributeData;return n!=null?ee(n[r],i):null}getGeometry(t){if(t.geometry)return t.geometry;let[r,s,i,n,o]=this._getFeatureExtent(t,Ke);return new W([5],[r,s,i,n,s,i,n,o,i,r,o,i,r,s,i])}getCentroid(t,r){if(t.geometry)return ve(new W,t.geometry,r.hasZ,r.hasM);let[s,i,n,o,l,a]=this._getFeatureExtent(t,Ke);return new W([0],[(s+o)/2,(i+l)/2,(n+a)/2])}cloneWithGeometry(t,r){let{id:s,index:i,meta:n}=t;return new ne(s,i,n,r)}},ne=class{constructor(t,r,s,i){this.id=t,this.index=r,this.meta=s,this.geometry=i}get usedMemory(){return 32+(this.geometry?.usedMemory??0)}},Ke=O();var $e=O(),Q=class extends T{constructor(e){super(e),this.events=new ce}forEach(e){this.forAllFeatures(t=>(e(t),G.CONTINUE))}forEachBounds(e,t){for(let r of e)t(this.getFeatureExtent(r,$e))}forEachInBounds(e,t){this.forAllFeatures(r=>{let s=this.getFeatureExtent(r,Xe);return be(e,_e(s,Ye))&&t(r),G.CONTINUE},r=>{if(A(r.node.serviceMbsInIndexSR,this.sourceSpatialReference,E,this.viewSpatialReference),E[0]>=e[0]&&E[2]<=e[2]&&E[1]>=e[1]&&E[3]<=e[3])return G.CONTINUE;let s=Math.max(e[0],Math.min(E[0],e[2])),i=Math.max(e[1],Math.min(E[1],e[3])),n=E[0]-s,o=E[1]-i;return n*n+o*o<=E[3]*E[3]?G.CONTINUE:G.SKIP})}};c([p({constructOnly:!0})],Q.prototype,"featureAdapter",void 0),c([p({constructOnly:!0})],Q.prototype,"forAllFeatures",void 0),c([p({constructOnly:!0})],Q.prototype,"getFeatureExtent",void 0),c([p({constructOnly:!0})],Q.prototype,"sourceSpatialReference",void 0),c([p({constructOnly:!0})],Q.prototype,"viewSpatialReference",void 0),Q=c([C("esri.views.3d.layers.i3s.I3SQueryFeatureStore")],Q);var E=L(0,0,0,0),Xe=O(),Ye=Se();export{f as a,R as b,We as c,ne as d,Q as e};
