import{f as H,k as L}from"./chunk-JK6BWFR4.js";import{a as M}from"./chunk-TF33FN54.js";import{a as U}from"./chunk-7HDKYHMG.js";import{B as G,g as A}from"./chunk-XR5FT7TQ.js";import{a as O}from"./chunk-JQAW4OB5.js";import{a as c,b as w,i as I,k as B}from"./chunk-TG45K3WR.js";import{f as k}from"./chunk-RAI4DTMT.js";import{a as v}from"./chunk-T7DXJKX7.js";import{a as r}from"./chunk-QGVBCWUY.js";import{e as n}from"./chunk-NFIPKH6V.js";import{l as F}from"./chunk-5QEXLALV.js";import{c as T}from"./chunk-P6QFA5MM.js";import{e as h,p as f}from"./chunk-4PTIEWMT.js";import{f as u}from"./chunk-VTHXE323.js";var g={key:Symbol(),label:"Other\u200B"};function _(e){return"templateInfos"in e}function C(e){let t=[];for(let{layer:s,templates:a}of e)for(let i of a)t.push({layer:s,template:i});return t}function S(e,t){let s=new Map;for(let a of e){let i=t(a),{key:d,label:p}=i.key!=null?i:g;T(s,d,()=>({label:p,templateInfos:[]})).templateInfos.push(a)}return Array.from(s.values())}function z(e,t){return{label:e.title??"",templateInfos:t.map(s=>({layer:e,template:s}))}}function j(e,t){return u(this,null,function*(){return e.type==="subtype-sublayer"?yield e.parent?.load(t):yield e.load(t),e})}function x(e){let t=new Map,s=[];for(let a of e)if(y(a)){s.push(a);for(let i of a.items)t.set(i.template,i)}else t.set(a.template,a);return[t,s]}var y=e=>"items"in e;var E=({layer:e})=>({key:e,label:e.title??""}),P=({layer:e})=>({key:e.geometryType,label:e.geometryType??""}),l=class extends v.EventedAccessor{constructor(e){super(e),this._allItems=[],this._updatingHandles=new O,this._updateTask=null,this.disabled=!1,this.disabledItemFunction=null,this.filterFunction=null,this.selectedItem=null,this.templateInfos=null,this.view=null}initialize(){this._get("groupBy")||(this.groupBy="layer"),this.addHandles([c(()=>[this.templateInfos,this.layers],([e],t)=>{e&&e===t?.at(0)||(this._updateTask=h(this._updateTask),e?this._updateAllItems(e):this._getTemplatesAndUpdateAllItems())},B),c(()=>this._groupByFunction,()=>{this.templateInfos==null&&(this._updateTask=h(this._updateTask),this._getTemplatesAndUpdateAllItems())},I),c(()=>this.filterFunction,e=>{for(let t of this._allItems)y(t)&&(t.filterFunction=e)},I)])}set groupBy(e){if(this._set("groupBy",e),typeof e!="function")switch(e){case"layer":this._groupByFunction=E;break;case"geometry":this._groupByFunction=P;break;default:this._groupByFunction=null}else this._groupByFunction=t=>this._ensureGroupByObject(e(t))}get layers(){return this._get("layers")}set layers(e){let t="layers";if(this.removeHandles(t),e){let s=()=>this.notifyChange("state");this.addHandles(e.map(a=>w(()=>a.loadStatus,s)),t)}this._set("layers",e)}get state(){return this.updating?"loading":this.layers.length!==0||this.templateInfos?.length?"ready":"disabled"}get numberOfFeatureTemplates(){return this._allItems.reduce((e,t)=>y(t)?e+t.allItems.length:e+1,0)}get items(){let{filterFunction:e}=this;return e==null?this._allItems:this._allItems.filter(t=>y(t)?t.items.length>0:e(t))}get updating(){return this._updatingHandles.updating}refresh(){this.notifyChange("filterFunction");for(let e of this._allItems)y(e)&&e.reapplyFilter()}select(e,{emit:t=!0}={}){let s=this.selectedItem,a=e?.clone()||null;this._set("selectedItem",a),t&&this.emit("select",{item:a,oldItem:s,template:a?.template??null})}_createItem(e,t){return new M({disabledFunction:this.disabledItemFunction,layer:t,template:e})}_ensureGroupByObject(e){return typeof e=="string"?{key:e,label:e}:e}_updateAllItems(e){let t=this._allItems;if(e.length===0)return V(t),void(this._allItems=[]);let[s,a]=x(t),i=o=>{let m=s.get(o.template);return m?(s.delete(o.template),m):this._createItem(o.template,o.layer)},{filterFunction:d}=this,p=e.filter(b).map(o=>_(o)?new U({filterFunction:d,label:o.label,allItems:o.templateInfos.filter(b).map(m=>i(m))}):i(o));for(let o of[...s.values(),...a])o.destroy();this._allItems=p}_getTemplatesFromLayers(e){return u(this,null,function*(){let t=[],s={signal:e};yield Promise.all(this.layers.map(o=>u(this,null,function*(){yield j(o,s),f(e);let m=G(o)?.operations;m?.supportsEditing&&m?.supportsAdd&&(A(o)?t.push(...o.sublayers):t.push(o))})));let a=yield L(t,this.view,e);f(e);let i=C(a),d=this._groupByFunction;if(d==null)return i;let p=S(i,d);return p.length===1&&p[0].label===g.label?p[0].templateInfos:p})}_getTemplatesAndUpdateAllItems(){return u(this,null,function*(){if(this.layers.length===0)return;let e=k(t=>u(this,null,function*(){let s=yield this._getTemplatesFromLayers(t);f(t),this._updateAllItems(s)}));this._updateTask=e,this._updatingHandles.addPromise(e.promise)})}};function V(e){for(let t of e){if(y(t))for(let s of t.items)s.destroy();t.destroy()}}function b(e){return _(e)?e.templateInfos.some(b):!H(e.template)||e.template.visible!==!1}r([n()],l.prototype,"_allItems",void 0),r([n()],l.prototype,"_groupByFunction",void 0),r([n()],l.prototype,"_updatingHandles",void 0),r([n()],l.prototype,"disabled",void 0),r([n()],l.prototype,"disabledItemFunction",void 0),r([n({value:null})],l.prototype,"filterFunction",void 0),r([n()],l.prototype,"groupBy",null),r([n({value:[]})],l.prototype,"layers",null),r([n()],l.prototype,"state",null),r([n({readOnly:!0})],l.prototype,"numberOfFeatureTemplates",null),r([n({readOnly:!0})],l.prototype,"items",null),r([n({readOnly:!0})],l.prototype,"selectedItem",void 0),r([n()],l.prototype,"templateInfos",void 0),r([n()],l.prototype,"updating",null),r([n()],l.prototype,"view",void 0),l=r([F("esri.widgets.FeatureTemplates.FeatureTemplatesViewModel")],l);var ie=l;export{g as a,z as b,y as c,ie as d};
