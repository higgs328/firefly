import{a as H}from"./chunk-322WAKKC.js";import{a as ce,b as de,c as ye}from"./chunk-R22A3CI2.js";import{a as pe,c as he,e as me}from"./chunk-SNC52ZAM.js";import{a as ge,b as fe,c as S}from"./chunk-OHURIINH.js";import{a as oe,b as le}from"./chunk-YHYXMWMO.js";import{b as ue}from"./chunk-5UAVTNPR.js";import{a as ae}from"./chunk-2DH3L3DZ.js";import{a as ne}from"./chunk-5DVGZXEZ.js";import{a as se}from"./chunk-4Y7EKSO4.js";import{a as Y}from"./chunk-KRX2B2DE.js";import{c as re}from"./chunk-MRKUOXYW.js";import{h as ie}from"./chunk-YTAJKLRN.js";import{d as G}from"./chunk-BMZ3PE5Y.js";import{a as F}from"./chunk-J4JQLN5L.js";import{a as T}from"./chunk-4YTM754S.js";import{a as te}from"./chunk-LAX5536Z.js";import{a as C}from"./chunk-JQAW4OB5.js";import{b as w}from"./chunk-2HYVVLKS.js";import{a as ee}from"./chunk-BMYVPMAK.js";import{c as $}from"./chunk-S7U4DSGB.js";import{d as K}from"./chunk-XLL67PCY.js";import{g as Z,h as W}from"./chunk-5LG2P6MT.js";import{a as X}from"./chunk-ZAZJB7CV.js";import{m as B}from"./chunk-KALOJIUA.js";import{b as Q}from"./chunk-JLPLCY2B.js";import{m as z}from"./chunk-ZQIC5NFT.js";import{e as k,f as L}from"./chunk-Q6Y4JG7Q.js";import{a as j}from"./chunk-4N4D2YQX.js";import{a as E,b as J,j as y}from"./chunk-TG45K3WR.js";import{a as s}from"./chunk-QGVBCWUY.js";import{H as x}from"./chunk-MYO4NP2N.js";import{e as n}from"./chunk-NFIPKH6V.js";import{l as g}from"./chunk-5QEXLALV.js";import{A as V,b as _,d as q,p as I,s as N,t as U}from"./chunk-4PTIEWMT.js";import{a as D}from"./chunk-TG2UTNEO.js";import{g as P}from"./chunk-XRGPJ3QY.js";import{a as m,b,f as h}from"./chunk-VTHXE323.js";var O=class{constructor(t){this._cache=t.newCache("QueryEngine",null,-1)}clear(){this._cache.clear()}destroy(){this._cache.destroy()}get(t){return this._cache.get(t)?.items}put(t,a){this._cache.put(t,new A(a))}get test(){}},A=class{constructor(t){this.items=t}get cachedMemory(){return this.items.reduce((t,a)=>t+a.usedMemory,W+Z)}};var xe=$,c=class extends x{constructor(e){super(e),this._dataQueryEngineInstance=null}destroy(){this.clear()}get layer(){return this.context.layer}get spatialReference(){return this.context.spatialReference}get _queryGeometryType(){switch(this.layer.geometryType){case"multipoint":case"point":case"polygon":case"polyline":return this.layer.geometryType;case"mesh":return"polygon";default:return}}get defaultQueryJSON(){return new w({outSpatialReference:this.spatialReference}).toJSON()}clear(){return!!this._dataQueryEngineInstance&&(this._dataQueryEngineInstance.destroy(),this._dataQueryEngineInstance=null,!0)}executeQueryForIdSet(e,t,a){return h(this,null,function*(){return this._dataQueryEngine.executeQueryForIdSet(this._ensureQueryJSON(e,t),a)})}executeQueryForCount(e,t){return h(this,null,function*(){return this._dataQueryEngine.executeQueryForCount(this._ensureQueryJSON(e),t)})}executeQueryForExtent(e,t){return h(this,null,function*(){let{count:a,extent:r}=yield this._dataQueryEngine.executeQueryForExtent(this._ensureQueryJSON(e),t);return{count:a,extent:z.fromJSON(r)}})}executeQueryForIds(e,t){return h(this,null,function*(){return this._dataQueryEngine.executeQueryForIds(this._ensureQueryJSON(e),t)})}executeQueryForLatestObservations(e,t){return h(this,null,function*(){let a=yield this._dataQueryEngine.executeQueryForLatestObservations(this._ensureQueryJSON(e),t),r=T.fromJSON(a);return r.features.forEach(i=>{i.layer=this.layer,i.sourceLayer=this.layer}),r})}executeQuery(e,t){return h(this,null,function*(){let a=yield this._dataQueryEngine.executeQuery(this._ensureQueryJSON(e),t),r=T.fromJSON(a);return r.features.forEach(i=>{i.layer=this.layer,i.sourceLayer=this.layer}),r})}_ensureQueryJSON(e,t){let a=this.defaultQueryJSON;if(e!=null&&("outSpatialReference"in e&&!e.outSpatialReference&&(e.outSpatialReference=this.spatialReference),a=e.toJSON(),a.cacheHint=!0),t!=null){let r=t.geometries.map(i=>i.toJSON()).reduce((i,l)=>(i.rings=i.rings.concat(l.rings),i));a=b(m({},a),{cacheHint:!0,sceneFilter:b(m({},t),{geometry:r})})}return a}get _dataQueryEngine(){if(this._dataQueryEngineInstance)return this._dataQueryEngineInstance;let{priority:e,layer:t}=this,a="timeInfo"in t&&t.timeInfo?.toJSON()||null,r=t.objectIdField,i=ee.toJSON(this._queryGeometryType),l=t.fieldsIndex?.toJSON()||new X([]),u=this.spatialReference.toJSON(),{hasZ:d,hasM:f,featureStore:R,scheduler:be,memoryController:_e}=this.context,Ee=new O(_e);return this._dataQueryEngineInstance=new xe({hasZ:d,hasM:f,geometryType:i,fieldsIndex:l,timeInfo:a,spatialReference:u,objectIdField:r,featureStore:R,scheduler:be,cache:Ee,priority:e}),this._dataQueryEngineInstance}};s([n({constructOnly:!0})],c.prototype,"context",void 0),s([n({constructOnly:!0})],c.prototype,"priority",void 0),s([n()],c.prototype,"layer",null),s([n()],c.prototype,"spatialReference",null),s([n()],c.prototype,"_queryGeometryType",null),s([n()],c.prototype,"defaultQueryJSON",null),c=s([g("esri.views.3d.layers.graphics.QueryEngine")],c);var v=class{constructor(t,a,r,i,l,u){this.spatialReference=t,this.layer=a,this.resourceController=r,this._getFeatureStore=i,this.hasZ=l,this.hasM=u}get scheduler(){return this.resourceController.scheduler}get memoryController(){return this.resourceController.memoryController}get featureStore(){return this._getFeatureStore()}};var p=class extends x{constructor(e){super(e),this._frameTask=null,this._queryEngine=null,this._updateRequested=!0,this._updatingHandles=new C,this._abortController=new AbortController}initialize(){let e=K.FILTER_VISIBILITY,{layer:t,view:a}=this._configuration,{featureStore:r}=this.context,{spatialReference:i,resourceController:l}=a,u=this._configuration.hasZ??!1,d=this._configuration.hasM??!1,f=new v(i,t,l,()=>r,u,d);this._queryEngine=new c({context:f,priority:e}),this._frameTask=a.resourceController.scheduler.registerTask(e),this._updatingHandles.add(()=>[this._compositedFeatureFilter,this._sceneFilter],()=>this._updateRequested=!0,y),this._updatingHandles.addWhen(()=>!this._frameTask.updating&&this._updateRequested,()=>{this._frameTask.schedule(()=>this._updateVisibility(),this._abortController.signal).catch(U),this._updateRequested=!1},y)}destroy(){this._abortController.abort(),this._updatingHandles.destroy(),this.clear(),this._frameTask=q(this._frameTask),this._queryEngine=_(this._queryEngine),this._set("context",null)}get updating(){return this._updateRequested||this._updatingHandles.updating||this._frameTask.updating}get defaultVisibility(){return this._compositedFeatureFilter==null&&this._sceneFilter==null}get _featureFilter(){return"filter"in this._configuration?this._configuration.filter:null}get _effectiveDisplayFilter(){return"effectiveDisplayFilter"in this._configuration?this._configuration.effectiveDisplayFilter:null}get _sceneFilter(){return"layerFilter"in this._configuration?this._configuration.layerFilter:null}get _floorFilter(){return se(this._configuration)}get _timeExtent(){return"timeExtent"in this._configuration?this._configuration.timeExtent:null}get _compositedFeatureFilter(){let{_featureFilter:e,_effectiveDisplayFilter:t,_timeExtent:a,_floorFilter:r}=this,i=e?.clone();if(t!=null&&(i??=new F,i.where=Q(i.where,t.where)),a!=null&&(i??=new F,i.timeExtent=i.timeExtent?.intersection(a)??a),r!=null){i??=new F;let l=i.where==null||i.where==="";i.where=l?r:Q(i.where,r)}return i}get _configuration(){return this.context.configuration}reapply(){this._updateRequested=!0}clear(){this._queryEngine.clear(),this.context.clearFeaturesVisibility()}_updateVisibility(){return h(this,null,function*(){let{signal:e}=this._abortController,{context:t,_frameTask:a,_sceneFilter:r,_compositedFeatureFilter:i}=this;if(I(e),i==null&&r==null||t.getFeatureCount()===0)return yield a.schedule(()=>this.clear(),e);try{let l=yield this._queryEngine.executeQueryForIdSet(i,r,e);return I(e),yield a.schedule(()=>{t.updateFeatureVisibilities(u=>l.has(u))},e)}catch(l){return N(l),P.getLogger(this).warn(`FeatureFilter query failed: ${l}`,{error:l}),yield a.schedule(()=>{t.setAllFeaturesVisibility(!0)},e)}})}};s([n({constructOnly:!0})],p.prototype,"context",void 0),s([n()],p.prototype,"updating",null),s([n()],p.prototype,"defaultVisibility",null),s([n()],p.prototype,"_featureFilter",null),s([n()],p.prototype,"_effectiveDisplayFilter",null),s([n()],p.prototype,"_sceneFilter",null),s([n()],p.prototype,"_floorFilter",null),s([n()],p.prototype,"_timeExtent",null),s([n()],p.prototype,"_compositedFeatureFilter",null),s([n()],p.prototype,"_configuration",null),s([n()],p.prototype,"_updateRequested",void 0),p=s([g("esri.views.3d.layers.support.FeatureVisibilityFilter")],p);var o=class extends j{constructor(e){super(e),this.type="graphics-3d",this._updatingHandles=new C,this.elevationFeatureExpressionEnabled=!1,this.scaleVisibilityEnabled=!1,this.filterVisibilityEnabled=!1,this.frustumVisibilityEnabled=!1,this.elevationAlignmentEnabled=!1,this.timeExtentEnabled=!1,this.setUidToIdOnAdd=!0,this.dataExtent=null,this.drapeSourceType=ae.Features,this.preferredUpdatePolicy=ne.ASYNC,this._suspendResumeExtent=null}initialize(){let e=this.owner,t=(this.filterVisibilityEnabled||this.timeExtentEnabled)&&e.layer.geometryType!=="multipatch",a=new he({owner:this,layer:this.layer,preferredUpdatePolicy:this.preferredUpdatePolicy,elevationFeatureExpressionEnabled:this.elevationFeatureExpressionEnabled,graphicSymbolSupported:!1,hasZ:e.hasZ,hasM:e.hasM,setUidToIdOnAdd:this.setUidToIdOnAdd,componentFactories:{deconflictor:r=>e.view.deconflictor.addGraphicsOwner(r),labeler:(r,i)=>e.view.labeler.addGraphicsOwner(r,i),elevationAlignment:this.elevationAlignmentEnabled?(r,i)=>new ce({graphicsCoreOwner:this,graphicsCore:r,queryGraphicUIDsInExtent:i,elevationProvider:e.view.elevationProvider}):null,scaleVisibility:this.scaleVisibilityEnabled?(r,i)=>new me({graphicsCoreOwner:this,layer:this.layer,queryGraphicUIDsInExtent:i,graphicsCore:r,basemapTerrain:e.view.basemapTerrain}):null,filterVisibility:t?r=>new p({context:b(m({},r),{configuration:e})}):null,objectStates:r=>new ye(r)}});this._set("graphicsCore",a),this.frustumVisibilityEnabled&&this._set("frustumVisibility",new de({graphicsCoreOwner:this})),this.elevationAlignment&&this._updatingHandles.add(()=>this.layer.elevationInfo,(r,i)=>{G(r,i)&&this._updatingHandles.addPromise(this.graphicsCore.elevationInfoChange())}),this._updatingHandles.add(()=>this.layer.labelsVisible,()=>this.graphicsCore.updateVisibilityInfo()),this._updatingHandles.add(()=>this.layer.labelingInfo,(r,i)=>{G(r,i)&&this.graphicsCore.updateLabelingInfo()}),this._updatingHandles.add(()=>this.preferredUpdatePolicy,r=>this.graphicsCore.preferredUpdatePolicy=r),this.addResolvingPromise(this._initializeAsync())}_initializeAsync(){return h(this,null,function*(){yield V(this.graphicsCore.initializePromise);let e=this.owner;this._updatingHandles.add(()=>this.renderer,t=>this._updatingHandles.addPromise(this.graphicsCore.rendererChange(t))),this._updatingHandles.add(()=>e.fullOpacity,()=>this.graphicsCore.opacityChange()),this._setupSuspendResumeExtent(),this.updateClippingExtent&&(this._updatingHandles.add(()=>e.view.clippingArea,()=>this._updateClippingExtent()),this._updateClippingExtent()),this.graphicsCore.startCreateGraphics(),this.graphicsCore.labelsEnabled&&(yield V(this.graphicsCore.updateLabelingInfo()))})}destroy(){this._updatingHandles.destroy(),this._set("frustumVisibility",_(this.frustumVisibility)),this._set("graphicsCore",_(this.graphicsCore)),this._set("owner",null)}get layer(){return this.owner.layer}get dataUpdating(){return this.graphicsCore?.dataUpdating??!1}get renderer(){let{renderer:e,objectIdField:t}=this.layer;if(!e||!t||e.type==="heatmap"||!e.visualVariables)return e;let a=e.visualVariables.findIndex(i=>i.type==="rotation"&&i.valueExpression!=null&&B(i.valueExpression)===t&&(i.axis==null||i.axis==="heading")&&i.rotationType==="geographic");if(a<0)return e;let r=e.clone();return r.visualVariables?(r.visualVariables.splice(a,1),this._randomRotationRenderers??=new WeakMap,this._randomRotationRenderers.set(r,t),r):e}get scaleVisibility(){return this.graphicsCore?.scaleVisibility}get filterVisibility(){return this.graphicsCore?.filterVisibility}get elevationAlignment(){return this.graphicsCore?.elevationAlignment}get suspendResumeExtentMode(){return this.owner.suspendResumeExtentMode??"computed"}get scaleVisibilitySuspended(){return this.scaleVisibility!=null&&this.scaleVisibility.suspended}get suspended(){return this.owner.suspended}get legendEnabled(){return this.frustumVisibility==null||!this.frustumVisibility.suspended}get suspendInfo(){let e={};return this.scaleVisibilitySuspended&&(e.outsideScaleRange=!0),this.frustumVisibility!=null&&this.frustumVisibility.suspended&&(e.outsideOfView=!0),e}get updating(){return!!(this.graphicsCore?.updating||this.frustumVisibility?.updating||this._updatingHandles.updating)}get updatingRemaining(){return this.graphicsCore?.updatingRemaining??0}get featureStore(){return this.graphicsCore?.featureStore}get view(){return this.owner.view}get loadedGraphics(){return this.owner.loadedGraphics}get fullOpacity(){return this.owner?.fullOpacity}get filter(){return"filter"in this.owner?this.owner.filter:null}get slicePlaneEnabled(){return this.owner.slicePlaneEnabled}get updatePolicy(){return this.owner.updatePolicy}get featureSpatialReference(){return"featureSpatialReference"in this.owner?this.owner.featureSpatialReference:this.owner.view.spatialReference}get graphics3DGraphics(){return this.graphicsCore?.graphics3DGraphics}get graphics3DGraphicsByObjectID(){return this.graphicsCore?.graphics3DGraphicsByObjectID}get symbolUpdateType(){return this.graphicsCore?.symbolUpdateType}get displayFeatureLimit(){let e=this.view.quality,t=this.graphicsCore?.displayFeatureLimit;if(e===1)return t;let a=Math.ceil(t.maximumNumberOfFeatures*e);return new pe(t.maximumTotalNumberOfVertices,a,t.averageSymbolComplexity)}get usedMemory(){return this.graphicsCore?.usedMemory??0}get loadedFeatures(){return this.graphicsCore?.numberOfGraphics??0}get usedMemoryPerFeature(){return this.graphicsCore?.usedMemoryPerGraphic??0}get unprocessedMemoryEstimate(){return this.graphicsCore?.unprocessedMemoryEstimate??0}get performanceInfo(){return this.graphicsCore.performanceInfo}maskOccludee(e){let t=this.graphicsCore?.objectStates;if(!t)return D();let{set:a,handle:r}=t.acquireOccludeeSet(null);return t.setUid(a,e.uid),r}highlight(e,t=null,a){let r=this.graphicsCore?.objectStates;if(!r)return S;if(a??=ie,e instanceof w){let{set:l,handle:u}=r.acquireHighlightSet(a,t);return this.owner.queryObjectIds(e).then(d=>r.setObjectIds(l,d)),u}let i=ge(e);if(i.length===0)return S;if(i[0]instanceof te){let l=i;if(H(this.layer.fieldsIndex,l[0].attributes,t)==null){let u=l.map(R=>R.uid),{set:d,handle:f}=r.acquireHighlightSet(a,null);return r.setUids(d,u),f}i=l.map(u=>H(this.layer.fieldsIndex,u.attributes,t))}if(fe(i[0])){let l=i,{set:u,handle:d}=r.acquireHighlightSet(a,t);return r.setObjectIds(u,l),d}return S}resetObjectStates(){this.graphicsCore?.objectStates?.reset()}whenGraphicBounds(e,t){return this.graphicsCore?.whenGraphicBounds(e,t)}computeAttachmentOrigin(e,t){return this.graphicsCore?.computeAttachmentOrigin(e,t)}notifyGraphicGeometryChanged(e){this.graphicsCore.notifyGraphicGeometryChanged(e)}notifyGraphicVisibilityChanged(e){this.graphicsCore.notifyGraphicVisibilityChanged(e)}getRenderingInfo(e,t,a){let r=oe(e,{renderer:t,arcade:a});if(r?.color){let i=r.color;i[0]=i[0]/255,i[1]=i[1]/255,i[2]=i[2]/255}if(r!=null&&t!=null&&this._randomRotationRenderers?.has(t)){let i=this._randomRotationRenderers.get(t),l=e.attributes[i],u=new Y(0);u.updateFloatArray([l]),u.updateUint8Array([173]),r.heading=8381e-11*u.digest()}return r}getRenderingInfoAsync(e,t,a,r){return le(e,m({renderer:t,arcade:a},r))}getSymbolLayerSize(e,t){return this.graphicsCore?.getSymbolLayerSize(e,t)}setObjectIdVisibility(e,t){this.graphicsCore?.setObjectIdVisibility(e,t)}refreshFilter(){this.filterVisibility!=null&&this.filterVisibility.reapply()}getGraphics3DGraphicByObjectId(e){return this.graphicsCore?.getGraphics3DGraphicByObjectId(e)}_updateClippingExtent(){let e=this.owner.view.clippingArea;this.graphicsCore.setClippingExtent(e,this.owner.view.spatialReference)&&(this.updateClippingExtent(e)||this.graphicsCore.recreateAllGraphics())}_setupSuspendResumeExtent(){(this.frustumVisibility||this.scaleVisibility)&&this.addHandles(E(()=>this.suspendResumeExtentMode,()=>{switch(this.removeHandles(M),this.suspendResumeExtentMode){case"computed":this.addHandles([E(()=>this.graphicsCore.computedExtent,e=>this._updateSuspendResumeExtent(e),y),E(()=>this.graphicsCore.extentPadding,()=>this._updateSuspendResumeExtent(this.graphicsCore.computedExtent))],M);break;case"data":this.addHandles([J(()=>this.dataExtent,e=>this._updateSuspendResumeExtent(e),y),E(()=>this.graphicsCore.extentPadding,()=>this._updateSuspendResumeExtent(this.dataExtent))],M);break;default:this.suspendResumeExtentMode}},y))}_updateSuspendResumeExtent(e){e?this._suspendResumeExtentChanged(this._extentToSuspendResumeRect(e,this._suspendResumeExtent)):this._suspendResumeExtentChanged(null)}_extentToSuspendResumeRect(e,t){let a=this.owner.view.spatialReference;if(!e.spatialReference.equals(a)){if(!k(e,a))return;e=L(e,a)}return re(e,t,ue,this.graphicsCore.extentPadding)}_suspendResumeExtentChanged(e){this.frustumVisibility!=null&&this.frustumVisibility.setExtent(e),this.scaleVisibility!=null&&this.scaleVisibility.setExtent(e)}};s([n()],o.prototype,"type",void 0),s([n({constructOnly:!0})],o.prototype,"owner",void 0),s([n()],o.prototype,"layer",null),s([n({readOnly:!0})],o.prototype,"dataUpdating",null),s([n()],o.prototype,"renderer",null),s([n({constructOnly:!0})],o.prototype,"updateClippingExtent",void 0),s([n({constructOnly:!0})],o.prototype,"elevationFeatureExpressionEnabled",void 0),s([n({constructOnly:!0})],o.prototype,"graphicsCore",void 0),s([n({constructOnly:!0})],o.prototype,"scaleVisibilityEnabled",void 0),s([n({constructOnly:!0})],o.prototype,"filterVisibilityEnabled",void 0),s([n({constructOnly:!0})],o.prototype,"frustumVisibilityEnabled",void 0),s([n({constructOnly:!0})],o.prototype,"elevationAlignmentEnabled",void 0),s([n({constructOnly:!0})],o.prototype,"timeExtentEnabled",void 0),s([n({constructOnly:!0})],o.prototype,"setUidToIdOnAdd",void 0),s([n()],o.prototype,"scaleVisibility",null),s([n()],o.prototype,"filterVisibility",null),s([n()],o.prototype,"elevationAlignment",null),s([n({constructOnly:!0})],o.prototype,"frustumVisibility",void 0),s([n()],o.prototype,"suspendResumeExtentMode",null),s([n()],o.prototype,"dataExtent",void 0),s([n()],o.prototype,"scaleVisibilitySuspended",null),s([n()],o.prototype,"suspended",null),s([n()],o.prototype,"legendEnabled",null),s([n()],o.prototype,"suspendInfo",null),s([n()],o.prototype,"updating",null),s([n()],o.prototype,"updatingRemaining",null),s([n()],o.prototype,"featureStore",null),s([n()],o.prototype,"view",null),s([n()],o.prototype,"loadedGraphics",null),s([n()],o.prototype,"fullOpacity",null),s([n()],o.prototype,"filter",null),s([n()],o.prototype,"slicePlaneEnabled",null),s([n()],o.prototype,"drapeSourceType",void 0),s([n()],o.prototype,"updatePolicy",null),s([n()],o.prototype,"preferredUpdatePolicy",void 0),s([n({readOnly:!0})],o.prototype,"displayFeatureLimit",null),o=s([g("esri.views.3d.layers.graphics.Graphics3DFeatureProcessor")],o);var M="suspendResumeExtentMode";export{c as a,v as b,p as c,o as d};
