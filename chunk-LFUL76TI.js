import{a as V}from"./chunk-Z5EURZKA.js";import{E as C,Q as k,s as M,v as q}from"./chunk-KALOJIUA.js";import{d as L}from"./chunk-SLAWDKDA.js";import{a as G,j as z}from"./chunk-TG45K3WR.js";import{d as j}from"./chunk-RAI4DTMT.js";import{a as m}from"./chunk-QGVBCWUY.js";import{H as T}from"./chunk-MYO4NP2N.js";import{e as F}from"./chunk-NFIPKH6V.js";import{l as O}from"./chunk-5QEXLALV.js";import{K as R}from"./chunk-4PTIEWMT.js";import{g as S}from"./chunk-XRGPJ3QY.js";import{b as N}from"./chunk-2LI2GKBQ.js";import{f as b}from"./chunk-VTHXE323.js";var H={setAttribute(){},rollback(){},commit(){}},h;function se(e,r){let t=r.attributes[e.objectIdField];if(t==null)return H;let i=e.sessions.get(t);if(i)return i;let s=N(r.attributes),o=new Set,a=e.i3sOverrides.createInteractiveEditSession(t),p=new Map,g=(d,n)=>{let c=p.get(d);if(c==null){let f=n.indexOf(t);return p.set(d,f),f}return c},u=h.EDITING,l={setAttribute(d,n){if(u!==h.EDITING)return;let c=e.fieldsIndex.get(d);if(!c)return;let f=e.attributeStorageInfo.findIndex(y=>y.name===c.name);if(f<0)return;if(!(d in s))throw new Error(`Attribute "${d}" is not an attribute of the edited feature.`);a.setAttribute(f,n);let I=e.attributeStorageInfo[f],w=!1;o.add(d),e.forEachNode((y,v)=>{let D=g(y,v);if(D===-1)return;let x=e.getAttributeData(y.index);if(x){let E=x[I.name];E&&(E[D]=n,e.setAttributeData(y.index,x,r),w=!0)}}),w&&e.clearMemCache()},rollback(){if(u===h.EDITING){for(let d of o)this.setAttribute(d,s[d]);a.remove(),u=h.ROLLED_BACK,e.sessions.delete(t)}},commit(){u===h.EDITING&&(a.remove(),u=h.COMMITTED,e.sessions.delete(t))}};return e.sessions.set(t,l),l}function J(e,r,t){let{gidToFeatureInfo:i,oidToFeatureInfo:s,fieldsIndex:o,objectIdField:a,globalIdField:p,featureOrIdentifierList:g}=t;if(!t.featuresResolved&&g!=null){for(let u of g){let l={feature:null,oid:-1,gid:null};if("attributes"in u){l.feature=u;let d=u.attributes;if(d!=null)for(let n in d){if(l.oid!==-1&&l.gid!=null)break;let c=o.normalizeFieldName(n);c===a&&(l.oid=d[n]??-1),c===p&&(l.gid=d[n])}}else l.oid=u.objectId??-1,l.gid=u.globalId;l.gid!=null&&i.set(l.gid,l),l.oid!==-1&&s.set(l.oid,l)}t.featuresResolved=!0}return(e!==-1?s.get(e):null)??(r!=null?i.get(r):null)}function _(e,r,t,i,s=null,o=!0){let a=[],p={gidToFeatureInfo:new Map,oidToFeatureInfo:new Map,featuresResolved:t==null,fieldsIndex:e.fieldsIndex,objectIdField:e.objectIdField,globalIdField:e.globalIdField,featureOrIdentifierList:t};for(let g of r){if(g.error!=null)continue;let u=g.objectId??-1,l=g.globalId,d=(u===-1||o?J(u,l,p):null)??{feature:null,oid:u,gid:l},n={oid:u===-1?d.oid:u,gid:l??d.gid,feature:d.feature,result:g};a.push(n);let c=n.gid?L(n.gid):null;if(n.oid===-1&&c!=null&&s!=null&&(n.oid=s.get(c)??-1),n.oid===-1&&c!=null){let f=i.get(c);f==null&&(f={gid:n.gid,edits:[]},i.set(c,f)),f.edits.push(n)}}return a}function oe(e,r){return b(this,null,function*(){let t=new Map,i=_(e,r.addedFeatures,r.edits?.addFeatures,t),s=_(e,r.updatedFeatures,r.edits?.updateFeatures,t),o=_(e,r.deletedFeatures,r.edits?.deleteFeatures,t,r.globalIdToObjectId,!1);return t.size>0&&(yield P(e,t)),{adds:i.filter(a=>a.oid!==-1),updates:s.filter(a=>a.oid!==-1),deletes:o.filter(a=>a.oid!==-1)}})}function P(e,r){return b(this,null,function*(){let t=e.i3sOverrides.layer.associatedLayer;if(t?.globalIdField==null)return;let i=t.createQuery(),{objectIdField:s,globalIdField:o}=t;i.where=Array.from(r.values()).map(({gid:g})=>`${o}='${g}'`).join(" OR "),i.returnGeometry=!1,i.outFields=[s,o],i.cacheHint=!1;let a=yield j(V(t,i));if(!a.ok)return;let p=a.value.features;for(let g of p){let u=g.attributes[o],l=g.attributes[s];if(u==null||l==null||l===-1)continue;let d=r.get(L(u));if(d!=null)for(let n of d.edits)n.oid=l}})}function ne(e,r){let t=new Map,i=s=>{for(let{oid:o,feature:a}of s){let p=a?.geometry;p?.type==="mesh"&&t.set(o,p)}};i(r.adds),i(r.updates);for(let s of r.deletes)t.set(s.oid,null);for(let[s,o]of t)e.i3sOverrides.updateGeometry(s,o)}function le(e,r){let t=W(e,r),i=Q(e,r);if(t.size===0&&i.size===0)return;let s=new Map;for(let n=0;n<e.attributeStorageInfo.length;n++)s.set(e.attributeStorageInfo[n].name,n);let o=!1;t.forEach((n,c)=>{let f=e.getAttributeData(c),I=!1;n.forEach((w,y)=>{let v=f!=null?f[y]:null,D=s.get(y);for(let{featureIndex:x,value:E,featureId:K}of w)v&&(v[x]=E,I=!0,o=!0),e.i3sOverrides.updateAttributeValue(K,D,E)}),I&&e.setAttributeData(c,f,null)}),o&&e.clearMemCache();let{fieldsIndex:a,i3sOverrides:p,objectIdField:g,globalIdField:u}=e,l=p.layer.associatedLayer?.infoFor3D,d=new Set(l?[...Object.values(l.assetMapFieldRoles),...Object.values(l.transformFieldRoles)]:[]);for(let[n,c]of i){p.featureAdded(n);let{attributes:f}=c;for(let I in f){if(I!==g&&I!==u&&d.has(I))continue;let w=a.normalizeFieldName(I),y=w!=null?s.get(w):null;if(y==null)continue;let v=f[I];p.updateAttributeValue(n,y,v)}}}function Q(e,r){let t=new Map,i=r.adds;if(!i||i.length===0||e.globalIdField==null)return t;for(let s of i){let o=s.oid,a=s.feature;a?.geometry?.type==="mesh"&&t.set(o,a)}return t}function W(e,r){let t=r.updates;if(!t||t.length===0)return new $;let i=new $,s=new Map;for(let o=0;o<e.attributeStorageInfo.length;o++)s.set(e.attributeStorageInfo[o].name,o);return e.forEachNode((o,a)=>{for(let p of t){if(p.feature==null)continue;let g=p.feature,u=p.oid,l=a.indexOf(u);for(let d in g.attributes){let n=e.fieldsIndex.normalizeFieldName(d),c=X(i,o.index,n),f=g.attributes[d];c.push({featureIndex:l,featureId:u,value:f})}}}),i}function X(e,r,t){let i=Y(e,r),s=t!=null&&i.get(t);if(s)return s;let o=new Array;return i.set(t,o),o}function Y(e,r){let t=e.get(r);if(t)return t;let i=new Z;return e.set(r,i),i}(function(e){e[e.EDITING=0]="EDITING",e[e.ROLLED_BACK=1]="ROLLED_BACK",e[e.COMMITTED=2]="COMMITTED"})(h||(h={}));var Z=Map,$=Map;function ce(){return{requiredFields:{type:[String],readOnly:!0},availableFields:{type:[String],readOnly:!0,get:function(){let{layer:e,layer:{fieldsIndex:r},requiredFields:t}=this;return e.outFields?M(r,[...q(r,e.outFields),...t]):M(r,t)}}}}var U=e=>{let r=class extends e{constructor(){super(...arguments),this._numUpdating=0}get updating(){return this._numUpdating>0}autoUpdateAsync(t,i){let s=R(o=>b(this,null,function*(){++this._numUpdating;try{let a=yield o;this.destroyed||this._set(t,a)}catch{S.getLogger(this).warn(`Async update of "${String(t)}" failed. Async update functions should not throw exceptions.`)}--this._numUpdating}));return G(i,s,z)}};return m([F({readOnly:!0})],r.prototype,"updating",null),m([F()],r.prototype,"_numUpdating",void 0),r=m([O("esri.core.AsyncUpdate")],r),r},B=class extends U(T){};B=m([O("esri.core.AsyncUpdate")],B);var A=class extends U(T){get layer(){return this.layerView.layer}get requiredFields(){let{layerView:{layer:{fieldsIndex:e},definitionExpressionFields:r},rendererFields:t,labelingFields:i,viewFilterFields:s}=this;return M(e,[...r??[],...t??[],...i??[],...s??[]])}constructor(e){super(e)}initialize(){this.addHandles([this.autoUpdateAsync("rendererFields",()=>b(this,null,function*(){let{fieldsIndex:e,renderer:r}=this.layer;return r?this._getFieldsAsync(t=>r.collectRequiredFields(t,e)):null})),this.autoUpdateAsync("labelingFields",()=>b(this,null,function*(){let{layer:e}=this;return e.labelsVisible?this._getFieldsAsync(r=>k(r,e)):null})),this.autoUpdateAsync("viewFilterFields",()=>{let{layer:e,mergedFilter:r}=this.layerView;return this._getFieldsAsync(t=>C(t,e,r))})])}_getFieldsAsync(e){return b(this,null,function*(){let r=new Set;try{return yield e(r),Array.from(r).sort()}catch(t){return S.getLogger(this).error(t),null}})}};m([F()],A.prototype,"layerView",void 0),m([F()],A.prototype,"layer",null),m([F()],A.prototype,"requiredFields",null),m([F()],A.prototype,"rendererFields",void 0),m([F()],A.prototype,"labelingFields",void 0),m([F()],A.prototype,"viewFilterFields",void 0),A=m([O("esri.views.3d.layers.support.SceneLayerViewRequiredFields")],A);export{se as a,oe as b,ne as c,le as d,ce as e,A as f};
