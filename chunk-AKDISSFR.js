import{a as V}from"./chunk-HSKV7JWT.js";import{b as G}from"./chunk-JK6ANXJE.js";import{a as U,b as K}from"./chunk-Q3T7LRXL.js";import{a as B,c as J,d as Q}from"./chunk-DYNR3EAF.js";import{a as w}from"./chunk-W3TWKYGN.js";import{a as j}from"./chunk-72TNJFVF.js";import{a as W}from"./chunk-2XCEJBGD.js";import{n as F,p as Z}from"./chunk-DT6D5YZT.js";import{a as y}from"./chunk-FM2MN524.js";import{e as P,h as v,j as R}from"./chunk-XEJVICTW.js";import{a as A}from"./chunk-ESAKNWVF.js";import{w as E}from"./chunk-Z7TBAZRW.js";import{g as M,s as L}from"./chunk-DA3SDKGO.js";import{a as T,i as O,k as D}from"./chunk-TG45K3WR.js";import{f as k}from"./chunk-RAI4DTMT.js";import{a as H}from"./chunk-T7DXJKX7.js";import{a as h}from"./chunk-QGVBCWUY.js";import{H as N}from"./chunk-MYO4NP2N.js";import{e as _}from"./chunk-NFIPKH6V.js";import{l as z}from"./chunk-5QEXLALV.js";import{p as C,r as x}from"./chunk-4PTIEWMT.js";import{f as g}from"./chunk-VTHXE323.js";var l=class extends H.EventedMixin(N){constructor(t){super(t),this.options=new W,this._engineCache=new Map,this._loadTask=null,this._engines=[],this._currentMainCandidate=null,this._currentOtherActiveCandidates=[],this._currentSnappedType=u.MAIN}initialize(){this.addHandles([T(()=>{let{distance:t,touchSensitivityMultiplier:e,effectiveSelfEnabled:n,effectiveFeatureEnabled:i,effectiveGridEnabled:s}=this.options;return{selfEnabled:n,featureEnabled:i,gridEnabled:this.view.type==="2d"&&s,viewReady:this.view.ready,viewSpatialReference:this.view.spatialReference,distance:t,touchSensitivityMultiplier:e}},(t,e)=>{e&&(this.doneSnapping(),this.emit("changed")),this._loadTask?.abort(),this._loadTask=k(n=>this._updateEngines(t,e,n))},D),T(()=>this.options,t=>{for(let e of this._engines)e.options=t},O)])}destroy(){this._loadTask?.abort(),this._destroyEngines()}get updating(){return this._engines.some(t=>t.updating)||!this._loadTask?.finished}_destroyEngines(){this._engineCache.forEach(t=>t.destroy()),this._engineCache.clear(),this._engines=[]}_updateEngines(t,e,n){return g(this,null,function*(){if(!t.viewReady)return void this._destroyEngines();e?.viewSpatialReference!==t.viewSpatialReference&&this._destroyEngines();let i=this._engineCache,s=yield Promise.allSettled([t.featureEnabled&&!i.has("feature")?this._createFeatureSnappingEngine(n):void 0,t.selfEnabled&&!i.has("self")?this._createSelfSnappingEngine(n):void 0,t.gridEnabled&&!i.has("grid")?this._createGridSnappingEngine(n):void 0]);if(n.aborted)for(let a of s)a.status==="fulfilled"&&a.value?.engine.destroy();else{for(let a of s)a.status==="fulfilled"&&a.value&&i.set(a.value.type,a.value.engine);this._engines=Array.from(i.values())}})}_createSelfSnappingEngine(t){return g(this,null,function*(){let{SelfSnappingEngine:e}=yield import("./chunk-6QDONCSU.js");return C(t),{type:"self",engine:new e({view:this.view,options:this.options})}})}_createGridSnappingEngine(t){return g(this,null,function*(){let{view:e}=this;if(e.type!=="2d")return;let{GridSnappingEngine:n}=yield import("./chunk-BO67LREG.js");return C(t),{type:"grid",engine:new n({view:e,options:this.options})}})}_createFeatureSnappingEngine(t){return g(this,null,function*(){let{FeatureSnappingEngine:e}=yield import("./chunk-U4O6FY4O.js");C(t);let{view:n,options:i}=this,{spatialReference:s}=n;return{type:"feature",engine:new e({view:n,options:i,spatialReference:s})}})}get _squaredMouseProximityThreshold(){return this.options.distance*this.options.distance}get _squaredTouchProximityThreshold(){let{distance:t,touchSensitivityMultiplier:e}=this.options,n=t*e;return n*n}snap(t){return tt(t)?this._snapMultiPoint(t):this._snapSinglePoint(t)}update(t){let{point:e,context:n}=t;this._removeVisualization();let i=this._currentMainCandidate;if(i==null)return e;let s=this._selectUpdateInput(t);if(s==null)return e;let{spatialReference:a}=n,r=M(s,a);if(r==null)return e;let{view:o}=this,{elevationInfo:p,visualizer:d}=n,c=[],f=v(r,o,p),S=i.constraint.closestTo(f);if(!this._arePointsWithinScreenThreshold(f,S,n)||!q(i,n.drawConstraints))return this._resetSnappingState(),e;i.targetPoint=P(S),c.push(...i.hints);for(let m of this._currentOtherActiveCandidates)q(m,n.drawConstraints)&&(m.targetPoint=P(S),c.push(...m.hints));return d!=null&&this.addHandles(d.draw(c,{spatialReference:a,elevationInfo:et(n),view:o,selfSnappingZ:n.selfSnappingZ}),I),R(S,o,e,n)}doneSnapping(){this._removeVisualization(),this._resetSnappingState()}_selectUpdateInput({point:t,scenePoint:e}){switch(this._currentSnappedType){case u.MAIN:return t;case u.SCENE:return e}}_resetSnappingState(){this._currentMainCandidate=null,this._currentOtherActiveCandidates=[],this._currentSnappedType=u.MAIN}_removeVisualization(){this.removeHandles(I)}_snapSinglePoint(i){return g(this,arguments,function*({point:t,context:e,signal:n}){let{view:s}=this,{elevationInfo:a}=e,r=v(t,s,a),o=yield this._fetchCandidates(r,y.ALL,e,n);return this._createSnapResult(r,u.MAIN,o,s,t,e,n)})}_snapMultiPoint(s){return g(this,arguments,function*({point:t,scenePoint:e,context:n,signal:i}){let{view:a}=this,{coordinateHelper:r,elevationInfo:o,spatialReference:p}=n;yield L(e.spatialReference,p);let d=M(e,p),c=v(d,a,o),f=yield this._fetchCandidates(c,y.FEATURE,n,i);if(f.length>0){let X=yield this._fetchCandidates(c,y.SELF,n,i);return this._createSnapResult(c,u.SCENE,[...f,...X],a,d,n,i)}let S=v(t,a,o),m=yield this._fetchCandidates(S,y.SELF,n,i);return this._createSnapResult(S,u.MAIN,m,a,{z:r.hasZ()&&t.hasZ?t.z??0:void 0,m:r.hasM()&&t.hasM?t.m??0:void 0},n,i)})}_fetchCandidates(t,e,n,i){return g(this,null,function*(){return(yield Promise.all(this._engines.map(s=>s.fetchCandidates(t,e,n,i)))).flat()})}_createSnapResult(t,e,n,i,s,a,r){return{get valid(){return!x(r)},apply:()=>{let{spatialReference:o}=a,{snappedPoint:p,hints:d}=this._processCandidates(t,e,n,a);return this._removeVisualization(),a.visualizer!=null&&this.addHandles(a.visualizer.draw(d,{spatialReference:o,elevationInfo:E,view:i,selfSnappingZ:a.selfSnappingZ}),I),R(p,i,s,a)}}}_processCandidates(t,e,n,i){if(n.length<1)return this.doneSnapping(),{snappedPoint:t,hints:[]};this._currentSnappedType!==e&&this._resetSnappingState(),Z(t,n);let s=this._currentMainCandidate;if(s!=null){let a=$(s,n);if(a>=0){if(!(n[a]instanceof w))return this._intersectWithOtherCandidates(a,n,t,e,i);if(this._arePointsWithinScreenThreshold(t,s.targetPoint,i))return this._updateSnappingCandidate(s,e,n,i)}}return this._intersectWithOtherCandidates(0,n,t,e,i)}_intersectWithOtherCandidates(t,e,n,i,s){let{coordinateHelper:a}=s,r=e[t],o=[];for(let p=0;p<e.length;++p){if(p===t)continue;let d=e[p],c=r.constraint.intersect(d.constraint);if(c)for(let f of c.closestPoints(r.targetPoint))o.push([new w(P(f),r,d,d.isDraped),this._squaredScreenDistance(n,f,a)])}return o.length>0&&(o.sort((p,d)=>p[1]-d[1]),o[0][1]<this._squaredPointProximityThreshold(s.pointer))?this._updateSnappingCandidate(o[0][0],i,e,s):q(r,s.drawConstraints)?this._updateSnappingCandidate(r,i,e,s):{snappedPoint:n,hints:[]}}_updateSnappingCandidate(t,e,n,i){this.doneSnapping(),this._currentMainCandidate=t,this._currentSnappedType=e;let s=this._currentMainCandidate.targetPoint,a=[];a.push(...t.hints);for(let r of n){if(t instanceof w){if(r.constraint.equals(t.first.constraint)||r.constraint.equals(t.second.constraint))continue}else if(r.constraint.equals(t.constraint))continue;let o=r.constraint.closestTo(s);this._squaredScreenDistance(o,s,i.coordinateHelper)<Y()&&(r.targetPoint=s,this._currentOtherActiveCandidates.push(r),a.push(...r.hints))}return{snappedPoint:s,hints:a}}_squaredPointProximityThreshold(t){return t==="touch"?this._squaredTouchProximityThreshold:this._squaredMouseProximityThreshold}_arePointsWithinScreenThreshold(t,e,n){return this._squaredScreenDistance(t,e,n.coordinateHelper)<this._squaredPointProximityThreshold(n.pointer)}_squaredScreenDistance(t,e,n){return F(this._toScreen(t,n),this._toScreen(e,n))}_toScreen(t,e){return Q(t,e.spatialReference,E,this.view)}get test(){}},u;h([_({constructOnly:!0})],l.prototype,"view",void 0),h([_()],l.prototype,"options",void 0),h([_({readOnly:!0})],l.prototype,"updating",null),h([_()],l.prototype,"_loadTask",void 0),h([_()],l.prototype,"_engines",void 0),h([_()],l.prototype,"_squaredMouseProximityThreshold",null),h([_()],l.prototype,"_squaredTouchProximityThreshold",null),l=h([z("esri.views.interactive.snapping.SnappingManager")],l),function(t){t[t.MAIN=0]="MAIN",t[t.SCENE=1]="SCENE"}(u||(u={}));var I="visualization-handle";function Y(){return A.satisfiesConstraintScreenThreshold*A.satisfiesConstraintScreenThreshold}function q(t,e){return!e||e.direction==null&&e.distance==null||!(t instanceof V||t instanceof G||t instanceof j||t instanceof U||t instanceof K)&&(!(t instanceof B)||e.direction==null&&t.selfSnappingType===J.LastVertex)}function $(t,e){return t instanceof w?b(e,t.first)>=0&&b(e,t.second)>=0?0:-1:b(e,t)}function b(t,e){let n=-1;for(let i=0;i<t.length;++i)if(e.constraint.equals(t[i].constraint)){n=i;break}return n}function tt(t){return t.scenePoint!=null}function et({coordinateHelper:t,elevationInfo:e}){return t.hasZ()?E:e}export{l as a};
