import{b as Et}from"./chunk-MELYPAZ7.js";import{a as j,b as ne,d as ft,e as ht,f as yt,g as gt,h as xt,i as Fe,j as we,k as Te,l as vt,m as Ve}from"./chunk-NQ53MXMB.js";import{g as ct}from"./chunk-4RK2B3SZ.js";import{a as mt,b as dt}from"./chunk-ZK55DZ3X.js";import{g as se,h as P}from"./chunk-XR5FT7TQ.js";import{a as it,b as rt}from"./chunk-CZAUQJCN.js";import{a as tt}from"./chunk-MROWXKZJ.js";import{a as et}from"./chunk-JQAW4OB5.js";import{a as Qe}from"./chunk-3JGYBNJA.js";import{f as Ke}from"./chunk-F5AJITOA.js";import{$ as at,M as st,O as ot,_ as nt,ba as be,ca as _e,da as oe,g as ge,ha as lt,i as xe,ia as ut,j as ve,k as Ee,ma as pt}from"./chunk-KALOJIUA.js";import{a as je,b as Je}from"./chunk-PQGCNP5H.js";import{a as Ie}from"./chunk-WZRAC35O.js";import{a as he,d as ye}from"./chunk-P33JWG3G.js";import{a as z}from"./chunk-HX2VGIR2.js";import{a as ze}from"./chunk-7F5DJLJT.js";import{a as Ze}from"./chunk-O3EGNJTY.js";import{a as V}from"./chunk-GHKL3NOH.js";import{a as de}from"./chunk-7P44K2YD.js";import{a as We,b as X,c as me}from"./chunk-MVHHPJM7.js";import{a as ce,c as Ye,e as Xe,i as fe}from"./chunk-TG45K3WR.js";import{f as qe}from"./chunk-RAI4DTMT.js";import{b as R}from"./chunk-ACP3S2CH.js";import{a as Ue}from"./chunk-T7DXJKX7.js";import{a as Ge}from"./chunk-TYYVNQUR.js";import{a as s}from"./chunk-QGVBCWUY.js";import{H as L,r as Pe,z as $e}from"./chunk-MYO4NP2N.js";import{e as o}from"./chunk-NFIPKH6V.js";import{l as x}from"./chunk-5QEXLALV.js";import{c as w}from"./chunk-P6QFA5MM.js";import{h as Be}from"./chunk-LI2SX4T6.js";import{e as re,p as He,w as pe}from"./chunk-4PTIEWMT.js";import{b as E}from"./chunk-YOFFGXOB.js";import{c as ie,g as Y}from"./chunk-XRGPJ3QY.js";import{y as Q,z as ee}from"./chunk-QBWJMFH5.js";import{a as q,f as g}from"./chunk-VTHXE323.js";var jt=new WeakMap,Se=class{constructor(){this._observables=new Map}get(t,i,r){let n=w(this._observables,i,()=>new Ge);return Be(n),Reflect.get(t,i)}set(t,i,r,n){return Reflect.set(t,i,r),this._observables.get(i)?.notify(),!0}};function It(e){return!e||typeof e!="object"||"__accessor__"in e?e:w(jt,e,()=>new Proxy(e,new Se))}var D=class extends L{constructor(e){super(e),this.userChangesHaveMadeInvalid=!1;let t=e.original.attributes??{},i=It(q({},t));this.attributes=i;let r=e.original.cloneShallow();r.attributes=i,this.plainGraphic=r}get geometry(){return this.original.geometry}get layer(){return this.original.sourceLayer??this.original.layer}attributeHasChanged(e){return!ht(this.attributes[e],this.original.attributes?.[e])}getAttribute(e){return this.attributes[e]??null}setAttribute(e,t){this.attributes[e]=t}};s([o()],D.prototype,"attributes",void 0),s([o()],D.prototype,"geometry",null),s([o()],D.prototype,"plainGraphic",void 0),s([o()],D.prototype,"layer",null),s([o({constructOnly:!0})],D.prototype,"original",void 0),s([o()],D.prototype,"userChangesHaveMadeInvalid",void 0),D=s([x("esri.widgets.BatchAttributeForm.ReactiveGraphic")],D);var Me="esri_BatchAttributeForm_different_values",$,O,h;function J(e){return e===h.VISIBLE}function te(e){return e.type==="field"}function ae(e){return e.type==="group"}function K(e,t){return`${e}:${t}`}(function(e){e.DIFFERENT_ERRORS="batch-attribute-form-validation::features-have-different-errors"})($||($={})),function(e){e.noElementsInCommon="noElementsInCommon",e.noElements="noElements",e.elementsHiddenInSome="elementsHiddenInSome",e.allElementsHidden="allElementsHidden"}(O||(O={})),function(e){e.HIDDEN_FIELD_DEFINITION="hidden:field-definition",e.HIDDEN_GROUP_VISIBILITY_EXPRESSION_ALL="hidden:group-visibility-expression:all-features",e.HIDDEN_GROUP_VISIBILITY_EXPRESSION_SOME="hidden:group-visibility-expression:some-features",e.HIDDEN_NO_DOMAIN_IN_COMMON="hidden:no-domain-in-common",e.HIDDEN_NOT_IN_ALL_LAYERS="hidden:not-in-all-layers",e.HIDDEN_VISIBILITY_EXPRESSION_ALL="hidden:visibility-expression:all-features",e.HIDDEN_VISIBILITY_EXPRESSION_SOME="hidden:visibility-expression:some-features",e.VISIBLE="visible"}(h||(h={}));var Ne=e=>e!=null&&(bt(e,"combo-box")||bt(e,"radio-buttons"));function bt(e,t){return e?.type===t}var Yi=(e,t)=>e!=null&&e.input?.type===t;function _t(e){return new D({original:e})}function Xi(e,t,i,r){let{dataType:n,minLength:a}=e,l=i?.validationErrors;if(!l||!t)return null;if(t===$.DIFFERENT_ERRORS)return l.invalidBatchFormType;if(t===ne.CANNOT_BE_EMPTY)return l.cannotBeNull;if(t===ge.VALUE_OUT_OF_RANGE||t===lt.OUT_OF_RANGE){let{field:u,range:p}=e,d={type:"date",intlOptions:q({timeZone:u.type==="date"&&r?r:void 0},ct(u))},m=vt(p,l);return de(m,p,{format:{max:n==="date"?d:p.max!=null&&Te(p.max)?we:Fe,min:n==="date"?d:p.min!=null&&Te(p.min)?we:Fe}})}return t===ge.INVALID_CODED_VALUE?l.invalidCodedValue:t===ut.INVALID_TYPE?l.invalidType:t===ne.TOO_SHORT?de(l.tooShort,{min:a}):(ne.TOO_LONG,null)}function zi(e,t,i){let r=i?.validationErrors;if(!r)return null;let n=null;for(let a of e.invalidHiddenInputs)switch(a.effectiveVisibilityCode){case h.HIDDEN_VISIBILITY_EXPRESSION_ALL:case h.HIDDEN_GROUP_VISIBILITY_EXPRESSION_ALL:case h.HIDDEN_FIELD_DEFINITION:return t==="single"?r.nonVisibleError_changeValues:r.nonVisibleError_checkIndividualFeatures;case h.HIDDEN_NO_DOMAIN_IN_COMMON:case h.HIDDEN_VISIBILITY_EXPRESSION_SOME:case h.HIDDEN_GROUP_VISIBILITY_EXPRESSION_SOME:case h.HIDDEN_NOT_IN_ALL_LAYERS:n=r.nonVisibleError_checkIndividualFeatures;break;case h.VISIBLE:continue;default:a.effectiveVisibilityCode}return n}var Jt=mt("form-calculation"),le=class{constructor(){this._executors=new Map,this._executorPromises=new Map}getArcadeExecutor(t){return g(this,null,function*(){return this._executors.has(t)?this._executors.get(t):this._executorPromises.has(t)?this._executorPromises.get(t):this._createExecutor(t)})}_createExecutor(t){return g(this,null,function*(){try{let i=dt(t,Jt);this._executorPromises.set(t,i);let r=yield i;return this._executors.set(t,r),r}finally{this._executorPromises.delete(t)}})}};function C(e){return e.type==="field"}function B(e){return e.type==="group"}var T=null,wt="esri.widgets.BatchAttributeForm.expressions.ExpressionsManager",Ft=()=>Y.getLogger(wt),M=class extends L{constructor(e){super(e),this.calculating=!1,this.arcadeContext=null,this._abortController=new AbortController,this.layerExpressionsModelMap=new Map,this.evaluatedExpressions=new V,this.expressionEvaluationFailed=!1}abort(){this._abortController.abort()}runAllExpressions(e,t=!1){return g(this,null,function*(){this.calculating=!0;try{let i=[];for(let r of e){let n=this.layerExpressionsModelMap.get(r.layer);if(!n||n.components.length===0)continue;let a=new Set;i.push(this.evaluateAffectedComponents(n.components,r,n,t,a))}yield pe(Promise.all(i),this._abortController)}catch(i){Ft().error(i),this.expressionEvaluationFailed=!0}finally{this.calculating=!1}})}valueChanged(e,t,i=!0){return g(this,null,function*(){try{this.calculating=!0;let r=t.map(n=>this.evaluateValueChangedForFeature(e,n,i));yield Promise.all(r)}catch(r){Ft().error(r),this.expressionEvaluationFailed=!0}finally{this.calculating=!1}})}evaluateValueChangedForFeature(e,t,i){return g(this,null,function*(){if(this._abortController.signal.aborted)return;let r=this.layerExpressionsModelMap.get(t.layer);if(!r||r.components.length===0)return;let n=new Set,a=new Set([e]),l=new Set;for(;a.size>0;){let[u]=a;if(a.delete(u),n.has(u))continue;n.add(u);let p=r.fieldReferencesMap.get(u.toLowerCase());if(!p)continue;for(let m of p)l.has(m)&&p.delete(m);if(p.size===0)continue;let d=new Set;yield this.evaluateAffectedComponents([...p],t,r,i,d);for(let m of p)l.add(m);for(let m of d)n.has(m)||a.add(m)}})}evaluateAffectedComponents(e,t,i,r,n){return g(this,null,function*(){let a=new Map;for(let u of e)a.has(u)||a.set(u,this.createSccEvaluator(u,t,a,i));if(a.size===0)return;let l=[...a.values()].map(u=>u.evaluate(r,n));yield Promise.all(l)})}createSccEvaluator(e,t,i,r){let n=new Le(e,t,this.arcadeContext,r,this.evaluatedExpressions,this._abortController);for(let a of e.adjacencyList)n.dependentEvaluators.push(w(i,a,()=>this.createSccEvaluator(a,t,i,r)));return n}};s([o()],M.prototype,"calculating",void 0),s([o({constructOnly:!0})],M.prototype,"arcadeContext",void 0),s([o()],M.prototype,"_abortController",void 0),s([o()],M.prototype,"layerExpressionsModelMap",void 0),s([o()],M.prototype,"evaluatedExpressions",void 0),s([o()],M.prototype,"expressionEvaluationFailed",void 0),M=s([x(wt)],M);var Le=class{constructor(t,i,r,n,a,l){this.scc=t,this.feature=i,this.arcadeContextInfo=r,this.expressionsModel=n,this.evaluatedExpressions=a,this._abortController=l,this.dependentEvaluators=[],this._evaluatorPromise=null}get baseContext(){let{editType:t,map:i,spatialReference:r,timeZone:n}=this.arcadeContextInfo,a=this.feature.layer,l=a?.type==="scene"&&a.associatedLayer!=null?a.associatedLayer:a;return{variables:{$originalfeature:this.feature.original.clone(),$editcontext:{editType:t},$layer:l,$featureset:l,$datastore:l?.url,$feature:this.feature.plainGraphic.clone(),$map:i},executeContext:{rawOutput:!0,spatialReference:r??void 0,timeZone:n,abortSignal:this._abortController.signal}}}evaluate(t,i){return this._evaluatorPromise==null&&(this._evaluatorPromise=this._evaluate(t,i)),this._evaluatorPromise}_evaluate(t,i){return g(this,null,function*(){T===null&&(T=yield import("./chunk-PAGHI6VQ.js"));let r=this.dependentEvaluators.map(n=>n.evaluate(t,i));yield pe(Promise.all(r),this._abortController);for(let n of this.scc.executors){let a=this.baseContext;if(this._abortController.signal.aborted)break;let l=this.expressionsModel.arcadeExecutorUses.get(n)??[],u=w(this.evaluatedExpressions,this.feature,()=>new V),p=null,d=null;try{p=n.isAsync?yield n.executeAsync(a.variables,a.executeContext):n.execute(a.variables,a.executeContext),d={result:p,status:"success"}}catch(m){d={error:m,status:"error"}}for(let m of l){let y=this.expressionsModel.elementTemplateMap.get(m.elementId);switch(m.executorPurpose){case"editable":case"required":u.set(K(m.elementId,m.executorPurpose),d);break;case"value":{if(d?.status==="error")continue;let v=y.getExpressionExecutorsForLayer(this.feature.layer),N=!0;if(v?.editableExpression&&(N=u.get(K(y.elementId,"editable"))?.result===!1),N){let W=this.feature.getAttribute(y.fieldName)??null,k=Kt(d.result,this.feature,y.fieldName,this.arcadeContextInfo.timeZone);k!==W&&(this.feature.setAttribute(y.fieldName,k),i.add(y.fieldName))}}break;case"visibility":if(u.set(K(m.elementId,m.executorPurpose),d),!this.expressionsModel.preserveFieldValuesWhenHidden&&d.result===!1&&t)if(B(y))for(let v of y.elements)C(v)&&(this.feature.getAttribute(v.fieldName)!==null&&i.add(v.fieldName),this.feature.setAttribute(v.fieldName,null));else C(y)&&(this.feature.getAttribute(y.fieldName)!==null&&i.add(y.fieldName),this.feature.setAttribute(y.fieldName,null))}}if(d?.status==="error"){let m=new Set;for(let y of l){let v=this.expressionsModel.elementTemplateMap.get(y.elementId);if(v)switch(y.executorPurpose){case"editable":m.add(v.label+" - Editable expression");break;case"required":m.add(v.label+" - Required expression");break;case"value":m.add(v.label+" - Value expression");break;case"visibility":m.add(v.label+" - Visibility expression")}}throw m.size>0?new E("expression-evaluation-failed","Arcade evaluation failed ("+[...m].join(",")+")"):new E("expression-evaluation-failed","Arcade evaluation failed ")}}})}};function Kt(e,t,i,r){if(e===null)return null;let n=t.layer.fieldsIndex.get(i);if(!n)throw new E("field-not-found","Unable set field value as the field cannot be found. ("+i+")");switch(n.type){case"big-integer":case"integer":case"long":case"oid":case"small-integer":case"single":case"double":return T.toNumber(e);case"global-id":case"guid":case"string":return T.toString(e);case"date":{if(T.isDate(e))return e.getTime();let a=T.toDate(e,r);if(!a)throw new E("unsupported-value-type","Arcade return type is not a supported field type. ("+i+")");return a.getTime()}case"date-only":{if(T.isDateOnly(e))return e.toStorageFormat();if(T.isDate(e))return he.fromDateTime(e.toDateTime()).toStorageFormat();let a=he.fromString(T.toString(e));if(!a)throw new E("unsupported-value-type","Arcade return type is not a supported field type.");return a.toStorageFormat()}case"time-only":{if(T.isTime(e))return e.toStorageString();if(T.isDate(e))return ye.fromDateTime(e.toDateTime()).toStorageString();let a=ye.fromString(T.toString(e));if(!a)throw new E("unsupported-value-type","Arcade return type is not a supported field type.");return a.toStorageString()}case"timestamp-offset":{if(T.isDate(e))return e.toISOString(!1);let a=T.toDate(e,r);if(!a)throw new E("unsupported-value-type","Arcade return type is not a supported field type. ("+i+")");return a.toISOString(!1)}}throw new E("unsupported-value-type","Arcade return type is not a supported field type. ("+i+")")}var Tt=0,ue=class{constructor(t){this.arcadeExecutorUses=new Map,this.components=[],this.preserveFieldValuesWhenHidden=!1,this.executorMap=t.executorMap,this.preserveFieldValuesWhenHidden=t.preserveFieldValuesWhenHidden===!0,this.elementTemplateMap=new Map;for(let i of this.executorMap.keys())this.elementTemplateMap.set(i.elementId,i);this._buildDependencyGraph()}_buildDependencyGraph(){let t=ii(this.executorMap),i={components:[],arcadeExecutorUses:this.arcadeExecutorUses,elementTemplatesById:new Map([...this.executorMap.keys()].map(r=>[r.elementId,r])),executorMap:this.executorMap,fieldElementTemplateMap:ti(this.executorMap),fieldReferencesMap:new Map,nextIndex:0,nodeInfoMap:t,nodeStack:new Ze($e),shouldConsiderVisibility:!this.preserveFieldValuesWhenHidden};for(let r of this.executorMap.keys()){let n=this.executorMap.get(r);n.editableExpression&&w(this.arcadeExecutorUses,n.editableExpression,()=>[]).push({elementId:r.elementId,executorPurpose:"editable"}),n.valueExpression&&w(this.arcadeExecutorUses,n.valueExpression,()=>[]).push({elementId:r.elementId,executorPurpose:"value"}),n?.visibilityExpression&&w(this.arcadeExecutorUses,n.visibilityExpression,()=>[]).push({elementId:r.elementId,executorPurpose:"visibility"}),n?.requiredExpression&&w(this.arcadeExecutorUses,n.requiredExpression,()=>[]).push({elementId:r.elementId,executorPurpose:"required"})}for(let r of this.arcadeExecutorUses.values())r.sort(n=>n.executorPurpose==="editable"?-1:1);for(let r of t.values())r.index===-1&&Vt(r,i);this.dependencyGraphComponents=ri(i.nodeInfoMap),this.fieldReferencesMap=si(i),this.components=i.components}};function Vt(e,t){e.index=e.lowlink=t.nextIndex++,t.nodeStack.push(e);for(let i of Qt(e,t))i.index===-1?(Vt(i,t),e.lowlink=Math.min(e.lowlink,i.lowlink)):i.index<e.index&&t.nodeStack.contains(i)&&(e.lowlink=Math.min(e.lowlink,i.index)),t.nodeStack.contains(i)||e.crossLinkNeighbors.add(i);if(e.lowlink===e.index){let i=oi();for(t.components.push(i);ni(t.nodeStack)>=e.index;){let r=t.nodeStack.pop();if(r!=null){r.component=i,i.executors.add(r.executor);for(let n of r.crossLinkNeighbors)n.component!=null&&i.adjacencyList.add(n.component)}}}}function Qt({executor:e},t){let i=new Set;for(let n of e.fieldsUsed){let a=n.toLowerCase();w(t.fieldReferencesMap,a,()=>new Set).add(e),Pe(i,ei(a,t))}let r=t.arcadeExecutorUses.get(e)?.filter(n=>n.executorPurpose==="value")??[];for(let n of r){let a=t.executorMap.get(t.elementTemplatesById.get(n.elementId));a?.editableExpression&&a.editableExpression!==e&&i.add(a.editableExpression)}return Array.from(i).map(n=>t.nodeInfoMap.get(n)).filter(Q)}function ei(e,{executorMap:t,fieldElementTemplateMap:i,shouldConsiderVisibility:r}){let n=[],a=i.get(e);if(a==null)return n;let l=t.get(a);if(l==null)return n;if(ee(n,l.editableExpression),ee(n,l.valueExpression),r){ee(n,l?.visibilityExpression);let{group:u}=a;if(u!=null){let p=t.get(u)?.visibilityExpression;ee(n,p)}}return n}function ti(e){let t=new Map;for(let i of e.keys())C(i)&&t.set(i.fieldName.toLowerCase(),i);return t}function ii(e){let t=Array.from(e.values()).filter(Q),i=new Set(t.flatMap(n=>Array.from(Object.values(n)))),r=Array.from(i).map(n=>({component:null,crossLinkNeighbors:new Set,executor:n,index:-1,lowlink:-1,onStack:!1}));return new Map(r.map(n=>[n.executor,n]))}function ri(e){return new Map([...e.values()].map(({component:t,executor:i})=>[i,t]))}function si({fieldReferencesMap:e,nodeInfoMap:t}){let i=new Map;for(let[r,n]of e.entries()){let a=new Set;for(let l of n){let u=t.get(l);u?.component&&a.add(u.component)}i.set(r,a)}return i}function oi(){Tt++;let e=Tt.toString();return{executors:new Set,adjacencyList:new Set,componentId:e}}function ni(e){return e.peek()?.index??-1}var _=class extends L{constructor(e){super(e),this.inputs=[],this.template=null}get allFieldInputs(){let e=[];for(let t of this.inputs)te(t)?e.push(t):ae(t)&&e.push(...t.inputs.filter(te));return e}get description(){return this.template?.description??null}get hasInvalidHiddenInputs(){return this.invalidHiddenInputs.length>0}get invalidFeatures(){return Array.from(new Set(this.allFieldInputs.flatMap(e=>e.invalidFeatures)))}get invalidHiddenInputs(){return this.allFieldInputs.filter(e=>!e.valid&&!e.effectiveVisible)}get title(){return this.template?.title??null}get valid(){return this.allFieldInputs.every(e=>e.valid)}};s([o()],_.prototype,"allFieldInputs",null),s([o()],_.prototype,"description",null),s([o()],_.prototype,"inputs",void 0),s([o()],_.prototype,"hasInvalidHiddenInputs",null),s([o()],_.prototype,"invalidFeatures",null),s([o()],_.prototype,"invalidHiddenInputs",null),s([o()],_.prototype,"template",void 0),s([o()],_.prototype,"title",null),s([o()],_.prototype,"valid",null),_=s([x("esri.widgets.BatchAttributeForm.inputs.BatchFormInputs")],_);var I=class extends L{constructor(e){super(e),this.existsInAllLayers=!0,this.features=new R}get description(){return this.template.description}get featuresHaveSameCalculatedVisibility(){let e=new Set;for(let t of this.features){if(this.template.getExpressionExecutorsForLayer(t.layer)?.visibilityExpression==null){e.add(!0);continue}let i=this._lookupEvaluatedExpression(t,"visibility");if(i?.status==="success"){if(e.add(i.result===!0),e.size>1)return!1}else e.add(!1)}return e.size<=1}get label(){return this.template.label}get layers(){return Array.from(new Set(this.features.map(e=>e.layer)))}get visibilityCode(){return this._baseVisibilityCode}get visible(){return J(this.visibilityCode)}get _baseVisibilityCode(){return this.existsInAllLayers?this.featuresHaveSameCalculatedVisibility?this._evaluatedVisibilityExpression===!1?h.HIDDEN_VISIBILITY_EXPRESSION_ALL:h.VISIBLE:h.HIDDEN_VISIBILITY_EXPRESSION_SOME:h.HIDDEN_NOT_IN_ALL_LAYERS}get _evaluatedVisibilityExpression(){let e=!0,t=!0;for(let i of this.features){if(this.template.getExpressionExecutorsForLayer(i.layer)?.visibilityExpression==null){e=e&&!0;continue}t=!1;let r=this._lookupEvaluatedExpression(i,"visibility");r?.status==="success"?e=e&&r.result===!0:e=!1}return t?null:e}_lookupEvaluatedExpression(e,t){return this.expressionsManager.evaluatedExpressions.get(e)?.get(K(this.template.elementId,t))}};s([o({constructOnly:!0})],I.prototype,"expressionsManager",void 0),s([o()],I.prototype,"description",null),s([o()],I.prototype,"existsInAllLayers",void 0),s([o()],I.prototype,"features",void 0),s([o()],I.prototype,"featuresHaveSameCalculatedVisibility",null),s([o()],I.prototype,"label",null),s([o()],I.prototype,"layers",null),s([o({constructOnly:!0})],I.prototype,"template",void 0),s([o()],I.prototype,"visibilityCode",null),s([o()],I.prototype,"visible",null),s([o()],I.prototype,"_baseVisibilityCode",null),s([o()],I.prototype,"_evaluatedVisibilityExpression",null),I=s([x("esri.widgets.BatchAttributeForm.inputs.InputBase")],I);var G=class extends I{constructor(){super(...arguments),this.editType="NA"}get editable(){return this._evaluatedEditableExpression??!0}get _evaluatedEditableExpression(){let e=!0,t=!0;for(let i of this.features){if(this.template.getExpressionExecutorsForLayer(i.layer)?.editableExpression==null){e=e&&!0;continue}t=!1;let r=this._lookupEvaluatedExpression(i,"editable");r?.status==="success"?e=e&&r.result===!0:e=!1}return t?null:e}};s([o()],G.prototype,"editable",null),s([o()],G.prototype,"editType",void 0),s([o()],G.prototype,"_evaluatedEditableExpression",null),G=s([x("esri.widgets.BatchAttributeForm.inputs.EditableInput")],G);var c=class extends G{constructor(e){super(e),this.group=null,this.type="field",this.userHasChangedValue=!1,this._hasIntersectionWithElementFieldDomain=!1}get compositeError(){if(this.valid)return null;let{errors:e}=this;if(e.length<this.features.length)return $.DIFFERENT_ERRORS;let t=e[0];for(let i of e)if(i.error!==t.error)return $.DIFFERENT_ERRORS;return t.error}get dataType(){let{field:e}=this;return nt(e)?j.Number:at(e)?j.Text:Ke(e)||oe(e)?j.Date:j.Unsupported}get domain(){let e=this._allDomains.toArray();return this.calculateDomain(e)}get distinctValues(){if(this.featuresHaveSameValue)return[this.value];let e=new Set;for(let t of this.features)e.add(t.getAttribute(this.fieldName));return Array.from(e)}get editable(){return!!this.field.editable&&(this._evaluatedEditableExpression??!0)}get effectiveVisible(){return J(this.effectiveVisibilityCode)}get effectiveVisibilityCode(){let{visibilityCode:e}=this;if(e!==h.VISIBLE)return e;let{group:t}=this;if(t==null)return e;let i=t.visibilityCode;return i===h.HIDDEN_VISIBILITY_EXPRESSION_ALL?h.HIDDEN_GROUP_VISIBILITY_EXPRESSION_ALL:i===h.HIDDEN_VISIBILITY_EXPRESSION_SOME?h.HIDDEN_GROUP_VISIBILITY_EXPRESSION_SOME:e}get errors(){return this._validate()}get featuresHaveSameValue(){let{fieldName:e}=this,t=this.features.at(0)?.getAttribute(e);return this.features.every(i=>i.getAttribute(e)===t)}get field(){return this.template.field}get fieldName(){return this.field.name}get invalidFeatures(){return this.errors.map(e=>e.feature)}get isSubtypeField(){return this.layers.some(e=>{if(e&&"subtypeField"in e){let{subtypeField:t,fieldsIndex:i}=e;return(i.get(t)?.name??t)===this.fieldName}return!1})}get showNoValueOptionEnabled(){let{input:e}=this.template;return!this.required&&(!Ne(e)||e?.showNoValueOption===!0)}get showNoValueLabel(){let{input:e}=this.template;return Ne(e)?e?.noValueOptionLabel:null}get includeTime(){let{template:e,field:t}=this;return this.dataType===j.Date&&(t.type==="time-only"||t.type!=="date-only"&&(e.input?.type!=="datetime-picker"||e.input.includeTime))}get includeTimeOffset(){if(this.field.type!=="timestamp-offset")return!1;let e=this.template.input;return!e||e.type==="datetimeoffset-picker"&&e.includeTimeOffset}get maxLength(){return gt({dataType:this.dataType,field:this.field,input:this.template.input})}get minLength(){return xt({dataType:this.dataType,field:this.field,input:this.template.input})}get range(){if(this.dataType==="date")return this._dateRange;let{domain:e,field:t}=this;if(e){let r=xe(t,e);return{max:r?.max,min:r?.min}}let i=this._allDomains.toArray().every(r=>!r)?pt(t):null;return{max:i?.max===Number.MAX_VALUE?null:i?.max??null,min:i?.min===-Number.MAX_VALUE?null:i?.min??null}}get required(){if(!this.editable)return!1;if(!this.field.nullable||this.isSubtypeField)return!0;let e=this.visible&&this.group?.visible!==!1,t=this._evaluatedRequiredExpression;return!(!e||t==null)&&t}get submittable(){return(!this.required||!this.distinctValues.some(e=>yt(e)))&&!!this.valid}get valid(){return this.errors.length===0}get value(){return this.featuresHaveSameValue?this.features.at(0)?.getAttribute(this.fieldName)??null:Me}get visibilityCode(){return this.field.visible?this._fieldShouldHaveDomain&&this.domain==null?h.HIDDEN_NO_DOMAIN_IN_COMMON:this._baseVisibilityCode:h.HIDDEN_FIELD_DEFINITION}get effectiveTimeZone(){let e=this.template,t=e.formTimeZone??"system";return e.layerTimeZone?e.layerTimeZone===X?t=me:e.formTimeZone===X&&(t=e.layerTimeZone):e.formTimeZone===X&&(t=me),t}get codedValueDomainOptions(){return this.domain?.type==="coded-value"?this.domain.codedValues.map(({name:e,code:t})=>({name:e,value:t})):[]}get codedValueOptions(){let e=this.codedValueDomainOptions,{value:t}=this,i=t==null||t===Me||e.some(r=>r.value===t)?[]:[{name:`${t}`,value:t}];return[e,i]}get _evaluatedRequiredExpression(){let e=!1,t=!0,i=this.template;for(let r of this.features){if(i.getExpressionExecutorsForLayer(r.layer)?.requiredExpression==null)continue;t=!1;let n=this._lookupEvaluatedExpression(r,"required");n?.status==="success"?e=e||n.result===!0:e=!0}return t?null:e}get _allDomains(){let e=this.template.domain;return this.features.map(t=>{let i=t.layer.getFieldDomain(this.fieldName,{feature:t.plainGraphic});return i?.type==="range"||e?.type==="range"?i??this.template.domain:i})}get _fieldShouldHaveDomain(){return!!this._hasIntersectionWithElementFieldDomain||this._allDomains.some(Q)}get _dateFormRange(){if(this.dataType!=="date")return{};let e=this.template.input;if(!e)return{};let{type:t}=e,i={};if(t!=="date-picker"&&t!=="time-picker"&&t!=="datetimeoffset-picker"||(i=Ee(this.field,e.max,e.min)),t==="datetime-picker"){let{max:r,min:n}=e;i={max:r!=null&&Ve(r)?r.getTime():null,min:n!=null&&Ve(n)?n.getTime():null}}return{min:i.min,max:i.max,rawMax:i?.rawMax??null,rawMin:i?.rawMin??null}}get _dateRange(){let{_dateFormRange:e,template:t,field:i,domain:r}=this;if(this.dataType!=="date")return{};if(!r)return this._fieldShouldHaveDomain?{}:e;let n=xe(i,r);if(!n)return e;let{max:a,min:l,rawMax:u,rawMin:p}=e,{type:d}=t.field;if(d==="date"){let{max:m,min:y}=n;return{max:z(a)&&(m===null||m!=null&&a<=m)?a:m??null,min:z(l)&&(y===null||y!=null&&l>=y)?l:y??null}}if(d==="date-only"||d==="time-only"||d==="timestamp-offset"){let{max:m,min:y,rawMax:v,rawMin:N}=n,W=z(a)&&u&&(m==null||a<m),k=z(l)&&p&&(y==null||l>y);return{max:W?a:m,min:k?l:y,rawMax:W?u:v,rawMin:k?p:N}}return{}}setValueFromUser(e){return g(this,null,function*(){this.userHasChangedValue=!0;let t=new R,i=this.fieldName;for(let r of this.features)r.getAttribute(i)!==e&&t.push(r);this._setValue(e),yield this.expressionsManager.valueChanged(i,t)})}_setValue(e){let{fieldName:t}=this;for(let i of this.features)i.setAttribute(t,e)}_validate(){let{dataType:e,fieldName:t,maxLength:i,minLength:r,range:n}=this,a=[];for(let l of this.features){let{layer:u}=l,p=u.getField(t)??this.field,d=u.getFieldDomain(t,{feature:l.plainGraphic}),m=this.calculateDomain([d]),y=this._requiredForFeature(l),v=l.getAttribute(t),N=ft(v,{dataType:e,domain:m,field:p,maxLength:i,minLength:r,range:n,required:y});N&&a.push({error:N,feature:l.original})}return a}_editableForFeature(e){if(!this.field.editable)return!1;if(this.template.getExpressionExecutorsForLayer(e.layer)?.editableExpression==null)return!0;let t=this._lookupEvaluatedExpression(e,"editable");return t?.status==="success"&&t.result===!0}_effectiveVisibleFeature(e){if(this.group&&!this.group.visibleForFeature(e))return!1;if(this.template.getExpressionExecutorsForLayer(e.layer)?.visibilityExpression==null)return!0;let t=this._lookupEvaluatedExpression(e,"visibility");return t?.status==="success"&&t.result===!0}_requiredForFeature(e){if(!this._editableForFeature(e))return!1;if(!this.field.nullable||this.isSubtypeField)return!0;let t=this._effectiveVisibleFeature(e);if(this.template.getExpressionExecutorsForLayer(e.layer)?.requiredExpression==null)return!1;let i=this._lookupEvaluatedExpression(e,"required");return i?.status!=="success"?t:t&&i.result===!0}calculateDomain(e){let t=e.find(n=>n!=null),i=this.template.domain;if(!t)return i&&ve(this.field,i)?i:null;switch(t.type){case"coded-value":if(e.some(n=>!n)){if(!i)return null;e=e.filter(n=>n!==null)}break;case"range":e=e.filter(n=>n!==null)}if(!e.every(n=>n?.type===t?.type))return null;let r=null;switch(t?.type){case"range":r=this._intersectRangeDomains(e);break;case"coded-value":r=this._intersectCodedValueDomains(e)}return r}_intersectCodedValueDomains(e){if(!e.length)return null;let t=new Map(e[0].codedValues.map(({code:a,name:l})=>[a,l])),i=this.template.domain?new Map(this.template.domain.codedValues.map(({code:a,name:l})=>[a,l])):null;for(let a of e)for(let[l,u]of t)a.codedValues.some(p=>p.code===l&&p.name===u)||t.delete(l);let r=t;if(i){r=new Map;for(let[a,l]of i)t.has(a)&&r.set(a,l)}let n=Array.from(r.entries()).map(([a,l])=>new je({code:a,name:l}));return n.length?new Je({codedValues:n}):null}_intersectRangeDomains(e){if(!e.length)return null;let t=e[0];if(e.length>1&&(t=e.reduce((r,n)=>this._findMinMaxValuesBetweenTwoDomains(r,n)||null,t)),t&&!ve(this.field,t))return null;let{domain:i}=this.template;if(t&&i&&i instanceof Ie){let r=this._findMinMaxValuesBetweenTwoDomains(t,i);return this._hasIntersectionWithElementFieldDomain=!!r,r}return t}_getMinMaxFromRangeDomain(e){let t=e.minValue,i=e.maxValue,{field:r}=this;return be(r)||oe(r)||_e(r)?Ee(r,i,t):{min:t!=null&&typeof t=="number"?t:null,max:i!=null&&typeof i=="number"?i:null}}_findMinMaxValuesBetweenTwoDomains(e,t){let i=new Ie,r=this._getMinMaxFromRangeDomain(e),n=this._getMinMaxFromRangeDomain(t),{field:a}=this,l=this._getValidRangeValue(r.min,-1/0),u=this._getValidRangeValue(r.max,1/0),p=this._getValidRangeValue(n.min,-1/0),d=this._getValidRangeValue(n.max,1/0);return i.minValue=Math.max(l,p),i.maxValue=Math.min(u,d),i.minValue===-1/0||i.maxValue===1/0||i.minValue>i.maxValue?null:((be(a)||oe(a)||_e(a))&&(i.minValue=Number(r.min)>Number(n.min)?r.rawMin:n.rawMin,i.maxValue=Number(r.max)<Number(n.max)?r.rawMax:n.rawMax),i.name="intersection",i)}_getValidRangeValue(e,t){return z(e)?e:t}};s([o()],c.prototype,"dataType",null),s([o()],c.prototype,"domain",null),s([o()],c.prototype,"distinctValues",null),s([o()],c.prototype,"editable",null),s([o()],c.prototype,"effectiveVisible",null),s([o()],c.prototype,"effectiveVisibilityCode",null),s([o()],c.prototype,"errors",null),s([o()],c.prototype,"featuresHaveSameValue",null),s([o()],c.prototype,"field",null),s([o()],c.prototype,"fieldName",null),s([o()],c.prototype,"group",void 0),s([o()],c.prototype,"invalidFeatures",null),s([o()],c.prototype,"isSubtypeField",null),s([o()],c.prototype,"showNoValueOptionEnabled",null),s([o()],c.prototype,"includeTime",null),s([o()],c.prototype,"includeTimeOffset",null),s([o()],c.prototype,"maxLength",null),s([o()],c.prototype,"minLength",null),s([o()],c.prototype,"range",null),s([o()],c.prototype,"required",null),s([o()],c.prototype,"submittable",null),s([o({readOnly:!0})],c.prototype,"type",void 0),s([o()],c.prototype,"userHasChangedValue",void 0),s([o()],c.prototype,"valid",null),s([o()],c.prototype,"value",null),s([o()],c.prototype,"visibilityCode",null),s([o()],c.prototype,"effectiveTimeZone",null),s([o()],c.prototype,"_evaluatedRequiredExpression",null),s([o()],c.prototype,"_hasIntersectionWithElementFieldDomain",void 0),s([o()],c.prototype,"_allDomains",null),s([o()],c.prototype,"_fieldShouldHaveDomain",null),s([o()],c.prototype,"_dateFormRange",null),s([o()],c.prototype,"_dateRange",null),c=s([x("esri.widgets.BatchAttributeForm.inputs.FieldInput")],c);var H=class extends I{constructor(e){super(e),this.inputs=[],this.type="group"}initialize(){for(let e of this.inputs)e.group=this}get open(){return this.template.initialState==="expanded"}set open(e){this._override("open",e)}get visible(){return J(this.visibilityCode)&&this.inputs.some(e=>e.visible)}visibleForFeature(e){if(this.template.getExpressionExecutorsForLayer(e.layer)?.visibilityExpression==null)return!0;let t=this._lookupEvaluatedExpression(e,"visibility");return t?.status==="success"&&t.result===!0}};s([o()],H.prototype,"inputs",void 0),s([o({readOnly:!0})],H.prototype,"type",void 0),s([o()],H.prototype,"open",null),s([o()],H.prototype,"visible",null),H=s([x("esri.widgets.BatchAttributeForm.inputs.GroupInput")],H);function De(e,t,i){let r=e.elements.map(n=>St(n,t,i));return new _({inputs:r,template:e})}function St(e,t,i){let r=new Set(e.layers),n=t.filter(l=>r.has(l.layer)),a=n.length===t.length;if(C(e))return new c({existsInAllLayers:a,features:n,template:e,expressionsManager:i});if(B(e)){let l=e.elements.map(u=>St(u,t,i));return new H({existsInAllLayers:a,features:n,inputs:l,template:e,expressionsManager:i})}throw new E("batch-attribute-form:unsupported-element-template","The type of form element template provided is not supported")}var A=class extends L{constructor(e){super(e),this.description=null,this.preserveFieldValuesWhenHidden=!1,this.title=null}get elementsFlat(){let e=[];for(let t of this.elements)if(e.push(t),B(t))for(let i of t.elements)e.push(i);return e}get elementsInCommon(){let e=this.layers.length;return this.elements.filter(t=>t.layers.length===e)}get layers(){let e=new Set(this.elements.flatMap(t=>t.layers));return Array.from(e)}getExpressionExecutorsForLayer(e){let t=new Map;for(let i of this.elementsFlat)i.layers.includes(e)&&t.set(i,i.getExpressionExecutorsForLayer(e));return t}};s([o()],A.prototype,"description",void 0),s([o()],A.prototype,"elements",void 0),s([o()],A.prototype,"elementsFlat",null),s([o()],A.prototype,"elementsInCommon",null),s([o()],A.prototype,"layers",null),s([o()],A.prototype,"preserveFieldValuesWhenHidden",void 0),s([o()],A.prototype,"title",void 0),A=s([x("esri.widgets.BatchAttributeForm.templates.BatchFormTemplate")],A);var Z=A;var Mt=new Map;function Nt(e){return g(this,null,function*(){return(e=P(e)?e.parent:e?.type==="feature"?e:null)?(yield w(Mt,e,()=>{let i=Et.createLoadedLayerContingentValuesCache(e);return e.addHandles({remove(){Mt.delete(e)}}),i}))??null:null})}function Oe(r){return g(this,arguments,function*({element:e,expressionInfos:t,provider:i}){let n={};if(e.visibilityExpression){let a=t.get(e.visibilityExpression);n.visibilityExpression=a?yield i.getArcadeExecutor(a.expression):void 0}if("editableExpression"in e&&e.editableExpression){let a=t.get(e.editableExpression);n.editableExpression=a?yield i.getArcadeExecutor(a.expression):void 0}if("requiredExpression"in e&&e.requiredExpression){let a=t.get(e.requiredExpression);n.requiredExpression=a?yield i.getArcadeExecutor(a.expression):void 0}if("valueExpression"in e&&e.valueExpression){let a=t.get(e.valueExpression);n.valueExpression=a?yield i.getArcadeExecutor(a.expression):void 0}return n})}function Lt(e){return new Map(e?.map(t=>[t.name,t]))}function Dt(e){return e.type==="barcode-scanner"}function Ot(e){return e.type==="combo-box"}function At(e){return e.type==="date-picker"}function Ct(e){return e.type==="datetime-picker"}function kt(e){return e.type==="datetimeoffset-picker"}function Rt(e){return e.type==="radio-buttons"}function Bt(e){return e.type==="switch"}function Ht(e){return e.type==="text-area"}function Pt(e){return e.type==="text-box"}function $t(e){return e.type==="time-picker"}var b="",ai="num:";function ke(e){return C(e)?ie(li(e)).toString():B(e)?ie(ui(e)).toString():ie(JSON.stringify(e)).toString()}function li(e){return`${Gt(e)}.${mi(e.field)}.${di(e.domain)}.${e.hint??b}.${pi(e.input)}.${e.layerTimeZone??""}`}function ui(e){let t=Gt(e)+`.${e.initialState}`,i=b;for(let r of e.elements)i+="."+ke(r).toString();return`${t}${i}`}function Gt(e){return`${e.label??b}.${e.description??b}`}function pi(e){if(!e)return b;let{type:t}=e;if(Dt(e))return t??b;if(Ot(e)||Rt(e)){let{showNoValueOption:i}=e;return`${t}.${i}.${e.noValueOptionLabel??b}`}if(At(e))return`${t}.${Ae(e)}`;if(Ct(e)){let i=e.min?.getTime(),r=e.max?.getTime(),{includeTime:n}=e;return`${t}.${i}.${r}.${n}`}if(kt(e)){let i=Ae(e),{includeTimeOffset:r,timeResolution:n}=e;return`${t}.${i}.${r}.${n}`}if(Bt(e)){let{offValue:i,onValue:r}=e;return`${t}.${Ce(i)}.${Ce(r)}`}if(Ht(e)||Pt(e))return`${t}.${e.minLength?.toString()??b}.${e.maxLength?.toString()??b}`;if($t(e)){let i=Ae(e),{timeResolution:r}=e;return`${t}.${i}.${r}`}return JSON.stringify(e)}function Ae(e){return`${e.min??b}.${e.max??b}`}function mi(e){let t=e.name,i=e.alias??b;return`${t}.${i===t?b:i}.${e.nullable}.${e.type}.${e.length??b}.${e.defaultValue??b}.${e.description??b}.${e.editable}.${e.visible}`}function di(e){return e?e.type==="coded-value"?ci(e):e.type==="range"?fi(e):JSON.stringify(e):b}function ci(e){let{type:t}=e;return`${t}.${e.codedValues.map(({code:i,name:r})=>`${Ce(i)}.${r}`).sort().join(".")}`}function Ce(e){return typeof e=="number"?`${ai}${e}`:e}function fi(e){let{maxValue:t,minValue:i,type:r}=e;return`${r}.${i}.${t}`}var S=class extends Qe{constructor(e){super(e),this.description=null,this.label=null,this._expressionExecutorsByLayer=new V}get elementId(){return ke(this)}get layers(){return Array.from(this._expressionExecutorsByLayer.keys())}addLayer(e,t=null){this._expressionExecutorsByLayer.set(e,t)}foldIn(e){for(let t of e.layers)this.addLayer(t,e.getExpressionExecutorsForLayer(t))}getExpressionExecutorsForLayer(e){return this._expressionExecutorsByLayer.get(e)??null}};s([o()],S.prototype,"description",void 0),s([o({readOnly:!0})],S.prototype,"elementId",null),s([o()],S.prototype,"label",void 0),s([o({readOnly:!0})],S.prototype,"layers",null),s([o({readOnly:!0})],S.prototype,"type",void 0),s([o({clonable:e=>new V(Array.from(e))})],S.prototype,"_expressionExecutorsByLayer",void 0),S=s([x("esri.widgets.BatchAttributeForm.templates.ElementTemplateBase")],S);var F=class extends S{constructor(e){super(e),this.domain=null,this.group=null,this.hint=null,this.input=null,this.type="field",this.layerTimeZone=null,this.formTimeZone=null}get fieldName(){return this.field.name}get hasValueCalculations(){for(let e of this.layers)if(this.getExpressionExecutorsForLayer(e)?.valueExpression)return!0;return!1}};s([o({clonable:"reference"})],F.prototype,"domain",void 0),s([o({clonable:"reference",constructOnly:!0})],F.prototype,"field",void 0),s([o()],F.prototype,"fieldName",null),s([o({clonable:!1})],F.prototype,"group",void 0),s([o()],F.prototype,"hint",void 0),s([o()],F.prototype,"input",void 0),s([o()],F.prototype,"type",void 0),s([o()],F.prototype,"layerTimeZone",void 0),s([o()],F.prototype,"formTimeZone",void 0),s([o()],F.prototype,"hasValueCalculations",null),F=s([x("esri.widgets.BatchAttributeForm.templates.FieldElementTemplate")],F);var U=class extends S{constructor(e){super(e),this.initialState="expanded",this.type="group"}initialize(){for(let e of this.elements)e.group=this}foldIn(e){let{elements:t}=this,i=e.elements;if(t.length!==i.length)throw new E("unable-to-fold-in","Unable to fold in the given GroupElementTemplate because it has a different number of child elements");for(let r of e.layers){this.addLayer(r,e.getExpressionExecutorsForLayer(r));for(let n=0;n<t.length;n++)t.at(n).foldIn(i.at(n))}}};s([o()],U.prototype,"initialState",void 0),s([o({constructOnly:!0})],U.prototype,"elements",void 0),s([o()],U.prototype,"type",void 0),U=s([x("esri.widgets.BatchAttributeForm.templates.GroupElementTemplate")],U);var Re="expression/dea57012-47ca4b55a000-8df62742ed0c",Zt=()=>Y.getLogger("esri.widgets.BatchAttributeForm.templates.templateUtils");function Ut(e,t){return g(this,null,function*(){return e.formTemplate?.elements&&e.formTemplate?.elements.length>0?hi(e,t):Wt(e,t)})}function Wt(r,n){return g(this,arguments,function*(e,{arcadeExecutorProvider:t,formTimeZone:i}){let a=new Set(st(e)),l={arcadeExecutorProvider:t,editTrackingFields:a,formTimeZone:i,layer:e},u=[];for(let d of e.fields)vi(d,e,a)&&u.push(xi(d,l));let p=yield Promise.all(u);return new Z({elements:p,preserveFieldValuesWhenHidden:!0})})}function qt(e,t){for(let i of e??[])if(i.type!=="group"){if(i.type==="field"&&(i.editable===!1&&!i.editableExpression||t.subtypeField&&(P(t)||se(t))&&i.fieldName?.toLowerCase()===t.subtypeField.toLowerCase()))return!0}else if(qt(i.elements??[],t))return!0;return!1}function hi(e,t){return g(this,null,function*(){let i=e.formTemplate;if(!i)return Wt(e,t);let r=null;qt(i.elements??[],e)&&(r=new tt({title:"",name:Re,expression:"false"}));let n=Lt(r?[...i.expressionInfos??[],r]:i.expressionInfos),a={description:i.description,elements:new Array,title:i.title,preserveFieldValuesWhenHidden:i.preserveFieldValuesWhenHidden},{elements:l}=i;if(!l)return new Z(a);let{arcadeExecutorProvider:u,formTimeZone:p}=t;for(let d of l){let m=yield Yt(d,{arcadeExecutorProvider:u,expressionInfos:n,layer:e,formTimeZone:p});m&&a.elements.push(m)}return new Z(a)})}function Yt(e,t){return g(this,null,function*(){return it(e)?yi(e,t):rt(e)?gi(e,t):(Zt().warn(new E("batch-attribute-form:unsupported-element-type",`Form elements of type ${e.type} are not supported`)),null)})}function yi(a,l){return g(this,arguments,function*(e,{arcadeExecutorProvider:t,expressionInfos:i,layer:r,formTimeZone:n}){let{fieldsIndex:u}=r,{description:p,domain:d,fieldName:m,hint:y,input:v,label:N}=e;if(m==null||!u.has(m))return Zt().warn(new E("batch-attribute-form:invalid-form-element-field",`Field element with label '${N}' does not refer to a valid field`)),null;let W={description:p,domain:d,field:u.get(m),hint:y,input:v,formTimeZone:n,layerTimeZone:Xt(r),label:N};e.editable!==!1||e.editableExpression||((e=e.clone()).editableExpression=Re),r.subtypeField&&(P(r)||se(r))&&e.fieldName?.toLowerCase()===r.subtypeField.toLowerCase()&&((e=e.clone()).editableExpression=Re);let k=new F(W),zt=yield Oe({element:e,expressionInfos:i,provider:t});return k.addLayer(r,zt),k})}function gi(e,t){return g(this,null,function*(){let{arcadeExecutorProvider:i,expressionInfos:r,layer:n}=t,{description:a,label:l,initialState:u}=e,p={description:a,elements:[],label:l,initialState:u??"expanded"};for(let y of e.elements){let v=yield Yt(y,t);v&&p.elements.push(v)}let d=new U(p),m=yield Oe({element:e,expressionInfos:r,provider:i});return d.addLayer(n,m),d})}function xi(n,a){return g(this,arguments,function*(e,{arcadeExecutorProvider:t,layer:i,formTimeZone:r}){let l=new F({field:e,label:e.alias??e.name,formTimeZone:r,layerTimeZone:Xt(i)}),u={},p=(se(i)||P(i))&&i.subtypeField&&i.subtypeField.toLowerCase()===e.name.toLowerCase();return!p&&e.editable&&i.userHasUpdateItemPrivileges&&(u.editableExpression=yield t.getArcadeExecutor("true")),p&&(u.editableExpression=yield t.getArcadeExecutor("false")),l.addLayer(i,u),l})}function vi(e,t,i){return!i.has(e.name.toLowerCase())&&ot(e,t)}function Xt(e){return P(e)&&e.parent&&(e=e.parent),e&&"datesInUnknownTimezone"in e&&e.datesInUnknownTimezone?X:e&&"preferredTimeZone"in e&&e.preferredTimeZone?e.preferredTimeZone:null}var f=class extends Ue.EventedAccessor{constructor(e){super(e),this.activeFeatureIndex=-1,this.disabled=!1,this.editType="NA",this.features=new R,this.map=null,this.spatialReference=null,this.submitHasBeenAttempted=!1,this.timeZone=null,this.userHasChangedValues=!1,this._arcadeExecutorProvider=new le,this._activeFormInputsByElementId=new Map,this._emptyForm=new _({inputs:[]}),this._emptyFormTemplate=new Z({elements:[]}),this._featureFormMap=new Map,this._prepareTask=null,this._reactiveGraphicLookup=new V,this._updatingHandles=new et,this._layerTemplateMap=new V,this._layerContingentValuesMap=new V,this._workingFeatures=new R,this._expressionsManager=new M({arcadeContext:{editType:"NA",spatialReference:null,map:null,timeZone:We}}),this.sharedForm=this._emptyForm,this.sharedFormTemplate=this._emptyFormTemplate}initialize(){this.addHandles([Ye(()=>this.features,"after-changes",()=>this._prepare(),{sync:!0}),ce(()=>[this.features,this.map,this.timeZone,this.editType],()=>{this._prepare()},fe),ce(()=>this.activeForm,()=>this._activeFormInputsByElementId.clear(),fe)]),this._prepare()}destroy(){this._prepareTask=re(this._prepareTask),this._workingFeatures.destroyAll(),this._expressionsManager&&this._expressionsManager.abort(),this._reactiveGraphicLookup=new V,this._emptyForm.destroy(),this._emptyFormTemplate.destroy()}get _effectiveTimeZone(){return this.timeZone??"system"}get activeFeature(){let e=this.activeFeatureIndex;return e<0?null:this.features.at(e)}get activeForm(){if(this.mode==="batch")return this.sharedForm;let e=this._workingFeatures.at(this.activeFeatureIndex);if(!e)return this._emptyForm;let t=this._featureFormMap.get(e);if(t)return t;let i=this._makeBatchFormInputsForFeature(e);return i!==this._emptyForm&&this._featureFormMap.set(e,i),i}get calculating(){return this._expressionsManager.calculating}get expressionEvaluationFailed(){return this._expressionsManager.expressionEvaluationFailed}get hasNonActiveInvalidFeatures(){if(this.mode==="batch")return!1;let{activeFeature:e}=this;return this.invalidFeatures.some(t=>t!==e)}get invalidFeatures(){return this.sharedForm.invalidFeatures}get hasVisibleInputs(){return this.visibleInputs.length>0}get hasLayersWithContingentValues(){for(let e of this.layers){let t=this._layerContingentValuesMap.get(e);if(t&&t.size>0)return!0}return!1}get visibleInputs(){return this.activeForm.inputs.filter(e=>e.visible)}get noVisibleElementsReason(){if(this.hasVisibleInputs)return null;if(this.activeForm.inputs.length===0)return O.noElements;let e=new Set;for(let t of this.activeForm.inputs)switch(t.visibilityCode){case h.HIDDEN_NOT_IN_ALL_LAYERS:case h.HIDDEN_NO_DOMAIN_IN_COMMON:e.add(O.noElementsInCommon);break;case h.HIDDEN_FIELD_DEFINITION:case h.HIDDEN_GROUP_VISIBILITY_EXPRESSION_ALL:case h.HIDDEN_VISIBILITY_EXPRESSION_ALL:e.add(O.allElementsHidden);break;case h.HIDDEN_GROUP_VISIBILITY_EXPRESSION_SOME:case h.HIDDEN_VISIBILITY_EXPRESSION_SOME:return O.elementsHiddenInSome}return e.has(O.allElementsHidden)?O.allElementsHidden:O.noElementsInCommon}get status(){let e=this._prepareTask;return e==null?"not-loaded":e.finished?e.error!=null?"failed":"loaded":"loading"}get submittable(){return this.valid,!0}get updating(){return this._updatingHandles.updating||this.calculating}get valid(){return this.sharedForm.valid}get layers(){let e=new Set;return this.features.forEach(t=>{let i=t.sourceLayer??t.layer;e.add(i)}),Array.from(e)}get mode(){return this.activeFeatureIndex>-1?"single":"batch"}submit(){this.submitHasBeenAttempted=!0,this.emit("submit",{})}findFieldInput(e){if(e==null)return;let t=this._activeFormInputsByElementId;if(t.has(e))return t.get(e);let i=this.activeForm.allFieldInputs.find(r=>r.template.elementId===e);return i!==void 0?(t.set(e,i),i):void 0}getFirstVisibleInvalidFieldInput(){if(this.hasVisibleInputs&&!this.activeForm.valid)for(let e of this.visibleInputs){if(ae(e)){let t=e.inputs.find(i=>!i.valid);if(t)return{input:t,groupInput:e}}if(te(e)&&!e.valid)return{input:e}}}getFieldInputValue(e){return this.findFieldInput(e)?.value}getValues(e){let t=this._workingFeatures.find(({original:i})=>i===e);if(!t)throw new E("feature-not-found","The given feature is not present in the BatchAttributeForm");return q({},t.attributes)}setFieldInputValue(e,t){let i=new Set(this.invalidFeatures);e.setValueFromUser(t),this.userHasChangedValues=!0,this._trackValidityChange(i),this.emit("value-change",{features:e.features.toArray().map(r=>r.original),fieldName:e.fieldName,name:"value-change",value:t})}setValue(e,t){let i=this.findFieldInput(e);if(i==null)throw new E("no-FieldInput-found",`Cannot set the value of FieldInput with ID: ${e} because none was found in the active form`);this.setFieldInputValue(i,t)}userChangesHaveMadeFeatureInvalid(e){return!!this._reactiveGraphicLookup.get(e)?.userChangesHaveMadeInvalid}_trackValidityChange(e){return g(this,null,function*(){yield Xe(()=>this.calculating===!1);let t=this.invalidFeatures;for(let i of t)e.has(i)===!1&&this._reactiveGraphicLookup.has(i)&&(this._reactiveGraphicLookup.get(i).userChangesHaveMadeInvalid=!0)})}validate(){return!1}_makeBatchFormInputsForFeature(e){let t=this._layerTemplateMap.get(e.layer);return t?De(t,new R([e]),this._expressionsManager):this._emptyForm}_prepare(){return g(this,null,function*(){this._prepareTask=re(this._prepareTask),this._updateWorkingFeatures(),re(this._expressionsManager),this.userHasChangedValues=!1,this._expressionsManager=new M({arcadeContext:{editType:this.editType,spatialReference:this.spatialReference??ze.WebMercator,map:this.map,timeZone:this._effectiveTimeZone}});let{layers:e}=this;if(e.length===0)return;let t=qe(i=>g(this,null,function*(){try{He(i);let r=new Map;for(let a of e){let l=yield Nt(a);if(l){let p=l.fieldGroups.flatMap(d=>d.fields);this._layerContingentValuesMap.set(a,new Set(p))}else this._layerContingentValuesMap.set(a,new Set);let u=yield Ut(a,{arcadeExecutorProvider:this._arcadeExecutorProvider,formTimeZone:this._effectiveTimeZone});this._layerTemplateMap.set(a,u),this._expressionsManager.layerExpressionsModelMap.set(a,new ue({preserveFieldValuesWhenHidden:u.preserveFieldValuesWhenHidden,executorMap:u.getExpressionExecutorsForLayer(a)}));for(let p of u.elements){let{elementId:d}=p;r.has(d)?r.get(d).foldIn(p):r.set(d,p.clone())}}let n=new Z({elements:Array.from(r.values())});this.sharedFormTemplate=n,this.sharedForm=De(n,this._workingFeatures,this._expressionsManager),yield this._expressionsManager.runAllExpressions(this._workingFeatures)}catch(r){throw Y.getLogger(this).error("Failed preparing form",r),r}}));this._updatingHandles.addPromise(t.promise),this._prepareTask=t})}_updateWorkingFeatures(){this._workingFeatures.destroyAll();let{features:e}=this;if(this._reactiveGraphicLookup=new V,e.length!==0){this._workingFeatures.addMany(e.map(_t));for(let t of this._workingFeatures)this._reactiveGraphicLookup.set(t.original,t)}}};s([o()],f.prototype,"_effectiveTimeZone",null),s([o({readOnly:!0})],f.prototype,"activeFeature",null),s([o()],f.prototype,"activeFeatureIndex",void 0),s([o({readOnly:!0})],f.prototype,"activeForm",null),s([o()],f.prototype,"disabled",void 0),s([o()],f.prototype,"calculating",null),s([o()],f.prototype,"editType",void 0),s([o()],f.prototype,"features",void 0),s([o()],f.prototype,"expressionEvaluationFailed",null),s([o()],f.prototype,"hasNonActiveInvalidFeatures",null),s([o()],f.prototype,"invalidFeatures",null),s([o()],f.prototype,"hasVisibleInputs",null),s([o()],f.prototype,"hasLayersWithContingentValues",null),s([o()],f.prototype,"visibleInputs",null),s([o()],f.prototype,"map",void 0),s([o()],f.prototype,"noVisibleElementsReason",null),s([o()],f.prototype,"spatialReference",void 0),s([o()],f.prototype,"submitHasBeenAttempted",void 0),s([o()],f.prototype,"timeZone",void 0),s([o()],f.prototype,"updating",null),s([o()],f.prototype,"valid",null),s([o()],f.prototype,"layers",null),s([o()],f.prototype,"mode",null),s([o()],f.prototype,"sharedForm",void 0),s([o()],f.prototype,"sharedFormTemplate",void 0),s([o()],f.prototype,"userHasChangedValues",void 0),s([o()],f.prototype,"_arcadeExecutorProvider",void 0),s([o()],f.prototype,"_prepareTask",void 0),s([o()],f.prototype,"_reactiveGraphicLookup",void 0),s([o()],f.prototype,"_layerTemplateMap",void 0),s([o()],f.prototype,"_layerContingentValuesMap",void 0),s([o()],f.prototype,"_workingFeatures",void 0),s([o()],f.prototype,"_expressionsManager",void 0),f=s([x("esri.widgets.BatchAttributeForm.BatchAttributeFormViewModel")],f);var Sn=f;export{Me as a,h as b,te as c,ae as d,Yi as e,Xi as f,zi as g,Sn as h};
