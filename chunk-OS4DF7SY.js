import{a as Pe}from"./chunk-XPTSGTNZ.js";import{c as O,e as ye}from"./chunk-M575ORV2.js";import{a as de,c as ve,f as W,g as ge}from"./chunk-CISTQZ5X.js";import{k as he}from"./chunk-Z7TBAZRW.js";import{a as me}from"./chunk-N62DQME2.js";import{d as ue}from"./chunk-XLL67PCY.js";import{i as ce,q as fe}from"./chunk-QXXXCEV5.js";import{x as pe}from"./chunk-6B5XFA6F.js";import{g as z,s as V}from"./chunk-DA3SDKGO.js";import{a as ie}from"./chunk-MDZTV2VL.js";import{n as le}from"./chunk-7LHOQXZT.js";import{a as F}from"./chunk-U4QEPZJ3.js";import{g as q,r as ae}from"./chunk-EQZWYK27.js";import{a as Q}from"./chunk-7F5DJLJT.js";import{L as se,aa as k,ca as b,f as re}from"./chunk-NJWTSROP.js";import{F as oe,p as M,t as te,y as ne}from"./chunk-4PTIEWMT.js";import{n as $,y as ee}from"./chunk-QBWJMFH5.js";import{a as T,b as N,f as G,g as H,h as Y}from"./chunk-VTHXE323.js";var we="ProfileGenerationError",w;(function(e){e.TooComplex="too-complex",e.InvalidGeometry="invalid-geometry",e.InvalidElevationInfo="invalid-elevation-info",e.ElevationQueryError="elevation-query-error"})(w||(w={}));var E=class extends Error{constructor(t){super("profile could not be generated",{cause:t}),this.type=we}};function $e(e){return e.type===we}function Ze(e,t,n,o,a,i,s){return G(this,null,function*(){let r,l,c,f=e.spatialReference,h=f.isGeographic||f.isWebMercator,p=0;if(!h){let{planarLength:m}=yield import("./chunk-ZASZZYFJ.js");M(s),p=yield m(e,"meters"),M(s)}let d=1/b(o);if(h){yield V([{source:f,dest:o},{source:f,dest:Q.WGS84}],s);let m=ke(e);r=ve([m],"meters")[0];let v=Ee(r,a);if(Re(e,r,v)>i)throw new E(w.TooComplex);let u=xe(m,t,n);({densifiedPath:l,distances:c}=Le(u,v,d)),l=z(l,o)}else{yield V([{source:f,dest:o}],s),r=p;let m=Ee(r,a);if(Re(e,r,m)>i)throw new E(w.TooComplex);let v=xe(e,t,n);({densifiedPath:l,distances:c}=Oe(v,m,d)),M(s),l=z(l,o)}return{densifiedPath:l,pathLength:r*d,distances:c}})}function Ee(e,t){let n=e/t.densificationMaxSamples;return Math.max(t.samplingDistance,n)}function xe(e,t,n){if(t==null)return Se(e);let o=e.spatialReference,a=t.mode,i=he(t,o),s=null;switch(n.type){case"2d":s=De(e,a,i);break;case"3d":s=Te(e,a,i,n)}return s==null?Se(e):new F({hasZ:!0,hasM:!1,spatialReference:o,paths:Ce(e.paths,s)})}function De({hasZ:e},t,n){return t==="absolute-height"?e?([o,a,i])=>[o,a,i+n]:([o,a])=>[o,a,n]:null}function Te({spatialReference:e,hasZ:t},n,o,{elevationProvider:a}){let i=(s,r,l,c)=>a?.getElevation(s,r,l,e,c)??0;switch(n){case"on-the-ground":return([s,r])=>[s,r,i(s,r,0,"ground")];case"absolute-height":return t?([s,r,l])=>[s,r,l+o]:([s,r])=>[s,r,o];case"relative-to-ground":return t?([s,r,l])=>[s,r,l+i(s,r,l,"ground")+o]:([s,r])=>[s,r,i(s,r,0,"ground")+o];case"relative-to-scene":return t?([s,r,l])=>[s,r,l+i(s,r,l,"scene")+o]:([s,r])=>[s,r,i(s,r,0,"scene")+o];default:return null}}function Se(e){return e.hasZ?new F({hasZ:!1,hasM:!1,spatialReference:e.spatialReference,paths:Ce(e.paths,([t,n])=>[t,n])}):e}function Ce(e,t){let n=e.length,o=new Array(n);for(let a=0;a<n;++a){let i=e[a],s=i.length,r=new Array(i.length);o[a]=r;for(let l=0;l<s;++l)r[l]=t(i[l])}return o}function _e(e){return He(e)&&e.paths.length>0&&e.paths.every(t=>t.length>=2)}function He(e){return e!=null&&e.type==="polyline"}function Me(e,t,n,o,a){let{spatialReference:i,hasZ:s}=e,r={from:null,to:null,distance:0,azimuth:0,reverseAzimuth:0,spatialReference:i,metersPerSR:b(i)},l=[],c=[],f=0;for(let h=0;h<e.paths.length;++h){let p=e.paths[h],d=new Array,m=new Array,v=0;for(let u=1;u<p.length;++u){let g=p[u-1],x=p[u],S=o(r,g,x),R;for(R=v;R<S.distance&&!ae(R,S.distance);R+=t)d.push(a(S,R)),m.push((f+R)*n);v=R-S.distance,f+=S.distance,d.push(x),m.push(f*n)}l[h]=d,c[h]=m}return{densifiedPath:new F({spatialReference:i,hasZ:s,paths:l}),distances:c}}function Oe(e,t,n){let{hasZ:o}=e;return Me(e,t,n,qe,o?je:Ue)}function Le(e,t,n){let{hasZ:o}=e;return Me(e,t,n,Ne,o?ze:Fe)}function Ne(e,t,n){return e.distance=0,ge(e,t,n,e.spatialReference),e.from=t,e.to=n,e}function qe(e,t,n){return e.from=t,e.to=n,e.distance=ce(n,t)*e.metersPerSR,e}function Fe({from:e,azimuth:t,spatialReference:n},o){return W([0,0],e,t,o,n)}function ze({from:e,to:t,azimuth:n,distance:o,spatialReference:a},i){let s=i/o,r=[0,0,q(e[2],t[2],s)];return W(r,e,n,i,a),r}function Ue({from:e,to:t,distance:n},o){return fe([0,0],e,t,o/n)}function je({from:e,to:t,distance:n},o){return pe([0,0,0],e,t,o/n)}function ke(e){return de(e.spatialReference)?e:z(e,Q.WGS84)}function B(e){return e.paths.reduce((t,n)=>t+n.length,0)}function Re(e,t,n){return B(e)+Math.floor(t/n)+Math.max(0,e.paths.reduce(o=>1+o,0)-1)}function Ge(e,t){let n=e.length;if(n===0)return null;let o=e[0],a=o.sampledZ,i=a,s=a,r=0,l=0,c=null,f=null,h=a??0,p=0,d=0,m=a!=null?1:0,v=0,u=0,g=b(t),x=k(t),S=O().minSlopeSampleDistance/g,R=2*S,A=new U,P=new U,j=()=>{Ie(),A.copy(P),P.reset()},X=(y,I)=>{j(),y>0&&y-A.start<=R&&(y=A.start+S),P.restart(y,I)},Ie=()=>{if(A.isHole||P.isHole)return;let y=P.avgElevation-A.avgElevation,I=P.start-A.start,D=y*x,Z=I*g,C=se(Math.atan2(D,Z),"radians","degrees");C>0?(p+=C,c=_(c,C),v++):C<0&&(d-=C,f=_(f,-C),u++)};o.sampledZ!=null&&X(o.distance,o.sampledZ);for(let y=1;y<n;++y){let I=e[y-1],D=e[y],Z=D.sampledZ;if(Z==null){P.isHole||j();continue}m++,h+=Z,i=K(i,Z),s=_(s,Z),P.isHole||D.distance-P.start>=S?X(D.distance,Z):P.insert(Z);let C=I.sampledZ;if(C!=null){let L=Z-C;L>0?r+=L:L<0&&(l-=L)}}return j(),m===0?null:{maxDistance:e[n-1].distance,minElevation:i,maxElevation:s,avgElevation:m===0?null:h/m,elevationGain:r,elevationLoss:l,maxPositiveSlope:c,maxNegativeSlope:f,avgPositiveSlope:v===0?null:p/v,avgNegativeSlope:u===0?null:d/u}}function gt(e){let t=e.filter(ee),n=t.length;if(n===0)return null;let o=t[0];if(n===1)return o;let a=o.maxDistance,i=o.minElevation,s=o.maxElevation,r=o.maxPositiveSlope,l=o.maxNegativeSlope;for(let c=1;c<t.length;++c){let f=t[c];a=_(a,f.maxDistance),i=K(i,f.minElevation),s=_(s,f.maxElevation),r=_(r,f.maxPositiveSlope),l=_(l,f.maxNegativeSlope)}return{maxDistance:a,minElevation:i,maxElevation:s,avgElevation:null,elevationGain:null,elevationLoss:null,maxPositiveSlope:r,maxNegativeSlope:l,avgPositiveSlope:null,avgNegativeSlope:null}}function yt(e){let t=null,n=null,o=null;for(let a of e){if(a==null)continue;let{statistics:i,spatialReference:s}=a;if(i==null)continue;let r=b(s);t=_(t,J(i.maxDistance,r));let l=k(s);o=K(o,J(i.minElevation,l)),n=_(n,J(i.maxElevation,l))}return{minDistance:0,maxDistance:t??0,minElevation:o??0,maxElevation:n??0}}function K(e,t){return t==null?e:e!=null?Math.min(e,t):t}function _(e,t){return t==null?e:e!=null?Math.max(e,t):t}function J(e,t){return e!=null&&t!=null?e*t:null}var U=class{constructor(){this._start=0,this._totalElevation=0,this._sampleCount=0}get avgElevation(){return this._totalElevation/this._sampleCount}get isHole(){return this._sampleCount===0}get start(){return this._start}copy(t){this._start=t._start,this._sampleCount=t._sampleCount,this._totalElevation=t._totalElevation}reset(){this._start=0,this._sampleCount=0,this._totalElevation=0}restart(t,n){this._start=t,this._sampleCount=1,this._totalElevation=n}insert(t){++this._sampleCount,this._totalElevation+=t}};function Dt(e,t){return Y(this,null,function*(){let{view:n,geometry:o,elevationInfo:a,providers:i,options:s}=e,r=n.spatialReference;if(!r||o==null||!_e(o))throw new E(w.InvalidGeometry);let l=i.length;if(l===0)return null;let c=Math.round(s.maxTotalSamples/l);if(B(o)>c)throw new E(w.TooComplex);let f=yield new H(Ze(o,a,n,r,s,c,t)),h=0,p=new Array(l),d=new Array(l);for(let u=0;u<l;u++){let g=Je(f);p[u]=g,h+=g.samples.length;let x=N(T({},e),{provider:i[u],result:g,densificationResult:f});d[u]=Qe(x,t)[Symbol.iterator]()}if(h>s.maxTotalSamples)throw new E(w.TooComplex);let m=yield new H(Promise.all(d.map(u=>{let g=u.next();return g.done===!0?Promise.resolve(null):g.value})));M(t);for(let u=0;u<l;u++)p[u]=m[u];yield p,yield new H(oe(e.delayAfterPreview??O().delayAfterPreviewMillis,null,t.signal));let v=[];try{let u;do{u=!1;for(let g=0;g<l;g++){let x=d[g].next();x.done===!1&&(v.push({resultPromise:x.value,index:g}),u=!0)}}while(u)}finally{d.forEach(u=>u.return?.())}for(let{resultPromise:u,index:g}of v)p[g]=yield new H(u),M(t),yield p;for(let u of p)u!=null&&(u.progress=1);yield p})}function*Qe(e,t){let{densificationResult:n}=e,o=N(T({},e),{abortOptions:t,densificationResult:n}),a=Pe(0,o.result.samples.length),i=a.slice(0,o.provider.numSamplesForPreview);yield Ae(o,i,!0);let s=$(a,o.provider.numSamplesPerChunk);for(let r of s)yield Ae(o,r,!1)}function Ae(l,c,f){return G(this,arguments,function*({densificationResult:e,result:t,provider:n,queue:o,abortOptions:a,cache:i},s,r){let{densifiedPath:h,pathLength:p}=e,d=t.spatialReference,{samples:m}=t,v=[];for(let u=0;u<s.length;u++){let g=m[s[u]];v[u]=g.coordinate}try{return yield o.push({geometry:new ie({spatialReference:d,points:v,hasZ:h.hasZ}),provider:n,indices:s,preview:r,result:t,queryOptions:N(T({},O().defaultQueryOptions()),{minDemResolution:Math.round(r?p/n.numSamplesForPreview:p/m.length),cache:i})},a),T({},t)}catch(u){return ne(u)?null:ye}})}function Tt(e){return new me({priority:ue.ELEVATION_PROFILE,concurrency:1,scheduler:e,process:t=>G(this,null,function*(){M(t.queryOptions);try{yield Ve(t)}catch(n){te(n)}})})}function Ve(s){return G(this,arguments,function*({geometry:e,provider:t,indices:n,preview:o,result:a,queryOptions:i}){if(n.length===0)return;let r=(yield Ye(t,e,i)).geometry,{hasZ:l,points:c}=r,f=i.noDataValue,{samples:h}=a;for(let p=0;p<n.length;p++){let d=h[n[p]];if(d.isHole)continue;let m=l?c[p][2]:null;m===null||m===f?d.sampledZ=null:(a.hasZ=!0,d.sampledZ=m),d.sampled=!0}We(h),a.progress=o?0:a.progress+n.length/h.length,a.statistics=Ge(a.samples,a.spatialReference)})}function We(e){let t=e.length-1,n=0;for(let o=1;o<=t;o++)(e[o].sampled||o===t)&&(Be(e,n,o),n=o)}function Be(e,t,n){if(n-t==1)return;let o=e[t],a=o.sampledZ,i=e[n],s=i.sampledZ;if(a==null||s==null){for(let c=t+1;c<n;c++)e[c].sampledZ=null;return}let r=o.distance,l=i.distance-r;for(let c=t+1;c<n;c++){let f=e[c],h=(f.distance-r)/l;f.sampledZ=q(a,s,h)}}function Je({densifiedPath:e,distances:t}){let n=e.spatialReference,o=re(n),a=e.paths,i=a.length,s=[],r=null,l=0;for(let c=0;c<i;c++){let f=a[c],h=f.length,p=t[c];for(let d=0;d<h;d++){let m=f[d],v=p[d];o&&(m[0]=le(m[0],o.valid[0],o.valid[1])),r&&d===0&&Ke(s,r,m,l,v),s.push(Xe(m,v)),r=m,l=v}}return{progress:0,samples:s,hasZ:!1,statistics:null,spatialReference:n}}function Ke(e,t,n,o,a){e.push(be(t,o)),e.push(be(n,a))}function Xe(e,t){return{coordinate:e,distance:t,sampledZ:null,sampled:!1,isHole:!1}}function be(e,t){return{coordinate:e,distance:t,sampledZ:null,sampled:!0,isHole:!0}}function Ye(e,t,n){return G(this,null,function*(){try{return yield e.queryElevation(t,n)}catch{throw new E(w.ElevationQueryError)}})}function Ht(e,t,n){if(!e||e.length===0)return;let o=e.length-1,a=e[0];if(t<=n(a))return a;let i=e[o];if(t>=n(i))return i;let s=0,r=0,l=o;for(;s<l;){r=s+Math.floor((l-s)/2);let c=e[r],f=n(c);if(f===t)return c;if(t<f){if(r>0){let h=e[r-1],p=n(h);if(t>p)return t-p>=f-t?c:h}l=r}else{if(r<o){let h=e[r+1],p=n(h);if(t<p)return t-f>=p-t?h:c}s=r+1}}return e[r]}export{w as a,$e as b,_e as c,He as d,gt as e,yt as f,Dt as g,Tt as h,Ht as i};
