import{a as ft}from"./chunk-EKHW2ZUO.js";import{d as mt}from"./chunk-SNC52ZAM.js";import{a as gt}from"./chunk-PFQXJNFG.js";import{a as _t}from"./chunk-5DVGZXEZ.js";import{o as l}from"./chunk-7HMNN4FJ.js";import{a as pt,e as dt}from"./chunk-UKAGN54W.js";import{a as ut}from"./chunk-342NGUMP.js";import{c as q}from"./chunk-AYNBEMCC.js";import{a as O}from"./chunk-QCZ3ZIGQ.js";import{A as L,e as G,g as lt,o as U,p as z}from"./chunk-7SDNM7YV.js";import{f as S}from"./chunk-ONYJLWAD.js";import{a as at,d as y}from"./chunk-XLL67PCY.js";import{F as nt,d as st,l as rt}from"./chunk-GJ2QRXGN.js";import{b as ct}from"./chunk-EO2H4LIH.js";import{a as M}from"./chunk-ALWV3RJ2.js";import{F as ht,c as u,d as ot,n as I,v as N,y as F}from"./chunk-6B5XFA6F.js";import{f as it}from"./chunk-ZTOZWLEE.js";import{a as f}from"./chunk-BOVYXYHK.js";import{a as tt,o as et}from"./chunk-KVM6SHDX.js";import{g as k}from"./chunk-EQZWYK27.js";import{B as x}from"./chunk-NJWTSROP.js";import{a as m,i as Z,j as $}from"./chunk-TG45K3WR.js";import{a as X}from"./chunk-T7DXJKX7.js";import{a as h}from"./chunk-QGVBCWUY.js";import{H as w}from"./chunk-MYO4NP2N.js";import{e as p}from"./chunk-NFIPKH6V.js";import{l as C}from"./chunk-5QEXLALV.js";import{a as P}from"./chunk-TG2UTNEO.js";var g=class extends w{constructor(s){super(s),this._dirtyExtents=new mt,this._globalDirty=!1,this._averageExtentUpdateSize=0,this._dirtyGraphicsSet=new Set,this._updateElevation=!1,this.graphicsCoreOwner=null,this.graphicsCore=null,this.events=new X}initialize(){let s=this.elevationProvider,t=this.graphicsCoreOwner.view.resourceController.scheduler;this._task=t.registerTask(yt(this.graphicsCore.layer.elevationInfo?.mode),this),this.addHandles([s.on("elevation-change",e=>this._elevationChanged(e)),m(()=>this.graphicsCoreOwner.suspended,()=>this._suspendedChange()),this._task,m(()=>yt(this.graphicsCore.layer.elevationInfo?.mode),e=>this._task.priority=e)])}destroy(){this._dirtyGraphicsSet.clear(),this.graphicsCoreOwner=null,this.graphicsCore=null,this.queryGraphicUIDsInExtent=null,this.elevationProvider=null}clear(){this._dirtyGraphicsSet.clear(),this.notifyChange("updating")}_suspendedChange(){this.graphicsCoreOwner.suspended===!0?this._updateElevation=!1:this.graphicsCoreOwner.suspended===!1&&this._updateElevation&&(this._globalDirty=!0,this.notifyChange("updating"))}elevationInfoChange(){this._globalDirty=!0,this.notifyChange("updating")}get updating(){return this.running}get running(){return this._dirtyGraphicsSet.size>0||this._dirtyExtents&&!this._dirtyExtents.empty||this._globalDirty}get updatingRemaining(){return this._dirtyGraphicsSet.size+this._dirtyExtents.size*this._averageExtentUpdateSize}runTask(s){for(this._globalDirty&&(this._markAllGraphicsElevationDirty(),this._globalDirty=!1,s.madeProgress()),s.run(()=>this._dirtyExtents.merge(s));this.running&&!s.done;)this._updateDirtyGraphics(s),this._updateDirtyExtents(s);this.notifyChange("updating")}_updateDirtyGraphics(s){let t=this.graphicsCoreOwner.view.renderCoordsHelper,e=this.graphicsCore.effectiveUpdatePolicy===_t.ASYNC;for(let i of this._dirtyGraphicsSet.keys()){let n=this.graphicsCore.getGraphics3DGraphicById(i);if(this._dirtyGraphicsSet.delete(i),n!=null&&(n.alignWithElevation(this.elevationProvider,t,e),this.graphicsCore.deconflictor?.setDirty(),s.madeProgress()),s.done)return}}_updateDirtyExtents(s){for(;!this._dirtyExtents.empty&&!s.done;){let t=this._dirtyExtents.pop(),e=this.elevationProvider.spatialReference;this.events.emit("invalidate-elevation",{extent:t,spatialReference:e});let i=this._dirtyGraphicsSet.size;this.queryGraphicUIDsInExtent(t,e,n=>{let r=this.graphicsCore.getGraphics3DGraphicById(n);r!=null&&r.needsElevationUpdates()&&this._dirtyGraphicsSet.add(n)}),this._averageExtentUpdateSize=.1*(this._dirtyGraphicsSet.size-i)+.9*this._averageExtentUpdateSize,s.madeProgress()}}_markAllGraphicsElevationDirty(){this._dirtyExtents.clear(),this._dirtyGraphicsSet.clear(),this.graphicsCore.graphics3DGraphics.forEach((s,t)=>this._dirtyGraphicsSet.add(t))}_elevationChanged(s){if(s.context==="scene"&&(!this.graphicsCore.layer.elevationInfo||this.graphicsCore.layer.elevationInfo.mode!=="relative-to-scene"))return;let t=s.extent;if(this.graphicsCoreOwner.suspended){if(!this._updateElevation){let e=this.graphicsCore.computedExtent;e&&t[2]>e.xmin&&t[0]<e.xmax&&t[3]>e.ymin&&t[1]<e.ymax&&(this._updateElevation=!0)}this.events.emit("invalidate-elevation",s)}else t[0]===-1/0?this._globalDirty=!0:this._dirtyExtents.add(t),this.notifyChange("updating")}};function yt(s){return s==null?y.ELEVATION_ALIGNMENT:s==="relative-to-scene"?y.ELEVATION_ALIGNMENT_SCENE:y.ELEVATION_ALIGNMENT}h([p()],g.prototype,"graphicsCoreOwner",void 0),h([p()],g.prototype,"graphicsCore",void 0),h([p()],g.prototype,"queryGraphicUIDsInExtent",void 0),h([p()],g.prototype,"elevationProvider",void 0),h([p({readOnly:!0})],g.prototype,"updating",null),h([p({readOnly:!0})],g.prototype,"updatingRemaining",null),g=h([C("esri.views.3d.layers.graphics.Graphics3DElevationAlignment")],g);var xt=.5*Math.PI,bt=xt/Math.PI*180,D=class{constructor(t){this._extent=new Array(4),this._planes=new Array(6),this._maxSpan=0,this._center={origin:f(),direction:f()},this._renderCoordsHelper=t.renderCoordsHelper;for(let e=0;e<4;e++)this._extent[e]={origin:f(),direction:f(),cap:{next:null,direction:f()}},this._planes[e]=G();this._planes[l.NEAR]=G(),this._planes[l.FAR]=G(),this._planesWithoutFar=this._planes.slice(0,5)}update(t,e,i,n=!0){let r=this._extent;this._toRenderBoundingExtent(t,e,i),ot(this._center.origin,r[0].origin,r[2].origin),I(this._center.origin,this._center.origin,.5),this._renderCoordsHelper.worldUpAtPosition(this._center.origin,this._center.direction),n||I(this._center.direction,this._center.direction,-1);for(let a=0;a<4;a++){let c=r[a];this._renderCoordsHelper.worldUpAtPosition(c.origin,c.direction);let E=r[a===3?0:a+1];c.cap.next=E.origin,ht(c.cap.direction,c.origin,E.origin),z(c.direction,c.cap.direction,c.origin,this._planes[a]),n||I(c.direction,c.direction,-1)}z(r[0].cap.direction,r[1].cap.direction,r[0].origin,this._planes[l.NEAR]),n?U(this._planes[l.NEAR],this._planes[l.FAR]):(lt(this._planes[l.FAR],this._planes[l.NEAR]),U(this._planes[l.NEAR],this._planes[l.NEAR])),this._maxSpan=Math.max(Math.abs(t[0]-t[2]),Math.abs(t[1]-t[3])),this._maxSpanSpatialReference=e,this._minGlobalAltitude=.9*x(this._maxSpanSpatialReference).radius}isVisibleInFrustum(t,e,i=!1){if(t==null)return!1;if(this._renderCoordsHelper.viewingMode===O.Global){let r=this._maxSpanSpatialReference.isGeographic?bt:xt*e;if(this._maxSpan>r)return!0;if(t.altitude!=null&&t.altitude>=this._minGlobalAltitude)return this._isVisibleInFrustumGlobal(t)}if(this._maxSpan===0){let r=this._extent[0];return!(i||!t.intersectsRay(q(r.origin,r.direction)))}for(let r=0;r<this._extent.length;r++){let a=this._extent[r];if(!i&&t.intersectsRay(q(a.origin,a.direction))||t.intersectsLineSegment(dt(a.origin,a.cap.next,Ct),a.cap.direction))return!0}let n=i?this._planes:this._planesWithoutFar;for(let r=0;r<t.lines.length;r++){let a=t.lines[r];if(ft(n,a.origin,a.endpoint,a.direction))return!0}return!1}_toRenderBoundingExtentGlobal(t,e,i){et(t,d),d[2]=i,ct(e,d,W,this._renderCoordsHelper.spatialReference),it(St,W),nt(o);for(let{x0:r,x1:a,y0:c,y1:E}of Et)for(let V=0;V<5;V++){let Q=V/4;d[0]=k(t[r],t[a],Q),d[1]=k(t[c],t[E],Q),d[2]=i,ut(d,e,d,this._renderCoordsHelper.spatialReference),F(d,d,St),rt(o,d)}u(this._extent[0].origin,o[0],o[1],o[2]),u(this._extent[1].origin,o[3],o[1],o[2]),u(this._extent[2].origin,o[3],o[4],o[2]),u(this._extent[3].origin,o[0],o[4],o[2]);for(let r=0;r<4;++r)F(this._extent[r].origin,this._extent[r].origin,W)}_toRenderBoundingExtentLocal(t,e,i){gt(t,e,_,this._renderCoordsHelper.spatialReference),u(this._extent[0].origin,_[0],_[1],i),u(this._extent[1].origin,_[2],_[1],i),u(this._extent[2].origin,_[2],_[3],i),u(this._extent[3].origin,_[0],_[3],i)}_toRenderBoundingExtent(t,e,i){switch(this._renderCoordsHelper.viewingMode){case O.Global:this._toRenderBoundingExtentGlobal(t,e,i);break;case O.Local:this._toRenderBoundingExtentLocal(t,e,i);break;default:this._renderCoordsHelper.viewingMode}}_isVisibleInFrustumGlobal(t){if(L(t.planes[l.NEAR],this._center.origin)<0&&N(this._center.direction,t.direction)<0)return!0;for(let e=0;e<4;e++){let i=this._extent[e];if(L(t.planes[l.NEAR],i.origin)<0&&N(i.direction,t.direction)<0)return!0}return!1}},Et=[{x0:0,y0:1,x1:2,y1:1},{x0:0,y0:3,x1:2,y1:3},{x0:0,y0:1,x1:0,y1:3},{x0:2,y0:1,x1:2,y1:3}],d=f(),W=M(),St=M(),o=st(),_=tt(),Ct=pt();var wt=1.2,v=class extends w{constructor(s){super(s),this.suspended=!1,this._extent=null,this._extentIntersectionDirty=!0,this._isVisibleBelowSurfaceInternal=!1,this.graphicsCoreOwner=null,this.updating=!0}initialize(){let{graphicsCoreOwner:s}=this;this._extentIntersection=new D({renderCoordsHelper:s.view.renderCoordsHelper});let t=s.view,e=t.basemapTerrain,i=t.resourceController.scheduler;this.addHandles([t.on("resize",()=>this._viewChange()),m(()=>t.state.camera,()=>this._viewChange(),Z),i.registerTask(y.FRUSTUM_VISIBILITY,this),m(()=>e.visibleElevationBounds,()=>this._elevationBoundsChange())]),t.viewingMode==="local"?this._isVisibleBelowSurface=!0:this.addHandles([m(()=>[e.baseOpacity,e.wireframe,t.map?.ground?.navigationConstraint?.type],()=>this._updateIsVisibleBelowSurface(),$)])}destroy(){this._set("graphicsCoreOwner",null),this._extent=null,this._extentIntersection=null}_setDirty(){this.updating||this._set("updating",!0)}setExtent(s){this._extent=s,this._extentIntersectionDirty=!0,this._setDirty()}_viewChange(){this._setDirty()}_elevationBoundsChange(){this._setDirty(),this._extentIntersectionDirty=!0}set _isVisibleBelowSurface(s){this._isVisibleBelowSurfaceInternal=s,this._setDirty(),this._extentIntersectionDirty=!0}_updateIsVisibleBelowSurface(){let s=this.graphicsCoreOwner.view,t=s.basemapTerrain,e=s.viewingMode==="local",i=s.map.ground?.navigationConstraint?.type==="none";this._isVisibleBelowSurface=e||!t.opaque||i}_updateExtentIntersection(){if(!this._extentIntersectionDirty)return;this._extentIntersectionDirty=!1;let s=this.graphicsCoreOwner.view,t;if(this._isVisibleBelowSurfaceInternal)t=-.3*x(s.spatialReference).radius;else{let{min:e,max:i}=s.basemapTerrain.visibleElevationBounds;t=e-Math.max(1,(i-e)*(wt-1))}this._extentIntersection.update(this._extent,s.spatialReference,t)}get running(){return this.updating}runTask(s){if(this._set("updating",!1),!this._extent)return this._set("suspended",!1),at;this._updateExtentIntersection();let t=this.graphicsCoreOwner.view.frustum,e=x(this.graphicsCoreOwner.view.spatialReference).radius;this._set("suspended",!this._extentIntersection.isVisibleInFrustum(t,e)),s.madeProgress()}};h([p({readOnly:!0})],v.prototype,"suspended",void 0),h([p({constructOnly:!0})],v.prototype,"graphicsCoreOwner",void 0),h([p({readOnly:!0})],v.prototype,"updating",void 0),v=h([C("esri.views.3d.layers.graphics.Graphics3DFrustumVisibility")],v);var b=class{},Y=class extends b{constructor(t,e){super(),this.objectStateId=t,this.object=e}remove(){this.object.removeStateID(this.objectStateId)}},J=class extends b{constructor(t,e,i){super(),this.objectStateId=t,this.object=e,this.owner=i}remove(){this.owner.removeRenderGeometryObjectState(this.object,this.objectStateId)}},K=class extends b{constructor(t,e){super(),this.objectStateId=t,this._removeCallback=e,this.object=null}remove(){this._removeCallback(this.objectStateId)}},j=class{constructor(){this._items=[]}addObject(t,e){this._items.push(new Y(e,t))}addRenderGeometry(t,e,i){this._items.push(new J(e,t,i))}addExternal(t,e){this._items.push(new K(e,t))}remove(t){this._remove(e=>e.objectStateId===t)}removeByObject(t){this._remove(e=>e.object===t)}removeAll(){this._items.forEach(t=>t.remove()),this._items=[]}_remove(t){let{_items:e}=this;for(let i=e.length-1;i>=0;--i){let n=e[i];t(n)&&(n.remove(),e.splice(i,1))}}},R=class extends j{constructor(){super(...arguments),this.stateType=S.MaskOccludee}},A=class extends j{constructor(t){super(),this.highlightName=t,this.stateType=S.Highlight}};var H=class{constructor(t){this.objectIdField=t,this.ids=new Set,this.paused=!1}hasGraphic(t){let e=this.objectIdField?t.graphic.attributes[this.objectIdField]:t.graphic.uid;return this.ids.has(e)}},B=class extends H{constructor(t){super(t),this.stateType=S.MaskOccludee,this.objectStateSet=new R}},T=class extends H{constructor(t,e){super(e),this.highlightName=t,this.stateType=S.Highlight,this.objectStateSet=new A(t)}};var vt=class{constructor(t){this._graphicsCore=t,this._stateSets=new Array}destroy(){this.reset(),this._stateSets=null}reset(){this._stateSets&&(this._stateSets.forEach(t=>t.objectStateSet.removeAll()),this._stateSets.length=0)}acquireOccludeeSet(t){let e=new B(t);this._stateSets.push(e);let i=P(()=>this.releaseSet(e));return{set:e,handle:i}}acquireHighlightSet(t,e){let i=new T(t,e);this._stateSets.push(i);let n=P(()=>this.releaseSet(i));return{set:i,handle:n}}releaseSet(t){t.objectStateSet.removeAll();let e=this._stateSets?this._stateSets.indexOf(t):-1;e!==-1&&this._stateSets.splice(e,1)}setUid(t,e){t.ids.add(e);let i=this._graphicsCore.graphics3DGraphics.get(e);i&&i.addObjectStateSet(t.objectStateSet)}setUids(t,e){e.forEach(i=>this.setUid(t,i))}setObjectIds(t,e){e.forEach(i=>t.ids.add(i)),this._initializeSet(t)}addGraphic(t){this._stateSets.forEach(e=>{!e.paused&&e.hasGraphic(t)&&t.addObjectStateSet(e.objectStateSet)})}removeGraphic(t){this._stateSets.forEach(e=>{e.hasGraphic(t)&&t.removeObjectState(e.objectStateSet)})}allGraphicsDeleted(){this._stateSets&&this._stateSets.forEach(t=>t.objectStateSet.removeAll())}_initializeSet(t){let e=this._graphicsCore.graphics3DGraphics;t.objectIdField?e.forEach(i=>{i&&t.hasGraphic(i)&&i.addObjectStateSet(t.objectStateSet)}):t.ids.forEach(i=>{let n=e.get(i);n&&n.addObjectStateSet(t.objectStateSet)})}get test(){}};export{g as a,v as b,vt as c};
