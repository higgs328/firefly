import{a as ft}from"./chunk-PSH6AM2I.js";import{a as vt}from"./chunk-E7FZSPTU.js";import{a as _t}from"./chunk-GHRDCMSY.js";import{a as gt}from"./chunk-AMX6AASB.js";import{t as yt}from"./chunk-DT6D5YZT.js";import{a as mt}from"./chunk-4OC4J3KU.js";import{a as ct}from"./chunk-CESHMSBL.js";import{h as pt,i as dt,j as ht}from"./chunk-DFZB6AM2.js";import{a as A}from"./chunk-N6U6XCUD.js";import{a as rt}from"./chunk-XOJOMNES.js";import{a as ot}from"./chunk-QC7YKF4H.js";import{a as x,d as nt,l as at}from"./chunk-RGD6ZU25.js";import{a as lt,f as ut}from"./chunk-XGBN53IG.js";import{a as E}from"./chunk-63BBKXWS.js";import{f as $}from"./chunk-6HKZJRQV.js";import{a as Z}from"./chunk-RFPOPWHB.js";import{a as Y}from"./chunk-5KMJDB5T.js";import{a as et,c as it,l as st}from"./chunk-2BJHWKO6.js";import{c as tt}from"./chunk-2I3LIA7G.js";import{a as T}from"./chunk-E2EA44RX.js";import{d as Q}from"./chunk-CL7L227X.js";import{d as X}from"./chunk-QXSQOLB3.js";import{e as K}from"./chunk-UKAGN54W.js";import{i as j,o as q,p as N,s as J}from"./chunk-ZM24RY22.js";import{a as F}from"./chunk-JQAW4OB5.js";import{a as H}from"./chunk-6F25LG6O.js";import{a as C}from"./chunk-BOVYXYHK.js";import{c as B}from"./chunk-VIEK2X23.js";import{I as O}from"./chunk-NJWTSROP.js";import{a as y,j as S,k as V}from"./chunk-TG45K3WR.js";import{a as i}from"./chunk-QGVBCWUY.js";import{H as k}from"./chunk-MYO4NP2N.js";import{e as s}from"./chunk-NFIPKH6V.js";import{l as w}from"./chunk-5QEXLALV.js";import{b as D}from"./chunk-4PTIEWMT.js";import{a as I,b as W}from"./chunk-VTHXE323.js";var P;(function(t){t.Manipulators="manipulators",t.AnalysisViewDestroyed="analysis-view-destroyed",t.AnalysisView="analysis-view"})(P||(P={}));var o=class extends k{constructor(t){super(t),this.cursorPoint=null,this._visible=!1,this._laserLine=null,this.laserLineEnabled=!0,this._lastDraggedHandle=null}initialize(){this._laserLine=new rt({view:this.view,attached:!0,isDecoration:!0}),this._updateVisibility(this._visible),this._connectToAnalysisView(),this.addHandles(y(()=>this._params,({laserLineGlowColor:t,laserLineInnerColor:e,laserLineGlobalAlpha:a})=>{let n=this._laserLine,l=n.style;n.style=W(I({},l),{innerColor:e,glowColor:t,globalAlpha:a})}))}destroy(){this._laserLine=D(this._laserLine)}get _params(){let{accentColor:t}=this.view.effectiveTheme;return{laserLineGlowColor:H.toUnitRGB(t),laserLineGlowWidth:8,laserLineGlowFalloff:8,laserLineInnerColor:H.toUnitRGB(j(t)),laserLineInnerWidth:.75,laserLineGlobalAlpha:.75*t.a,handleColor:J(t,.5),handleRadius:5}}get visible(){return this._visible}set visible(t){t?this.show():this.hide()}get testData(){}get _cursorPosition(){let t=C(),e=this.cursorPoint;return e&&this.view.renderCoordsHelper.toRenderCoords(e,t),t}get _startPosition(){let t=C(),e=this.analysis.startPoint;return e&&this.view.renderCoordsHelper.toRenderCoords(e,t),t}get _endPosition(){let t=C(),e=this.analysis.endPoint;return e&&this.view.renderCoordsHelper.toRenderCoords(e,t),t}get _laserLineParams(){let t=this._focusPosition,{active:e,lineState:a}=this.toolState,n=this.analysisViewData,l=this.laserLineEnabled&&!!t&&a!=="measured"&&e;if(!l||!this.visible||n==null||n.destroyed)return{heightManifoldTarget:null,pointDistanceLine:null,lineVerticalPlaneSegment:null};let r=n.actualVisualizedMeasurement,d=this.view.viewingMode!=="local"&&l&&!!this.analysis.startPoint&&r==="geodesic",h=l&&n.viewMode===A.Triangle;return{heightManifoldTarget:r==="euclidean"?t:null,pointDistanceLine:d?this._pointDistanceLine:null,lineVerticalPlaneSegment:h?K(this._startPosition,this._endPosition):null}}get _focusPosition(){let{lineState:t}=this.toolState,e=this.analysisViewData,a=e!=null&&!e.destroyed&&e.measurementMode===Z.Euclidean&&e.viewMode===A.Direct;switch(t){case"drawing":return a?this._startPosition:this.analysis.endPoint?this._endPosition:this._startPosition;case"editing":return a?this._lastDraggedHandle==="start"?this._endPosition:this._startPosition:this._lastDraggedHandle==="start"?this._startPosition:this._endPosition;default:return this.cursorPoint!=null?this._cursorPosition:null}}get _pointDistanceLine(){return{origin:this.toolState.lineState==="drawing"||this._lastDraggedHandle==="end"?this._startPosition:this._endPosition,target:this._focusPosition}}createManipulators(){let t=this._params,{view:e}=this,a=()=>{let u=nt(t.handleColor),b=[new at(X(u,1,32,32))],f=new x({view:e,renderObjects:b});return f.available=!1,f.radius=t.handleRadius,[f,u]},[n,l]=a(),[r,d]=a(),h=new x({view:this.view,available:!1,interactive:!1});this.analysis.startPoint!=null&&(n.location=this.analysis.startPoint,n.available=!0),this.analysis.endPoint!=null&&(r.location=this.analysis.endPoint,r.available=!0);let _=()=>{let u=this._lastDraggedHandle;n.grabbing&&!r.grabbing&&(u="start"),r.grabbing&&!n.grabbing&&(u="end"),n.grabbing||r.grabbing||(u=null),this._lastDraggedHandle=u},M=n.events.on("grab-changed",_),v=r.events.on("grab-changed",_);return this.addHandles([M,v,y(()=>N(this._params.handleColor),u=>{l.setParameters({color:u}),d.setParameters({color:u})},{equals:q})],P.Manipulators),{start:n,end:r,cursor:h}}show(){this.destroyed||this._visible||this._updateVisibility(!0)}hide(){!this.destroyed&&this._visible&&this._updateVisibility(!1)}_connectToAnalysisView(){this.removeHandles(P.AnalysisView),this.addHandles([y(()=>this.analysisViewData?.destroyed,t=>{t&&this.removeHandles(P.AnalysisView)},S),y(()=>[this.toolState.lineState==="measured",this.analysisViewData],([t,e])=>{e==null||e.destroyed||(e.allowVisualElementsOrientationChange=!t)},S),y(()=>this._laserLineParams,t=>{let e=this._laserLine;e.heightManifoldTarget=t.heightManifoldTarget,e.pointDistanceLine=t.pointDistanceLine,e.lineVerticalPlaneSegment=t.lineVerticalPlaneSegment},S)],P.AnalysisView)}_updateVisibility(t){this.initialized&&(this._visible=t,t?this._laserLine.style={innerColor:this._params.laserLineInnerColor,innerWidth:this._params.laserLineInnerWidth,glowColor:this._params.laserLineGlowColor,glowWidth:this._params.laserLineGlowWidth,glowFalloff:this._params.laserLineGlowFalloff,globalAlpha:this._params.laserLineGlobalAlpha}:this.view.cursor=null,this._laserLine.visible=t)}};i([s({constructOnly:!0})],o.prototype,"view",void 0),i([s()],o.prototype,"_params",null),i([s({constructOnly:!0})],o.prototype,"analysis",void 0),i([s({constructOnly:!0})],o.prototype,"analysisViewData",void 0),i([s()],o.prototype,"cursorPoint",void 0),i([s()],o.prototype,"toolState",void 0),i([s()],o.prototype,"visible",null),i([s()],o.prototype,"testData",null),i([s()],o.prototype,"_visible",void 0),i([s()],o.prototype,"_laserLine",void 0),i([s({constructOnly:!0})],o.prototype,"laserLineEnabled",void 0),i([s()],o.prototype,"_cursorPosition",null),i([s()],o.prototype,"_startPosition",null),i([s()],o.prototype,"_endPosition",null),i([s()],o.prototype,"_lastDraggedHandle",void 0),i([s()],o.prototype,"_laserLineParams",null),i([s()],o.prototype,"_focusPosition",null),i([s()],o.prototype,"_pointDistanceLine",null),o=i([w("esri.views.3d.interactive.measurementTools.directLineMeasurement3D.DirectLineMeasurement3DView")],o);var p=class extends ot{constructor(t){super(t),this._updatingHandles=new F,this._emulatedDrag=null,this.lineState="initial",this.startPointSurfaceLocation=null,this.endPointSurfaceLocation=null,this.cursorPointSurfaceLocation=null,this.startManipulator=null,this.endManipulator=null,this.cursorManipulator=null,this._getSnappingContext=mt(e=>new ct({elevationInfo:{mode:"absolute-height",offset:0},pointer:e,editGeometryOperations:new st(new it("point",et(!0,!1,this.view.spatialReference)),this.view.state.viewingMode),visualizer:new _t}))}initialize(){let{view:t,analysis:e,analysisViewData:a,visible:n}=this;this.measurementView=new o({toolState:this,view:t,analysis:e,analysisViewData:a,visible:n});let l=vt(t);this._snappingManagerResult=l,this.addHandles(l);let{start:r,end:d,cursor:h}=this.measurementView.createManipulators(),_=(v,u,b)=>lt(v,(f,Pt,L,R)=>{let z=dt(f),bt=this._snappingManager,Dt=this._getSnappingContext(R),Mt=this._updatingHandles,{lineState:Lt}=this;L=L.next(z).next(ut(this,[b,u])).next(c=>{if(u!=="cursorPoint"){let m=this.analysis[u];m!=null&&(f.location=m)}return c});let St=ht(this.view),Vt=c=>{let m=St(c);return m||this.lineState!=="drawing"&&this.lineState!=="initial"||(this[u]=null,this[b]=null),m},U=Pt.next(z).next(Vt);if(R!=="touch"||Lt==="editing"){let{snappingStep:c,cancelSnapping:m}=gt({snappingManager:bt,snappingContext:Dt,updatingHandles:Mt});L=L.next(m),U=U.next(...c)}U.next(c=>c.action!=="start"?c:null).next(c=>{let m=Q(c.mapEnd,new B);this[u]=m,f.location=m,this[b]=this._surfaceLocation(m,c.surfaceType)})}),M=v=>v.events.on("grab-changed",()=>{let u=r.grabbing||d.grabbing;this.lineState=u?"editing":"measured"});this.addHandles([_(r,"startPoint","startPointSurfaceLocation"),_(d,"endPoint","endPointSurfaceLocation"),_(h,"cursorPoint","cursorPointSurfaceLocation"),M(r),M(d)]),this.manipulators.add(r),this.manipulators.add(d),this.manipulators.add(h),this.startManipulator=r,this.endManipulator=d,this.cursorManipulator=h,this.addHandles(y(()=>this.state,v=>{v==="measured"&&this.finishToolCreation()},V)),yt(this)}destroy(){this._updatingHandles=D(this._updatingHandles),this.measurementView=D(this.measurementView)}get _snappingManager(){return this._snappingManagerResult.snappingManager}get state(){let{analysis:t}=this;if(t.startPoint==null&&t.endPoint==null)return"ready";let{lineState:e}=this;return this.validMeasurement&&e!=="editing"&&e!=="drawing"?"measured":"measuring"}get cursor(){return this.state==="ready"||this.lineState==="drawing"?"crosshair":null}get startPoint(){return this.analysis.startPoint}set startPoint(t){this.analysis.startPoint=t}get endPoint(){return this.analysis.endPoint}set endPoint(t){this.analysis.endPoint=t}get cursorPoint(){return this.measurementView.cursorPoint}set cursorPoint(t){this.measurementView.cursorPoint=t}get snappingOptions(){return this._snappingManager.options}get validMeasurement(){return this.analysis.startPoint!=null&&this.analysis.endPoint!=null}get updating(){return this._updatingHandles.updating||this._snappingManager.updating}onShow(){this.measurementView.show(),this._updateManipulatorAvailability()}onHide(){this.measurementView.hide()}onDeactivate(){this._emulatedDrag?.cancel(),this._emulatedDrag=null}onInputEvent(t){switch(t.type){case"immediate-click":this._handleImmediateClick(t);break;case"pointer-move":this._handlePointerMove(t)}this._updateManipulatorAvailability()}_handlePointerMove(t){if(!this.active||this.view.navigating)return;let{pointerType:e}=t;if(e!=="mouse")return;let a=E(t),{lineState:n,cursorManipulator:l,endManipulator:r}=this,d=!1;this.cursorPoint==null&&(this._emulatedDrag?.cancel(),this._emulatedDrag=G(l,e,a),d=!0),n==="initial"&&(this._emulatedDrag?.update(a),d=!0),n==="drawing"&&(r.events.emit("drag",{action:"update",start:a,screenPoint:a}),d=!0),d&&t.stopPropagation()}_handleImmediateClick(t){if(!this.active||!$(t))return;let e=E(t),{pointerType:a}=t,{cursorManipulator:n,startManipulator:l,endManipulator:r,lineState:d}=this,h=!1;switch(this.cursorPoint==null&&(this._emulatedDrag?.cancel(),this._emulatedDrag=G(n,a,e)),d){case"initial":if(this._emulatedDrag?.update(e),this.cursorPoint!=null){this._emulatedDrag?.end(e),this._emulatedDrag=null;let{cursorPoint:_}=this;this.startPoint=_,this.startPointSurfaceLocation=this.cursorPointSurfaceLocation,l.location=_,l.interactive=!1,r.interactive=!1,this.lineState="drawing",this._emulatedDrag=G(r,a,e),h=!0}break;case"drawing":this._emulatedDrag?.update(e),this.endPoint!=null&&(this._emulatedDrag?.end(e),this._emulatedDrag=null,l.interactive=!0,r.interactive=!0,this.lineState="measured",h=!0)}h&&t.stopPropagation()}_surfaceLocation(t,e){return e===pt.GROUND?"on-the-surface":(t.z??0)>=this._getElevation(t)?"above-the-surface":"below-the-surface"}_updateManipulatorAvailability(){this.startManipulator.available=this.analysis.startPoint!=null,this.endManipulator.available=this.analysis.endPoint!=null}_getElevation(t){return this.view.basemapTerrain.ready?tt(this.view.elevationProvider,t)??0:0}get test(){}};function G(t,e,a){return t.events.emit("drag",{action:"start",pointerType:e,start:a,screenPoint:a}),{update:n=>t.events.emit("drag",{action:"update",start:n,screenPoint:n}),end:n=>t.events.emit("drag",{action:"end",start:n,screenPoint:n}),cancel:()=>t.events.emit("drag",{action:"cancel"})}}i([s({readOnly:!0})],p.prototype,"state",null),i([s()],p.prototype,"lineState",void 0),i([s({readOnly:!0})],p.prototype,"cursor",null),i([s()],p.prototype,"startPoint",null),i([s()],p.prototype,"endPoint",null),i([s()],p.prototype,"cursorPoint",null),i([s({constructOnly:!0})],p.prototype,"analysis",void 0),i([s({constructOnly:!0})],p.prototype,"analysisViewData",void 0),i([s()],p.prototype,"measurementView",void 0),i([s({constructOnly:!0})],p.prototype,"view",void 0),i([s({readOnly:!0})],p.prototype,"validMeasurement",null),i([s({value:null})],p.prototype,"startPointSurfaceLocation",void 0),i([s({value:null})],p.prototype,"endPointSurfaceLocation",void 0),i([s({value:null})],p.prototype,"cursorPointSurfaceLocation",void 0),i([s()],p.prototype,"updating",null),p=i([w("esri.views.3d.interactive.measurementTools.directLineMeasurement3D.DirectLineMeasurement3DTool")],p);var wt=p;var g=class extends ft{constructor(t){super(t),this.analysis=null,this.supportedViewType="3d",this.unsupportedErrorMessage="DirectLineMeasurement3DViewModel is only supported in 3D views.",this._userUnit=null,this._userUnitOptions=null}initialize(){this.addHandles(y(()=>({analysis:this.analysis,unit:this.unit}),({analysis:t,unit:e})=>{t!=null&&(t.unit=e)},V))}get state(){return this.disabled||!this.ready?"disabled":this.tool==null?"ready":this.tool.state}get measurement(){let{tool:t}=this;if(t==null)return null;let e=()=>({text:null,state:"unavailable"}),a=r=>({text:r,state:"available"}),{analysisViewData:n}=t,l=n.result!=null;return{mode:n.result?.mode??"euclidean",directDistance:l&&n.actualVisualizedMeasurement==="euclidean"?a(n.directLabelText):e(),horizontalDistance:l?a(n.horizontalLabelText):e(),verticalDistance:l?a(n.verticalLabelText):e()}}set unitOptions(t){this._userUnitOptions=t,this._set("unitOptions",this._filteredOrAllUnits(this._userUnitOptions))}get unitOptions(){return this._filteredOrAllUnits(this._userUnitOptions)}set unit(t){this._userUnit=t?this._findSelectableUnit(t,this._userUnit):null}get unit(){return this._userUnit?(this._userUnit=this._findSelectableUnit(this._userUnit,this.defaultUnit),this._userUnit):this._findSelectableUnit(this.defaultUnit)}constructAnalysis(){return new T}constructTool(){return new wt({view:this.view,analysis:this.analysis,analysisViewData:this.analysisView,visible:this.visible})}_findSelectableUnit(t,e){let a=this.unitOptions;return a.includes(t)?t:e?this._findSelectableUnit(e):a[0]}_filteredOrAllUnits(t){if(!t)return O.slice();let e=t.filter(a=>O.includes(a));return e.length===0?O.slice():e}};i([s({type:T})],g.prototype,"analysis",void 0),i([s({readOnly:!0})],g.prototype,"state",null),i([s({readOnly:!0})],g.prototype,"measurement",null),i([s()],g.prototype,"unitOptions",null),i([s()],g.prototype,"unit",null),i([s(Y)],g.prototype,"defaultUnit",void 0),i([s()],g.prototype,"_userUnit",void 0),i([s()],g.prototype,"_userUnitOptions",void 0),g=i([w("esri.widgets.DirectLineMeasurement3D.DirectLineMeasurement3DViewModel")],g);var ze=g;export{ze as a};
