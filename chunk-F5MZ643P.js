import{a as A,b as D,c as S}from"./chunk-4DLF223B.js";import{m as ee}from"./chunk-25WBXAEY.js";import{a as J}from"./chunk-LMGYHZE3.js";import{a as H}from"./chunk-7F5DJLJT.js";import{o as x}from"./chunk-AUAZP44J.js";import{c as U}from"./chunk-P6QFA5MM.js";import{b as q}from"./chunk-YOFFGXOB.js";import{f as g}from"./chunk-VTHXE323.js";var L=class{constructor(){this.version="",this.queryResult=new Y}},Y=class{constructor(){this.featureResult=new V}},V=class{constructor(){this.objectIdFieldName="",this.uniqueIdField=new W,this.globalIdFieldName="",this.geohashFieldName="",this.geometryProperties=new j,this.geometryType=null,this.spatialReference=new H,this.exceededTransferLimit=!1,this.hasZ=!1,this.hasM=!1,this.transform=new M,this.fields=[],this.fieldNameToAttributeIndexMap={},this.values=[],this.features=[],this.geometryFields=[]}},W=class{constructor(){this.name="",this.isSystemMaintained=!1}},j=class{constructor(){this.shapeAreaFieldName="",this.shapeLengthFieldName="",this.units=""}},M=class{constructor(){this.quantizeOriginPosition="upperLeft",this.scale=new B,this.translate=new Q}},B=class{constructor(){this.xScale=0,this.yScale=0,this.mScale=0,this.zScale=0}},Q=class{constructor(){this.xTranslate=0,this.yTranslate=0,this.mTranslate=0,this.zTranslate=0}},P=class{constructor(){this.name="",this.fieldType="esriFieldTypeString",this.alias="",this.sqlType="sqlTypeVarchar",this.domain="",this.defaultValue=""}},k=class{constructor(){this.attributes=[],this.compressedGeometry=new N,this.centroid=new N,this.aggregateGeometries=[]}},N=class{constructor(){this.geometryType=null,this.lengths=[],this.coords=[]}};var I;(function(e){e.ELEMENTUID="ELEMENTUID",e.TYPENAME="TYPENAME"})(I||(I={}));var te=[I.ELEMENTUID,I.TYPENAME],G,f;(function(e){e[e.ELEMENTUID=0]="ELEMENTUID",e[e.TYPENAME=1]="TYPENAME"})(G||(G={})),function(e){e[e.ELEMENTUID=0]="ELEMENTUID",e[e.TYPENAME=1]="TYPENAME",e[e.FROMUID=2]="FROMUID",e[e.TOUID=3]="TOUID"}(f||(f={}));var se,C,R,F;(function(e){e[e.featureResult=0]="featureResult",e[e.countResult=1]="countResult",e[e.idsResult=2]="idsResult"})(se||(se={})),function(e){e[e.upperLeft=0]="upperLeft",e[e.lowerLeft=1]="lowerLeft"}(C||(C={})),function(e){e[e.sqlTypeBigInt=0]="sqlTypeBigInt",e[e.sqlTypeBinary=1]="sqlTypeBinary",e[e.sqlTypeBit=2]="sqlTypeBit",e[e.sqlTypeChar=3]="sqlTypeChar",e[e.sqlTypeDate=4]="sqlTypeDate",e[e.sqlTypeDecimal=5]="sqlTypeDecimal",e[e.sqlTypeDouble=6]="sqlTypeDouble",e[e.sqlTypeFloat=7]="sqlTypeFloat",e[e.sqlTypeGeometry=8]="sqlTypeGeometry",e[e.sqlTypeGUID=9]="sqlTypeGUID",e[e.sqlTypeInteger=10]="sqlTypeInteger",e[e.sqlTypeLongNVarchar=11]="sqlTypeLongNVarchar",e[e.sqlTypeLongVarbinary=12]="sqlTypeLongVarbinary",e[e.sqlTypeLongVarchar=13]="sqlTypeLongVarchar",e[e.sqlTypeNChar=14]="sqlTypeNChar",e[e.sqlTypeNVarChar=15]="sqlTypeNVarChar",e[e.sqlTypeOther=16]="sqlTypeOther",e[e.sqlTypeReal=17]="sqlTypeReal",e[e.sqlTypeSmallInt=18]="sqlTypeSmallInt",e[e.sqlTypeSqlXml=19]="sqlTypeSqlXml",e[e.sqlTypeTime=20]="sqlTypeTime",e[e.sqlTypeTimestamp=21]="sqlTypeTimestamp",e[e.sqlTypeTimestamp2=22]="sqlTypeTimestamp2",e[e.sqlTypeTinyInt=23]="sqlTypeTinyInt",e[e.sqlTypeVarbinary=24]="sqlTypeVarbinary",e[e.sqlTypeVarchar=25]="sqlTypeVarchar"}(R||(R={})),function(e){e[e.OID_ARRAY=0]="OID_ARRAY",e[e.GLOBALID_ARRAY=1]="GLOBALID_ARRAY",e[e.STRING_ARRAY=2]="STRING_ARRAY",e[e.IDENTIFIER_ARRAY=3]="IDENTIFIER_ARRAY"}(F||(F={}));function re(e){let t=new L;t.version=e.version;let i=e.get_query_result();if(i.results_type.value!==0)throw new Error("Got a non-feature collection type");let s=i.get_feature_result(),r=t.queryResult.featureResult;r.objectIdFieldName=s.objectid_field_name,r.exceededTransferLimit=s.exceeded_transfer_limit,r.hasM=s.has_m,r.hasZ=s.has_z,r.geometryType=S[s.geometry_type.value],r.globalIdFieldName=s.globalid_field_name,r.geohashFieldName=s.geohash_field_name;let l=r.uniqueIdField,p=s.unique_id_field;l.name=p.name,l.isSystemMaintained=p.isSystemMaintained;let n=r.geometryProperties,o=s.geometry_properties;n.shapeAreaFieldName=o.shapeAreaFieldName,n.shapeLengthFieldName=o.shapeLengthFieldName,n.units=o.units;let y=r.spatialReference,u=s.spatial_reference;y.wkid=u.wkid,y.latestWkid=u.latestWkid,y.vcsWkid=u.vcsWkid,y.latestVcsWkid=u.latestVcsWkid,y.wkt=u.wkt,r.transform=_e(s.transform);let c=r.fields,d=r.fieldNameToAttributeIndexMap,a=s.fields,w=a.size();for(let m=0;m<w;m++){let h=a.get(m),_=ie(h);c.push(_),d[_.name]=m,h.delete()}a.delete();let T=r.values,E=s.values_count();for(let m=0;m<E;m++)T.push(s.get_value_at(m));let ce=r.features,O=s.features,Z=O.size();if(Z>0){for(let m of te)if(d[m]===void 0)throw new Error(`Feature collection missing required attribute: ${m}`)}for(let m=0;m<Z;m++){let h=new k,_=O.get(m),ye=h.attributes,pe=_.attributes_count();for(let b=0;b<pe;b++)ye.push(_.get_attribute_at(b));let K=_.get_compressed_geometry();K&&(h.compressedGeometry=X(K),h.centroid=X(_.get_centroid()));let me=h.aggregateGeometries,z=_.aggregate_geometries,fe=z.size();for(let b=0;b<fe;b++){let $=z.get(b),Te=X($);me.push(Te),$.delete()}z.delete(),ce.push(h),_.delete()}O.delete();let de=r.geometryFields,v=s.geometry_fields,ue=v.size();for(let m=0;m<ue;m++){let h=v.get(m),_=he(h);de.push(_),h.delete()}return v.delete(),t}function X(e){let t=new N;t.geometryType=S[e.geometry_type.value];let i=[],s=[];for(let r=0;r<e.lengths.length;r++)i.push(e.lengths[r]);for(let r=0;r<e.coords.length;r++)s.push(e.coords[r]);return t.lengths=i,t.coords=s,t}function ie(e){let t=new P;return t.name=e.name,t.alias=e.alias,t.fieldType=D[e.field_type.value],t.sqlType=R[e.sql_type.value],t.domain=e.domain,t.defaultValue=e.default_value,t}function he(e){let t=ie(e);return t.geometryType=S[e.geometry_type.value],t}function _e(e){let t=new M;t.quantizeOriginPosition=C[e.quantizeOriginPosition.value];let i=t.scale,s=e.scale;i.xScale=s.xScale,i.yScale=s.yScale,i.mScale=s.mScale,i.zScale=s.zScale;let r=t.translate,l=e.translate;return r.xTranslate=l.xTranslate,r.yTranslate=l.yTranslate,r.mTranslate=l.mTranslate,r.zTranslate=l.zTranslate,t}function ge(e){return g(this,null,function*(){let t=[],i={generateAllSublayers:!1,namedTypeDefinitions:new Map};return e.entitiesUrl&&t.push(ae(e.entitiesUrl).then(s=>{ne(s,i)})),e.relationshipsUrl&&t.push(ae(e.relationshipsUrl).then(s=>{ne(s,i)})),yield Promise.all(t),i})}function Ye(e,t){return g(this,null,function*(){t??=!1;let i={generateAllSublayers:t,namedTypeDefinitions:new Map};return yield Ie(e).then(s=>{Ee(s,i)}),i})}function Ve(e,t,i){return g(this,null,function*(){let s=yield A(),r=new s.FeatureCollection;try{oe(r,s,e,"entities",t,i);let l=new s.FeatureCollectionEncoder,p=le(r,l),n=structuredClone(p);return l.delete(),n}finally{r.delete()}})}function We(e,t,i){return g(this,null,function*(){let s=yield A(),r=new s.FeatureCollection;try{oe(r,s,e,"relationships",t,i);let l=new s.FeatureCollectionEncoder,p=le(r,l),n=structuredClone(p);return l.delete(),n}finally{r.delete()}})}function je(e){return g(this,null,function*(){let t=yield A(),i=new t.MapOfObjectIdentifierSets;we(i,t,e);let s=new t.MapOfObjectIdentifierSetsEncoder;try{s.set_map_of_identifier_sets(i),s.encode();let r=s.get_encoding_result();if(r.error.error_code!==0)throw new q("knowledge-graph:layer-support-utils",r.error.error_message);let l=structuredClone(r.get_byte_buffer());return s.delete(),l}finally{i.delete()}})}function oe(e,t,i,s,r,l){e.version="";let p=new t.QueryResult,n=new t.FeatureResult,o=s==="entities"?G:f;n.unique_id_field={name:o[o.ELEMENTUID],isSystemMaintained:!1},n.globalid_field_name=o[o.ELEMENTUID],n.geohash_field_name="",n.geometry_properties={shapeAreaFieldName:"",shapeLengthFieldName:"",units:""},n.spatial_reference={wkid:4326,latestWkid:4326,vcsWkid:0,latestVcsWkid:0,wkt:""},n.exceeded_transfer_limit=!1,n.has_z=!1,n.has_m=!1,n.transform={quantizeOriginPosition:{value:C.upperLeft},scale:{xScale:1e-9,yScale:1e-9,mScale:1e-4,zScale:1e-4},translate:{xTranslate:-400,yTranslate:-400,mTranslate:-1e5,zTranslate:-1e5}};for(let u of Object.keys(o).filter(c=>isNaN(Number(c)))){let c=new t.Field;if(c.name=u,c.alias=u,c.sql_type={value:R.sqlTypeBigInt},s==="entities")switch(u){case o[o.ELEMENTUID]:case o[o.TYPENAME]:c.field_type={value:D.esriFieldTypeString}}else switch(u){case o[o.ELEMENTUID]:case o[o.TYPENAME]:case f[f.FROMUID]:case f[f.TOUID]:c.field_type={value:D.esriFieldTypeString}}c.domain="",n.add_field(c),c.delete()}let y=new Map;for(let u of r.dataModel.entityTypes)y.set(u.name,"entities");for(let u of r.dataModel.relationshipTypes)y.set(u.name,"relationships");for(let[u,c]of i.namedTypeDefinitions)if(s===y.get(u))for(let d of c.members.values()){let a=new t.Feature;for(let T of Object.keys(o).filter(E=>isNaN(Number(E))))if(s==="entities")switch(T){case o[o.ELEMENTUID]:a.add_attribute(d.id,t.esriFieldType.esriFieldTypeString);break;case o[o.TYPENAME]:a.add_attribute(u,t.esriFieldType.esriFieldTypeString)}else switch(T){case o[o.ELEMENTUID]:a.add_attribute(d.id,t.esriFieldType.esriFieldTypeString);break;case f[f.FROMUID]:a.add_attribute(l.has(d.id)?l.get(d.id)[0]:"",t.esriFieldType.esriFieldTypeString);break;case f[f.TOUID]:a.add_attribute(l.has(d.id)?l.get(d.id)[1]:"",t.esriFieldType.esriFieldTypeString);break;case o[o.TYPENAME]:a.add_attribute(u,t.esriFieldType.esriFieldTypeString)}let w;if(d.linkChartLocation&&"x"in d.linkChartLocation?w=ee(d.linkChartLocation):d.linkChartLocation&&(w=d.linkChartLocation),d.linkChartLocation&&w){let T=new t.FeatureCollectionGeometry,E=!1;switch(s){case"entities":T.geometry_type=t.esriGeometryType.esriGeometryPoint,E=!0;break;case"relationships":T.geometry_type=t.esriGeometryType.esriGeometryPolyline}T.coords=new Float64Array(w.coords),T.lengths=new Uint32Array(E?[1]:w.lengths),a.set_compressed_geometry(T),T.delete()}n.add_feature(a),a.delete()}switch(s){case"entities":n.geometry_type=t.esriGeometryType.esriGeometryPoint;break;case"relationships":n.geometry_type=t.esriGeometryType.esriGeometryPolyline}return p.set_feature_result(n),e.set_query_result(p),n.delete(),p.delete(),e}function we(e,t,i){for(let[s,r]of i.namedTypeDefinitions){if(!r.members||r.useAllData)continue;let l=r.members.keys(),p=!1,n=!0,o=new t.ObjectIdArray,y=new t.StringArray,u=new t.GlobalIdArray,c=new t.IdentifierArray,d=new t.ObjectIdentifierSet;for(let a of l)n&&(p=!isNaN(Number(a)),n=!1),p?o.add_objectid(Number(a)):(y.add_string(a),u.add_globalid(a)),c.add_identifier(a);d.set_oid_array(o),d.set_string_array(y),d.set_globalid_array(u),d.set_identifier_array(c),o.delete(),y.delete(),u.delete(),c.delete(),e.put_identifier_set(s,d),d.delete()}return e}function ae(e){return g(this,null,function*(){let t=yield x(e,{responseType:"array-buffer"});return be(yield t.data)})}function be(e){return g(this,null,function*(){let t=new(yield A()).FeatureCollectionDecoder,i=t.decode(new Uint8Array(e));if(i.error_code!==0)throw new q("knowledge-graph:layer-support-utils",i.error_message);let s=t.get_feature_collection(),r=re(s);return t.delete(),r})}function Ie(e){return g(this,null,function*(){let t=yield x(e,{responseType:"array-buffer"}),i=yield t.data;return Fe(new Uint8Array(i))})}function Fe(e){return g(this,null,function*(){let t=new(yield A()).MapOfObjectIdentifierSetsDecoder,i=t.decode(new Uint8Array(e)),s=new Map;if(i.error_code!==0)throw new q("knowledge-graph:layer-support-utils",i.error_message);let r=t.get_map_of_identifier_sets(),l=r.keys,p=l.size();for(let n=0;n<p;n++){let o=l.get(n),y=r.query_identifier_set(o),u=[];if(y.id_array_type.value===F.GLOBALID_ARRAY){let c=y.get_globalid_array(),d=c.count();for(let a=0;a<d;a++)u.push(c.get_globalid_at(a))}else if(y.id_array_type.value===F.IDENTIFIER_ARRAY){let c=y.get_identifier_array(),d=c.count();for(let a=0;a<d;a++)u.push(c.get_identifier_at(a).toString())}else if(y.id_array_type.value===F.STRING_ARRAY){let c=y.get_string_array(),d=c.count();for(let a=0;a<d;a++)u.push(c.get_string_at(a))}else{if(y.id_array_type.value!==F.OID_ARRAY)throw new q("knowledge-graph:layer-support-utils","Tried to encode an unexpected ID Array type.");{let c=y.get_oid_array(),d=c.count();for(let a=0;a<d;a++)u.push(c.get_objectid_at(a).toString())}}s.set(o,u)}return t.delete(),s})}function ne(e,t){if(!e?.queryResult?.featureResult)return t;let i=e.queryResult.featureResult.fieldNameToAttributeIndexMap;for(let s of e.queryResult.featureResult.features){let r=s.attributes[i[I.TYPENAME]],l=U(t.namedTypeDefinitions,r,()=>({useAllData:!1,members:new Map})),p=s.attributes[i[I.ELEMENTUID]];if(s.compressedGeometry?.coords?.length>0){let n=s.compressedGeometry.lengths;s.compressedGeometry.geometryType==="esriGeometryPoint"&&(n=[]),l.members.set(p,{id:p,linkChartLocation:new J(n,s.compressedGeometry.coords)})}else l.members.set(p,{id:p})}return t}function Ee(e,t){for(let[i,s]of e){let r=U(t.namedTypeDefinitions,i,()=>({useAllData:!1,members:new Map}));for(let l of s)r.members.has(l)||r.members.set(l,{id:l})}return t}var le=(e,t)=>{t.set_feature_collection(e),t.encode();let i=t.get_encoding_result();if(i.error.error_code!==0)throw new q("knowledge-graph:layer-support-utils",i.error.error_message);return i.get_byte_buffer()},Be={fetchAndConvertSerializedLinkChart:e=>ge(e)};export{Ye as a,Ve as b,We as c,je as d,Be as e};
