import{a as ue,b as Se}from"./chunk-Q3T7LRXL.js";import{a as xe,b as ve,c as C,d as f}from"./chunk-DYNR3EAF.js";import{a as fe}from"./chunk-72TNJFVF.js";import"./chunk-OC2XJJQU.js";import{a as de,f as me,n as x,p as ge,s as _}from"./chunk-DT6D5YZT.js";import"./chunk-CSSRRM4C.js";import"./chunk-RVXDLN3U.js";import{c as L,g as G}from"./chunk-QCN4VUQF.js";import"./chunk-CJL3HAFX.js";import"./chunk-S3MATJKX.js";import{a as le}from"./chunk-FM2MN524.js";import{c as y,e as E,g as m}from"./chunk-XEJVICTW.js";import{a as P}from"./chunk-ESAKNWVF.js";import"./chunk-2JW3DUYT.js";import"./chunk-4JIR4MZV.js";import"./chunk-ZO3S2OWI.js";import"./chunk-NYVDVEEV.js";import{c as j}from"./chunk-KWYU7DMC.js";import"./chunk-M6JND3B6.js";import{d as H,f as b}from"./chunk-67GIWMYL.js";import{a as O,b as he,e as ce}from"./chunk-Q5KIWWVU.js";import"./chunk-CISTQZ5X.js";import{b as M,c as pe}from"./chunk-H2NTHPNN.js";import{w as g}from"./chunk-Z7TBAZRW.js";import"./chunk-342NGUMP.js";import"./chunk-NIYDRLW4.js";import"./chunk-QSQIQSC6.js";import"./chunk-AYNBEMCC.js";import"./chunk-LNYBTIG7.js";import"./chunk-3WNFY6Z5.js";import"./chunk-7SDNM7YV.js";import"./chunk-4NUW747S.js";import"./chunk-T6WMVIUG.js";import"./chunk-JPMGMA4B.js";import"./chunk-YZJDOXQC.js";import"./chunk-F2BQ2GD6.js";import"./chunk-R3XLNYYB.js";import"./chunk-2HYVVLKS.js";import"./chunk-XRTA5GHC.js";import"./chunk-Y6XW36QP.js";import"./chunk-ZXKU6WBY.js";import"./chunk-BMYVPMAK.js";import"./chunk-6F25LG6O.js";import{a as w}from"./chunk-EM35R6FY.js";import"./chunk-HKJZ7WI6.js";import"./chunk-DJW5LMRG.js";import"./chunk-DEH76MSI.js";import"./chunk-ALWV3RJ2.js";import{d as J,h as te,i as D,j as K,l as re,o as ie,q as se}from"./chunk-QXXXCEV5.js";import{c as oe,e as ne,o as ae}from"./chunk-6B5XFA6F.js";import"./chunk-TJ6P6NLD.js";import"./chunk-3JGYBNJA.js";import"./chunk-TQPBYYQ3.js";import"./chunk-DA3SDKGO.js";import"./chunk-ZOEPYNM4.js";import"./chunk-57VFBGF3.js";import"./chunk-GWBRHLNH.js";import"./chunk-BJH4F4SM.js";import"./chunk-Z3RBZHAK.js";import"./chunk-PTZYZULI.js";import"./chunk-NMLYCCKN.js";import"./chunk-JAPGPEA6.js";import"./chunk-ZC6EBRE4.js";import"./chunk-E7AX56GD.js";import"./chunk-IDVLLREH.js";import"./chunk-DWLSVYOY.js";import"./chunk-PQGCNP5H.js";import"./chunk-UASS7NJI.js";import"./chunk-WZRAC35O.js";import"./chunk-KUYAWYSS.js";import"./chunk-MIS6QMFE.js";import"./chunk-MDZTV2VL.js";import"./chunk-RNC4P66O.js";import"./chunk-7LHOQXZT.js";import"./chunk-BCREO4Q5.js";import"./chunk-U4QEPZJ3.js";import"./chunk-KJUZWSCL.js";import"./chunk-3WO6D7MU.js";import"./chunk-BUZ3SPLE.js";import"./chunk-CELWVZPW.js";import"./chunk-OLOKUDVI.js";import"./chunk-DYTVXYAV.js";import"./chunk-ZTOZWLEE.js";import"./chunk-RJWOVI3M.js";import"./chunk-RSDQHAJX.js";import{a as T}from"./chunk-BOVYXYHK.js";import"./chunk-KVM6SHDX.js";import"./chunk-EQZWYK27.js";import"./chunk-JLPLCY2B.js";import"./chunk-VU5W7W6Y.js";import"./chunk-ZQIC5NFT.js";import"./chunk-VIEK2X23.js";import"./chunk-XKIFGPJO.js";import"./chunk-PEW2PLAN.js";import"./chunk-Q6Y4JG7Q.js";import"./chunk-7F5DJLJT.js";import"./chunk-CX5IFQZJ.js";import{ca as ee}from"./chunk-NJWTSROP.js";import"./chunk-D3R25AF2.js";import"./chunk-ARRCN5K3.js";import"./chunk-O3EGNJTY.js";import"./chunk-WGAOVKGR.js";import"./chunk-G4DZJMGT.js";import"./chunk-K5T5FD5C.js";import"./chunk-MVHHPJM7.js";import"./chunk-VDO6JJ3Y.js";import"./chunk-WFKZLI6F.js";import"./chunk-X2B63YVS.js";import"./chunk-BAEF3CT6.js";import"./chunk-AUAZP44J.js";import"./chunk-PVDFCTA4.js";import"./chunk-KNVXE32P.js";import"./chunk-76ATOSLU.js";import"./chunk-CCJU4DSH.js";import"./chunk-TG45K3WR.js";import"./chunk-RAI4DTMT.js";import{b as $}from"./chunk-ACP3S2CH.js";import"./chunk-HVAXZ2NA.js";import"./chunk-T7DXJKX7.js";import"./chunk-TYYVNQUR.js";import{a as R}from"./chunk-QGVBCWUY.js";import{H as Z}from"./chunk-MYO4NP2N.js";import{e as I}from"./chunk-NFIPKH6V.js";import"./chunk-JPU2PQZC.js";import{l as Y}from"./chunk-5QEXLALV.js";import"./chunk-P6QFA5MM.js";import"./chunk-DGTD7Y73.js";import"./chunk-LI2SX4T6.js";import"./chunk-BWO7LS2H.js";import"./chunk-HEVQSRJ2.js";import"./chunk-OVHPPCBL.js";import"./chunk-SNFOAZZQ.js";import"./chunk-AML4XSEF.js";import"./chunk-4PTIEWMT.js";import"./chunk-TG2UTNEO.js";import"./chunk-YOFFGXOB.js";import"./chunk-XRGPJ3QY.js";import"./chunk-6MRUJ2UW.js";import"./chunk-2LI2GKBQ.js";import"./chunk-QBWJMFH5.js";import{f as X}from"./chunk-VTHXE323.js";var v=class{constructor(r,e){this.view=r,this.options=e,this.squaredShortLineThreshold=P.shortLineThreshold*P.shortLineThreshold}snap(r,e){return e.vertexHandle!=null?e.vertexHandle.type!=="vertex"?[]:this.snapExistingVertex(r,e):this.snapNewVertex(r,e)}edgeExceedsShortLineThreshold(r,e){return this.exceedsShortLineThreshold(m(r.leftVertex.pos,this.view,e),m(r.rightVertex.pos,this.view,e),e)}exceedsShortLineThreshold(r,e,{spatialReference:t}){return this.squaredShortLineThreshold===0||x(f(e,t,g,this.view),f(r,t,g,this.view))>this.squaredShortLineThreshold}isVertical(r,e,{spatialReference:t}){let i=ee(t);return D(r,e)*i<P.verticalLineThresholdMeters}squaredProximityThreshold(r){return r==="touch"?this._squaredTouchProximityThreshold:this._squaredMouseProximityThreshold}get _squaredMouseProximityThreshold(){return this.options.distance*this.options.distance}get _squaredTouchProximityThreshold(){let{distance:r,touchSensitivityMultiplier:e}=this.options,t=r*e;return t*t}};var N=class extends v{snapNewVertex(r,e){let t=e.editGeometryOperations.data.components[0],i=t.edges.length,s=[];if(i<1)return s;let{spatialReference:o}=e,a=f(r,o,g,this.view),{view:n}=this,p=t.edges[i-1],h=p;do{if(this.edgeExceedsShortLineThreshold(h,e)){let d=_(h,n,e);this._processCandidateProposal(d.left,d.right,r,a,e,s)}h=h.leftVertex.leftEdge}while(h&&h!==p);return s}snapExistingVertex(r,e){let t=[],i=e.vertexHandle,s=i.component;if(s.edges.length<2)return t;let{view:o}=this,{spatialReference:a}=e,n=f(r,a,g,o),p=i.leftEdge,h=i.rightEdge;p&&h&&this.edgeExceedsShortLineThreshold(p,e)&&this.edgeExceedsShortLineThreshold(h,e)&&this._processCandidateProposal(m(p.leftVertex.pos,o,e),m(h.rightVertex.pos,o,e),r,n,e,t);let d=s.edges[0],l=d;do{if(l!==i.leftEdge&&l!==i.rightEdge&&this.edgeExceedsShortLineThreshold(l,e)){let u=_(l,o,e);this._processCandidateProposal(u.left,u.right,r,n,e,t)}l=l.rightVertex.rightEdge}while(l&&l!==d);return t}_processCandidateProposal(r,e,t,i,s,o){let{spatialReference:a,pointer:n}=s,p=T();Te(p,r,e,t,s);let h=E(p);x(i,f(h,a,g,this.view))<this.squaredProximityThreshold(n)&&o.push(new fe({lineStart:r,lineEnd:e,targetPoint:h,isDraped:s.elevationInfo?.mode==="on-the-ground"}))}};function Te(c,r,e,t,i){we(c,r,e,t,i)||ye(c,t,r,e)}function we(c,r,e,t,{spatialReference:i}){let s=L(r,e,i,i);if(s==null)return!1;let o=L(e,t,i,i);if(o==null)return!1;let a=j(e,t,i);if(a==null)return!1;let n=Math.abs(pe.shortestSignedDiff(s,o))>Math.PI/2?M.normalize(s+Math.PI):s;return G(c,e,i,b(a,"meters"),H(n,"radians","geographic"),"geodesic"),c[2]=t[2],!0}function ye(c,r,e,t){de(r,{start:e,end:t,type:ce.LINE},c),c[2]=r[2]}var z=class extends v{snapNewVertex(r,e){let t=e.editGeometryOperations.data.components[0],i=t.edges.length,s=t.vertices.length,o=[];if(i<2)return o;let{view:a}=this,n=f(r,e.spatialReference,g,a),p=m(t.vertices[s-1].pos,a,e),h=m(t.vertices[0].pos,a,e),d=t.edges[i-1],l=d;do{if(this.edgeExceedsShortLineThreshold(l,e)){let u=_(l,a,e);this._checkEdgeForParallelLines(u,p,r,n,e,o),this._checkEdgeForParallelLines(u,h,r,n,e,o)}l=l.leftVertex.leftEdge}while(l&&l!==d);return o}snapExistingVertex(r,e){let t=[],i=e.vertexHandle,s=i.component;if(s.edges.length<3)return t;let{view:o}=this,a=f(r,e.spatialReference,g,o),n=i.leftEdge,p=i.rightEdge,h=s.vertices[0],d=m(h.pos,o,e),l=s.vertices.length,u=s.vertices[l-1],A=m(u.pos,o,e),k=s.edges[0],S=k;do{if(S!==n&&S!==p&&this.edgeExceedsShortLineThreshold(S,e)){let q=_(S,o,e);n&&this._checkEdgeForParallelLines(q,m(n.leftVertex.pos,o,e),r,a,e,t),p&&this._checkEdgeForParallelLines(q,m(p.rightVertex.pos,o,e),r,a,e,t),i===h?this._checkEdgeForParallelLines(q,A,r,a,e,t):i===u&&this._checkEdgeForParallelLines(q,d,r,a,e,t)}S=S.rightVertex.rightEdge}while(S&&S!==k);return t}_checkEdgeForParallelLines(r,e,t,i,s,o){let a=r.left,n=r.right;if(O(V,e,a,n),K(V,e)<P.parallelLineThreshold)return;O(V,t,a,n,e);let{spatialReference:p,pointer:h}=s,d=E(y(V[0],V[1],t[2]));if(x(i,f(d,p,g,this.view))<this.squaredProximityThreshold(h)){if(this.isVertical(d,e,s)||this.isVertical(a,n,s)||Le(r,o))return;o.push(new ue({referenceLine:r,lineStart:e,targetPoint:d,isDraped:s.elevationInfo?.mode==="on-the-ground"}))}}};function Le(c,r){let e=c.left,t=c.right;for(let i of r)if(O(V,t,i.constraint.start,i.constraint.end,e),K(V,t)<P.parallelLineThreshold)return i.addReferenceLine(c),!0;return!1}var V=w();var U=class extends v{snapNewVertex(r,e){let t=e.editGeometryOperations.data.components[0],i=[];if(t.vertices.length<2)return i;let{view:s}=this,o=f(r,e.spatialReference,g,s),a=t.vertices.at(-1);this._checkForSnappingCandidate(C.LastVertex,i,a.leftEdge,a,a.leftEdge.leftVertex,r,o,e);let n=t.vertices[0];return this._checkForSnappingCandidate(C.FirstVertex,i,n.rightEdge,n,n.rightEdge.rightVertex,r,o,e),i}snapExistingVertex(r,e){let t=[],i=e.vertexHandle;if(i.component.vertices.length<3)return t;let{view:s}=this,o=f(r,e.spatialReference,g,s),a=i.leftEdge,n=i.rightEdge;if(a?.leftVertex.leftEdge){let p=a.leftVertex.leftEdge;this._checkForSnappingCandidate(C.ExistingEdge,t,p,p.rightVertex,p.leftVertex,r,o,e)}if(n?.rightVertex.rightEdge){let p=n.rightVertex.rightEdge;this._checkForSnappingCandidate(C.ExistingEdge,t,p,p.leftVertex,p.rightVertex,r,o,e)}return t}_checkForSnappingCandidate(r,e,t,i,s,o,a,n){if(!this.edgeExceedsShortLineThreshold(t,n))return;let p=this.view,h=m(i.pos,p,n),d=m(s.pos,p,n);_e(Ee,d,h,o,n),this._checkForSnappingCandidateAlongProjectedRay(r,e,d,h,Ee,o,a,n)}_checkForSnappingCandidateAlongProjectedRay(r,e,t,i,s,o,a,n){let{spatialReference:p,pointer:h}=n,d=J(W,o,i),l=ie(s,d)/re(s),u=te(W,i,s,l),A=E(y(u[0],u[1],o[2]));if(x(a,f(A,p,g,this.view))>this.squaredProximityThreshold(h)||this.isVertical(A,i,n)||this.isVertical(i,t,n))return;let k=ae(T(),i,s,Math.sign(l));e.push(new xe({targetPoint:A,constraint:new me(i,k),previousVertex:t,otherVertex:i,otherVertexType:ve.CENTER,selfSnappingType:r,isDraped:n.elevationInfo?.mode==="on-the-ground"}))}};function _e(c,r,e,t,i){Ae(c,r,e,t,i)||Re(c,r,e)}function Ae(c,r,e,t,{spatialReference:i}){let s=L(r,e,i,i);if(s==null)return!1;let o=L(e,t,i,i);if(o==null)return!1;let a=Math.sign(M.shortestSignedDiff(s,o))*Math.PI*.5,n=H(s+a,"radians","geographic"),p=T(),h=j(e,t,i);return h!=null&&(G(p,e,i,b(h,"meters"),n,"geodesic"),ne(c,p,e),!0)}function Re(c,r,e){let t=J(W,e,r);oe(c,t[1],-t[0],0)}var W=w(),Ee=T();var B=class extends v{snapNewVertex(r,e){let t=e.editGeometryOperations.data.components[0],i=[],s=t.vertices.length;if(e.editGeometryOperations.data.type!=="polygon"||s<2)return i;let{view:o}=this,a=t.vertices[0],n=t.vertices[s-1],p=m(a.pos,o,e),h=m(n.pos,o,e);return this._processCandidateProposal(p,h,r,e,i),i}snapExistingVertex(r,e){let t=[],i=e.vertexHandle,s=i.component;if(s.edges.length<2||e.editGeometryOperations.data.type==="polyline"&&(i.index===0||i.index===s.vertices.length-1))return t;let{view:o}=this,a=m(i.leftEdge.leftVertex.pos,o,e),n=m(i.rightEdge.rightVertex.pos,o,e);return this._processCandidateProposal(a,n,r,e,t),t}_processCandidateProposal(r,e,t,i,s){if(!this.exceedsShortLineThreshold(r,e,i))return;let o=se(Pe,r,e,.5),a=.5*D(r,e),n=he(Pe,t,o,a),p=E(y(n[0],n[1],t[2])),{spatialReference:h,pointer:d}=i,l=f(t,h,g,this.view);if(x(l,f(p,h,g,this.view))<this.squaredProximityThreshold(d)){if(this.isVertical(r,p,i)||this.isVertical(p,e,i))return;s.push(new Se({targetPoint:p,point1:r,point2:e,isDraped:i.elevationInfo?.mode==="on-the-ground"}))}}},Pe=w();var F=class extends Z{constructor(c){super(c),this.updating=!1,this._snappers=new $,this._domain=le.SELF}initialize(){this._snappers.push(new z(this.view,this.options),new N(this.view,this.options),new U(this.view,this.options),new B(this.view,this.options))}set options(c){this._set("options",c);for(let r of this._snappers)r.options=c}fetchCandidates(c,r,e){return X(this,null,function*(){if(!(r&this._domain&&this.options.effectiveSelfEnabled))return[];let t=[];for(let i of this._snappers.items)for(let s of i.snap(c,e))t.push(s);return ge(c,t),t})}};R([I({readOnly:!0})],F.prototype,"updating",void 0),R([I({constructOnly:!0})],F.prototype,"view",void 0),R([I()],F.prototype,"options",null),F=R([Y("esri.views.interactive.snapping.SelfSnappingEngine")],F);export{F as SelfSnappingEngine};
