import{a as O,s as ne}from"./chunk-ZHEBYHJM.js";import{a as x,b as B,c as K,d as te,f as U}from"./chunk-WGX2RQVH.js";import{i as F}from"./chunk-4DLF223B.js";import{a as v}from"./chunk-735YNPMJ.js";import{b as ee}from"./chunk-2HYVVLKS.js";import{g as W,s as z}from"./chunk-DA3SDKGO.js";import{h as Z}from"./chunk-RNC4P66O.js";import{a as Q}from"./chunk-JLPLCY2B.js";import{m as P}from"./chunk-ZQIC5NFT.js";import{u as A}from"./chunk-NJWTSROP.js";import{a as k}from"./chunk-QGVBCWUY.js";import{H as J}from"./chunk-MYO4NP2N.js";import{e as R}from"./chunk-NFIPKH6V.js";import{l as q}from"./chunk-5QEXLALV.js";import{c as j}from"./chunk-P6QFA5MM.js";import{o as X}from"./chunk-4PTIEWMT.js";import{b as G}from"./chunk-YOFFGXOB.js";import{g as V}from"./chunk-XRGPJ3QY.js";import{f as S}from"./chunk-VTHXE323.js";var C=class extends J{constructor(i){super(i),this._processingCacheUpdatesLookup=new Map,this.knowledgeGraph=null,this.inclusionModeDefinition={generateAllSublayers:!0,namedTypeDefinitions:new Map},this.entityTypeNames=new Set,this.relationshipTypeNames=new Set,this.geographicLookup=new Map,this.sublayerCaches=new Map,this.nodeConnectionsLookup=new Map,this.relationshipConnectionsLookup=new Map,this.memberIdTypeLookup=new Map;let e=new Map;i.knowledgeGraph.dataModel.entityTypes?.forEach(o=>{o.name&&(e.set(o.name,"entity"),this._processingCacheUpdatesLookup.set(o.name,[]),i.inclusionModeDefinition&&!i.inclusionModeDefinition?.generateAllSublayers||this.entityTypeNames.add(o.name),o.properties?.forEach(n=>{n.geometryType&&n.geometryType!=="esriGeometryNull"&&this.geographicLookup.set(o.name,{name:n.name??"",geometryType:n.geometryType})}))}),i.knowledgeGraph.dataModel.relationshipTypes?.forEach(o=>{o.name&&(e.set(o.name,"relationship"),this._processingCacheUpdatesLookup.set(o.name,[]),i.inclusionModeDefinition&&!i.inclusionModeDefinition?.generateAllSublayers||this.relationshipTypeNames.add(o.name),o.properties?.forEach(n=>{n.geometryType&&n.geometryType!=="esriGeometryNull"&&this.geographicLookup.set(o.name,{name:n.name??"",geometryType:n.geometryType})}))}),i.inclusionModeDefinition?.namedTypeDefinitions.forEach((o,n)=>{if(e.get(n)==="entity")this.entityTypeNames.add(n);else{if(e.get(n)!=="relationship")return V.getLogger(this).warn(`A named type, ${n}, was in the inclusion list that wasn't in the data model and will be removed`),void i.inclusionModeDefinition?.namedTypeDefinitions.delete(n);this.relationshipTypeNames.add(n)}let a=new Map;o.members?.forEach(c=>{j(this.memberIdTypeLookup,c.id,()=>new Set).add(n);let f=this.getById(c.id);f&&a.set(c.id,f)}),this.sublayerCaches.set(n,a)})}addToLayer(i){i.forEach(({typeName:e,id:o})=>{if(!this.inclusionModeDefinition)throw new G("knowledge-graph:layer-data-manager","You cannot add to a layer's exclusion list if it was not created with an exclusion list originally");if(this.inclusionModeDefinition.namedTypeDefinitions.has(e)){if(this.inclusionModeDefinition.namedTypeDefinitions.has(e)){let n=this.inclusionModeDefinition.namedTypeDefinitions.get(e);n.members||(n.members=new Map),n.members.set(o,{id:o}),j(this.memberIdTypeLookup,o,()=>new Set).add(e)}}else{let n=new Map;n.set(o,{id:o}),this.inclusionModeDefinition.namedTypeDefinitions.set(e,{useAllData:!1,members:n}),j(this.memberIdTypeLookup,o,()=>new Set).add(e)}})}getById(i){return O.getInstance().readFromStoreById(i)}getData(i,e,o){return S(this,null,function*(){if(e.objectType.name&&this.inclusionModeDefinition?.namedTypeDefinitions&&this.inclusionModeDefinition.namedTypeDefinitions.size>0&&!this.inclusionModeDefinition.namedTypeDefinitions.has(e.objectType.name))return[];let n;if(n=i||new ee({where:"1=1",outFields:["*"]}),e.parentCompositeLayer.type==="link-chart"){let a=e.parentCompositeLayer,c=this._processingCacheUpdatesLookup.get(e.objectType.name??""),f=n.outFields;f&&f.length===1&&f[0]===x&&n.where==="1=1"||(yield Promise.all(c??[]));let m=this.sublayerCaches.has(e.objectType.name??"")?Array.from(this.sublayerCaches.get(e.objectType.name)?.values()):[],w=[];return m.forEach(t=>{if(this.relationshipTypeNames.has(e.objectType.name)){t.geometry=a.relationshipLinkChartDiagramLookup.get(t.attributes[e.objectIdField]);let s=this.memberIdTypeLookup.get(t.attributes[B]),l=this.memberIdTypeLookup.get(t.attributes[K]),p=this._isEndEntitySpatial(s,t,B),b=this._isEndEntitySpatial(l,t,K);t.attributes[U]=Number(p&&b)}else{t.geometry=a.entityLinkChartDiagramLookup.get(t.attributes[e.objectIdField]);let s=this.geographicLookup.get(e.objectType.name);s&&t.attributes[s.name]?t.attributes[U]=1:t.attributes[U]=0}t.attributes[te]=t.geometry,w.push(t)}),w}return this.retrieveDataFromService(n,e,o)})}getConnectedRecordIds(i,e,o){return S(this,null,function*(){let n=[],a="",c=this._getNamedTypeIdMapFromNodeIds(i);if(e&&e?.length!==0){for(let s of e)a=a+s+"|";a=a.slice(0,-1)}let f={},m=[];for(let[s,l]of c){let p=`${s}_ids`;f[p]=l,e&&e?.length!==0?m.push(`MATCH (n:${s}) WHERE id(n) IN $${p} WITH n MATCH (n)-[r:${a}]-(m) RETURN id(r), type(r), id(m), labels(m)[0]`):m.push(`MATCH (n:${s}) WHERE id(n) IN $${p} WITH n MATCH (n)-[r]-(m) RETURN id(r), type(r), id(m), labels(m)[0]`)}if(!m.length)return n;let w=m.join(" UNION "),t=(yield F(this.knowledgeGraph,new v({openCypherQuery:w,bindParameters:f}),{signal:o?.signal})).resultRowsStream.getReader();for(;;){let{done:s,value:l}=yield t.read();if(s)break;for(let p=0;p<l.length;p++){let b=l[p];n.push({id:b[0],typeName:b[1]}),n.push({id:b[2],typeName:b[3]})}}return n})}getRelationshipsBetweenNodes(i,e,o){return S(this,null,function*(){let n=this._getNamedTypeIdMapFromNodeIds(i);if(n.size===0)return[];let a={relationshipExclusionIds:e,possibleConnectionEntityIds:i},c=[];for(let[t,s]of n.entries()){let l=`${t}_ids`;a[l]=s,c.push(`MATCH (n:${t}) WHERE id(n) IN $${l} WITH n MATCH (n)-[r]->(m) WHERE id(m) IN $possibleConnectionEntityIds AND NOT id(r) IN $relationshipExclusionIds RETURN id(r), type(r)`)}let f=c.join(" UNION "),m=[],w=(yield F(this.knowledgeGraph,new v({openCypherQuery:f,bindParameters:a}),{signal:o?.signal})).resultRowsStream.getReader();for(;;){let{done:t,value:s}=yield w.read();if(t)break;for(let l=0;l<s.length;l++){let p=s[l];m.push({id:p[0],typeName:p[1]})}}return m})}getRelationshipsFromNodes(i,e,o,n){return S(this,null,function*(){let a=this._getNamedTypeIdMapFromNodeIds(i);if(a.size===0||e.length===0)return[];let c={relationshipExclusionIds:o,possibleConnectionEntityIds:e},f=[];for(let[l,p]of a.entries()){let b=`${l}_ids`;c[b]=p,f.push(`MATCH (n:${l}) WHERE id(n) IN $${b} WITH n MATCH (n)-[r]-(m) WHERE id(m) IN $possibleConnectionEntityIds AND NOT id(r) IN $relationshipExclusionIds RETURN id(r), type(r)`)}let m=f.join(" UNION "),w=new Map,t=(yield F(this.knowledgeGraph,new v({openCypherQuery:m,bindParameters:c}),{signal:n?.signal})).resultRowsStream.getReader();for(;;){let{done:l,value:p}=yield t.read();if(l)break;for(let b=0;b<p.length;b++){let y=p[b],r=w.get(y[1]);r||(r=new Set,w.set(y[1],r)),r.add(y[0])}}let s=[];for(let[l,p]of w)for(let b of p)s.push({id:b,typeName:l});return s})}refreshCacheContent(i,e,o,n=!0,a){return S(this,null,function*(){let c=O.getInstance(),f=[],m=new Map,w=new Map;this.knowledgeGraph.dataModel.entityTypes?.forEach(t=>{t.name&&w.set(t.name,t)}),this.knowledgeGraph.dataModel.relationshipTypes?.forEach(t=>{t.name&&w.set(t.name,t)}),i||this.inclusionModeDefinition?i?i.forEach(t=>{if(this.memberIdTypeLookup.has(t))for(let s of this.memberIdTypeLookup.get(t))m.has(s)?m.get(s)?.push(t):m.set(s,[t])}):this.inclusionModeDefinition?.namedTypeDefinitions?.forEach((t,s)=>{t.useAllData?m.set(s,null):t.members&&t.members.forEach(l=>{m.has(s)&&m.get(s)!==null?m.get(s)?.push(l.id):m.set(s,[l.id])})}):(this.knowledgeGraph.dataModel.entityTypes?.forEach(t=>{t.name&&m.set(t.name,null)}),this.knowledgeGraph.dataModel.entityTypes?.forEach(t=>{t.name&&m.set(t.name,null)}));for(let[t,s]of m){let l=new Set(s),p=new Promise((b,y)=>{S(this,null,function*(){let D=new Set,I=[],N,u="",T=!1;if(e||w.get(t)?.properties?.forEach(g=>{g.name&&D.add(g.name)}),o&&this.geographicLookup.has(t)){let g=this.geographicLookup.get(t)?.name;g&&D.add(g)}if(this.entityTypeNames.has(t))u=`MATCH (n:${t}) ${s?"WHERE id(n) IN $ids ":""}return ID(n)`,D.forEach(g=>{u+=`, n.${g}`,I.push(g)});else{if(!this.relationshipTypeNames.has(t))throw new G("knowledge-graph:layer-data-manager",`The graph type of ${t} could not be determined. Was this type set in the KG data model and inclusion definition?`);T=!0,u=`MATCH ()-[n:${t}]->() ${s?"WHERE id(n) IN $ids ":""}return ID(n), id(startNode(n)), id(endNode(n))`,D.forEach(g=>{u+=`, n.${g}`,I.push(g)})}N=new v(s?{openCypherQuery:u,bindParameters:{ids:s}}:{openCypherQuery:u});let h=(yield F(this.knowledgeGraph,N,{signal:a?.signal})).resultRowsStream.getReader();for(;;){let{done:g,value:E}=yield h.read();if(g)break;let Y=[];for(let L=0;L<E.length;L++){let H=E[L],$=0,_=0,M={properties:{}};for(M.id=H[$],$++,_++,T&&(M.originId=H[$],$++,_++,M.destinationId=H[$],$++,_++,j(this.nodeConnectionsLookup,M.originId,()=>new Set).add(M.id),j(this.nodeConnectionsLookup,M.destinationId,()=>new Set).add(M.id),j(this.relationshipConnectionsLookup,M.id,()=>[M.originId,M.destinationId]));$<H.length;$++)M.properties[I[$-_]]=H[$];l.delete(M.id),Y.push(M)}let ie=c.writeToStore(Y,x,this.geographicLookup.get(t)?.name);this.sublayerCaches.has(t)||this.sublayerCaches.set(t,new Map),n&&!this.inclusionModeDefinition?.namedTypeDefinitions.has(t)&&this.inclusionModeDefinition?.namedTypeDefinitions.set(t,{useAllData:!1,members:new Map}),n&&!this.inclusionModeDefinition?.namedTypeDefinitions.get(t).members&&(this.inclusionModeDefinition.namedTypeDefinitions.get(t).members=new Map);let oe=this.sublayerCaches.get(t);ie.forEach(L=>{oe?.set(L.attributes[x],L),n&&!this.inclusionModeDefinition?.namedTypeDefinitions.get(t).members.has(L.attributes[x])&&(this.inclusionModeDefinition?.namedTypeDefinitions.get(t).members.set(L.attributes[x],{id:L.attributes[x]}),j(this.memberIdTypeLookup,L.attributes[x],()=>new Set).add(t))})}let d=this.inclusionModeDefinition?.namedTypeDefinitions.get(t);if(d)for(let g of l)d.members?.delete(g)}).then(()=>{b(null)}).catch(D=>{D.name==="AbortError"?b(null):y(D)})});f.push(p),this._processingCacheUpdatesLookup.get(t)?.push(p)}if(yield Promise.all(f),a?.signal?.aborted)throw X()})}removeFromLayer(i){let e=new Set,o=new Set(i.map(n=>n.id));for(let n of i)e.add(n.typeName),this.memberIdTypeLookup.get(n.id)?.size===1?this.memberIdTypeLookup.delete(n.id):this.memberIdTypeLookup.get(n.id)?.delete(n.typeName),this.inclusionModeDefinition?.namedTypeDefinitions.forEach((a,c)=>{c===n.typeName&&a.members?.has(n.id)&&a.members.delete(n.id)});e.forEach(n=>{this.sublayerCaches.get(n)?.forEach((a,c)=>{o.has(c)&&this.sublayerCaches.get(n)?.delete(c)})})}retrieveDataFromService(i,e,o){return S(this,null,function*(){let n=O.getInstance(),a=new Set,c=[],f,m="",w=[],t=e.graphType==="relationship",s=this.inclusionModeDefinition?.namedTypeDefinitions?.get(e.objectType.name)?.useAllData,l=e.parentCompositeLayer.sublayerIdsCache.get(e.objectType.name),p=!s&&l?Array.from(l).sort():null;if(this.inclusionModeDefinition?.namedTypeDefinitions?.get(e.objectType.name)?.useAllData)this.inclusionModeDefinition?.namedTypeDefinitions?.get(e.objectType.name)?.useAllData&&i.objectIds!=null&&(p=i.objectIds);else if(i.objectIds!=null&&p&&p.length>0){let y=i.objectIds;i.objectIds=p.filter(r=>y.includes(r))}else if(i.objectIds!=null)p=i.objectIds;else{if(this.inclusionModeDefinition?.namedTypeDefinitions.has(e.objectType.name)&&(!this.inclusionModeDefinition.namedTypeDefinitions.get(e.objectType.name)?.members||this.inclusionModeDefinition.namedTypeDefinitions.get(e.objectType.name)?.members?.size<1))return i.objectIds=[],[];i.objectIds=p}if(i.outFields!=null){let y=i.outFields;y.includes("*")?e.fields.forEach(r=>{a.add(r.name)}):y.forEach(r=>{r!==x&&r!==e.geometryFieldName&&a.add(r)})}if(i.geometry!=null){let y=i.geometry,r,D=e.parentCompositeLayer.dataManager.knowledgeGraph.serviceDefinition,I=D?.spatialReference,N=D?.serviceCapabilities?.geometryCapabilities,u=N?.geometryMaxBoundingRectangleSizeX,T=N?.geometryMaxBoundingRectangleSizeY;if(y.type==="point"){let h=y;h.spatialReference?.isWGS84||(yield z(h.spatialReference,A),h=W(h,A)),r=new P({spatialReference:A,xmin:h.x-1e-4,ymin:h.y-1e-4,xmax:h.x+1e-4,ymax:h.y+1e-4})}else y?.extent?.spatialReference&&!y.spatialReference?.isWGS84?(yield z(y.extent.spatialReference,A),r=W(y.extent,A)):r=y.extent;if(u&&T&&I){if(I.wkid!==4326){let h=new P({spatialReference:I,xmax:u,ymax:T}),d=W(h,A);u=d.xmax,T=d.ymax}if(r.xmax-r.xmin>u)throw new G("knowledge-graph:layer-data-manager",`Extent x bounds should be within ${u}\xB0 latitude, limit exceeded`);if(r.ymax-r.ymin>T)throw new G("knowledge-graph:layer-data-manager",`Extent y bounds should be within ${T}\xB0 longitude, limit exceeded`)}if(i.where!=null&&i.where!=="1=1"){let h=yield Q(i.where.toUpperCase(),e.fieldsIndex);e.fields.forEach(d=>{h.fieldNames.includes(d.name)&&a.add(d.name)})}m=t?`Match ()-[n:${e.objectType.name}]->() WHERE esri.graph.ST_Intersects($param_filter_geom, n.${e.geometryFieldName}) return ID(n), id(startNode(r)), id(endNode(r))`:`Match (n:${e.objectType.name}) WHERE esri.graph.ST_Intersects($param_filter_geom, n.${e.geometryFieldName}) return ID(n)`,e.geometryFieldName&&a.add(e.geometryFieldName),a.forEach(h=>{m+=`, n.${h}`,c.push(h)}),f=new v({openCypherQuery:m,bindParameters:{param_filter_geom:new Z({rings:ne(r)})}})}else{let y="";if(i.where!=null&&i.where!=="1=1"){let I=yield Q(i.where,e.fieldsIndex);e.fields.forEach(d=>{I.fieldNames.includes(d.name)&&a.add(d.name)});let N=new Set(["column-reference","string","number","binary-expression"]),u=new Set(["=","<","<=","<>",">",">=","AND","OR","LIKE"]),T=!1,h=d=>{if(d.type==="column-reference")return`n.${d.column}`;if(d.type==="string")return`'${d.value}'`;if(d.type==="number")return`${d.value}`;if(d.type==="binary-expression"&&N.has(d.left.type)&&N.has(d.right.type)&&u.has(d.operator))return`${h(d.left)} ${d.operator} ${h(d.right)}`;if(d.type==="binary-expression"&&d.operator==="LIKE"){let g="";if(d.left.type==="function"&&d.left.args.value[0].type==="column-reference")g+=`lower(n.${d.left.args.value[0].column})`;else{if(d.left.type!=="column-reference")return T=!0,"";g+=`lower(n.${d.left.column})`}if(g+=" CONTAINS (",d.right.type!=="string")return T=!0,"";{let E=d.right.value;E.charAt(0)==="%"&&(E=E.slice(1)),E.charAt(E.length-1)==="%"&&(E=E.slice(0,-1)),g+=`'${E.toLowerCase()}')`}return g}return T=!0,""};y=h(I.parseTree),T&&(y="")}let r="";r=t?`Match ()-[n:${e.objectType.name}]->()`:`Match (n:${e.objectType.name})`;let D=!1;p&&(D=!0,r+=" WHERE ID(n) IN $ids"),y&&(r+=D?" AND":" WHERE",r+=` ${y}`),r+=" return ID(n)",t&&(r+=", id(startNode(n)), id(endNode(n))"),i.returnGeometry&&e.geometryFieldName&&a.add(e.geometryFieldName),a.forEach(I=>{r+=`, n.${I}`,c.push(I)}),f=new v(p?{openCypherQuery:r,bindParameters:{ids:p}}:{openCypherQuery:r})}let b=(yield F(e.parentCompositeLayer.dataManager.knowledgeGraph,f,o)).resultRowsStream.getReader();for(;;){let{done:y,value:r}=yield b.read();if(y)break;let D=[];for(let I=0;I<r.length;I++){let N=r[I],u=0,T=0,h={properties:{}};for(h.id=N[u],u++,T++,t&&(h.originId=N[u],u++,T++,h.destinationId=N[u],u++,T++);u<N.length;u++)h.properties[c[u-T]]=N[u];D.push(h)}w=w.concat(n.writeToStore(D,x,e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name)?.name))}return w})}_isEndEntitySpatial(i,e,o){for(let n of i??[])if(this.entityTypeNames.has(n)){let a=this.geographicLookup.get(n),c=a&&this.sublayerCaches.get(n)?.get(e.attributes[o]);if(a&&c?.attributes[a.name])return!0}return!1}_getNamedTypeIdMapFromNodeIds(i){let e=new Map;return i.forEach(o=>{if(this.memberIdTypeLookup.has(o))for(let n of this.memberIdTypeLookup.get(o)){if(!this.entityTypeNames.has(n))return;e.has(n)?e.get(n)?.push(o):e.set(n,[o])}}),e}};k([R()],C.prototype,"knowledgeGraph",void 0),k([R()],C.prototype,"inclusionModeDefinition",void 0),k([R()],C.prototype,"entityTypeNames",void 0),k([R()],C.prototype,"relationshipTypeNames",void 0),k([R()],C.prototype,"geographicLookup",void 0),k([R()],C.prototype,"sublayerCaches",void 0),k([R()],C.prototype,"nodeConnectionsLookup",void 0),k([R()],C.prototype,"relationshipConnectionsLookup",void 0),k([R()],C.prototype,"memberIdTypeLookup",void 0),C=k([q("esri.layers.knowledgeGraph.KnowledgeGraphLayerDataManager")],C);export{C as a};
