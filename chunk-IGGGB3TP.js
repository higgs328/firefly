import{b as At}from"./chunk-JDU4SWWX.js";import{a as l,c as z}from"./chunk-HMOFKUIJ.js";import{a as xt}from"./chunk-EMILT3E5.js";import{a as k,b as Me,c as Tt}from"./chunk-2DH3L3DZ.js";import{a as yt,c as Mt}from"./chunk-GPMOZK2F.js";import{b as Ot}from"./chunk-INIILA7E.js";import{b as Ct}from"./chunk-YLC7GOFS.js";import{b as St}from"./chunk-KCIAXQ4S.js";import{a as Pt,c as Dt}from"./chunk-BONXCVQE.js";import{a as vt,c as j,f as bt}from"./chunk-PI27WDVR.js";import{a as Rt,c as wt}from"./chunk-IXA5GG5W.js";import{a as Et,c as qt}from"./chunk-PIIZWXGF.js";import{a as L}from"./chunk-N3W77OHB.js";import{a as ft}from"./chunk-5DVGZXEZ.js";import{a as _t}from"./chunk-NOHUHVCW.js";import{c as ot}from"./chunk-5H7NDIGP.js";import{a as lt}from"./chunk-2GLWK7ZW.js";import{a as De}from"./chunk-CX3G2QWN.js";import{g as ut}from"./chunk-YTAJKLRN.js";import{a as R}from"./chunk-FSW536RM.js";import{a as pt,b as mt}from"./chunk-QAHTJVUZ.js";import{a as gt}from"./chunk-XWEUR6F7.js";import{e as E}from"./chunk-MPI26GZ3.js";import{a as ct,e as ge}from"./chunk-5252J253.js";import{a as w}from"./chunk-7WCQBAQY.js";import{a as m,b as g}from"./chunk-T5UBLAP4.js";import{g as q,l as f,m as T}from"./chunk-DA3NC6W4.js";import{a as me,d as H}from"./chunk-CZMBPC27.js";import{j as F}from"./chunk-J5AEP4US.js";import{a as ce}from"./chunk-YHRLMRSO.js";import{a as ht}from"./chunk-XKFJ6GWH.js";import{a as ue}from"./chunk-EM2AEAFS.js";import{a as nt}from"./chunk-L7NOU4T2.js";import{a as dt}from"./chunk-IRQF7UTO.js";import{b as pe}from"./chunk-3KOZOOEP.js";import{a as at}from"./chunk-PHMJ7KPL.js";import{a as u}from"./chunk-YEXMIDOT.js";import{c as M}from"./chunk-ONYJLWAD.js";import{d as Qe,e as Je}from"./chunk-XLL67PCY.js";import{a as et}from"./chunk-PDQQY7RQ.js";import{a as U}from"./chunk-W5OI4BJ2.js";import{a as B}from"./chunk-RWCIDBNQ.js";import{a as Se}from"./chunk-EM35R6FY.js";import{a as P,b as tt,h as D,k as de,m as rt,n as it,r as Pe}from"./chunk-HM5RIVQC.js";import{a as st}from"./chunk-ALWV3RJ2.js";import{b as le}from"./chunk-QXXXCEV5.js";import{c as $e}from"./chunk-6B5XFA6F.js";import{f as Ke}from"./chunk-PTZYZULI.js";import{A as Ze,n as Ye}from"./chunk-ZTOZWLEE.js";import{g as Xe}from"./chunk-BOVYXYHK.js";import{A as Ce,a as N,c as je}from"./chunk-KVM6SHDX.js";import{a as O,c as ze,j as G,k as Oe}from"./chunk-TG45K3WR.js";import{a as ke}from"./chunk-T7DXJKX7.js";import{a as p}from"./chunk-QGVBCWUY.js";import{q as ne}from"./chunk-MYO4NP2N.js";import{e as x}from"./chunk-NFIPKH6V.js";import{l as he}from"./chunk-5QEXLALV.js";import{a as A}from"./chunk-P6QFA5MM.js";import{a as Be}from"./chunk-AML4XSEF.js";import{c as S,f as V}from"./chunk-4PTIEWMT.js";import{g as Ue}from"./chunk-XRGPJ3QY.js";import{a as Ge,b as Ne}from"./chunk-VTHXE323.js";var X=class{constructor(){this._extent=N(),this.resolution=0,this.renderLocalOrigin=yt(0,0,0,"O"),this.pixelRatio=1,this.mapUnitsPerPixel=1,this.canvasGeometries=new Ae}get extent(){return this._extent}setupGeometryViewsCyclical(e){this.setupGeometryView();let r=.001*e.range;if(this._extent[0]-r<=e.min){let i=this.canvasGeometries.extents[this.canvasGeometries.numViews++];Ce(this._extent,e.range,0,i)}if(this._extent[2]+r>=e.max){let i=this.canvasGeometries.extents[this.canvasGeometries.numViews++];Ce(this._extent,-e.range,0,i)}}setupGeometryView(){this.canvasGeometries.numViews=1,je(this.canvasGeometries.extents[0],this._extent)}hasSomeSizedView(){for(let e=0;e<this.canvasGeometries.numViews;e++){let r=this.canvasGeometries.extents[e];if(r[0]!==r[2]&&r[1]!==r[3])return!0}return!1}},Ae=class{constructor(){this.extents=[N(),N(),N()],this.numViews=0}};var _e=class{constructor(e,r,i){this._fbos=e,this._format=r,this._name=i}get valid(){return this._handle?.getTexture()!=null}dispose(){this._handle=V(this._handle)}get texture(){return this._handle?.getTexture()}bind(e,r,i){this._handle&&this._handle.fbo?.width===r&&this._handle.fbo?.height===i||(this._handle?.release(),this._handle=this._fbos.acquire(r,i,this._name,this._format)),e.bindFramebuffer(this._handle?.fbo)}generateMipMap(){this._handle?.getTexture()?.descriptor?.hasMipmap&&this._handle?.getTexture()?.generateMipmap()}};var C=class{constructor(e,r,i,a,s=w.RGBA_MIPMAP){this.output=i,this.content=a,this.fbo=new _e(e,s,r)}get valid(){return this.fbo.valid}},fe=class{constructor(e){this.targets=[new C(e,"overlay color",u.Color,l.Color),new C(e,"overlay IM color",u.Color,l.ColorNoRasterImage),new C(e,"overlay highlight",u.Highlight,l.Highlight,w.RG),new C(e,"overlay water",u.Normal,l.WaterNormal),new C(e,"overlay occluded",u.Color,l.Occluded)],at()&&this.targets.push(new C(e,"overlay olid",u.ObjectAndLayerIdColor,l.ObjectAndLayerIdColor,w.RGBA))}getTexture(e){return this.targets[e]?.fbo.texture}dispose(){for(let e of this.targets)e.fbo.dispose()}computeValidity(){return this.targets.reduce((e,r,i)=>r.valid?e|=1<<i:e,0)}};var Y=class extends g{constructor(e,r){super(e,r,new m(Ot,()=>import("./chunk-HZYUCKFQ.js")))}initializePipeline(){return T({blending:q,colorWrite:f})}};var Z=class extends g{constructor(e,r){super(e,r,new m(bt,()=>import("./chunk-PK43HH3K.js")))}initializePipeline(){return T({colorWrite:f})}};var Te=class extends nt{constructor(){super(...arguments),this.occludedFactor=ut,this.verticalCellCount=0,this.horizontalCellCount=0,this.highlightLevel=0,this.pixelRatio=1}};var K=class extends g{constructor(e,r){super(e,r,new m(Ct,()=>import("./chunk-SZHI7RBP.js")))}initializePipeline(){return T({colorWrite:f})}};var Q=class extends g{constructor(e,r){super(e,r,new m(St,()=>import("./chunk-WK4OFFE2.js")))}initializePipeline(){return T({blending:q,colorWrite:f})}};var J=class extends g{constructor(e,r){super(e,r,new m(Dt,()=>import("./chunk-T43WJEKO.js")))}initializePipeline(){return T({colorWrite:f})}};var Ft=[],Lr=[new U(B.POSITION,3,D.FLOAT,0,12)],Ir=[new U(B.POSITION,2,D.FLOAT,0,8)],Wr=[new U(B.POSITION,2,D.FLOAT,0,16),new U(B.UV0,2,D.FLOAT,8,16)];var ye=class extends dt{constructor(){super(...arguments),this.produces=pe.HIGHLIGHTS,this.consumes={required:[pe.HIGHLIGHTS,"highlights"]},this._useMultipleHighlights=!1,this._downsampleDrawParameters=new vt,this._passParameters=new Te,this._singleHighlightBlurDrawParameters=new Pt,this._grid=new Ee}initialize(){this.addHandles([O(()=>this._updateOptionsTexture(),()=>{},G)])}destroy(){this._grid.coverage=V(this._grid.coverage),this._grid.vao=S(this._grid.vao),this._passParameters.highlightOptionsTexture=V(this._passParameters.highlightOptionsTexture)}_updateOptionsTexture(){if(this._passParameters.highlightOptionsTexture==null){let t=new me(16,2);t.internalFormat=it.RGBA,t.samplingMode=de.NEAREST,this._passParameters.highlightOptionsTexture=new H(this.renderingContext,t,null)}this._passParameters.highlightOptionsTexture.setData(kt(this.view.state.highlights)),this.requestRender(M.UPDATE)}precompile(){this.techniques.precompile(Z),this._useMultipleHighlights?this.techniques.precompile(Y):(this.techniques.precompile(K),this.techniques.precompile(J),this.techniques.precompile(Q))}render(t){let e=t.find(({name:d})=>d===pe.HIGHLIGHTS),{techniques:r,bindParameters:i,_passParameters:a,renderingContext:s}=this;if(!i.decorations)return e;let o=r.get(Z);if(!o.compiled)return this.requestRender(M.UPDATE),e;let n=t.find(({name:d})=>d==="highlights").getTexture(),h=()=>{this._gridUpdateResources(n);let d=this._gridComputeCoverage(o,n,i),{horizontalCellCount:_,verticalCellCount:se}=d;return a.horizontalCellCount=_,a.verticalCellCount=se,a.coverageTexture=d.coverage?.getTexture(),d},c=d=>{let _=d.verticalCellCount*d.horizontalCellCount;s.bindVAO(d.vao),s.drawElementsInstanced(tt.TRIANGLES,6,D.UNSIGNED_BYTE,0,_)},{camera:y}=i,b=()=>{s.bindFramebuffer(e.fbo),s.setViewport4fv(y.fullViewport)};return this._useMultipleHighlights?this._renderMultiple(n,h,c,b):this._renderSingle(n,h,c,b),a.highlightTexture=null,a.coverageTexture=null,e}_renderMultiple(t,e,r,i){let{techniques:a,bindParameters:s,_passParameters:o,renderingContext:n}=this,h=a.get(Y);if(!h.compiled)return void this.requestRender(M.UPDATE);let c=e();o.highlightTexture=t,o.pixelRatio=s.camera.pixelRatio,n.bindTechnique(h,s,o),i(),r(c)}_renderSingle(t,e,r,i){let{fboCache:a,techniques:s,bindParameters:o,_passParameters:n,renderingContext:h}=this,c=s.get(K),y=s.get(J),b=s.get(Q);if(!b.compiled||!y.compiled||!c.compiled)return void this.requestRender(M.UPDATE);let d=e(),{width:_,height:se}=t.descriptor;n.highlightTexture=t;let{camera:Vt}=o,{fullWidth:Gt,fullHeight:Nt,pixelRatio:We}=Vt,we=Math.ceil(Gt/We),ve=Math.ceil(Nt/We),{_singleHighlightBlurDrawParameters:W}=this,Ut=this.view._stage.renderView.renderer,{highlights:Ve}=o;for(let ae=0;ae<Ve.length;++ae){let{name:Bt}=Ve[ae];if(!Ut.hasHighlightOptions(Bt))continue;n.highlightLevel=ae,h.setClearColor(0,0,0,0);let be=a.acquire(_,se,"single highlight",w.RG);h.bindFramebuffer(be.fbo),h.setViewport(0,0,_,se),h.clear(P.COLOR),h.bindTechnique(c,o,n),r(d),W.blurInput=be.getTexture(),le(W.blurSize,1/we,0);let oe=a.acquire(we,ve,"single highlight blur h",w.RG);h.unbindTexture(oe.fbo?.colorTexture),h.bindFramebuffer(oe.fbo),h.setViewport(0,0,we,ve),h.clear(P.COLOR),h.bindTechnique(y,o,n,W),r(d),be.release(),le(W.blurSize,0,1/ve),n.singleHighlightBlurTexture=oe.getTexture(),i(),h.bindTechnique(b,o,n,W),r(d),oe.release()}}_gridUpdateResources(t){let e=this._grid,{width:r,height:i}=t.descriptor;if(e.horizontalCellCount=Math.ceil(r/j),e.verticalCellCount=Math.ceil(i/j),e.vao)return;let a=this.renderingContext,s=De.createIndex(a,Pe.STATIC_DRAW,jt);e.vao=new lt(a,ht,new Map([["geometry",Ft]]),new Map([["geometry",De.createVertex(a,Pe.STATIC_DRAW)]]),s)}_gridComputeCoverage(t,e,r){let i=this.renderingContext,a=this._grid,s=e.descriptor,o=Math.ceil(s.width/j),n=Math.ceil(s.height/j);this._downsampleDrawParameters.input=e,a.coverage?.release();let h=this.fboCache.acquire(o,n,"highlight coverage",w.RG);return a.coverage=h,i.bindFramebuffer(h.fbo),i.bindTechnique(t,r,this._passParameters,this._downsampleDrawParameters),i.setViewport(0,0,o,n),i.screen.draw(),a}get test(){}};p([x()],ye.prototype,"produces",void 0),p([x()],ye.prototype,"consumes",void 0),ye=p([he("esri.views.3d.webgl-engine.effects.highlight.Highlight")],ye);var Ee=class{constructor(){this.coverage=null,this.vao=null,this.verticalCellCount=0,this.horizontalCellCount=0,this.viewportWidth=0,this.viewportHeight=0}};function kt(t){let e=new Uint8Array(128),r=0;for(let i of t){let a=4*r,s=4*r+64;++r;let{color:o}=i,n=i.haloColor??o;e[a+0]=o.r,e[a+1]=o.g,e[a+2]=o.b,e[a+3]=i.fillOpacity*o.a*255,e[s+0]=n.r,e[s+1]=n.g,e[s+2]=n.b,e[s+3]=i.haloOpacity*n.a*255}return e}var zt=0;function Ht(t){let e=0;for(let i of t){let{name:a}=i;e+=a.length;let{color:s,fillOpacity:o,haloColor:n,haloOpacity:h}=i;e+=s.r+s.g+s.b+s.a+o,e+=n?n.r+n.g+n.b+n.a+h:0}let r=t.at(0);if(r){let{shadowOpacity:i,shadowDifference:a,shadowColor:s}=r;e+=i+a+s.r+s.g+s.b+s.a}return zt+++(e>=0?0:1)}var jt=new Uint8Array([0,1,2,2,1,3]);function Lt(t,e,r,i,a,s=0){let o=i.highlights,n=o.length>1?e.acquire(r.width,r.height,"highlight mix",w.RG):null;if(n){let c=t.getBoundFramebufferObject();t.bindFramebuffer(n.fbo),t.clearFramebuffer(Ke),t.bindFramebuffer(c)}let h=n?.getTexture();i.highlightMixTexture=h,le(i.highlightMixOrigin,s,0),o.forEach((c,y)=>{y>0&&(t.bindTexture(h,H.TEXTURE_UNIT_FOR_UPDATES),t.gl.copyTexSubImage2D(rt.TEXTURE_2D,0,0,0,s,0,r.width,r.height),t.bindTexture(null,H.TEXTURE_UNIT_FOR_UPDATES)),t.clear(P.DEPTH),i.highlightLevel=y,a()}),i.highlightLevel=null,i.highlightMixTexture=null,n?.release()}var xe=class{constructor(e,r,i,a){this._textures=e,this._techniques=r,this.materialChanged=i,this.requestRender=a,this._id2glMaterialRef=new _t}dispose(){this._textures.destroy()}acquire(e,r,i){if(this._ownMaterial(e),!e.produces.get(r)?.(i))return null;let s=this._id2glMaterialRef.get(i,e.id);if(s==null){let o=e.createGLMaterial({material:e,techniques:this._techniques,textures:this._textures,output:i});s=new qe(o),this._id2glMaterialRef.set(i,e.id,s)}return s.ref(),s.glMaterial}release(e,r){let i=this._id2glMaterialRef.get(r,e.id);i!=null&&(i.unref(),i.referenced||(S(i.glMaterial),this._id2glMaterialRef.delete(r,e.id)))}_ownMaterial(e){e.repository&&e.repository!==this&&Ue.getLogger("esri.views.3d.webgl-engine.lib.GLMaterialRepository").error("Material is already owned by a different material repository"),e.repository=this}},qe=class{constructor(e){this.glMaterial=e,this._refCnt=0}ref(){++this._refCnt}unref(){--this._refCnt,et(this._refCnt>=0)}get referenced(){return this._refCnt>0}};var I;(function(t){t[t.Immediate=0]="Immediate",t[t.FadeWithWeather=1]="FadeWithWeather"})(I||(I={}));var It=class{constructor(e,r){this.width=e,this.height=r}},Re=class{constructor(e){this.shadowMap=e,this.slot=R.OPAQUE_MATERIAL,this.slicePlane=null,this.hasOccludees=!1,this.enableFillLights=!0,this.oitPass=ue.NONE,this.alignPixelEnabled=!1,this.decorations=!0,this.overlayStretch=1,this.viewshedEnabled=!1,this._camera=new E,this._inverseViewport=Se(),this._oldLighting=new ge,this._newLighting=new ge,this._fadedLighting=new ge,this._lighting=this._newLighting,this.ssr=new Fe,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.highlights=new Array,this.highlightOrderMap=new Map,this.highlightMixOrigin=Se(),this.highlightMixTexture=null,this.hudRenderStyle=gt.Occluded,this.hudOccludedFragmentOpacity=1,this.clouds=new xt,this.shadowHighlightsVisible=!1}get camera(){return this._camera}set camera(e){this._camera=e,this._inverseViewport[0]=1/e.fullViewport[2],this._inverseViewport[1]=1/e.fullViewport[3]}get inverseViewport(){return this._inverseViewport}get lighting(){return this._lighting}fadeLighting(){switch(this.clouds.fadeFactor){case 0:this._lighting=this._oldLighting;break;default:this._fadedLighting.lerpLighting(this._oldLighting,this._newLighting,this.clouds.fadeFactor),this._lighting=this._fadedLighting;break;case 1:this._lighting=this._newLighting,this._oldLighting.copyFrom(this._newLighting)}}updateLighting(e,r,i,a){this._oldLighting.copyFrom(this.lighting),this._newLighting.noonFactor=r,this._newLighting.globalFactor=i,this._newLighting.set(e),a===I.FadeWithWeather&&this.clouds.requestFade(),this.fadeLighting()}get highlight(){return this.highlightLevel==null?null:this.highlights[this.highlightLevel]}},Fe=class{constructor(){this.fadeFactor=1,this.reprojectionMatrix=st()}};var $=class{constructor(e,r){this.rctx=e,this.lastFrameCamera=new E,this.output=u.Color,this.renderOccludedMask=ee,this.bind=new Re(r),this.bind.alignPixelEnabled=!0}},Wt=class extends ${constructor(e,r,i){super(e,r),this.techniques=i,this.time=0}},ee=F.Occlude|F.OccludeAndTransparent|F.OccludeAndTransparentStencil;var te=class extends g{constructor(e,r){super(e,r,new m(wt,()=>import("./chunk-4NOI3OQK.js")))}initializePipeline(e){return e.hasAlpha?T({blending:q,colorWrite:f}):T({colorWrite:f})}};var re=class extends pt{constructor(){super(...arguments),this.hasAlpha=!1}};p([mt()],re.prototype,"hasAlpha",void 0);var ie=class extends g{constructor(e,r){super(e,r,new m(qt,()=>import("./chunk-4QKOWCUM.js")))}};var v=class extends ot{constructor(t){super(t),this._overlays=null,this._renderTargets=null,this._overlayParameters=new Et,this.hasHighlights=!1,this._hasWater=!1,this._renderers=new Map,this._sortedDrapeSourceRenderersDirty=!1,this._sortedRenderers=new Be,this._passParameters=new Rt,this._materials=null,this._screenToWorldRatio=1,this._localOriginFactory=null,this.unloadedMemory=0,this.ignoresMemoryFactor=!1,this._camera=new E,this.events=new ke,this.longitudeCyclical=null,this.produces=new Map([[R.DRAPED_MATERIAL,e=>e!==u.Highlight||this.hasHighlights],[R.DRAPED_WATER,()=>this._hasWater]]),this._hasTargetWithoutRasterImage=!1,this._hasDrapedFeatureSource=!1,this._hasDrapedRasterSource=!1}initialize(){let t=this._view,e=t._stage,r=e.renderer.fboCache,{waterTextures:i,textures:a}=e.renderView;this._renderContext=new $(this._rctx,new At(r,t.state.viewingMode)),this.addHandles([O(()=>i.updating,()=>this.events.emit("content-changed"),Oe),O(()=>this.spatialReference,n=>this._localOriginFactory=new Mt(n),Oe),ze(()=>t.allLayerViews,"after-changes",()=>this._sortedDrapeSourceRenderersDirty=!0),O(()=>Ht(t.state.highlights),()=>this._sortedDrapeSourceRenderersDirty=!0,G),O(()=>t.state.highlights,n=>{this._bindParameters.highlights=n,this._bindParameters.highlightOrderMap=t.state.highlightOrderMap,this._updateHighlights()},G),t.resourceController.scheduler.registerTask(Qe.STAGE,this)]),this._materials=new xe(a,this._techniques,()=>{this.notifyChange("rendersOccludedDraped"),this.events.emit("content-changed"),this.notifyChange("updating"),this.notifyChange("isEmpty")},()=>this.events.emit("content-changed"));let{_bindParameters:s,_camera:o}=this;o.near=1,o.far=1e4,o.relativeElevation=null,s.slot=R.DRAPED_MATERIAL,s.mainDepth=null,s.camera=o,s.oitPass=ue.NONE,s.updateLighting([new ct(Xe())],0,0,I.Immediate)}destroy(){this._renderers.forEach(t=>t.destroy()),this._renderers.clear(),this._passParameters.texture=S(this._passParameters.texture),this.disposeOverlays()}get _bindParameters(){return this._renderContext.bind}get _rctx(){return this._stage.renderView.renderingContext}get _view(){return this.parent.view}get _stage(){return this.parent.view._stage}get spatialReference(){return this.parent.spatialReference}get _techniques(){return this._stage.renderView.techniques}get rctx(){return this._rctx}get materials(){return this._materials}get screenToWorldRatio(){return this._screenToWorldRatio}get localOriginFactory(){return this._localOriginFactory}get pluginContext(){return this._pluginContext}initializeRenderContext(t){this._pluginContext=t,this._techniques.precompile(ie)}uninitializeRenderContext(){}acquireTechniques(){return[]}render(){}get updating(){return this._sortedDrapeSourceRenderersDirty||A(this._renderers,t=>t.updating)}get hasOverlays(){return this._overlays!=null&&this._renderTargets!=null}getMaterialRenderer(t){for(let e of this._renderers.values()){let r=e.getMaterialRenderer(t);if(r)return r}return null}get layers(){return this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers(),this._sortedRenderers.map(t=>t.drapeSource.layer).filter(t=>!!t)}_updateHighlights(){let t=this._view.state;this._renderers.forEach(e=>e.updateHighlights(t.highlightOrderMap))}createDrapeSourceRenderer(t,e,r){let i=this._renderers.get(t);i?.destroy();let a=new e(Ne(Ge({},r),{rendererContext:this,drapeSource:t}));return this._renderers.set(t,a),this._sortedDrapeSourceRenderersDirty=!0,"fullOpacity"in t&&this.addHandles(O(()=>t.fullOpacity,()=>this.events.emit("content-changed")),t),a}removeDrapeSourceRenderer(t){if(t==null)return;let e=this._renderers.get(t);e!=null&&(this._sortedDrapeSourceRenderersDirty=!0,this._renderers.delete(t),this.removeHandles(t),e.destroy())}computeValidity(){return this._renderTargets?.computeValidity()??0}releaseRenderTargets(){this._renderTargets?.dispose()}get overlays(){return this._overlays??[]}ensureDrapeTargets(t){this._hasTargetWithoutRasterImage=!!this._overlays&&ne(t,e=>e.drapeTargetType===Tt.WithoutRasterImage)}ensureDrapeSources(t){this._overlays?(this._hasDrapedFeatureSource=ne(t,e=>e.drapeSourceType===k.Features),this._hasDrapedRasterSource=ne(t,e=>e.drapeSourceType===k.RasterImage)):this._hasDrapedFeatureSource=this._hasDrapedRasterSource=!1}get _needsColorWithoutRasterImage(){return this._hasDrapedRasterSource&&this._hasDrapedFeatureSource&&this._hasTargetWithoutRasterImage}ensureOverlays(t,e,r=this._bindParameters.overlayStretch){this._overlays==null&&(this._renderTargets=new fe(this._stage.renderer.fboCache),this._overlays=[new X,new X]),this.ensureDrapeTargets(t),this.ensureDrapeSources(e),this._bindParameters.overlayStretch=r}disposeOverlays(){this._overlays=null,this._renderTargets=S(this._renderTargets),this.events.emit("textures-disposed")}getTexture(t){if(t!=null)return t===l.ColorNoRasterImage&&!this._needsColorWithoutRasterImage&&this._hasDrapedFeatureSource?this._renderTargets?.getTexture(l.Color):this._renderTargets?.getTexture(t)}get running(){return this.updating}runTask(t){this._processDrapeSources(t,()=>!0)}_processDrapeSources(t,e){let r=!1;for(let[i,a]of this._renderers){if(t.done)break;(i.destroyed||e(i))&&a.commitChanges(this._view.state.highlightOrderMap)&&(r=!0,t.madeProgress())}this._sortedDrapeSourceRenderersDirty&&(this._sortedDrapeSourceRenderersDirty=!1,r=!0,this._updateSortedDrapeSourceRenderers()),r&&(this._overlays!=null&&this._renderers.size===0&&this.disposeOverlays(),this.notifyChange("updating"),this.notifyChange("isEmpty"),this.events.emit("content-changed"),this.hasHighlights=A(this._renderers,i=>i.hasHighlights),this.notifyChange("rendersOccludedDraped"))}hasHighlightOptions(t){return A(this._renderers,e=>e.hasHighlightOptions(t))}processSyncDrapeSources(){this._processDrapeSources(Je,t=>t.updatePolicy===ft.SYNC)}get isEmpty(){return!ce.OVERLAY_DRAW_DEBUG_TEXTURE&&!A(this._renderers,t=>!t.isEmpty)}get hasWater(){let t=A(this._renderers,e=>e.hasWater);return t!==this._hasWater&&(this._hasWater=t,this.events.emit("has-water")),this._hasWater}get rendersOccludedDraped(){let t=this._renderContext.renderOccludedMask;this._renderContext.renderOccludedMask=He,++this._techniques.precompiling;let e=this._sortedRenderers.some(({renderer:r})=>r.precompile(this._renderContext));return--this._techniques.precompiling,this._renderContext.renderOccludedMask=t,e}renders(t){if(ce.OVERLAY_DRAW_DEBUG_TEXTURE&&t!==l.Occluded&&t!==l.Highlight)return!0;++this._techniques.precompiling;let e=this._sortedRenderers.some(({renderer:r})=>r.precompile(this._renderContext));return--this._techniques.precompiling,e}get mode(){return this.isEmpty?z.Disabled:this.hasWater&&this.renders(l.WaterNormal)?z.EnabledWithWater:this._renderTargets?.getTexture(l.Color)?z.Enabled:z.Disabled}updateAnimation(t){let e=!1;return this._renderers.forEach(r=>e=r.updateAnimation(t)||e),e&&this.parent.requestRender(M.BACKGROUND),e}updateDrapeSourceOrder(){this._sortedDrapeSourceRenderersDirty=!0}precompileShaders(t){if(this._renderTargets){this._bindParameters.alignPixelEnabled=t.alignPixelEnabled,++this._techniques.precompiling;for(let e of this._renderTargets.targets){if(e.content===l.ColorNoRasterImage&&!this._needsColorWithoutRasterImage)continue;let r=e.output;this._renderContext.output=r,this._bindParameters.slot=r===u.Normal?R.DRAPED_WATER:R.DRAPED_MATERIAL,e.content===l.Occluded&&(this._renderContext.renderOccludedMask=He),this._sortedRenderers.forAll(({drapeSource:i,renderer:a})=>{e.content===l.ColorNoRasterImage&&i.drapeSourceType===k.RasterImage||a.precompile(this._renderContext)}),this._renderContext.renderOccludedMask=ee}--this._techniques.precompiling}}drawOverlays(t){if(this._overlays&&this._renderTargets){for(let e of this._overlays)this.longitudeCyclical?e.setupGeometryViewsCyclical(this.longitudeCyclical):e.setupGeometryView();this._bindParameters.alignPixelEnabled=t.alignPixelEnabled;for(let e of this._renderTargets.targets){if(e.content===l.ColorNoRasterImage&&!this._needsColorWithoutRasterImage)continue;let r=this._drawTarget(L.INNER,e),i=this._drawTarget(L.OUTER,e);(r||i)&&e.fbo.generateMipMap()}}}_drawTarget(t,e){let r=this._overlays[t],i=r.canvasGeometries;if(i.numViews===0)return!1;let a=this._view.state.contentPixelRatio;this._screenToWorldRatio=a*r.mapUnitsPerPixel/this._bindParameters.overlayStretch;let s=e.output;if(this.isEmpty||s===u.Normal&&!this.hasWater||!r.hasSomeSizedView())return!1;let{_rctx:o,_camera:n,_renderContext:h,_bindParameters:c}=this;if(n.pixelRatio=r.pixelRatio*a,h.output=s,c.screenToWorldRatio=this._screenToWorldRatio,c.screenToPCSRatio=this._screenToWorldRatio*this.parent.worldToPCSRatio,c.slot=s===u.Normal?R.DRAPED_WATER:R.DRAPED_MATERIAL,e.content===l.Occluded&&(h.renderOccludedMask=He),!this.renders(e.content))return h.renderOccludedMask=ee,!1;let{resolution:y}=r,b=t===L.INNER?0:y;if(o.setViewport(b,0,y,y),this._bindTargetFBO(e),t===L.INNER&&(o.setClearColor(0,0,0,0),o.clear(P.COLOR)),ce.OVERLAY_DRAW_DEBUG_TEXTURE&&e.content!==l.Occluded&&e.content!==l.Highlight){this._techniques.precompile(te,Ie);let d=this._techniques.get(te,Ie);for(let _=0;_<i.numViews;_++)this._setViewParameters(i.extents[_],r),this._ensureDebugPatternResources(r.resolution,Xt[t]),o.bindTechnique(d,c,this._passParameters),o.screen.draw()}if(e.output===u.Highlight){let{fboCache:d}=this._stage.renderer,_=this._resolution;this._bindTargetFBO(e),Lt(o,d,{width:_,height:_},c,()=>this._renderAllGeometry(t,e),b)}else this._renderAllGeometry(t,e);return o.bindFramebuffer(null),h.renderOccludedMask=ee,!0}_renderAllGeometry(t,e){let r=this._overlays[t],i=r.canvasGeometries;this._sortedRenderers.forAll(({drapeSource:a,renderer:s})=>{if(e.content===l.ColorNoRasterImage&&a.drapeSourceType===k.RasterImage)return;let{fullOpacity:o}=a,n=o!=null&&o<1&&e.output===u.Color&&this._bindTemporaryFBO();for(let h=0;h<i.numViews;h++)this._setViewParameters(i.extents[h],r),s.render(this._renderContext);if(n){this._bindTargetFBO(e),this._overlayParameters.texture=n.getTexture(),this._overlayParameters.opacity=o,this._overlayParameters.overlayIndex=t;let h=this._techniques.get(ie);this._rctx.bindTechnique(h,this._bindParameters,this._overlayParameters),this._rctx.screen.draw(),n.release()}})}_bindTargetFBO(t){let e=this._resolution,r=2*e;t.fbo.bind(this._rctx,r,e)}_bindTemporaryFBO(){let t=this._resolution,e=2*t,r=this._stage.renderer.fboCache,i=r.acquire(e,t,"overlay tmp");return r.rctx.bindFramebuffer(i.fbo),r.rctx.clear(P.COLOR),i}get _resolution(){return this._overlays?.[L.INNER].resolution??0}notifyContentChanged(){this.events.emit("content-changed")}intersect(t,e,r,i){this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers();let a=0;for(let{renderer:s}of this._sortedRenderers)a=s.intersect?.(t,e,r,i,a)??a}_updateSortedDrapeSourceRenderers(){if(this._sortedRenderers.clear(),this._renderers.size===0)return;let t=this._view.map.allLayers,e=t.length;this._renderers.forEach((r,i)=>{let a=t.indexOf(i.layer),s=a>=0,o=i.renderGroup??(s?Me.MapLayer:Me.ViewLayer),n=e*o+(s?a:0);this._sortedRenderers.push(new Le(i,r,n))}),this._sortedRenderers.sort((r,i)=>r.index-i.index)}_setViewParameters(t,e){let r=this._camera;r.viewport=[0,0,e.resolution,e.resolution],Ze(r.projectionMatrix,0,t[2]-t[0],0,t[3]-t[1],r.near,r.far),Ye(r.viewMatrix,[-t[0],-t[1],0])}_ensureDebugPatternResources(t,e){if($e(this._passParameters.color,e[0],e[1],e[2]),this._passParameters.texture)return;let r=new Uint8Array(t*t*4),i=0;for(let s=0;s<t;s++)for(let o=0;o<t;o++){let n=Math.floor(o/10),h=Math.floor(s/10);n<2||h<2||10*n>t-20||10*h>t-20?(r[i++]=255,r[i++]=255,r[i++]=255,r[i++]=255):(r[i++]=255,r[i++]=255,r[i++]=255,r[i++]=1&n&&1&h?1&o^1&s?0:255:1&n^1&h?0:128)}let a=new me(t);a.samplingMode=de.NEAREST,this._passParameters.texture=new H(this._rctx,a,r)}get test(){}};p([x()],v.prototype,"hasHighlights",void 0),p([x()],v.prototype,"_sortedDrapeSourceRenderersDirty",void 0),p([x({constructOnly:!0})],v.prototype,"parent",void 0),p([x({readOnly:!0})],v.prototype,"_techniques",null),p([x({type:Boolean,readOnly:!0})],v.prototype,"updating",null),p([x()],v.prototype,"isEmpty",null),p([x({readOnly:!0})],v.prototype,"rendersOccludedDraped",null),v=p([he("esri.views.3d.terrain.OverlayRenderer")],v);var Le=class{constructor(e,r,i){this.drapeSource=e,this.renderer=r,this.index=i}},Xt=[[1,.5,.5],[.5,.5,1]],ks=-2,He=F.OccludeAndTransparent,Ie=new re;Ie.hasAlpha=!0;export{Lr as a,Ir as b,Wr as c,ye as d,Lt as e,xe as f,I as g,It as h,Re as i,Wt as j,ee as k,v as l,ks as m,He as n};
