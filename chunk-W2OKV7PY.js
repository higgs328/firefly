import{a as wt}from"./chunk-S5TVWI2Y.js";import{a as ft}from"./chunk-4PK4ZJM7.js";import{a as d}from"./chunk-GVABYWYT.js";import{a as vt}from"./chunk-EQ3KQIXX.js";import{a as E}from"./chunk-TCTLHOSE.js";import{a as bt}from"./chunk-INL6HB7Y.js";import{a as gt}from"./chunk-E3FPV7ZA.js";import{a as yt}from"./chunk-6HINJY73.js";import{a as ut}from"./chunk-EBLTZITF.js";import{c as ht,d as dt}from"./chunk-PTFN55DA.js";import{a as ct}from"./chunk-DXDHIMTP.js";import{a as mt}from"./chunk-6LW5LY2X.js";import{a as rt}from"./chunk-LORHDXEB.js";import{a as at,b as lt}from"./chunk-5BPM64SU.js";import{d as st}from"./chunk-XLL67PCY.js";import{q as P}from"./chunk-6B5XFA6F.js";import{a as ot}from"./chunk-3JGYBNJA.js";import{a as pt}from"./chunk-QK56OQGR.js";import{a as x}from"./chunk-BOVYXYHK.js";import{w as nt}from"./chunk-EQZWYK27.js";import{a as b}from"./chunk-G4DZJMGT.js";import{f as p}from"./chunk-CCJU4DSH.js";import{b as et,e as it}from"./chunk-TG45K3WR.js";import{c as tt}from"./chunk-RAI4DTMT.js";import{b as M}from"./chunk-ACP3S2CH.js";import{a as r}from"./chunk-QGVBCWUY.js";import{e as n}from"./chunk-NFIPKH6V.js";import{l}from"./chunk-5QEXLALV.js";import{j as L,r as C}from"./chunk-P6QFA5MM.js";import{b as Q,d as X,o as Y,v as Z,y as $}from"./chunk-4PTIEWMT.js";import{g as K}from"./chunk-XRGPJ3QY.js";import{b as f}from"./chunk-2LI2GKBQ.js";import{a as D,b as J,f as h}from"./chunk-VTHXE323.js";var q,S=q=class extends p{constructor(){super(...arguments),this.text=""}clone(){return new q({text:this.text})}};r([n({type:String,json:{write:{isRequired:!0}}})],S.prototype,"text",void 0),S=q=r([l("esri.webscene.support.Description")],S);var w=S;var O,u=O=class extends p{constructor(){super(...arguments),this.lighting=new E,this.weather=new yt}clone(){return new O({lighting:f(this.lighting),weather:f(this.weather)})}};r([n({types:ft,json:{write:!0}})],u.prototype,"lighting",void 0),r([n({types:gt,json:{write:!0}})],u.prototype,"weather",void 0),u=O=r([l("esri.webscene.Environment")],u);var j,I=j=class extends p{constructor(){super(...arguments),this.opacity=null}clone(){return new j({opacity:this.opacity})}cloneAndApplyTo(t){return this.opacity==null||((t=t?.clone()??new ct).opacity=this.opacity),t}static fromGround(t){return new j({opacity:t.opacity})}};r([n({type:Number,json:{type:C,read:{reader:lt,source:"transparency"},write:{writer:(t,e)=>{e.transparency=at(t)},target:"transparency"}}})],I.prototype,"opacity",void 0),I=j=r([l("esri.webscene.support.SlideGround")],I);var B=I;var F,y=F=class extends p{constructor(t){super(t),this.id="",this.sublayerIds=null}clone(){return new F({id:this.id,sublayerIds:f(this.sublayerIds)})}};r([n({type:String,json:{write:!0}})],y.prototype,"id",void 0),r([n({type:[C],json:{read:{source:"subLayerIds"},write:{target:"subLayerIds"}}})],y.prototype,"sublayerIds",void 0),y=F=r([l("esri.webscene.support.SlideVisibleLayer")],y);var G,k=G=class extends p{constructor(){super(...arguments),this.text=""}clone(){return new G({text:this.text})}};r([n({type:String,json:{write:{isRequired:!0}}})],k.prototype,"text",void 0),k=G=r([l("esri.webscene.support.Title")],k);var v=k;var St=0,N=M.ofType(y),jt=["caption","cover","none"],o=class extends ot.ClonableMixin(p){constructor(t){super(t),this.id=Date.now().toString(16)+"-slide-"+St++,this.title=new v,this.description=new w,this.hidden=!1,this.thumbnail=new d,this.viewpoint=null,this.basemap=null,this.ground=null,this.layout="caption",this.environment=new u,this.timeExtent=null,this.elements=null,this.visibleLayers=new N}destroy(){this.visibleLayers.removeAll(),this.basemap=null,this.thumbnail=Q(this.thumbnail),this.description=null,this.title=null,this.thumbnail=null,this.elements=null}castTitle(t){return typeof t=="string"?new v({text:t}):L(v,t)}castDescription(t){return typeof t=="string"?new w({text:t}):L(w,t)}castThumbnail(t){return typeof t=="string"?new d({url:t}):L(d,t)}castBasemap(t){return ht(t)}set visibleLayers(t){this._set("visibleLayers",rt(t,this._get("visibleLayers"),N))}castVisibleLayers(t){return t&&typeof t.map=="function"?t.map(e=>{if(typeof e=="string")return{id:e};if(e instanceof pt){let i=Tt(e);return{id:e.id,sublayerIds:i}}return e.id?{id:e.id,sublayerIds:"sublayerIds"in e?e.sublayerIds:void 0}:(K.getLogger(this).warn('Invalid visible layer, expected { id }, Layer or "id"'),e)}):null}_updateVisibleLayersFrom(t){return h(this,null,function*(){let e=[];yield Promise.allSettled(this._getLayers(t.map).map(i=>t.whenLayerView(i).then(s=>{if(s.visible){let m=Tt(i);e.push(new y({id:s.layer.id,sublayerIds:m}))}})).toArray()),this.visibleLayers.removeAll(),this.visibleLayers.addMany(e)})}updateFrom(t,e){let i=D({format:"png",quality:80,width:120,height:75,disableDecorations:!0},e?.screenshot);return t.when(()=>(this.viewpoint=t.viewpoint.clone(),this.environment.lighting=t.environment.lighting.type==="virtual"?bt.prototype.clone.apply(t.environment.lighting):E.prototype.clone.apply(t.environment.lighting),this.environment.weather=t.environment.weather.clone(),this.basemap=t.map.basemap?.clone()||null,this.ground=t.map.ground?B.fromGround(t.map.ground):null,this.timeExtent=t.timeExtent?.clone()??null,this._updateVisibleLayersFrom(t))).then(()=>t.takeScreenshot(i)).then(s=>(this.thumbnail=new d({url:s.dataUrl}),this))}applyTo(t,e){return h(this,null,function*(){this._applyToController!=null&&this._applyToController.abort();let i=new AbortController;this._applyToController=i;let s=Z(e,()=>i?.abort()),m=()=>{this._applyToController===i&&(this._applyToController=null),i=null,s?.remove()};try{yield it(()=>t.ready,i.signal)}catch(_){throw m(),_}if(i.signal.aborted)throw m(),Y();let a=t.resourceController.scheduler.registerTask(st.SLIDE),T=!1,c=J(D({animate:!0},e),{signal:this._applyToController.signal}),V=()=>h(this,null,function*(){yield Promise.all([a.schedule(()=>h(this,null,function*(){return T=yield this._setViewpointOfInterest(t,c)})),a.schedule(()=>this._applyBasemap(t,c),c.signal),a.schedule(()=>this._loadLayersWithSublayerVisibility(t))]),yield Promise.all([a.schedule(()=>this._applyLayerVisibility(t),c.signal),a.schedule(()=>this._applyGround(t),c.signal),a.schedule(()=>this._applyViewpoint(t,c),c.signal),a.schedule(()=>t.timeExtent=this.timeExtent?.clone()??null,c.signal),a.schedule(()=>t.environment.weather=this.environment.weather.clone())])}),g=yield tt(t.addUpdatingPromise(V()));if(T&&(t.contentCamera=null),a.remove(),m(),g.ok===!1)throw g.error;return this})}_applyBasemap(t,e){return h(this,null,function*(){if(this.basemap){try{yield this.basemap.load(e)}catch(i){if($(i))throw i}t.map.basemap=dt(this.basemap,t.map.basemap)}})}_applyGround(t){this.ground&&(t.map.ground=this.ground.cloneAndApplyTo(t.map.ground))}_getLayers(t){let e=new M;return this._collectLayers(t,e),this._collectLayers(t.ground,e),e}_collectLayers(t,e){t.layers.forEach(i=>{i.persistenceEnabled&&(e.add(i),"layers"in i&&this._collectLayers(i,e))})}_loadLayersWithSublayerVisibility(t){return h(this,null,function*(){this.visibleLayers&&(yield Promise.allSettled(this._getLayers(t.map).items.map(e=>this.visibleLayers.find(s=>s.id===e.id)?.sublayerIds?e.load():null)))})}_applyLayerVisibility(t){this.visibleLayers&&this._getLayers(t.map).forEach(e=>{let i=this.visibleLayers.find(a=>a.id===e.id);e.visible=i!=null;let s=i?.sublayerIds,m=_t(e);s&&m&&m.forEach(a=>a.visible=s.includes(a.id))})}_setViewpointOfInterest(t,e){return h(this,null,function*(){if(t.state.fixedContentCamera||!this.viewpoint||e?.ignoreViewpoint||!e?.useDestinationCamera)return!1;let{toCameraAsync:i}=yield import("./chunk-2WEPPAFJ.js"),s=yield i(t,this.viewpoint);return t.contentCamera=s,s!=null})}_applyViewpoint(t,e){return h(this,null,function*(){if(this._applyCachedCameraTrackingEnabled(t),this.viewpoint&&!e.ignoreViewpoint){let i=this.environment.lighting;if(e.animate&&i.type==="sun"&&i.date)return this._animateToLighting(t,e);e.animate&&(t.environment.applyLighting(i.clone()),yield t.goTo(this.viewpoint,e)),t.viewpoint=this.viewpoint}t.environment.applyLighting(this.environment.lighting.clone())})}_animateToLighting(t,e){return h(this,null,function*(){let i=null;return t.environment.lighting.type!=="virtual"&&this.environment.lighting.type!=="virtual"&&(t.viewingMode==="global"&&(i=this._animateLightingWithCamera(t,t.environment.lighting,this.environment.lighting)),t.environment.cachedCameraTrackingEnabled=t.environment.lighting.cameraTrackingEnabled,t.environment.lighting.cameraTrackingEnabled=!1),t.environment.lighting.directShadowsEnabled=this.environment.lighting.directShadowsEnabled,this.environment.lighting.type==="virtual"||t.environment.lighting.type==="virtual"?(t.environment.applyLighting(this.environment.lighting.clone()),t.environment.lighting.type!=="virtual"&&(t.environment.cachedCameraTrackingEnabled=t.environment.lighting.cameraTrackingEnabled,t.environment.lighting.cameraTrackingEnabled=!1)):this.environment.lighting.displayUTCOffset!=null&&(t.environment.lighting.displayUTCOffset=this.environment.lighting.displayUTCOffset),t.goTo(this.viewpoint,e).then(()=>{this._applyCachedCameraTrackingEnabled(t),t.environment.applyLighting(this.environment.lighting.clone())}).catch(s=>{throw t.animation==null&&this._applyCachedCameraTrackingEnabled(t),s}).finally(()=>{X(i)})})}_applyCachedCameraTrackingEnabled(t){t.environment.cachedCameraTrackingEnabled!=null&&(t.environment.lighting.cameraTrackingEnabled=t.environment.cachedCameraTrackingEnabled,t.environment.cachedCameraTrackingEnabled=null)}_getTime(t){return[t.getTime(),3600*t.getUTCHours()+60*t.getUTCMinutes()+t.getUTCSeconds()]}_setTime(t,e,i){return t.setTime(e),t.setUTCHours(i/3600),t.setUTCMinutes(i%3600/60),t.setUTCSeconds(i%3600%60),t}_animateLightingWithCamera(t,e,i){let s=new Date(e.date.toString()),[m,a]=this._getTime(s),[T,c]=this._getTime(i.date),V=kt(a,c),g=t.renderCoordsHelper,_=x();g.toRenderCoords(t.camera.position,_);let H=x(),A=x();this.viewpoint.camera!=null&&g.toRenderCoords(this.viewpoint.camera.position,H);let Lt=new Date;return et(()=>t.camera,Ct=>{g.toRenderCoords(Ct.position,A);let U=P(_,A),z=P(H,A),R=0;U+z!==0&&(R=U/(U+z));let xt=m+(T-m)*R,Et=Vt(a,V*R);e.date=this._setTime(Lt,xt,Et)})}static createFrom(t,e){return new this().updateFrom(t,e)}};r([n({type:String,json:{write:{isRequired:!0}}})],o.prototype,"id",void 0),r([n({type:v,json:{default:()=>new v({text:""}),write:{isRequired:!0}}})],o.prototype,"title",void 0),r([b("title")],o.prototype,"castTitle",null),r([n({type:w,json:{write:{overridePolicy:t=>({enabled:!(!t||!t.text)})}}})],o.prototype,"description",void 0),r([b("description")],o.prototype,"castDescription",null),r([n({type:Boolean,nonNullable:!0,json:{write:!0,default:!1}})],o.prototype,"hidden",void 0),r([n({type:d,json:{default:()=>new d({url:""}),write:{isRequired:!0}}})],o.prototype,"thumbnail",void 0),r([b("thumbnail")],o.prototype,"castThumbnail",null),r([n({type:ut,nonNullable:!0,json:{write:{isRequired:!0}}})],o.prototype,"viewpoint",void 0),r([n({type:mt,json:{read:{source:"baseMap"},write:{target:"baseMap"}}})],o.prototype,"basemap",void 0),r([b("basemap")],o.prototype,"castBasemap",null),r([n({type:B,json:{write:!0}})],o.prototype,"ground",void 0),r([n({type:jt,json:{write:!0,default:"caption"},nonNullable:!0})],o.prototype,"layout",void 0),r([n({type:N,json:{write:{isRequired:!0}}})],o.prototype,"visibleLayers",null),r([b("visibleLayers")],o.prototype,"castVisibleLayers",null),r([n({type:u,json:{write:!0}})],o.prototype,"environment",void 0),r([n(vt)],o.prototype,"timeExtent",void 0),r([n({type:wt,json:{write:!0}})],o.prototype,"elements",void 0),o=r([l("esri.webscene.Slide")],o);var li=o;function _t(t){if(t.type==="building-scene"||t.type==="map-image")return t.allSublayers.toArray()}function Tt(t){let e=_t(t);if(e)return e.filter(i=>i.visible).map(i=>i.id)}var W=86400,It=43200;function kt(t,e){let i=e-t;return i>It&&(i-=W),i<-43200&&(i+=W),i}function Vt(t,e){return nt(t+e,W)}export{li as a};
