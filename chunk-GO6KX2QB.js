import{a as T,c as pa}from"./chunk-PLVVXHQB.js";import{$ as sa,A as Y,F as _,G as $,H as aa,K as ea,M as ta,P as ra,T as x,U as b,V as oa,X as na,Y as j,Z as ia,_ as H,da as ca,ea as E,ga as la,ha as ma,ia as fa,w as K,x as Q,z as X}from"./chunk-XXEY6HOD.js";import{b as q}from"./chunk-ZCXB2W4M.js";import{e as G,i as J}from"./chunk-QSQIQSC6.js";import{e as D,f as N}from"./chunk-AYNBEMCC.js";import{d as B}from"./chunk-5C57S7IZ.js";import{k as F,q as k}from"./chunk-7SDNM7YV.js";import{G as z}from"./chunk-6B5XFA6F.js";import{h as Z}from"./chunk-RNC4P66O.js";import{a as L,b as C,f as O}from"./chunk-BOVYXYHK.js";import{c as h}from"./chunk-VIEK2X23.js";import{m as I}from"./chunk-QBWJMFH5.js";import{a as R,b as S,f as p}from"./chunk-VTHXE323.js";function V(e,a,t){return p(this,null,function*(){let r=Array.isArray(e)?e:[e],o;if(ca(a))o=yield Q(r,a.elevationSample,t);else if(E(a)){let{elevationSource:c,extent:l}=a,{url:s,lod:m,rasterFunction:i}=c;o=yield K(r,{url:s,lod:m,rasterFunction:i,extent:l},t)}else o=yield X(r,a.elevationSource.constantElevation,t);return Array.isArray(e)?o:o[0]})}function ha(o,c,l){return p(this,arguments,function*(e,a,t,r=ya){let{cameraLocation:s,farPlaneVertices:m}=t,i=x(s),n=new Array;yield ga(m,t,n);let f=F(n[0],n[1],n[2]),d=e.clone();for(let g=0;g<r;g++){let w=L();if(!k(f,i,x(e),w))break;let v=0,P=null;if({error:v,imagePoint:P,pointWithZ:d}=yield ba(a,new h(w,s.spatialReference),t),v<=1)break;let[y,u]=wa(s.spatialReference,n);if(b(y<=1,u<=1))break;n.splice(0,n.length,...yield va(y,u,new h(w,s.spatialReference),t)),f=F(n[0],n[1],n[2])}return x(d)})}function da(o,c,l){return p(this,arguments,function*(e,a,t,r=ya){let{cameraLocation:s,farPlaneVertices:m}=t,i=x(s),n=new Array;yield ga(m,t,n);let f=F(n[0],n[1],n[2]),d=e.clone();for(let g=0;g<r;g++){let w=L();if(!k(f,i,x(e),w))break;let v,P=0;if({error:P,imagePoint:v,pointWithZ:d}=yield Ta(a,new h(w,s.spatialReference),t),P<=1)break;let[y,u]=wa(s.spatialReference,n);if(b(y<=1,u<=1))break;n.splice(0,n.length,...yield va(y,u,new h(w,s.spatialReference),t)),f=F(n[0],n[1],n[2])}return x(d)})}var ya=10,ua=10;function wa(e,a){let t=new Z({spatialReference:e});return t.addRing(a),[t.extent?.width?t.extent.width/ua:1,t.extent?.height?t.extent.height/ua:1]}function ga(e,a,t){return p(this,null,function*(){let r=q(e),o=yield V(r,a);t.push(...o.map(x))})}function ba(e,a,t){return p(this,null,function*(){let r=yield V(a,t),o=T(r,t);return{error:Fa(o,e),imagePoint:o,pointWithZ:r}})}function Ta(e,a,t){return p(this,null,function*(){let r=yield V(a,t),o=pa(r,t);return{error:Va(o,e),imagePoint:o,pointWithZ:r}})}var Fa=(e,a)=>Math.abs(e.x-a.x)+Math.abs(e.y-a.y),Va=(e,a)=>Math.abs(e.heading-a.heading)+Math.abs(e.pitch-a.pitch);function va(e,a,t,r){return p(this,null,function*(){let o=[[-e,-a],[e,-a],[e,a],[-e,a]].map(([c,l])=>new h([t.x+c,t.y+l],t.spatialReference));return V(o,r).then(c=>c.map(l=>l.toArray()))})}function le(e,a,t){return p(this,null,function*(){let{verticalFieldOfView:r,imageBoundaries:o,scalingFactor:c,farPlaneVertices:l,cameraLocation:s,pixelsToTransform:m,vecToPoint:i}=ka(e,a),n=new Array;return yield Ma(m,l,o,i,a,n,s,c,r,t),Array.isArray(e)?n:n[0]})}function Ma(e,a,t,r,o,c,l,s,m,i){return p(this,null,function*(){let n=o.averageElevation;for(let f of e){let d=Ea(a,t,f,r,o);i&&b(H(i.elevationSample),E(i))&&(n=(yield ha(r(d),{x:f[0],y:f[1]},S(R(R({},o),i),{farPlaneVertices:a.map(r)})))[2]),c.push(r(xa(d,l,s,n,o.cameraPitch,m)))}})}function xa(e,a,t,r,o,c){let l=C(e),s=Math.sqrt((e[2]-a[2])**2+(Math.sqrt((e[0]-a[0])**2+(e[1]-a[1])**2)/t)**2)*t,m=aa(z(O(),e,a),1/s,1/t);if(Sa(e[2],r,o,c)){let i=Math.abs((a[2]-r)/-m[2])*t;l=$(a,m,i,t)}else l[2]=r;return l}function Sa(e,a,t,r){return e<a||t+r/2<90}function Ea(e,a,t,r,o){let c=null,l=9,s,m=0,i=e,n=a;for(;m<=l;){let f=La(t,n,i,o);if(s=f.error,c=f.transformedPoint,b(s<=1,m===l))break;i=sa(i,s,t,a),n=Wa(i,r,o),m++}return c}function Wa(e,a,t){return T(e.map(a),t).map(({x:r,y:o})=>[r,o,1])}function La(e,a,t,r){let{cameraLocation:o}=r,c=_(e,a,t),{x:l,y:s}=T(new h(c,o.spatialReference),r);return{transformedPoint:c,error:Oa(e,[l,s,1])}}function Oa(e,a){return Math.abs(e[0]-a[0])+Math.abs(e[1]-a[1])}function ka(e,a){let t=I(e)||"items"in e?e:[e],{cameraLocation:r,rotationMatrix:o}=a;if(oa(t,r),na(o),o?.length!==9)throw new Error("Rotation matrix is not provided or is not a valid 3x3 matrix");let c=j(r.y,r.spatialReference),l=fa(S(R({},a),{scalingFactor:c})),s=T(l.map(i=>new h(i,r.spatialReference)),a),{vfov:m}=ea(a.horizontalFieldOfView,a.verticalFieldOfView,a.cameraRoll);return{cameraLocation:r.toArray(),imageBoundaries:s.map(({x:i,y:n})=>[i,n,1]),verticalFieldOfView:m,farPlaneVertices:l,scalingFactor:c,pixelsToTransform:t.map(i=>[i.x,i.y,1]),vecToPoint:ia(r.spatialReference)}}function me(e,a,t){return p(this,null,function*(){let{cameraHeading:r,cameraLocation:o,farDistance:c,imageHeight:l,imageWidth:s,verticalFieldOfView:m}=a,i=j(o.y,o.spatialReference),n=new Array,[f,d,g]=o.toArray(),w=G([f,d,g??0],c*i),v=Y.toArray(),P=Array.isArray(e)?e:[e];for(let y of P){let u,A;if(la(y))u=y.heading,A=y.pitch;else{let M=ta({x:y.x,y:y.y},s,l);u=M.heading,A=M.pitch}u=(u+r)%360;let Pa=D([v[0],v[1],v[2]],ra(u,A)),Aa=N([f,d,g??0],Pa.direction),W=O();J(w,Aa,W);let U=a.averageElevation;t&&(B(t)||H(t.elevationSample))&&A+m/2<90&&(U=(yield da(new h(W,o.spatialReference),{heading:u,pitch:A},S(R(R({},a),t),{farPlaneVertices:ma(c,c).map(([M,Ra])=>new h([o.x+M,o.y+Ra],o.spatialReference))})))[2]),n.push(new h(xa(W,o.toArray(),i,U,A,m),o.spatialReference))}return Array.isArray(e)?n:n[0]})}export{V as a,le as b,me as c};
