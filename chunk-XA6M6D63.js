import{a as xe}from"./chunk-R3FXASFX.js";import{a as ve}from"./chunk-GADLIJ5Z.js";import{a as Ee}from"./chunk-2NQYTMPD.js";import{a as D}from"./chunk-SBU7IJGM.js";import{a as _e}from"./chunk-2QYW4A6N.js";import{a as W,b as ge}from"./chunk-MELYPAZ7.js";import{C as ye,b as ce,c as w,d as O,e as de,i as he,j as fe,k as me,p as $,w as G}from"./chunk-PKVI3POI.js";import{a as ue,b as pe}from"./chunk-ZK55DZ3X.js";import{a as le}from"./chunk-7IOOWZFM.js";import{a as re}from"./chunk-LAX5536Z.js";import{a as oe}from"./chunk-7PAP5DT2.js";import{a as se,b as P,c as ne,d as ie,e as L}from"./chunk-CZAUQJCN.js";import{a as S}from"./chunk-JQAW4OB5.js";import{s as ae}from"./chunk-KALOJIUA.js";import{a as X}from"./chunk-4N4D2YQX.js";import{a as Y,b as q,c as Z}from"./chunk-MVHHPJM7.js";import{a as R,c as Q,e as ee,k as te}from"./chunk-TG45K3WR.js";import{a as K}from"./chunk-T7DXJKX7.js";import{a as u}from"./chunk-QGVBCWUY.js";import{H as k}from"./chunk-MYO4NP2N.js";import{e as p}from"./chunk-NFIPKH6V.js";import{l as b}from"./chunk-5QEXLALV.js";import{c as M}from"./chunk-P6QFA5MM.js";import{K as T,L as B,b as N,y as H}from"./chunk-4PTIEWMT.js";import{e as U,g as V}from"./chunk-XRGPJ3QY.js";import{a as _,b as C,f as y}from"./chunk-VTHXE323.js";var z="#JSAPI_FORM_EXPRESSIONS_MANAGER_GEOMETRY",x=class extends k{constructor(e){super(e),this._fieldReferencesLookup=new Map,this._fieldsAffectedLookup=new Map,this.preserveFieldValuesWhenHidden=!0,this._latestFieldValues=_({},e.feature.attributes)}initialize(){this._dependencyGraph=this._buildDependencyGraph()}destroy(){this.resetExecutors()}get _asyncExecutors(){return this.executors.filter(e=>e.isAsync)}get _baseContext(){let{editType:e,layer:t,map:n,originalFeature:s,spatialReference:i,timeZone:r}=this.arcadeContextInfo,o=t?.type==="scene"&&t.associatedLayer!=null?t.associatedLayer:t;return[{$originalfeature:s,$editcontext:{editType:e},$layer:o,$featureset:o,$datastore:t?.url,$map:n},{rawOutput:!0,spatialReference:i??void 0,timeZone:r}]}set feature(e){this._latestFieldValues=_({},e?.attributes),this._set("feature",e)}evaluateAll(){return this._evaluate(this.executors)}evaluateAsyncExpressions(){return this._evaluate(this._asyncExecutors)}evaluateExpressions(e){return this._evaluate(e)}evaluateInvalidated(e){let{_fieldReferencesLookup:t,_latestFieldValues:n,feature:s}=this,i=new Set;for(let r of e)if(n[r]=s.getAttribute(r),t.has(r))for(let o of t.get(r))i.add(o);return this._evaluate([...i])}evaluateInvalidatedByGeometry(){return y(this,null,function*(){if(this._fieldReferencesLookup.has(z))return this._evaluate([...this._fieldReferencesLookup.get(z)])})}resetExecutors(){for(let e of this.executors)e.reset()}_buildDependencyGraph(){let{_fieldReferencesLookup:e,_fieldsAffectedLookup:t,executors:n,preserveFieldValuesWhenHidden:s}=this,i=new Map(this.fieldInputs.map(a=>[a.name,a])),r=s===!1,o=new Map(n.map(a=>[a,new Array]));for(let a of n){for(let c of a.fieldsUsed){M(e,c,()=>new Set).add(a);let l=i.get(c);[l?.valueExpressionExecutor,l?.editableExpressionExecutor,r?l?.group?.visibilityExpressionExecutor:null,r?l?.visibilityExpressionExecutor:null].filter(d=>d!=null&&d!==a).forEach(d=>{o.get(d).push(a),M(t,d,()=>new Set).add(l)})}a.geometryUsed&&M(e,z,()=>new Set).add(a)}return o}_evaluate(e){return y(this,null,function*(){let t=new Map,{_dependencyGraph:n,_fieldsAffectedLookup:s,_latestFieldValues:i}=this;for(let o of e)Ce(o,t,n);for(let[o,{resolver:a,dependencyPromises:c}]of t)Promise.all(c).then(()=>y(this,null,function*(){let[l,d]=this._makeContext(i);return o.executeAsync(l,d)})).then(()=>{if(s.has(o))for(let l of s.get(o))this._latestFieldValues[l.name]=l.value;a.resolve()},l=>{!l||H(l)||Ie(l)||o.markStale(),a.reject(l)});let r=(yield Promise.allSettled(Array.from(t.values(),({resolver:o})=>o.promise))).filter(o=>o.status==="rejected"&&!(H(o.reason)||Ie(o.reason)));if(r.length>0){let o=new AggregateError(r,`One or more expression executions failed. First error message: ${r[0].reason}`);throw V.getLogger(this).error(o),o}})}_makeContext(e){let[t,n]=this._baseContext,s=this.feature.clone();return s.attributes=e,[C(_({},t),{$feature:s}),n]}get test(){}};u([p()],x.prototype,"_asyncExecutors",null),u([p()],x.prototype,"_baseContext",null),u([p()],x.prototype,"feature",null),u([p({constructOnly:!0})],x.prototype,"preserveFieldValuesWhenHidden",void 0),u([p()],x.prototype,"executors",void 0),u([p()],x.prototype,"fieldInputs",void 0),u([p()],x.prototype,"arcadeContextInfo",void 0),x=u([b("esri.widgets.FeatureForm.FormExpressionsManager")],x);var Ce=(e,t,n)=>{if(t.has(e))return;let s=B();t.set(e,{resolver:s,dependencyPromises:[]}),e.abort();let i=n.get(e);for(let r of i)Ce(r,t,n),t.get(r).dependencyPromises.push(s.promise)},Ie=e=>e&&typeof e=="object"&&"message"in e&&e.message==="Cancelled";var be,Te=Symbol("FormExpressionArcadeExecutor"),m=class extends k{constructor(e){super(e),this[be]=!0,this._lastEvaluatedValue=null,this._abortController=new AbortController,this._initialExecutionComplete=!1,this._stale=!1,this._updatingTracking=new S,this._executeAsyncDebounced=T((t,n,s)=>y(this,null,function*(){let i=yield this.executor.executeAsync(t,C(_({},n),{abortSignal:s}));return s.aborted?this._lastEvaluatedValue:(this._lastEvaluatedValue=i,this._stale=!1,i)}))}get initialExecutionComplete(){return this._initialExecutionComplete}get isAsync(){return this.executor.isAsync}get fieldsUsed(){return this.executor.fieldsUsed}get syntaxTree(){return this.executor.syntaxTree}get updating(){return this._updatingTracking.updating}get stale(){return this._stale}get geometryUsed(){return this.executor.geometryUsed}get variablesUsed(){return this.executor.variablesUsed}get lastEvaluatedValue(){return this._lastEvaluatedValue}abort(){this._abortController.abort()}execute(e,t){this._abortController=new AbortController;let n=this.executor.execute(e,C(_({},t),{abortSignal:this._abortController.signal}));return this._lastEvaluatedValue=n,this._initialExecutionComplete=!0,n}executeAsync(e,t){return y(this,null,function*(){return this._abortController=new AbortController,this._updatingTracking.addPromise(this._executeAsyncDebounced(e,t??{},this._abortController.signal).then(()=>{this._initialExecutionComplete=!0}))})}markStale(){this._stale=!0}reset(){this.abort(),this._lastEvaluatedValue=null,this._stale=!1}};be=Te,u([p()],m.prototype,"_lastEvaluatedValue",void 0),u([p()],m.prototype,"_initialExecutionComplete",void 0),u([p()],m.prototype,"_stale",void 0),u([p()],m.prototype,"_updatingTracking",void 0),u([p({constructOnly:!0})],m.prototype,"executor",void 0),u([p()],m.prototype,"initialExecutionComplete",null),u([p()],m.prototype,"isAsync",null),u([p()],m.prototype,"fieldsUsed",null),u([p()],m.prototype,"syntaxTree",null),u([p()],m.prototype,"updating",null),u([p()],m.prototype,"stale",null),u([p()],m.prototype,"geometryUsed",null),u([p()],m.prototype,"variablesUsed",null),u([p()],m.prototype,"lastEvaluatedValue",null),m=u([b("esri.widgets.support.forms.expressions.FormExpressionArcadeExecutor")],m);var Fe=(e,t)=>y(void 0,null,function*(){let n=ue("form-calculation"),s=yield pe(e,n,{});return t?.fieldsIndex&&(s.fieldsUsed=ae(t.fieldsIndex,s.fieldsUsed)),new m({executor:s})});var J=new re({attributes:{}}),Me={field:["editableExpression","requiredExpression","valueExpression","visibilityExpression"],group:["visibilityExpression"],relationship:["editableExpression","visibilityExpression"],text:["visibilityExpression"],utilityNetworkAssociations:["editableExpression","visibilityExpression"]},ke="#JSAPI_CONTINGENT_VALUE_EMPTY_HASH",F="#JSAPI_CONTINGENT_VALUE_ANY_HASH",Re="#JSAPI_CONTINGENT_VALUE_NULL_HASH",Ve="esri.widgets.FeatureForm.FeatureFormViewModel",we=()=>V.getLogger(Ve),h=class extends X.EsriPromiseMixin(K.EventedAccessor){constructor(e){super(e),this._expressionExecutorsInUse=new Set,this._expressionExecutorLookup=new Map,this._expressionsManager=null,this._contingentValuesCache=null,this._featureClone=J.clone(),this._initialFeature=J.clone(),this._timeZone=null,this._updatingHandles=new S,this.activeAssociation=null,this.arcadeEditType="NA",this.contingencyConstraintViolations=new Map,this.disabled=!1,this.highlightHelper=null,this.inputs=[],this.map=null,this.callbacks=null,this.strict=!1,this.pendingSubtypeChoice=null,this._updateInputs=T(()=>y(this,null,function*(){this._stopExpressions();let{_featureClone:t,_initialFeature:n,arcadeEditType:s,formTemplate:i,inputs:r,layer:o,timeZone:a}=this;if(!o)return;let c={arcadeEditType:s,feature:t,initialFeature:n,layer:o,timeZone:a},l=r.slice(),d=i?.elements&&i.elements.length>0?yield this._updateInputsUsingFormElements(l,i.elements,c):this._updateInputsUsingLayerFields(l,o?.fields,c);this.inputs=d,yield this._startExpressions()}))}initialize(){let e=R(()=>[this.layer,!!this.layer?.loaded,this.formTemplate,this.feature,this.timeZone,this.arcadeEditType],([s,i])=>{s!=null&&(i?this._updatingHandles.addPromise(this._updateInputs()):s.load().catch(()=>{}))},te),t=R(()=>this._arcadeContextInfo,s=>{this._expressionsManager!=null&&(this._expressionsManager.arcadeContextInfo=s,this._updatingHandles.addPromise(this._expressionsManager.evaluateAll().finally(()=>this._afterExpressionsEvaluated())))}),n=R(()=>this.layer,s=>{let i=s?.type==="subtype-sublayer"?s.parent:s?.type==="feature"?s:null;i&&this.addResolvingPromise(ge.createLoadedLayerContingentValuesCache(i).then(r=>{this._contingentValuesCache=r,this.notifyChange("fieldsWithContingentValues")}))},{initial:!0});this.addHandles([e,t,n])}destroy(){this.feature=null,this.layer=null,this._contingentValuesCache=N(this._contingentValuesCache),this.highlightHelper?.removeAll(),this._updatingHandles.destroy()}get _expressionInfosLookup(){return new Map(this.formTemplate?.expressionInfos?.map(e=>[e.name,e]))}get activeAssociationInput(){return this.allAssociationInputs.find(e=>e.uid===this.associationId)}get activeRelationshipInput(){return this.allRelationshipInputs.find(e=>e.relationshipId===this.relationshipId||e.activeCategory||e.showAllEnabled)}get _arcadeContextInfo(){let{_initialFeature:e,arcadeEditType:t,layer:n,map:s,spatialReference:i,timeZone:r}=this;return{layer:le(n)?n:null,originalFeature:e,editType:t,map:s,spatialReference:i,timeZone:r}}get associationId(){return this._get("associationId")}set associationId(e){e==null&&this.activeAssociationInput?.viewModel&&(this.activeAssociationInput.associatedLayer=null,this.activeAssociationInput.viewModel.activeAssociationType=null),this._set("associationId",e)}get associatedLayer(){return this.activeAssociationInput?.associatedLayer}set associatedLayer(e){this.activeAssociationInput&&(this.activeAssociationInput.associatedLayer=e)}get allAssociationInputs(){return me(this.inputs)}get allFieldInputs(){return he(this.inputs)}get allGroupInputs(){return this.inputs.filter(w)}get allRelationshipInputs(){return fe(this.inputs)}get _layerFieldsByName(){return new Map(this.layer?.fields.map(e=>[e.name,e]))}get feature(){return this._get("feature")}set feature(e){let t=this._get("feature");this._featureClone=e?e.clone():J.clone(),this._initialFeature=this._featureClone.clone(),this._expressionsManager&&(this._expressionsManager.feature=this._featureClone),e?(this._resetFieldInputValues(this._featureClone),this.allRelationshipInputs.forEach(n=>n.feature=e)):(this.inputs.forEach(n=>n.destroy()),this.inputs.length=0),t!==e&&(this.pendingSubtypeChoice=null),this.contingencyConstraintViolations.clear(),this._set("feature",e)}get fieldsWithContingentValues(){if(this._contingentValuesCache==null)return new Set;let e=this._contingentValuesCache.fieldGroups.flatMap(t=>t.fields);return new Set(e)}get formTemplate(){return this.layer&&"formTemplate"in this.layer?this.layer.formTemplate:null}set formTemplate(e){e===void 0?this._clearOverride("formTemplate"):this._override("formTemplate",e)}get formDescription(){let{formTemplate:e,layer:t}=this;return e?.description&&t?$({label:e.description,attributes:this.getValues(),fieldsIndex:t.fieldsIndex,timeZone:this.timeZone}):null}get formTitle(){let{formTemplate:e,layer:t}=this;return e?.title&&t?$({label:e.title,attributes:this.getValues(),fieldsIndex:t.fieldsIndex,timeZone:this.timeZone}):null}get formHeaderVisible(){let{activeRelationshipInput:e,activeAssociationInput:t,formDescription:n,formTitle:s}=this;return!(e||t||!n&&!s)}get joinedContingentValues(){return this._joinContingentValues()}get layer(){return this.feature?.sourceLayer&&"applyEdits"in this.feature.sourceLayer?this.feature.sourceLayer:null}set layer(e){this._override("layer",e)}get relationshipId(){return this._get("relationshipId")}set relationshipId(e){let t=this.allRelationshipInputs;if(e!=null&&e===this.relationshipId||t.forEach(n=>{n.showAllEnabled=!1,n.activeCategory=null}),e!=null){let n=t.find(s=>s.relationshipId===e);n&&(n.showAllEnabled=!0)}this._set("relationshipId",e)}get spatialReference(){return this.layer?.spatialReference??null}set spatialReference(e){this._override("spatialReference",e)}get state(){return this.layer?.loaded?"ready":"disabled"}get submittable(){return!!this.valid||this.allFieldInputs.filter(e=>!e.valid).every(({submittable:e})=>e)}get timeZone(){let{layer:e}=this;if(e&&"datesInUnknownTimezone"in e&&e.datesInUnknownTimezone)return Z;let t=e&&"preferredTimeZone"in e&&e.preferredTimeZone;return this._timeZone===q?t||Z:this._timeZone||Y}set timeZone(e){this._timeZone=e}get updating(){return this._updatingHandles.updating}get valid(){let e=this.allFieldInputs;return e.length>0&&e.every(({valid:t})=>t)}findField(e){return this.allFieldInputs.find(t=>t.name===e)}getFieldValueOptionsForField(e,t){let n=this.findField(e);if(!n)return[[],[],[]];let s=n.domain?.type==="coded-value"?n.domain.codedValues.map(({name:o,code:a})=>({name:o,value:a})):[],i=n.value==null||s.some(o=>o.value===n.value)?[]:[{name:`${n.value}`,value:n.value}],r=this.fieldsWithContingentValues.has(e)?this._getContingentValueOptionsForField(e,t):[];if(r.length>0){let o=new Set(r.map(a=>a.value));return[r,s.filter(a=>!o.has(a.value)),i]}return[s,[],i]}getValue(e){let t=this.layer?.getField(e);if(t!=null)return this._featureClone.getAttribute(t.name)??null}setValue(e,t){let{_featureClone:n,strict:s}=this,i=this.findField(e);t=t===""?null:t,i&&n.getAttribute(e)!==t&&(i.value=t,s&&!i.valid||(this._afterValueChange(i),this._expressionsManager!=null&&this._updatingHandles.addPromise(this._expressionsManager.evaluateInvalidated([i.name]).finally(()=>this._afterExpressionsEvaluated()))))}getValues(){return _({},this._featureClone.attributes)}overrideInitialFeature(e){this._initialFeature=e}submit(){let e=this.allFieldInputs,t=new Set(e.filter(i=>i.valid).map(({name:i})=>i)),n=e.filter(i=>!i.valid).map(({name:i})=>i),s=this.getValues();if(this.validateContingencyConstraints(s,{includeIncompleteViolations:!0}).length>0)for(let[i,r]of this.contingencyConstraintViolations.entries())r.type==="error"&&(t.delete(i),n.push(i));this.notifyChange("submittable"),this.notifyChange("valid"),this.emit("submit",{valid:[...t],invalid:n,values:s})}validateContingencyConstraints(e,t){let{_contingentValuesCache:n}=this,s=new Map;if(this.contingencyConstraintViolations=s,n==null)return[];let{invalid:i,incomplete:r}=n.validateContingencyConstraints(e),o=[...i,...t?.includeIncompleteViolations?r:[]];for(let a of o)for(let c of a.fieldGroup.fields)s.set(c,a);return o}notifyFeatureGeometryChanged(){let{_expressionsManager:e,feature:t,_featureClone:n}=this;t&&(n.geometry=t.geometry,e!=null&&this._updatingHandles.addPromise(e.evaluateInvalidatedByGeometry().finally(()=>this._afterExpressionsEvaluated())))}applySubtypeDefaults(e){let{defaultValues:t}=e,{allFieldInputs:n}=this;for(let{name:s}of n){let i=t[s];i!=null&&this.setValue(s,i)}}_emitChangeEvent({name:e,valid:t,value:n}){this.emit("value-change",{layer:this.layer,feature:this.feature,fieldName:e,value:n,valid:t})}_updateInputsUsingFormElements(e,t,n){return y(this,null,function*(){let s=new Map;for(let o of e)if(w(o)){s.set(o.element,o);for(let a of o.inputs)a.element&&s.set(a.element,a)}else o.element&&s.set(o.element,o);let i=new Map,r=yield this._updateInputsUsingFormElementsRecursive({existingInputsByElement:s,updatedElements:t.filter(Ae),sharedInitializationProperties:n,group:null,newExpressionExecutorPromises:i});for(let[o,a]of s.entries())s.delete(o),a.destroy();return yield Promise.all(Array.from(i.values())),r})}_updateInputsUsingFormElementsRecursive(e){return y(this,null,function*(){let{existingInputsByElement:t,updatedElements:n,sharedInitializationProperties:s,group:i,newExpressionExecutorPromises:r}=e,o=[];for(let a of n){let c=t.has(a),l=c?t.get(a):this._makeInputFromElement(a,s,i);if(l){if(o.push(l),yield ee(()=>!l.updating),this._assignExpressionExecutors(l,a,r),c)if(t.delete(a),w(l)){let{feature:d,timeZone:f}=s;l.set({feature:d,timeZone:f})}else if(O(l)){let d=this.relationshipId===a.relationshipId;l.set(s),l.set({map:this.map,showAllEnabled:d})}else L(l)?(l.set(s),l.set({map:this.map})):l.set(s);if(P(a)){let d=a.elements.filter(f=>Ae(f));l.inputs=yield this._updateInputsUsingFormElementsRecursive({existingInputsByElement:t,updatedElements:d,sharedInitializationProperties:s,group:l,newExpressionExecutorPromises:r})}}}return o})}_updateInputsUsingLayerFields(e,t,n){if(!Array.isArray(t))return we().warn(this.declaredClass,"No attribute fields found."),[];let s=new Map;for(let r of e)if(w(r)){for(let o of r.inputs)o.destroy();r.inputs.length=0,r.destroy()}else O(r)?r.destroy():ce(r)&&(r.element!==null?r.destroy():s.set(r.field,r));let i=[];for(let r of t){let o=n.feature?.getAttribute(r.name)??null,a=s.get(r)??new D({field:r,preservesValueWhenHidden:this.formTemplate?.preserveFieldValuesWhenHidden});i.push(a.set(C(_({},n),{value:o}))),s.delete(r)}for(let[r,o]of s.entries())s.delete(r),o.destroy();return i}_resetFieldInputValues(e){for(let t of this.allFieldInputs)t.value=e.getAttribute(t.name)}_makeInputFromElement(e,t,n){return P(e)?Se(e,t):se(e)?this._makeFieldInputFromElement(e,t,n):ie(e)?this._makeRelationshipInputFromElement(e,t,n):L(e)?this._makeUtilityNetworkAssociationInputFromElement(e,t,n):ne(e)?Le(e,t):L(e)?this._makeUtilityNetworkAssociationInputFromElement(e,t,n):void 0}_makeFieldInputFromElement(e,t,n){let{arcadeEditType:s,feature:i,initialFeature:r,layer:o,timeZone:a}=t,{fieldName:c}=e,l=c&&this._layerFieldsByName.get(c);return l?new D({arcadeEditType:s,element:e,field:l,value:i?.getAttribute(e.fieldName)??null,feature:i,initialFeature:r,layer:o,group:n,preservesValueWhenHidden:this.formTemplate?.preserveFieldValuesWhenHidden,timeZone:a}):null}_makeRelationshipInputFromElement(e,t,n=null){let{map:s}=this,{feature:i,layer:r,timeZone:o}=t,a=new xe({element:e,feature:i,group:n,layer:r,map:s,timeZone:o});return a.addHandles(Q(()=>a.relatedLayer,"edits",()=>this._expressionsManager?.evaluateAsyncExpressions())),a}_makeUtilityNetworkAssociationInputFromElement(e,t,n=null){let{map:s}=this,{feature:i,layer:r,timeZone:o}=t;return new Ee({element:e,feature:i,group:n,layer:r,map:s,timeZone:o})}_assignExpressionExecutors(e,t,n){let s=Me[t.type],i=[];for(let r of s){let o=`${r}Executor`;if(e[o]){this._useExecutor(e[o]);continue}let a=t[r];if(a!=null&&a!==""){let c=this._expressionInfosLookup.get(a)?.expression??a;i.push(this._getOrCreateExecutorForExpression(c,n).then(l=>{e[o]=this._useExecutor(l)}))}}return de(e)&&i.push(...this._assignTextElementExpressionExecutors(e,n)),i}_assignTextElementExpressionExecutors(e,t){let{_expressionInfosLookup:n}=this,s=[];for(let i of e.expressionsUsed){let r=n.get(i);r!=null?s.push(this._getOrCreateExecutorForExpression(r.expression,t).then(o=>e.setExpressionExecutor(i,this._useExecutor(o)))):V.getLogger(this).error("feature-form:expression-not-found",`Could not find expressionInfo object with name '${i}'`)}for(let i of e.fieldsUsed){let r=`return $feature['${i}'];`;s.push(this._getOrCreateExecutorForExpression(r,t).then(o=>e.setFieldExecutor(i,this._useExecutor(o))))}return s}_getOrCreateExecutorForExpression(e,t){return y(this,null,function*(){let{_expressionExecutorLookup:n}=this;if(n.has(e))return n.get(e);if(t.has(e))return t.get(e);let s=Fe(e,this.layer);t.set(e,s);let i=yield s;return n.set(e,i),i})}_createExpressionsManager(e){let{_arcadeContextInfo:t,_featureClone:n,allFieldInputs:s,formTemplate:i}=this;this._expressionsManager=new x({executors:e,feature:n,arcadeContextInfo:t,fieldInputs:s,preserveFieldValuesWhenHidden:i?.preserveFieldValuesWhenHidden===!0})}_startExpressions(){return y(this,null,function*(){if(this._expressionExecutorsInUse.size===0)return;let e=Array.from(this._expressionExecutorsInUse);this._createExpressionsManager(e),yield this._expressionsManager.evaluateAll().finally(()=>this._afterExpressionsEvaluated())})}_stopExpressions(){this._expressionsManager=N(this._expressionsManager),this._expressionExecutorsInUse.clear()}_useExecutor(e){return this._expressionExecutorsInUse.add(e),e}_afterValueChange(e){let{name:t,value:n}=e,{_featureClone:s,formTemplate:i,layer:r}=this;if(!r)return;let o=s.getAttribute(t);s.setAttribute(t,n);let{typeFieldName:a,types:c}=G(r);if((e.isSubtypeField||t===a)&&n!==o){if(r.type==="subtype-sublayer"){let d=r.parent?.findSublayerForFeature(s);d&&(this.feature&&(this.feature.sourceLayer=d),s.sourceLayer=d)}let l=new Set;for(let d of c)if(d.domains&&typeof d.domains=="object")for(let f of Object.keys(d.domains))l.add(f);for(let d of l){let f=this.findField(d);f&&f.notifyChange("domain")}this.notifyChange("joinedContingentValues")}if(i!=null){let{description:l,title:d}=i;d&&U(d,t)&&this.notifyChange("formTitle"),l&&U(l,t)&&this.notifyChange("formDescription")}this._emitChangeEvent(e)}_afterExpressionsEvaluated(){let{_featureClone:e}=this;for(let t of this.allFieldInputs)t.value!==e.getAttribute(t.name)&&this._afterValueChange(t)}_joinContingentValues(){let e=this._contingentValuesCache;if(e==null)return[];let{typeFieldName:t}=G(this.layer),n=t?this.getValue(t):null,s=[];for(let o of e.fieldGroups){let{contingencies:a,fields:c,name:l}=o,d=[];for(let f of a)f.isRetired||f.subtype!=null&&f.subtype.code!==n||d.push({values:f.values});d.length>0&&s.push({name:l,fields:c,contingencies:d})}let[i,r]=this._generateJoinPlan(s);return[...i.flatMap(o=>this._joinFieldGroupContingencies(o)),...r.flatMap(o=>o.contingencies)]}_generateJoinPlan(e){let t=new Map,n=[],s=new Set;for(let c of e)for(let l of c.fields)if(t.has(l)){let d=t.get(l),f=c,g=[d.name,f.name].sort().join("|");if(s.has(g))continue;n.push([d,f]),s.add(g),t.set(l,f)}else t.set(l,c);let i=new Set(n.flat()),r=new Set(e);for(let c of i)r.delete(c);let o=new Map,a=new Map;for(let c of new Set(n.flat())){let l=Symbol(c.name);o.set(l,new Set([c])),a.set(c,l)}for(let[c,l]of n){let d=a.get(c),f=a.get(l);if(d===f)continue;let g=o.get(d),v=o.get(f);for(let E of v)g.add(E),a.set(E,d);o.delete(f)}return[[...o.values()].map(c=>[...c]),[...r]]}_joinFieldGroupContingencies(e){let t=e.slice(),n=t.shift(),s=t.shift(),i=this._generateJoinKey(n.fields,s.fields),r=new Set([...n.fields,...s.fields]),o=new Map;for(let c of n.contingencies){let[l]=this._hashContingency(c,i.codedValueFields,!0);o.has(l)?o.get(l)?.push(c):o.set(l,[c])}for(;t.length>0;){let c=new Map,l=t.shift(),d=this._generateJoinKey(r,l.fields);for(let f of s.contingencies){let[g,v]=this._hashContingency(f,i.codedValueFields),E=v?this._findMatchingContingenciesWithAnyHashMask(o,g):o.get(g);if(o.has(F)&&E?.push(...this._findMatchingContingenciesContainingAny(f,o.get(F),i.codedValueFields)),E!=null)for(let A of E){let I=i.rangeFields.length>0?this._joinContingenciesWithRangeDomains(A,f,i.rangeFields):this._joinContingencies(A,f);if(I==null)break;let[j]=this._hashContingency(I,d.codedValueFields,!0);c.has(j)?c.get(j)?.push(I):c.set(j,[I])}}o=c,s=l,i=d,r=new Set([...r,...s.fields])}let a=[];for(let c of s.contingencies){let[l,d]=this._hashContingency(c,i.codedValueFields),f=d?this._findMatchingContingenciesWithAnyHashMask(o,l):o.get(l);if(o.has(F)&&f.push(...this._findMatchingContingenciesContainingAny(c,o.get(F),i.codedValueFields)),f!=null)for(let g of f){let v=i.rangeFields.length>0?this._joinContingenciesWithRangeDomains(g,c,i.rangeFields):this._joinContingencies(g,c);v!=null&&a.push(v)}}return a}_joinContingencies(e,t){let n={values:_(_({},e.values),t.values)};for(let[s,i]of Object.entries(n.values))i.objectType==="any"&&e.values[s]!=null&&(n.values[s]=e.values[s]);return n}_joinContingenciesWithRangeDomains(e,t,n){let s=this._joinContingencies(e,t);for(let i of n){let r=e.values[i],o=t.values[i],{leftIsNull:a,rightIsNull:c,bothAreNull:l,leftIsAny:d,rightIsAny:f,bothAreAny:g,leftIsRange:v,rightIsRange:E}=this._compareObjectTypes(r.objectType,o.objectType);if(l||g)continue;if(a&&f||c&&d){s.values[i]=new W({objectType:"null"});continue}if(a&&E||c&&v)return null;d?(r.minValue=-1/0,r.maxValue=1/0):f&&(o.minValue=-1/0,o.maxValue=1/0);let A=Math.max(r.minValue,o.minValue),I=Math.min(r.maxValue,o.maxValue);if(A>I)return null;s.values[i]=new W({objectType:"range",minValue:A,maxValue:I})}return s}_findMatchingContingenciesContainingAny(e,t,n){return t.filter(s=>n.every(i=>{let r=s.values[i],o=e.values[i];return r.objectType==="any"||o.objectType==="any"||r.codedValue?.code===o.codedValue?.code}))}_findMatchingContingenciesWithAnyHashMask(e,t){let n=RegExp(`${t}$`),s=[];for(let[i,r]of e){if(i===F)break;n.test(i)&&s.push(...r)}return s}_generateJoinKey(e,t){let n=Array.isArray(e)?new Set(e):e,s=Array.isArray(t)?new Set(t):t,i=n.size<s.size?n:s,r=i===n?s:n,{feature:o}=this,a=new Set,c=new Set;for(let l of i)if(r.has(l)){let d=this.layer?.getFieldDomain(l,{feature:o??void 0,excludeImpliedDomains:!0});if(d==null)continue;switch(d.type){case"coded-value":a.add(l);break;case"range":c.add(l)}}return{codedValueFields:[...a],rangeFields:[...c]}}_contingencyIsValid(e,t){let n={};for(let{name:s,value:i}of this.allFieldInputs)this.fieldsWithContingentValues.has(s)&&i!=null&&s!==e&&(n[s]=i);return Object.entries(n).every(([s,i])=>!t.values.hasOwnProperty(s)||ye(i,t.values[s]))}_getContingentValueOptionsForField(e,t){let n=this.joinedContingentValues.slice(),s=new Map,i={code:"",name:t??"No value"};for(let r of n){let o=r.values[e];if(o?.objectType==="code"||o?.objectType==="null"){let{code:a,name:c}=o.codedValue&&o.objectType!=="null"?o.codedValue:i;!s.has(a)&&this._contingencyIsValid(e,r)&&s.set(a,{name:c,value:a})}}return[...s.values()]}_hashContingency(e,t,n=!1){if(t.length<1)return[ke,!1];let s=[],i=!1;for(let r of t){let o=e.values[r];if(o.objectType==="any"){if(n)return[F,!0];i=!0,s.push(`${r}:.*`)}else o.objectType==="null"?s.push(`${r}:${Re}`):s.push(`${r}:${o.codedValue?.code}`)}return[s.sort().join("&"),i]}_compareObjectTypes(e,t){return{leftIsNull:e==="null",rightIsNull:t==="null",bothAreNull:e==="null"&&t==="null",leftIsAny:e==="any",rightIsAny:t==="any",bothAreAny:e==="any"&&t==="any",leftIsRange:e==="range",rightIsRange:t==="range"}}get test(){return{featureClone:this._featureClone}}};function Ae(e){return e.type==="field"||e.type==="group"||e.type==="relationship"||e.type==="text"||e.type==="utilityNetworkAssociations"||(we().warn("form-info::unsupported-element-type","Only element types 'field', 'group' and 'relationship' are supported",`Element ${e.label} has unsupported type '${e.type}'`),!1)}function Se(e,t){let{feature:n,layer:s}=t;return new _e({element:e,inputs:[],feature:n,layer:s})}function Le(e,t,n=null){let{feature:s,layer:i,timeZone:r}=t;return new ve({element:e,feature:s,group:n,layer:i,timeZone:r})}u([p()],h.prototype,"_expressionInfosLookup",null),u([p()],h.prototype,"_featureClone",void 0),u([p()],h.prototype,"_timeZone",void 0),u([p()],h.prototype,"activeAssociation",void 0),u([p()],h.prototype,"activeAssociationInput",null),u([p()],h.prototype,"activeRelationshipInput",null),u([p()],h.prototype,"_arcadeContextInfo",null),u([p()],h.prototype,"associationId",null),u([p()],h.prototype,"associatedLayer",null),u([p()],h.prototype,"allAssociationInputs",null),u([p()],h.prototype,"allFieldInputs",null),u([p()],h.prototype,"allGroupInputs",null),u([p()],h.prototype,"allRelationshipInputs",null),u([p()],h.prototype,"_layerFieldsByName",null),u([p()],h.prototype,"arcadeEditType",void 0),u([p()],h.prototype,"contingencyConstraintViolations",void 0),u([p()],h.prototype,"disabled",void 0),u([p()],h.prototype,"feature",null),u([p()],h.prototype,"fieldsWithContingentValues",null),u([p({type:oe})],h.prototype,"formTemplate",null),u([p()],h.prototype,"formDescription",null),u([p()],h.prototype,"formTitle",null),u([p()],h.prototype,"formHeaderVisible",null),u([p()],h.prototype,"highlightHelper",void 0),u([p()],h.prototype,"inputs",void 0),u([p()],h.prototype,"joinedContingentValues",null),u([p()],h.prototype,"layer",null),u([p()],h.prototype,"map",void 0),u([p()],h.prototype,"callbacks",void 0),u([p()],h.prototype,"relationshipId",null),u([p()],h.prototype,"spatialReference",null),u([p()],h.prototype,"state",null),u([p()],h.prototype,"strict",void 0),u([p()],h.prototype,"submittable",null),u([p()],h.prototype,"timeZone",null),u([p()],h.prototype,"updating",null),u([p()],h.prototype,"valid",null),u([p()],h.prototype,"pendingSubtypeChoice",void 0),u([p()],h.prototype,"getValues",null),u([p()],h.prototype,"submit",null),u([p()],h.prototype,"test",null),h=u([b(Ve)],h);var Ut=h;export{Ut as a};
