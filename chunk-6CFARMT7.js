import{a as Zi}from"./chunk-JHKHLDGA.js";import{a as ae,c as it,d as st,z as Yi}from"./chunk-6MLWKKU3.js";import{a as Ki}from"./chunk-SCX5V5ZM.js";import{a as Qi}from"./chunk-VS266ZEX.js";import{a as Vt}from"./chunk-2JW3DUYT.js";import{a as Xi}from"./chunk-5MQCBXNU.js";import{c as ke}from"./chunk-XYAS56YV.js";import{a as _t,f as Ni}from"./chunk-DFZB6AM2.js";import{a as Ji,c as $i}from"./chunk-FJ7K6WNN.js";import"./chunk-GEYV2JMR.js";import"./chunk-IGGGB3TP.js";import"./chunk-JDU4SWWX.js";import"./chunk-HMOFKUIJ.js";import"./chunk-C5TDOKQP.js";import"./chunk-QGGZ7JI7.js";import"./chunk-EMILT3E5.js";import"./chunk-5KY2RG7F.js";import"./chunk-XQ4DD6H6.js";import"./chunk-E3FPV7ZA.js";import"./chunk-IQA3CVAZ.js";import"./chunk-2DH3L3DZ.js";import"./chunk-GPMOZK2F.js";import{d as Pi,h as Fi}from"./chunk-CHALI33A.js";import"./chunk-D4ULQQN7.js";import"./chunk-NTU4GX2J.js";import"./chunk-XHCZWFY2.js";import{a as Bi}from"./chunk-JHVSXE55.js";import{a as Li}from"./chunk-XOJOMNES.js";import"./chunk-TTZ4CWZW.js";import"./chunk-EB24NRSQ.js";import"./chunk-4JIR4MZV.js";import"./chunk-ZO3S2OWI.js";import{a as Wi,b as Gi,c as qi}from"./chunk-IJETEJ35.js";import{a as Ii}from"./chunk-QC7YKF4H.js";import{a as _e,d as xi,h as Hi,i as zi,l as re}from"./chunk-RGD6ZU25.js";import"./chunk-NRFDPN3W.js";import{a as Re,c as ki,f as tt,k as ji}from"./chunk-XGBN53IG.js";import"./chunk-KVIHP5QH.js";import{b as ge}from"./chunk-62UTK67Z.js";import{b as Ui}from"./chunk-63BBKXWS.js";import{a as et}from"./chunk-SLOUGIU5.js";import"./chunk-RK73WDNW.js";import"./chunk-C24MSACP.js";import"./chunk-Y533SYIC.js";import"./chunk-SCVJO5X3.js";import"./chunk-AIPTYQTX.js";import"./chunk-INIILA7E.js";import"./chunk-YLC7GOFS.js";import"./chunk-KCIAXQ4S.js";import"./chunk-BONXCVQE.js";import"./chunk-DKDKCWEH.js";import"./chunk-PI27WDVR.js";import"./chunk-IXA5GG5W.js";import"./chunk-PIIZWXGF.js";import"./chunk-N3W77OHB.js";import"./chunk-CJXY7S42.js";import{a as Ei}from"./chunk-HOMK53AL.js";import{l as Ri}from"./chunk-2BJHWKO6.js";import"./chunk-Q5KIWWVU.js";import{a as Oi}from"./chunk-3Y3IWJBE.js";import{b as Di,c as we}from"./chunk-IHEDDQC4.js";import{a as Ci}from"./chunk-W3HCXOXG.js";import"./chunk-AN3DAG6F.js";import"./chunk-K5FFS5P4.js";import"./chunk-3NS6RWJD.js";import{d as Ai}from"./chunk-6ZTUPVYX.js";import"./chunk-5DVGZXEZ.js";import"./chunk-2I3LIA7G.js";import"./chunk-QIO7OVOF.js";import"./chunk-J3QLC2LP.js";import"./chunk-VBFF4VHB.js";import"./chunk-Q2IUY7EW.js";import"./chunk-6HINJY73.js";import"./chunk-WQKVID54.js";import"./chunk-DBCWR6HP.js";import"./chunk-GUIIGAD3.js";import"./chunk-SFSN6ZUK.js";import{a as Ti}from"./chunk-L6LNCKFB.js";import{b as yi,d as Si}from"./chunk-QGBXTIEK.js";import{b as Mi}from"./chunk-XAJ5ULUR.js";import"./chunk-MIJLPOZZ.js";import"./chunk-QBDGQCUP.js";import"./chunk-NOHUHVCW.js";import{a as bi,d as gt}from"./chunk-H2NTHPNN.js";import"./chunk-Z7TBAZRW.js";import"./chunk-5H7NDIGP.js";import"./chunk-KJFE7WVE.js";import"./chunk-ZYYN4NWF.js";import"./chunk-MRKUOXYW.js";import"./chunk-CL7L227X.js";import"./chunk-2GLWK7ZW.js";import{d as gi,l as wt,n as _i,o as Vi}from"./chunk-QXSQOLB3.js";import{b as mi}from"./chunk-BKWQOCBC.js";import"./chunk-XACQ2RJ5.js";import"./chunk-LCFWGHLF.js";import"./chunk-CX3G2QWN.js";import"./chunk-YTAJKLRN.js";import"./chunk-D6N4VI5S.js";import"./chunk-5YS73I3T.js";import{b as ni}from"./chunk-3ZJ4NMBE.js";import"./chunk-4S7THJAS.js";import{c as wi}from"./chunk-2XTO2IAR.js";import"./chunk-CQVHC5U2.js";import"./chunk-P7MVFIZJ.js";import"./chunk-FSW536RM.js";import"./chunk-VN5FPMRB.js";import"./chunk-N7DSOI7B.js";import"./chunk-F4HA2HQL.js";import"./chunk-DQZHSTUF.js";import"./chunk-CY62WWD7.js";import"./chunk-VDNRZCIE.js";import{a as fi,b as vi}from"./chunk-I2JD5OSI.js";import"./chunk-2MROBW6T.js";import"./chunk-QAHTJVUZ.js";import"./chunk-XE4T4457.js";import"./chunk-BWHHYBB5.js";import"./chunk-XWEUR6F7.js";import"./chunk-PSNQ2KG3.js";import{e as oi}from"./chunk-MPI26GZ3.js";import"./chunk-X5NPIY3C.js";import"./chunk-5252J253.js";import{a as ft,b as vt}from"./chunk-7WCQBAQY.js";import"./chunk-VQSLKKYN.js";import"./chunk-JBAMJB5J.js";import"./chunk-VAOSSSLB.js";import"./chunk-AMISFAT3.js";import"./chunk-CUV3BSEW.js";import"./chunk-3ZJU5D2H.js";import"./chunk-2UHZH5L3.js";import"./chunk-DQINVX66.js";import"./chunk-CSFAHB4Y.js";import{a as li,b as pi}from"./chunk-T5UBLAP4.js";import"./chunk-PTXLSCMJ.js";import{g as hi,l as ci,m as di}from"./chunk-DA3NC6W4.js";import"./chunk-6L543SC5.js";import"./chunk-FRN24G7D.js";import"./chunk-FGABE2LC.js";import"./chunk-CU7FHMWW.js";import"./chunk-CZMBPC27.js";import"./chunk-VANM5A4M.js";import"./chunk-VSD74FMI.js";import"./chunk-KALTBP5D.js";import"./chunk-O2J7LFYY.js";import"./chunk-BIU7ZFAB.js";import"./chunk-6FZTFPIH.js";import{j as J}from"./chunk-J5AEP4US.js";import"./chunk-YHRLMRSO.js";import"./chunk-KPT44MCK.js";import"./chunk-XKFJ6GWH.js";import"./chunk-SFANISLX.js";import"./chunk-UJ7KVQR6.js";import"./chunk-GSXOR3JU.js";import"./chunk-55OTJIMU.js";import"./chunk-EM2AEAFS.js";import"./chunk-YEPHAEAY.js";import"./chunk-TK4PPGQL.js";import"./chunk-ELCBU4NP.js";import"./chunk-GMZFCQJQ.js";import"./chunk-5WDH2LXO.js";import"./chunk-L7NOU4T2.js";import"./chunk-VGAXEXH3.js";import"./chunk-HMNTGQTR.js";import"./chunk-ZLIWNUFM.js";import"./chunk-GVSOJUIP.js";import"./chunk-GWSX6PRO.js";import{d as Ie}from"./chunk-G2JMPZCN.js";import{a as ui}from"./chunk-IRQF7UTO.js";import{b as $e}from"./chunk-3KOZOOEP.js";import"./chunk-EG2DTURK.js";import"./chunk-YVCKQBWT.js";import"./chunk-WOZSH7YY.js";import"./chunk-2PJRHNJW.js";import"./chunk-B2RVSTL3.js";import"./chunk-4XEE5PE3.js";import"./chunk-2CKJLDTO.js";import"./chunk-F6TN7E7K.js";import"./chunk-4LDVFWME.js";import"./chunk-HUUJBVXR.js";import"./chunk-7G56KLCZ.js";import"./chunk-L56OBJFS.js";import"./chunk-7HMNN4FJ.js";import"./chunk-UKAGN54W.js";import"./chunk-342NGUMP.js";import"./chunk-NIYDRLW4.js";import"./chunk-PHMJ7KPL.js";import"./chunk-ESSDCWGF.js";import"./chunk-WVKBXQWE.js";import"./chunk-FSWSNKJD.js";import"./chunk-FGEB67EG.js";import"./chunk-YEXMIDOT.js";import"./chunk-T7PUQGWM.js";import"./chunk-GV3ZFCVD.js";import"./chunk-SOEEM7Z7.js";import"./chunk-MVDZB4AK.js";import"./chunk-44A27HB7.js";import"./chunk-47NSYSFY.js";import"./chunk-QXNVQZT7.js";import{e as ai}from"./chunk-QSQIQSC6.js";import{f as ri}from"./chunk-AYNBEMCC.js";import"./chunk-LNYBTIG7.js";import"./chunk-VYZHOYXV.js";import"./chunk-ECA5I2I7.js";import"./chunk-XAHD7XBV.js";import"./chunk-Y7XRSFOZ.js";import{b as si}from"./chunk-YQNUGDFH.js";import{b as ii}from"./chunk-QCZ3ZIGQ.js";import{e as Ye,j as Ze,x as ti}from"./chunk-7SDNM7YV.js";import"./chunk-4NUW747S.js";import"./chunk-T6WMVIUG.js";import{a as Je,c as mt}from"./chunk-ONYJLWAD.js";import"./chunk-UBEQHTGJ.js";import"./chunk-PHODKV66.js";import"./chunk-JPMGMA4B.js";import"./chunk-ZM24RY22.js";import"./chunk-LAX5536Z.js";import"./chunk-N3HRYLNW.js";import"./chunk-4DBMALZW.js";import"./chunk-CVWWHM2V.js";import"./chunk-6OQYVEQJ.js";import"./chunk-YOXOWGT6.js";import"./chunk-EFZOSMYP.js";import"./chunk-WI7F4ZKJ.js";import"./chunk-MJ7M24NH.js";import"./chunk-GJH4QFRX.js";import"./chunk-T63F7663.js";import"./chunk-O4V2VBSK.js";import"./chunk-5TKRKB5E.js";import"./chunk-XAGMDNNR.js";import"./chunk-OP2TLIUN.js";import"./chunk-T2THIR6K.js";import"./chunk-LORHDXEB.js";import"./chunk-BBBPJI4H.js";import"./chunk-45BTW5EG.js";import"./chunk-TPFBHGDM.js";import"./chunk-73NLRHJD.js";import"./chunk-PNFEUBDF.js";import"./chunk-6RCCEJDL.js";import"./chunk-PQ2TNDUX.js";import"./chunk-6X6MKRQ3.js";import"./chunk-FQFHMHYU.js";import"./chunk-SZMEI3WL.js";import"./chunk-KKVGD67U.js";import"./chunk-MYOJWRDU.js";import"./chunk-L7UKJKHG.js";import"./chunk-V2IENAEU.js";import"./chunk-QAGQFNF2.js";import"./chunk-SY7JS2VW.js";import"./chunk-WK57SDN6.js";import"./chunk-AG4V3ZUO.js";import"./chunk-YWLMJ26A.js";import"./chunk-QAWNU3UJ.js";import"./chunk-HRQT4R6X.js";import"./chunk-44BHLWQ4.js";import"./chunk-5BPM64SU.js";import"./chunk-PMVHHMQJ.js";import"./chunk-NAFOM5UA.js";import"./chunk-DO7UF2F2.js";import"./chunk-ZTR6OS44.js";import"./chunk-VRTKAD2J.js";import"./chunk-DBLKLHK2.js";import"./chunk-UTE3ASAZ.js";import"./chunk-2AFEAPEX.js";import"./chunk-GNGXUEWV.js";import"./chunk-QBI5NDCA.js";import"./chunk-NOHW2DKR.js";import"./chunk-HVJAAM3A.js";import"./chunk-ACPEJEHK.js";import"./chunk-I7B3LWNP.js";import"./chunk-YP2E5N4E.js";import"./chunk-QLMNLSCT.js";import"./chunk-P55G5ATK.js";import"./chunk-JT3K52KQ.js";import"./chunk-SPLEGG4R.js";import"./chunk-Y4TJDUGP.js";import"./chunk-6PAFOJ4W.js";import"./chunk-74SDGE57.js";import"./chunk-FRXWHX3T.js";import"./chunk-DTDQ5X42.js";import"./chunk-RX2HFR4X.js";import"./chunk-AZW7YPTQ.js";import"./chunk-NJLJX4X6.js";import"./chunk-DZHFTD24.js";import"./chunk-K57Z4J34.js";import"./chunk-VWG3KVOU.js";import"./chunk-JOEUVLAN.js";import"./chunk-JZQDGIDQ.js";import"./chunk-CZ6CGC7I.js";import"./chunk-7B6U3N62.js";import"./chunk-46WDO5LS.js";import"./chunk-G5EYK5KM.js";import"./chunk-YJKJQU3F.js";import"./chunk-OK4K3OQT.js";import"./chunk-BPWNCOXC.js";import"./chunk-VNS4CQ27.js";import"./chunk-AVMO6LCR.js";import"./chunk-TEGPMVWT.js";import"./chunk-CLQRQC3Y.js";import"./chunk-KSNU73LO.js";import"./chunk-FACEVGRE.js";import"./chunk-5XTCPT52.js";import"./chunk-F2BQ2GD6.js";import"./chunk-R3XLNYYB.js";import"./chunk-BMYVPMAK.js";import{a as N}from"./chunk-6F25LG6O.js";import"./chunk-XLL67PCY.js";import"./chunk-MCO7DSFO.js";import"./chunk-IIROCMOY.js";import"./chunk-5LG2P6MT.js";import"./chunk-GJ2QRXGN.js";import"./chunk-6QXEFK4U.js";import"./chunk-5L2EJ5RT.js";import"./chunk-S52JRLJC.js";import"./chunk-E2QKN2KY.js";import{a as Le}from"./chunk-PDQQY7RQ.js";import"./chunk-W5OI4BJ2.js";import{a as ei}from"./chunk-RWCIDBNQ.js";import"./chunk-2NH7HOKA.js";import"./chunk-EM35R6FY.js";import{a as ut}from"./chunk-HM5RIVQC.js";import"./chunk-HKJZ7WI6.js";import"./chunk-CXOFHVIF.js";import"./chunk-EO2H4LIH.js";import"./chunk-DJW5LMRG.js";import"./chunk-DMO5HQM3.js";import"./chunk-DEH76MSI.js";import{a as _}from"./chunk-ALWV3RJ2.js";import"./chunk-2ZFXOJDB.js";import"./chunk-QXXXCEV5.js";import{C as ye,D as $t,G as R,J as de,b as j,c as G,d as q,n as I,o as Zt,p as pt,s as De,u as se,v as ce,w as Jt,y as U}from"./chunk-6B5XFA6F.js";import"./chunk-PUVSV35R.js";import"./chunk-FCWOKKZM.js";import"./chunk-3JGYBNJA.js";import{b as Qt,o as Kt,q as Yt}from"./chunk-DA3SDKGO.js";import"./chunk-ZOEPYNM4.js";import"./chunk-57VFBGF3.js";import"./chunk-GWBRHLNH.js";import"./chunk-BJH4F4SM.js";import"./chunk-Z3RBZHAK.js";import{a as Xt,e as dt}from"./chunk-PTZYZULI.js";import"./chunk-NMLYCCKN.js";import"./chunk-ZC6EBRE4.js";import"./chunk-KALOJIUA.js";import"./chunk-KMMTNF7G.js";import"./chunk-MIS6QMFE.js";import"./chunk-MDZTV2VL.js";import"./chunk-RNC4P66O.js";import"./chunk-7LHOQXZT.js";import"./chunk-BCREO4Q5.js";import"./chunk-U4QEPZJ3.js";import"./chunk-KJUZWSCL.js";import"./chunk-3WO6D7MU.js";import"./chunk-BUZ3SPLE.js";import"./chunk-K75TK42V.js";import"./chunk-OLOKUDVI.js";import{H as L,g as He,h as qt,i as Nt,n as ie,o as ve,p as W,q as Ke,r as Me,s as ze}from"./chunk-ZTOZWLEE.js";import"./chunk-RJWOVI3M.js";import"./chunk-RSDQHAJX.js";import{a as u,b as ct,c as k,e as Gt}from"./chunk-BOVYXYHK.js";import"./chunk-KVM6SHDX.js";import"./chunk-HX2VGIR2.js";import"./chunk-ERDKAICI.js";import{b as be,i as g,j as fe}from"./chunk-EQZWYK27.js";import"./chunk-JLPLCY2B.js";import"./chunk-DKGGDYJI.js";import"./chunk-5LA3PVK5.js";import"./chunk-IR6XCBC4.js";import"./chunk-C6JPAW54.js";import"./chunk-WD3OPXCN.js";import"./chunk-FA3WGIU4.js";import"./chunk-WWVPA6PE.js";import"./chunk-ZQIC5NFT.js";import{c as xe}from"./chunk-VIEK2X23.js";import"./chunk-XKIFGPJO.js";import"./chunk-PEW2PLAN.js";import"./chunk-Q6Y4JG7Q.js";import"./chunk-7F5DJLJT.js";import"./chunk-CX5IFQZJ.js";import"./chunk-NJWTSROP.js";import"./chunk-D3R25AF2.js";import"./chunk-ARRCN5K3.js";import"./chunk-O3EGNJTY.js";import"./chunk-WGAOVKGR.js";import"./chunk-4N4D2YQX.js";import"./chunk-G4DZJMGT.js";import"./chunk-K5T5FD5C.js";import"./chunk-MVHHPJM7.js";import"./chunk-VDO6JJ3Y.js";import"./chunk-WFKZLI6F.js";import"./chunk-X2B63YVS.js";import"./chunk-BAEF3CT6.js";import"./chunk-AUAZP44J.js";import"./chunk-PVDFCTA4.js";import"./chunk-KNVXE32P.js";import"./chunk-76ATOSLU.js";import"./chunk-CCJU4DSH.js";import{a as v,b as Te,g as Oe,i as Qe,j as T,k as he}from"./chunk-TG45K3WR.js";import{f as Bt}from"./chunk-RAI4DTMT.js";import{b as Wt}from"./chunk-ACP3S2CH.js";import"./chunk-HVAXZ2NA.js";import"./chunk-T7DXJKX7.js";import"./chunk-TYYVNQUR.js";import{a as n}from"./chunk-QGVBCWUY.js";import{H as te}from"./chunk-MYO4NP2N.js";import{e as l}from"./chunk-NFIPKH6V.js";import"./chunk-JPU2PQZC.js";import{l as z}from"./chunk-5QEXLALV.js";import"./chunk-P6QFA5MM.js";import"./chunk-DGTD7Y73.js";import"./chunk-LI2SX4T6.js";import{d as me}from"./chunk-BWO7LS2H.js";import"./chunk-HEVQSRJ2.js";import"./chunk-OVHPPCBL.js";import"./chunk-SNFOAZZQ.js";import"./chunk-AML4XSEF.js";import{F as Ut,b as C,c as zt,e as Se,f as Lt,p as jt}from"./chunk-4PTIEWMT.js";import{a as It,d as Xe,g as kt}from"./chunk-TG2UTNEO.js";import"./chunk-YOFFGXOB.js";import{g as Ht}from"./chunk-XRGPJ3QY.js";import"./chunk-6MRUJ2UW.js";import{g as xt}from"./chunk-2LI2GKBQ.js";import{a as Pt,y as Ft}from"./chunk-QBWJMFH5.js";import{a as H,b as B,f as Ne}from"./chunk-VTHXE323.js";var es=2,ys=4,rt=g(2),ts=1.5,bt=class{constructor(){this.collisionRadius=5,this.fovUnfocusedArcWidth=ys,this.fovFocusedArcWidth=es*this.fovUnfocusedArcWidth,this.scaleOrientSize=90,this.scaleOrientHandleRadius=.025,this.scaleOrientMinDistance=1,this.scaleOrientArrowTipLength=.3,this.scaleOrientArrowTipFocusMultiplier=es/1.5,this.observerSize=5,this.hoverTimeoutMilliseconds=1e3,this.viewAngleThreshold=10}getFovArcWidth(e){return e?this.fovFocusedArcWidth:this.fovUnfocusedArcWidth}getScaleOrientArrowTipLength(e){return this.scaleOrientArrowTipLength*(e?this.scaleOrientArrowTipFocusMultiplier:1)}},E=new bt,Mt=class{constructor(){this.frameWidthNotSelected=.3,this.frameWidthSelected=1,this.frameColor=new N([255,255,255,.99]),this.observerPointConfiguration={size:6,pixelSnappingEnabled:!1,primitive:"circle",elevationInfo:{mode:"absolute-height",offset:0},outlineSize:0,color:N.toUnitRGBA(new N([3,252,111,1]))},this.shapeMaterialParameters={color:[.33,.33,.33,.25],renderOccluded:J.Occlude,cullFace:Je.Back,writeDepth:!1}}},oe=new Mt;function Ce({tiltedUpVector:t,rightVector:e,observerRenderSpace:i},s){let r=zi(t,e,i,s);return r[12]=0,r[13]=0,r[14]=0,r}function je(t,e,i,s){let r=u(),a=i.plane,o=Ss(e,a),h;if(Math.abs(o)>E.viewAngleThreshold)h=t.next(_t(e,i.plane));else{let d=Ze(s.targetRenderSpace,i.basis1,Ye()),c=se(rs,i.basis1),p=se(Ts,i.basis2);h=t.next(_t(e,d)).next(m=>{let f=O=>{let D=ce(R(is,O,i.origin),p),F=Math.acos(be(D/s.farDistanceRenderSpace,-1,1)),K=Math.sin(F)*s.farDistanceRenderSpace;return q(u(),i.origin,q(u(),I(is,c,K),I(Os,p,D)))},w=f(m.renderStart),V=f(m.renderEnd);return B(H({},m),{renderStart:w,renderEnd:V})})}return h.next(d=>{d.action==="start"&&j(r,d.renderStart);let c=fe(Hi(r,d.renderEnd,i.origin,a));return B(H({},d),{deltaAngle:c})})}function Ss(t,e){let i=rs;t.renderCoordsHelper.toRenderCoords(t.camera.position,i);let s=Fi(t,i,t.camera.heading,t.camera.tilt,Pi()).direction;return fe(ye(s,e))-90}function ne(t,e,i,s){return W(ss,i,s),U(t,e,ss)}var rs=u(),Ts=u(),is=u(),Os=u(),ss=_();var at=class extends it{constructor(e){super(),this._handles=new me,this._tool=e.tool,this._view=e.view,this._focusedArcMaterial=this._createArcMaterial(!0),this._unfocusedArcMaterial=this._createArcMaterial(!1),this._createManipulators(),this.forEachManipulator(i=>this._tool.manipulators.add(i))}destroy(){this._handles=C(this._handles),this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()}),this._tool=null,this._view=null,this._manipulators=null}createDragPipeline(e,i){let s=Object.values(this._manipulators);return Xe(s.map(({manipulator:r,side:a})=>Re(r,(o,h,d,c,p)=>{let m=Es(a,i),f=h.next(V=>B(H({},V),{manipulatorType:ae.SCALE,side:a})),w=je(f,this._view,m,i);e(o,w,d)})))}updateManipulatorsTransform(e){e.arcCentersPoints(as),this._forEachManipulatorInfo(i=>this._updateArcManipulatorTransform(i,e,as[i.side]))}updateManipulatorVisuals(e){this._forEachManipulatorInfo(i=>this._updateArcManipulatorVisuals(i,e))}_updateArcManipulatorVisuals({manipulator:e,side:i},s){let r=[];if(s!=null){let[a,o]=Ds(i,s,this._unfocusedArcMaterial);r.push(new re(a,ge.Unfocused),new re(a.instantiate({material:this._focusedArcMaterial}),ge.Focused)),e.collisionType={type:"line",paths:[o]}}e.renderObjects=r,e.radius=E.collisionRadius}_updateArcManipulatorTransform({manipulator:e,side:i},s,r){let a=s.horizontalFieldOfView,o=g(s.verticalFieldOfView/2),h=g(a/2),d=Ee(i);e.renderLocation=r;let c=_(),p=O=>{He(c,O,c)};p(Me(Ae,g(-90))),d||p(Ke(Ae,o));let m=s.farDistanceRenderSpace,f,w;p(ve(Ae,G(ns,m,m,m))),p(ze(Ae,As(i))),p(Ce(s,Ae)),d?(f=h,w=s.tiltedUpVector):(w=s.rightVector,f=o),f*=i==="right"||i==="bottom"?-1:1;let V=W(Ae,f,w);V!=null&&p(V),e.modelTransform=c}_createManipulators(){let e=this._createArcManipulator("left"),i=this._createArcManipulator("right"),s=this._createArcManipulator("top"),r=this._createArcManipulator("bottom");this._manipulators={left:e,right:i,top:s,bottom:r},[[r.manipulator,s.manipulator],[e.manipulator,i.manipulator]].forEach(([a,o])=>{a.metadata={pairedManipulator:o},o.metadata={pairedManipulator:a}})}_createArcManipulator(e){let i=new _e({view:this._view,autoScaleRenderObjects:!1,worldSized:!0}),s={manipulator:i,side:e};return this._updateArcManipulatorVisuals(s),this._handles.add(i.events.on("focus-changed",r=>{let a=i.metadata?.pairedManipulator;a!=null&&(a.hovering!==i.hovering&&(a.hovering=i.hovering),a.grabbing!==i.grabbing&&(a.grabbing=i.grabbing))})),s}_createArcMaterial(e){let i=E.getFovArcWidth(e),s=new Ai({renderOccluded:J.OccludeAndTransparent,isDecoration:!0,width:i});return this._handles.add(v(()=>N.toUnitRGBA(this._view.effectiveTheme.accentColor),r=>s.setParameters({color:r}),T)),s}forEachManipulator(e){Object.values(this._manipulators).forEach(({manipulator:i})=>e(i,ae.SCALE))}_forEachManipulatorInfo(e){Object.values(this._manipulators).forEach(i=>e(i))}get test(){return{manipulators:this._manipulators}}};function Ds(t,e,i){let{horizontalFieldOfView:s,verticalFieldOfView:r}=e,a=Ee(t),o=g(be((a?r:s)/2,0,15)),h=Rs(-o/2,o/2,a?1:Math.max(Math.sin(g(90-r/2)),.1));return[_i(i,h),h]}function Rs(t,e,i,s=10){Le(s>1,"createArcPolylineGeometry() needs at least 2 for numVertices");let r=e-t;if(r<=0||i<=0)return[k(0,0,.01),k(0,0,-.01)];let a=[],o=r/s;for(let h=0;h<s;h++){let d=t+h*o;h===s-1&&(d=e);let c=Math.cos(d)*i,p=Math.sin(d)*i,m=k(c-i,0,p);a.push(m)}return a}function Cs(t){switch(t){case"left":return 0;case"bottom":return 1;case"right":return 2;case"top":return 3}}function As(t){return Cs(t)*Ps}function Ee(t){return t==="left"||t==="right"}function os(t){return t==="left"?"right":t==="right"?"left":t==="top"?"bottom":"top"}function Es(t,{observerRenderSpace:e,targetRenderSpace:i,tiltedUpVector:s,rightVector:r,farDistanceRenderSpace:a}){let o=R(ns,i,e),h=Ee(t)?r:s,d=I(Fs,h,a);return Ie(e,o,d)}var Ps=Math.PI/2,Ae=_(),ns=u(),Fs=u(),as={top:u(),bottom:u(),left:u(),right:u()};var Pe=class extends _e{constructor(e,i){super({view:e,autoScaleRenderObjects:!1,worldSized:!1,radius:E.collisionRadius}),this._handles=new me,this._setupManipulatorVisual(i)}destroy(){this._handles.remove(),super.destroy()}_setupManipulatorVisual(e){let i=this._createMaterial(),s=1,r=[k(0,0,0),k(0,0,s)],a=wt(i,r,e,16,!1),o=wt(i,r,e*ke,16,!1),h=ls(!1,i,e),d=ls(!0,i,e),c=_();ie(c,r[r.length-1]),L(c,c,Ke(hs,Math.PI/2)),L(c,c,Me(hs,Math.PI/2)),h.transformation=c,d.transformation=c,this.renderObjects=[new re(a,ge.Unfocused),new re(o,ge.Focused),new re(h,ge.Unfocused),new re(d,ge.Focused)];let p=k(0,E.getScaleOrientArrowTipLength(!0),0),m=U(p,p,c),f=[...r,m];this.collisionType={type:"line",paths:[f]}}_createMaterial(){let e=new et({cullFace:Je.Back,renderOccluded:J.OccludeAndTransparent,isDecoration:!0});return this._handles.add(v(()=>N.toUnitRGBA(this.view.effectiveTheme.accentColor),i=>e.setParameters({color:i}),T)),e}};function ls(t,e,i){let s=E.getScaleOrientArrowTipLength(t),r=2*i;t&&(r*=ke);let a=s/2;return Vi(e,s,a,a,r,0)}var hs=_();var nt=class extends it{constructor(e){super(),this._handles=new me,this._tool=e.tool,this._view=e.view;let i=E.scaleOrientHandleRadius;this._manipulatorHeading=new Pe(this._view,i),this._manipulatorTilt=new Pe(this._view,i),this._manipulatorDistance=new Pe(this._view,i),this.forEachManipulator(s=>this._tool.manipulators.add(s))}destroy(){this._handles.destroy(),this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()}),this._manipulatorHeading=null,this._manipulatorTilt=null,this._manipulatorDistance=null,this._tool=null,this._view=null}createHeadingDragPipeline(e,i){return Re(this._manipulatorHeading,(s,r,a,o,h)=>{let d=this._view,{tiltParallelToSurface:c,farDistanceRenderSpace:p,upVector:m,observerRenderSpace:f,targetRenderSpace:w,rightVector:V}=i,O=Math.sin(g(c))*p,D=q(ot,f,I(yt,m,O)),F=R(yt,w,D),K=I(Hs,V,de(F)),x=Ie(D,F,K),Y=je(r,d,x,i).next(Z=>B(H({},Z),{manipulatorType:ae.ROTATE}));e(s,Y,a)})}createTiltDragPipeline(e,i){return Re(this._manipulatorTilt,(s,r,a,o,h)=>{let{observerRenderSpace:d,farDistanceRenderSpace:c,upVector:p,targetDirection:m}=i,f=ce(m,p),w=Zt(ot,m,p,-f);I(w,se(w,w),c);let V=I(yt,p,c),O=Ie(d,w,V),D=je(r,this._view,O,i).next(F=>B(H({},F),{manipulatorType:ae.ROTATE}));e(s,D,a)})}createDistanceDragPipeline(e,i){return Re(this._manipulatorDistance,(s,r,a,o,h)=>{let d=ri(i.observerRenderSpace,i.targetDirection),c=r.next(ji(this._view,s.location)).next(Ni(this._view,d)).next(p=>B(H({},p),{manipulatorType:ae.SCALE}));e(s,c,a)})}updateManipulators(e){let{targetRenderSpace:i}=e;this._manipulatorHeading.renderLocation=i,this._manipulatorTilt.renderLocation=i,this._manipulatorDistance.renderLocation=i;let s=_(),r=p=>{He(s,p,s)},a=E.scaleOrientSize*(st/70);r(ve(Ue,G(ot,a,a,a))),r(Ce(e,Ue));let o=E.scaleOrientHandleRadius*ke*a,h=I(ot,e.targetDirection,o);r(ie(Ue,h));let d=ze(Ue,-St);L(d,d,Me(cs,-St)),this._manipulatorHeading.modelTransform=L(_(),s,d);let c=Me(Ue,St);L(c,c,ze(cs,Math.PI)),this._manipulatorTilt.modelTransform=He(_(),s,c),this._manipulatorDistance.modelTransform=s}forEachManipulator(e){e(this._manipulatorHeading,ae.ROTATE),e(this._manipulatorTilt,ae.ROTATE),e(this._manipulatorDistance,ae.SCALE)}},Ue=_(),cs=_(),ot=u(),yt=u(),Hs=u(),St=Math.PI/2;var Be=class extends _e{constructor(e,i){super({view:e,autoScaleRenderObjects:!1,worldSized:!1,radius:E.observerSize,interactive:!1}),this._handles=new me;let s=xi(this._color);this.renderObjects=[new re(gi(s,E.observerSize,32,32))],i.manipulators.add(this),this._handles.add([v(()=>this._color,r=>{s.setParameters({color:r})},T)])}destroy(){this._handles.remove(),super.destroy()}get _color(){return N.toUnitRGBA(this.view.effectiveTheme.accentColor)}};n([l()],Be.prototype,"_color",null);var ds=Symbol("dragHandles"),ps=Symbol("hideManipulators"),us=Symbol("hideFoVManipulators"),ms=Symbol("hideObserverManipulator"),X=class extends te{constructor(t){super(t),this._moveManipulation=null,this._observerManipulator=null,this._fieldOfViewManipulation=null,this._scaleOrientManipulation=null,this._forceHoveringTask=null,this._forceHoveringTestPromise=null,this._grabbing=!1,this.viewshedComputedData=null}initialize(){this._moveManipulation=this._createMoveManipulation(),this._fieldOfViewManipulation=new at({view:this.view,tool:this.parentTool}),this._scaleOrientManipulation=new nt({view:this.view,tool:this.parentTool}),this._observerManipulator=new Be(this.view,this.parentTool),this.addHandles([v(()=>this.viewshedComputedData?.observerRenderSpace,e=>{e!=null&&(this._moveManipulation.renderLocation=e,this._observerManipulator.renderLocation=e)},he),v(()=>this.viewshedComputedData?.heading,e=>{e&&(this._moveManipulation.angle=g(90-e))},T),v(()=>{let{viewshedComputedData:e}=this;return{viewshedComputedData:e,observer:e?.observer}},({viewshedComputedData:e,observer:i},s)=>{this._grabbing&&i!==s?.observer||(this.removeHandles(ds),e?.isValid()&&this.addHandles([this._buildObserverDragPipeline(e),this._buildFOVDragPipeline(e),this._buildScaleOrientDragPipeline(e)].filter(Ft),ds))},T),v(()=>{let e=this.viewshedComputedData;return e?.isValid()?{viewshedCompData:e,target:e.targetRenderSpace,hFOV:e.horizontalFieldOfView,vFOV:e.verticalFieldOfView}:null},e=>{e!=null&&this._fieldOfViewManipulation.updateManipulatorsTransform(e.viewshedCompData)},T),v(()=>{let e=this.viewshedComputedData;return e?.isValid()?{viewshedCompData:e,hFOV:e.horizontalFieldOfView,vFOV:e.verticalFieldOfView,tilt:e.tilt}:null},e=>{e!=null&&this._fieldOfViewManipulation.updateManipulatorVisuals(e.viewshedCompData)},T),v(()=>{let e=this.analysisViewData.visible&&(this.viewshedComputedData?.isValid()??!1),i=this.parentTool.selectedViewshedComputedData===this.viewshedComputedData;return{fovManipulationAvailable:e&&!this.parentTool.isPlacingTarget,nonFOVManipulationAvailable:e&&(!this.parentTool.creating||i)}},({fovManipulationAvailable:e,nonFOVManipulationAvailable:i})=>{this._moveManipulation.available=i,this._scaleOrientManipulation.available=i,this._observerManipulator.available=i,this._fieldOfViewManipulation.available=e},T),v(()=>{let e=this.viewshedComputedData;if(!e?.isValid())return null;let{observer:i,target:s,verticalFieldOfView:r,horizontalFieldOfView:a}=e;return{viewshedCompData:e,observer:i,target:s,verticalFieldOfView:r,horizontalFieldOfView:a}},e=>{e!=null&&this._scaleOrientManipulation.updateManipulators(e.viewshedCompData)},T)]);let t=e=>{let i=this.analysisViewData;this.addHandles([e.events.on("focus-changed",()=>{let s=this._someManipulatorHovering();s&&this.parentTool.subToolHandles.forEach(({subTool:r})=>{r._resetHoveringTask()}),this._someManipulatorSelected()||s||(this._forceHoveringTask=Bt(r=>Ne(this,null,function*(){yield this._forceHoveringTestPromise??Ut(E.hoverTimeoutMilliseconds,r),jt(r),this._forceHoveringTask=null,this._updateManipulatorVisibility()})))}),e.events.on("grab-changed",s=>{this._grabbing=s.action==="start",s.action==="end"&&i.tool?.updateInteractionVisualsVisibility(),this.parentTool.subToolHandles.forEach(({subTool:r})=>{r!==this&&r._setInteractive(!this._grabbing)}),this._setInteractive(r=>r.hasManipulator(e)||!this._grabbing)}),e.events.on("drag",s=>{s.action==="start"&&i.tool?.updateInteractionVisualsVisibility()})])};this._forEachManipulator(t)}destroy(){this._forceHoveringTask=Se(this._forceHoveringTask),this._moveManipulation=C(this._moveManipulation),this._fieldOfViewManipulation=C(this._fieldOfViewManipulation),this._scaleOrientManipulation=C(this._scaleOrientManipulation),this.parentTool.manipulators.remove(this._observerManipulator),this._observerManipulator=C(this._observerManipulator)}get viewshed(){return this.viewshedComputedData?.viewshed}get grabbing(){return this._grabbing}get observer(){return this.viewshed?.observer}set observer(t){let e=this.viewshed;e!=null&&(e.observer=t)}get discManipulator(){return this._moveManipulation.xyManipulation.discManipulator}get moveInteractionState(){let{dragging:t,grabbing:e}=this._moveManipulation;return{dragging:t,grabbing:e}}get scaleOrientInteractionState(){let{dragging:t,grabbing:e}=this._scaleOrientManipulation;return{dragging:t,grabbing:e}}_setInteractive(t){let e=typeof t=="boolean";this._forEachManipulation(i=>i.interactive=e?t:t(i))}onManipulatorSelectionChanged(){this._updateManipulatorVisibility(),!this._someManipulatorSelected()&&(this.analysisViewData.selectedViewshed===this.viewshed&&(this.analysisViewData.selectedViewshed=null),this._resetHoveringTask())}hasManipulator(t){let e=!1;return this._forEachManipulator(i=>{e=e||i===t}),e}_someManipulatorSelected(){return this._moveManipulation.selected||this._fieldOfViewManipulation.selected||this._scaleOrientManipulation.selected}_someManipulatorHovering(){return this._moveManipulation.hovering||this._fieldOfViewManipulation.hovering||this._scaleOrientManipulation.hovering}_createMoveManipulation(){return new Yi({view:this.view,tool:this.parentTool,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:st})}_buildObserverDragPipeline(t){let e={mode:"absolute-height",offset:0},i=t.observer;if(i==null)return null;let s=this.view.spatialReference;return this._moveManipulation.createDragPipeline((r,a,o,h,d)=>{h=h.next(tt(this,["observer"]));let c=Kt(i,s);if(c==null)return{steps:o,cancel:h};let p=Ri.fromGeometry(c,ii(this.view.viewingMode));return{steps:o.next(ki({operations:p})).next(m=>(this.observer=p.data.geometry,m)),cancel:h}},e,s,void 0)}_buildFOVDragPipeline(t){let e=0,i=0;return this._fieldOfViewManipulation.createDragPipeline((s,r,a)=>{if(t==null)return{steps:r,cancel:a};let o=t.viewshed,h=null;return a=a.next(tt(o,["horizontalFieldOfView","verticalFieldOfView"])),{steps:r.next(d=>{d.action==="start"&&(h=null,e=t.horizontalFieldOfView,i=t.verticalFieldOfView);let c=d.deltaAngle;if(h==null&&c!==0){let f=d.side==="bottom"||d.side==="left"?c>0:c<0;h=Ee(d.side)?e===0&&f||e===360&&!f:i===0&&f}let p=h?os(d.side):d.side,m=0;switch(p){case"left":m=e/2-c;break;case"right":m=e/2+c;break;case"top":m=i+2*c;break;case"bottom":m=i-2*c}return Ee(p)?(m=gt.normalize(m),m=m>270?0:m>180?180:m,o.horizontalFieldOfView=2*m):o.verticalFieldOfView=m,d}),cancel:a}},t)}_buildScaleOrientDragPipeline(t){let e=0,i=0,s=(r,a)=>(o,h,d)=>{if(t==null)return{steps:h,cancel:d};let c=t.viewshed;return d=d.next(tt(c,[r])),{steps:h=h.next(a(c,t)),cancel:d}};return Xe([this._scaleOrientManipulation.createHeadingDragPipeline(s("heading",(r,a)=>o=>(o.action==="start"&&(i=t.heading),r.heading=gt.normalize(i+o.deltaAngle),o)),t),this._scaleOrientManipulation.createTiltDragPipeline(s("tilt",(r,a)=>o=>{o.action==="start"&&(e=t.tilt);let h=e+o.deltaAngle;return h<-90?h=180:h>270&&(h=0),r.tilt=Ls.clamp(h),o}),t),this._scaleOrientManipulation.createDistanceDragPipeline(s("farDistance",(r,a)=>o=>{let h=R(zs,o.renderEnd,a.observerRenderSpace),d=de(h)*a.metersPerUnit,c=ce(h,a.targetDirection)<0?E.scaleOrientMinDistance:d;return r.farDistance=c,o}),t)])}_updateManipulatorVisibility(){let t=this._someManipulatorSelected(),e=this._forceHoveringTask!=null||this._someManipulatorHovering(),i=this._fieldOfViewManipulation.hovering,s=this.parentTool.creating,r=[],a=o=>{r.push(o.disableDisplay())};t||!s&&e?this.removeHandles(ps):(this._scaleOrientManipulation.forEachManipulator(a),this._moveManipulation.forEachManipulator(a),this.addHandles(r,ps),r=[]),t||!s&&e||s&&i?this.removeHandles(us):(this._fieldOfViewManipulation.forEachManipulator(a),this.addHandles(r,us)),t||!s?this.removeHandles(ms):this.addHandles(this._observerManipulator.disableDisplay(),ms)}_resetHoveringTask(){this._forceHoveringTask=Se(this._forceHoveringTask),this._updateManipulatorVisibility()}_forEachManipulator(t){this._forEachManipulation(e=>{e.forEachManipulator(t)}),t(this._observerManipulator)}_forEachManipulation(t){t(this._moveManipulation),t(this._fieldOfViewManipulation),t(this._scaleOrientManipulation)}get test(){return{moveManipulation:this._moveManipulation,fieldOfViewManipulation:this._fieldOfViewManipulation,scaleOrientManipulation:this._scaleOrientManipulation,viewshedComputedData:this.viewshedComputedData,setHoveringTimeoutPromise:t=>{this._forceHoveringTestPromise=t}}}};n([l({constructOnly:!0})],X.prototype,"analysis",void 0),n([l({constructOnly:!0})],X.prototype,"analysisViewData",void 0),n([l({constructOnly:!0})],X.prototype,"parentTool",void 0),n([l({constructOnly:!0,nonNullable:!0})],X.prototype,"view",void 0),n([l()],X.prototype,"viewshed",null),n([l()],X.prototype,"_grabbing",void 0),n([l()],X.prototype,"grabbing",null),n([l()],X.prototype,"viewshedComputedData",void 0),n([l()],X.prototype,"observer",null),X=n([z("esri.views.3d.analysis.Viewshed.ViewshedSubTool")],X);var zs=u(),Ls=new bi(0,180);var Tt=Symbol("interactionVisuals"),A=class extends Ii{constructor(t){super(t),this.removeIncompleteOnCancel=!1,this.automaticManipulatorSelection=!1,this._stagedViewshed=null,this._stagedViewshedComputedData=null,this._creationState=!1,this._interactionVisualElements=null,this._settings=new Ki({getTheme:()=>this.view.effectiveTheme}),this._selectedManipulator=null}initialize(){this._intersector=Xi(this.view.state.viewingMode),this._createInteractionVisuals();let t=this.analysisViewData.viewshedComputedDataHandles;this.subToolHandles=Oe(()=>t,({viewshedComputedData:e})=>{let i=new X({analysis:this.analysis,analysisViewData:this.analysisViewData,parentTool:this,view:this.view,viewshedComputedData:e});return{subTool:i,remove:()=>{this.selectedViewshed===e.viewshed&&(this.selectedViewshed=null),i.destroy()}}}),this.addHandles([v(()=>t?.some(e=>e.viewshedComputedData.isValid()),e=>{e&&this.finishToolCreation()},he),v(()=>this._stagedViewshed,e=>{let i=this.analysisViewData.viewshedComputedDataHandles;this._stagedViewshedComputedData=e!=null&&i!=null?this._findSubTool(e)?.viewshedComputedData:null},he),v(()=>this.firstGrabbedManipulator,e=>{if(e!=null){let i=this._findSubTool(e)?.viewshed;this.selectedViewshed=i,this._selectManipulator(e)}else this._selectedSubTool?.onManipulatorSelectionChanged()},Qe),v(()=>this.view.activeTool,e=>{e!==this&&e!=null&&(this.selectedViewshed=null)}),Te(()=>{let e=this.selectedViewshedComputedData;return e==null?null:{subTool:this._selectedSubTool,observer:e.observerRenderSpace,target:e.targetRenderSpace}},e=>{let{subTool:i,observer:s,target:r}=e;i?.moveInteractionState.dragging?this._updateInteractionVisualsLocation(s,!0):i?.scaleOrientInteractionState.dragging&&this._updateInteractionVisualsLocation(r,!1)},T),v(()=>this.creating,()=>this.updateInteractionVisualsVisibility()),v(()=>this.selectedViewshed,e=>{let i=this._selectedManipulator,s=this._selectedSubTool;e==null?this._selectManipulator(null):i!=null&&s.hasManipulator(i)||this._selectManipulator(s.discManipulator)},T)])}destroy(){this.subToolHandles=C(this.subToolHandles),this.removeHandles(Tt)}onDeactivate(){this.removeStaged(),this._creationState=!1}get cursor(){return this.creating?"crosshair":null}get _selectedSubTool(){return this._findSubTool(this.selectedViewshed)}_selectManipulator(t){let e=this._selectedManipulator;e!==t&&(this._selectedManipulator=t,e!=null&&(e.selected=!1),t!=null&&(t.selected=!0),this._findSubTool(e)?.onManipulatorSelectionChanged(),this._selectedSubTool?.onManipulatorSelectionChanged())}get selectedViewshed(){return this.analysisViewData.selectedViewshed}set selectedViewshed(t){this.analysisViewData.selectedViewshed=t}get selectedViewshedComputedData(){return this._selectedSubTool?.viewshedComputedData}get stagedViewshed(){return this._stagedViewshed}get grabbing(){return this.subToolHandles.some(({subTool:t})=>t.grabbing)}get creating(){return this._creationState&&this.active}get isPlacingTarget(){return this._creationState==="placing-target"}createViewsheds(){this.selectedViewshed=null,this._creationState="placing-observer"}onManipulatorSelectionChanged(){this.subToolHandles.forEach(t=>t.subTool.onManipulatorSelectionChanged())}onInputEvent(t){switch(t.type){case"immediate-double-click":this._doubleClickHandler(t);break;case"pointer-move":this._pointerMoveHandler(t);break;case"key-down":Vt.cancel===t.key?this._cancelKeyHandler(t):Vt.delete.includes(t.key)&&this._deleteKeyHandler();break;case"hold":this.updateInteractionVisualsVisibility(!0)}}onInputEventAfter(t){t.type==="immediate-click"&&this._clickPlacementHandler(t)}_clickPlacementHandler(t){if(!this.creating||this.hasFocusedManipulators)return;let e=this._intersectScreen(t,vs);if(e!=null){if(this._creationState==="placing-observer"){e.mapPoint.z=(e.mapPoint.z??0)+ts;let i=new Ti({observer:e.mapPoint.clone(),feature:e.feature});this.analysis.viewsheds.add(i),this._stagedViewshed=i,this._creationState="placing-target",this._updateStagedViewshed(e.scenePoint)}else if(this._creationState==="placing-target"){this._updateStagedViewshed(e.scenePoint);let i=this._stagedViewshed;this._creationState="placing-observer",this._stagedViewshed=null,this.selectedViewshed=i}t.stopPropagation()}}_doubleClickHandler(t){this.creating&&(this.removeStaged(),this._creationState=!1,this.view.activeTool=null,t.stopPropagation())}_pointerMoveHandler(t){if(!this.creating)return;let e=this._intersectScreen(t,vs);e!=null&&(this._updateInteractionVisualsLocation(e.scenePoint,!1),this._updateStagedViewshed(e.scenePoint))}_cancelKeyHandler(t){if(this.creating){if(this.removeStaged())return this._creationState="placing-observer",this.selectedViewshed=null,void t.stopPropagation();this._creationState=!1}else if(!this.grabbing)return this.selectedViewshed=null,void t.stopPropagation()}_deleteKeyHandler(){this.creating&&(this.removeStaged(),this._creationState="placing-observer"),this.selectedViewshed!=null&&this.analysis.viewsheds.remove(this.selectedViewshed)}_updateStagedViewshed(t){let e=this._stagedViewshed,i=this._stagedViewshedComputedData;if(e==null||i==null)return;let{heading:s,tilt:r,farDistance:a}=Is(this.view,i,t);e.farDistance=a,e.tilt=r,e.heading=s}removeStaged(){return this._stagedViewshed!=null&&(this.analysis.viewsheds.remove(this._stagedViewshed),this._stagedViewshed=null,!0)}_intersectScreen(t,e){let i=Ui(t);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(i,this._intersector);let s=this._intersector.results.min,r=e.scenePoint;if(!s.getIntersectionPoint(r))return null;let a=e.mapPoint;return a.spatialReference=this.view.spatialReference,this.view.renderCoordsHelper.fromRenderCoords(r,a),a==null?null:(e.feature=Mi(s,this.view),e)}_createInteractionVisuals(){this.removeHandles(Tt);let t=this._settings.visualElements,e=new Li({view:this.view,attached:!1,style:{glowWidth:t.heightPlane.glowWidth,innerWidth:t.heightPlane.innerWidth},isDecoration:!0}),i=new Qi({view:this.view,extensionType:t.zVerticalLine.extensionType,attached:!1,innerWidth:1,writeDepthEnabled:!1,renderOccluded:J.OccludeAndTransparent,isDecoration:!0});this._interactionVisualElements={laserline:e,verticalLine:i},this.addHandles([v(()=>t.zVerticalLine,s=>s.apply(i),he),v(()=>t.heightPlane,s=>s.apply(e),he),It(()=>{e.destroy(),i.destroy(),this._interactionVisualElements=null})],Tt)}updateInteractionVisualsVisibility(t=!1){let e=this.creating,i=this.analysisViewData.visible,s=this._selectedSubTool,r=this.selectedViewshedComputedData,a=(m,f)=>{let w=this._interactionVisualElements;w!=null&&(w.verticalLine.attached=f,w.laserline.attached=m)};if(e)return void a(i,!1);if(s==null||r==null)return void a(!1,!1);let o=s.moveInteractionState,h=t?o.grabbing:o.dragging,d=s.scaleOrientInteractionState,c=t?d.grabbing:d.dragging,p=i&&(h||c);if(a(p,h),p){let m=h?r.observerRenderSpace:r.targetRenderSpace;this._updateInteractionVisualsLocation(m,h)}}_updateInteractionVisualsLocation(t,e){let i=this._interactionVisualElements;if(i==null)return;let{laserline:s,verticalLine:r}=i;s.heightManifoldTarget=t,s.intersectsWorldUpAtLocation=e?t:null,t!=null&&r.setStartEndFromWorldDownAtLocation(t)}_findSubTool(t){if(t==null)return null;let e=t instanceof _e?i=>i.subTool.hasManipulator(t):i=>i.subTool.viewshed===t;return this.subToolHandles?.find(e)?.subTool}get test(){}};function Is(t,e,i){let s=e.observerRenderSpace,r=R(ks,i,s),a=de(r)*e.metersPerUnit,o=t.renderCoordsHelper.basisMatrixAtPosition(s,Bs),h=G(js,o[8],o[9],o[10]),d=Ze(s,h,Ws),c=ti(d,i,Us),p=R(c,c,s),m=(de(p)<1e-4?90:fe(ye(r,p)))*(ce(h,r)<0?-1:1)+90,f=G(fs,o[4],o[5],o[6]),w=fe(ye(f,p)),V=G(fs,o[0],o[1],o[2]);return{heading:ce(p,V)<0?360-w:w,tilt:m,farDistance:a}}n([l({constructOnly:!0})],A.prototype,"view",void 0),n([l()],A.prototype,"analysisViewData",void 0),n([l()],A.prototype,"removeIncompleteOnCancel",void 0),n([l()],A.prototype,"automaticManipulatorSelection",void 0),n([l({constructOnly:!0})],A.prototype,"analysis",void 0),n([l()],A.prototype,"subToolHandles",void 0),n([l()],A.prototype,"_stagedViewshed",void 0),n([l()],A.prototype,"_stagedViewshedComputedData",void 0),n([l()],A.prototype,"_creationState",void 0),n([l({readOnly:!0})],A.prototype,"cursor",null),n([l()],A.prototype,"_selectedManipulator",void 0),n([l()],A.prototype,"_selectedSubTool",null),n([l()],A.prototype,"selectedViewshed",null),n([l()],A.prototype,"selectedViewshedComputedData",null),n([l()],A.prototype,"stagedViewshed",null),n([l()],A.prototype,"grabbing",null),n([l()],A.prototype,"creating",null),n([l()],A.prototype,"isPlacingTarget",null),A=n([z("esri.views.3d.analysis.Viewshed.ViewshedTool")],A);var ks=u(),js=u(),Us=u(),fs=u(),Bs=_(),Ws=Ye(),vs={mapPoint:new xe,scenePoint:u(),feature:null},We=A;var lt=class extends Ci{constructor(e){super(e),this._material=null,this._viewshedComputedData=null,this._material=new et(B(H({},oe.shapeMaterialParameters),{isDecoration:this.isDecoration,writeDepth:!1})),this.applyProperties(e)}get viewshedComputedData(){return this._viewshedComputedData}set viewshedComputedData(e){this._viewshedComputedData=e,this.updateTransform()}updateTransform(){let e=this._viewshedComputedData;if(e==null)return;let i=_(),s=e.farDistanceRenderSpace;ve(i,k(s,s,s)),Ce(e,Ge),L(i,Ge,i),ie(Ge,this._viewshedComputedData.observerRenderSpace),L(i,Ge,i),this.transform=i}createExternalResources(){}destroyExternalResources(){}forEachExternalMaterial(e){this._material!=null&&e(this._material)}createGeometries(e){let{_material:i,viewshedComputedData:s}=this;s==null||i==null||!s.isValid()||Gs(i,s).forEach(r=>e.addGeometry(r))}};function Gs(t,e){let{horizontalFieldOfView:i,verticalFieldOfView:s}=e,r=G(qs,0,0,1),a=G(gs,0,1,0),o=G(_s,1,0,0);ne(r,r,g(s/2),a),ne(r,r,g(i/2),o);let h=S=>Math.ceil(Math.abs(S)/rt)+1,d=g(i),c=j(Ns,o),p=h(d),m=ws(-d/(p-1)),f=W(Ge,m,c),w=g(-s),V=h(w),O=ws(w/(V-1)),D=j(gs,a),F=W(Vs,g(i)/2,o);U(D,D,F);let K=Vs,x=[],Y=j(_s,r);for(let S=0;S<p;S++){W(K,O,D);for(let M=0;M<V;M++){let y=3*(M*p+S);x[y]=Y[0],x[y+1]=Y[1],x[y+2]=Y[2],U(Y,Y,K)}U(D,D,f),U(r,r,f),j(Y,r)}let Z=p*V;x[3*Z]=0,x[3*Z+1]=0,x[3*Z+2]=0;let ee=[];for(let S=0;S<p-1;S++)for(let M=0;M<V-1;M++){let y=6*(M*(p-1)+S);ee[y]=M*p+S,ee[y+1]=(M+1)*p+S,ee[y+2]=M*p+S+1,ee[y+3]=M*p+S+1,ee[y+4]=(M+1)*p+S,ee[y+5]=(M+1)*p+S+1}let ue=[ee];if(i!==360&&s!==0){let S=[],M=[];for(let y=0;y<V-1;y++){let P=3*y;S[P]=Z,S[P+1]=(y+1)*p,S[P+2]=y*p,M[P]=Z,M[P+1]=y*p+p-1,M[P+2]=(y+1)*p+p-1}ue.push(S,M)}if(s!==180&&i!==0){let S=[],M=[];for(let y=0;y<p-1;y++){let P=3*y;S[P]=Z,S[P+1]=y,S[P+2]=y+1,M[P]=Z,M[P+1]=y+(V-1)*p+1,M[P+2]=y+(V-1)*p}ue.push(S,M)}return ue.map(S=>{let M=[[ei.POSITION,new si(x,S,3,!0)]];return new wi(t,M)})}function ws(t){return isNaN(t)?1:t}var qs=u(),gs=u(),_s=u(),Ns=u(),Ge=_(),Vs=_();var le=class extends te{constructor(t){super(t),this.visible=!0,this._viewshedCorners={topLeft:u(),topRight:u(),bottomLeft:u(),bottomRight:u()},this._arcCenterPoints={top:u(),bottom:u(),left:u(),right:u()},this._parallelCenters={top:u(),bottom:u()}}initialize(){let t={view:this.view,isDecoration:!0},e=B(H({},t),{color:this._color,renderOccluded:J.OccludeAndTransparent}),i=B(H({},e),{stipplePattern:Ei(2)});this._observerVisualElement=new Bi(H(H({},t),oe.observerPointConfiguration)),this._shapeVisualElement=new lt(t),this._frameLinesVisualElement=new we(e),this._leftArcVisualElement=new we(e),this._rightArcVisualElement=new we(e),this._topArcVisualElement=new we(e),this._bottomArcVisualElement=new we(e),this._centralLongitude=new we(i),this._centralLatitude=new we(i),this.addHandles([v(()=>{let s=this.viewshedComputedData;if(!s?.isValid())return null;let r=this._viewshedCorners,a=this._arcCenterPoints,o=this._parallelCenters;return s.cornerPoints(r),s.arcCentersPoints(a),s.parallelCenterPoints(o),{viewshedComputedData:s,corners:r,arcCenters:a,parallelCenters:o,interactive:this.analysisViewData.interactive,selected:this._selected}},s=>{let r=s!=null;this._forEachVisualElement(a=>a.attached=r),r&&this._updateVisualElements(s)},{initial:!0,equals:xt}),v(()=>{let{viewshedComputedData:s}=this,{horizontalFieldOfView:r,verticalFieldOfView:a}=s??{};return{viewshedComputedData:s,horizontalFieldOfView:r,verticalFieldOfView:a}},({viewshedComputedData:s})=>{let{_shapeVisualElement:r}=this;s!==r.viewshedComputedData&&(r.viewshedComputedData=s),this._shapeVisualElement.recreateGeometry()},T),v(()=>{let{interactive:s}=this.analysisViewData;return{visible:this.visible,selected:s&&this._selected,staged:s&&this._staged,horFovNot360:this.viewshedComputedData?.horizontalFieldOfView!==360}},({visible:s,selected:r,staged:a,horFovNot360:o})=>{let h=r||a;this._shapeVisualElement.visible=s,this._topArcVisualElement.visible=s,this._bottomArcVisualElement.visible=s,this._frameLinesVisualElement.visible=s&&o;let d=s&&(r||o);this._leftArcVisualElement.visible=d,this._rightArcVisualElement.visible=d,this._forEachLineVisualElement(c=>{c.width=h?oe.frameWidthSelected:oe.frameWidthNotSelected,c.renderOccluded=r?J.OccludeAndTransparent:J.Occlude}),[this._centralLatitude,this._centralLongitude].forEach(c=>{c.width=2*(h?oe.frameWidthSelected:oe.frameWidthNotSelected),c.visible=s&&r})},T),v(()=>{let{analysisViewData:{interactive:s,tool:r},_selected:a,visible:o}=this,h=this.view.activeTool,d=!r?.active&&h instanceof We&&h.creating;return{observerVisible:o&&!a&&(!s||(r?.creating??!1)||d),color:this._color}},({observerVisible:s,color:r})=>{this._observerVisualElement.visible=s,this._forEachLineVisualElement(a=>a.color=r)},T)])}get _color(){let{viewshedComputedData:t,_selected:e,analysisViewData:i}=this;if(t==null)return N.toUnitRGBA(oe.frameColor);let s=i.tool?.active||i.interactive,r=t.viewshed===i.tool?.stagedViewshed,a=s&&(e||r)?this.view.effectiveTheme.accentColor:oe.frameColor;return N.toUnitRGBA(a)}get _selected(){let{viewshedComputedData:t,analysisViewData:{selectedViewshedComputedData:e}}=this;return t!=null&&t===e}get _staged(){let{analysisViewData:{tool:t},viewshedComputedData:e}=this;return t!=null&&t.creating&&t.stagedViewshed===e?.viewshed}destroy(){this._observerVisualElement=C(this._observerVisualElement),this._shapeVisualElement=C(this._shapeVisualElement),this._frameLinesVisualElement=C(this._frameLinesVisualElement),this._leftArcVisualElement=C(this._leftArcVisualElement),this._rightArcVisualElement=C(this._rightArcVisualElement),this._topArcVisualElement=C(this._topArcVisualElement),this._bottomArcVisualElement=C(this._bottomArcVisualElement),this._centralLongitude=C(this._centralLongitude),this._centralLatitude=C(this._centralLatitude)}_forEachLineVisualElement(t){[this._frameLinesVisualElement,this._leftArcVisualElement,this._rightArcVisualElement,this._topArcVisualElement,this._bottomArcVisualElement,this._centralLatitude,this._centralLongitude].forEach(t)}_forEachVisualElement(t){this._forEachLineVisualElement(t),t(this._observerVisualElement),t(this._shapeVisualElement)}_updateVisualElements(t){let{viewshedComputedData:e,corners:i,arcCenters:s,parallelCenters:r}=t,a=ct(e.observerRenderSpace);this._observerVisualElement.geometry=e.observer,this._shapeVisualElement.updateTransform(),this._updateFrameLines(a,i),this._updateFrameArcs(e,i,r),this._updateCentralHelperArcs(e,s)}_updateFrameLines(t,e){this._frameLinesVisualElement.geometry=[[t,e.topLeft],[t,e.topRight],[t,e.bottomLeft],[t,e.bottomRight]]}_updateFrameArcs(t,e,i){let{observerRenderSpace:s,rightVector:r,horizontalFieldOfView:a,tiltedUpVector:o}=t,h=g(a),d=u(),c=_();W(c,h/2,o),U(d,r,c),Fe(this._leftArcVisualElement,s,e.bottomLeft,e.topLeft,"forward",d),W(c,-h/2,o),G(d,0,0,0),U(d,r,c),Fe(this._rightArcVisualElement,s,e.bottomRight,e.topRight,"forward",d);let p=a>180?"backward":"forward";Fe(this._topArcVisualElement,i.top,e.topRight,e.topLeft,p,o),Fe(this._bottomArcVisualElement,i.bottom,e.bottomRight,e.bottomLeft,p,o)}_updateCentralHelperArcs(t,e){let i=t.observerRenderSpace,s=t.horizontalFieldOfView>=180?"backward":"forward";Fe(this._centralLatitude,i,e.right,e.left,s,t.tiltedUpVector),Fe(this._centralLongitude,i,e.top,e.bottom,"forward",t.leftVector)}get test(){}};function Fe(t,e,i,s,r,a,o=rt){let h=u();R(h,i,e);let d=de(h),c=u();R(c,s,e),se(c,c),I(c,c,d);let p=ye(h,c),m=ct(a);r==="backward"&&(De(m,m),p=-(2*Math.PI-p));let f=[],w=Math.ceil(Math.abs(p)/o),V=_();W(V,p/w,m);let O=u();j(O,h);let D=u();j(D,i);for(let F=0;F<w;F++){let K=u();j(K,D),U(O,O,V),q(D,e,O);let x=u();j(x,D),f.push([K,x])}t.geometry=f}n([l()],le.prototype,"view",void 0),n([l()],le.prototype,"analysisViewData",void 0),n([l()],le.prototype,"viewshedComputedData",void 0),n([l()],le.prototype,"visible",void 0),n([l()],le.prototype,"_color",null),n([l()],le.prototype,"_selected",null),n([l()],le.prototype,"_staged",null),le=n([z("esri.views.3d.analysis.Viewshed.ViewshedVisualization")],le);var bs=le;var Ve=class extends te{get visible(){return this.analysisViewData.visible}constructor(t){super(t)}initialize(){let t=this.analysisViewData,e=Oe(()=>this.analysisViewData.viewshedComputedDataHandles,({viewshedComputedData:i})=>{let s=new bs({view:this.view,viewshedComputedData:i,analysisViewData:t});return{visualization:s,remove:()=>s.destroy()}});this._viewshedVisualizations=e,this.addHandles([kt(e),v(()=>this.visible,i=>this._viewshedVisualizations.forEach(({visualization:s})=>s.visible=i),T)])}get test(){}};n([l({constructOnly:!0})],Ve.prototype,"analysisViewData",void 0),n([l({constructOnly:!0,nonNullable:!0})],Ve.prototype,"view",void 0),n([l({constructOnly:!0})],Ve.prototype,"isDecoration",void 0),n([l()],Ve.prototype,"visible",null),Ve=n([z("esri.views.3d.analysis.Viewshed.ViewshedAnalysisVisualization")],Ve);var Dt,b=Dt=class extends te{constructor(t){super(t),this.observerRenderSpaceOverride=null}get observer(){return this.viewshed.observer??new xe}get effectiveObserverRenderSpace(){return this.observerRenderSpaceOverride??this.observerRenderSpace}get effectiveObserver(){return this.renderSpaceToPoint(this.effectiveObserverRenderSpace,this.observer.spatialReference)}get effectiveTargetRenderSpace(){return this._computeTargetRenderSpace(this.effectiveObserverRenderSpace)}get farDistance(){return this.viewshed.farDistance}get farDistanceRenderSpace(){return this.farDistance/this.metersPerUnit}get heading(){return this.viewshed.heading}get tilt(){return this.viewshed.tilt}get feature(){return this.viewshed.feature}get tiltParallelToSurface(){return this.tilt-90}get horizontalFieldOfView(){return this.viewshed.horizontalFieldOfView}get verticalFieldOfView(){return this.viewshed.verticalFieldOfView}get observerRenderSpace(){return this._pointToRenderSpace(this.observer,u())}get target(){let t=this.targetRenderSpace;return this.renderSpaceToPoint(t,this.observer.spatialReference)}get targetRenderSpace(){return this._computeTargetRenderSpace(this.observerRenderSpace)}get targetDirection(){let t=R(u(),this.targetRenderSpace,this.observerRenderSpace);return se(t,t)}get tiltedUpVector(){let t=ne(u(),this.upVector,-g(this.tiltParallelToSurface),this.leftVector);return se(t,t)}get _basis(){return this.renderCoordsHelper.basisMatrixAtPosition(this.observerRenderSpace,_())}get upVector(){let t=this._basis;return k(t[8],t[9],t[10])}get northVector(){let t=this._basis;return k(t[4],t[5],t[6])}get leftVector(){let t=this.upVector,e=ne(u(),this.northVector,-g(this.heading),t);return Jt(e,t,e)}get rightVector(){return De(u(),this.leftVector)}clone(){return new Dt({renderCoordsHelper:this.renderCoordsHelper,viewshed:this.viewshed.clone()})}isValid(){return this.viewshed.isValid()}get metersPerUnit(){return this.renderCoordsHelper.spatialReference.metersPerUnit}pointOnSphere(t,e,i){let{observerRenderSpace:s,targetRenderSpace:r}=this,a=R(Ot,r,s);return ne(a,a,-g(e),this.leftVector),ne(a,a,-g(t),this.tiltedUpVector),q(i,a,s)}cornerPoints(t){let e=this.horizontalFieldOfView/2,i=this.verticalFieldOfView/2;this.pointOnSphere(-e,i,t.topLeft),this.pointOnSphere(e,i,t.topRight),this.pointOnSphere(-e,-i,t.bottomLeft),this.pointOnSphere(e,-i,t.bottomRight)}arcCentersPoints(t){let e=this.horizontalFieldOfView/2,i=this.verticalFieldOfView/2;this.pointOnSphere(0,i,t.top),this.pointOnSphere(0,-i,t.bottom),this.pointOnSphere(-e,0,t.left),this.pointOnSphere(e,0,t.right)}parallelCenterPoints(t){let e=this.observerRenderSpace,i=this.farDistanceRenderSpace*Math.sin(g(this.verticalFieldOfView/2)),s=I(Ot,this.tiltedUpVector,i);q(t.top,e,s),R(t.bottom,e,s)}renderSpaceToPoint(t,e){let i=Ot;return this.renderCoordsHelper.fromRenderCoords(t,i,e),new xe(i[0],i[1],i[2],e)}_pointToRenderSpace(t,e){let i=Gt(t.toArray());return this.renderCoordsHelper.toRenderCoords(i,t.spatialReference,e),e}_computeTargetRenderSpace(t){let{leftVector:e,northVector:i,upVector:s}=this,r=this.farDistanceRenderSpace,a=u();return I(a,i,r),ne(a,a,-g(this.heading),s),ne(a,a,-g(this.tiltParallelToSurface),e),q(a,t,a),a}};n([l()],b.prototype,"renderCoordsHelper",void 0),n([l()],b.prototype,"viewshed",void 0),n([l()],b.prototype,"observerRenderSpaceOverride",void 0),n([l()],b.prototype,"observer",null),n([l()],b.prototype,"effectiveObserverRenderSpace",null),n([l()],b.prototype,"effectiveObserver",null),n([l()],b.prototype,"effectiveTargetRenderSpace",null),n([l()],b.prototype,"farDistance",null),n([l()],b.prototype,"farDistanceRenderSpace",null),n([l()],b.prototype,"heading",null),n([l()],b.prototype,"tilt",null),n([l()],b.prototype,"feature",null),n([l()],b.prototype,"tiltParallelToSurface",null),n([l()],b.prototype,"horizontalFieldOfView",null),n([l()],b.prototype,"verticalFieldOfView",null),n([l()],b.prototype,"observerRenderSpace",null),n([l()],b.prototype,"target",null),n([l()],b.prototype,"targetRenderSpace",null),n([l()],b.prototype,"targetDirection",null),n([l()],b.prototype,"tiltedUpVector",null),n([l()],b.prototype,"_basis",null),n([l()],b.prototype,"upVector",null),n([l()],b.prototype,"northVector",null),n([l()],b.prototype,"leftVector",null),n([l()],b.prototype,"rightVector",null),n([l()],b.prototype,"isValid",null),n([l()],b.prototype,"metersPerUnit",null),b=Dt=n([z("esri.views.3d.analysis.Viewshed.ViewshedComputedData")],b);var Ot=u();var pe=class extends oi{constructor(){super(...arguments),this.sectionAngles=Xt()}get sectionAnglesDeg(){return dt(this.sectionAngles.map(t=>fe(t)))}set sectionAnglesDeg(t){this.sectionAngles=dt(t.map(e=>g(e)))}get projectionMatrix(){return L(_(),this.sectionMatrix,this._projectionMatrixInternal)}get sectionMatrix(){let t=this.sectionAngles[0],e=this.sectionAngles[1],i=this.sectionAngles[2],s=this.sectionAngles[3];Le(t<=e),Le(i<=s);let r=2*Math.tan(this.fovX/2),a=2*Math.tan(this.fovY/2),o=Math.tan(t),h=Math.tan(e),d=Math.tan(i),c=h-o,p=Math.tan(s)-d,m=r/c,f=a/p,w=-(o+c/2)/r*2,V=-(d+p/2)/a*2,O=_();ie(O,[w,V,0]);let D=_();ve(D,[m,f,1]);let F=_();return L(F,D,O)}get _sectionRatioX(){let t=Math.tan(this.sectionAngles[0]),e=Math.tan(this.sectionAngles[1]),i=2*Math.tan(this.fovX/2);return Math.min(1,(e-t)/i)}setViewport(t,e){let i=e*this._sectionRatioX;return this.viewport=[t[0],t[1],i,e],i}};n([l()],pe.prototype,"sectionAngles",void 0),n([l()],pe.prototype,"sectionAnglesDeg",null),n([l()],pe.prototype,"projectionMatrix",null),n([l()],pe.prototype,"sectionMatrix",null),n([l()],pe.prototype,"_sectionRatioX",null),pe=n([z("esri.views.3d.webgl-engine.lib.ViewshedFaceCamera")],pe);var Ct=class{constructor(){this.textureSizeQuality=1,this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.textureSizeMultiple=128,this.toleranceSides=5,this.toleranceBottomTop=10}textureSizeModifier(e){let i=e?this.textureSizeModHighQuality:this.textureSizeModLowQuality;return this.textureSizeQuality*i}textureResizeModulo(e){return Math.ceil(e/this.textureSizeMultiple)*this.textureSizeMultiple}},Rt=["front","left","right","back","top","bottom"];function Xs(t){return!["top","bottom"].includes(t)}var ht=class{constructor(e){this._fbos=e,this._minTextureSize=16,this._faces={},this._width=0,this._height=0,this.settings=new Ct,this._maxTextureSize=Math.min(Pt("esri-mobile")?4096:16384,e.rctx.parameters.maxTextureSize)}get depthTexture(){return this._handle?.getTexture()}get ready(){return this.depthTexture!=null&&this._width!==0&&this._height!==0}get nearFar(){let e=this.faces;return e.length===0?null:e[0].nearFar}get numActiveFaces(){let e=this._faces,i=0;return Object.keys(e).forEach(s=>{e[s]&&(i+=1)}),i}get faces(){let e=this._faces,i=[];for(let s of Rt){let r=e[s];r&&i.push(r)}return i}get atlasRegions(){return this.faces.map(e=>[e.x/this._width,(e.x+e.width)/this._width,e.y/this._height,(e.y+e.height)/this._height])}get viewshedProjectionMatrices(){return this.faces.map(e=>e.projectionMatrix)}get viewshedViewMatrices(){return this.faces.map(e=>e.viewMatrix)}_setupFaceCamera(e,i,s,r){let{effectiveObserverRenderSpace:a,tiltedUpVector:o,targetRenderSpace:h,farDistanceRenderSpace:d,horizontalFieldOfView:c,verticalFieldOfView:p}=i,m=u();R(m,h,a);let f=u(),w=u(),V=(M,y)=>{let P=u(),Et=_();return W(Et,M,y),U(P,m,Et),q(P,a,P),P},O,D=o,F=Math.min(90,c),K=Math.min(90,Math.max(0,(c-90)/2)),x=-45,Y=45,Z=-45,ee=45;if(Xs(e)){let M=y=>be(y,-45,45);Z=M(-p/2)-this.settings.toleranceBottomTop,ee=M(+p/2)+this.settings.toleranceBottomTop}switch(e){case"front":O=h,x=-F/2,Y=F/2;break;case"left":O=V(Math.PI/2,o),x=45-K;break;case"right":O=V(-Math.PI/2,o),Y=-45+K;break;case"top":O=q(f,a,o),D=De(w,m);break;case"bottom":O=R(f,a,o),D=m;break;case"back":O=V(Math.PI,o)}let ue=new pe({center:O,eye:a,up:D,far:d});ue.sectionAnglesDeg=[x-this.settings.toleranceSides,Y+this.settings.toleranceSides,Z,ee],ue.fovY=Math.PI/2;let S=ue.setViewport(s,r);return this._faces[e]=ue,S}isActive(e){return this._computeActiveFaces(e).size>0}_computeActiveFaces(e){let i=new Set,{horizontalFieldOfView:s,verticalFieldOfView:r}=e,a=-r/2,o=r/2;return s===0||r===0||(a<=45&&o>=-45&&i.add("front"),s>90&&(i.add("left"),i.add("right")),s>270&&i.add("back"),o>45-this.settings.toleranceBottomTop&&i.add("top"),a<-45+this.settings.toleranceBottomTop&&i.add("bottom")),i}_computeBaseTextureSize(e,i,s,r){let a=i/e.pixelRatio,o=this.settings.textureSizeModifier(s),h=Math.max(e.fullWidth,e.fullHeight),d=fi(Math.floor(h*a*o)),c=Math.floor(this._maxTextureSize/r),p=be(d,this._minTextureSize,c);return vi(p)}_ensureFBO(e){let i=this._width,s=this._height;this._handle?.fbo?.width===i&&this._handle?.fbo?.height===s||(this._handle?.release(),this._handle=this._fbos.acquire(i,s,"viewshed shadow map",ft.RGBA4));let r=e?vt.DEPTH_STENCIL_TEXTURE:vt.DEPTH16_BUFFER;this._handle.acquireDepth(r)}clearFBO(e){let i=this._fbos.rctx;this._ensureFBO(e),i.bindFramebuffer(this._handle?.fbo),i.setClearColor(1,1,1,1),i.clear(ut.COLOR|ut.DEPTH)}dispose(){this._handle=Lt(this._handle)}start(e,i,s,r,a=!1){this._faces={};let o=this._computeActiveFaces(i),h=o.size;if(h===0)return!1;let d=this._computeBaseTextureSize(e,r,s,h),c=0,p=0,m=0;return Rt.filter(f=>o.has(f)).forEach(f=>{let w=Qs(f,h);w>p&&(m=Math.max(m,c),c=0),p=w;let V=w*d;c+=this._setupFaceCamera(f,i,[c,V],d)}),m=Math.max(m,c),this._width=this.settings.textureResizeModulo(m),this._height=Ks(h)*d,this.clearFBO(a),!0}finish(){this._handle?.detachDepth()}get test(){return{faces:this._faces,faceTypes:Rt,width:this._width,height:this._height,getFBO:()=>this._fbos.acquire(this._width,this._height,"viewshed shadow map",ft.RGBA4)}}};function Qs(t,e){if(e<4)return 0;let i=t==="front"||t==="left";return e===4?i?0:1:i||t==="right"?0:1}function Ks(t){return t<4?1:2}var qe=class extends pi{constructor(e,i){super(e,i,new li($i,()=>import("./chunk-QOOXRHEL.js")))}initializePipeline(){return di({colorWrite:ci,blending:hi})}};var $=class extends ui{get shadowMap(){return this._shadowMap}get hasViewsheds(){return this._viewsheds.length>0}get _contentPixelRatio(){return this.view.state.contentPixelRatio}get _viewshedsInView(){return this._viewsheds.items.filter(t=>Js(this.view,t))}constructor(t){super(t),this._passParameters=new Ji,this._viewsheds=new Wt,this._shadowMap=null,this.consumes={required:[$e.VIEWSHED,"normals"]},this.produces=$e.VIEWSHED,this.requireGeometryDepth=!0}initialize(){this._shadowMap=new ht(this.fboCache),this.addHandles([v(()=>this.view.resolutionScale,t=>{let e=this._shadowMap;e&&(e.settings.textureSizeQuality=t)},T),Te(()=>!this.hasViewsheds,()=>this._shadowMap?.dispose()),v(()=>this._viewshedsInView.map(t=>[t.observerRenderSpace,t.heading,t.tilt,t.farDistance,t.horizontalFieldOfView,t.verticalFieldOfView]),()=>this.requestRender(mt.UPDATE),Qe)])}destroy(){this._shadowMap=zt(this._shadowMap)}precompile(){if(this.hasViewsheds){this.techniques.precompile(qe);for(let t of this._viewshedsInView)if(this._shadowMap?.isActive(t))return void this.view._stage.renderer.precompileViewshedShadowMap()}}render(t){let e=this.bindParameters,i=this.renderingContext,s=t.find(({name:o})=>o===$e.VIEWSHED);if(!this.hasViewsheds||!e.depth)return s;this._passParameters.shadowMap=this._shadowMap??this._passParameters.shadowMap,this._passParameters.normals=t.find(({name:o})=>o==="normals")?.getTexture();let r=this.techniques.get(qe);if(!r?.compiled)return this.requestRender(mt.UPDATE),s;let a=this.view._stage.renderer.isFeatureEnabled(Zi.HighResolutionViewshed);for(let o of this._viewshedsInView){if(!this._renderShadowCubeMap(e,o,a)||!this._shadowMap?.ready)continue;let h=this._setupViewshedParameters(o,e.camera);i.bindTechnique(r,e,h),i.bindFramebuffer(s.fbo),i.screen.draw()}return this.shadowMap?.dispose(),s}updateViewsheds(t){let e=this._viewsheds,{removes:i,adds:s}=t;if(i&&(Array.isArray(i)?e.removeMany(i):e.remove(i)),s)if(Array.isArray(s)){let r=s.filter(a=>!e.includes(a));e.addMany(r)}else e.includes(s)||e.add(s)}_renderShadowCubeMap(t,e,i){let s=this._shadowMap;if(!s)return!1;let r=this.view.basemapTerrain.hasStencilEnabledExtents,a=s.start(t.camera,e,i,this._contentPixelRatio,r);return a&&s.faces.forEach(o=>this.view._stage.renderer.renderViewshedShadowMap(o)),s.finish(),a}_setupViewshedParameters(t,e){let i=this._shadowMap;if(!i)return this._passParameters;let s=this._passParameters,r=t.effectiveObserverRenderSpace;s.localOrigin=r,s.observerOffset=R(er,t.observerRenderSpace,t.effectiveObserverRenderSpace),s.fovs=[g(t.horizontalFieldOfView),g(t.verticalFieldOfView)],s.headingAndTilt=[g(t.heading),g(t.tiltParallelToSurface)],s.upVector=t.tiltedUpVector;let a=Ys(t.targetRenderSpace,r);s.targetVector=a;let o=new Array,h=new Array;for(let d=0;d<i.numActiveFaces;d++)qt(At,i.viewshedViewMatrices[d],r),o.push(...At),Zs(i.viewshedProjectionMatrices[d],At,Ms),h.push(...Ms);return s.viewMatrices=o,s.projectionMatrices=h,s.volumeOffset=this.selectedViewshed?.()===t.viewshed?$s(t,this.view,e.eye):0,s}get test(){return{viewsheds:this._viewsheds,shadowMap:this._shadowMap,viewshedsInView:this._viewshedsInView}}};function Ys(t,e){let i=u();return R(i,t,e)}function Zs(t,e,i){let s=k(.5,.5,.5);return ie(i,s),Nt(i,i,s),L(i,i,t),L(i,i,e),i}function Js(t,e){let i=ai(e.observerRenderSpace,e.farDistanceRenderSpace);return!!t.ready&&t.frustum.intersectsSphere(i)}function $s(t,e,i){if(t==null)return 0;let{observerRenderSpace:s,targetRenderSpace:r}=t,a=pt(i,s)>pt(i,r)?t.observer:t.target;return e.pixelSizeAt(a)}n([l()],$.prototype,"selectedViewshed",void 0),n([l()],$.prototype,"shadowMap",null),n([l()],$.prototype,"hasViewsheds",null),n([l()],$.prototype,"_contentPixelRatio",null),n([l()],$.prototype,"_viewshedsInView",null),n([l()],$.prototype,"consumes",void 0),n([l()],$.prototype,"produces",void 0),$=n([z("esri.views.3d.webgl-engine.lib.Viewshed")],$);var er=u(),At=_(),Ms=_();var Q=class extends Oi(te){constructor(t){super(t),this.type="viewshed-view-3d",this.analysis=null,this.tool=null,this._selectedViewshed=null,this.viewshedComputedDataHandles=null,this._placementTask=null,this._viewshedRenderer=null,this._intersector=null}get selectedViewshed(){return this._selectedViewshed}set selectedViewshed(t){this._unselectOtherViewsheds(t),this._selectedViewshed=t}get selectedViewshedComputedData(){return this.tool?.selectedViewshedComputedData}initialize(){let t=this.view;this._viewshedRenderer=new $({view:t,selectedViewshed:()=>this.selectedViewshed??this.tool?.stagedViewshed}),this._intersector=mi(this.view.state.viewingMode),this._intersector.options.hud=!1,this._intersector.options.store=ni.MIN,this.viewshedComputedDataHandles=Oe(()=>this.analysis.viewsheds,e=>{let i=new b({renderCoordsHelper:t.renderCoordsHelper,viewshed:e}),s=Symbol();return this.addHandles([v(()=>({valid:i.isValid(),canProject:Yt(i.observer?.spatialReference,this.view.spatialReference)||Qt()}),({valid:r,canProject:a},o)=>{this.visible&&(r&&a?this._addViewshedsToRenderer(i):o?.valid&&o?.canProject&&this._removeViewshedsFromRenderer(i),a||Di(this.analysis,i.observer.spatialReference,Ht.getLogger(this)))},T),v(()=>[t.state.camera,t.slicePlane,i.viewshed.observer,i.targetRenderSpace,i.verticalFieldOfView,i.horizontalFieldOfView,i.feature],()=>{this._updateObserverFromFeature(t,i)},T)]),{viewshedComputedData:i,remove:()=>{this.removeHandles(s),this._removeViewshedsFromRenderer(i),i.destroy()}}}),this._analysisVisualization=new Ve({view:t,analysisViewData:this,isDecoration:!this.parent}),this.addHandles([v(()=>this.visible,e=>{let i=this.viewshedComputedDataHandles;if(i==null)return;e||(this.selectedViewshed=null);let s=i.map(r=>r.viewshedComputedData).filter(r=>r.isValid()).toArray();e?this._addViewshedsToRenderer(s):this._removeViewshedsFromRenderer(s)}),v(()=>t.renderCoordsHelper,e=>{this.viewshedComputedDataHandles?.forEach(({viewshedComputedData:i})=>i.renderCoordsHelper=e)}),Gi(this,We),Te(()=>this.interactive,()=>{this._unselectOtherViewsheds(this.selectedViewshed)},he)])}destroy(){this._placementTask=Se(this._placementTask),qi(this),this._analysisVisualization=C(this._analysisVisualization);let t=this.viewshedComputedDataHandles;t!=null&&this._removeViewshedsFromRenderer(t.map(e=>e.viewshedComputedData).toArray())}createViewsheds(t){return Ne(this,null,function*(){return this._placementTask=Se(this._placementTask),this._placementTask=Wi(this,t),this.tool!=null&&this.tool.createViewsheds(),yield this._placementTask.promise})}_addViewshedsToRenderer(t){this._viewshedRenderer.updateViewsheds({adds:t})}_removeViewshedsFromRenderer(t){this._viewshedRenderer.updateViewsheds({removes:t})}_updateObserverFromFeature(t,e){let i=e.observerRenderSpace,s=e.targetRenderSpace,r=j(u(),i),a={observer:i,observerSurfaceNormal:null,observerAdjusted:r,observerFeatureId:yi(e.feature),target:s,targetSurfaceNormal:null,targetAdjusted:j(u(),s),targetFeatureId:null};Si(t,this._intersector,a,o=>Math.min(o,.05*e.farDistanceRenderSpace)),e.observerRenderSpaceOverride=$t(r,i)?null:r}_unselectOtherViewsheds(t){if(t!=null)for(let e of this.view.tools.items)e!==this.tool&&e instanceof We&&(e.analysisViewData.selectedViewshed=null)}get test(){}};n([l({readOnly:!0})],Q.prototype,"type",void 0),n([l({constructOnly:!0,nonNullable:!0})],Q.prototype,"analysis",void 0),n([l()],Q.prototype,"tool",void 0),n([l()],Q.prototype,"_selectedViewshed",void 0),n([l()],Q.prototype,"selectedViewshed",null),n([l()],Q.prototype,"selectedViewshedComputedData",null),n([l()],Q.prototype,"viewshedComputedDataHandles",void 0),n([l()],Q.prototype,"_analysisVisualization",void 0),n([l()],Q.prototype,"_placementTask",void 0),n([l()],Q.prototype,"_viewshedRenderer",void 0),Q=n([z("esri.views.3d.analysis.ViewshedAnalysisView3D")],Q);var Fh=Q;export{Fh as default};
