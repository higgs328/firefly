import{c as Ae}from"./chunk-ETLJEDNA.js";import{a as _e}from"./chunk-QW25UBG2.js";import{a as be}from"./chunk-2XCEJBGD.js";import{a as we}from"./chunk-UZ6PRO67.js";import{a as ye}from"./chunk-KDY6S22B.js";import{a as ge}from"./chunk-GXPTMWWM.js";import{a as N}from"./chunk-KPGBL7TL.js";import{a as me}from"./chunk-IBQD5DMC.js";import{a as fe}from"./chunk-7F42SXKP.js";import{a as S}from"./chunk-7XYYDAZO.js";import{c as pe}from"./chunk-7NTCDIVV.js";import{G as he,H as m,I as ue,c as M,p as H,v as q,w as j}from"./chunk-3WNFY6Z5.js";import{a as ce}from"./chunk-2WYOVBUR.js";import{b as A,y as te}from"./chunk-XR5FT7TQ.js";import{a as T}from"./chunk-LAX5536Z.js";import{a as ne}from"./chunk-DO7UF2F2.js";import{a as oe}from"./chunk-K57Z4J34.js";import{a as D}from"./chunk-CZ6CGC7I.js";import{a as v}from"./chunk-BPWNCOXC.js";import{a as le}from"./chunk-AVMO6LCR.js";import{f as ae,g as L}from"./chunk-DA3SDKGO.js";import{b as ie,c as x}from"./chunk-ZC6EBRE4.js";import{b as re}from"./chunk-PQGCNP5H.js";import{a as se}from"./chunk-U4QEPZJ3.js";import{a as de}from"./chunk-DKGGDYJI.js";import{a as _}from"./chunk-7F5DJLJT.js";import{b as V}from"./chunk-UST6HCE7.js";import{d as X}from"./chunk-KNVXE32P.js";import{e as ee}from"./chunk-TG45K3WR.js";import{b as R}from"./chunk-ACP3S2CH.js";import{a as Y}from"./chunk-T7DXJKX7.js";import{a as u}from"./chunk-QGVBCWUY.js";import{c as K}from"./chunk-MYO4NP2N.js";import{e as d}from"./chunk-NFIPKH6V.js";import{l as Q}from"./chunk-5QEXLALV.js";import{b as E}from"./chunk-YOFFGXOB.js";import{g as U}from"./chunk-XRGPJ3QY.js";import{a as g,f as h}from"./chunk-VTHXE323.js";function z(t){return t.type==="polygon"||t.type==="polyline"}function Re(t){return t.hasOwnProperty("points")}function Le(t){return Re(t)&&t.points.length===2}var f=class{createBuffer(e,r,s,i){if(Array.isArray(e)){if(e.length>0){let l=_.fromJSON(e[0].spatialReference);return l.isWGS84||l.isWebMercator?j(e,r,s,i):q(e,r,s,i)}return}let a=_.fromJSON(e.spatialReference);return a.isWGS84||a.isWebMercator?j(e,r[0],s):q(e,r[0],s)}createConvexHull(e){if(Array.isArray(e)){if(e.length===1&&Le(e[0])){let s=H(e[0]);if(z(s))return s}return H(e,!0).filter(z)}let r=H(e);if(z(r))return r}calculateArea(e,r){let s=new _({wkid:e.spatialReference.wkid});return s.isWGS84||s.isWebMercator?parseFloat(ue(e,r).toFixed(2)):parseFloat(he(e,r).toFixed(2))}mergeAggregatedToGeometries(e){let r=[],{line:s,multipoint:i,polygon:a}=e;return s&&r.push(s),i&&r.push(i),a&&r.push(a),r}getPercentageAlong(e,r,s){let i=e,a=this._createPolyline(e.paths,s.wkid);if(r.type==="point"){let o=r.x-.5,n=r.x+.5,y=[[[o,r.y-.5],[n,r.y+.5]]];i=this._createPolyline(y,r.spatialReference.wkid),i=L(i,s);let p=M(a,i);if(p.length>0){let b=m(a,"feet"),Z;return Z=p[0].paths[0][0][0]===a.paths[0][0][0]?m(p[0],"feet"):m(p[1],"feet"),[Z/b]}return[.5]}i=L(r,s);let l=M(a,i);if(l.length>0){let o=m(a,"feet");return[m(l[0],"feet")/o]}return[.5]}projectGeometry(e,r){return h(this,null,function*(){return yield ae(),L(e,r)})}_createPolyline(e,r){return new se({hasZ:!1,hasM:!0,paths:e,spatialReference:new _({wkid:r})})}};var W=[227,27,21,.6],$=[21,244,21,.6],P=12,ve=[{color:[255,0,0,.6],haloOpacity:.9,fillOpacity:.2,hex:"#ff0000"},{color:[255,0,255,.6],haloOpacity:.9,fillOpacity:.2,hex:"#ff00ff"},{color:[217,188,255,.6],haloOpacity:.9,fillOpacity:.2,hex:"#D9BCFF"},{color:[0,255,0,.6],haloOpacity:.9,fillOpacity:.2,hex:"#00ff00"},{color:[255,255,0,.6],haloOpacity:.9,fillOpacity:.2,hex:"#ffff00"},{color:[0,0,255,.6],haloOpacity:.9,fillOpacity:.2,hex:"#0000ff"},{color:[255,165,0,.5],haloOpacity:.9,fillOpacity:.2,hex:"#ffa500"},{color:[0,0,0,.5],haloOpacity:.9,fillOpacity:.2,hex:"#000000"}],B=class{constructor(){this.highlightColor=[...ve]}addCustomColor(e){this.highlightColor=[...ve],this.highlightColor.some(r=>r.hex.toLowerCase()===e.hex.toLowerCase())||this.highlightColor.push(e)}getFlagGraphic(e,r,s,i){let a=r==="starting-point"?$:W;if(e.type==="polygon"){let l=e;l.centroid&&(e=l.centroid)}return i?this.makeGraphic(e,a,s?.attributes,null,i):this.makeGraphic(e,a,s?.attributes)}initializeSketch(e,r,s){let i=new R;return s.forEach(a=>i.add(new we({layer:a,enabled:!0}))),new Ae({layer:r,view:e,snappingOptions:new be({enabled:!0,featureEnabled:!0,featureSources:i})})}makeGraphic(e,r,s,i,a){let l,o=e;switch(e.type){case"multipoint":l=new D({color:r,size:P,outline:{color:r,width:0}}),i&&(o=e);break;case"point":l=a||new D({color:r,size:P,outline:{color:r,width:0}}),i&&(o=e);break;case"polyline":l=new le({color:r,width:P}),i&&(o=e);break;case"polygon":l=new v({color:r,outline:{color:r,width:P}}),i&&(o=e)}return new T({geometry:o,symbol:l,attributes:s??null})}};var w=`utility-network-trace-result-area-${Date.now()}`;function k(t){return t.type==="graphics"}var C=class{constructor(){this.traceInformation={},this._geometryHandler=new f}addResultAreaToMap(e,r){let s=this.createGraphicLayer(r);s&&k(s)&&s.add(e)}changeResultAreaColor(e,r,s){let i=new v({color:r.color,style:"solid",outline:{color:r.color,width:1}}),a=this._findGraphicsByTraceId(e,s);return a&&a.forEach(l=>{l.symbol=i}),i}createBuffer(e,r,s,i){return this._geometryHandler.createBuffer(e,r,s,i)}createConvexHull(e,r,s){let i=this._geometryHandler.createConvexHull(e);return r>0&&i?this.createBuffer(i,[r],s,!1):i}createResultAreaGraphic(e,r,s,i,a,l){let o=new v({color:l.color,style:"solid",outline:{color:l.color,width:1}}),n=[];for(let y in r)n.push(new oe({fieldName:y,label:y==="areaStatistic"?i.attributeStrings[y]+" ("+a.units[s]?.abbr+")":i.attributeStrings[y]}));return new T({geometry:e,symbol:o,attributes:r,popupTemplate:new ne({title:r.traceName,content:[{type:"fields",fieldInfos:n}]})})}removeResultArea(e,r){let s=r.findLayerById(w);if(s&&k(s)){let i=this._findGraphicsByTraceId(e,r);return i&&s.removeMany(i),i}return null}removeAllResultAreaGraphics(e){if(e){let r=e.findLayerById(w);r&&k(r)&&r.removeAll()}}createGraphicLayer(e,r){let s=e.findLayerById(w);if(s&&k(s))return s;let i=new S({title:r??w,listMode:"hide",id:w});return e.add(i),i}_findGraphicsByTraceId(e,r){let s=r.findLayerById(w);if(s&&k(s)){let i=s.graphics.filter(a=>a.attributes.traceId===e);return i.length>0?i.toArray():null}return null}};function ke(t){return t.type==="feature"}function J(t,e){return t.url.includes(e)}function Ge(t,e){return(t.dataElement?.domainNetworks||[]).some(r=>r.subnetworkLayerId===e.layerId)}var O=class{getValidUtilityNetworkLayers(e,r){let s=[];return e?.allLayers.forEach(i=>{i.type==="group"?s.push(...i.layers.filter(A).filter(a=>ke(a)&&r.isUtilityLayer(a)&&!Ge(r,a)).filter(a=>J(a,r.featureServiceUrl)).toArray()):i.type==="subtype-group"?s.push(...i.sublayers.filter(a=>J(a,r.featureServiceUrl)).toArray()):A(i)&&ke(i)&&r.isUtilityLayer(i)&&!Ge(r,i)&&J(i,r.featureServiceUrl)&&s.push(i)}),s}};var Te=()=>V("esri/widgets/UtilityNetworkTrace/t9n/UtilityNetworkTrace"),He=()=>V("esri/core/t9n/Units"),G=`utility-network-trace-flags-${Date.now()}`,I=`utility-network-trace-results-${Date.now()}`,F=`utility-network-trace-sketch-${Date.now()}`;function Se(t){return t instanceof re}function Ne(t){return t.layer.type==="feature"||t.layer.type==="subtype-group"}function Pe(t){return"layer"in t}function Ie(t){return t.layerViews!==void 0}function Be(t){return t.type==="graphics"}function Fe(t){return t.type==="feature"||t.type==="subtype-group"||t.type==="group"}function Ce(t){return h(this,null,function*(){let e=new ce({url:t.networkSystemLayers.dirtyAreasLayerUrl});yield e.load();let r=e.version;if(Number(r)<=11.1){let s=yield te(t.layerUrl),i=new de({url:s});yield i.load();let a=i?.user?.username;return!!a&&pe(i,a,"utilityNetwork")}return!0})}var c=class extends Y.EventedAccessor{constructor(t){super(t),this._activeProgress=!1,this._clickHandler=null,this._flags=[],this._flagId=0,this._geometryHandler=null,this._highlightHandler=[],this._resultAreaHandler=null,this._sketchViewModel=null,this._traceTimeout=6e5,this._utilityHelper=new O,this._validUNLayers=[],this._watchHandler=null,this.traces=[],this.graphicHandler=null,this.defaultGraphicColor={color:[255,255,0,.6],haloOpacity:.9,fillOpacity:.2,hex:"#FFFF00"},this.enableResultArea=!1,this.flags=[],this.gdbVersion="sde.DEFAULT",this.messages=null,this.messagesUnits=null,this.defaultResultAreaProperties={type:"convexhull",distance:10,unit:"meters",areaUnit:"square-meters",color:{color:[255,165,0,.5],haloOpacity:.9,fillOpacity:.2,hex:"#ffa500"},show:!1},this.selectedTraces=[],this.selectOnComplete=!0,this.showGraphicsOnComplete=!0,this.showSelectionAttributes=!0,this.traceResults=[],this.utilityNetwork=null}initialize(){K(U.getLogger(this),"gdbVersion will be removed and the gdbVersion of the UtilityNetwork will be consumed directly.",{replacement:"UtilityNetwork.gdbVersion",version:"4.31"}),this._geometryHandler=new f,this.graphicHandler=new B,this._resultAreaHandler=new C,h(this,null,function*(){let[t,e]=yield Promise.all([Te(),He()]);this.set({messages:t,messagesUnits:e})})}destroy(){this.view=null}get resultAreaProperties(){return this.defaultResultAreaProperties}set resultAreaProperties(t){this._set("resultAreaProperties",g(g({},this.defaultResultAreaProperties),t)),this.graphicHandler.addCustomColor(this.resultAreaProperties.color),this.traceResults.forEach(e=>{let r=e.resultArea?.show;e.resultArea=g(g({},this.defaultResultAreaProperties),t),this.removeResultAreaFromMap(e),this.enableResultArea&&this.createResultAreaGraphic(e).then(s=>{if(s){e.resultAreaGraphic=s;let i=t?.show??r;e.resultArea&&(e.resultArea.show=i),i&&this.addResultAreaToMap(e,s)}})})}get state(){return this.view?.ready?"ready":"loading"}get view(){return this._get("view")}set view(t){t&&t.type!=="2d"&&U.getLogger(this).error(new E("view:invalid-view","SceneView is not supported",{view:t})),this._set("view",t),this.utilityNetwork&&this.reset(),this.utilityNetwork=null,this.loadUtilityNetwork().then(e=>{e&&this.selectTracesOnLoad()})}addFlagByHit(t,e){let r=!!this.view&&this.view.popupEnabled,s=i=>{this.view?.popup&&(this.view.popupEnabled=i)};return new Promise((i,a)=>{r&&s(!1),this._clickHandler?.remove(),this._clickHandler=this._sketchViewModel.on("create",l=>{if(l.state==="complete"){let o=this._getGraphicLayer(F);o&&l.graphic&&o.remove(l.graphic),this.queryFlagByHitTest(l,t,e).then(n=>{this.emit("add-flag-complete",{type:t,symbol:e}),i(n)}).catch(n=>{this.emit("add-flag-error",{type:t,symbol:e}),a(n)}).finally(()=>{r&&s(!0),this._clickHandler?.remove()})}}),this._sketchViewModel.create("point"),this.emit("add-flag",{type:t})})}addNonspatialTraceLocation(t,e){let r=this._getDisplayField(t),s=this.utilityNetwork?.getTerminalConfiguration(t),i={terminalId:null,isFilterBarrier:!1,allTerminals:s,selectedTerminals:[s?s.terminals[0].id||null:1],displayValue:r};t.attributes=g(g({},t.attributes),i);let a=t.attributes.hasOwnProperty("GLOBALID")?t.attributes.GLOBALID:t.attributes.globalid;if(!this._flags.some(l=>l.globalId===a&&l.type===e)){let l=this._createFlagProperty(t,e,null);this._flags.push(l),this.emit("add-flag-complete",{type:e})}this.emit("add-flag",{type:e})}addFlagsOnLoad(){return h(this,null,function*(){return this._flags.length>0?[]:(yield ee(()=>this.view!=null&&!this.view.updating),(yield Promise.all(this.flags.map(t=>h(this,null,function*(){if(!t.mapPoint)return null;let{type:e}=t,r=t.mapPoint.clone(),s=e==="barrier"?W:$,i={graphic:this.graphicHandler.makeGraphic(r,s),state:"complete",tool:"point",toolEventInfo:null,type:"create"};try{return yield this.queryFlagByHitTest(i,t.type,null),this.emit("add-flag-complete",{type:e}),null}catch{return this.emit("add-flag-error",{type:e}),e==="barrier"?"barrier":"starting-point"}})))).filter(t=>!t))})}addResultAreaToMap(t,e){return h(this,null,function*(){if(this.view){if(t.resultArea.show=!0,e)this._resultAreaHandler?.addResultAreaToMap(e,this.view.map),this.emit("add-result-area",{graphic:e});else if(t.results){let r=yield this.createResultAreaGraphic(t);r&&(t.resultAreaGraphic=r,this._resultAreaHandler?.addResultAreaToMap(r,this.view.map),this.emit("add-result-area",{graphic:r}))}}})}addResultGraphicToView(t,e){return h(this,null,function*(){let{view:r}=this,{results:s}=t;if(r&&s&&this.utilityNetwork){for(let i in s.aggregatedGeometry)if("line,multipoint,polygon".includes(i)){let a=i,l=s.aggregatedGeometry[a];if(l!=null){l.spatialReference=this.utilityNetwork.spatialReference,t.graphicEnabled=!0;let o=yield this._geometryHandler.projectGeometry(l,r.spatialReference),n={globalid:t.trace.globalId};if(o!==null){let y=this.graphicHandler.makeGraphic(o,e.color,n,r.spatialReference);this._getGraphicLayer(I)?.add(y)}}}}})}addTerminal(t,e){let r=[...this._flags];r.forEach(s=>{s.globalId===e.globalId&&(e.selectedTerminals?.includes(parseInt(t,10))||s.selectedTerminals?.push(parseInt(t,10)))}),this._flags=r}callTrace(){return h(this,null,function*(){let t=this.traces.filter(e=>e.selected);return!!t.length&&(this.traceResults.length>0&&this.traceResults.forEach(e=>{this.removeResultGraphicFromView(e)}),this.traceResults=[],this.removeSelection(),yield Promise.all(t.map((e,r)=>h(this,null,function*(){let s=e,i=new ge({gdbVersion:this.utilityNetwork?.gdbVersion,moment:this.utilityNetwork?.historicMoment,namedTraceConfigurationGlobalId:s.globalId,outSpatialReference:null,resultTypes:null,traceType:s.traceType,traceLocations:this._flags,traceConfiguration:null});yield this.executeTrace(s,this.utilityNetwork?.networkServiceUrl,i).then(a=>{if(a.hasOwnProperty("results")){let l=g({},a);if(l.results!==null){l.resultArea=g({},this.resultAreaProperties);let o=[...l.results.elements];l.results.elements.length=0;let n=new Map;for(let p of o)n.has(p.globalId)||(n.set(p.globalId,!0),l.results.elements.push(p));let y=[...this.traceResults];y.splice(r,0,l),this.traceResults=y,l.results!==null&&(this.selectOnComplete&&this.mergeSelection(!0,l.trace),this.showGraphicsOnComplete&&this.addResultGraphicToView(l,l.graphicColor),this.enableResultArea&&this.createResultAreaGraphic(l).then(p=>{p&&(l.resultAreaGraphic=p,l.resultArea?.show&&this.addResultAreaToMap(l,l.resultAreaGraphic))}))}else{let o=[...this.traceResults];o.splice(r,0,a),this.traceResults=o}this._activeProgress=!1}else{this._activeProgress=!1;let l=[...this.traceResults];l.splice(r,0,a),this.traceResults=l}}).catch(a=>{throw this._activeProgress=!1,a})}))),!0)})}cancelAddFlagByHit(){this._sketchViewModel.cancel()}changeResultAreaColor(t,e){if(!t.resultArea)return;t.resultArea.color=e;let r=this._resultAreaHandler?.changeResultAreaColor(t.trace.globalId,e,this.view.map);t.resultAreaGraphic&&(t.resultAreaGraphic.symbol=r)}changeResultGraphicColor(t,e){let r=[...this.traceResults];r.length>0&&r.forEach(s=>{s.trace.globalId===e.trace.globalId&&(s.graphicColor=t,s.graphicEnabled=!0)}),this.traceResults=r,this.removeResultGraphicFromView(e),this.addResultGraphicToView(e,t)}changeFlagSymbol(t,e){this._flags.length>0&&this._flags.forEach(r=>{r.type===t&&e&&r.mapGraphic&&(r.mapGraphic.symbol=e)})}checkCanTrace(){let t={status:!0,issues:[]};return this.traces.filter(r=>r.selected).length||(t.status=!1,t.issues.push("noTracesSelected")),this._flags.some(r=>r.type==="starting-point")||(t.status=!1,t.issues.push("noStartingPoints")),this._flags.filter(r=>r.allTerminals!==null).some(r=>!r.selectedTerminals.length)&&(t.status=!1,t.issues.push("noTerminalSelected")),t}checkSelectionExist(){return this._highlightHandler.some(t=>t)}clearResult(t){if(!this.view)return;let e=this.traceResults;if(e.length>0){let r=e.filter(s=>s.trace.globalId===t.globalId);r.length>0&&(this.removeResultGraphicFromView(r[0]),this.removeResultAreaFromMap(r[0])),e=e.filter(s=>s.trace.globalId!==t.globalId)}this.traceResults=e,e.length===0?(this.removeAllResultAreaGraphics(),this.removeSelection(),this.emit("clear-selection",{resultSet:[]})):this.mergeSelection(!1,t)}createResultAreaGeometries(t,e,r){if(!this.view||!this.resultAreaProperties)return;let s;if(s=this.resultAreaProperties?.type==="convexhull"?e.length===1&&(x(e[0])||ie(e[0])&&e[0].points.length===1)?this._resultAreaHandler?.createBuffer(e,r,t.resultArea?.unit,!0):this._resultAreaHandler?.createConvexHull(e,t.resultArea?.distance,t.resultArea?.unit):this._resultAreaHandler?.createBuffer(e,r,t.resultArea?.unit,!0),!s)return;if(Array.isArray(s)){for(let a of s){let l=this.getResultAreaAttributes(t,a),o=this._resultAreaHandler?.createResultAreaGraphic(a,l,t.resultArea?.areaUnit,this.messages,this.messagesUnits,t.resultArea?.color);if(o)return o}return}let i=this.getResultAreaAttributes(t,s);return this._resultAreaHandler?.createResultAreaGraphic(s,i,t.resultArea?.areaUnit,this.messages,this.messagesUnits,t.resultArea?.color)}createResultAreaGraphic(t){return h(this,null,function*(){if(t.results){let e=yield this._createResultAreaInputGeometry(t.results);if(e.length>0){let r=Array(e.length).fill(t.resultArea?.distance),s=this.createResultAreaGeometries(t,e,r);return this.emit("create-result-area",{graphic:s}),s}}})}executeTrace(t,e,r){let s=this._processFlags(r.traceLocations);return r.traceLocations=s,ye(e,r,{timeout:this._traceTimeout}).then(i=>({trace:t,results:i,selectionEnabled:!1,graphicEnabled:!1,graphicColor:this.defaultGraphicColor,status:"success",date:new Date})).catch(i=>({trace:t,results:null,selectionEnabled:!1,graphicEnabled:!1,graphicColor:this.defaultGraphicColor,status:i.message,date:new Date}))}getNonspatialTraceLocationInitialFeature(){return h(this,null,function*(){return new Promise((t,e)=>{this._clickHandler?.remove(),this._clickHandler=this._sketchViewModel.on("create",r=>h(this,null,function*(){if(r.state!=="complete")return;let s=this._getGraphicLayer(F);s&&r.graphic&&s.remove(r.graphic);let i=this.view?.toScreen(r.graphic?.geometry);if(!i)return;let a=yield this.view?.hitTest(i);if(a?.results.length){let l=a.results.find(o=>o.type==="graphic"&&this.utilityNetwork?.isUtilityLayer(o.layer));l?t(l):e(null)}})),this._sketchViewModel.create("point")})})}getResultAreaAttributes(t,e){let{messages:r}=this,s=[],i=[];this._flags.forEach(l=>{let o=l.displayValue?.field+":"+l.displayValue?.value+";"+r.attributeStrings.globalid+":"+l.globalId+";"+r.attributeStrings.terminalid+":"+l.terminalId+";"+r.attributeStrings.x+":"+l.mapPoint?.x+";"+r.attributeStrings.y+":"+l.mapPoint?.y;l.type==="starting-point"?s.push(o):i.push(o)});let a=this.utilityNetwork?this.utilityNetwork.gdbVersion:this.gdbVersion;return{traceId:t.trace.globalId,traceName:t.trace.title,traceDescription:t.trace.description??"",startingPoints:s.toString(),barriers:i.toString(),version:a??void 0,username:X.credentials[0].userId,date:t.date,elementCount:t.results?.elements.length,functionResult:JSON.stringify(t.results?.globalFunctionResults),areaStatistic:e?this._geometryHandler.calculateArea(e,t.resultArea?.areaUnit):0}}getValidSources(){let t=[],e=this.utilityNetwork?.dataElement?.domainNetworks??[];for(let r of e)t=t.concat(r.junctionSources),t=t.concat(r.edgeSources);return t}groupResultsByNetworkSource(t){return t.length===0?[]:this._groupBy(t,"networkSourceId")}loadUtilityNetwork(){return h(this,null,function*(){let{view:t}=this;if(!t)return null;if(yield t.when(),this.utilityNetwork){if(this.utilityNetwork.loaded||(yield this.utilityNetwork.load()),this.utilityNetwork instanceof me){try{yield t.map.loadAll()}catch(s){if(s.name!=="layer:unsupported-layer-type")throw s}finally{this._loadUNSupportItems()}return this.utilityNetwork}return null}let e=t.map,r=e.utilityNetworks?.at(0);if(r){if(yield r.load(),this.utilityNetwork=r,!(yield Ce(r)))throw new E("utility-network:no-user-type-extension","User type extension not found");try{yield e.loadAll()}catch(s){if(s.name!=="layer:unsupported-layer-type")throw s}finally{this._loadUNSupportItems()}return r}return null})}manageFilterBarrier(t,e){let r=[...this._flags];r.forEach(s=>{s.globalId===e.globalId&&e.type==="barrier"&&s.id===e.id&&(s.isFilterBarrier=t)}),this._flags=r}mergeSelection(t,e){let r=[],s=[...this.traceResults],i=e.globalId;s.forEach(a=>{i===a.trace.globalId&&(a.selectionEnabled=t),a.selectionEnabled&&a.results?.elements!==null&&(r=[...r,...a.results?.elements??[]])}),this.selectResults([...new Set(r)])}queryFeaturesById(t){return h(this,null,function*(){let{view:e}=this;if(!e||!this.utilityNetwork)return null;let r=this.utilityNetwork.getObjectIdsFromElements(t),s={layerUrl:r[0].layerUrl,objectIds:r[0].objectIds,outFields:["*"]},i=e.map?.allTables.toArray().filter(l=>l?.parsedUrl?.path===r[0].layerUrl).filter(A)??[];this._getUniqueMapLayerViews(e).filter(({layer:l})=>l?.parsedUrl?.path===r[0].layerUrl).forEach(({layer:l})=>{l.type!=="feature"&&l.type!=="subtype-group"||i.push(l)});let a=(yield Promise.all(i.map(l=>h(this,null,function*(){let o={layers:new R([l]),layerInfos:[s],returnGeometry:!0,outSpatialReference:e.spatialReference},[n]=yield fe(o,!1);return n})))).filter(({featureSet:l})=>l.features.length>0);return a.length>0?a:null})}queryFlagByHitTest(t,e,r){return this._lookupFlagByHit(t).then(s=>{let{view:i}=this;if(!i)return!1;if(s.length>0){let a=[...this._flags],l=r;return s.forEach(o=>{let n=o.graphic,y=n.attributes.hasOwnProperty("GLOBALID")?n.attributes.GLOBALID:n.attributes.globalid;if(a.filter(p=>p.globalId===y).length<=0){let p=this.graphicHandler.getFlagGraphic(n.attributes.mapPoint,e,n,l);this._getGraphicLayer(G)?.add(p);let b=this._createFlagProperty(n,e,p);a.push(b)}else if(n.attributes.percentAlong!==null){let p=this.graphicHandler.getFlagGraphic(n.attributes.mapPoint,e,n,l);this._getGraphicLayer(G)?.add(p);let b=this._createFlagProperty(n,e,p);a.push(b)}}),this._flags=a,!0}return!1})}removeResultGraphicFromView(t){let{view:e}=this;if(!e)return;let r=this._getGraphicLayer(I)?.graphics;t.graphicEnabled=!1,r?.filter(i=>i.attributes[i.attributes.hasOwnProperty("GLOBALID")?"GLOBALID":"globalid"]===t.trace.globalId)?.forEach(i=>{this._getGraphicLayer(I)?.remove(i)})}removeFlag(t){let e=this._flags.filter(r=>{if(r.id!==t.id)return r});this._removeGraphic(t),this._flags=e}removeAllResultAreaGraphics(){this._resultAreaHandler?.removeAllResultAreaGraphics(this.view.map)}removeResultAreaFromMap(t){if(t.resultArea){t.resultArea.show=!1;let e=this._resultAreaHandler?.removeResultArea(t.trace.globalId,this.view?.map);e&&this.emit("remove-result-area",{graphic:e})}}removeSelection(){this._highlightHandler.forEach(t=>{t&&t.remove()}),this._highlightHandler=[]}removeTerminal(t,e){let r=[...this._flags];r.forEach(s=>{if(s.globalId===e.globalId&&e.selectedTerminals?.includes(parseInt(t,10))){let i=e.selectedTerminals.indexOf(parseInt(t,10));s.selectedTerminals?.splice(i,1)}}),this._flags=r}removeFlagsOnLoadWatcher(){this._watchHandler&&this._watchHandler!==null&&this._watchHandler.remove()}removeClickHandler(){this._clickHandler&&(this._sketchViewModel.cancel(),this._clickHandler.remove())}reset(){this._flags=[],this.traceResults=[];let t=[...this.traces];t.forEach(e=>{e.selected=!1}),this.traces=t,this.view&&(this._getGraphicLayer(F)?.removeAll(),this._getGraphicLayer(G)?.removeAll(),this._getGraphicLayer(I)?.removeAll(),this.removeAllResultAreaGraphics(),this.removeSelection(),this.emit("clear-selection",{resultSet:[]}),this.emit("reset"))}selectFeaturesById(t){let{view:e}=this;if(!e||!this.utilityNetwork)return;let r=this.utilityNetwork.getObjectIdsFromElements(t);this._getUniqueMapLayerViews(e).forEach(s=>{Pe(s)&&s.layer?.parsedUrl?.path===r[0].layerUrl&&Ne(s)&&this._highlightHandler.push(s.highlight(r[0].objectIds))})}selectResults(t){if(t.length>0){this.removeSelection();let e=this.groupResultsByNetworkSource(t),r=[];for(let s in e)this.selectFeaturesById(e[s]),r.push(this.queryFeaturesById(e[s]));Promise.all(r).then(s=>{this.emit("select-features",{resultSet:s})})}else this.removeSelection(),this.emit("clear-selection",{resultSet:[]})}selectTraces(t,e){let r=[...this.traces];r.forEach(s=>{e===s.globalId&&(s.selected=t)}),this.traces=r}selectTracesOnLoad(){this.utilityNetwork?.hasOwnProperty("sharedNamedTraceConfigurations")&&(this.traces=[...this.utilityNetwork.sharedNamedTraceConfigurations],this.traces.forEach(t=>{t.selected=!1,this.selectedTraces.includes(t.globalId)&&(t.selected=!0)}))}zoomToAsset(t){this.view?.goTo(t).catch(e=>console.error(e))}_createResultAreaInputGeometry(t){return h(this,null,function*(){if(t.aggregatedGeometry!=null)return this._geometryHandler.mergeAggregatedToGeometries(t.aggregatedGeometry);let e=this.groupResultsByNetworkSource(t.elements),r=[];for(let s in e)r.push(this.queryFeaturesById(e[s]));try{let s=yield Promise.all(r),i=[];for(let a of s)if(a)for(let l of a)for(let o of l.featureSet.features)o.geometry&&i.push(o.geometry);return i}catch{return[]}})}_loadUNSupportItems(){if(!this.utilityNetwork)return;let{map:t}=this.view,{messages:e}=this;this._populateOutfields(),this._createGraphicLayer(F),this._createGraphicLayer(G),this._createGraphicLayer(I),this._resultAreaHandler?.createGraphicLayer(t,e?.alertsStrings.genericResultHeader),this._validUNLayers=this._utilityHelper.getValidUtilityNetworkLayers(t,this.utilityNetwork),this._sketchViewModel=this.graphicHandler.initializeSketch(this.view,this._getGraphicLayer(F),this._validUNLayers)}_getUniqueMapLayerViews(t){let e=[],r=t.layerViews.filter(({layer:{type:i}})=>i==="feature"||i==="group"||i==="subtype-group").toArray(),s=i=>{for(let a of i.layerViews)Ie(a)?s(a):e.push(a)};return r.forEach(i=>{switch(i.layer.type){case"group":Ie(i)&&s(i);break;case"subtype-group":e.push(i);break;default:e.some(a=>a.layer.id===i.layer.id)||e.push(i)}}),e}_processFlags(t){let e=[];return t.forEach(r=>{if(r.selectedTerminals!==null&&r.selectedTerminals.length>0)r.selectedTerminals.forEach(s=>{let i=new N({globalId:r.globalId,percentAlong:r.percentAlong,terminalId:s,type:r.type,isFilterBarrier:r.isFilterBarrier});e.push(i)});else{let s=new N({globalId:r.globalId,percentAlong:r.percentAlong,type:r.type,isFilterBarrier:r.isFilterBarrier});e.push(s)}}),e}_getDisplayField(t){return t?.layer?.type==="subtype-sublayer"?this._getDisplayFieldBySublayer(t):this._getDisplayFieldByFeatureLayer(t)}_getDisplayFieldBySublayer(t){let e="",r="",s=t.layer;e=this._checkParentForData(s,"displayField");for(let i in t.attributes){let a=i.toLowerCase();a===e?.toLowerCase()?(r=t.attributes[i],a==="assetgroup"||a==="assettype"?r=this._checkSubtype(s,s.subtypeCode):(r=this._checkDomain(s.fields,i,r),typeof r=="string"&&(r=this._defaultDisplayField(r,s)))):(r=this._checkDomain(s.fields,i,r),typeof r=="string"&&(r=this._defaultDisplayField(r,s)))}return{field:e,value:r.toString()}}_getDisplayFieldByFeatureLayer(t){let e=t.layer,r=e.displayField,s="";for(let i in t.attributes){let a=i.toLowerCase();if(a===r?.toLowerCase())if(s=t.attributes[i],a==="assetgroup"||a==="assettype"){let l=t.attributes[e.typeIdField.toUpperCase()];l||(l=t.attributes[e.typeIdField.toLowerCase()]),r=e.typeIdField,s=this._checkSubtype(e,l),r===""&&(e.templates&&e.templates.length>0?(r=e.templates[0]?.name,s=e.templates[0]?.name):(r=e.displayField,s=t.attributes[i]))}else s=this._checkDomain(e.fields,i,s),typeof s=="string"&&(s=this._defaultDisplayField(s,e));else s=this._checkDomain(e.fields,i,s),typeof s=="string"&&(s=this._defaultDisplayField(s,e))}return{field:r,value:s?s.toString():""}}_checkSubtype(t,e){let r=e;if(t.type==="subtype-sublayer"){let s=this._checkParentForData(t,"subtypes");s?.length>0&&s.forEach(i=>{i.code===e&&(r=i.name)})}else if(t.types!=null&&t.types.length>0){let s=t.types.filter(i=>i.id===e);s.length>0&&(r=s[0].name)}return r}_checkDomain(t,e,r){let s=r,i=t.filter(a=>a.name.toLowerCase()===e.toLowerCase());if(i.length>0&&Se(i[0].domain)&&i[0].domain?.codedValues){let a=i[0].domain.codedValues.filter(({code:l})=>l===r);a.length>0&&(s=a[0].name)}return s}_checkParentForData(t,e){return t.parent?.[e]??null}_defaultDisplayField(t,e){return t.trim()?t:e.templates&&e.templates?.length>0?e.templates[0].name:e.title}get _uniqueFlagId(){return this._flagId++}_groupBy(t,e){return t.reduce((r,s)=>((r[s[e]]=r[s[e]]||[]).push(s),r),{})}_lookupFlagByHit(t){return h(this,null,function*(){let e=t.graphic?.geometry,r=[];if(e&&x(e)&&this.view){let s=this.view.toScreen(e);if(s){let i=yield this.view.hitTest(s,{include:this._validUNLayers});if(i?.results.length){let a=i.results.find(l=>l.layer!==null);if(a.graphic?.geometry){if(a.graphic.geometry.type==="polyline"){let l={terminalId:null,isFilterBarrier:!1,allTerminals:null,selectedTerminals:null,percentAlong:this._geometryHandler.getPercentageAlong(a.graphic.geometry,t.graphic?.geometry,a.graphic.geometry.spatialReference),displayValue:this._getDisplayField(a.graphic),mapPoint:a.mapPoint};a.graphic.attributes=g(g({},a.graphic.attributes),l),r.push(a)}else if((a.graphic.geometry.type==="point"||a.graphic.geometry.type==="polygon")&&this.utilityNetwork){let l=this.utilityNetwork.getTerminalConfiguration(a.graphic),o=this._getDisplayField(a.graphic),n={terminalId:l?l.terminals[0].id||null:1,isFilterBarrier:!1,allTerminals:l??null,selectedTerminals:[l?l.terminals[0].id||null:1],percentAlong:null,displayValue:o,mapPoint:a.mapPoint};a.graphic.attributes=g(g({},a.graphic.attributes),n),r.push(a)}}}}}return r})}_createFlagProperty(t,e,r){let s=new N;s.terminalId=t.attributes.terminalId,s.isFilterBarrier=t.attributes.isFilterBarrier,s.percentAlong=t.attributes.percentAlong,s.globalId=t.attributes.globalid||t.attributes.GLOBALID,s.type=e;let i=s;return i.details=t,i.mapGraphic=r,i.id=this._uniqueFlagId,i.allTerminals=t.attributes.allTerminals,i.selectedTerminals=t.attributes.selectedTerminals,i.displayValue=t.attributes.displayValue,i.mapPoint=t.attributes.mapPoint,i}_populateOutfields(){return h(this,null,function*(){if(!this.view)return;let{map:t}=this.view,e=this.getValidSources(),r=s=>{s.type==="group"?s.layers.forEach(i=>{Fe(i)&&r(i)}):e.some(i=>i.layerId===s.layerId)&&s.fields.some(i=>i.name.toLowerCase()==="assetgroup")&&(s.outFields=["assetgroup","assettype","globalid","objectid"])};for(let s of t.layers)Fe(s)&&r(s)})}_removeGraphic(t){this._getGraphicLayer(G)?.remove(t.mapGraphic)}_createGraphicLayer(t){let{map:e}=this.view;if(!e.findLayerById(t)){let r=new S({id:t,internal:!0,listMode:"hide",title:t});_e(this.view,r)}}_getGraphicLayer(t){let{map:e}=this.view;if(e){let r=e.findLayerById(t);if(r&&Be(r))return r}return null}};u([d()],c.prototype,"_activeProgress",void 0),u([d()],c.prototype,"_flags",void 0),u([d()],c.prototype,"traces",void 0),u([d()],c.prototype,"defaultGraphicColor",void 0),u([d()],c.prototype,"enableResultArea",void 0),u([d()],c.prototype,"flags",void 0),u([d()],c.prototype,"gdbVersion",void 0),u([d()],c.prototype,"messages",void 0),u([d()],c.prototype,"messagesUnits",void 0),u([d()],c.prototype,"resultAreaProperties",null),u([d()],c.prototype,"selectedTraces",void 0),u([d()],c.prototype,"selectOnComplete",void 0),u([d()],c.prototype,"showGraphicsOnComplete",void 0),u([d()],c.prototype,"showSelectionAttributes",void 0),u([d({readOnly:!0})],c.prototype,"state",null),u([d()],c.prototype,"traceResults",void 0),u([d()],c.prototype,"utilityNetwork",void 0),u([d({value:null})],c.prototype,"view",null),c=u([Q("esri.widgets.UtilityNetworkTrace.UtilityNetworkTraceViewModel")],c);var Ot=c;export{ve as a,Ot as b};
