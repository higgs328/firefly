import{Aa as ot,Ba as rt,Da as F,K as E,L as it,M as nt,Sa as ht,Va as U,Ya as W,ab as Dt,db as St,eb as xt,fa as j,ga as bt,hb as G,ib as It,jb as Q,p as st}from"./chunk-A2QQP5DF.js";import{a as gt}from"./chunk-LTHAIW3V.js";import{a as w}from"./chunk-RRQS6PLL.js";import{ea as O,ga as B}from"./chunk-WFHQTMIY.js";import{a as D}from"./chunk-XAZOVQGA.js";import{Ea as Pt,Ja as Tt,a as k,b as N,g as _t,i as dt,o as H,r as $,t as pt,ub as b,y as tt,z as et}from"./chunk-V3KEO7AJ.js";import"./chunk-QGVBCWUY.js";import"./chunk-VTHXE323.js";function Ft(r){let t=r.getInputSR(),s=r.getOutputSR(),i=!1;do{if(t.equals(s)){i=!1;break}if(!K(t)||!K(s)){i=!1;break}if(t.getCoordinateSystemType()===2){i=!0;break}if(s.getCoordinateSystemType()===2){i=!0;break}let e=r.getGeographicTransformations();if(e!==null&&e.count()>0){i=!0;break}}while(!1);return i}var mt=class{constructor(t,s,i,e){this.m_horizon2Env=new D,this.m_horizon2=t,this.m_sr=s,this.m_bInclusive2=i,this.m_pannableExtent=e.clone(),this.m_segIter=null,this.m_qtIter=null,t!==null?(t.queryEnvelope(this.m_horizon2Env),this.m_gcs360=e.width(),this.m_gcs180=.5*this.m_gcs360,this.m_gcs90=.25*this.m_gcs360,this.m_pannableFactor=1,this.m_horizon2Env.width()-this.m_gcs360>0&&(this.m_pannableFactor+=Math.ceil((this.m_horizon2Env.width()-this.m_gcs360)/this.m_gcs360)),this.m_period=this.m_gcs360):(this.m_horizon2Env.setEmpty(),this.m_gcs360=Number.NaN,this.m_gcs180=Number.NaN,this.m_gcs90=Number.NaN,this.m_pannableFactor=Number.NaN,this.m_period=Number.NaN),this.m_gcsTolerance=s!=null?s.getTolerance(0):Number.NaN}isPointStartInHorizon(t,s){if(!this.m_horizon2)return!0;let i=Y(new O(t),this.m_horizon2,!0,this.m_period);do{let e=t.clone();if(e.x-=i*this.m_period,this.m_horizon2.getGeometryType()===N.enumPolygon){let n;if(n=this.m_horizon2Env.contains(e)?bt(this.m_horizon2,e,0):0,this.m_bInclusive2){if(n===0)return!1}else if(n===1)return!1}else{let n=this.m_horizon2Env.contains(e);if(this.m_bInclusive2){if(!n)return!1}else if(n)return!1}}while(this.m_horizon2Env.xmin+ ++i*this.m_period<t.x);return!0}isAdjoiningLineInHorizon(t,s,i){if(!this.m_horizon2)return!0;let e=new b,n=new b;X(t,s,this.m_gcs90,this.m_gcs180,this.m_gcs360,e,n);let h=Math.max(e.x,n.x),o=new E;o.setStart2D(e),o.setEnd2D(n);let a=Y(o,this.m_horizon2,!0,this.m_period),m=!1;do{let c=e.clone(),u=n.clone();if(c.x-=a*this.m_period,u.x-=a*this.m_period,this.m_horizon2.getGeometryType()===N.enumPolygon){let l=new E;l.setStartXY(c),l.setEndXY(u);let g=new D,_=new D;if(l.queryEnvelope(g),_.setCoords({env2D:g}),_.inflateCoords(this.m_gcsTolerance,this.m_gcsTolerance),this.m_horizon2Env.isIntersecting(_)){let p=this.m_horizon2.getImpl(),d=p.getAccelerators();d!==null&&d.getRasterizedGeometry()!==null&&k(0);{let f=null;if(d!==null&&(f=d.getQuadTree()),f!==null){this.m_qtIter||(this.m_qtIter=f.getIteratorForQT()),this.m_qtIter.resetIterator(l,this.m_gcsTolerance),this.m_segIter||(this.m_segIter=p.querySegmentIterator());for(let P=this.m_qtIter.next();P!==-1;P=this.m_qtIter.next()){let T=f.getElement(P);if(this.m_segIter.resetToVertex(T,-1),this.m_segIter.nextSegment().isIntersecting(l,this.m_gcsTolerance))return!1}}else for(this.m_segIter||(this.m_segIter=p.querySegmentIterator()),this.m_segIter.resetToFirstPath();this.m_segIter.nextPath();)for(;this.m_segIter.hasNextSegment();){let P=this.m_segIter.nextSegment(),T=new D;if(P.queryEnvelope(T),T.isIntersecting(_)&&P.isIntersecting(l,this.m_gcsTolerance))return!1}}}}else if(this.m_bInclusive2){let l=this.m_horizon2Env.contains(c),g=this.m_horizon2Env.contains(u);if(l&&g)return!0}else{let l=this.m_horizon2Env.clone();if(l.inflateCoords(this.m_gcsTolerance,this.m_gcsTolerance),l.clipLine(c,u)!==0)return!1}}while(this.m_horizon2Env.xmin+ ++a*this.m_period<h);return!this.m_bInclusive2||m}isEnvelopeInHorizon(t,s){if(!this.m_horizon2)return!0;let i=new B({env2D:t}),e=Y(i,this.m_horizon2,!0,this.m_period);do{let n=t.clone();if(n.move(-e*this.m_period,0),i.setCoords(n.xmin,n.ymin,n.xmax,n.ymax),!R(i,this.m_horizon2,this.m_sr,this.m_bInclusive2,s))return!1}while(this.m_horizon2Env.xmin+ ++e*this.m_period<t.xmax);return!0}},at=class{constructor(t,s,i){this.m_splitLines2=null,this.m_scalars=[],this.m_splitIter=null,this.m_splitLines2=t,this.m_transform1=s,this.m_pannableExtent=i.clone(),this.m_gcs360=i.width(),this.m_gcs180=.5*this.m_gcs360,this.m_gcs90=.25*this.m_gcs360,s!==null?(this.m_gcsTolerance=this.m_transform1.getOutputSR().getTolerance(0),this.m_halfGcsTolerance=.5*this.m_gcsTolerance,this.m_gcsToleranceSq=this.m_gcsTolerance*this.m_gcsTolerance):(this.m_gcsTolerance=Number.NaN,this.m_halfGcsTolerance=Number.NaN,this.m_gcsToleranceSq=Number.NaN)}hasSplitLines(){return this.m_splitLines2!=null}getSplitLineFactorEx(t,s,i,e,n,h){let o=new b,a=new b;X(e,n,this.m_gcs90,this.m_gcs180,this.m_gcs360,o,a);let m=new E;for(m.setStartXY(o),m.setEndXY(a),this.m_splitIter?this.m_splitIter.resetToFirstPath():this.m_splitIter=this.m_splitLines2.getImpl().querySegmentIterator();this.m_splitIter.nextPath();)for(;this.m_splitIter.hasNextSegment();){let c=this.m_splitIter.nextSegment(),u=.5*(c.getStartX()+c.getEndX());V(this.m_gcs180,this.m_gcs360,u,m);let l=new D;m.queryEnvelope(l),l.inflateCoords(this.m_gcsTolerance,this.m_gcsTolerance);let g=new D;if(c.queryEnvelope(g),!!l.isIntersecting(g)&&(this.m_scalars.length<2&&(this.m_scalars.length=2),m.intersect(c,null,this.m_scalars,null,this.m_gcsTolerance)===1&&this.m_scalars[0]>0&&this.m_scalars[0]<1)){let _=lt(s,i,this.m_scalars[0]),p=C(t.getCoord2D(_),this.m_transform1);return c.isIntersectingPoint(p,this.m_halfGcsTolerance)?_:this.getSplitLineFactor(t,s,i,c,h)}}return-1}getSplitLineFactor(t,s,i,e,n){let h=s,o=i,a=.5*(e.getStartX()+e.getEndX()),m=new E,c=t.getCoord2D(h),u=t.getCoord2D(o),l=C(c,this.m_transform1),g=C(u,this.m_transform1);for(;h<o;){let _=new b,p=new b;X(l,g,this.m_gcs90,this.m_gcs180,this.m_gcs360,_,p),m.setStartXY(_),m.setEndXY(p),V(this.m_gcs180,this.m_gcs360,a,m);let d=b.sqrDistance(m.getStartXY(),m.getEndXY());if(d<=this.m_gcsToleranceSq)break;if(Number.isNaN(d))return Number.NaN;let f=lt(h,o,this.m_scalars[0]);if(h<f&&f<o||(f=.5*(o+h)),h===f||f===o)return f;let P=t.getCoord2D(f),T=C(P,this.m_transform1),x=new b;X(l,T,this.m_gcs90,this.m_gcs180,this.m_gcs360,_,x),m.setStartXY(_),m.setEndXY(x),V(this.m_gcs180,this.m_gcs360,a,m);let S=m.intersect(e,null,this.m_scalars,null,this.m_halfGcsTolerance);if(S!==0){if(this.m_scalars[0]===1)return f;o=f,u.setCoordsPoint2D(P),g.setCoordsPoint2D(T)}else{if(X(T,g,this.m_gcs90,this.m_gcs180,this.m_gcs360,x,p),m.setStartXY(x),m.setEndXY(p),V(this.m_gcs180,this.m_gcs360,a,m),S=m.intersect(e,null,this.m_scalars,null,this.m_halfGcsTolerance),S===0||this.m_scalars[0]===0)return f;h=f,c.setCoordsPoint2D(P),l.setCoordsPoint2D(T)}}return .5*(o+h)}},J=class{constructor(){this.m_bPrepared=!1,this.m_bNeedsShapePreservingProject=!1,this.m_inputTransform=null,this.m_transform1=null,this.m_transform2=null,this.m_extentFrom=null,this.m_horizon1=null,this.m_horizon2=null,this.m_pannableExtentFrom=new D,this.m_pannableExtentTo=new D,this.m_pannableExtentGcsTo=new D,this.m_bClipTopBottomFrom=!1,this.m_bNeedsGeoTransform=!1,this.m_bIsPannableFrom=!1,this.m_bIsPannableTo=!1,this.m_bInclusive1=!1,this.m_bInclusive2=!1,this.m_bSrFromIsPcs=!1,this.m_bSrToIsPcs=!1,this.m_fromTolerance=Number.NaN,this.m_toTolerance=Number.NaN,this.m_gcsToTolerance=Number.NaN,this.m_aFrom=Number.NaN,this.m_mpuFrom=Number.NaN,this.m_rpuFrom=Number.NaN,this.m_rpuGcsTo=Number.NaN,this.m_aTo=Number.NaN,this.m_mpuTo=Number.NaN,this.m_stages=0}prepare(t,s,i){this.m_bPrepared&&$(""),t||H("");let e=t.getInputSR(),n=t.getOutputSR();K(e)&&K(n)||H("shape preserving project requires PCS or GCS");let h=e.getCoordinateSystemType(),o=n.getCoordinateSystemType();this.m_bSrFromIsPcs=h===2,this.m_bSrToIsPcs=o===2;let a=null,m=null,c=null,u=null;this.m_bSrFromIsPcs?(a=e,c=e.getGCS(),this.m_aFrom=Et(c),this.m_mpuFrom=wt(a),this.m_rpuFrom=Number.NaN):(c=e,this.m_rpuFrom=yt(c),this.m_aFrom=Number.NaN),this.m_bSrToIsPcs?(m=n,u=n.getGCS(),this.m_aTo=Et(u),this.m_mpuTo=wt(m)):(u=n,this.m_aTo=Number.NaN,this.m_mpuTo=Number.NaN),this.m_rpuGcsTo=yt(u);let l=t.getGeographicTransformations();this.m_bNeedsGeoTransform=l!==null&&l.count()>0;let g=e.equals(n);if(this.m_bNeedsShapePreservingProject=!g&&(this.m_bSrFromIsPcs||this.m_bSrToIsPcs||this.m_bNeedsGeoTransform),!this.m_bNeedsShapePreservingProject)return this.m_inputTransform=t,this.m_extentFrom=s?s.clone():null,void(this.m_bPrepared=!0);if(this.m_bIsPannableFrom=e.isPannable(),this.m_bIsPannableTo=n.isPannable(),this.m_bIsPannableFrom&&(this.m_pannableExtentFrom=e.getPannableExtent()),this.m_bIsPannableTo&&(this.m_pannableExtentTo=n.getPannableExtent()),this.m_bSrToIsPcs){this.m_pannableExtentGcsTo=u.getPannableExtent();let d=m.getCentralMeridian(),f=this.m_pannableExtentGcsTo.getCenter();f.x=d,this.m_pannableExtentGcsTo.centerAt(f)}else this.m_pannableExtentGcsTo=this.m_pannableExtentTo.clone();this.m_fromTolerance=e.getTolerance(0),this.m_toTolerance=n.getTolerance(0),this.m_gcsToTolerance=u.getTolerance(0);{let d=t.getExtendedParams(),f=d.clipWithInputHorizon,P=d.clipWithOutputHorizon;f&&this.setHorizon1(t,s,i),P&&this.setHorizon2(t,i),this.checkAndSetStages(t,i)}let _=Q();_.setFlag(1073741824,!0),_.setFlag(536870912,!0);let p=It();if(p.clipWithInputHorizon=!1,p.clipWithOutputHorizon=!1,this.m_stages===1)this.m_transform1=G(!1,e,n,l,p,_);else if(this.m_stages===2){_.setFlag(2147483648,!0),this.m_transform1=G(!1,e,u,l,p,_);let d=Q();this.m_transform2=G(!1,u,n,null,p,d)}else{k(m!=null),p.centralMeridianOfOutputGCS=m.getCentralMeridian(),this.m_transform1=G(!1,e,u,l,p,_);let d=Q();d.setFlag(2147483648,!0),this.m_transform2=G(!1,u,n,null,p,d)}this.m_inputTransform=t,this.m_extentFrom=s?s.clone():null,this.m_bPrepared=!0}execute(t,s,i,e){return this.m_bPrepared||$(""),k(!t.hasAttribute(10)),this.execute_(t,s,i,e)}checkIfNeedsReset(t,s){return k(0),!1}setHorizon1(t,s,i){let e=t.getInputSR(),n,h=null,o=new D;if(this.m_bSrFromIsPcs){n=!0,h=e.getPCSHorizon(),h.queryEnvelope(o),this.m_bIsPannableFrom&&(h=new B({xmin:this.m_pannableExtentFrom.xmin,ymin:o.ymin,xmax:this.m_pannableExtentFrom.xmax,ymax:o.ymax}));let a=!1;s!=null&&(a=At(s,h,e,n,this.m_bIsPannableFrom,this.m_pannableExtentFrom,i)),a||(this.m_horizon1=h,this.m_bInclusive1=n)}else this.m_bClipTopBottomFrom=!0,this.m_bInclusive1=!0}setHorizon2(t,s){let i=t.getOutputSR();if(i.getCoordinateSystemType()===1)return this.m_horizon2=null,void(this.m_bInclusive2=!1);let e=null,n=new D,h=i.getGCSHorisonIsInclusive();e=i.getGCSHorizon(),e.queryEnvelope(n);let o=i.getCentralMeridian();if(this.m_bIsPannableTo){let a=new B({xmin:this.m_pannableExtentGcsTo.xmin,ymin:n.ymin,xmax:this.m_pannableExtentGcsTo.xmax,ymax:n.ymax});a.centerAt(o,0),e=a}this.m_horizon2=e,this.m_bInclusive2=h}checkAndSetStages(t,s){let i=t.getOutputSR().getGCSSplitLines();if(!this.m_horizon2&&!i)return void(this.m_stages=1);if(this.m_horizon2.getGeometryType()===N.enumEnvelope){let e=new D;this.m_horizon2.queryEnvelope(e);let n=e.width(),h=e.height();n>=Tt/this.m_rpuGcsTo&&h>=Math.PI/this.m_rpuGcsTo&&(this.m_horizon2=null)}if(this.m_horizon2||i){if(this.m_horizon2!==null&&!this.m_bNeedsGeoTransform&&!this.m_bSrFromIsPcs){let e=t.getOutputSR().getGCS();return t.getInputSR().equals(e)?(this.m_horizon1=this.m_horizon2,this.m_bInclusive1=this.m_bInclusive2,this.m_bClipTopBottomFrom=!1,this.m_horizon2=null,this.m_bInclusive2=!1,void(this.m_stages=1)):void(this.m_stages=2)}this.m_stages=3}else this.m_stages=1}execute_(t,s,i,e){if(!this.m_bNeedsShapePreservingProject)return new F().execute(t,this.m_inputTransform,e);if(!t)return null;et(t),tt(t);let n,h=t.getGeometryType();return _t(h)?(n=Mt(t),h=N.enumPolyline):n=t,n.isEmpty()?n:dt(h)?this.executeEx(t,s,i,e):new F().execute(t,this.m_inputTransform,e)}executeEx(t,s,i,e){let n;t.hasNonLinearSegments()&&pt(""),n=this.m_bIsPannableFrom?new F().foldInto360Range(t,this.m_transform1.getInputSR()):t;let h,o=i;return o>0||(o=100*this.m_toTolerance),h=this.m_stages===1?this.executeGood(n,s,o,e):this.m_stages===2?this.executeBad(n,s,o,e):this.executeUgly(n,s,o,e),this.filterOverDensification(h,this.m_inputTransform.getOutputSR(),o,e)}executeGood(t,s,i,e){let n=i*i,h,o;return h=s>0?this.getMinLengthInSrFrom(s):this.getMinLengthInSrFrom(1e-5),o=this.m_bClipTopBottomFrom?W(t,this.m_transform1.getInputSR()):L(t,this.m_transform1.getInputSR(),this.m_horizon1,this.m_bInclusive1,this.m_bIsPannableFrom,this.m_pannableExtentFrom,!0,Number.NaN,e),o=U(o,this.m_transform1.getOutputSR(),e),o=q(o,this.m_transform1,this.m_bIsPannableFrom,this.m_pannableExtentFrom,this.m_bIsPannableTo,this.m_pannableExtentTo,null,null,null,null,h,n,e),o=new F().execute(o,this.m_transform1,e),o}executeBad(t,s,i,e){let n;n=s>0?s*(Math.PI/180/this.m_rpuGcsTo):Math.PI/180/this.m_rpuGcsTo*1e-5;let h=i*i,o;return o=this.m_bClipTopBottomFrom?W(t,this.m_transform1.getInputSR()):t,o=new F().execute(o,this.m_transform1,e),o=L(o,this.m_transform2.getInputSR(),this.m_horizon2,this.m_bInclusive2,!0,this.m_pannableExtentGcsTo,!0,Number.NaN,e),o=U(o,this.m_transform2.getOutputSR(),e),o=q(o,this.m_transform2,!0,this.m_pannableExtentGcsTo,this.m_bIsPannableTo,this.m_pannableExtentTo,null,null,null,null,n,h,e),o=new F().execute(o,this.m_transform2,e),o}executeUgly(t,s,i,e){let n=i*i,h;h=s>0?this.getMinLengthInSrFrom(s):this.getMinLengthInSrFrom(1e-5);let o=null;o=this.m_bClipTopBottomFrom?W(t,this.m_transform1.getInputSR()):L(t,this.m_transform1.getInputSR(),this.m_horizon1,this.m_bInclusive1,this.m_bIsPannableFrom,this.m_pannableExtentFrom,!0,Number.NaN,e);let a=o,m=new mt(this.m_horizon2,this.m_transform2.getInputSR(),this.m_bInclusive2,this.m_pannableExtentGcsTo),c=this.m_transform2.getOutputSR().getGCSSplitLines(),u=new at(c,this.m_transform1,this.m_pannableExtentGcsTo);if(o=q(o,this.m_transform1,this.m_bIsPannableFrom,this.m_pannableExtentFrom,this.m_bIsPannableTo,this.m_pannableExtentTo,this.m_transform2,m,this.m_pannableExtentGcsTo,u,h,n,e),o!==null){a=null,o=new F().execute(o,this.m_transform1,e);let p=Math.PI/180/this.m_rpuGcsTo*2;return o=L(o,this.m_transform2.getInputSR(),this.m_horizon2,this.m_bInclusive2,!0,this.m_pannableExtentGcsTo,!1,p,e),o=new F().execute(o,this.m_transform2,e),o}let l=Number.NaN;l=i>0?i:100*this.m_toTolerance,l/=this.m_rpuGcsTo*this.m_aTo/this.m_mpuTo;let g=l*l,_;return o=q(a,this.m_transform1,this.m_bIsPannableFrom,this.m_pannableExtentFrom,!0,this.m_pannableExtentGcsTo,null,null,null,null,h,g,e),a=null,o=new F().execute(o,this.m_transform1,e),_=s>0?s*(Math.PI/180/this.m_rpuGcsTo):Math.PI/180/this.m_rpuGcsTo*1e-5,o=L(o,this.m_transform2.getInputSR(),this.m_horizon2,this.m_bInclusive2,!0,this.m_pannableExtentGcsTo,!1,Number.NaN,e),o=U(o,this.m_transform2.getOutputSR(),e),o=q(o,this.m_transform2,!0,this.m_pannableExtentGcsTo,this.m_bIsPannableTo,this.m_pannableExtentTo,null,null,null,null,_,n,e),o=new F().execute(o,this.m_transform2,e),o}getMinLengthInSrFrom(t){let s;return s=this.m_bSrFromIsPcs?this.m_aFrom*(t*Math.PI/180)/this.m_mpuFrom:t*Math.PI/180*(1/this.m_rpuFrom),s}filterOverDensification(t,s,i,e){let n=zt(t,i);return n.dropAttribute(10),n!==t&&n.getGeometryType()===N.enumPolygon&&(n=new ot().execute(n,s,!1,e)),n}};function zt(r,t){if(r.isEmpty()||!r.hasAttribute(10))return r;let s=t*t,i=r.getAttributeStreamRef(10),e=!1,n=new E,h=[],o=!1;for(let m=0,c=r.getPathCount();m<c;m++){let u=r.getPathStart(m),l=r.getPathEnd(m),g=r.isClosedPath(m);if(!(l>u))continue;{let d=g?u:l-1;i.read(u)===0&&i.read(d)===0||(e||(i=i.clone(),e=!0),i.write(u,0),i.write(d,0))}let _=g?l+1:l,p=u;for(let d=u;d<_;d++){let f=d===l?u:d;if(i.read(f)===0){if(d-p>1){h.push({from:p,to:d});let P=new b;for(;h.length>0;){let T=h.at(-1);h.pop(),n.setStartXY(r.getXY(T.from));let x=T.to===l?u:T.to;n.setEndXY(r.getXY(x));let S=s,I=-1;for(let y=T.from+1,Z=T.to;y<Z;y++){let A=r.getXY(y),z=n.getClosestCoordinate(A,!1);n.queryCoord2D(z,P);let v=b.sqrDistance(P,A);S<v&&(S=v,I=y)}I>=0?(e||(i=i.clone(),e=!0),i.write(I,0),I-T.from>1&&h.push({from:T.from,to:I}),T.to-I>1&&h.push({from:I,to:T.to})):o=!0}}p=f}}}if(!o)return r;let a=kt(r,i,1);return a.dropAttribute(10),a}function kt(r,t,s){let i=r.createInstance(),e=new O;for(let n=0,h=r.getPathCount();n<h;n++){let o=!0,a=0,m=0,c=r.getPathStart(n),u=r.getPathEnd(n),l=!0;for(let g=c;g<u;g++)t.read(g)===s?(!l&&m>0&&(i.addSegmentsFromPath(r,n,a-c,m,o),m=0),l=!0):l?(l=!1,r.getPointByVal(g,e),o?(i.startPathPoint(e),o=!1):i.lineToPoint(e),a=g):m++;m>0&&i.addSegmentsFromPath(r,n,a-c,m,o)}return i}var Nt=8;function qt(r,t){for(let i=0;i<r;i++){let e=Math.ceil(i/2)/(r+1);i%2!=0&&(e=-e);let n=.5+e;t[i]=n}}function K(r){if(!r)return!1;let t=r.getCoordinateSystemType();return t===2||t===1}function q(r,t,s,i,e,n,h,o,a,m,c,u,l){let g=r.createInstance();g.addAttribute(10);let _=r.querySegmentIterator(),p=[],d=[],f=new it,P=r.getDescription().getAttributeCount()>1,T=new ut(t,s,i,e,n,h,o,m,c,u,P?d:null,p,l);for(;_.nextPath();)for(;_.hasNextSegment();){let x=_.nextSegment(),S=x.getStartXY(),I=x.getEndXY(),y=S.compare(I)>0,Z=Ct(y,x,f);if(p.length=0,d.length=0,!T.densifySegment(_.isFirstSegmentInPath(),Z))return null;y&&Yt(P?d:null,p),p.at(-1).setCoordsPoint2D(x.getEndXY());let A=g.getPointCount();if(P){let z=Ct(y,x,f);Rt(_.isFirstSegmentInPath(),_.isLastSegmentInPath()&&!_.isPathClosed(),x,z,d,p,g)}else Lt(_.isFirstSegmentInPath(),_.isLastSegmentInPath()&&!_.isPathClosed(),p,g);if(T.needsPostFiltering()){g.addAttribute(10);let z=g.getAttributeStreamRef(10);for(let v=1,Gt=p.length-1;v<Gt;v++)z.write(v+A,1)}}return g}function Lt(r,t,s,i){r&&i.insertPath2D(-1,null,0,0,!0);let e=i.getPathCount()-1;t?i.insertPointsFromPoints(e,-1,s,0,s.length,!0):i.insertPointsFromPoints(e,-1,s,0,s.length-1,!0)}function Rt(r,t,s,i,e,n,h){h.reserve(h.getPointCount()+n.length-1);let o=new O;if(s.queryStart(o),r?h.startPathPoint(o):h.lineToPoint(o),n.length>2){let a=i.calculateLength2D();for(let m=1;m<n.length-1;m++){let c=i.lengthToT(e[m]*a);i.queryCoord(c,o),o.setXY(n[m]),h.lineToPoint(o)}}t&&(s.queryEnd(o),h.lineToPoint(o))}function Mt(r){let t=new st({vd:r.getDescription()});return t.addSegment(r,!0),t}function C(r,t){let s=t.getInputSR(),i=t.getOutputSR(),e=new b;s.getCoordinateSystemType()===2?(e.setCoordsPoint2D(r),St(s,0,[e],1)):e.setCoordsPoint2D(r);let n=new b;n.setCoordsPoint2D(e),xt(t,[n],null,1,!1);let h=new b;return i.getCoordinateSystemType()===2?(h.setCoordsPoint2D(n),Dt(i,[h],1,!1)):h.setCoordsPoint2D(n),h}function Xt(r,t,s,i,e,n,h,o){if(e){let a=n.width(),m=.5*a;if(i){let u=.25*a,l=!1,g=new b,_=new b;if(Math.abs(r.y)===u?(g.setCoords(s.x,r.y),_.setCoordsPoint2D(s),l=!0):Math.abs(s.y)===u&&(_.setCoords(r.x,s.y),g.setCoordsPoint2D(r),l=!0),Math.abs(t.y)===u&&(l||(g.setCoordsPoint2D(r),_.setCoordsPoint2D(s),l=!0),g.x=t.x),l)return M(t,g,m,a,h),M(t,_,m,a,o),!0}let c=0;r.x-t.x>m&&s.x-t.x>m?c-=a:t.x-r.x>m&&t.x-s.x>m&&(c+=a),Math.abs(t.x-(r.x+c))<m?(h.setCoordsPoint2D(r),M(h,s,m,a,o),h.x+=c,o.x+=c):(h.setCoordsPoint2D(s),M(h,r,m,a,o),h.x+=c,o.x+=c)}else h.setCoordsPoint2D(r),o.setCoordsPoint2D(s);return!1}function Ct(r,t,s){return r?(s.create(t.getGeometryType()),t.copyTo(s.get()),s.get().reverse(),s.get()):t}function Yt(r,t){t.reverse(),r!==null&&r.reverse()}function V(r,t,s,i){let e=.5*(i.getStartX()+i.getEndX());if(e-s>r){let n=new w;n.setShiftCoords(-t,0),i.applyTransformation(n)}else if(s-e>r){let n=new w;n.setShiftCoords(t,0),i.applyTransformation(n)}}function L(r,t,s,i,e,n,h,o,a){let m=[!1];h&&ct(r,t,s,i,e,n,!0,o,m,a);let c=r;return m[0]||(c=ct(c,t,s,i,e,n,!1,o,null,a)),c=Ht(c,e,n,c!==r),c}function ct(r,t,s,i,e,n,h,o,a,m){if(h&&(a[0]=!1),s==null)return r;let c=new D,u=new D;s.queryEnvelope(c),r.queryEnvelope(u);let l=r.getGeometryType(),g=s.getGeometryType(),_=t.getTolerance(0);if(!e){if(h)return a[0]=R(r,s,t,i,m),null;let P;return P=i?g===N.enumEnvelope?nt(r,c,_,o,m):new rt().execute(r,s,t,m):new ht().execute(r,s,t,m),P===s&&(P=s.clone()),P}let p=n.width(),d=p*Math.ceil(c.width()/p),f=null;if(i){let P=Y(r,s,e,d),T=0,x=new w;do{let S=null;if(g===N.enumEnvelope){let I=s.clone();if(x.setShiftCoords(P*d,0),I.applyTransformation(x),h){if(a[0]=R(r,I,t,i,m),!a[0])return null}else{let y=new D;I.queryEnvelope(y),S=nt(r,y,_,o,m)}}else{let I=r.clone();if(x.setShiftCoords(-P*d,0),I.applyTransformation(x),h){if(a[0]=R(I,s,t,i,m),!a[0])return null}else S=new rt().execute(I,s,t,m),S===s&&(S=s.clone())}if(!h){if(S.isEmpty())continue;if(l===N.enumPolygon){let I=new D;if(S.queryEnvelope(I),I.width()<=_)continue}g===N.enumEnvelope&&(x.setShiftCoords(-P*d,0),S===r&&(S=S.clone()),S.applyTransformation(x)),f===null?f=S===r?S.clone():S:f.add(S,!1)}T++}while(c.xmin+ ++P*d<u.xmax);if(h)return null;f===null&&(f=r.createInstance()),l===N.enumPolygon&&T>1&&p-u.width()<=10*_&&(f=new ot().execute(f,t,!0,m))}else{let P=Y(r,s,e,d);if(f=r.clone(),P!==0){let T=new w;T.setShiftCoords(-P*d,0),f.applyTransformation(T)}do{if(h){if(a[0]=R(f,s,t,i,m),!a[0])return null}else if(f=new ht().execute(f,s,t,m),f===s&&(f=s.clone()),f.isEmpty())break;let T=new w;T.setShiftCoords(-d,0),f.applyTransformation(T)}while(c.xmin+ ++P*d<u.xmax);if(h)return null;if(!f.isEmpty()&&P!==0){let T=new w;T.setShiftCoords(P*d,0),f.applyTransformation(T)}}return f}function At(r,t,s,i,e,n,h){let o=[!1];return ct(r,s,t,i,e,n,!0,Number.NaN,o,h),o[0]}function R(r,t,s,i,e){let n;if(t.getGeometryType()===N.enumPolygon)i?n=j(t,r,s,64,e):n=j(t,r,s,4,e);else if(i){let h=new D,o=new D;t.queryEnvelope(h),r.queryEnvelope(o),n=h.containsEnvelope(o)}else n=j(t,r,s,4,e);return n}function Ht(r,t,s,i){let e;if(!t)return r;let n=s.getCenter().x,h=s.width(),o=.5*h,a=new D;r.queryEnvelope(a);let m=a.getCenter().x,c=0;if(m-n>o?c=-Math.ceil((m-n-o)/h)*h:n-m>o&&(c=Math.ceil((n-m-o)/h)*h),c!==0){e=i?r:r.clone();let u=new w;u.setShiftCoords(c,0),e.applyTransformation(u)}else e=r;return e}function Y(r,t,s,i){if(!s)return 0;let e=0,n=new D;t.queryEnvelope(n);let h=new D;r.queryEnvelope(h);let o=n.xmin+i;for(;o+i+e*i>h.xmin;)e--;for(;o+e*i<h.xmin;)e++;return e}function M(r,t,s,i,e){t.x-r.x>s?e.setCoords(t.x-i,t.y):r.x-t.x>s?e.setCoords(t.x+i,t.y):e.setCoordsPoint2D(t)}function X(r,t,s,i,e,n,h){Math.abs(r.y)===s?(n.setCoords(t.x,r.y),h.setCoordsPoint2D(t)):Math.abs(t.y)===s?(n.setCoordsPoint2D(r),h.setCoords(r.x,t.y)):(n.setCoordsPoint2D(r),M(n,t,i,e,h))}function yt(r){return r.getUnit().getUnitToBaseFactor()}function wt(r){return r.getUnit().getUnitToBaseFactor()}function Et(r){return r.getPECoordSys().getDatum().getSpheroid().getAxis()}function lt(r,t,s){return s<=.5?r+(t-r)*s:t-(t-r)*(1-s)}var ut=class{checkSegment(){for(let t=0;t<this.n;t++){if(this.pSplitLines2Info!==null&&this.pSplitLines2Info.hasSplitLines()&&!this.bCheckIfNoDensificationNeededForCurve){let i=this.pSplitLines2Info.getSplitLineFactorEx(this.rectifiedSegment,this.leftFactor,this.rightFactor,this.leftGcsToDensifiedPoint,this.rightGcsToDensifiedPoint,this.progressTracker);if(Number.isNaN(i))return-1;if(i!==-1&&this.leftFactor<i&&i<this.rightFactor)return this.cutFactor=i,this.cutFromDensifiedPoint.assign(this.rectifiedSegment.getCoord2D(this.cutFactor)),this.cutToDensifiedPoint.assign(C(this.cutFromDensifiedPoint,this.transform)),this.cutGcsToDensifiedPoint.setCoordsPoint2D(this.cutToDensifiedPoint),this.cutToDensifiedPoint.assign(C(this.cutGcsToDensifiedPoint,this.transform2)),this.midFactor=this.cutFactor,this.midFromDensifiedPoint.setCoordsPoint2D(this.cutFromDensifiedPoint),this.midToDensifiedPoint.setCoordsPoint2D(this.cutToDensifiedPoint),this.midGcsToDensifiedPoint.setCoordsPoint2D(this.cutGcsToDensifiedPoint),1}if(this.cutFactor=lt(this.leftFactor,this.rightFactor,this.scalars[t]),this.cutFromDensifiedPoint.assign(this.rectifiedSegment.getCoord2D(this.cutFactor)),this.cutToDensifiedPoint.assign(C(this.cutFromDensifiedPoint,this.transform)),this.transform2!==null&&(this.cutGcsToDensifiedPoint.setCoordsPoint2D(this.cutToDensifiedPoint),this.cutToDensifiedPoint.assign(C(this.cutGcsToDensifiedPoint,this.transform2))),t===0&&(this.midFactor=this.cutFactor,this.midFromDensifiedPoint.setCoordsPoint2D(this.cutFromDensifiedPoint),this.midToDensifiedPoint.setCoordsPoint2D(this.cutToDensifiedPoint),this.midGcsToDensifiedPoint.setCoordsPoint2D(this.cutGcsToDensifiedPoint)),this.bIsPannableFrom&&!this.bCheckIfNoDensificationNeededForCurve&&Math.abs(this.leftFromDensifiedPoint.x-this.rightFromDensifiedPoint.x)>=.25*this.pannableExtentFrom.width())return 1;let s;if(this.bCheckIfNoDensificationNeededForCurve){let i=this.projCurveSegment.get().getClosestCoordinate(this.cutToDensifiedPoint,!1),e=this.projCurveSegment.get().getCoord2D(i);s=b.sqrDistance(this.cutToDensifiedPoint,e)}else{let i=new b,e=new b,n=Xt(this.leftToDensifiedPoint,this.cutToDensifiedPoint,this.rightToDensifiedPoint,this.bSrToIsGcs,this.bIsPannableTo,this.pannableExtentTo,i,e);this.line.setStartXY(i),this.line.setEndXY(e);let h=this.line.getClosestCoordinate(this.cutToDensifiedPoint,!0);if(n||t>0||Math.abs(h-this.scalars[t])<.3){let o=this.line.getCoord2D(h);s=b.sqrDistance(this.cutToDensifiedPoint,o)}else s=2*this.maxDeviationInSrToSq,this.bNeedPostFiltering=!0}if(s>this.maxDeviationInSrToSq)return this.bCheckIfNoDensificationNeededForCurve=!1,1}return 0}constructor(t,s,i,e,n,h,o,a,m,c,u,l,g){this.leftFromDensifiedPoint=new b,this.rightFromDensifiedPoint=new b,this.cutFromDensifiedPoint=new b,this.midFromDensifiedPoint=new b,this.leftToDensifiedPoint=new b,this.rightToDensifiedPoint=new b,this.cutToDensifiedPoint=new b,this.midToDensifiedPoint=new b,this.line=new E,this.leftGcsToDensifiedPoint=new b,this.rightGcsToDensifiedPoint=new b,this.cutGcsToDensifiedPoint=new b,this.midGcsToDensifiedPoint=new b,this.bSrToIsGcs=!1,this.bIsCurve=!1,this.leftFactor=0,this.rightFactor=0,this.bIsFirstInPath=!1,this.rectifiedSegment=null,this.transform=null,this.bIsPannableFrom=!1,this.pannableExtentFrom=new D,this.bIsPannableTo=!1,this.bNeedPostFiltering=!1,this.pannableExtentTo=new D,this.transform2=null,this.pHorizon2Info=null,this.pSplitLines2Info=null,this.minLengthInSrFrom=0,this.maxDeviationInSrToSq=0,this.cutFactor=0,this.midFactor=0,this.pDensifiedFactors=null,this.pDensifiedPoints=[],this.rightFromDensifiedPointsStack=[],this.rightToDensifiedPointsStack=[],this.rightGcsToDensifiedPointsStack=[],this.rightFactorsStack=[],this.projCurveSegment=new it,this.n=0,this.bCheckIfNoDensificationNeededForCurve=!1,this.scalars=Pt(Nt-1,Number.NaN),this.progressTracker=g,this.transform=t,this.bIsPannableFrom=s,this.pannableExtentFrom.assign(i),this.bIsPannableTo=e,this.pannableExtentTo.assign(n),this.transform2=h,this.pHorizon2Info=o,this.pSplitLines2Info=a,this.minLengthInSrFrom=m,this.maxDeviationInSrToSq=c,this.pDensifiedFactors=u,this.pDensifiedPoints=l,this.progressTracker=g,this.bNeedPostFiltering=!1}needsPostFiltering(){return this.bNeedPostFiltering}densifySegment(t,s){if(this.bIsFirstInPath=t,this.rectifiedSegment=s,this.leftGcsToDensifiedPoint.setNAN(),this.rightGcsToDensifiedPoint.setNAN(),this.cutGcsToDensifiedPoint.setNAN(),this.midGcsToDensifiedPoint.setNAN(),this.bSrToIsGcs=this.transform2!=null?this.transform2.getOutputSR().getCoordinateSystemType()===1:this.transform.getOutputSR().getCoordinateSystemType()===1,this.bIsCurve=this.rectifiedSegment.isCurve(),this.leftFactor=0,this.rightFactor=1,this.leftFromDensifiedPoint.assign(this.rectifiedSegment.getStartXY()),this.rightFromDensifiedPoint.assign(this.rectifiedSegment.getEndXY()),this.leftToDensifiedPoint.assign(C(this.leftFromDensifiedPoint,this.transform)),this.rightToDensifiedPoint.assign(C(this.rightFromDensifiedPoint,this.transform)),this.transform2!==null&&(this.leftGcsToDensifiedPoint.setCoordsPoint2D(this.leftToDensifiedPoint),this.rightGcsToDensifiedPoint.setCoordsPoint2D(this.rightToDensifiedPoint),this.leftToDensifiedPoint.assign(C(this.leftGcsToDensifiedPoint,this.transform2)),this.rightToDensifiedPoint.assign(C(this.rightGcsToDensifiedPoint,this.transform2)),this.bIsFirstInPath&&!this.pHorizon2Info.isPointStartInHorizon(this.leftGcsToDensifiedPoint,this.progressTracker)))return!1;this.rightFromDensifiedPointsStack.length=0,this.rightToDensifiedPointsStack.length=0,this.rightGcsToDensifiedPointsStack.length=0,this.rightFactorsStack.length=0,this.rightFromDensifiedPointsStack.push(this.rightFromDensifiedPoint.clone()),this.rightToDensifiedPointsStack.push(this.rightToDensifiedPoint.clone()),this.rightFactorsStack.push(this.rightFactor),this.transform2!=null&&this.rightGcsToDensifiedPointsStack.push(this.rightGcsToDensifiedPoint.clone()),this.pDensifiedPoints!==null&&this.pDensifiedPoints.push(this.leftFromDensifiedPoint.clone()),this.pDensifiedFactors!==null&&this.pDensifiedFactors.push(this.leftFactor),this.bIsCurve?this.rectifiedSegment.getGeometryType()===N.enumBezier?this.n=Nt-1:this.n=5:this.n=3,qt(this.n,this.scalars);let i=this.rectifiedSegment.calculateLength2D();if(this.bCheckIfNoDensificationNeededForCurve=!1,this.bIsCurve){let e=new st({vd:this.rectifiedSegment.getDescription()}),n=new F().execute(e,this.transform,this.progressTracker);if(this.transform2!==null){let h=new D;if(n.queryEnvelope(h),!this.pHorizon2Info.isEnvelopeInHorizon(h,this.progressTracker))return!1;n=new F().execute(n,this.transform2,this.progressTracker)}n.getSegmentBuffer(0,this.projCurveSegment,!1),this.bCheckIfNoDensificationNeededForCurve=!0}for(;this.rightFromDensifiedPointsStack.length>0;){let e=!1;if(this.cutFactor=Number.NaN,this.midFactor=Number.NaN,this.midFromDensifiedPoint.setNAN(),this.midToDensifiedPoint.setNAN(),(this.rightFactor-this.leftFactor)*i>this.minLengthInSrFrom){let n=this.checkSegment();if(n===-1)return!1;e=n!==0}if(e)this.rightFromDensifiedPoint.setCoordsPoint2D(this.midFromDensifiedPoint),this.rightToDensifiedPoint.setCoordsPoint2D(this.midToDensifiedPoint),this.rightFactor=this.midFactor,this.rightFromDensifiedPointsStack.push(this.rightFromDensifiedPoint.clone()),this.rightToDensifiedPointsStack.push(this.rightToDensifiedPoint.clone()),this.rightFactorsStack.push(this.rightFactor),this.transform2!==null&&(this.rightGcsToDensifiedPoint.setCoordsPoint2D(this.midGcsToDensifiedPoint),this.rightGcsToDensifiedPointsStack.push(this.rightGcsToDensifiedPoint.clone()));else{if(this.transform2!==null&&!this.pHorizon2Info.isAdjoiningLineInHorizon(this.leftGcsToDensifiedPoint,this.rightGcsToDensifiedPoint,this.progressTracker))return!1;if(this.rightFromDensifiedPointsStack.pop(),this.rightToDensifiedPointsStack.pop(),this.rightFactorsStack.pop(),this.transform2!==null&&this.rightGcsToDensifiedPointsStack.pop(),this.pDensifiedPoints!==null&&this.pDensifiedPoints.push(this.rightFromDensifiedPoint.clone()),this.pDensifiedFactors!==null&&this.pDensifiedFactors.push(this.rightFactor),this.rightFromDensifiedPointsStack.length>0){this.leftFromDensifiedPoint.setCoordsPoint2D(this.rightFromDensifiedPoint),this.leftToDensifiedPoint.setCoordsPoint2D(this.rightToDensifiedPoint),this.leftFactor=this.rightFactor;let n=this.rightFromDensifiedPointsStack.at(-1),h=this.rightToDensifiedPointsStack.at(-1);if(this.rightFromDensifiedPoint.setCoordsPoint2D(n),this.rightToDensifiedPoint.setCoordsPoint2D(h),this.rightFactor=this.rightFactorsStack.at(-1),this.transform2!==null){this.leftGcsToDensifiedPoint.setCoordsPoint2D(this.rightGcsToDensifiedPoint);let o=this.rightGcsToDensifiedPointsStack.at(-1);this.rightGcsToDensifiedPoint.setCoordsPoint2D(o)}}}}return!0}},vt=class{getOperatorType(){return 10315}supportsCurves(){return!1}accelerateGeometry(t,s,i){return!1}canAccelerateGeometry(t){return!1}executeMany(t,s,i,e,n,h){return Ft(i)?new ft(t,s,i,e,n,h):new F().executeMany(t,i,h)}execute(t,s,i,e,n){if(!Ft(s))return new F().execute(t,s,n);let h=new J;return h.prepare(s,null,n),h.execute(t,i,e,n)}},ft=class extends gt{constructor(t,s,i,e,n,h){super(),this.m_spp=null,this.m_index=-1,t||H(""),this.m_progressTracker=h,this.m_geometries=t,this.m_geometriesExtent=s?s.clone():null,this.m_transform=i,this.m_minSegmentLengthInDegrees=e,this.m_maxDeviationInSrTo=n}tock(){return!0}getRank(){return 1}next(){this.m_spp||(this.m_spp=new J,this.m_spp.prepare(this.m_transform,this.m_geometriesExtent,this.m_progressTracker));let t=this.m_geometries.next();return et(t),tt(t),t!=null?(this.m_index=this.m_geometries.getGeometryID(),this.m_spp.execute(t,this.m_minSegmentLengthInDegrees,this.m_maxDeviationInSrTo,this.m_progressTracker)):null}getGeometryID(){return this.m_index}};export{vt as OperatorShapePreservingProject};
