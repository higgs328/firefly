import{c as O}from"./chunk-7A3ZNBEY.js";import{a as u}from"./chunk-4ITLBBRT.js";import{a as d,c as h,d as p}from"./chunk-SJQJMVOJ.js";import{a as w}from"./chunk-KQDXCPD7.js";import{a as r}from"./chunk-2JW3DUYT.js";import{d as t}from"./chunk-4JIR4MZV.js";import{a as o}from"./chunk-63BBKXWS.js";import{b as m,c as g,l as v}from"./chunk-2BJHWKO6.js";import{a}from"./chunk-QCZ3ZIGQ.js";import{c}from"./chunk-VIEK2X23.js";import{a as n}from"./chunk-QGVBCWUY.js";import{e as l}from"./chunk-NFIPKH6V.js";import{l as _}from"./chunk-5QEXLALV.js";var P=["freehand","click"],s=class extends w{constructor(e){super(e),this._isDragging=!1,this._panEnabled=!1,this._addVertexOnPointerUp=!1,this._drawTool=null,this.viewAlignedCoordinateSystem=null,this.mode="freehand"}initialize(){this.view.type==="2d"?this._addViewHandles():this._addDrawTool()}destroy(){this._removeDrawTool(),this.emit("destroy")}complete(){this._completeDrawing()}_getGeometryZValue(){return this.hasZ&&this.vertices.length>0?this.vertices[0][2]:this.defaultZ}_addViewHandles(){this.mode==="click"?this.addHandles(this._getClickModeViewHandles()):this.addHandles(this._getDragModeViewHandles())}_getDragModeViewHandles(){return[this.view.on("immediate-click",e=>{e.stopPropagation(),e.mapPoint&&!this._panEnabled&&this.getCoordsFromScreenPoint(o(e))!=null&&(this._vertexAddHandler(e),this._drawCompleteHandler(e))},t.TOOL),this.view.on("pointer-down",e=>{this._shouldHandlePointerEvent(e)&&(this._abortSnapping(),this._panEnabled||(this._resetGeometry(),this._addVertexOnPointerUp=!0,this._cursorScreenPoint=o(e),this._activePointerId=e.pointerId,this._vertexAddHandler(e),this._isDragging=!1,e.pointerType==="touch"&&this._updateCursor()))},t.TOOL),this.view.on("pointer-move",e=>{this._abortSnapping(),this._activePointerId==null&&e.pointerType!=="touch"&&(this._cursorScreenPoint=o(e),this._updateCursor())},t.TOOL),this.view.on("pointer-drag",e=>{this._shouldHandlePointerEvent(e)&&(this._abortSnapping(),this._isDragging=!0,this._cursorScreenPoint=o(e),this._updateCursor())},t.TOOL),this.view.on("pointer-up",e=>{this._shouldHandlePointerEvent(e)&&this._addVertexOnPointerUp&&(this._abortSnapping(),this._activePointerId=null,this._isDragging&&this._vertexAddHandler(e),this._committedVertices.length===2&&this._drawCompleteHandler(e),this._isDragging=!1)},t.TOOL),this.view.on("key-down",e=>{e.key===r.complete&&this._cursorScreenPoint?(this._abortSnapping(),this._vertexAddHandler(e),this._drawCompleteHandler(e)):e.key===r.pan&&(this._panEnabled=!0)},t.TOOL),this.view.on("key-up",e=>{e.key===r.pan&&(this._panEnabled=!1)},t.TOOL),this.view.on("drag",e=>{this._activePointerId!=null&&e.stopPropagation()},t.TOOL),this.view.on("drag",["Shift"],e=>{e.stopPropagation()},t.TOOL)]}_getClickModeViewHandles(){return[this.view.on("pointer-down",e=>{this._abortSnapping(),this._cursorScreenPoint=o(e),this._activePointerId=e.pointerId,this._isDragging=!1,e.pointerType==="touch"&&this._updateCursor()},t.TOOL),this.view.on("pointer-move",e=>{this._abortSnapping(),this._cursorScreenPoint=o(e),this._activePointerId==null&&e.pointerType!=="touch"&&this._updateCursor()},t.TOOL),this.view.on("pointer-drag",e=>{this._shouldHandlePointerEvent(e)&&(this._abortSnapping(),this._isDragging=!0)},t.TOOL),this.view.on("pointer-up",e=>{this._shouldHandlePointerEvent(e)&&(this._abortSnapping(),this._activePointerId=null,e.stopPropagation(),this._isDragging||this._vertexAddHandler(e),this.vertices.length!==2||this._isDragging||this._drawCompleteHandler(e),this._isDragging=!1)},t.TOOL),this.view.on("key-down",e=>{e.key===r.vertexAdd&&this._cursorScreenPoint&&(this._vertexAddHandler(e),this.vertices.length===2&&this._drawCompleteHandler(e)),e.key===r.complete&&this._cursorScreenPoint&&this.vertices.length===2&&(this._vertexAddHandler(e),this._drawCompleteHandler(e))},t.TOOL)]}_addDrawTool(){let e=new u({view:this.view,elevationInfo:this.elevationInfo,hasZ:this.hasZ,geometryType:"segment",mode:this.mode});this._drawTool=e,this.view.addAndActivateTool(e),this.addHandles([e.on("vertex-add",i=>{i.vertices.length===1&&this.emit("vertex-add",new d(this.view,i.vertices[0].vertexIndex,e.getVertexCoords()))}),e.on("cursor-update",i=>{i.vertices.length===1&&this.emit("cursor-update",new h(this.view,i.vertices[0].vertexIndex,e.getVertexCoords()))}),e.on("complete",i=>{this.emit("draw-complete",new p(e.getVertexCoords())),this._removeDrawTool()}),this.view.on("key-down",i=>{i.key!==r.vertexAdd||i.repeat||this.mode!=="click"?i.key!==r.complete||i.repeat||e.completeCreateOperation():e.drawOperation.numCommittedVertices>0?e.completeCreateOperation():e.drawOperation.commitStagedVertex()},t.TOOL)])}_removeDrawTool(){this._drawTool&&(this.view.tools.remove(this._drawTool),this._drawTool=null)}_addVertex(e){let i=this._coordinateHelper.arrayToVector(e);if(this._isDuplicateOfLastVertex(i))return;this._lastVertexUnsnapped=this._stagedVertexUnsnapped,this._popCursorVertex(),this._editGeometryOperations.appendVertex(i),this._committedVertices.length===1&&(this.viewAlignedCoordinateSystem=O(this.view,this._committedVertices[0]));let y=this._committedVertices.length-1,x=new d(this.view,y,this.vertices);this.emit("vertex-add",x)}_updateCursor(){if(this._popCursorVertex(),!this._cursorScreenPoint)return;let e=this.getCoordsAndPointFromScreenPoint(this._cursorScreenPoint);e!=null&&this._pushCursorVertex(e.vertex,()=>this.emit("cursor-update",new h(this.view,this._activeComponent.vertices.length,this.vertices,this._stagedVertex!=null?new c(this._stagedVertex):null)))}_completeDrawing(){if(this._drawTool)return this._drawTool.completeCreateOperation(),void this.removeAllHandles();if(this._activePointerId=null,this._popCursorVertex(),this._cursorScreenPoint=null,this._isDragging=!1,this._abortSnapping(),this._snappingManager!=null&&this._snappingManager.doneSnapping(),this.vertices.length<1)return;let e=new p(this.vertices);this.emit("draw-complete",e),e.defaultPrevented||this.removeAllHandles()}_resetGeometry(){this._editGeometryOperations.destroy(),this._editGeometryOperations=new v(new g("polygon",this._coordinateHelper),a.Local),this._activeComponent=new m(this._coordinateHelper.spatialReference,a.Local),this._editGeometryOperations.data.components.push(this._activeComponent)}};n([l({type:P})],s.prototype,"mode",void 0),s=n([_("esri.views.draw.SegmentDrawAction")],s);var F=s;export{F as a};
