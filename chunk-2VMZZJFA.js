import{b as S}from"./chunk-JF73MJ44.js";import{a as m,b as I,c as u,d as w,h as L,k as f}from"./chunk-4JY7PCV4.js";import{b as D}from"./chunk-6RBQSBA2.js";import{a as N}from"./chunk-IR6XCBC4.js";import{a as T}from"./chunk-PEW2PLAN.js";import{a as R}from"./chunk-CX5IFQZJ.js";import{o as E}from"./chunk-AUAZP44J.js";import{W as M,f as k}from"./chunk-76ATOSLU.js";import{f as U}from"./chunk-CCJU4DSH.js";import{a as c}from"./chunk-QGVBCWUY.js";import{e as p}from"./chunk-NFIPKH6V.js";import{l as _}from"./chunk-5QEXLALV.js";import{b as v}from"./chunk-YOFFGXOB.js";import{a as h,b as g,f as a}from"./chunk-VTHXE323.js";var V=class{constructor(e){this.moments=[],this.forwardMoments=[],this.moments.push(e)}push(e){return this.forwardMoments.length,this.moments.push(e)}pop(){if(!(this.forwardMoments.length>0))return this.moments.pop()}undo(){if(!this.canUndo())return;let e=this.moments.pop();return this.forwardMoments.push(e),e}peek(){return this.moments.at(-1)}canUndo(){return this.moments.length>1}canRedo(){return this.hasForwardEdits()}redo(){if(!this.canRedo())return;let e=this.forwardMoments.pop();return this.moments.push(e),e}size(){return this.moments.length+this.forwardMoments.length}hasForwardEdits(){return this.forwardMoments.length>0}clearForwardEdits(){this.forwardMoments=[]}};var l=class extends U.JSONSupportMixin(N){constructor(t){super(t),this.url=null,this.sourceJSON=null,this.name=null,this.defaultVersionIdentifier=null,this.capabilities=null,this._isDefault=e=>!e||e===this.defaultVersionIdentifier.name,this._dateEquals=(e,r)=>!e&&!r||!(!e||!r)&&e.toISOString()===r.toISOString(),this._applyEditsHandler=e=>{let{serviceUrl:r,gdbVersion:i,result:s}=e;r===this._featureServiceUrl&&s.then(n=>{let o=n.historicMoment;o&&this._addMomentToVersionItem(i,o)})}}initialize(){this.url=M(this.url),this._featureServiceUrl=this.url.replace(/\/VersionManagementServer/i,"/FeatureServer"),u.has(this.url)||u.set(this.url,new Map);let t=(w.get(this.url)??0)+1;w.set(this.url,t),this.when().then(()=>this.addHandles(L(this._applyEditsHandler)),()=>{})}destroy(){let t=(w.get(this.url)??1)-1;w.set(this.url,t),t===0&&u.delete(this.url),I.delete(this._featureServiceUrl)}read(t,e){this.sourceJSON=t,super.read(t,e)}readDefaultVersionIdentifier(t,e){return{name:e.defaultVersionName,guid:e.defaultVersionGuid}}writeDefaultVersionIdentifier(t,e){e.defaultVersionName=t.name,e.defaultVersionGuid=t.guid}load(t){return this.addResolvingPromise(this._fetchService(this.url,t)),Promise.resolve(this)}createVersion(t){return a(this,null,function*(){let[{createVersion:e},{default:r}]=yield Promise.all([import("./chunk-LHUHU27G.js"),import("./chunk-QTOOA3TA.js")]),i=r.from(t);return e(this.url,i)})}deleteVersion(t){return a(this,null,function*(){let[{deleteVersion:e},{default:r}]=yield Promise.all([import("./chunk-OL4AN5HN.js"),import("./chunk-LN6WPT2H.js")]),i;t.guid&&u.get(this.url)?.has(t.guid)&&(i=m??void 0);let s=new r({versionName:t.name,sessionId:i});return e(this.url,s)})}getVersionInfoExtended(t){return a(this,null,function*(){let{getVersion:e}=yield import("./chunk-XMN5EV5J.js");return e(this.url,t.guid)})}getVersionInfos(){return a(this,arguments,function*(t={}){let[{getVersionInfos:e},{default:r}]=yield Promise.all([import("./chunk-HK24IFOK.js"),import("./chunk-5V3BCUZR.js")]),i=r.from(t);return e(this.url,i)})}reconcile(r){return a(this,arguments,function*(t,e={}){let[{reconcile:i},{default:s}]=yield Promise.all([import("./chunk-FBBZC7O6.js"),import("./chunk-GLEN7DNO.js")]),n=s.from(e);return n.sessionId=m,i(this.url,t.guid,n)})}post(t){return a(this,null,function*(){let[{post:e},{default:r}]=yield Promise.all([import("./chunk-3OYHVIIM.js"),import("./chunk-IPIZVNAO.js")]),i=r.from({sessionId:m});return e(this.url,t.guid,i)})}alterVersion(t,e){return a(this,null,function*(){let[{alterVersion:r},{default:i}]=yield Promise.all([import("./chunk-FANEISNO.js"),import("./chunk-BYYXGANX.js")]),s=i.from(e);return r(this.url,t.guid,s)})}startReading(t){return a(this,null,function*(){return(yield this.startReadingWithResult(t)).success})}startReadingWithResult(t){return a(this,null,function*(){let{startReading:e}=yield import("./chunk-7KVCZVI5.js"),r=yield e(this.url,t.guid,m);if(r.success){let i=yield this.getVersionInfoExtended(t),s=new Date(i.modifiedDate),n={name:i.versionIdentifier.name,moment:s,lockType:"read"};this._addOrUpdateItem(t.guid,n),f(this._featureServiceUrl,null,t.name,s)}return r})}stopReading(t){return a(this,null,function*(){return(yield this.stopReadingWithResult(t)).success})}stopReadingWithResult(t){return a(this,null,function*(){let{stopReading:e}=yield import("./chunk-HFW52EJW.js"),r=yield e(this.url,t.guid,m);return r.success&&(u.get(this.url)?.delete(t.guid),f(this._featureServiceUrl,null,t.name,null)),r})}startEditing(t){return a(this,null,function*(){return(yield this.startEditingWithResult(t)).success})}startEditingWithResult(t){return a(this,null,function*(){let{startEditing:e}=yield import("./chunk-OFRSNMU2.js"),r=yield e(this.url,t.guid,m);if(r.success){let i=yield this.getVersionInfoExtended(t),s=new Date(i.modifiedDate),n=new V(s),o={name:t.name,moment:s,lockType:"edit",stack:n};this._addOrUpdateItem(t.guid,o),f(this._featureServiceUrl,null,t.name,s)}return r})}stopEditing(t,e){return a(this,null,function*(){return(yield this.stopEditingWithResult(t,e)).success})}stopEditingWithResult(t,e){return a(this,null,function*(){if(e){let s=u.get(this.url)?.get(t.guid);if(s?.stack?.canRedo()){let[{deleteForwardEdits:n},{default:o}]=yield Promise.all([import("./chunk-G3A2ZWJR.js"),import("./chunk-RDVDCCL5.js")]),d=yield n(this.url,t.guid,new o({sessionId:m,moment:s.moment}));if(!d.success)return d}}let{stopEditing:r}=yield import("./chunk-LZDBMLOR.js"),i=yield r(this.url,t.guid,m,e);if(i.success){let s=yield this.getVersionInfoExtended(t),n=new Date(s.modifiedDate);this._addOrUpdateItem(t.guid,{name:t.name,moment:n,lockType:"read",editMomentStack:void 0}),f(this._featureServiceUrl,null,t.name,n)}return i})}getLockType(t){return u.get(this.url)?.get(t.guid)?.lockType??"none"}changeVersion(t,e,r){return a(this,null,function*(){if(r&&"name"in r&&!(yield this.getVersionInfoExtended(r)))throw new v("version-management-service:invalid-version","version does not exist");if("networkServiceUrl"in t){if(this._featureServiceUrl.toLowerCase()===t.featureServiceUrl.toLowerCase())return this._changeVersionInternal(t,e,r)}else{let i;"layers"in t?(i=t.allTables.concat(t.allLayers),t.utilityNetworks&&t.utilityNetworks.forEach(s=>{this._featureServiceUrl.toLowerCase()===s.featureServiceUrl.toLowerCase()&&this._changeVersionInternal(s,e,r)})):i=t;for(let s of i)if(s.type==="feature"||s.type==="subtype-group"){let n=/^(.*\/FeatureServer)\/\d+$/,o=s.url.replace(n,"$1");if(this._featureServiceUrl.toLowerCase()===o.toLowerCase()&&!this._changeVersionInternal(s,e,r))return!1}else if(s.type==="group"){let n=s.allTables.concat(s.allLayers);for(let o of n)if(o.type==="feature"||o.type==="subtype-group"){let d=/^(.*\/FeatureServer)\/\d+$/,y=o.url.replace(d,"$1");if(this._featureServiceUrl.toLowerCase()===y.toLowerCase()&&!this._changeVersionInternal(o,e,r))return!1}}}return!0})}changeVersionWithResult(t,e,r){return a(this,null,function*(){let i;if("layers"in t){let n=S(t.allTables.concat(t.allLayers).filter(o=>o.type!=="group").toArray());t.utilityNetworks&&t.utilityNetworks.forEach(o=>{let d=S([o]);n.push(...d)}),i=n}else i=t;if(r&&"name"in r&&!(yield this.getVersionInfoExtended(r))){let n=new Map;for(let o of i)n.set(o,{success:!1});return n}if(e&&"name"in e&&this.getLockType(e)!=="none"){let n=new Map;for(let o of i)n.set(o,{success:!1});return n}let s=new Map;for(let n of i)if(n)if(n.featureServiceUrl.toLowerCase()===this._featureServiceUrl.toLowerCase()){let o=this._changeVersionInternalWithResult(n,e,r);s.set(n,o)}else s.set(n,{success:!1});return s})}getVersionIdentifierFromName(t){return a(this,null,function*(){try{return(yield this.getVersionInfos({includeHidden:!0})).find(r=>r.versionIdentifier.name.toUpperCase()===t.toUpperCase())?.versionIdentifier||null}catch{return null}})}getVersionIdentifierFromGuid(t){return a(this,null,function*(){let{getVersion:e}=yield import("./chunk-XMN5EV5J.js");try{return(yield e(this.url,t)).versionIdentifier}catch{return null}})}canUndo(t){return!!u.get(this.url)?.get(t.guid)?.stack?.canUndo()}canRedo(t){return!!u.get(this.url)?.get(t.guid)?.stack?.canRedo()}undo(t){let e=u.get(this.url)?.get(t.guid),r=e?.stack?.undo()||void 0;if(e&&r){let i=e.stack.peek();f(this._featureServiceUrl,null,t.name,i),u.get(this.url)?.set(t.guid,g(h({},e),{moment:i}))}}redo(t){let e=u.get(this.url)?.get(t.guid),r=e?.stack?.redo()||void 0;e&&r&&(f(this._featureServiceUrl,null,t.name,r),u.get(this.url)?.set(t.guid,g(h({},e),{moment:r})))}_setUpData(t,e){let r=null,i=null,s=null,n=null,o=d=>{let y=u?.get(this.url)?.get(d.guid);s=d.name,n=y?.moment??null};if(t&&"name"in t){if(this.getLockType(t)!=="none")throw new v("version-management-service:version-locked","version is locked");r=t.name,i=null,e&&"name"in e?o(e):(s=this.defaultVersionIdentifier.name,n=e)}else r=this.defaultVersionIdentifier.name,i=t,e&&"name"in e?o(e):(s=this.defaultVersionIdentifier.name,n=e);return{fromVersionName:r,fromMoment:i,toVersionName:s,toMoment:n}}_changeVersionInternal(t,e,r){try{let{fromVersionName:i,fromMoment:s,toVersionName:n,toMoment:o}=this._setUpData(e,r);(this._isDefault(i)&&this._isDefault(t.gdbVersion)&&this._dateEquals(t.historicMoment,s)||i===t.gdbVersion&&this._dateEquals(t.historicMoment,s))&&(t.gdbVersion=n,t.historicMoment=o)}catch{return!1}return!0}_changeVersionInternalWithResult(t,e,r){try{let{fromVersionName:i,fromMoment:s,toVersionName:n,toMoment:o}=this._setUpData(e,r);return this._isDefault(i)&&this._isDefault(t.gdbVersion)&&this._dateEquals(t.historicMoment,s)||i===t.gdbVersion&&this._dateEquals(t.historicMoment,s)?(t.gdbVersion=n,t.historicMoment=o,{success:!0}):{success:!1}}catch{return{success:!1}}}_addMomentToVersionItem(t,e){let r=u.get(this.url);if(r)for(let[i,s]of r)s.name===t&&this._addToStack(i,e)}_addToStack(t,e){let r=u.get(this.url),i=r?.get(t);return!!i?.stack&&(b(i.stack.peek(),e)&&i.stack.push(e),r.set(t,g(h({},i),{moment:e})),!0)}_addOrUpdateItem(t,e){let r=u.get(this.url),i=r?.get(t);return i?(r.set(t,h(h({},i),e)),!0):!(!e.name||!e.lockType)&&(r?.set(t,g(h({},e),{lockType:e.lockType})),!0)}_fetchService(t,e){return a(this,null,function*(){if(this.sourceJSON){this.read(this.sourceJSON,{origin:"service",url:D(t)});let i=new k(this.url).host;return void I.set(i,this.defaultVersionIdentifier.name)}let r=yield E(t,h({responseType:"json",query:{f:"json"}},e));this.read(r.data)})}};function b(t,e){return t?t.getTime()<e.getTime():!0}c([p()],l.prototype,"url",void 0),c([p()],l.prototype,"sourceJSON",void 0),c([p({type:String,json:{write:!0}})],l.prototype,"name",void 0),c([p({json:{write:{target:{defaultVersionName:{type:String},defaultVersionGuid:{type:String}}},read:{source:["defaultVersionName","defaultVersionGuid"]}}})],l.prototype,"defaultVersionIdentifier",void 0),c([T("defaultVersionIdentifier",["defaultVersionName","defaultVersionGuid"])],l.prototype,"readDefaultVersionIdentifier",null),c([R("defaultVersionIdentifier",{defaultVersionName:{type:String},defaultVersionGuid:{type:String}})],l.prototype,"writeDefaultVersionIdentifier",null),c([p({json:{write:!0}})],l.prototype,"capabilities",void 0),l=c([_("esri.versionManagement.VersionManagementService")],l);var Z=l;export{Z as a};
