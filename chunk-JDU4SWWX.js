import{a as Et,b as Ft}from"./chunk-I2JD5OSI.js";import{e as Rt}from"./chunk-MPI26GZ3.js";import{a as it,b as Ot}from"./chunk-7WCQBAQY.js";import{d as rt}from"./chunk-CZMBPC27.js";import{a as jt}from"./chunk-QCZ3ZIGQ.js";import{a as L,b as O,d as I,f as Ht}from"./chunk-PDQQY7RQ.js";import{a as u}from"./chunk-EM35R6FY.js";import{a as at,m as St}from"./chunk-HM5RIVQC.js";import{a as vt}from"./chunk-DEH76MSI.js";import{a as D,d as Q}from"./chunk-ALWV3RJ2.js";import{a as Mt,b as q,c as S,d as j,g as R,j as st,m as bt,n as et,o as p,q as F}from"./chunk-QXXXCEV5.js";import{D as Dt,b as Ct,c as wt,s as yt,y as Tt}from"./chunk-6B5XFA6F.js";import{a as P}from"./chunk-PTZYZULI.js";import{c as tt,l as xt}from"./chunk-NMLYCCKN.js";import{B as gt,f as ft,g as Z,h as $}from"./chunk-ZTOZWLEE.js";import{a as K}from"./chunk-BOVYXYHK.js";import{b as mt,g as _t,l as pt}from"./chunk-EQZWYK27.js";import{a as W}from"./chunk-QGVBCWUY.js";import{e as J}from"./chunk-NFIPKH6V.js";import{l as ut}from"./chunk-5QEXLALV.js";import{f as Y}from"./chunk-4PTIEWMT.js";import{a as dt}from"./chunk-QBWJMFH5.js";var V=class extends Rt{constructor(){super(...arguments),this._projectionMatrix=D()}get projectionMatrix(){return this._projectionMatrix}};W([J()],V.prototype,"_projectionMatrix",void 0),W([J({readOnly:!0})],V.prototype,"projectionMatrix",null),V=W([ut("esri.views.3d.webgl-engine.lib.CascadeCamera")],V);var ct;(function(a){a[a.Highlight=0]="Highlight",a[a.ExcludeHighlight=1]="ExcludeHighlight"})(ct||(ct={}));var B=class{constructor(){this.camera=new V,this.lightMat=D()}},lt=class{constructor(){this.maxNumCascadesHighQuality=4,this.maxNumCascadesLowQuality=4,this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.splitSchemeLambda=0}},Lt=class{constructor(t,e){this._fbos=t,this._viewingMode=e,this._enabled=!1,this._snapshots=new Array,this._textureHeight=0,this._numCascades=1,this.settings=new lt,this._projectionView=D(),this._projectionViewInverse=D(),this._modelViewLight=D(),this._cascadeDistances=[0,0,0,0,0],this._usedCascadeDistances=P(),this._cascades=[new B,new B,new B,new B],this._lastOrigin=null,this._maxTextureWidth=Math.min(dt("esri-mobile")?4096:16384,t.rctx.parameters.maxTextureSize)}dispose(){this.enabled=!1,this.disposeOffscreenBuffers()}get depthTexture(){return this._handle?.getTexture()}get _textureWidth(){return this._textureHeight*this._numCascades}get numCascades(){return this._numCascades}get cascadeDistances(){return tt(this._usedCascadeDistances,this._cascadeDistances[0],this._numCascades>1?this._cascadeDistances[1]:1/0,this._numCascades>2?this._cascadeDistances[2]:1/0,this._numCascades>3?this._cascadeDistances[3]:1/0)}disposeOffscreenBuffers(){this._handle=Y(this._handle),this._discardSnapshots()}set maxCascades(t){this.settings.maxNumCascadesHighQuality=mt(Math.floor(t),1,4)}get maxCascades(){return this.settings.maxNumCascadesHighQuality}set enabled(t){this._enabled=t,t||this.disposeOffscreenBuffers()}get enabled(){return this._enabled}get ready(){return this._enabled&&this.depthTexture!=null}get cascades(){for(let t=0;t<this._numCascades;++t)ot[t]=this._cascades[t];return ot.length=this._numCascades,ot}start(t,e,h,o,r){L(this.enabled);let{near:n,far:c}=Zt(h);this._computeCascadeDistances(n,c,o),this._textureHeight=this._computeTextureHeight(t,r,o),this._setupMatrices(t,e);let{viewMatrix:_,projectionMatrix:C}=t;for(let w=0;w<this._numCascades;++w)this._constructCascade(w,C,_,e);this._lastOrigin=null,this.clear()}finish(){L(this.enabled),this._handle?.detachDepth()}getShadowMapMatrices(t){if(!this._lastOrigin||!Dt(t,this._lastOrigin)){this._lastOrigin=this._lastOrigin||K(),Ct(this._lastOrigin,t);for(let e=0;e<this._numCascades;++e){$(Bt,this._cascades[e].lightMat,t);for(let h=0;h<16;++h)It[16*e+h]=Bt[h]}}return It}moveSnapshot(t){L(this.enabled),this._handle?.detachDepth(),this._snapshots[t]?.release(),this._snapshots[t]=this._handle,this._handle=null,this.clear()}copySnapshot(t){let e=this._handle?.getTexture()?.descriptor;if(!this.enabled||!e)return;this._snapshots[t]?.release();let{width:h,height:o}=e,r=t===ct.Highlight?"shadow highlight snapshot":"shadow no highlight snapshot";this._snapshots[t]=this._fbos.acquire(h,o,r,it.RGBA4);let n=this._fbos.rctx;this._bindFbo();let c=n.bindTexture(this._snapshots[t]?.getTexture(),rt.TEXTURE_UNIT_FOR_UPDATES);n.gl.copyTexSubImage2D(St.TEXTURE_2D,0,0,0,0,0,h,o),n.bindTexture(c,rt.TEXTURE_UNIT_FOR_UPDATES)}getSnapshot(t){return this.enabled?this._snapshots[t]?.getTexture():null}clear(){let t=this._fbos.rctx;this._ensureFbo(),this._bindFbo(),t.setClearColor(1,1,1,1),t.clear(at.COLOR|at.DEPTH)}_computeTextureHeight(t,e,h){let o=Math.min(window.devicePixelRatio,e)/t.pixelRatio,r=h?this.settings.textureSizeModHighQuality:this.settings.textureSizeModLowQuality,n=Et(Math.floor(Math.max(t.fullWidth,t.fullHeight)*o*r)),c=Math.min(this._maxTextureWidth,this._numCascades*n);return Ft(c/this._numCascades)}_ensureFbo(){this._handle?.fbo?.width===this._textureWidth&&this._handle?.fbo.height===this._textureHeight||(this._handle?.release(),this._handle=this._fbos.acquire(this._textureWidth,this._textureHeight,"shadow map",it.RGBA4)),this._handle?.acquireDepth(Ot.DEPTH16_BUFFER)}_discardSnapshot(t){this._snapshots[t]=Y(this._snapshots[t])}_discardSnapshots(){for(let t=0;t<this._snapshots.length;++t)this._discardSnapshot(t);this._snapshots.length=0}_bindFbo(){this._fbos.rctx.bindFramebuffer(this._handle?.fbo)}_constructCascade(t,e,h,o){let r=this._cascades[t],n=-this._cascadeDistances[t],c=-this._cascadeDistances[t+1],_=(e[10]*n+e[14])/Math.abs(e[11]*n+e[15]),C=(e[10]*c+e[14])/Math.abs(e[11]*c+e[15]);L(_<C);for(let l=0;l<8;++l){tt(Qt,l%4==0||l%4==3?-1:1,l%4==0||l%4==1?-1:1,l<4?_:C,1);let T=b[l];xt(T,Qt,this._projectionViewInverse),T[0]/=T[3],T[1]/=T[3],T[2]/=T[3]}yt(ht,b[0]),r.camera.viewMatrix=$(Gt,this._modelViewLight,ht);for(let l=0;l<8;++l)Tt(b[l],b[l],r.camera.viewMatrix);let w=b[0][2],y=b[0][2];for(let l=1;l<8;++l)w=Math.min(w,b[l][2]),y=Math.max(y,b[l][2]);w-=200,y+=200,r.camera.near=-y,r.camera.far=-w,Kt(h,o,w,y,r.camera),Z(r.lightMat,r.camera.projectionMatrix,r.camera.viewMatrix);let H=this._textureHeight;r.camera.viewport=[t*H,0,H,H]}_setupMatrices(t,e){Z(this._projectionView,t.projectionMatrix,t.viewMatrix),ft(this._projectionViewInverse,this._projectionView);let h=this._viewingMode===jt.Global?t.eye:wt(ht,0,0,1);gt(this._modelViewLight,[0,0,0],[-e[0],-e[1],-e[2]],h)}_computeCascadeDistances(t,e,h){let o=h?this.settings.maxNumCascadesHighQuality:this.settings.maxNumCascadesLowQuality;this._numCascades=Math.min(1+Math.floor(Ht(e/t,4)),o);let r=(e-t)/this._numCascades,n=(e/t)**(1/this._numCascades),c=t,_=t;for(let C=0;C<this._numCascades+1;++C)this._cascadeDistances[C]=_t(c,_,this.settings.splitSchemeLambda),c*=n,_+=r}get test(){}},Gt=D(),Qt=P(),b=[];for(let a=0;a<8;++a)b.push(P());var Vt=u(),Nt=u(),Xt=u(),zt=u(),At=u(),ht=K(),ot=[],Bt=D(),It=Q.concat(Q,Q,Q,Q),M=u(),N=u(),E=[u(),u(),u(),u()],m=u(),nt=u(),v=u(),U=u(),z=u(),A=u(),k=u();function Yt(a,t,e,h,o,r,n,c){q(M,0,0);for(let d=0;d<4;++d)S(M,M,a[d]);R(M,M,.25),q(N,0,0);for(let d=4;d<8;++d)S(N,N,a[d]);R(N,N,.25),F(E[0],a[4],a[5],.5),F(E[1],a[5],a[6],.5),F(E[2],a[6],a[7],.5),F(E[3],a[7],a[4],.5);let _=0,C=st(E[0],M);for(let d=1;d<4;++d){let x=st(E[d],M);x<C&&(C=x,_=d)}j(m,E[_],a[_+4]);let w=m[0],y,H;m[0]=-m[1],m[1]=w,j(nt,N,M),p(nt,m)<0&&bt(m,m),F(m,m,nt,e),et(m,m),y=H=p(j(v,a[0],M),m);for(let d=1;d<8;++d){let x=p(j(v,a[d],M),m);x<y?y=x:x>H&&(H=x)}Mt(h,M),R(v,m,y-t),S(h,h,v);let l=-1,T=1,G=0,X=0;for(let d=0;d<8;++d){j(U,a[d],h),et(U,U);let x=m[0]*U[1]-m[1]*U[0];x>0?x>l&&(l=x,G=d):x<T&&(T=x,X=d)}O(l>0,"leftArea"),O(T<0,"rightArea"),R(z,m,y),S(z,z,M),R(A,m,H),S(A,A,M),k[0]=-m[1],k[1]=m[0];let Wt=I(h,a[X],A,S(v,A,k),1,o),Pt=I(h,a[G],A,v,1,r),qt=I(h,a[G],z,S(v,z,k),1,n),kt=I(h,a[X],z,v,1,c);O(Wt,"rayRay"),O(Pt,"rayRay"),O(qt,"rayRay"),O(kt,"rayRay")}function i(a,t){return 3*t+a}var Ut=u();function g(a,t){return q(Ut,a[t],a[t+3]),Ut}var f=u(),s=vt();function Jt(a,t,e,h,o){j(f,e,h),R(f,f,.5),s[0]=f[0],s[1]=f[1],s[2]=0,s[3]=f[1],s[4]=-f[0],s[5]=0,s[6]=f[0]*f[0]+f[1]*f[1],s[7]=f[0]*f[1]-f[1]*f[0],s[8]=1,s[i(0,2)]=-p(g(s,0),a),s[i(1,2)]=-p(g(s,1),a);let r=p(g(s,0),e)+s[i(0,2)],n=p(g(s,1),e)+s[i(1,2)],c=p(g(s,0),h)+s[i(0,2)],_=p(g(s,1),h)+s[i(1,2)];r=-(r+c)/(n+_),s[i(0,0)]+=s[i(1,0)]*r,s[i(0,1)]+=s[i(1,1)]*r,s[i(0,2)]+=s[i(1,2)]*r,r=1/(p(g(s,0),e)+s[i(0,2)]),n=1/(p(g(s,1),e)+s[i(1,2)]),s[i(0,0)]*=r,s[i(0,1)]*=r,s[i(0,2)]*=r,s[i(1,0)]*=n,s[i(1,1)]*=n,s[i(1,2)]*=n,s[i(2,0)]=s[i(1,0)],s[i(2,1)]=s[i(1,1)],s[i(2,2)]=s[i(1,2)],s[i(1,2)]+=1,r=p(g(s,1),t)+s[i(1,2)],n=p(g(s,2),t)+s[i(2,2)],c=p(g(s,1),e)+s[i(1,2)],_=p(g(s,2),e)+s[i(2,2)],r=-.5*(r/n+c/_),s[i(1,0)]+=s[i(2,0)]*r,s[i(1,1)]+=s[i(2,1)]*r,s[i(1,2)]+=s[i(2,2)]*r,r=p(g(s,1),t)+s[i(1,2)],n=p(g(s,2),t)+s[i(2,2)],c=-n/r,s[i(1,0)]*=c,s[i(1,1)]*=c,s[i(1,2)]*=c,o[0]=s[0],o[1]=s[1],o[2]=0,o[3]=s[2],o[4]=s[3],o[5]=s[4],o[6]=0,o[7]=s[5],o[8]=0,o[9]=0,o[10]=1,o[11]=0,o[12]=s[6],o[13]=s[7],o[14]=0,o[15]=s[8]}function Kt(a,t,e,h,o){let r=1/b[0][3],n=1/b[4][3];L(r<n);let c=r+Math.sqrt(r*n),_=Math.sin(pt(a[2]*t[0]+a[6]*t[1]+a[10]*t[2]));c/=_,Yt(b,c,_,Vt,Nt,Xt,zt,At),Jt(Vt,Nt,zt,At,o.projectionMatrix),o.projectionMatrix[10]=2/(e-h),o.projectionMatrix[14]=-(e+h)/(e-h)}function Zt(a){let{near:t,far:e}=a;return t<2&&(t=2),e<2&&(e=2),t>=e&&(t=2,e=4),{near:t,far:e}}export{ct as a,Lt as b};
