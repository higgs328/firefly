import{b as he}from"./chunk-JKHGG7T4.js";import{a as U,b as pe,c as de,d as ce,f as me,g as ye}from"./chunk-KZXCI3DC.js";import{a as y,b as V,c as D}from"./chunk-I76R3PW5.js";import{a as ee}from"./chunk-6RE36L2Q.js";import{h as ue}from"./chunk-6DALCDDU.js";import{x as le}from"./chunk-5A7AFZJT.js";import{f as ie,h as ne,i as oe}from"./chunk-TERDLNGF.js";import{a as te,f as se,g as re,j as ae}from"./chunk-4JY7PCV4.js";import{y as K}from"./chunk-XR5FT7TQ.js";import{a as X,b as F,c as Y}from"./chunk-6RBQSBA2.js";import{a as Z}from"./chunk-K75TK42V.js";import{a as z}from"./chunk-2GJBUR2F.js";import{a as $}from"./chunk-IR6XCBC4.js";import{a as w}from"./chunk-PEW2PLAN.js";import{a as P}from"./chunk-7F5DJLJT.js";import{o as v}from"./chunk-AUAZP44J.js";import{d as G}from"./chunk-KNVXE32P.js";import{A as B,c as H}from"./chunk-76ATOSLU.js";import{f as W}from"./chunk-CCJU4DSH.js";import{a as p}from"./chunk-QGVBCWUY.js";import{e as m}from"./chunk-NFIPKH6V.js";import{l as Q}from"./chunk-5QEXLALV.js";import{p as L,s as E}from"./chunk-4PTIEWMT.js";import{b as I}from"./chunk-YOFFGXOB.js";import{e as j}from"./chunk-6MRUJ2UW.js";import{b as C}from"./chunk-2LI2GKBQ.js";import{y as T}from"./chunk-QBWJMFH5.js";import{a as d,b as f,f as c}from"./chunk-VTHXE323.js";function fe(r){return c(this,arguments,function*({serviceUrl:e,query:s,requestOptions:t={}}){if(s.layers==null&&s.templateIds==null)throw new I("query-shared-templates:invalid-parameters","Must supply a value for either the 'layers' or the 'templateIds' parameters");let o=B(e,"sharedTemplates","query"),a=d(d({f:"json"},t.query),s);a.layers&&(a.layers=k(a.layers)),a.templateIds&&(a.templateIds=k(a.templateIds)),a.tags&&(a.tags=k(a.tags));let i=f(d({},t),{responseType:"json",query:a});return(yield v(o,i)).data.templates})}function k(e){return Array.isArray(e)?e.join(","):""}function A(e,s){let t=s.id;return{id:t,name:s.name,url:`${e}/${t}`,type:s.type||"Table"}}function Se(e){return{data:Ee(e),sync:Ae(e),operations:Ie(e.capabilities,e),query:we(e),editing:Fe(e)}}function Ee(e){return{isDataVersioned:y(e,"hasVersionedData",!1),isDataBranchVersioned:y(e,"hasBranchVersionedData",!1)}}function Ie(e,s){let t=e?e.toLowerCase().split(",").map(n=>n.trim()):[],r=t.includes("query"),o=t.includes("editing")&&!s.datesInUnknownTimezone,a=o&&t.includes("create"),i=o&&t.includes("delete"),l=o&&t.includes("update");return o&&!(a||i||l)&&(a=i=l=!0),{supportsAdd:a,supportsDelete:i,supportsEditing:o,supportsChangeTracking:t.includes("changetracking"),supportsQuery:r,supportsQueryDataElements:y(s,"supportsQueryDataElements",!1),supportsQueryDomains:y(s,"supportsQueryDomains",!1),supportsQueryContingentValues:y(s,"supportsQueryContingentValues",!1),supportsSync:t.includes("sync"),supportsUpdate:l}}function we(e){return{maxRecordCountFactor:V(e,"maxRecordCountFactor",void 0),maxRecordCount:V(e,"maxRecordCount",void 0)}}function Fe(e){let s=e?.advancedEditingCapabilities;return{supportsAsyncApplyEdits:y(s,"supportsAsyncApplyEdits",!1),supportsGlobalId:y(e,"supportsApplyEditsWithGlobalIds",!1),supportsReturnServiceEditsInSourceSpatialReference:y(s,"supportsReturnServiceEditsInSourceSR",!1),supportsSharedTemplates:y(e,"hasSharedTemplates",!1),supportsSplit:y(s,"supportsSplit",!1)}}function Ae(e){let s=e?.syncCapabilities,t=s?.supportedSyncDataOptions;return{supportsAsync:y(s,"supportsAsync",!1),supportedSyncDataOptions:{annotations:!(1&~t),dimensions:!(2&~t),contingentValues:!(4&~t),attributeRules:!(8&~t),utilityNetworkSystem:!(16&~t),annotationFullModel:!(32&~t),include3DObjects:!(64&~t),utilityNetworkMissingLayers:!(128&~t),preserveTrueCurves:!(256&~t)}}}var u=class extends W.JSONSupportMixin(Z.IdentifiableMixin($)){constructor(e){super(e),this.url=null,this.sourceJSON=null,this.userHasFullEditingPrivileges=!1,this.userHasUpdateItemPrivileges=!1,this.userTypeExtensions=[],this.layerInfos=null,this.tableInfos=null,this.capabilities=null}read(e,s){this.sourceJSON=e,super.read(e,s)}get utilityNetworkUrl(){if(this.sourceJSON){for(let e of this.sourceJSON.layers)if(e.type==="Utility Network Layer")return`${this.url}/${e.id}`}return null}get versionManagementServiceUrl(){return this.sourceJSON?.hasBranchVersionedData&&!H(this.url)?this.url.replace(/\/FeatureServer/i,"/VersionManagementServer"):null}readLayerInfos(e,s){return(s.layers||[]).map(t=>{let{type:r,geometryType:o}=t;return f(d({},A(this.url,t)),{type:r||"Feature Layer",geometryType:o})})}readTableInfos(e,s){return(s.tables||[]).map(t=>A(this.url,t))}readCapabilities(e,s){return Se(s)}get effectiveCapabilities(){let e=this.capabilities;if(!e)return null;let s=C(e),{operations:t}=s;return this.userHasUpdateItemPrivileges?(t.supportsAdd=t.supportsDelete=t.supportsEditing=t.supportsQuery=t.supportsUpdate=!0,s):(this.userHasFullEditingPrivileges&&t.supportsEditing&&(t.supportsAdd=t.supportsDelete=t.supportsUpdate=!0),s)}load(e){return this.addResolvingPromise(this._fetchService(this.url,e).then(()=>this._setUserPrivileges(e))),Promise.resolve(this)}fetchAllLayersAndTables(e){return c(this,null,function*(){return yield this.load(e),this._fetchLayersAndTablesPromise||=this._fetchLayersAndTables(this.url),L(e),this._fetchLayersAndTablesPromise})}applyEdits(e,s){return c(this,null,function*(){let t=null;try{let{results:r,edits:o,editedFeatures:a}=yield this._internalApplyEdits(e,s),i=n=>n.filter(b=>!b.error).map(C),l=0;return r.map(n=>{t=ae(this.url,n.id,s?.gdbVersion,!0);let b={edits:o[l],addedFeatures:i(n.addFeatureResults),updatedFeatures:i(n.updateFeatureResults),deletedFeatures:i(n.deleteFeatureResults),addedAttachments:i(n.addAttachmentResults),updatedAttachments:i(n.updateAttachmentResults),deletedAttachments:i(n.deleteAttachmentResults),exceededTransferLimit:!1,historicMoment:n.editMoment?new Date(n.editMoment):null};l+=1,a.length>0&&(b.editedFeatures=a),t.resolve(b),t=null}),r}catch(r){throw t&&t.reject(r),r}})}querySharedTemplates(e){return c(this,null,function*(){let s=d({},e?.query);return s.layers==null&&s.templateIds==null&&(s.layers=this.layerInfos.map(t=>t.id)),(yield fe({serviceUrl:this.url,query:s,requestOptions:e?.requestOptions})).map(t=>{let r=he.fromJSON(t);return r.featureService=this,r})})}_setUserPrivileges(e){return c(this,null,function*(){if(j.userPrivilegesApplied)try{let{features:{fullEdit:s},content:{updateItem:t}}=yield this._fetchUserPrivileges(this.sourceJSON.serviceItemId,e);this._set("userHasFullEditingPrivileges",s),this._set("userHasUpdateItemPrivileges",t)}catch(s){E(s)}})}_fetchUserPrivileges(e,s){return c(this,null,function*(){if(!e)return{features:{edit:!0,fullEdit:!1},content:{updateItem:!1}};let a,i,l;try{a=yield K(this.url,s)}catch(n){E(n)}try{let n=s!=null?s.signal:null;i=yield G?.getCredential(`${a}/sharing`,{prompt:!1,signal:n})}catch(n){E(n)}if(!i)return{features:{edit:!0,fullEdit:!1},content:{updateItem:!1}};try{if(l=new z({id:e,portal:{url:a}}),yield l.load(s),l.portal.user)return ue(l)}catch(n){E(n)}return{features:{edit:!0,fullEdit:!1},content:{updateItem:!1}}})}_internalApplyEdits(e,s){return c(this,null,function*(){yield le(this.url);let t=s?.globalIdUsed??!1,r=P.fromJSON(this.sourceJSON.spatialReference),{edits:o,options:a}=yield this._processApplyEditsParams(e,s),i=yield Promise.all(o.map(h=>c(this,null,function*(){let ge=h.addFeatures?.map(O=>U({spatialReference:r},O,null))??[],q=(yield Promise.all(ge)).filter(T),N=q.length>0?q:null,ve=h.updateFeatures?.map(O=>U({spatialReference:r},O,null))??[],M=(yield Promise.all(ve)).filter(T),x=M.length>0?M:null,_=de(h.identifierFields,h.deleteFeatures,t),be=_.length>0?_:null;ee(N,x,r);let g=yield pe(h.identifierFields,h),J=null;return g&&(J={adds:g.adds.length>0?g.adds:void 0,updates:g.updates.length>0?g.updates:void 0,deletes:g.deletes.length>0?g.deletes:void 0}),{id:h.id,adds:N,updates:x,deletes:be,attachments:J}}))),l={gdbVersion:a?.gdbVersion,rollbackOnFailure:!0,useGlobalIds:t,returnEditMoment:!0,honorSequenceOfEdits:a?.honorSequenceOfEdits,usePreviousEditMoment:a?.usePreviousEditMoment,returnServiceEditsInSourceSR:!1,returnServiceEditsOption:"originalAndCurrentFeatures",async:!1};yield se(this.url,s?.gdbVersion,!0);let n=re(this.url,s?.gdbVersion||null);l.edits=JSON.stringify(i);let b=F(this.url),S=X(b.query,{query:Y(f(d({},l),{f:"json"})),method:"post"}),R;n&&(S.authMode="immediate",S.query.sessionId=te);try{R=yield v(this.url+"/applyEdits",S)}catch(h){if(!ye(h))throw h;S.authMode="immediate",R=yield v(this.url+"/applyEdits",S)}return f(d({},Re(R)),{edits:o})})}_processApplyEditsParams(e,s){return c(this,null,function*(){let t=f(d({},s),{usingFeatureServiceEndpoint:!0});return{edits:yield Promise.all(e.map(r=>c(this,null,function*(){let o=this.effectiveCapabilities,a=r&&(r.addFeatures||r.updateFeatures||r.deleteFeatures),i=r&&(r.addAttachments||r.updateAttachments||r.deleteAttachments);if(oe(r,o,t,!!a,!!i,"feature-service"),!o.data.isDataVersioned&&t?.gdbVersion)throw new I("feature-service:invalid-parameter","'gdbVersion' is applicable only if the layer supports versioned data. See: 'capabilities.data.isDataVersioned'");let l=ne(r,o,"feature-service");return f(d({},yield ie(l)),{id:r.id,identifierFields:r.identifierFields})}))),options:t}})}_fetchService(e,s){return c(this,null,function*(){if(this.sourceJSON)return void this.read(this.sourceJSON,{url:F(e)});let t=yield v(e,d({responseType:"json",query:{f:"json"}},s));this.read(t.data,{url:F(e)})})}_fetchLayersAndTables(e){return c(this,null,function*(){let s=`${e}/layers`,t=yield v(s,{responseType:"json",query:{f:"json"}});return{layers:t.data.layers.map(r=>{let{type:o,geometryType:a}=r,i=A(this.url,r),l=D(r,i.url);return f(d({},i),{type:o||"Feature Layer",geometryType:a,capabilities:l})}),tables:t.data.tables.map(r=>{let o=A(this.url,r),a=D(r,o.url);return f(d({},o),{capabilities:a})})}})}};function Re(e){let s=e.data,t=[];return{results:s.map(r=>{let o={addResults:r.addResults??[],updateResults:r.updateResults??[],deleteResults:r.deleteResults??[],attachments:r.attachments,editMoment:r.editMoment},a=ce(o),i=r.editedFeatures,l=i?.spatialReference?new P({wkid:i?.spatialReference.wkid,wkt:i?.spatialReference.wkt,latestWkid:i?.spatialReference.latestWkid,latestVcsWkid:i?.spatialReference.latestVcsWkid,vcsWkid:i?.spatialReference.vcsWkid}):null,n=i?me(i,l):null;return n&&t.push({layerId:r.id,editedFeatures:n}),d({id:r.id,editedFeatures:n},a)}),editedFeatures:t}}p([m()],u.prototype,"url",void 0),p([m()],u.prototype,"sourceJSON",void 0),p([m()],u.prototype,"userHasFullEditingPrivileges",void 0),p([m()],u.prototype,"userHasUpdateItemPrivileges",void 0),p([m({readOnly:!0})],u.prototype,"utilityNetworkUrl",null),p([m({readOnly:!0})],u.prototype,"versionManagementServiceUrl",null),p([m()],u.prototype,"userTypeExtensions",void 0),p([m({json:{read:{source:["layers"]}}})],u.prototype,"layerInfos",void 0),p([w("layerInfos",["layers"])],u.prototype,"readLayerInfos",null),p([m({json:{read:{source:["tables"]}}})],u.prototype,"tableInfos",void 0),p([w("tableInfos",["tables"])],u.prototype,"readTableInfos",null),p([m({readOnly:!0,json:{read:{source:["hasVersionedData","hasSharedTemplates","hasBranchVersionedData","capabilities","supportsQueryDataElements","supportsQueryDomains","supportsQueryContingentValues","maxRecordCountFactor","maxRecordCount","advancedEditingCapabilities","supportsApplyEditsWithGlobalIds","syncCapabilities","datesInUnknownTimezone"]}}})],u.prototype,"capabilities",void 0),p([w("capabilities",["hasVersionedData","hasSharedTemplates","hasBranchVersionedData","capabilities","supportsQueryDataElements","supportsQueryDomains","supportsQueryContingentValues","maxRecordCountFactor","maxRecordCount","advancedEditingCapabilities","supportsApplyEditsWithGlobalIds","syncCapabilities","datesInUnknownTimezone"])],u.prototype,"readCapabilities",null),p([m({readOnly:!0})],u.prototype,"effectiveCapabilities",null),u=p([Q("esri.rest.featureService.FeatureService")],u);var pt=u;export{pt as a};
