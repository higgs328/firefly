import{a as X}from"./chunk-XPTSGTNZ.js";import{d as W}from"./chunk-FZV4JEHO.js";import{a as M}from"./chunk-52JRYXZN.js";import{a as Q}from"./chunk-AC55GQHL.js";import{c as K}from"./chunk-D4ULQQN7.js";import{a as L}from"./chunk-LORHDXEB.js";import{a as u}from"./chunk-6F25LG6O.js";import{d as k,f as j,g as q}from"./chunk-OLOKUDVI.js";import{c as z,i as p}from"./chunk-DYTVXYAV.js";import{a as J}from"./chunk-BOVYXYHK.js";import{a as f,k as y}from"./chunk-TG45K3WR.js";import{f as A}from"./chunk-RAI4DTMT.js";import{b as U}from"./chunk-ACP3S2CH.js";import{a as e}from"./chunk-QGVBCWUY.js";import{H as h}from"./chunk-MYO4NP2N.js";import{e as i}from"./chunk-NFIPKH6V.js";import{l as c}from"./chunk-5QEXLALV.js";import{F as I,b as B,e as S,p as x}from"./chunk-4PTIEWMT.js";import{a as F}from"./chunk-TG2UTNEO.js";import{y as G}from"./chunk-QBWJMFH5.js";import{f as O}from"./chunk-VTHXE323.js";var b=class extends h{constructor(){super({}),this.color=new u([50,50,50,.7]),this.intervalOptions=new U([p(15,"minutes","milliseconds"),p(30,"minutes","milliseconds"),p(1,"hours","milliseconds"),p(2,"hours","milliseconds"),p(3,"hours","milliseconds")]),this.interval=this.intervalOptions.at(0)}set intervalOptions(t){this._set("intervalOptions",L(t,this._get("intervalOptions")))}};e([i({type:u})],b.prototype,"color",void 0),e([i()],b.prototype,"interval",void 0),e([i({type:U})],b.prototype,"intervalOptions",null),b=e([c("esri.widgets.ShadowCast.DiscreteOptions")],b);var R=b;var D;(function(t){t.Continuous="continuous",t.Hourly="hourly"})(D||(D={}));var C=class extends h{constructor(){super(...arguments),this.color=new u([0,0,255,.7]),this.mode=D.Continuous}};e([i({type:u})],C.prototype,"color",void 0),e([i()],C.prototype,"mode",void 0),C=e([c("esri.widgets.ShadowCast.DurationOptions")],C);var E=C;var P;(function(t){t.Disabled="disabled",t.Ready="ready"})(P||(P={}));var _;(function(t){t.PointerMove="pointer-move",t.Main="main"})(_||(_={}));var et=300,m=class extends h{constructor(t){super(t),this._screenPoint=null,this._accumulatedShadowTime=null,this._shadowTimeTask=null,this._updateAccumulatedShadowTime=(o,s)=>{this._shadowTimeTask=S(this._shadowTimeTask),this._shadowTimeTask=A(a=>O(this,null,function*(){let{results:n,ground:v}=yield o.hitTest(s);if(x(a),n.length===0&&!v.mapPoint)return void(this._accumulatedShadowTime=null);let T=yield this.getDuration(s,a);this._accumulatedShadowTime=T}))},this._throttledUpdateAccumulatedShadowTime=Q(this._updateAccumulatedShadowTime,et)}initialize(){this.addHandles(f(()=>({enabled:this.enabled,view:this.view}),({enabled:t,view:o})=>{t&&o!=null?this._startTracking(o):this._stopTracking()},y))}get screenPoint(){return this.enabled?this._screenPoint:null}get accumulatedShadowTime(){return this.enabled?this._accumulatedShadowTime:null}get testData(){}_startTracking(t){if(this.hasHandles(_.Main))return;let o=()=>{this.hasHandles(_.PointerMove)||this.addHandles(t.on("pointer-move",a=>{let n=k(a.x,a.y);this._screenPoint=n,this._throttledUpdateAccumulatedShadowTime(t,n)}),_.PointerMove)},s=()=>{this.removeHandles(_.PointerMove),this._screenPoint=null,this._accumulatedShadowTime=null};this.addHandles([this._throttledUpdateAccumulatedShadowTime,t.on("pointer-enter",o),t.on("pointer-leave",s),t.on("pointer-down",s),t.on("pointer-drag",s),t.on("pointer-up",o),t.on("click",a=>{let n=k(a.x,a.y);this._screenPoint=n,this._updateAccumulatedShadowTime(t,n)}),F(()=>{this._shadowTimeTask=S(this._shadowTimeTask)})],_.Main),o()}_stopTracking(){this.removeHandles(_.Main)}};e([i()],m.prototype,"getDuration",void 0),e([i()],m.prototype,"view",void 0),e([i()],m.prototype,"enabled",void 0),e([i()],m.prototype,"screenPoint",null),e([i()],m.prototype,"accumulatedShadowTime",null),e([i()],m.prototype,"_screenPoint",void 0),e([i()],m.prototype,"_accumulatedShadowTime",void 0),e([i()],m.prototype,"_shadowTimeTask",void 0),m=e([c("esri.widgets.ShadowCast.ShadowTooltipViewModel")],m);var d;(function(t){t.Threshold="threshold",t.Duration="duration",t.Discrete="discrete"})(d||(d={}));var Qt=[d.Threshold,d.Duration,d.Discrete];var w=class extends h{constructor(){super(...arguments),this.color=new u([255,0,0,.7]),this.value=p(4,"hours","milliseconds"),this.minValue=0,this.maxValue=p(8,"hours","milliseconds")}};e([i({type:u})],w.prototype,"color",void 0),e([i()],w.prototype,"value",void 0),e([i()],w.prototype,"minValue",void 0),e([i()],w.prototype,"maxValue",void 0),w=e([c("esri.widgets.ShadowCast.ThresholdOptions")],w);var H=w;var Y=[],it=J(),Z=[],$=255,ot=p(1,"hours","milliseconds"),rt=500,r=class extends h{constructor(t){super(t),this.view=null,this.tooltip=new m({getDuration:(o,s)=>this.getDuration(o,s)}),this.startTimeOfDay=p(10,"hours","milliseconds"),this.endTimeOfDay=p(16,"hours","milliseconds"),this.visualizationType=d.Threshold,this.thresholdOptions=new H,this.durationOptions=new E,this.discreteOptions=new R,this._running=!0,this._stopPreviewingTask=null,this._forcePreview=!1,this._autoRestoreForcePreviewEnabled=!0,this._utcOffset=null,this.date=new Date}initialize(){this.addHandles([f(()=>({view:this.view,tooltipEnabled:this._tooltipEnabled}),({view:t,tooltipEnabled:o})=>{this.tooltip.view=t,this.tooltip.enabled=o},y),f(()=>this._forcePreviewDependencies,()=>{S(this._stopPreviewingTask),this._forcePreview=!0,this._autoRestoreForcePreviewEnabled&&(this._stopPreviewingTask=A(t=>O(this,null,function*(){yield I(rt,t),x(t),this._forcePreview=!1})))},y),f(()=>({renderer:this.renderer,parameters:this._visualizationParameters}),t=>V(t.renderer,t.parameters),y),f(()=>({renderer:this.renderer,parameters:{lightDirections:this._lightDirections}}),t=>V(t.renderer,t.parameters),y),f(()=>({renderer:this.renderer,parameters:{enabled:this._running}}),t=>V(t.renderer,t.parameters),y),f(()=>({renderer:this.renderer,parameters:{previewing:this._previewing}}),t=>V(t.renderer,t.parameters),y)])}destroy(){this.stop(),V(this.renderer,{enabled:!1}),B(this.tooltip)}get state(){return this.view!=null&&this.view.ready&&this._referencePosition!=null?P.Ready:P.Disabled}set date(t){let o=new Date(t);o.setHours(0,0,0,0),this._set("date",o)}get utcOffset(){return this._utcOffset??this._utcOffsetAuto}set utcOffset(t){this._utcOffset=t}get testData(){}get _previewing(){let{view:t}=this;return t?.allLayerViews==null||this._forcePreview||!t.stationary||t.allLayerViews.some(o=>N(o)&&o.updating)}get _utcOffsetAuto(){let t=this._referencePosition;return t!=null?K(t[0],!1):0}get _dateUTCOffset(){let t=this.date;return t=z(t,-t.getTimezoneOffset(),"minutes"),t=z(t,-this.utcOffset,"hours"),t}get _startDateTimeUTC(){return z(this._dateUTCOffset,this.startTimeOfDay)}get _endDateTimeUTC(){return z(this._dateUTCOffset,this.endTimeOfDay)}get _referencePosition(){return this.view?.environmentManager?.referencePositionGeographic}get _interval(){let t=this._duration>0?Math.floor(this._duration/$):$,o=this.discreteOptions.interval;switch(this.visualizationType){case d.Threshold:case d.Duration:return t;case d.Discrete:return o>0?o:t}}get _sampleCount(){return this._lightDirections.length}get _duration(){return this.endTimeOfDay-this.startTimeOfDay}get _lightDirections(){let{view:t}=this;if(t==null)return Y;let o=t.viewingMode==="global"?it:this._referencePosition;if(o==null)return Y;let s=this._interval,a=W(this._startDateTimeUTC,this._endDateTimeUTC,s,o,t.state.viewingMode),n=a.length;Z.length=0;let v=X(0,n,Z),T=new Array(n);for(let g=0;g<n;++g)T[g]=a[v[g]];return T}get _tooltipEnabled(){return this.state===P.Ready&&this.visualizationType!==d.Discrete&&this._running&&!this._previewing}get _visualizationParameters(){if(!this._running)return null;switch(this.visualizationType){case d.Threshold:return this._thresholdVisualizationParameters;case d.Duration:return this._durationVisualizationParameters;case d.Discrete:return this._discreteVisualizationParameters}}get _thresholdVisualizationParameters(){let{value:t,color:o}=this.thresholdOptions,s=this._duration;return{visualization:M.Threshold,color:u.toUnitRGBA(o),threshold:s>0?t/this._duration:0}}get _durationVisualizationParameters(){let{color:t,mode:o}=this.durationOptions,s=this._duration,a=s>0&&o===D.Hourly?ot/s:0;return{color:u.toUnitRGBA(t),visualization:M.Gradient,bandsEnabled:a>0,bandSize:a}}get _discreteVisualizationParameters(){return{color:u.toUnitRGBA(this.discreteOptions.color),visualization:M.Gradient,bandsEnabled:!1,bandSize:0}}get _forcePreviewDependencies(){let{view:t}=this;if(t==null)return null;let o=t.slicePlane,s=t.allLayerViews.toArray().filter(N),a=s.map(l=>l.layer).filter(G),n=s.map(l=>l.visible),v=a.map(l=>l.visible),T=a.map(l=>l.opacity),g=a.filter(l=>"definitionExpression"in l).map(l=>l.definitionExpression),tt=s.filter(l=>"filter"in l).map(l=>l.filter);return{slicePlane:o,startDateUTC:this._startDateTimeUTC,endDateUTC:this._endDateTimeUTC,layerViewVisibilities:n,layerVisibilities:v,layerOpacities:T,filters:tt,definitionExpressions:g}}get renderer(){let{view:t}=this;if(t==null)return null;let o=t._stage;return o==null?null:o.renderer}start(){this.setRunning(!0)}stop(){this.setRunning(!1)}setRunning(t){this._running=t}getDuration(t,o){return O(this,null,function*(){let{view:s,renderer:a,_sampleCount:n}=this;if(s==null||a==null||n===0)return 0;let v=s.state.camera.screenToRender(j(t.x,t.y),q());return a.readAccumulatedShadow(v)*this._duration})}};function V(t,o){t!=null&&o!=null&&t.setParameters({shadowCast:o})}function N(t){if(t.suspended)return!1;switch(t.type){case"building-scene-3d":case"csv-3d":case"elevation-3d":case"feature-3d":case"geojson-3d":case"graphics-3d":case"integrated-mesh-3d":case"integrated-mesh-3dtiles":case"ogc-feature-3d":case"route-3d":case"scene-layer-3d":case"scene-layer-graphics-3d":case"stream-3d":case"wms-3d":return!0;case"base-dynamic-3d":case"catalog-3d":case"catalog-footprint-3d":case"catalog-dynamic-group-3d":case"dimension-3d":case"imagery-3d":case"imagery-tile-3d":case"line-of-sight-3d":case"map-image-3d":case"point-cloud-3d":case"tile-3d":case"vector-tile-3d":case"viewshed-3d":case"voxel-3d":case"wfs-3d":case"wmts-3d":case"media-3d":default:return!1;case"group":return t.layerViews.toArray().some(o=>N(o))}}e([i()],r.prototype,"state",null),e([i()],r.prototype,"view",void 0),e([i()],r.prototype,"tooltip",void 0),e([i({type:Date,nonNullable:!0})],r.prototype,"date",null),e([i({nonNullable:!0})],r.prototype,"utcOffset",null),e([i({nonNullable:!0})],r.prototype,"startTimeOfDay",void 0),e([i({nonNullable:!0})],r.prototype,"endTimeOfDay",void 0),e([i({nonNullable:!0})],r.prototype,"visualizationType",void 0),e([i({type:H,nonNullable:!0})],r.prototype,"thresholdOptions",void 0),e([i({type:E,nonNullable:!0})],r.prototype,"durationOptions",void 0),e([i({type:R,nonNullable:!0})],r.prototype,"discreteOptions",void 0),e([i()],r.prototype,"_running",void 0),e([i()],r.prototype,"_stopPreviewingTask",void 0),e([i()],r.prototype,"_forcePreview",void 0),e([i()],r.prototype,"_autoRestoreForcePreviewEnabled",void 0),e([i()],r.prototype,"_previewing",null),e([i()],r.prototype,"_utcOffset",void 0),e([i()],r.prototype,"_utcOffsetAuto",null),e([i()],r.prototype,"_dateUTCOffset",null),e([i()],r.prototype,"_startDateTimeUTC",null),e([i()],r.prototype,"_endDateTimeUTC",null),e([i()],r.prototype,"_referencePosition",null),e([i()],r.prototype,"_interval",null),e([i()],r.prototype,"_sampleCount",null),e([i()],r.prototype,"_duration",null),e([i()],r.prototype,"_lightDirections",null),e([i()],r.prototype,"_tooltipEnabled",null),e([i()],r.prototype,"_visualizationParameters",null),e([i()],r.prototype,"_thresholdVisualizationParameters",null),e([i()],r.prototype,"_durationVisualizationParameters",null),e([i()],r.prototype,"_discreteVisualizationParameters",null),e([i()],r.prototype,"_forcePreviewDependencies",null),e([i()],r.prototype,"renderer",null),r=e([c("esri.widgets.ShadowCast.ShadowCastViewModel")],r);var Ue=r;export{P as a,D as b,d as c,Ue as d};
