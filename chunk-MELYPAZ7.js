import{w as Q}from"./chunk-PKVI3POI.js";import{a as k}from"./chunk-2SJBRRT6.js";import{$,aa as B}from"./chunk-KALOJIUA.js";import{a as z}from"./chunk-IR6XCBC4.js";import{b as R,o as w}from"./chunk-AUAZP44J.js";import{f as q}from"./chunk-CCJU4DSH.js";import{a}from"./chunk-QGVBCWUY.js";import{H as x}from"./chunk-MYO4NP2N.js";import{e as u}from"./chunk-NFIPKH6V.js";import{l as v}from"./chunk-5QEXLALV.js";import{y as A}from"./chunk-QBWJMFH5.js";import{a as S,f as j}from"./chunk-VTHXE323.js";var _=class extends x{constructor(e){super(e),this.maxValue=null,this.minValue=null,this.codedValue=null}};a([u()],_.prototype,"objectType",void 0),a([u()],_.prototype,"maxValue",void 0),a([u()],_.prototype,"minValue",void 0),a([u()],_.prototype,"codedValue",void 0),_=a([v("esri.layers.support.ContingentValue")],_);var h=_;var F=class extends x{constructor(e){super(e),this.isRetired=!1}};a([u()],F.prototype,"id",void 0),a([u()],F.prototype,"isRetired",void 0),a([u()],F.prototype,"subtype",void 0),a([u()],F.prototype,"values",void 0),F=a([v("esri.layers.support.Contingency")],F);var I=F;var D=class extends x{constructor(e){super(e)}};a([u()],D.prototype,"fieldGroup",void 0),a([u()],D.prototype,"type",void 0),D=a([v("esri.layers.support.ContingencyConstraintViolation")],D);var J=D;var E=class extends x{constructor(e){super(e)}};a([u()],E.prototype,"contingentValuesAllGroups",void 0),a([u()],E.prototype,"contingentValuesByFieldGroup",void 0),E=a([v("esri.layers.support.ContingentValuesResult")],E);var M=E;var C=class extends x{constructor(e){super(e),this.fields=null,this.isEditingRestrictive=!1}};a([u()],C.prototype,"name",void 0),a([u()],C.prototype,"fields",void 0),a([u()],C.prototype,"isEditingRestrictive",void 0),a([u()],C.prototype,"contingencies",void 0),C=a([v("esri.layers.support.FieldGroup")],C);var N=C;var L,G=L=class extends q.JSONSupportMixin(z){constructor(e){super(e),this.request=w,this.fieldGroups=null,this.fieldGroupDefinitions=null}initialize(){}get subtypeFieldName(){return Q(this.layer).typeFieldName}static createLoadedLayerContingentValuesCache(e){return j(this,null,function*(){yield e.load();let t=e.sourceJSON;if(e.layerId===void 0)return null;let n=t.hasContingentValuesDefinition;if(n)return new L({layer:e}).load();if(n===void 0){let i=R(e.url);if(i==null)return null;let o=i.url.path;if((yield H(o)).supportsQueryDataElements){let s=e.layerId.toString(),r=yield P(o,s);if(r){let V=r.map(g=>({name:g.name,isEditingRestrictive:g.isEditingRestrictive,fields:g.fieldNames.names.map(c=>e.fieldsIndex.normalizeFieldName(c))}));return new L({layer:e,fieldGroupDefinitions:V}).load()}}}return null})}load(e){return j(this,null,function*(){let t=this.layer.load(e).then(()=>this._initializeContingentValues(this.fieldGroupDefinitions,e));return this.addResolvingPromise(t),this})}validateContingencyConstraints(e,t){let n=Object.keys(e),i=[],o=[];for(let s of this.fieldGroups){let r=s.isEditingRestrictive?"error":"warning";if(t&&!s.fields.some(d=>t.includes(d)))continue;if(!s.fields.every(d=>n.includes(d))){o.push(new J({fieldGroup:s,type:r}));continue}let V=!1,g=e[this.subtypeFieldName],c=s.contingencies.filter(d=>!(!d.isRetired&&d.subtype)||d.subtype.code===g);if(c.length!==0){for(let d of c){let p=!0;for(let f in d.values){let l=d.values[f];if(l.objectType!=="any"){if(l.objectType==="null"){if(e[f]!=null){p=!1;break}}else if(l.objectType==="code"){if(e[f]!==l.codedValue.code){p=!1;break}}else if(l.objectType==="range"){let m=e[f];if(m<l.minValue||m>l.maxValue){p=!1;break}}}}if(p){V=!0;break}}V||i.push(new J({fieldGroup:s,type:r}))}}return{invalid:i,incomplete:o}}getContingentValues(e,t,n=!1){let i=e[this.subtypeFieldName],o=i!=null,s={},r=[],V=this.fieldGroups.filter(g=>g.fields.includes(t));r.push(new h({objectType:"any"}));for(let g of V){let c=[],d=g.contingencies.filter(l=>!(l.isRetired||l.subtype&&o&&l.subtype.code!==i)),p=!1,f={};for(let l of d){let m,T=!0;for(let y in l.values){let b=l.values[y];if(t!==y){if(e[y]!==void 0&&b.objectType!=="any"){if(b.objectType==="null")e[y]!==null&&(T=!1);else if(b.objectType==="code")e[y]!==b.codedValue.code&&(T=!1);else if(b.objectType==="range"){let O=e[y];(O<b.minValue||O>b.maxValue)&&(T=!1)}}}else m=b,p=p||b.objectType==="range"}if(m&&T){if(m.objectType==="any"){c.length=0,c.push(m);break}let y=K(m);f[y]||c.push(m),f[y]=!0}}p&&(c=U(c)),s[g.name]=c,r=n?Y(r,c):[]}return V.length===1&&n&&(r=[]),new M({contingentValuesAllGroups:r,contingentValuesByFieldGroup:s})}_initializeContingentValues(e,t){return j(this,null,function*(){let n=e??(yield this._fetchFieldGroupDefs(t));if(n.length===0)return void(this.fieldGroups=[]);let i=yield this._fetchContingentValues(n,t);this.fieldGroups=i})}_fetchFieldGroupDefs(e){return j(this,null,function*(){if(this.layer.layerId===void 0)return[];let t=this.layer.sourceJSON,n=this.layer.layerId.toString(),i=R(this.layer.url).url.path;return t.hasContingentValuesDefinition?(yield Z(i,n,e)).map(o=>({name:o.name,isEditingRestrictive:o.restrictive,fields:o.fields.map(s=>this.layer.fieldsIndex.normalizeFieldName(s))})):t.hasContingentValuesDefinition!==void 0?[]:H(i,e).then(o=>j(this,null,function*(){return o.supportsQueryDataElements?(yield P(i,n,e)).map(s=>({name:s.name,isEditingRestrictive:s.isEditingRestrictive,fields:s.fieldNames.names.map(r=>this.layer.fieldsIndex.normalizeFieldName(r))})):[]}))})}_fetchContingentValues(e,t){return j(this,null,function*(){if(this.layer.layerId===void 0)return[];let n=this.layer.sourceJSON,i=this.layer.layerId.toString(),o=R(this.layer.url).url.path;if(n.hasContingentValuesDefinition){let r=yield te(o,i,t);return this._constructFieldGroupsAGOL(e,r)}let s=yield ee(o,i,t);return this._constructFieldGroupsEnterprise(e,s)})}_constructFieldGroupsAGOL(e,t){return e.map(n=>{let i=t.contingentValuesDefinition.fieldGroups.find(o=>o.name===n.name);if(i){let o=[];return o=t.contingentValuesDefinition.hasSubType?this._parseAGOLFieldGroupSubtype(n,t,i.subTypes):this._parseAGOLFieldGroup(n,t,i.contingentValues),new N({name:n.name,isEditingRestrictive:n.isEditingRestrictive,fields:n.fields,contingencies:o})}return null}).filter(A)}_parseAGOLFieldGroupSubtype(e,t,n){let i=[];return n?.forEach(o=>{let s=this._getSubtypeAGOL(o.name);i=i.concat(this._parseAGOLFieldGroup(e,t,o.contingentValues,s))}),i}_parseAGOLFieldGroup(e,t,n,i=null){let o=[];for(let s of n??[]){let r=this._parseAGOLContingency(s,e,t,i);o.push(r)}return o}_parseAGOLContingency(e,t,n,i){let o=e.id,s=!!e.retired&&e.retired===1,r={};for(let V=0,g=0;V<t.fields.length;V++){let c=t.fields[V],d=n.typeCodes[e.types[V]];if(d==="Code"){let p=e.values[g];g++;let f=this._getDomain(i,c);if(this.layer.getField(c)?.type==="string"){let y=n.stringDicts.find(b=>b.domain===f?.name);y&&(p=y.entries[p])}let m=f?.codedValues.find(y=>y.code===p),T=new h({codedValue:m,objectType:"code"});r[c]=T}else if(d==="Range"){let p=e.values[g];g++;let f=p.range[0],l=p.range[1],m=new h({minValue:f,maxValue:l,objectType:"range"});r[c]=m}else if(d==="Any"){let p=new h({objectType:"any"});r[c]=p}else{let p=new h({objectType:"null"});r[c]=p}}return new I({id:o,isRetired:s,subtype:i,values:r})}_constructFieldGroupsEnterprise(e,t){let n=t.fieldGroups;return e.map(i=>{let o=n.find(s=>s.name===i.name);if(o){let s=o.contingencies.map(r=>{let V=r.id,g=r.isRetired||!1,c=this._getSubtypeEnterprise(r.subtypeCode),d={};for(let p=0;p<i.fields.length;p++){let f=i.fields[p],l=r.values[p];if(typeof l=="number"||typeof l=="string"){let m=this._getDomain(c,f),T=this.layer.getField(f);$(T)?l=t.stringDictionary[l]:B(T)&&(l=new Date(`${l}+00:00`).getTime());let y=m?.codedValues.find(O=>O.code===l),b=new h({codedValue:y,objectType:"code"});d[f]=b}else if(typeof l=="object"){let m=l.minValue,T=l.maxValue,y=new h({minValue:m,maxValue:T,objectType:"range"});d[f]=y}else if(l){let m=new h({objectType:"any"});d[f]=m}else{let m=new h({objectType:"null"});d[f]=m}}return new I({id:V,isRetired:g,subtype:c,values:d})});return new N({name:i.name,isEditingRestrictive:i.isEditingRestrictive,fields:i.fields,contingencies:s})}return null}).filter(A)}_getSubtypeEnterprise(e){let t=this.layer.sourceJSON,n;if(t.subtypes){let i=t.subtypes.find(o=>o.code===e);n=k.fromJSON(i)}return n||null}_getSubtypeAGOL(e){let t=this.layer.sourceJSON,n;if(t.subtypes){let i=t.subtypes.find(o=>o.name===e);n=k.fromJSON(i)}return n||null}_getDomain(e,t){let n=e?ne(e,t):this.layer.getFieldDomain(t);return n?.type==="inherited"?this.layer.getFieldDomain(t):n}};function K(e){switch(e.objectType){case"any":return"@any@";case"null":return"@null@";case"code":return e.codedValue.name+e.codedValue.code.toString();case"range":return e.minValue.toString()+"-"+e.maxValue.toString()}}function U(e){let t,n;e.sort((o,s)=>o.objectType==="null"?-1:s.objectType==="null"?1:o.minValue-s.minValue);let i=[];for(let o of e)o.objectType!=="null"?t!=null&&n!=null?n<o.minValue?(i.push(new h({objectType:"range",minValue:t,maxValue:n})),t=o.minValue,n=o.maxValue):n<o.maxValue&&(n=o.maxValue):(t=o.minValue,n=o.maxValue):i.push(o);return i.push(new h({objectType:"range",minValue:t,maxValue:n})),i}function W(e,t){let n=[],i,o=0;for(let s of e)for(;o<t.length;o++){let r=t[o];if(s.objectType==="null"&&r.objectType==="null")n.push(new h({objectType:"null"}));else{if(s.objectType==="null")break;if(r.objectType==="null")continue}if(s.maxValue<r.minValue)break;if(s.maxValue===r.minValue){n.push(new h({objectType:"range",minValue:s.maxValue,maxValue:r.minValue}));break}if(!(s.minValue>r.maxValue))if(s.minValue!==r.maxValue){if(i=s.minValue>r.minValue?s.minValue:r.minValue,s.maxValue<r.maxValue){n.push(new h({objectType:"range",minValue:i,maxValue:s.maxValue}));break}n.push(new h({objectType:"range",minValue:i,maxValue:r.maxValue}))}else n.push(new h({objectType:"range",minValue:s.minValue,maxValue:r.maxValue}))}return n}function X(e,t){let n=[];for(let i of e)t.some(o=>{if(i.objectType===o.objectType)switch(i.objectType){case"any":case"null":return!0;case"code":return i.codedValue.code===o.codedValue.code&&i.codedValue.name===o.codedValue.name}return!1})&&n.push(i);return n}function Y(e,t){if(e.length===0||t.length===0)return[];if(e[0].objectType==="any")return t;if(t[0].objectType==="any")return e;let n=e[0].objectType==="range"||e[1]?.objectType==="range",i=t[0].objectType==="range"||t[1]?.objectType==="range";return n||i?W(e,t):X(e,t)}function Z(e,t,n){return j(this,null,function*(){return w(`${e}/${t}/fieldgroups`,S({responseType:"json",query:{f:"json"}},n)).then(i=>i.data.fieldGroups??[])})}function P(e,t,n){return j(this,null,function*(){return w(`${e}/queryDataElements`,S({responseType:"json",query:{layers:JSON.stringify([t]),f:"json"}},n)).then(i=>i.data.layerDataElements?.[0].dataElement.fieldGroups??[])})}function H(e,t){return j(this,null,function*(){return w(e,S({responseType:"json",query:{f:"json"}},t)).then(n=>n.data)})}function ee(e,t,n){return j(this,null,function*(){return w(`${e}/queryContingentValues`,S({responseType:"json",query:{layers:JSON.stringify([t]),f:"json"}},n)).then(i=>i.data.contingentValueSets?.[0])})}function te(e,t,n){return j(this,null,function*(){return w(`${e}/${t}/contingentValues`,S({responseType:"json",query:{f:"json"}},n)).then(i=>i.data)})}function ne(e,t){let n=e.domains;if(n){let[i,o]=Object.entries(n).find(([s])=>s.trim().toLowerCase()===t.trim().toLowerCase())||[];return o||null}return null}a([u({constructOnly:!0})],G.prototype,"layer",void 0),a([u({constructOnly:!0})],G.prototype,"request",void 0),a([u({type:[N]})],G.prototype,"fieldGroups",void 0),a([u({constructOnly:!0})],G.prototype,"fieldGroupDefinitions",void 0),a([u()],G.prototype,"subtypeFieldName",null),G=L=a([v("esri.layers.support.LayerContingentValuesCache")],G);var dt=G;export{h as a,dt as b};
