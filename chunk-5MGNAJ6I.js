import{c as x}from"./chunk-7NTCDIVV.js";import{b as V,y as N}from"./chunk-XR5FT7TQ.js";import{a as E}from"./chunk-JQAW4OB5.js";import{a as L}from"./chunk-DKGGDYJI.js";import{b as v}from"./chunk-UST6HCE7.js";import{f as g}from"./chunk-WFKZLI6F.js";import{a as m,c as k,j as f}from"./chunk-TG45K3WR.js";import{b as _}from"./chunk-ACP3S2CH.js";import{a as r}from"./chunk-QGVBCWUY.js";import{H as w}from"./chunk-MYO4NP2N.js";import{e as a}from"./chunk-NFIPKH6V.js";import{l as u}from"./chunk-5QEXLALV.js";import{b as p}from"./chunk-YOFFGXOB.js";import{g as y}from"./chunk-XRGPJ3QY.js";import{f as h}from"./chunk-VTHXE323.js";var c={noDirtyAreasInExtent:-2147208940,noUtilityNetworkExtension:-2147208474,cannotAcquireVersionLock_v10:-2147217146,cannotAcquireVersionLock_v11:-2147220947},e=class extends w{constructor(t){super(t),this._activeOperationDidSucceed=!1,this._initialValidationsFinished=!1,this._dirtyAreasLayer=null,this._serverVersion=null,this._updatingHandles=new E,this._validConstructProperties=!1,this.executionError="",this.extentToValidate="current",this.loadErrors=new _}initialize(){let t=()=>h(this,null,function*(){this.messages||(this.messages=yield v("esri/widgets/UtilityNetworkValidateTopology/t9n/UtilityNetworkValidateTopology"))});t().then(()=>{this.view||(this.view=null),this.utilityNetwork||(this.utilityNetwork=null),this.addHandles([m(()=>[this.view,this.utilityNetwork],()=>h(this,null,function*(){let{loadErrors:s,messages:{info:{noUtilityNetwork:i,noView:o}}}=this;this._initialValidationsFinished=!1,s.removeAll(),this._validConstructProperties=!0,this._dirtyAreasLayer=null,this._serverVersion=null,this.utilityNetwork?.type!=="utility"&&(this.loadErrors.push(i),y.getLogger(this).error(new p("utilityNetworkValidateTopology:missing-property",i)),this._validConstructProperties=!1),this.view?.type!=="2d"&&(this.loadErrors.push(o),y.getLogger(this).error(new p("utilityNetworkValidateTopology:missing-property",o)),this._validConstructProperties=!1),this._validConstructProperties&&(this.utilityNetwork.loaded||(yield this.utilityNetwork.load().catch(n=>{y.getLogger(this).error(n),this._validConstructProperties=!1})),yield this._setDirtyAreasLayer()),this._validConstructProperties&&(yield this._validateNetworkExtension())}),f),k(()=>this.view?.map?.layers,"change",()=>h(this,null,function*(){let{loadErrors:s,messages:{info:{noUtilityNetwork:i}}}=this,o=s.find(n=>n===i);this._initialValidationsFinished=!1,o||(s.removeAll(),yield this._validateNetworkExtension(),yield this._setDirtyAreasLayer()),this._initialValidationsFinished=!0})),g(t)])})}destroy(){this._updatingHandles.destroy()}get state(){return this.loadErrors.length||!this._validConstructProperties?"disabled":this.executionError?"failed":this._updatingHandles.updating?"executing":this._activeOperationDidSucceed?"success":this._initialValidationsFinished?"ready":"loading"}set utilityNetwork(t){this._get("utilityNetwork")!==t&&this._set("utilityNetwork",t)}set view(t){this._get("view")!==t&&this._set("view",t)}validateTopology(){return h(this,null,function*(){let{messages:{info:{cannotAcquireVersionLock:t,noDirtyAreasInExtent:s}},utilityNetwork:i,view:o}=this;if(!this.loadErrors.length){this._activeOperationDidSucceed=!1,this._set("executionError","");let n={gdbVersion:i?.gdbVersion,outSpatialReference:o.spatialReference?.clone()||null,validateArea:this.extentToValidate==="current"?o.extent.clone():i.fullExtent.clone()};this._updatingHandles.addPromise(i?.validateTopology(n).then(()=>{this._activeOperationDidSucceed=!0},l=>{let d="Error: "+l;if(l instanceof p&&l.details?.raw)switch(l.details.raw.extendedCode){case c.noDirtyAreasInExtent:d=s;break;case c.cannotAcquireVersionLock_v10:case c.cannotAcquireVersionLock_v11:d=t;break;default:d=l.details.message}this._set("executionError",d)}))}})}_setDirtyAreasLayer(){return h(this,null,function*(){let{messages:{info:{noDirtyAreasLayer:t}}}=this,s=this.view?.map.allLayers.items.filter(i=>V(i)).find(i=>i.parsedUrl?.path===this.utilityNetwork?.networkSystemLayers.dirtyAreasLayerUrl);s?(this._dirtyAreasLayer=s,yield this._dirtyAreasLayer.load(),this._serverVersion=this._dirtyAreasLayer.version??0,this._validConstructProperties=!0):(this.loadErrors.includes(t)||(this.loadErrors.push(t),y.getLogger(this).error(new p("utilityNetworkValidateTopology:missing-layer",t))),this._validConstructProperties=!1)})}_validateNetworkExtension(){return h(this,null,function*(){let{messages:{info:{noAdvancedEditingUserTypeExtension:t,noUtilityNetworkServiceUserTypeExtension:s}}}=this,i=yield N(this.utilityNetwork.layerUrl),o=new L({url:i});yield o.load();let n=o.user?.username??"",l=Number(this._serverVersion)<=11.1?"utilityNetwork":"advediting";if(!(yield x(o,n,l))){let d=Number(this._serverVersion)<=11.1?s:t;this.loadErrors.push(d),y.getLogger(this).error(new p("utilityNetworkValidateTopology:no-user-type-extension",d)),this._validConstructProperties=!1}this._initialValidationsFinished=!0})}};r([a()],e.prototype,"_initialValidationsFinished",void 0),r([a()],e.prototype,"_dirtyAreasLayer",void 0),r([a()],e.prototype,"_validConstructProperties",void 0),r([a({readOnly:!0})],e.prototype,"executionError",void 0),r([a()],e.prototype,"extentToValidate",void 0),r([a()],e.prototype,"loadErrors",void 0),r([a()],e.prototype,"messages",void 0),r([a({readOnly:!0})],e.prototype,"state",null),r([a()],e.prototype,"utilityNetwork",null),r([a()],e.prototype,"view",null),e=r([u("esri.widgets.UtilityNetworkValidateTopology.UtilityNetworkValidateTopologyViewModel")],e);var j=e;export{j as a};
