import{a as X}from"./chunk-BRJ4IROM.js";import{c as H,d as J}from"./chunk-VP2YX4L2.js";import{a as W}from"./chunk-XRTA5GHC.js";import{h as Q}from"./chunk-RNC4P66O.js";import{ca as P}from"./chunk-NJWTSROP.js";import{a as K}from"./chunk-7P44K2YD.js";import{d as U}from"./chunk-K5T5FD5C.js";import{a as x}from"./chunk-QGVBCWUY.js";import{e as S}from"./chunk-NFIPKH6V.js";import{l as z}from"./chunk-5QEXLALV.js";import{i as Z}from"./chunk-4PTIEWMT.js";import{b as T}from"./chunk-YOFFGXOB.js";import{g as G}from"./chunk-XRGPJ3QY.js";import{b as E}from"./chunk-2LI2GKBQ.js";import{a as k}from"./chunk-QBWJMFH5.js";import{a as A,f as V}from"./chunk-VTHXE323.js";var ye=/https?:\/\/services.*\.arcgis\.com/i,Fe=/(?:\{([^}]+)\})/g,I=()=>G.getLogger("esri.widgets.Search.support.layerSearchUtils");function Y(e,i){let{exactMatch:t=!1,location:s,maxResults:l,spatialReference:r,source:n,sourceIndex:o,suggestResult:c,view:a}=e,{layer:u,filter:b,zoomScale:h}=n,f=a?.scale,p=te(n,a),v=i?.signal;return re(u).then(()=>{let w=u.popupTemplate;return w?w.getRequiredFields(u.fieldsIndex):null}).then(w=>{let{objectIdField:M,returnZ:_}=u,$=ue(n);if(!B(u,$))throw I().error("invalid-field: displayField is invalid."),new T("getResults():invalid-field","displayField is invalid.");let m=w?.length?w:[$],F=n.outFields||m,C=ie(F);if(F.includes(M)||C||F.push(M),u.floorInfo?.floorField&&F.push(u.floorInfo.floorField),!(C||N(u,F)))throw I().error("invalid-field: outField is invalid."),new T("getResults():invalid-field","outField is invalid.");let d=u.createQuery(),{orderByFields:D}=n;if(D&&(d.orderByFields=D),r){d.outSpatialReference=r;let g=1/P(r);g&&(d.maxAllowableOffset=g)}let j=u.geometryType==="mesh"||u.geometryType==="multipatch",R=u.capabilities?.data?.supportsZ&&!j;if(d.returnZ=R&&_!==!1,d.returnGeometry=!0,d.multipatchOption=j?"xyFootprint":null,F&&(d.outFields=F),s)d.geometry=s;else if(c.key)d.objectIds=[c.key];else{let g=n.searchFields||[$];if(!N(u,g))throw I().error("invalid-field: search field is invalid."),new T("getResults():invalid-field","search field is invalid.");if(ae(u)&&(d.num=l),p&&(d.geometry=p),!c.text?.trim())return[];let q=c.text,{prefix:pe="",suffix:me=""}=n,he=ce(`${pe}${q}${me}`);oe(u)&&le(u,g)&&!t&&q&&(d.fullText=ne({text:q,searchFields:g}));let ge=de({searchTerm:he,layer:u,searchFields:g,filter:b,exactMatch:t,query:d,type:"search"});if(d.where=ge,!se(d))return[]}return u.queryFeatures(d,{signal:v}).then(g=>Me(g,a,n,o,$,f,h))})}function ee(e,i){let{source:t,spatialReference:s,view:l,suggestTerm:r,maxSuggestions:n,sourceIndex:o,exactMatch:c}=e,{layer:a,filter:u}=t,b=i?.signal,h=te(t,l);return re(a).then(()=>{if(!ae(a))return[];let f=ue(t),p=t.searchFields||[f],v=[];t.suggestionTemplate?t.suggestionTemplate.replaceAll(Fe,(R,g)=>(v.push(g),R)):v.push(f);let w=ie(v);v.includes(a.objectIdField)||w||v.push(a.objectIdField);let M=B(a,f),_=w||N(a,v),$=N(a,p);if(!M)throw I().error("invalid-field: displayField is invalid."),new T("getSuggestions():invalid-field","displayField is invalid.");if(!_)throw I().error("invalid-field: outField is invalid."),new T("getSuggestions():invalid-field","outField is invalid.");if(!$)throw I().error("invalid-field: search field is invalid."),new T("getSuggestions():invalid-field","search field is invalid.");let m=a.createQuery(),{orderByFields:F}=t;if(F&&(m.orderByFields=F),m.outSpatialReference=s,m.returnGeometry=!1,m.num=n,m.outFields=v,h&&(m.geometry=h),!r.trim())return[];let{prefix:C="",suffix:d=""}=t,D=ce(`${C}${r}${d}`);oe(a)&&le(a,p)&&!c&&r&&(m.fullText=ne({text:r,searchFields:p}));let j=de({searchTerm:D,layer:a,searchFields:p,filter:u,exactMatch:c,query:m,type:"suggest"});return m.where=j,se(m)?a.queryFeatures(m,{signal:b}).then(R=>Re(R,t,o,f)):[]})}function te(e,i){let{filter:t,withinViewEnabled:s}=e,l=i?.extent;return t?.geometry??(s&&l?l:void 0)}function ie(e){return e&&e.includes("*")}function re(e){return V(this,null,function*(){e&&(yield e.load())})}function se(e){return!(!e.fullText&&!e.where)}function le(e,i){let t=e?.indexes;return!t||!i?.length?!1:t.filter(s=>s.indexType==="FullText").some(s=>{let l=s.fields?.split(",").map(r=>r.trim().toLowerCase())||[];return i.every(r=>l.includes(r.toLowerCase()))})}function ne({text:e,searchFields:i}){return e.trim().split(" ").filter(t=>!!t.trim()).map(t=>new W({onFields:i,searchTerm:t,searchType:"prefix"}))}function oe(e){return e?.capabilities?.query?.supportsFullTextSearch??!1}function ae(e){return e?.capabilities?.query?.supportsPagination??!1}function xe(e){return e?.fieldsIndex?.fields?.find(i=>i.type==="string")?.name??""}function ue(e){return e.displayField||e.layer.displayField||xe(e.layer)}function N(e,i){return!(!e||!i?.length)&&i.every(t=>B(e,t))}function B(e,i){return!!e.getField(i)}function ve(e){for(let i=0;i<e.length;i++)if(e.charCodeAt(i)>255)return!0;return!1}function Se({codedValues:e},i,t){return Z(e??[],s=>{let l=s.name,r=t?l:l.toLowerCase();return(t?i:i.toLowerCase())===r?s.code.toString():null})??null}function ce(e){return e.replaceAll("'","''")}function L(e,i){let t=i?.where;return t?`(${e}) AND (${t})`:e}function we({currentTerm:e,field:i,filter:t,exactMatch:s,url:l,type:r}){let n=i?.type,o=i?.name;if(n==="string"||n==="date"||n==="global-id"){let c=ye.test(l??""),a=c&&ve(e)?"N":"";return L(s&&r==="search"?`${o} = ${a}'${e}'`:c?`${o} LIKE ${a}${`'${e}%'`}`:`${`LOWER(${o})`} LIKE ${a}${`'${e.toLowerCase()}%'`}`,t)}if(n==="oid"||n==="small-integer"||n==="integer"||n==="single"||n==="double"){let c=Number(e);return isNaN(c)?null:L(`${o} = ${c}`,t)}return L(`${o} = ${e}`,t)}function be(e,i){return e?` OR (${i})`:`(${i})`}function de({searchTerm:e,layer:i,searchFields:t,filter:s,exactMatch:l,query:r,type:n}){let{definitionExpression:o,url:c}=i,a="";return!r.fullText&&e&&t&&t.forEach(u=>{let b=i.getField(u),h=i.getFieldDomain?.(u,{excludeImpliedDomains:k("esri-widget-legacy-field-domain-calculation")}),f=(h&&h.type==="coded-value"?Se(h,e,l):null)||e||null;if(f!==null){let p=we({currentTerm:f,field:b,filter:s,exactMatch:l,url:c,type:n});p&&(a+=be(a,p))}}),o&&a?`(${o}) AND (${a})`:o||a}function Te(e,i){let t=null,{codedValues:s}=e;return s&&s.length&&s.some(l=>l.code===i&&(t=l.name,!0)),t}function $e(e,i){return e[i]??e[Object.keys(e).find(t=>t.toLowerCase()===i.toLowerCase())]}function fe(e,i,t){let s=e.sourceLayer,{attributes:l}=e,r=s.getFieldDomain?.(t,{feature:e,excludeImpliedDomains:k("esri-widget-legacy-field-domain-calculation")});if(i)return K(i,l);if(t&&l){let n=s.getField(t),o=$e(l,t);return o==null?"":r&&r.type==="coded-value"?Te(r,o)??"":n?.type==="date"?U(new Date(o)):typeof o=="number"?o.toString():typeof o!="string"?"":o.trim()}return""}function Ie(e,i,t,s){let l=e.sourceLayer,{attributes:r}=e,{objectIdField:n}=l,o=n?r[n]:null;return{text:fe(e,i.suggestionTemplate,s),key:o,sourceIndex:t}}function Re(e,i,t,s){return e.features.map(l=>Ie(l,i,t,s))}function Ee(e){return e!=null&&e.minScale!=null&&e.maxScale!=null}function Le(e,i,t,s,l,r,n){let o=e.clone(),c=e.sourceLayer,a=c?.objectIdField,u=a?e.attributes[a]:null,b=fe(e,t.searchTemplate,l);r!=null&&Ee(c)&&(c.minScale&&c.minScale<r?r=c.minScale:c.maxScale&&c.maxScale>r&&(r=c.maxScale));let h=o.geometry?J(o.geometry,i??void 0,r??void 0):void 0,f=typeof n=="number"&&h?H(E(h),i??void 0,n):h,p=e.clone();return f!=null&&(p.geometry=Q.fromExtent(f)),{extent:f,target:p,feature:o,key:u,name:b,sourceIndex:s}}function Me(e,i,t,s,l,r,n){return e.features.map(o=>Le(o,i,t,s,l,r,n))}var O,y=O=class extends X{constructor(e){super(e),this.displayField=null,this.exactMatch=null,this.orderByFields=null,this.searchFields=null,this.searchTemplate=null,this.suggestionTemplate=null,this.getResults=(i,t)=>Y(A({source:this},i),t),this.getSuggestions=(i,t)=>ee(A({source:this},i),t)}set layer(e){this._set("layer",e),e&&e.load().catch(()=>{})}get name(){return this._getLayerTitle()??""}set name(e){this._overrideIfSome("name",e)}clone(){return new O({autoNavigate:this.autoNavigate,filter:this.filter,maxResults:this.maxResults,maxSuggestions:this.maxSuggestions,minSuggestCharacters:this.minSuggestCharacters,outFields:this.outFields?E(this.outFields):null,placeholder:this.placeholder,popupEnabled:this.popupEnabled,prefix:this.prefix,resultGraphicEnabled:this.resultGraphicEnabled,resultSymbol:this.resultSymbol?this.resultSymbol.clone():null,suggestionsEnabled:this.suggestionsEnabled,suffix:this.suffix,withinViewEnabled:this.withinViewEnabled,displayField:this.displayField,exactMatch:this.exactMatch,layer:this.layer,searchFields:this.searchFields?E(this.searchFields):null,suggestionTemplate:this.suggestionTemplate,zoomScale:this.zoomScale})}_getFirstStringField(){return this.layer.fieldsIndex?.fields.find(e=>e.type==="string")?.name??""}_getDisplayField(){return this.displayField||this.layer.displayField||this._getFirstStringField()}_getSearchFieldsString(){let{layer:e,searchFields:i}=this;return e.loaded?`: ${(i||[this._getDisplayField()]).map(t=>e.getField(t)?.alias||t).join(", ")}`:""}_getLayerTitle(){let{layer:e}=this;if(!e)return;let{title:i}=e;return i?`${i}${this._getSearchFieldsString()}`:void 0}};x([S({json:{read:{source:"field.name"},write:{target:"field.name"}}})],y.prototype,"displayField",void 0),x([S({json:{read:{source:"field.exactMatch"},write:{target:"field.exactMatch"}}})],y.prototype,"exactMatch",void 0),x([S({value:null})],y.prototype,"layer",null),x([S()],y.prototype,"name",null),x([S({type:[String],json:{write:!0}})],y.prototype,"orderByFields",void 0),x([S()],y.prototype,"searchFields",void 0),x([S()],y.prototype,"searchTemplate",void 0),x([S()],y.prototype,"suggestionTemplate",void 0),y=O=x([z("esri.widgets.Search.LayerSearchSource")],y);var et=y;export{et as a};
