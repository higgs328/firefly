import{a as ye}from"./chunk-QWIVERB5.js";import{a as ge}from"./chunk-E7FZSPTU.js";import"./chunk-AKDISSFR.js";import{a as ue}from"./chunk-PMIZEMLB.js";import"./chunk-HSKV7JWT.js";import"./chunk-JK6ANXJE.js";import"./chunk-Q3T7LRXL.js";import"./chunk-DYNR3EAF.js";import"./chunk-W3TWKYGN.js";import"./chunk-72TNJFVF.js";import"./chunk-OC2XJJQU.js";import"./chunk-CCSZEQ2U.js";import{a as _e}from"./chunk-YNALIB5D.js";import"./chunk-2XCEJBGD.js";import"./chunk-UZ6PRO67.js";import"./chunk-DT6D5YZT.js";import"./chunk-CSSRRM4C.js";import"./chunk-RVXDLN3U.js";import"./chunk-CJL3HAFX.js";import"./chunk-S3MATJKX.js";import"./chunk-NWJCHWGR.js";import"./chunk-FM2MN524.js";import"./chunk-XEJVICTW.js";import"./chunk-ESAKNWVF.js";import{a as ce}from"./chunk-HCXKN2EN.js";import"./chunk-Z2LJUUE7.js";import{d as l,e as pe}from"./chunk-2JW3DUYT.js";import{m as v}from"./chunk-IGGGB3TP.js";import"./chunk-JDU4SWWX.js";import"./chunk-HMOFKUIJ.js";import{a as L,b as R,c as me}from"./chunk-C5TDOKQP.js";import"./chunk-QGGZ7JI7.js";import"./chunk-EMILT3E5.js";import"./chunk-5KY2RG7F.js";import"./chunk-XQ4DD6H6.js";import"./chunk-E3FPV7ZA.js";import"./chunk-IQA3CVAZ.js";import{a as he}from"./chunk-2DH3L3DZ.js";import"./chunk-GPMOZK2F.js";import{d as I}from"./chunk-4JIR4MZV.js";import"./chunk-ZO3S2OWI.js";import"./chunk-INIILA7E.js";import"./chunk-YLC7GOFS.js";import"./chunk-KCIAXQ4S.js";import"./chunk-BONXCVQE.js";import"./chunk-DKDKCWEH.js";import"./chunk-PI27WDVR.js";import"./chunk-IXA5GG5W.js";import"./chunk-PIIZWXGF.js";import"./chunk-N3W77OHB.js";import"./chunk-THFX26II.js";import"./chunk-NYVDVEEV.js";import"./chunk-2BJHWKO6.js";import"./chunk-Q5KIWWVU.js";import"./chunk-3NS6RWJD.js";import"./chunk-6ZTUPVYX.js";import{a as le}from"./chunk-5DVGZXEZ.js";import"./chunk-QIO7OVOF.js";import"./chunk-J3QLC2LP.js";import"./chunk-VBFF4VHB.js";import"./chunk-Q2IUY7EW.js";import"./chunk-6HINJY73.js";import{a as ae}from"./chunk-FY4QM6AV.js";import{a as de}from"./chunk-WBPLJNRU.js";import"./chunk-WQKVID54.js";import"./chunk-DBCWR6HP.js";import"./chunk-CISTQZ5X.js";import{a as ne}from"./chunk-2ARQOMI2.js";import{b as se}from"./chunk-5BRKCXYS.js";import"./chunk-NOHUHVCW.js";import"./chunk-Z7TBAZRW.js";import"./chunk-5H7NDIGP.js";import"./chunk-2GLWK7ZW.js";import"./chunk-XACQ2RJ5.js";import"./chunk-CX3G2QWN.js";import{h as te}from"./chunk-YTAJKLRN.js";import"./chunk-D6N4VI5S.js";import{c as oe}from"./chunk-2XTO2IAR.js";import{a as re}from"./chunk-CQVHC5U2.js";import"./chunk-P7MVFIZJ.js";import"./chunk-FSW536RM.js";import"./chunk-VN5FPMRB.js";import"./chunk-N7DSOI7B.js";import"./chunk-F4HA2HQL.js";import"./chunk-DQZHSTUF.js";import"./chunk-CY62WWD7.js";import{b as ie}from"./chunk-VDNRZCIE.js";import"./chunk-I2JD5OSI.js";import"./chunk-2MROBW6T.js";import"./chunk-QAHTJVUZ.js";import"./chunk-XWEUR6F7.js";import"./chunk-PSNQ2KG3.js";import"./chunk-MPI26GZ3.js";import"./chunk-5252J253.js";import"./chunk-7WCQBAQY.js";import"./chunk-VQSLKKYN.js";import"./chunk-JBAMJB5J.js";import"./chunk-VAOSSSLB.js";import"./chunk-AMISFAT3.js";import"./chunk-3ZJU5D2H.js";import"./chunk-2UHZH5L3.js";import"./chunk-DQINVX66.js";import"./chunk-CSFAHB4Y.js";import"./chunk-T5UBLAP4.js";import"./chunk-PTXLSCMJ.js";import"./chunk-DA3NC6W4.js";import"./chunk-6L543SC5.js";import"./chunk-FRN24G7D.js";import"./chunk-FGABE2LC.js";import"./chunk-CU7FHMWW.js";import"./chunk-CZMBPC27.js";import"./chunk-VANM5A4M.js";import"./chunk-VSD74FMI.js";import"./chunk-O2J7LFYY.js";import"./chunk-BIU7ZFAB.js";import"./chunk-6FZTFPIH.js";import"./chunk-J5AEP4US.js";import"./chunk-YHRLMRSO.js";import{b as C}from"./chunk-KPT44MCK.js";import"./chunk-XKFJ6GWH.js";import"./chunk-SFANISLX.js";import"./chunk-UJ7KVQR6.js";import"./chunk-GSXOR3JU.js";import"./chunk-55OTJIMU.js";import"./chunk-EM2AEAFS.js";import"./chunk-YEPHAEAY.js";import"./chunk-TK4PPGQL.js";import"./chunk-ELCBU4NP.js";import"./chunk-GMZFCQJQ.js";import"./chunk-5WDH2LXO.js";import"./chunk-L7NOU4T2.js";import"./chunk-VGAXEXH3.js";import"./chunk-HMNTGQTR.js";import"./chunk-ZLIWNUFM.js";import"./chunk-GVSOJUIP.js";import"./chunk-GWSX6PRO.js";import"./chunk-G2JMPZCN.js";import"./chunk-IRQF7UTO.js";import"./chunk-3KOZOOEP.js";import"./chunk-EG2DTURK.js";import"./chunk-2PJRHNJW.js";import"./chunk-B2RVSTL3.js";import"./chunk-4XEE5PE3.js";import"./chunk-2CKJLDTO.js";import"./chunk-F6TN7E7K.js";import"./chunk-4LDVFWME.js";import"./chunk-HUUJBVXR.js";import"./chunk-7G56KLCZ.js";import"./chunk-L56OBJFS.js";import"./chunk-7HMNN4FJ.js";import"./chunk-UKAGN54W.js";import{d as ee}from"./chunk-456M7HFK.js";import"./chunk-NIYDRLW4.js";import"./chunk-PHMJ7KPL.js";import"./chunk-ESSDCWGF.js";import"./chunk-WVKBXQWE.js";import"./chunk-FSWSNKJD.js";import"./chunk-FGEB67EG.js";import"./chunk-YEXMIDOT.js";import"./chunk-T7PUQGWM.js";import"./chunk-GV3ZFCVD.js";import"./chunk-SOEEM7Z7.js";import"./chunk-MVDZB4AK.js";import"./chunk-44A27HB7.js";import"./chunk-47NSYSFY.js";import"./chunk-QXNVQZT7.js";import"./chunk-QSQIQSC6.js";import"./chunk-AYNBEMCC.js";import"./chunk-LNYBTIG7.js";import{h as $}from"./chunk-E2J2V7JN.js";import"./chunk-4JEZ6E3P.js";import"./chunk-VYZHOYXV.js";import"./chunk-ECA5I2I7.js";import{b as P}from"./chunk-YQNUGDFH.js";import"./chunk-QCZ3ZIGQ.js";import"./chunk-7SDNM7YV.js";import"./chunk-4NUW747S.js";import"./chunk-T6WMVIUG.js";import"./chunk-ONYJLWAD.js";import"./chunk-UBEQHTGJ.js";import"./chunk-PHODKV66.js";import"./chunk-JPMGMA4B.js";import"./chunk-YZJDOXQC.js";import{a as X}from"./chunk-JQAW4OB5.js";import"./chunk-F2BQ2GD6.js";import"./chunk-R3XLNYYB.js";import"./chunk-2HYVVLKS.js";import"./chunk-XRTA5GHC.js";import"./chunk-Y6XW36QP.js";import"./chunk-ZXKU6WBY.js";import"./chunk-BMYVPMAK.js";import"./chunk-6F25LG6O.js";import"./chunk-XLL67PCY.js";import"./chunk-MCO7DSFO.js";import"./chunk-IIROCMOY.js";import"./chunk-5LG2P6MT.js";import"./chunk-GJ2QRXGN.js";import"./chunk-5L2EJ5RT.js";import"./chunk-E2QKN2KY.js";import"./chunk-PDQQY7RQ.js";import"./chunk-W5OI4BJ2.js";import{a as f}from"./chunk-RWCIDBNQ.js";import"./chunk-2NH7HOKA.js";import{a as J}from"./chunk-EM35R6FY.js";import{l as j}from"./chunk-HM5RIVQC.js";import"./chunk-EO2H4LIH.js";import"./chunk-DJW5LMRG.js";import{a as Q}from"./chunk-DEH76MSI.js";import"./chunk-ALWV3RJ2.js";import"./chunk-2ZFXOJDB.js";import{b as Y,s as Z}from"./chunk-QXXXCEV5.js";import"./chunk-6B5XFA6F.js";import"./chunk-TJ6P6NLD.js";import"./chunk-MPRKSQLC.js";import"./chunk-3JGYBNJA.js";import"./chunk-DA3SDKGO.js";import"./chunk-ZOEPYNM4.js";import"./chunk-57VFBGF3.js";import"./chunk-GWBRHLNH.js";import"./chunk-BJH4F4SM.js";import"./chunk-Z3RBZHAK.js";import"./chunk-PTZYZULI.js";import"./chunk-NMLYCCKN.js";import"./chunk-ZC6EBRE4.js";import"./chunk-E7AX56GD.js";import"./chunk-IDVLLREH.js";import"./chunk-DWLSVYOY.js";import"./chunk-PQGCNP5H.js";import"./chunk-UASS7NJI.js";import"./chunk-WZRAC35O.js";import"./chunk-KUYAWYSS.js";import"./chunk-MIS6QMFE.js";import"./chunk-MDZTV2VL.js";import"./chunk-RNC4P66O.js";import"./chunk-7LHOQXZT.js";import"./chunk-BCREO4Q5.js";import"./chunk-U4QEPZJ3.js";import"./chunk-KJUZWSCL.js";import"./chunk-3WO6D7MU.js";import"./chunk-BUZ3SPLE.js";import"./chunk-D3CUKSGS.js";import"./chunk-K75TK42V.js";import"./chunk-CELWVZPW.js";import"./chunk-OLOKUDVI.js";import"./chunk-DYTVXYAV.js";import"./chunk-ZTOZWLEE.js";import"./chunk-RJWOVI3M.js";import"./chunk-RSDQHAJX.js";import"./chunk-BOVYXYHK.js";import{f as B}from"./chunk-KVM6SHDX.js";import"./chunk-HX2VGIR2.js";import{i as F}from"./chunk-EQZWYK27.js";import"./chunk-JLPLCY2B.js";import"./chunk-ZQIC5NFT.js";import"./chunk-VIEK2X23.js";import"./chunk-XKIFGPJO.js";import"./chunk-PEW2PLAN.js";import"./chunk-Q6Y4JG7Q.js";import"./chunk-7F5DJLJT.js";import"./chunk-CX5IFQZJ.js";import{ca as G}from"./chunk-NJWTSROP.js";import"./chunk-D3R25AF2.js";import"./chunk-ARRCN5K3.js";import"./chunk-O3EGNJTY.js";import"./chunk-WGAOVKGR.js";import"./chunk-4N4D2YQX.js";import"./chunk-G4DZJMGT.js";import"./chunk-K5T5FD5C.js";import"./chunk-MVHHPJM7.js";import"./chunk-VDO6JJ3Y.js";import"./chunk-WFKZLI6F.js";import"./chunk-X2B63YVS.js";import"./chunk-BAEF3CT6.js";import"./chunk-AUAZP44J.js";import"./chunk-PVDFCTA4.js";import"./chunk-KNVXE32P.js";import"./chunk-76ATOSLU.js";import"./chunk-CCJU4DSH.js";import{a as D,c as O,j as x,k as H}from"./chunk-TG45K3WR.js";import"./chunk-RAI4DTMT.js";import"./chunk-ACP3S2CH.js";import"./chunk-HVAXZ2NA.js";import"./chunk-T7DXJKX7.js";import"./chunk-TYYVNQUR.js";import{a}from"./chunk-QGVBCWUY.js";import{H as q}from"./chunk-MYO4NP2N.js";import{e as d}from"./chunk-NFIPKH6V.js";import"./chunk-JPU2PQZC.js";import{l as b}from"./chunk-5QEXLALV.js";import"./chunk-P6QFA5MM.js";import"./chunk-DGTD7Y73.js";import"./chunk-LI2SX4T6.js";import{c as U}from"./chunk-BWO7LS2H.js";import"./chunk-HEVQSRJ2.js";import"./chunk-OVHPPCBL.js";import"./chunk-SNFOAZZQ.js";import"./chunk-AML4XSEF.js";import{I as N,K as w,b as W,e as A}from"./chunk-4PTIEWMT.js";import{a as u,d as K,g as T}from"./chunk-TG2UTNEO.js";import{b as k}from"./chunk-YOFFGXOB.js";import"./chunk-XRGPJ3QY.js";import"./chunk-6MRUJ2UW.js";import"./chunk-2LI2GKBQ.js";import"./chunk-QBWJMFH5.js";import{f as c}from"./chunk-VTHXE323.js";var fe=Symbol(),ve=Symbol(),Ee=1,He=10,h=class extends q{get editSourcePoints(){return!!this.options?.reshapeOptions.editSourcePoints!==this._isEditSourcePointsToggled}get updating(){return this._updatingHandles.updating}get _preferredInteractionTool(){return this.options?.tool??"transform"}get _toolType(){switch(this._preferredInteractionTool){case"transform":return"transform-3d";case"reshape":return"reshape-3d"}}get _validatedSelectedElement(){let e=this.selectedElement;if(!e)return null;let{layer:{source:t}}=this;return t?"hasElement"in t?t.hasElement(e)?e:null:t===e?e:null:null}constructor(e){super(e),this.enabled=!1,this._isEditSourcePointsToggled=!1,this._updatingHandles=new X,this._isOpacityToggled=!1,this._factor=Ee,this._tool=null,this._object=null,this._createToolAbortController=null,this._onPointerMove=w(t=>c(this,null,function*(){let i=yield this._updatingHandles.addPromise(this._findElementAtScreenPoint(t));this.destroyed||(this.removeHandles(ve),i&&i!==this.selectedElement&&(this.view.cursor="pointer",this.addHandles(u(()=>this.view.cursor=null),ve)))})),this._tmpMat2=de(),this._tmpVec2=J()}destroy(){this._createToolAbortController=A(this._createToolAbortController)}initialize(){this.addHandles([T(this._updatingHandles),this._updatingHandles.add(()=>this.enabled,e=>this._enableDisable(e),x),this._updatingHandles.add(()=>this._preferredInteractionTool,e=>this._preferredInteractionToolChanged(e))])}_enableDisable(e){if(!e)return void this.removeHandles(fe);this._dynamicImports();let{view:t}=this,i=new pe;i.add(l.undo,()=>{this._object?.operations?.undo(),this._object?.emit("modified-externally")}),i.add(l.redo,()=>{this._object?.operations?.redo(),this._object?.emit("modified-externally")}),i.addToggle(l.preserveAspectRatio,r=>{this._tool?.type==="transform-3d"&&(this._tool.preserveAspectRatio=r.type==="key-down")}),i.addToggle(l.editSourcePoints,r=>{this._tool?.type==="reshape-3d"&&(this._isEditSourcePointsToggled=r.type==="key-down")}),i.addToggle(l.rotateIncrements,r=>{this._tool?.type==="transform-3d"&&(this._tool.snapRotation=r.type==="key-down")}),i.add(l.toggleOpacity,()=>{let r=this._object?.element;r&&(r.opacity*=this._isOpacityToggled?2:.5,this._isOpacityToggled=!this._isOpacityToggled)}),i.add(l.moveUp,()=>this._move(0,this._factor)),i.add(l.moveDown,()=>this._move(0,-this._factor)),i.add(l.moveRight,()=>this._move(this._factor,0)),i.add(l.moveLeft,()=>this._move(-this._factor,0)),i.addToggle(l.factorModifier,r=>this._factor=r.type==="key-down"?He:Ee),this._isOpacityToggled=!1,this.addHandles([i.register(t,I.TOOL),u(()=>{this._isOpacityToggled&&this.selectedElement&&(this.selectedElement.opacity*=2,this._isOpacityToggled=!1)}),t.on("immediate-click",r=>this._onClick(r),I.TOOL),t.on("pointer-move",r=>this._onPointerMove(r).catch(()=>{}),I.TOOL),this._updatingHandles.add(()=>this._validatedSelectedElement,(r,o)=>{o&&r!==o&&this._isOpacityToggled&&(o.opacity*=2,this._isOpacityToggled=!1),this._selectedElementChanged(r)},x),u(()=>{t.cursor=null,this._removeTool()})],fe)}_onClick(e){return c(this,null,function*(){yield this._updatingHandles.addPromise(e.async(()=>c(this,null,function*(){let t=yield this._findElementAtScreenPoint(e);this.destroyed||(t&&e.stopPropagation(),this.selectedElement=t,this.selectedElement&&(this.view.cursor=null))})))})}_selectedElementChanged(e){return c(this,null,function*(){e?.georeference?this._object?.element!==e&&(yield this._updatingHandles.addPromise(this._recreateTool())):this._removeTool()})}_recreateTool(){return c(this,null,function*(){this._createToolAbortController=A(this._createToolAbortController),this._removeTool();let e=this._validatedSelectedElement;if(!e)return;let t=new AbortController;this._createToolAbortController=t;let{ManipulatedObject3DMediaElement:i,ExtentTransformTool:r,ReshapeTool3D:o}=yield this._dynamicImports();if(t.signal.aborted)return;let{view:s,layer:n,_toolType:m}=this;switch(this._object=new i({view:s,layer:n,element:e,tool:this._preferredInteractionTool}),m){case"transform-3d":{this._tool=new r({view:s,object:this._object});let p=s.inputManager;p.isModifierKeyDown(l.rotateIncrements.key)&&(this._tool.snapRotation=!0),p.isModifierKeyDown(l.preserveAspectRatio.key)&&(this._tool.preserveAspectRatio=!0)}break;case"reshape-3d":{let p=ge(s),{snappingManager:_}=p;this._tool=new o({view:s,object:this._object,enableMidpoints:!1,enableZShape:!1,snappingManager:_,enableMoveObject:!1,autoHideManipulators:!0,enableDeleteVertices:!1,sketchOptions:{tooltips:{enabled:!0,inputEnabled:!0,visibleElements:{area:!1}}}}),this.addHandles([p,D(()=>({editSourcePoints:this.editSourcePoints,operations:this._object?.operations}),y=>{y.operations instanceof ye&&(y.operations.editSourcePoints=y.editSourcePoints)},H)],this._tool)}}this.addHandles([u(()=>{this._object=W(this._object),this._tool&&(s.tools.remove(this._tool),this._tool=null)})],this._tool),s.addAndActivateTool(this._tool)})}_preferredInteractionToolChanged(e){let{_tool:t}=this;if(!t)return;if(this._toolType!==t.type)return void this._updatingHandles.addPromise(this._recreateTool());let{_object:i}=this;i&&(i.tool=e)}_dynamicImports(){return c(this,null,function*(){let[{ManipulatedObject3DMediaElement:e},{ExtentTransformTool:t,ReshapeTool3D:i}]=yield Promise.all([import("./chunk-2H4NM6OJ.js"),import("./chunk-WBAPNUFI.js")]);return{ManipulatedObject3DMediaElement:e,ExtentTransformTool:t,ReshapeTool3D:i}})}_findElementAtScreenPoint(e){return c(this,null,function*(){let t=(yield this.view.hitTest(e,{include:[this.layer]})).results[0];return t?.type==="media"?t.element:null})}_removeTool(){this._tool&&this.removeHandles(this._tool)}_move(e,t){let{view:i,_object:r}=this,o=r?.operations;if(!o)return;let s=i.overlayPixelSizeInMapUnits(i.pointsOfInterest.focus.location)*G(i.spatialReference)/G(o.data.spatialReference),{_tmpMat2:n,_tmpVec2:m}=this,p=$(n,F(360-this.view.camera.heading)),_=Y(m,s*e,s*t);Z(_,_,p),o.move(_[0],_[1],0),r.emit("modified-externally")}};a([d({constructOnly:!0})],h.prototype,"view",void 0),a([d({constructOnly:!0})],h.prototype,"layer",void 0),a([d()],h.prototype,"selectedElement",void 0),a([d()],h.prototype,"enabled",void 0),a([d()],h.prototype,"options",void 0),a([d()],h.prototype,"editSourcePoints",null),a([d()],h.prototype,"_isEditSourcePointsToggled",void 0),a([d()],h.prototype,"updating",null),a([d()],h.prototype,"_preferredInteractionTool",null),a([d()],h.prototype,"_validatedSelectedElement",null),h=a([b("esri.views.3d.layers.support.MediaLayerInteraction")],h);var g=class extends ue(_e(ae)){get interactive(){return this._interaction.enabled}set interactive(e){this._interaction&&(this._interaction.enabled=e)}get selectedElement(){return this._interaction.selectedElement}set selectedElement(e){this._interaction&&(this._interaction.selectedElement=e)}get visibleAtCurrentScale(){return ee(this.layer.effectiveScaleRange,this.view.scale)}constructor(e){super(e),this.type="media-3d",this.drapeSourceType=he.Features,this.updatePolicy=le.SYNC,this._uidToElement=new Map,this._highlightedElements=new Map,this._elementsInHighlightedId=new Map,this._renderElements=new Map,this._lastDrapingExtent=null,this._update=w((r,o,s)=>c(this,null,function*(){let n=yield this._collectMediaElements(r,o,s);this._synchronizeRenderElements(n)}),0);let{view:t,layer:i}=e;this._interaction=new h({view:t,layer:i}),this.addHandles(D(()=>this.interactionOptions,r=>this._interaction.options=r,H))}initialize(){let{view:e,layer:t}=this;this._renderer=e.basemapTerrain.overlayManager.registerGeometryDrapeSource(this);let i=()=>this._updateWithLastDrapingExtent();this.addHandles([u(()=>e.basemapTerrain.overlayManager.unregisterDrapeSource(this)),O(()=>t.effectiveSource,"change",i),O(()=>t.effectiveSource,"refresh",i)]),this._updatingHandles.add(()=>this.suspended,i)}setDrapingExtent(e,t){this._lastDrapingExtent={overlays:e,spatialReference:t},this._updateWithLastDrapingExtent()}getHit(e){let t=this._uidToElement.get(e);return t?{type:"media",element:t,layer:this.layer}:null}highlight(e,t){let i=new re(t?.name??te),r=U(e)?Array.from(e):[e];this._elementsInHighlightedId.set(i,r);for(let o of r){let s=this._highlightedElements.get(o);s?s.add(i):this._highlightedElements.set(o,new Set([i]));let n=this._renderElements.get(o)?.getRenderData();n&&(n.renderGeometry.geometry.addHighlight(i),this._renderer.modifyGeometries([n.renderGeometry],R.HIGHLIGHT))}return u(()=>{let o=this._elementsInHighlightedId.get(i);if(o){for(let s of o){let n=this._highlightedElements.get(s);if(!n)continue;n.delete(i);let m=this._renderElements.get(s)?.getRenderData();m&&(m.renderGeometry.geometry.removeHighlight(i),this._renderer.modifyGeometries([m.renderGeometry],R.HIGHLIGHT)),n.size===0&&this._highlightedElements.delete(s)}this._elementsInHighlightedId.delete(i)}})}isUpdating(){return super.isUpdating()||this._interaction.updating}_updateWithLastDrapingExtent(){if(this._lastDrapingExtent==null||this.suspended)return void(this._renderer&&this._synchronizeRenderElements(new Set));let{overlays:e,spatialReference:t}=this._lastDrapingExtent;this._updatingHandles.addPromise(this._update(e,t).catch(()=>{}))}_collectMediaElements(e,t,i){return c(this,null,function*(){let r=this.layer.effectiveSource;return r==null?new Set:new Set((yield Promise.all(e.map(o=>r.queryElements(B(o.extent,t),{signal:i})))).flat())})}_synchronizeRenderElements(e){this._synchronizeRenderElementsRemove(e),this._synchronizeRenderElementsAdd(e)}_synchronizeRenderElementsRemove(e){this._renderElements.forEach((t,i)=>{e.has(i)||(this._removeElement(i,t),this.emit("element-render-changed",{element:i}))})}_synchronizeRenderElementsAdd(e){for(let t of e)this._renderElements.has(t)||this._createRenderElement(t)}_removeElement(e,t){this._destroyRenderData(e,t),this._renderElements.delete(e),this._uidToElement.delete(e.uid),t.handle.remove()}_createRenderElement(e){let t=new ne({spatialReference:this.view.spatialReference,element:e}),i=new z(K([this._updatingHandles.add(()=>e.opacity,r=>i.getRenderData()?.material.setParameters({opacity:r})),this._updatingHandles.add(()=>t.coords,()=>{i.data?this._updateGeometry(t,i):this._initializeRenderData(t,i)}),this._updatingHandles.add(()=>e.content,()=>this._initializeRenderData(t,i)),T(t)]));this._renderElements.set(e,i),this._uidToElement.set(e.uid,e),this._updatingHandles.addPromise(e.load().catch(()=>{})),this._initializeRenderData(t,i)}_initializeRenderData(e,t){let{coords:i,element:r}=e,{contentWidth:o,contentHeight:s}=r;if(i==null||r.content==null)return void this._destroyRenderData(r,t);if(t.data)return;let n=this._createTexture(r.content),m=n.load(this.view._stage.renderView.renderingContext),p=()=>{this.view._stage.add(n);let _=new ce({textureId:n.id,opacity:r.opacity,perspectiveInterpolation:!0}),y=this._getPositionAttributeArray(i),Te=[0,0,1,0,1,1,0,1],we=this._getPerspectiveDivideAttributeArray(y,o,s),M=[0,1,2,0,2,3],be=new oe(_,[[f.POSITION,new P(y,M,3,!0)],[f.UV0,new P(Te,M,2,!0)],[f.PERSPECTIVEDIVIDE,new P(we,M,1,!0)]]),S=new me(be,{layerUid:this.layer.uid,graphicUid:r.uid});this._highlightedElements.get(r)?.forEach(De=>S.geometry.addHighlight(De)),this._renderer.addGeometries([S],L.ADD),t.data=new V(S,n,_),this.emit("element-render-changed",{element:r})};N(m)?(t.data=n,this._updatingHandles.addPromise(m),m.then(p).catch(()=>n.dispose())):p()}_updateGeometry(e,t){let{coords:i,element:r}=e;if(i==null||r.content==null)return void this._destroyRenderData(r,t);let o=t.getRenderData();if(!o)return;let s=this._getPositionAttributeArray(i);o.renderGeometry.geometry.setAttributeData(f.POSITION,s);let n=this._getPerspectiveDivideAttributeArray(s,r.contentWidth,r.contentHeight);o.renderGeometry.geometry.setAttributeData(f.PERSPECTIVEDIVIDE,n),o.renderGeometry.geometry.invalidateBoundingInfo(),this._renderer.modifyGeometries([o.renderGeometry],R.GEOMETRY),this.emit("element-render-changed",{element:r})}_getPositionAttributeArray(e){let[t,i,r,o]=e.rings[0];return[t[0],t[1],v,o[0],o[1],v,r[0],r[1],v,i[0],i[1],v]}_getPerspectiveDivideAttributeArray(e,t,i){se(E,[0,0,t,0,t,i,0,i],[e[0],e[1],e[3],e[4],e[6],e[7],e[9],e[10]]);let r=E[6]/E[8]*t,o=E[7]/E[8]*i;return[1,1+r,1+r+o,1+o]}_destroyRenderData(e,t){let i=t.data;if(i==null)return;if(t.data=null,i?.type===C.Texture)return void i.dispose();let r=i.texture;r.unload(),this.view._stage.remove(r),this._renderer.removeGeometries([i.renderGeometry],L.REMOVE),this.emit("element-render-changed",{element:e})}_createTexture(e){let t=e instanceof HTMLImageElement?e.naturalWidth:e.width,i=e instanceof HTMLImageElement?e.naturalHeight:e.height;if("getFrame"in e)throw new k("media-layer-view-3d","animation is not supported");return new ie(e,{wrap:{s:j.CLAMP_TO_EDGE,t:j.CLAMP_TO_EDGE},preMultiplyAlpha:!0,width:t,height:i,mipmap:!0,updateCallback:()=>this.view.basemapTerrain.overlayManager.requestRender()})}get test(){}};a([d({readOnly:!0})],g.prototype,"type",void 0),a([d()],g.prototype,"layer",void 0),a([d()],g.prototype,"interactive",null),a([d()],g.prototype,"selectedElement",null),a([d({readOnly:!0})],g.prototype,"visibleAtCurrentScale",null),g=a([b("esri.views.3d.layers.MediaLayerView3D")],g);var E=Q(),z=class{constructor(t){this.handle=t}getRenderData(){return this.data?.type===C.Texture?null:this.data}},V=class{constructor(t,i,r){this.renderGeometry=t,this.texture=i,this.material=r,this.type="RenderData"}},Ot=g;export{Ot as default};
