import{b as te}from"./chunk-KUE5X75D.js";import{l as R}from"./chunk-CTPO46HK.js";import{a as ee}from"./chunk-SBU7IJGM.js";import{a as G}from"./chunk-M3BFYJNF.js";import{c as T,e as W,f as J,h as O,i as K,j as Q,k as L,l as X,o as Y}from"./chunk-4RK2B3SZ.js";import{a as $}from"./chunk-7IOOWZFM.js";import{v as U}from"./chunk-5A7AFZJT.js";import{f as E}from"./chunk-F5AJITOA.js";import{$ as M,Z as z,_ as B,aa as j,ba as V,ca as x,da as H,ka as w}from"./chunk-KALOJIUA.js";import{a as P}from"./chunk-E7AX56GD.js";import{m as y,o as A}from"./chunk-FB4M3WPV.js";import{a as b,b as D}from"./chunk-32OAXCA4.js";import{c as F}from"./chunk-K5T5FD5C.js";import{a as k,h as q}from"./chunk-MVHHPJM7.js";import{a as l}from"./chunk-QGVBCWUY.js";import{e as a}from"./chunk-NFIPKH6V.js";import{l as C}from"./chunk-5QEXLALV.js";import{g as I}from"./chunk-XRGPJ3QY.js";import{a as N,b as Z,f as v}from"./chunk-VTHXE323.js";var S={showInput:"Enter",hideInput:"Escape"},h=class extends te{constructor(t){super(t),this.editInfo=null,this.cellValueValidatorFunction=({oldValue:e,value:i})=>e!==i,this.editable=!0,this.headerRenderFunction=e=>{let{root:i}=e,n=this.createHeaderContent();this.tableEditingEnabled&&!this.effectiveEditable&&n.prepend(this._lockIconNode),this.removeCellContent(i),i.appendChild(n)},this.inputRenderFunction=({root:e,column:i,rowData:n})=>{if(this.editInfo||!this.effectiveEditable||!n)return;let r=this.getCellValue(n),o=this.createInputElement({value:r});this._set("editInfo",{column:i,inputs:[o],root:e,rowData:n,oldValue:r});let s=document.createElement("div");s.appendChild(o),this.removeCellContent(e),e.appendChild(s),o.focus(),o instanceof HTMLInputElement&&o.select()},this.loadingMessage="",this.inputType="text",this.maxLength=null,this.onShowPromptCallback=()=>{},this.parseInputValueFunction=({inputs:e})=>e?.length||e.length!==1||Array.isArray(e[0].value)?null:e[0].value,this.renderFunction=e=>{let{root:i,rowData:n}=e,{editInfo:r}=this;if(r)return;let o=this.getCellValue(n),s=this.cellValueFormatFunction({root:i,rowData:n,value:o}),u=null;i.onclick=()=>i.focus(),i.ondblclick=()=>this.inputRenderFunction(e),i.ontouchend=()=>this.inputRenderFunction(e);let c=this.grid?.getSlotElementByName(i.slot),d=c?.parentElement;d&&!d.onkeydown&&(d.onkeydown=m=>{m.key!==S.showInput||this.editInfo||this.inputRenderFunction(e),m.key===S.hideInput&&this.editInfo&&this.cancel()}),o!=null&&s!=null?i.title=s.toString():i.title&&i.removeAttribute("title"),u=s instanceof HTMLElement?s:G(this.messagesURIUtils,s),this.removeCellContent(i),u instanceof HTMLElement?i.appendChild(u):u!=null&&(i.innerHTML=u.toString())},this.required=!1,this.tableEditingEnabled=!1}get _lockIconNode(){return this.createCalciteIcon({icon:"lock",textLabel:this.messages?.editingPreventedColumn})}get effectiveEditable(){return this.tableEditingEnabled&&this.editable}get effectiveRequired(){return this.required}get editing(){return!!this.editInfo}get shouldShowPrompt(){return!1}cancel(){let{editInfo:t}=this;if(!t)return;let{column:e,root:i,rowData:n}=t;this.onEditComplete(),this.renderFunction({column:e,root:i,rowData:n})}createCalciteOption(t,e,i=!1){let n=document.createElement("calcite-option");return n.label=t,n.value=`${e}`,n.selected=i,n}createCalciteSelect(t,e){let{effectiveRequired:i,messages:n}=this,r=!1,o=e.map(({name:u,value:c})=>{let d=c===t;return d&&(r=!0),this.createCalciteOption(u,c,d)});if(t!=null&&t!==""&&!r){let u=t.toString(),c=this.createCalciteOption(u,u);o.unshift(c)}i||o.unshift(this.createCalciteOption(`<${n?.noValue}>`,""));let s=document.createElement("calcite-select");return o.forEach(u=>s.appendChild(u)),s}createInputElement({value:t}){let{effectiveRequired:e,maxLength:i}=this,n=document.createElement("calcite-input");return i!=null&&(n.maxLength=i),n.required=e,n.value=t,n.addEventListener("calciteInputChange",()=>this.onInputBlur(n)),n.onkeydown=r=>{r.key===S.hideInput&&this.onInputBlur(n,!0)},n.onblur=()=>this.onInputBlur(n),n}createDateComponent(){let t=document.createElement("calcite-input-date-picker");return t.focusTrapDisabled=!0,t.overlayPositioning="fixed",t}createTimeComponent(){let t=document.createElement("calcite-input-time-picker");return t.overlayPositioning="fixed",t.placement="auto-start",t.step=1,t}createTimeZoneComponent(){let t=document.createElement("calcite-input-time-zone");return t.maxItems=4,t.overlayPositioning="fixed",t}onEditComplete(){this._set("editInfo",null),this.grid?.generateCellPartNames()}onInputBlur(t,e=!1){t.onblur=null,e?this.cancel():this.submit()}submit(){return v(this,null,function*(){let{editInfo:t}=this;if(!t)return void this.cancel();let{inputs:e,rowData:i,oldValue:n}=t,r=this.parseInputValueFunction({inputs:e});if(!this.cellValueValidatorFunction({value:r,oldValue:n}))return void this.cancel();let{root:o}=t,s=i.item.objectId,{fieldName:u}=this;o.textContent=this.loadingMessage,this.shouldShowPrompt?this.onShowPromptCallback({column:this,objectId:s,oldValue:n,value:r}):yield this.updateItems({objectId:s,updates:[{fieldName:u,value:r}]})})}updateItems(t){return v(this,null,function*(){let{store:e}=this;if(e)try{yield e.updateItem(t),this.onEditComplete()}catch{this.cancel()}else this.cancel()})}};l([a()],h.prototype,"_lockIconNode",null),l([a({readOnly:!0})],h.prototype,"editInfo",void 0),l([a()],h.prototype,"cellValueValidatorFunction",void 0),l([a()],h.prototype,"editable",void 0),l([a()],h.prototype,"effectiveEditable",null),l([a()],h.prototype,"effectiveRequired",null),l([a()],h.prototype,"editing",null),l([a()],h.prototype,"headerRenderFunction",void 0),l([a()],h.prototype,"inputRenderFunction",void 0),l([a({constructOnly:!0})],h.prototype,"loadingMessage",void 0),l([a()],h.prototype,"inputType",void 0),l([a()],h.prototype,"maxLength",void 0),l([a()],h.prototype,"onShowPromptCallback",void 0),l([a()],h.prototype,"parseInputValueFunction",void 0),l([a()],h.prototype,"renderFunction",void 0),l([a()],h.prototype,"required",void 0),l([a()],h.prototype,"shouldShowPrompt",null),l([a()],h.prototype,"tableEditingEnabled",void 0),h=l([C("esri.widgets.FeatureTable.Grid.EditorColumn")],h);var ie=h;var se={cancelEdit:"Escape"},ne="esri-column",oe={input:`${ne}__cell-input`,inputContainer:`${ne}__cell__input-container`},ue=F("short-date-short-time"),de=F("short-date"),le={useGrouping:!0,maximumFractionDigits:20},p=class extends ie{constructor(t){super(t),this._activeFieldInput=null,this.cellValueFormatFunction=({root:e,rowData:i,value:n})=>{let{formatFunction:r}=this;if(r&&i){let{index:u,item:{attachments:c,feature:d,relatedRecords:m}}=i;return r({attachments:c,column:this,feature:d,field:this.field,index:u,relatedRecords:m,value:y.sanitize(n),virtualIndex:this.getVirtualRowIndex(e)})}if(n===null)return"&nbsp;";let{field:o}=this,s=this._getDomainForFeature(i?.item?.feature);if(s){let u=this._getComputedDomain(n,s);if(o.type==="date"&&s.type==="range")return this._formatDateValueForDisplay(o,u);if(this._isNumericField&&s.type==="range"){let c=this.template?.format,d=c?b(c):le;return D(parseFloat(n),d)}return T.has(o.type)?s.type==="range"?y.sanitize(O(o,u)):y.sanitize(u):u}if(o.type==="date"||T.has(o.type))return this._formatDateValueForDisplay(o,n);if(this._isNumericField){let u=this.template?.format,c=u?b(u):le;return D(parseFloat(n),c)}return y.sanitize(n)},this.cellValueValidatorFunction=({oldValue:e,value:i})=>{let{_effectiveRange:n,field:r}=this,{max:o,min:s}=n;if(this.effectiveRequired&&(i==null||i===""))return!1;if(this._isNumericField&&(w(r,i)||!L({max:o,min:s,value:i})))return I.getLogger(this).warn("value-exceeds-valid-range","Field value exceeds valid range. Attempted edit was rejected."),!1;if(this._isAnyDateOrTimeField){let u=r.type;if(!Y({type:u,range:n,value:i}))return!1}return e!==i},this.field=null,this.formatFunction=null,this.inputRenderFunction=r=>v(this,[r],function*({root:e,column:i,rowData:n}){if(this.editInfo||!this.effectiveEditable)return;let o=this.getCellValue(n),{field:s}=this;if(s.type==="big-integer"&&w(s,o))return void I.getLogger(this).warn("value-exceeds-valid-range","Field value is beyond supported limit. Editing is disabled for this field value.");let u=n?.item.feature;if(!u)return;this._activeFieldInput=this._setUpFieldInput(u,o);let c=document.createElement("div");c.classList.add(oe.inputContainer);let d=[],m=this._effectiveDomain?.type==="coded-value";if(this._isAnyDateOrTimeField&&!m){let g=document.createElement("div"),_=this._setUpDateComponents(o),ae=this._setUpDateActionBar();_.forEach(re=>g.appendChild(re)),c.appendChild(g),c.appendChild(ae),d.push(..._)}else{let g=this.createInputElement({value:o});c.appendChild(g),d.push(g)}this._set("editInfo",{column:i,inputs:d,root:e,rowData:n,oldValue:o}),this.removeCellContent(e),e.appendChild(c),this._syncRowEditingState(e,!0),this.grid?.generateCellPartNames();let f=d[0];yield A(f),"selectText"in f&&(yield f.selectText())}),this.layer=null,this.parseInputValueFunction=({inputs:e})=>{let{editInfo:i,field:n,includeTime:r}=this;if(!i||!e.length)return null;let o=e[0];if(this._isAnyDateOrTimeField){if(this._effectiveDomain?.type==="coded-value"){if(o.value==null)return null;let m=String(o.value);return j(n)?parseFloat(m):m}let{timeZone:c}=this.effectiveTimeZoneOptions,d=i.oldValue??void 0;switch(n.type){case"date-only":{let m=o.value;return m!==""?m:null}case"time-only":{let m=X(o.value);return m!==""?m:null}case"timestamp-offset":{let m=r?e[1]:void 0,f=e.at(-1);return K({oldValue:d,dateComponent:o,timeComponent:m,timeZoneComponent:f,defaultTimeZone:c})}case"date":{let{max:m,min:f}=this._effectiveRange;return Q({oldValue:d,dateComponent:o,timeComponent:e[1],timeZone:c,max:m,min:f})}}return null}let s=o.value,{effectiveRequired:u}=this;return u||s!=null&&s!==""?this._isNumericField?parseFloat(s):this._isStringField?s.trim():s:null},this.sortable=!0,this.store=null,this.template=null,this.view=null}get _effectiveDomain(){let t=this._activeFieldInput?.feature;return t?this._getDomainForFeature(t):null}get _effectiveRange(){return this._activeFieldInput?.range??{max:null,min:null}}get _isAnyDateOrTimeField(){let{field:t}=this;return E(t)||H(t)}get _isIntegerField(){return z(this.field)}get _isNumericField(){return B(this.field)}get _isStringField(){return M(this.field)}get _isSubtypeField(){let{layer:t}=this;if(t?.subtypeField){let{subtypeField:e,fieldsIndex:i}=t;return(i.get(e)?.name??e)===this.fieldName}return!1}get alias(){return this.field?.alias}get defaultValue(){return this.field?.defaultValue}get effectiveDescription(){let{description:t,field:e}=this,i=e.description,n=R(t)?R(i)?null:i:t;return n==null?null:y.sanitize(n)}get effectiveEditable(){let{editable:t,field:e,layer:i,tableEditingEnabled:n}=this;if(!e||!i)return!1;let r=$(i),o=i.effectiveCapabilities??i.capabilities,s=o?.operations?.supportsUpdate;return!!(e.editable&&r&&s&&e.type!=="oid"&&n)&&t}get effectiveLabel(){return y.sanitize(this.label||this.alias||this.fieldName)}get effectiveRequired(){return!this.nullable||this._isSubtypeField||this._activeFieldInput?.required||this.required}get effectiveTimeZoneOptions(){let{layer:t,field:e}=this;if(!t||e?.type!=="date"&&e?.type!=="timestamp-offset")return{timeZone:void 0,timeZoneName:void 0};let{tableTimeZone:i,timeZone:n,view:r}=this;return q(t.preferredTimeZone||null,!!t.datesInUnknownTimezone,n??i??r?.timeZone??k,F("short-time"),e.type)}get includeTime(){let{field:t,template:e}=this;return t.type==="time-only"||t.type!=="date-only"&&(!e?.input||"includeTime"in e.input&&e.input.includeTime!==!1)}get loadingMessage(){return this.messages?.loading||"..."}get maxLength(){let{field:t,template:e}=this,i=t?.length??-1,n=e?.input&&"maxLength"in e.input?e.input.maxLength:null;return n!=null&&!isNaN(n)&&n>=-1&&(i===-1||n<=i)?n:i}get minLength(){let{template:t,maxLength:e}=this,i=t?.input&&"minLength"in t.input?t.input.minLength:null;return e&&i<=e?i:null}get name(){return this.field?.name}get nullable(){return this.field.nullable!==!1}get shouldShowPrompt(){return this._isSubtypeField}createInputElement({value:t}){let{_effectiveDomain:e,maxLength:i,minLength:n,effectiveRequired:r}=this,o;if(e?.type==="coded-value")o=this.createCalciteSelect(t,e.codedValues.map(({code:s,name:u})=>({value:s,name:u}))),o.addEventListener("calciteSelectChange",()=>this.onInputBlur(o));else if(this._isNumericField){let{_effectiveRange:{max:s,min:u}}=this;o=document.createElement("calcite-input"),o.type="number",this._isIntegerField&&(o.step=1),s!=null&&(o.max=s),u!=null&&(o.min=u),o.status=L({max:s,min:u,value:t})?"idle":"invalid"}else o=document.createElement("calcite-input"),o.addEventListener("calciteInputChange",()=>this.onInputBlur(o)),i>-1&&(o.maxLength=i),n>0&&(o.minLength=n);return o.classList.add(oe.input),o.required=r,o.value=t!=null?t.toString():"",o.onkeydown=s=>{s.key===se.cancelEdit&&this.onInputBlur(o,!0)},o.onblur=()=>this.onInputBlur(o),o}onEditComplete(){let t=this.editInfo?.root;t&&this._syncRowEditingState(t,!1),this._activeFieldInput=null,super.onEditComplete()}_clearActiveEditValues(){this.editInfo?.inputs?.forEach(t=>t.value="")}_setUpDateActionBar(){let{messagesCommon:t}=this,e=t?.cancel??"",i=t?.clear??"",n=t?.save??"",r=document.createElement("calcite-action-bar");return r.expandDisabled=!0,r.layout="horizontal",r.appendChild(this.createCalciteAction({text:n,icon:"save",onclick:()=>this.submit()})),this.effectiveRequired||r.appendChild(this.createCalciteAction({text:i,icon:"trash",onclick:()=>{this._clearActiveEditValues(),this.submit()}})),r.appendChild(this.createCalciteAction({text:e,icon:"x",onclick:()=>this.cancel()})),r}_formatDateValueForDisplay(t,e){let{timeZone:i,timeZoneName:n}=this.effectiveTimeZoneOptions;return e!=null?O(t,e,Z(N({},this._getDateFormatOptions()),{timeZone:i,timeZoneName:n})):null}_setUpDateComponents(t){let{_effectiveRange:{max:e,min:i,rawMax:n,rawMin:r},field:o,effectiveRequired:s}=this,u=this._getDateFieldValuesForComponents(o,t),c=[];if(E(o)){let d=this.createDateComponent(),m=V(o)||x(o)?n:e,f=V(o)||x(o)?r:i,g=this._getDateFieldValuesForComponents(o,m??null),_=this._getDateFieldValuesForComponents(o,f??null);d.value=u.date??"",d.max=g.date??"",d.min=_.date??"",d.required=s,d.addEventListener("calciteInputDatePickerOpen",()=>this._onDateComponentOpen(d)),c.push(d)}if(this.includeTime){let d=this.createTimeComponent();d.value=u.time??"",d.required=s,d.addEventListener("calciteInputTimePickerOpen",()=>this._onDateComponentOpen(d)),c.push(d)}if(o.type==="timestamp-offset"){let d=this.createTimeZoneComponent();d.value=u.timeZoneOffset??"0",d.addEventListener("calciteInputTimeZoneOpen",()=>this._onDateComponentOpen(d)),c.push(d)}return c}_onDateComponentOpen(t){this.editInfo?.inputs.forEach(e=>{e!==t&&"open"in e&&(e.open=!1)})}_syncRowEditingState(t,e=!1){let i=this.grid?.getRowContainingNode(t);i&&(e?i.setAttribute("editing","true"):i.removeAttribute("editing"))}_getDateFieldValuesForComponents(t,e){switch(t.type){case"date":return J(e,this.effectiveTimeZoneOptions.timeZone);case"date-only":return{date:e};case"time-only":return{time:e};case"timestamp-offset":return W(e);default:return{}}}_setUpFieldInput(t,e){let{field:i,layer:n,effectiveTimeZoneOptions:{timeZone:r}}=this,o=new ee({feature:t,field:i,initialFeature:t.clone(),layer:n,timeZone:r});return o.set("value",e),o}_isDomainCompatible(t){if(!t)return!1;let{_isNumericField:e,_isStringField:i}=this,{type:n}=t;if(n==="coded-value"){let r=typeof t.codedValues[0].code;if(r==="string"&&i||r==="number"&&e)return!0}return!(n!=="range"||!e)}_getDomainForFeature(t){let{fieldName:e,layer:i,template:n}=this;if(!t||!i?.getFieldDomain||i.type==="wfs"||i.type==="geojson"||i.type==="csv"||i.type==="knowledge-graph-sublayer")return null;if(n?.domain&&this._isDomainCompatible(n.domain))return n.domain;if(i.type!=="feature"&&i.type!=="subtype-group"&&i.getField(e)?.domain==null){let r=U(i,e);if(r)return r}return i.getFieldDomain(e,{feature:t})}_getComputedDomain(t,e){if(!e)return null;if(e.type==="range")return t;if(e.type==="coded-value"){let i=e.codedValues.filter(n=>n.hasOwnProperty("code")&&n.code===t);return i&&i.length?i[0].name:t}return null}_getDateFormatOptions(){let{template:t}=this,e=t?.format?.dateFormat;return e?F(e):t?.input&&"includeTime"in t.input&&t.input.includeTime===!1?de:ue}};l([a()],p.prototype,"_effectiveDomain",null),l([a()],p.prototype,"_activeFieldInput",void 0),l([a()],p.prototype,"_effectiveRange",null),l([a()],p.prototype,"_isAnyDateOrTimeField",null),l([a()],p.prototype,"_isIntegerField",null),l([a()],p.prototype,"_isNumericField",null),l([a()],p.prototype,"_isStringField",null),l([a()],p.prototype,"_isSubtypeField",null),l([a({readOnly:!0})],p.prototype,"alias",null),l([a()],p.prototype,"cellValueFormatFunction",void 0),l([a()],p.prototype,"cellValueValidatorFunction",void 0),l([a({readOnly:!0})],p.prototype,"defaultValue",null),l([a()],p.prototype,"effectiveDescription",null),l([a()],p.prototype,"effectiveEditable",null),l([a()],p.prototype,"effectiveLabel",null),l([a()],p.prototype,"effectiveRequired",null),l([a()],p.prototype,"effectiveTimeZoneOptions",null),l([a({type:P})],p.prototype,"field",void 0),l([a()],p.prototype,"formatFunction",void 0),l([a()],p.prototype,"includeTime",null),l([a()],p.prototype,"inputRenderFunction",void 0),l([a()],p.prototype,"layer",void 0),l([a({readOnly:!0})],p.prototype,"loadingMessage",null),l([a()],p.prototype,"maxLength",null),l([a()],p.prototype,"minLength",null),l([a({readOnly:!0})],p.prototype,"name",null),l([a({readOnly:!0})],p.prototype,"nullable",null),l([a()],p.prototype,"parseInputValueFunction",void 0),l([a()],p.prototype,"shouldShowPrompt",null),l([a()],p.prototype,"sortable",void 0),l([a()],p.prototype,"store",void 0),l([a()],p.prototype,"template",void 0),l([a()],p.prototype,"view",void 0),p=l([C("esri.widgets.FeatureTable.FieldColumn")],p);var Be=p;export{Be as a};
