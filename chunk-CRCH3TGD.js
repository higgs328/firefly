import{b as y,c as k}from"./chunk-MKARC3VG.js";import{a as v}from"./chunk-N3NGJUQN.js";import{a as O,b as U,c as V}from"./chunk-HFZI5WHY.js";import{a as E}from"./chunk-FPCHE4I2.js";import{a as A}from"./chunk-LAX5536Z.js";import{d as W}from"./chunk-N3HRYLNW.js";import{a as T}from"./chunk-XAGMDNNR.js";import{f as G}from"./chunk-DA3SDKGO.js";import{c as _}from"./chunk-VIEK2X23.js";import{a as x}from"./chunk-G4DZJMGT.js";import{b as P}from"./chunk-UST6HCE7.js";import{a as w,f as M}from"./chunk-WFKZLI6F.js";import{b as S}from"./chunk-X2B63YVS.js";import{a as f,b as F,j as H}from"./chunk-TG45K3WR.js";import{b as m}from"./chunk-ACP3S2CH.js";import{a as L}from"./chunk-T7DXJKX7.js";import{a as n}from"./chunk-QGVBCWUY.js";import{e as r}from"./chunk-NFIPKH6V.js";import{l as b}from"./chunk-5QEXLALV.js";import{b as c}from"./chunk-YOFFGXOB.js";import{g as u}from"./chunk-XRGPJ3QY.js";import{f as h}from"./chunk-VTHXE323.js";var g={default:"default",crosshair:"crosshair"},j=new _([0,0,500]),I="xy",B=["mgrs","utm","usng","dd","dms","ddm"],D="esri__coordinateConversionWidgetState",a={conversions:"conversions",formats:"formats",view:"view",viewChange:"view-change"},R="esri/images/search/search-symbol-32.png",i=class extends E(L.EventedAccessor){constructor(t){super(t),this._conversionPromise=null,this._locationGraphic=null,this._pointerCount=0,this.conversions=new m,this.formats=new m,this.formatterAvailable=!1,this.messages=null,this.filteredFormats=new m,this.locationSymbol=new T({url:S(R),width:24,height:24}),this.storageEnabled=!0,this.storageType="session",this.view=null,this._saveWidgetState=this._saveWidgetState.bind(this),this._handleFormatChange=this._handleFormatChange.bind(this),this._handleConversionChange=this._handleConversionChange.bind(this),this._handleViewChange=this._handleViewChange.bind(this),this._onClick=this._onClick.bind(this),this._onPointerMove=this._onPointerMove.bind(this),this._onPointerDown=this._onPointerDown.bind(this),this._onPointerUp=this._onPointerUp.bind(this)}initialize(){let t=()=>h(this,null,function*(){return this.messages=yield P("esri/widgets/CoordinateConversion/t9n/CoordinateConversion")});this.formats.addMany(k()),t().then(()=>{if(!this.destroyed&&(y(this.messages,this.formats),this.storageEnabled&&this._loadWidgetState(),this.formats.forEach(e=>{e.viewModel=this,this.addHandles(f(()=>e.currentPattern,this._saveWidgetState),e.name??"unnamed-format")}),this.addHandles(this.conversions.on("change",this._handleConversionChange),a.conversions),this.addHandles(this.formats.on("change",this._handleFormatChange),a.formats),this.addHandles(M(()=>{t().then(()=>{y(this.messages,this.formats)})})),G().then(()=>{this.formatterAvailable=!0}).catch(e=>{u.getLogger(this).error(new c("coordinate-conversion:projection-load-failed","Failed to load the projection module.",{error:e})),this.formatterAvailable=!1,this._filterFormatsAndConversions()}).then(()=>this.addHandles(f(()=>this.view,this._handleViewChange,H),a.viewChange)),this.conversions.length===0)){let e=this.formats.find(o=>o.name===I)||this.formats.at(0);this.conversions.add(new v({format:e}))}})}destroy(){this.removeHandles(),this._cleanUpView(this.view),this.view=null}castConversions(t){return this._castToConversions(t)}set currentLocation(t){this._set("currentLocation",t),this._updateConversions()}get currentLocation(){return this._get("currentLocation")||null}set mode(t){switch(t){case"capture":this.currentLocation=null,this._startCaptureMode(),this._set("mode",t);break;case"live":this._startLiveMode(),this._set("mode",t)}}get mode(){return this._get("mode")||"live"}get state(){let{messages:t,view:e}=this,o=e?.ready;return t?o?"ready":e?"loading":"disabled":"disabled"}get storage(){let{storageType:t}=this;return t==="session"?sessionStorage:localStorage}get waitingForConversions(){return this._conversionPromise!=null}setLocation(t){if(this._locationGraphic&&this.view?.graphics.remove(this._locationGraphic),!t)return;let e=t.clone();e.hasZ&&(e.z=void 0),this._locationGraphic=new A({geometry:e,symbol:this.locationSymbol}),this.view?.graphics.add(this._locationGraphic)}convert(t,e){return h(this,null,function*(){if(!O(e))throw new c("coordinate-conversion:invalid-point","Invalid point cannot be converted.",{point:e});return Promise.resolve().then(()=>t.convert(e))})}goToLocation(t){return h(this,null,function*(){let{view:e}=this;if(!e)throw new c("coordinate-conversion:go-to-failed","no view");let o=e.type==="3d"?e.clippingArea:null,s=e.map?.basemap?.baseLayers;if(o||(s?.length??0)>0){let d=o??s?.at(0)?.fullExtent;if(d!=null&&!d.contains(t))throw new c("coordinate-conversion:go-to-failed","Point outside basemap extent.",{point:t})}return this.callGoTo({target:t})})}pause(){this.currentLocation=null,this.removeHandles(a.view),this.view&&(this.view.cursor=g.default,this._locationGraphic&&this.view.graphics.remove(this._locationGraphic))}previewConversion(o){return h(this,arguments,function*(t,e=this.currentLocation||j){return(yield N(t,e)).displayCoordinate})}resume(){this.mode==="capture"?this._startCaptureMode():this._startLiveMode()}reverseConvert(t,e){return e.reverseConvert(t)}updateConversions(t,e){return h(this,null,function*(){if(e?.type!=="point")throw this._clearConversions(this.conversions),new c("coordinate-conversion:invalid-input-point","Point is invalid, conversions cannot be updated.",{point:e});return this._convertMany(t,e)})}_castToConversions(t){let e=new m;return t.forEach(o=>{let s=null;if(o instanceof v)s=o;else if(typeof o=="string"){let d=this.formats.find(p=>p.name===o);d&&(s=new v({format:d}))}s&&e.add(s)}),e}_cleanUpView(t){t&&(this._locationGraphic&&t.graphics.remove(this._locationGraphic),this.removeHandles(a.view),t.cursor=g.default)}_clearConversions(t){t.forEach(e=>{e.position={location:null,coordinate:null}})}_convertMany(t,e){return h(this,null,function*(){return Promise.all(t.map(o=>N(o,e)))})}_handleConversionChange(t){for(let e of t.added){let{format:o}=e;o&&(o.viewModel=this,this.currentLocation&&(this._set("waitingForConversions",!0),this.convert(o,this.currentLocation).then(s=>{e.position=s,this._set("waitingForConversions",!1)})))}this._saveWidgetState()}_handleFormatChange(t){t.added.forEach(e=>{this.addHandles(f(()=>e.currentPattern,this._saveWidgetState),e.name??"unnamed-format"),e.viewModel=this}),t.removed.forEach(e=>{e.viewModel=null;let o=this.conversions.filter(s=>s.format===e);this.conversions.removeMany(o),e.name&&this.removeHandles(e.name)})}_loadWidgetState(){try{let t=JSON.parse(this.storage.getItem(D));t&&this._setWidgetState(t)}catch(t){u.getLogger(this).error(new c("coordinate-conversion:invalid-session-storage-json","Could not read from storage.",{error:t}))}}_startCaptureMode(){this.removeHandles(a.view),this.view&&(this.view.cursor=g.crosshair,this.currentLocation&&this.setLocation(this.currentLocation),this.addHandles(this.view.on("click",this._onClick),a.view))}_startLiveMode(){this._pointerCount=0,this.removeHandles(a.view),this.view&&(this.view.cursor=g.default,this._locationGraphic&&this.view.graphics.remove(this._locationGraphic),this.addHandles([this.view.on("pointer-down",this._onPointerDown),this.view.on("pointer-up",this._onPointerUp),this.view.on("pointer-move",this._onPointerMove)],a.view))}_handleViewChange(t,e){e&&e!==t&&this._cleanUpView(e),t&&(this.mode==="capture"?this._startCaptureMode():this._startLiveMode(),e&&this._filterFormatsAndConversions())}_onClick(t){if(t.button===0){let e=this.view?.toMap(t),o=e?.normalize();this.setLocation(o),this.currentLocation=o}}_onPointerDown(t){let{pointerType:e}=t;if(this._pointerCount++,(e==="touch"||e==="pen")&&this._pointerCount===1){let o=this.view?.toMap(t);this.currentLocation=o?.normalize()}}_onPointerMove(t){let{pointerType:e}=t;if(e==="mouse"||this._pointerCount===1){let o=this.view?.toMap(t);this.currentLocation=o?.normalize()}}_onPointerUp(){this._pointerCount--}_setWidgetState(t){try{t.formats.forEach(e=>{let o=this.formats.find(s=>s.name===e.name);o&&t.locale===w()&&e.currentPattern&&(o.currentPattern=e.currentPattern),o&&e.index>=0&&this.conversions.add(new v({format:o}))})}catch(e){u.getLogger(this).warn(new c("coordinate-conversion:session-storage-read-error","Could not get widget state from stored JSON.",{error:e}))}}_saveWidgetState(){if(!this.storageEnabled)return;let t=this._toJSON();try{this.storage.setItem(D,JSON.stringify({formats:t,locale:w()}))}catch(e){u.getLogger(this).error(new c("coordinate-conversion:local-storage-write-error","Could not write to localStorage.",{error:e}))}}_updateConversions(){return h(this,null,function*(){try{yield this.updateConversions(this.conversions.toArray(),this.currentLocation)}catch{}})}_toJSON(){return this.formats.filter(t=>{let e=t.name;return e==="xy"||e==="basemap"||U(e)}).map(t=>({name:t.name,currentPattern:t.currentPattern,defaultPattern:t.defaultPattern,index:this.conversions.findIndex(e=>e.format===t)})).sort((t,e)=>t.index-e.index).toArray()}_filterFormatsAndConversions(){let{formatterAvailable:t,conversions:e,formats:o}=this;t||this.addHandles(F(()=>this.view?.spatialReference,s=>{let d=s.isWebMercator||s.isWGS84,p=o.filter(l=>{let{name:C}=l;return!!Z(C)||C==="xy"&&!d}),z=this.filteredFormats.filter(l=>l.name==="xy"&&d&&!this.formats.includes(l)),J=e.filter(l=>p.includes(l.format));o.removeMany(p),e.removeMany(J),this.filteredFormats.addMany(p.filter(l=>!this.filteredFormats.includes(l))),o.addMany(z)},{once:!0,initial:!0}),a.view)}};function N(t,e){return h(this,null,function*(){try{t.position=yield t.format?.convert(e)}catch{t.position=null}return t})}function Z(t){return B.includes(t)}n([r({type:m.ofType(v)})],i.prototype,"conversions",void 0),n([x("conversions")],i.prototype,"castConversions",null),n([r({type:_})],i.prototype,"currentLocation",null),n([r({type:m.ofType(V)})],i.prototype,"formats",void 0),n([r()],i.prototype,"messages",void 0),n([r()],i.prototype,"mode",null),n([r()],i.prototype,"filteredFormats",void 0),n([r({readOnly:!0})],i.prototype,"state",null),n([r({types:W})],i.prototype,"locationSymbol",void 0),n([r({readOnly:!0,dependsOn:["storageType"]})],i.prototype,"storage",null),n([r()],i.prototype,"storageEnabled",void 0),n([r()],i.prototype,"storageType",void 0),n([r({readOnly:!0})],i.prototype,"waitingForConversions",null),n([r()],i.prototype,"view",void 0),i=n([b("esri.widgets.CoordinateConversion.CoordinateConversionViewModel")],i);var _t=i;export{_t as a};
