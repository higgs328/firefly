import{a as v}from"./chunk-IR6XCBC4.js";import{f as l}from"./chunk-CCJU4DSH.js";import{b as d}from"./chunk-ACP3S2CH.js";import{a as r}from"./chunk-QGVBCWUY.js";import{e as s}from"./chunk-NFIPKH6V.js";import{l as h}from"./chunk-5QEXLALV.js";import{b as u}from"./chunk-YOFFGXOB.js";import{g as c}from"./chunk-XRGPJ3QY.js";import{f as n}from"./chunk-VTHXE323.js";var i=class extends l.JSONSupportMixin(v){constructor(e){super(e),this.versionManagementService=null,this.featureServiceUrl=null,this.url=null,this.currentVersion=null,this.currentVersionInfo=null,this.versionInfos=[],this.versionableItems=new d,this.usePersistentReadSessions=!1,this.state="lock-none"}initialize(){this.url=this.versionManagementService.url,this.featureServiceUrl=this.url.replace(/\/VersionManagementServer/i,"/FeatureServer"),this.addHandles([this.versionableItems.on("before-add",e=>{if(e.item.featureServiceUrl.toLowerCase()!==this.featureServiceUrl.toLowerCase())return e.preventDefault(),void c.getLogger(this).error("#add()","Cannot add versionAdapter, feature service urls do not match.")}),this.versionableItems.on("before-remove",e=>{if(this.versionableItems.items.length===0&&this.currentVersion&&"name"in this.currentVersion&&this.versionManagementService.getLockType(this.currentVersion)!=="none")return e.preventDefault(),void c.getLogger(this).error("#remove()","Cannot remove last versionAdapter.")})])}load(e){return this.addResolvingPromise(this._setUpState(e)),Promise.resolve(this)}get defaultVersionIdentifier(){return this.versionManagementService.defaultVersionIdentifier}get isDefault(){return!this.currentVersion||!!this.currentVersion&&"name"in this.currentVersion&&this.currentVersion.name===this.defaultVersionIdentifier.name}getVersionInfos(e=!1){return n(this,null,function*(){return e&&(this.versionInfos=yield this.versionManagementService.getVersionInfos()),this.versionInfos})}alterVersion(e,t){return n(this,null,function*(){if(this.currentVersion&&"guid"in this.currentVersion&&e.guid===this.currentVersion.guid)return!1;let o=yield this.versionManagementService.alterVersion(e,t);return o&&(yield this.getVersionInfos(!0)),o})}deleteVersion(e){return n(this,null,function*(){if(this.currentVersion&&"guid"in this.currentVersion&&e.guid===this.currentVersion.guid)return!1;let t=yield this.versionManagementService.deleteVersion(e);return t&&(yield this.getVersionInfos(!0)),t})}getVersionInfoExtended(){return n(this,null,function*(){return this.currentVersion&&"name"in this.currentVersion?this.versionManagementService.getVersionInfoExtended(this.currentVersion):this.versionManagementService.getVersionInfoExtended(this.defaultVersionIdentifier)})}startEditing(){return n(this,null,function*(){if(this._isDefaultOrHistoricVersion())return{success:!1};if(!this.usePersistentReadSessions){let t=yield this.versionManagementService.startReadingWithResult(this.currentVersion);if(!t.success)return t;this.state="lock-read"}let e=yield this.versionManagementService.startEditingWithResult(this.currentVersion);return e.success&&(this.state="lock-write"),e})}stopEditing(e){return n(this,null,function*(){if(this._isDefaultOrHistoricVersion())return{success:!1};let t=yield this.versionManagementService.stopEditingWithResult(this.currentVersion,e);if(!t.success)return t;if(this.state="lock-read",!this.usePersistentReadSessions){let o=yield this.versionManagementService.stopReadingWithResult(this.currentVersion);return o.success&&(this.state="lock-none"),o}return t})}changeVersion(e){return n(this,null,function*(){let t=null;if(this.usePersistentReadSessions){if(this._isDefaultOrHistoricVersion(e))e&&"name"in e?(t=yield this.versionManagementService.getVersionInfoExtended(e),this.state=t?.access==="public"?"lock-none":"lock-read"):this.state="lock-read";else if(!(yield this.versionManagementService.startReading(e)))throw new u("Failed to acquire read lock for version: "+e);this._isDefaultOrHistoricVersion(this.currentVersion)||(yield this.versionManagementService.stopReading(this.currentVersion))}let o=yield this.versionManagementService.changeVersionWithResult(this.versionableItems,this.currentVersion,e),a=!1;return o.forEach((V,f)=>{a=a||V.success}),a&&(this.currentVersion=e,this.currentVersionInfo=t||(yield this.getVersionInfoExtended()),this._isDefaultOrHistoricVersion()?this.currentVersion&&"name"in this.currentVersion?this.state=this.currentVersionInfo?.access==="public"?"lock-none":"lock-read":this.state="lock-read":this.state=this.versionManagementService.getLockType(this.currentVersion)!=="read"?"lock-none":"lock-read"),o})}undo(){return n(this,null,function*(){return this._isDefaultOrHistoricVersion()?{success:!1}:(this.versionManagementService.undo(this.currentVersion),{success:!0})})}redo(){return n(this,null,function*(){return this._isDefaultOrHistoricVersion()?{success:!1}:(this.versionManagementService.redo(this.currentVersion),{success:!0})})}_setUpState(e){return n(this,null,function*(){yield this.versionManagementService.load(e),this.state="lock-none",this.currentVersionInfo=yield this.getVersionInfoExtended(),this.versionableItems.forEach(t=>{this.currentVersion?"name"in this.currentVersion?(t.gdbVersion=this.currentVersion.name,t.historicMoment=null):(t.historicMoment=this.currentVersion,t.gdbVersion=null):(t.gdbVersion=null,t.historicMoment=null)}),this.usePersistentReadSessions&&(this._isDefaultOrHistoricVersion()?this.currentVersion&&"name"in this.currentVersion?this.state=this.currentVersionInfo?.access==="public"?"lock-none":"lock-read":this.state="lock-read":(yield this.versionManagementService.startReading(this.currentVersion))&&(this.state="lock-read"))})}_isDefaultOrHistoricVersion(e=this.currentVersion){return!(e&&"name"in e)||e.name===this.versionManagementService.defaultVersionIdentifier.name}};r([s()],i.prototype,"versionManagementService",void 0),r([s()],i.prototype,"featureServiceUrl",void 0),r([s()],i.prototype,"url",void 0),r([s()],i.prototype,"currentVersion",void 0),r([s()],i.prototype,"currentVersionInfo",void 0),r([s()],i.prototype,"versionInfos",void 0),r([s()],i.prototype,"versionableItems",void 0),r([s()],i.prototype,"usePersistentReadSessions",void 0),r([s()],i.prototype,"state",void 0),r([s({readOnly:!0})],i.prototype,"defaultVersionIdentifier",null),r([s({readOnly:!0})],i.prototype,"isDefault",null),i=r([h("esri.versionManagement.VersioningState")],i);var b=i;export{b as a};
