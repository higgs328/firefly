import{b as H}from"./chunk-ZA2DRI5X.js";import{a as C,m as z}from"./chunk-ZQIC5NFT.js";import{f as V,i as L}from"./chunk-Q6Y4JG7Q.js";import{a as A}from"./chunk-7F5DJLJT.js";import{a as D,b as I,c as M}from"./chunk-TG45K3WR.js";import{c as x}from"./chunk-RAI4DTMT.js";import{b as g}from"./chunk-ACP3S2CH.js";import{a as m}from"./chunk-QGVBCWUY.js";import{H as w}from"./chunk-MYO4NP2N.js";import{e as y}from"./chunk-NFIPKH6V.js";import{l as v}from"./chunk-5QEXLALV.js";import{f as _}from"./chunk-VTHXE323.js";function j(e,i){return e&&"copyright"in e&&(!i||typeof e.originOf=="function"&&e.originOf("copyright")==="user")}function T(e,i){return e.length!==i.length||e.some((r,t)=>r.text!==i[t].text)}function p(e,i,r){!r||!i||e.find(t=>t.layerView===i&&t.text===r)||e.push({text:r,layerView:i})}function W(e){return e.type==="bing-maps"}var h=[],d=class extends w{constructor(e){super(e),this._clear=()=>{this._fetchedAttributionData.clear(),this._pendingAttributions.clear(),this.removeHandles("suspension"),this.notifyChange("state")},this._pendingAttributions=new Set,this._fetchedAttributionData=new Map,this.items=new g,this.view=null,this._allLayerViewsChange=i=>{this.removeHandles("suspension"),this.removeHandles("visible-geometry-changed");let r=this.view?.allLayerViews;r&&(this.addHandles(r.map(t=>D(()=>[t.suspended,t.layer?.attributionVisible],()=>this._updateAttributionItems())).toArray(),"suspension"),r.forEach(t=>{t.declaredClass==="esri.views.3d.layers.Tiles3DLayerView3D"&&this.addHandles(t.on("visible-geometry-changed",()=>this._updateAttributionItems()),"visible-geometry-changed")})),i?.removed&&i.removed.forEach(t=>{this._pendingAttributions.delete(t),this._fetchedAttributionData.delete(t)}),this._updateAttributionItems()},this.addHandles([M(()=>this.view?.allLayerViews,"change",i=>this._allLayerViewsChange(i),{onListenerAdd:()=>this._allLayerViewsChange(),onListenerRemove:this._clear}),I(()=>this.view?.stationary===!0,()=>this._updateAttributionItems())])}destroy(){this.view=null,this._fetchedAttributionData.clear(),this._pendingAttributions.clear(),this.items.removeAll()}get state(){return this.view?.ready?this._pendingAttributions.size>0?"loading":"ready":"disabled"}_updateAttributionItems(){let e=this.view,i=e?.allLayerViews;if(h.length=0,!e||!i)return void this._clear();i.forEach(t=>{if(t.suspended||!t.layer?.attributionVisible)return;let n=t.layer;if(j(n,"user"))return void p(h,t,n.copyright);if(n.hasAttributionData){if(this._fetchedAttributionData.has(t)){let l=this._fetchedAttributionData.get(t);return void(l?p(h,t,this._getDynamicAttribution(l,e,n)):j(n)&&p(h,t,n.copyright))}return void this._fetchAttributionData(t)}let s="portalItem"in n?n.portalItem?.accessInformation:void 0;p(h,t,s||n.copyright)});let r=i.find(t=>t.layer?.type==="integrated-mesh-3dtiles");if(this.view&&r){let t=H(this.view);if(t){let n=t.getAttributionText();for(let s=0;s<n.length;++s)p(h,r,n[s])}}T(this.items,h)&&(this.items.removeAll(),this.items.addMany(h)),h.length=0,this.notifyChange("state")}_fetchAttributionData(e){return _(this,null,function*(){if(this._pendingAttributions.has(e))return;this._pendingAttributions.add(e);let i=yield x(e.layer.fetchAttributionData());if(this._pendingAttributions.has(e)){let r=i.ok?this._createContributionIndex(i.value,W(e.layer)):null;this._pendingAttributions.delete(e),this._fetchedAttributionData.set(e,r)}this._updateAttributionItems()})}_createContributionIndex(e,i){let r=e.contributors,t={};if(!r)return t;for(let n=0;n<r.length;n++){let s=r[n],l=s.coverageAreas;if(!l)return;for(let o of l){let u=o.bbox,a=o.zoomMin-(i&&o.zoomMin?1:0),c=o.zoomMax-(i&&o.zoomMax?1:0),f=new z({xmin:u[1],ymin:u[0],xmax:u[3],ymax:u[2],spatialReference:A.WGS84}),O={extent:L(f),attribution:s.attribution||"",score:o.score!=null?o.score:100,id:n};for(let b=a;b<=c;b++)t[b]??=[],t[b].push(O)}}return t.maxKey=Math.max.apply(null,Object.keys(t)),t}_getDynamicAttribution(e,i,r){let{extent:t,scale:n}=i,s=r.tileInfo?.scaleToZoom(n)??0;if(s=Math.min(e.maxKey??0,Math.round(s)),!t||s==null||s<=-1)return"";let l=e[s],o=V(t.center.clone().normalize(),A.WebMercator),u=new Set;return l?l.filter(a=>{let c=a.id,f=!u.has(c)&&o&&a.extent&&C(a.extent,o);return f&&u.add(c),f}).sort((a,c)=>c.score-a.score||a.objectId-c.objectId).map(a=>a.attribution).join(", "):""}};m([y({readOnly:!0,type:g})],d.prototype,"items",void 0),m([y({readOnly:!0})],d.prototype,"state",null),m([y()],d.prototype,"view",void 0),d=m([v("esri.widgets.Attribution.AttributionViewModel")],d);var X=d;export{X as a};
