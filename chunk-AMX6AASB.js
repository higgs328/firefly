import{a as N}from"./chunk-CESHMSBL.js";import{l as L}from"./chunk-XGBN53IG.js";import{w as F}from"./chunk-Z7TBAZRW.js";import{d as D}from"./chunk-CL7L227X.js";import{a as G}from"./chunk-U2ZO6WN5.js";import{d as U,f as A}from"./chunk-XLL67PCY.js";import{a as O}from"./chunk-TG45K3WR.js";import{K as M,d as I,e as C,z as H}from"./chunk-4PTIEWMT.js";import{a as E,b as w,f as z}from"./chunk-VTHXE323.js";function cn({predicate:n=()=>!0,snappingManager:e,snappingContext:a,updatingHandles:i,useZ:o=!0}){let r=new L;if(e==null)return{snappingStep:[j,r],cancelSnapping:j};let u,s=null,l=null,p=null,c=()=>{s=C(s),e.doneSnapping(),l?.frameTask.remove(),l=null,u=I(u),p=null},J=X(e,o,r),y=null,d=null,f=null;return{snappingStep:[t=>{if(!n(t))return t;let{action:P}=t;if(P==="start"){let{info:g}=t,x=Y(e.view);if(l=_(a,t,x),l.context.selfSnappingZ=null,!o&&g!=null){let m=nn(a.coordinateHelper,g.handle.component);m!=null&&(l.context.selfSnappingZ={value:m,elevationInfo:a.elevationInfo??F})}}if(l!=null){let{context:g,originalScenePos:x,originalPos:m}=l,{mapEnd:T,mapStart:Z,scenePoints:K}=t,v=q(m,h(T,Z)),b=h(Z,m),Q=w(E({},t),{action:"update"}),R=l.context,S=$(x,K),k=e.update({point:v,scenePoint:S,context:g});if(f=k,B(T,k,b,o),y=v,d=S,P!=="end"){let{frameTask:V}=l;s==null&&(s=new AbortController),p=W=>{i.addPromise(H(J({frameTask:V,event:Q,context:R,point:v,scenePoint:S,delta:b,getLastState:()=>({point:y,scenePoint:d,updatePoint:W.forceUpdate?null:f})},s.signal)))},p({forceUpdate:!1}),u==null&&(u=O(()=>e.options.effectiveEnabled,()=>p?.({forceUpdate:!0})))}}return P==="end"&&c(),t},r],cancelSnapping:t=>(c(),t)}}function X(n,e,a){return M((J,y)=>z(this,[J,y],function*({frameTask:i,point:o,scenePoint:r,context:u,event:s,delta:l,getLastState:p},c){let d=yield i.schedule(()=>n.snap({point:o,scenePoint:r,context:u,signal:c}),c);if(d.valid){let f=yield i.schedule(()=>d.apply(),c),t=p();t.point!=null&&o!==t.point&&(f=n.update({point:t.point,scenePoint:t.scenePoint,context:u})),t.updatePoint!=null&&G(f,t.updatePoint)||(B(s.mapEnd,f,l,e),a.execute(s))}}))}function Y(n){return n.type==="3d"?n.resourceController.scheduler.registerTask(U.SNAPPING):A}function _(n,e,a){return{context:new N({editGeometryOperations:n.editGeometryOperations,elevationInfo:n.elevationInfo,pointer:n.pointer,vertexHandle:e.info!=null?e.info.handle:null,excludeFeature:n.excludeFeature,feature:n.feature,visualizer:n.visualizer}),originalPos:e.snapOrigin!=null?n.coordinateHelper.vectorToDehydratedPoint(e.snapOrigin):e.mapStart,originalScenePos:e.scenePoints!=null?e.scenePoints.sceneStart:null,frameTask:a}}function q(n,[e,a,i]){let o=D(n);return o.x+=e,o.y+=a,o.hasZ&&(o.z+=i),o}function $(n,e){return n==null||e==null?null:q(n,h(e.sceneEnd,e.sceneStart))}function h(n,e){let a=n.hasZ&&e.hasZ?n.z-e.z:0;return[n.x-e.x,n.y-e.y,a]}function B(n,e,[a,i,o],r){n.x=e.x+a,n.y=e.y+i,r&&n.hasZ&&e.hasZ&&(n.z=e.z+o)}function nn(n,e){if(!n.hasZ())return null;let a=e.vertices,i=null;for(let o of a){let r=n.getZ(o.pos);if(i!=null&&r!=null&&Math.abs(r-i)>1e-6)return null;i==null&&(i=r)}return i}function j(n){return n}export{cn as a};
