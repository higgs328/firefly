import{a as S}from"./chunk-TFDME2PB.js";import{a as J}from"./chunk-HHOYZIQV.js";import{a as D}from"./chunk-BEIT7H7J.js";import{a as N,b as W}from"./chunk-NSUARQNU.js";import{b as k}from"./chunk-4Y7EKSO4.js";import{b as B}from"./chunk-GNEAU6X4.js";import{a as P}from"./chunk-CZ6CGC7I.js";import{t as $}from"./chunk-KALOJIUA.js";import{b as C}from"./chunk-KMMTNF7G.js";import{b as z}from"./chunk-JLPLCY2B.js";import{m as j}from"./chunk-ZQIC5NFT.js";import{ca as q}from"./chunk-NJWTSROP.js";import{c as E}from"./chunk-TG45K3WR.js";import{a as d}from"./chunk-QGVBCWUY.js";import{H as Q}from"./chunk-MYO4NP2N.js";import{e as f}from"./chunk-NFIPKH6V.js";import{l as M}from"./chunk-5QEXLALV.js";import{c as U}from"./chunk-P6QFA5MM.js";import{K as O,p as x}from"./chunk-4PTIEWMT.js";import{b as v}from"./chunk-YOFFGXOB.js";import{a as H,y as I}from"./chunk-QBWJMFH5.js";import{a as A,b as L,f as u}from"./chunk-VTHXE323.js";var R=null;function _e(s,t){return t.type==="tile"||t.type==="map-image"}var m=class extends Q{constructor(s){super(s),this._featuresResolutions=new WeakMap,this.highlightGraphics=null,this.highlightGraphicUpdated=null,this.updateHighlightedFeatures=O(t=>u(this,null,function*(){this.destroyed||this.updatingHandles.addPromise(this._updateHighlightedFeaturesGeometries(t).catch(()=>{}))}))}initialize(){let s=t=>{for(let i of t){let{sourceLayer:o}=i;o!=null&&"geometryType"in o&&o.geometryType==="point"&&(i.visible=!1)}this.updatingHandles.addPromise(this._updateHighlightedFeaturesSymbols(t).catch(()=>{})),this.updateHighlightedFeatures(this._highlightGeometriesResolution)};this.addHandles([E(()=>this.highlightGraphics,"change",t=>s(t.added),{onListenerAdd:t=>s(t)})])}fetchPopupFeaturesAtLocation(s,t){return u(this,null,function*(){let{layerView:{layer:i,view:{scale:o}}}=this;if(!s)throw new v("fetchPopupFeatures:invalid-area","Nothing to fetch without area",{layer:i});let r=Z(i.sublayers,o,t);if(!r.length)return[];let a=yield te(i,r);if(!((i.capabilities?.operations?.supportsIdentify??!0)&&i.version>=10.5)&&!a)throw new v("fetchPopupFeatures:not-supported","query operation is disabled for this service",{layer:i});return a?this._fetchPopupFeaturesUsingQueries(s,r,t):this._fetchPopupFeaturesUsingIdentify(s,r,t)})}clearHighlights(){this.highlightGraphics?.removeAll()}_updateHighlightedFeaturesSymbols(s){return u(this,null,function*(){let{layerView:{view:t},highlightGraphics:i,highlightGraphicUpdated:o}=this;if(i&&o)for(let r of s){let a=r.sourceLayer&&"renderer"in r.sourceLayer&&r.sourceLayer.renderer;r.sourceLayer&&"geometryType"in r.sourceLayer&&r.sourceLayer.geometryType==="point"&&a&&"getSymbolAsync"in a&&a.getSymbolAsync(r).then(e=>u(this,null,function*(){e||=new P;let p=null,y="visualVariables"in a?a.visualVariables?.find(n=>n.type==="size"):void 0;y&&(R||(R=(yield import("./chunk-R45N3IFT.js")).getSize),p=R(y,r,{view:t.type,scale:t.scale,shape:e.type==="simple-marker"?e.style:null})),p||="width"in e&&"height"in e&&e.width!=null&&e.height!=null?Math.max(e.width,e.height):"size"in e?e.size:16,i.includes(r)&&(r.symbol=new P({style:"square",size:p,xoffset:"xoffset"in e?e.xoffset:0,yoffset:"yoffset"in e?e.yoffset:0}),o(r,"symbol"),r.visible=!0)}))}})}_updateHighlightedFeaturesGeometries(s){return u(this,null,function*(){let{layerView:{layer:t,view:i},highlightGraphics:o,highlightGraphicUpdated:r}=this;if(this._highlightGeometriesResolution=s,!r||!o?.length||!t.capabilities.operations.supportsQuery)return;let a=this._getTargetResolution(s),e=new Map;for(let n of o)if(!this._featuresResolutions.has(n)||this._featuresResolutions.get(n)>a){let c=n.sourceLayer;U(e,c,()=>new Map).set(n.getObjectId(),n)}let p=Array.from(e,([n,c])=>{let l=n.createQuery();return l.objectIds=[...c.keys()],l.outFields=[n.objectIdField],l.returnGeometry=!0,l.maxAllowableOffset=a,l.outSpatialReference=i.spatialReference,n.queryFeatures(l)}),y=yield Promise.all(p);if(!this.destroyed)for(let{features:n}of y)for(let c of n){let l=c.sourceLayer,h=e.get(l).get(c.getObjectId());h&&o.includes(h)&&(h.geometry=c.geometry,r(h,"geometry"),this._featuresResolutions.set(h,a))}})}_getTargetResolution(s){let t=s*q(this.layerView.view.spatialReference),i=t/16;return i<=10?0:s/t*i}_fetchPopupFeaturesUsingIdentify(s,t,i){return u(this,null,function*(){let o=yield this._createIdentifyParameters(s,t,i);if(o==null)return[];let{results:r}=yield J(this.layerView.layer.parsedUrl,o,i);return r.map(a=>a.feature)})}_createIdentifyParameters(s,t,i){return u(this,null,function*(){let{floors:o,layer:r,timeExtent:a,view:{spatialReference:e,scale:p}}=this.layerView;if(!t.length)return null;yield Promise.all(t.map(({sublayer:g})=>g.load(i).catch(()=>{})));let y=Math.min(H("mapservice-popup-identify-max-tolerance"),r.allSublayers.reduce((g,b)=>b.renderer?S({renderer:b.renderer,pointerType:i?.pointerType}):g,2)),n=this.createFetchPopupFeaturesQueryGeometry(s,y),c=B(p,e),l=Math.round(n.width/c),h=new j({xmin:n.center.x-c*l,ymin:n.center.y-c*l,xmax:n.center.x+c*l,ymax:n.center.y+c*l,spatialReference:n.spatialReference});return new D({floors:o,gdbVersion:"gdbVersion"in r?r.gdbVersion:void 0,geometry:s,height:l,layerOption:"popup",mapExtent:h,returnGeometry:!0,spatialReference:e,sublayers:r.sublayers,timeExtent:a,tolerance:y,width:l})})}_fetchPopupFeaturesUsingQueries(s,t,i){return u(this,null,function*(){let{layerView:{floors:o,timeExtent:r}}=this,a=t.map(y=>u(this,[y],function*({sublayer:e,popupTemplate:p}){if(yield e.load(i).catch(()=>{}),e.capabilities&&!e.capabilities.operations.supportsQuery)return[];let n=e.createQuery(),c=S({renderer:e.renderer,pointerType:i?.pointerType}),l=this.createFetchPopupFeaturesQueryGeometry(s,c),h=new Set,[g]=yield Promise.all([N(e,p),e.renderer?.collectRequiredFields(h,e.fieldsIndex)]);x(i),$(h,e.fieldsIndex,g);let b=Array.from(h).sort();n.geometry=l,n.outFields=b,n.timeExtent=r;let K=k(o,e);if(n.where=z(n.where,K),e.capabilities?.query.supportsOrderBy&&e.orderBy?.[0]){let w=e.orderBy[0],V=!w.valueExpression&&w.field,Y=w.order==="ascending"?"asc":"desc";V&&(n.orderByFields=[`${V} ${Y}`])}let _=this._getTargetResolution(l.width/c),G=yield ee(p);x(i);let T=e.geometryType==="point"||G&&G.arcadeUtils.hasGeometryOperations(p);T||(n.maxAllowableOffset=_);let{features:F}=yield e.queryFeatures(n,i),X=T?0:_;F=yield re(e,F,i);for(let w of F)this._featuresResolutions.set(w,X);return F}));return(yield Promise.allSettled(a)).reduce((e,p)=>p.status==="fulfilled"?[...e,...p.value]:e,[]).filter(I)})}};function Z(s,t,i){let o=[];if(!s)return o;let r=a=>{let e=a.minScale===0||t<=a.minScale,p=a.maxScale===0||t>=a.maxScale;if(a.visible&&e&&p){if(a.sublayers)a.sublayers.forEach(r);else if(a.popupEnabled){let y=W(a,L(A({},i),{defaultPopupTemplateEnabled:!1}));y!=null&&o.unshift({sublayer:a,popupTemplate:y})}}};return s.map(r),o}function ee(s){return s.expressionInfos?.length||Array.isArray(s.content)&&s.content.some(t=>t.type==="expression")?C():Promise.resolve()}function te(s,t){return u(this,null,function*(){if(s.capabilities?.operations?.supportsQuery)return!0;try{return yield Promise.any(t.map(({sublayer:i})=>i.load().then(()=>i.capabilities.operations.supportsQuery)))}catch{return!1}})}function re(s,t,i){return u(this,null,function*(){let o=s.renderer;return o&&"defaultSymbol"in o&&!o.defaultSymbol&&(t=o.valueExpression?yield Promise.all(t.map(r=>o.getSymbolAsync(r,i).then(a=>a?r:null))).then(r=>r.filter(a=>a!=null)):t.filter(r=>o.getSymbol(r)!=null)),t})}d([f({constructOnly:!0})],m.prototype,"createFetchPopupFeaturesQueryGeometry",void 0),d([f({constructOnly:!0})],m.prototype,"layerView",void 0),d([f({constructOnly:!0})],m.prototype,"highlightGraphics",void 0),d([f({constructOnly:!0})],m.prototype,"highlightGraphicUpdated",void 0),d([f({constructOnly:!0})],m.prototype,"updatingHandles",void 0),m=d([M("esri.views.layers.support.MapServiceLayerViewHelper")],m);export{_e as a,m as b};
