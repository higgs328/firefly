import{a as O}from"./chunk-BL36WTGF.js";import{a as c,e as m,i as v,k as A}from"./chunk-TG45K3WR.js";import{f as w}from"./chunk-RAI4DTMT.js";import{a as e}from"./chunk-QGVBCWUY.js";import{e as a}from"./chunk-NFIPKH6V.js";import{l as d}from"./chunk-5QEXLALV.js";import{e as o,p as _,r as u,y as V}from"./chunk-4PTIEWMT.js";import{g as y}from"./chunk-XRGPJ3QY.js";import{c as p,f as h}from"./chunk-VTHXE323.js";var l;(function(s){s[s.PENDING=0]="PENDING",s[s.WAIT_FOR_VIEW_READY=1]="WAIT_FOR_VIEW_READY",s[s.RUNNING=2]="RUNNING"})(l||(l={}));var n=class extends O{constructor(s={}){super(s),this.analysisView=null,this._reconnectViewTask=null,this._parentChangeFromReconnect=!1,this._startUserOperation=null;let t=s?.analysis;t!=null?this.analysis=t:(this._set("analysis",this.constructAnalysis()),this._set("isAnalysisOwner",!0))}normalizeCtorArgs(s){let r=s,{analysis:t}=r;return p(r,["analysis"])}initialize(){this.addHandles([c(()=>this.analysis?.parent,s=>{this._parentChangeFromReconnect||s===this.view||this._set("isAnalysisOwner",!1);let t=!this._parentChangeFromReconnect;this._parentChangeFromReconnect=!1,t&&this._scheduleViewReconnect()},v),c(()=>({view:this.view,ready:this.view!=null&&this.view.ready,supported:this.supported}),({view:s},t)=>{let i=t?.view;s!==i&&(this._startUserOperation=o(this._startUserOperation),this._disconnectFromView(i)),this._scheduleViewReconnect()},A),c(()=>this.analysis.isEditable,(s,t)=>{this.analysisView!=null&&(s&&!t&&this.tool==null?this.createTool():s||!t||this.tool==null||this.tool.active||this.removeTool())})])}destroy(){this._reconnectViewTask=o(this._reconnectViewTask),this._startUserOperation=o(this._startUserOperation),this.analysisView!=null&&(this.analysisView.visible=void 0),this._disconnectFromView(this.view),this.analysis!=null&&this.isAnalysisOwner&&(this.analysis.destroy(),this._set("analysis",null))}set analysis(s){s!==this._get("analysis")&&(this._startUserOperation=o(this._startUserOperation),this._disconnectFromView(this.view),this._setExternalAnalysis(s),this._scheduleViewReconnect())}get ready(){return this.analysisView!=null&&!this.connectingToView}get connectingToView(){return this._reconnectViewTask!=null}get isAnalysisOwner(){return this._get("isAnalysisOwner")}set visible(s){this._set("visible",s),this.analysisView!=null&&(this.analysisView.visible=s)}start(){return h(this,null,function*(){if(!this.visible)return void y.getLogger(this).warn("Cannot start analysis when not visible");this.clear();let s={task:null,abort:null,state:l.PENDING},t=w(i=>h(this,null,function*(){s.state=l.WAIT_FOR_VIEW_READY,yield m(()=>this.ready,i),s.state=l.RUNNING,this.createTool({interactive:!0})}));return s.task=t,s.abort=()=>t.abort(),this._startUserOperation=s,t.promise})}clear(){this._startUserOperation=o(this._startUserOperation),this.removeTool(),this.analysis.clear()}onConnectToAnalysisView(s){}onDisconnectFromAnalysisView(){}_scheduleViewReconnect(){this._reconnectViewTask=o(this._reconnectViewTask);let s=w(t=>h(this,null,function*(){try{yield this._reconnectView(t)}catch(i){if(_(t),!V(i))return void y.getLogger(this).warn("Failed to use analysis in view model",i);throw i}finally{s===this._reconnectViewTask&&(this._reconnectViewTask=null)}}));this._reconnectViewTask=s}_reconnectView(s){return h(this,null,function*(){let{view:t}=this,i=t!=null&&t.ready&&this.supported,r=this.analysis;if(this._startUserOperation=g(this._startUserOperation),this._disconnectFromView(t),i&&t!=null&&r!=null){if(this.isAnalysisOwner){if(r.parent!=null)return void this.logError("expected owned analysis to have null parent when connecting to view");this._parentChangeFromReconnect=!0,t.analyses.add(r)}this.analysisView=yield t.whenAnalysisView(r),u(s)?this._startUserOperation=g(this._startUserOperation):(this.analysisView.visible=this.visible,this.onConnectToAnalysisView(this.analysisView),this.createTool())}})}_disconnectFromView(s){this.removeTool(),s!=null&&this.isAnalysisOwner&&(this._parentChangeFromReconnect=!0,s.analyses.remove(this.analysis),this.analysis.clear()),this.analysisView=null,this.onDisconnectFromAnalysisView()}_setExternalAnalysis(s){this.analysisView==null||this.isAnalysisOwner||(this.analysisView.visible=!0),this.analysisView=null,this._set("isAnalysisOwner",!1),this._set("analysis",s),this._parentChangeFromReconnect=!1}get testInfo(){}};function g(s){return s!=null&&s.state>=l.RUNNING?(s.abort(),null):s}e([a({nonNullable:!0})],n.prototype,"analysis",null),e([a()],n.prototype,"analysisView",void 0),e([a()],n.prototype,"ready",null),e([a()],n.prototype,"connectingToView",null),e([a({readOnly:!0})],n.prototype,"isAnalysisOwner",null),e([a({type:Boolean,value:!0})],n.prototype,"visible",null),e([a()],n.prototype,"_reconnectViewTask",void 0),n=e([d("esri.widgets.support.InteractiveAnalysisViewModel")],n);export{n as a};
