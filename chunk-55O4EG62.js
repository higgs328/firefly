import{a as $}from"./chunk-CVKHXVTW.js";import{D as U}from"./chunk-Y4PJQPM4.js";import{h as T}from"./chunk-XR5FT7TQ.js";import{a as L}from"./chunk-LAX5536Z.js";import{b as M}from"./chunk-2HYVVLKS.js";import{a as D}from"./chunk-3JGYBNJA.js";import{a as j}from"./chunk-K75TK42V.js";import{a as E}from"./chunk-GHKL3NOH.js";import{a as q,j as N}from"./chunk-TG45K3WR.js";import{b as f}from"./chunk-ACP3S2CH.js";import{a as r}from"./chunk-QGVBCWUY.js";import{H as O}from"./chunk-MYO4NP2N.js";import{e as i}from"./chunk-NFIPKH6V.js";import{l as S}from"./chunk-5QEXLALV.js";import{K as k,z as v}from"./chunk-4PTIEWMT.js";import{f as h}from"./chunk-VTHXE323.js";var C={fromGlobalId:"fromglobalid",fromNetworkSourceId:"fromnetworksourceid",fromTerminalId:"fromterminalid",toGlobalId:"toglobalid",toNetworkSourceId:"tonetworksourceid",toTerminalId:"toterminalid",associationType:"associationtype",globalId:"globalid",status:"status",isContentVisible:"iscontentvisible",percentAlong:"percentalong",assetGroup:"assetgroup",assetType:"assettype"};var P=100,s=class extends D.ClonableMixin(j.IdentifiableMixin(O)){constructor(t){super(t),this._loaded=!1,this._queryAbortController=null,this._queryPageAbortController=null,this._queryFeatureCountAbortController=null,this.networkSourceIdsInUse=new Set,this.source="popup",this.description=null,this.graphic=null,this.layer=null,this.map=null,this.featureCount=0,this.associationTypes=null,this.showAllEnabled=!1,this.title=null,this.attachmentsFeatureCount=0,this.structureFeatureCount=0,this.contentFeatureCount=0,this.containerFeatureCount=0,this.connectivityFeatureCount=0,this._queryOpenAssociationType=()=>h(this,null,function*(){this.activeAssociationType&&(yield this._queryDebounced(this.activeAssociationType))}),this._cancelQuery=()=>{let{_queryAbortController:e}=this;e&&e.abort(),this._queryAbortController=null},this._cancelQueryFeatureCount=()=>{let{_queryFeatureCountAbortController:e}=this;e&&e.abort(),this._queryFeatureCountAbortController=null},this._queryController=e=>h(this,null,function*(){this._cancelQuery();let o=new AbortController;this._queryAbortController=o,yield v(this._query(e)),this._queryAbortController===o&&(this._queryAbortController=null)}),this._queryFeatureCountController=()=>h(this,null,function*(){this._loaded=!1,this._cancelQueryFeatureCount();let e=new AbortController;this._queryFeatureCountAbortController=e,yield v(this._queryFeatureCount()),this._queryFeatureCountAbortController===e&&(this._queryFeatureCountAbortController=null),this._loaded=!0}),this._queryDebounced=k(this._queryController,P),this._queryFeatureCountDebounced=k(this._queryFeatureCountController,P)}initialize(){this.addHandles([q(()=>[this.graphic,this.layer,this.map,this.associationTypes,this.objectId,this.globalId,this.canQuery],()=>this.refresh(),N),q(()=>this.activeAssociationType,t=>this._queryDebounced(t),N)])}destroy(){this._cancelQuery(),this._cancelQueryFeatureCount(),this._destroyAssociatedFeatureViewModels()}get supportsCacheHint(){return!!this.layer?.capabilities?.query?.supportsCacheHint}get canLoad(){return!!this.map&&!!this.associationTypes&&typeof this.globalId=="string"}get canQuery(){let t=this.layer?.capabilities?.query;return!!this.associationTypes&&typeof this.globalId=="string"&&!!t?.supportsPagination}set displayCount(t){this._set("displayCount",Math.max(t??3,0))}get displayCount(){return this._get("displayCount")}get objectId(){return(this.objectIdField&&this.graphic?.attributes?.[this.objectIdField])??null}get objectIdField(){return this.layer?.objectIdField||null}get globalId(){return(this.globalIdField&&this.graphic?.attributes?.[this.globalIdField])??null}get globalIdField(){let{layer:t}=this;return t?.globalIdField}get activeAssociationType(){return this._get("activeAssociationType")}set activeAssociationType(t){t&&!this.associationTypes.includes(t)||this._set("activeAssociationType",t)}get state(){let{_queryAbortController:t,_queryFeatureCountAbortController:e,_queryPageAbortController:o,canQuery:a,_loaded:l,canLoad:u,source:d}=this;return e||u&&!l?"loading":t||o?"querying":!a||d==="popup"&&this.featureCount===0?"disabled":"ready"}get utilityNetwork(){let{layer:t,map:e}=this;if(!t?.loaded||!e)return null;let o=T(t)?t.parent:t;return U(e,o)}get attachmentsAssociations(){return this._get("attachmentsAssociations")||new f}get structureAssociations(){return this._get("structureAssociations")||new f}get contentAssociations(){return this._get("contentAssociations")||new f}get containerAssociations(){return this._get("containerAssociations")||new f}get connectivityAssociations(){return this._get("connectivityAssociations")||new f}get associationFeatures(){return this._get("associationFeatures")||new E}get associationViewModels(){return this._get("associationViewModels")||new Map}refresh(){return h(this,null,function*(){yield this._queryFeatureCountDebounced(),yield this._queryOpenAssociationType()})}getFeatureCountForAssociationType(t){switch(t){case"attachment":return this.attachmentsFeatureCount;case"structure":return this.structureFeatureCount;case"content":return this.contentFeatureCount;case"container":return this.containerFeatureCount;case"connectivity":return this.connectivityFeatureCount}}_destroyAssociatedFeatureViewModels(){this.associationViewModels.forEach(t=>t.destroyAll())}_loadUtiltyNetworks(){return h(this,null,function*(){let t=this.map;if(!t)return;yield Promise.allSettled(t.utilityNetworks?.map(o=>h(this,null,function*(){yield o.load()}))??[]);let e=this.utilityNetwork;if(e){let o=a=>{if("layerId"in a&&e.isUtilityLayer(a)){let l=e.getSourceIdByLayerId(a.layerId);l!==null&&this.networkSourceIdsInUse.add(l)}};this._set("networkSourceIdsInUse",new Set),t.allLayers.forEach(o),t.allTables.forEach(o)}})}_findLayersBySourceId(t){return h(this,null,function*(){let{utilityNetwork:e,map:o}=this,a=c=>{let A=c;return c.url&&A.layerId===l?c.url.replace(/\/\d+$/,"")===e?.featureServiceUrl:!1};yield e?.load();let l=e.getLayerIdBySourceId(t),u=o.allLayers.filter(a),d=o.allTables.filter(a),m=u.concat(d).toArray();return yield Promise.allSettled(m.map(c=>c.load())),m})}_clearAssociations(){this.attachmentsAssociations.removeAll(),this.structureAssociations.removeAll(),this.contentAssociations.removeAll(),this.containerAssociations.removeAll(),this.connectivityAssociations.removeAll()}_clearFeatures(){this.associationFeatures.forEach(t=>t.removeAll()),this.associationFeatures.clear()}_getAssociationsByType(t){switch(t){case"attachment":return this.attachmentsAssociations;case"structure":return this.structureAssociations;case"connectivity":return this.connectivityAssociations;case"container":return this.containerAssociations;case"content":return this.contentAssociations}}_queryLayer(t,e,o,a,l){return h(this,null,function*(){let u=t.fieldsIndex.get(C.assetGroup),d=t.fieldsIndex.get(C.assetType),m=o!=null,c=a!=null,A="("+e.map(g=>`'${g}'`).join(", ")+")",p=m?` AND ${u?.name} = ${o}`:"",y=m&&c?` AND ${d?.name} = ${a}`:"",w=`${t.globalIdField} IN ${A}`+p+y,n=new M({outFields:["*"],cacheHint:this.supportsCacheHint,where:w});return yield this._queryAll(n,t,{signal:l?.signal})})}_createAssociationFeatureObjects(t,e,o,a,l,u){return h(this,null,function*(){if(t.length===0)return[];let d=new Map;for(let[c,A]of e){let p=yield this._findLayersBySourceId(c);for(let y of p)(yield this._queryLayer(y,A,a,l,u)).forEach(w=>{if(this.source==="popup"?w.layer&&w.getEffectivePopupTemplate():w.layer){let n=d.get(w.attributes[y.globalIdField])??[];n.push(w),d.set(w.attributes[y.globalIdField],n)}})}let m=[];return yield Promise.all(t.toArray().map(c=>h(this,null,function*(){let{fromNetworkElement:A,toNetworkElement:p}=c,y=A.globalId===o?p:A,w=d.get(y.globalId)??[];yield Promise.all(w.map(n=>h(this,null,function*(){let g=this.utilityNetwork?.getTerminalById(y?.terminalId)?.name;if(n.layer&&"getFeatureTitle"in n.layer){let b=yield n.layer.getFeatureTitle(n);m.push({title:b,association:c,feature:n,terminalName:g})}else m.push({association:c,feature:n,terminalName:g})})))}))),m})}_parseFeatureObjects(t,e){t.forEach(o=>{let a=o?.feature,l=a.layer,u=e.get(l)??new f;u.add(o),e.set(l,u)})}_queryAll(t,e,o){return h(this,null,function*(){let a=[],l=0,u=!1;t.num=e.sourceJSON?.maxRecordCount??2e3;do{t.start=l;let d=yield e.queryFeatures(t,o);a.push(...d.features),u=d.exceededTransferLimit,u&&(l+=d.features.length)}while(u);return a})}_queryAssociations(t){return h(this,null,function*(){let{layer:e,globalId:o,associationTypes:a,utilityNetwork:l,canQuery:u}=this;if(yield Promise.allSettled([e?.load(),l?.load()]),this._clearAssociations(),!(u&&e&&a&&l&&o))return;let d=T(e)?e.parent:e,m=new $({globalId:o,networkSourceId:l.getSourceIdByLayerId(d.layerId)}),c=new Set;a.forEach(n=>{switch(n.type){case"attachment":case"structure":c.add("attachment");break;case"container":case"content":c.add("containment");break;case"connectivity":c.add("connectivity"),c.add("junction-junction-connectivity"),c.add("junction-edge-from-connectivity"),c.add("junction-edge-midspan-connectivity"),c.add("junction-edge-to-connectivity")}});let A=yield l?.queryAssociations({elements:[m],types:Array.from(c)},{signal:t?.signal}),p=new Map,y=new Map;a.forEach(n=>{y.set(n.type,n),p.set(n.type,[])}),A.forEach(n=>{let{toNetworkElement:g,fromNetworkElement:b}=n;switch(n.associationType){case"connectivity":case"junction-junction-connectivity":case"junction-edge-from-connectivity":case"junction-edge-midspan-connectivity":case"junction-edge-to-connectivity":if(b?.globalId===o){if(this._shouldDiscardNetworkElement(g,"connectivity",y))break;p.get("connectivity")?.push(g.globalId)}else{if(this._shouldDiscardNetworkElement(b,"connectivity",y))break;p.get("connectivity")?.push(b.globalId)}this.connectivityAssociations.add(n);break;case"containment":if(b?.globalId===o){if(this._shouldDiscardNetworkElement(g,"content",y))break;p.get("content")?.push(g.globalId),this.contentAssociations.add(n)}else{if(this._shouldDiscardNetworkElement(b,"container",y))break;p.get("container")?.push(b.globalId),this.containerAssociations.add(n)}break;case"attachment":if(b?.globalId===o){if(this._shouldDiscardNetworkElement(g,"attachment",y))break;p.get("attachment")?.push(g.globalId),this.attachmentsAssociations.add(n)}else{if(this._shouldDiscardNetworkElement(b,"structure",y))break;p.get("structure")?.push(b.globalId),this.structureAssociations.add(n)}}});let w=a.map(n=>h(this,null,function*(){let{associatedNetworkSourceId:g,associatedAssetGroup:b,associatedAssetType:I}=n,F=p.get(n.type),_=b!=null?yield this._countAssociatedFeatures(g,F,b,I,t):F.length;switch(n.type){case"attachment":this._set("attachmentsFeatureCount",_);break;case"structure":this._set("structureFeatureCount",_);break;case"content":this._set("contentFeatureCount",_);break;case"container":this._set("containerFeatureCount",_);break;case"connectivity":this._set("connectivityFeatureCount",_)}}));yield Promise.allSettled(w)})}_countAssociatedFeatureCount(t,e,o,a,l){return h(this,null,function*(){let u=t.fieldsIndex.get(C.assetGroup),d=t.fieldsIndex.get(C.assetType),m=a!=null,c="("+e.map(w=>`'${w}'`).join(", ")+")",A=` AND ${u?.name} = ${o}`,p=m?` AND ${d?.name} = ${a}`:"",y=`${t.globalIdField} IN ${c}`+A+p;return t.queryFeatureCount({where:y,outFields:["*"],returnGeometry:!1},{signal:l?.signal})})}_countAssociatedFeatures(t,e,o,a,l){return h(this,null,function*(){if(e.length===0)return 0;let u=(yield this._findLayersBySourceId(t)).map(d=>h(this,null,function*(){return this._countAssociatedFeatureCount(d,e,o,a,l)}));return(yield Promise.all(u)).reduce((d,m)=>d+m,0)})}_queryAssociatedFeatures(t,e){return h(this,null,function*(){let{layer:o,globalId:a,associationTypes:l,utilityNetwork:u,canQuery:d,associationFeatures:m}=this;if(yield Promise.allSettled([o?.load(),u?.load()]),!(d&&o&&l&&u))return;let c=this._getAssociationsByType(t.type),{associatedAssetGroup:A,associatedAssetType:p}=t,y=new Map;c.forEach(n=>{let{fromNetworkElement:g,toNetworkElement:b}=n,{networkSourceId:I,elementGlobalId:F}=g.globalId===a?{networkSourceId:b.networkSourceId,elementGlobalId:b.globalId}:{networkSourceId:g.networkSourceId,elementGlobalId:g.globalId},_=y.get(I)||[];_.push(F),y.set(I,_)});let w=yield this._createAssociationFeatureObjects(c,y,a,A,p,e);this._parseFeatureObjects(w,m)})}_queryFeatureCount(){return h(this,null,function*(){yield this._loadUtiltyNetworks();let{_queryFeatureCountAbortController:t,canQuery:e}=this;e?(yield this._queryAssociations(t),this._set("featureCount",this.attachmentsFeatureCount+this.structureFeatureCount+this.contentFeatureCount+this.containerFeatureCount+this.connectivityFeatureCount)):this._set("featureCount",0)})}_query(t){return h(this,null,function*(){if(!t)return;yield this._loadUtiltyNetworks();let{_queryAbortController:e}=this;this._destroyAssociatedFeatureViewModels(),this._clearFeatures(),this.featureCount!==0&&(this.destroyed||(yield this._queryAssociatedFeatures(t,{signal:e?.signal})))})}_shouldDiscardNetworkElement(t,e,o){if(!t)return!1;let{networkSourceIdsInUse:a}=this,{networkSourceId:l}=t,u=o.get(e)?.associatedNetworkSourceId,d=a.has(l);return u!=null&&u!==l||!d}};r([i()],s.prototype,"_loaded",void 0),r([i()],s.prototype,"_queryAbortController",void 0),r([i()],s.prototype,"_queryPageAbortController",void 0),r([i()],s.prototype,"_queryFeatureCountAbortController",void 0),r([i({readOnly:!0})],s.prototype,"supportsCacheHint",null),r([i({readOnly:!0})],s.prototype,"canLoad",null),r([i({readOnly:!0})],s.prototype,"canQuery",null),r([i()],s.prototype,"networkSourceIdsInUse",void 0),r([i({constructOnly:!0})],s.prototype,"source",void 0),r([i()],s.prototype,"description",void 0),r([i({value:3})],s.prototype,"displayCount",null),r([i({type:L})],s.prototype,"graphic",void 0),r([i()],s.prototype,"layer",void 0),r([i()],s.prototype,"map",void 0),r([i({readOnly:!0})],s.prototype,"objectId",null),r([i({readOnly:!0})],s.prototype,"objectIdField",null),r([i({readOnly:!0})],s.prototype,"globalId",null),r([i({readOnly:!0})],s.prototype,"globalIdField",null),r([i()],s.prototype,"featureCount",void 0),r([i()],s.prototype,"associationTypes",void 0),r([i()],s.prototype,"activeAssociationType",null),r([i()],s.prototype,"showAllEnabled",void 0),r([i()],s.prototype,"state",null),r([i()],s.prototype,"title",void 0),r([i({readOnly:!0})],s.prototype,"utilityNetwork",null),r([i({readOnly:!0})],s.prototype,"attachmentsFeatureCount",void 0),r([i({readOnly:!0})],s.prototype,"structureFeatureCount",void 0),r([i({readOnly:!0})],s.prototype,"attachmentsAssociations",null),r([i({readOnly:!0})],s.prototype,"structureAssociations",null),r([i({readOnly:!0})],s.prototype,"contentFeatureCount",void 0),r([i({readOnly:!0})],s.prototype,"containerFeatureCount",void 0),r([i({readOnly:!0})],s.prototype,"contentAssociations",null),r([i({readOnly:!0})],s.prototype,"containerAssociations",null),r([i({readOnly:!0})],s.prototype,"connectivityFeatureCount",void 0),r([i({readOnly:!0})],s.prototype,"connectivityAssociations",null),r([i({readOnly:!0})],s.prototype,"associationFeatures",null),r([i({readOnly:!0})],s.prototype,"associationViewModels",null),s=r([S("esri.widgets.support.UtilityNetworkAssociations.FeatureUtilityNetworkAssociationsViewModel")],s);var at=s;export{at as a};
