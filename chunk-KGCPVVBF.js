import{a as j}from"./chunk-6ZSLG6BI.js";import{a as L}from"./chunk-Y4PJQPM4.js";import{a as A}from"./chunk-IBVI7JQ7.js";import{a as _}from"./chunk-LAX5536Z.js";import{a as q}from"./chunk-YJKJQU3F.js";import{a as I}from"./chunk-G4DZJMGT.js";import{a as v,j as b}from"./chunk-TG45K3WR.js";import{b as y}from"./chunk-ACP3S2CH.js";import{a as s}from"./chunk-QGVBCWUY.js";import{H as w}from"./chunk-MYO4NP2N.js";import{e as o}from"./chunk-NFIPKH6V.js";import{l as g}from"./chunk-5QEXLALV.js";import{b as a}from"./chunk-YOFFGXOB.js";import{a as u,f}from"./chunk-VTHXE323.js";var F={editing:!1,operations:{add:!0,update:!0,delete:!0}},C=y.ofType(j),n=class extends w{constructor(e){super(e),this._getAttachmentsPromise=null,this._attachmentLayer=null,this.capabilities=u({},F),this.activeAttachmentInfo=null,this.activeFileInfo=null,this.attachmentInfos=new C,this.fileInfos=new y,this.graphic=null,this.mode="view",this.orderByFields=null,this.filesEnabled=!1,this.addHandles(v(()=>this.graphic,()=>this._graphicChanged(),b))}destroy(){this._attachmentLayer=null,this.graphic=null}castCapabilities(e){return u(u({},F),e)}get state(){return this._getAttachmentsPromise?"loading":this.graphic?"ready":"disabled"}get supportsResizeAttachments(){let{graphic:e}=this;if(!e)return!1;let t=e.layer||e.sourceLayer;return t?.loaded&&"capabilities"in t&&t.capabilities&&"attachment"in t.capabilities&&t.capabilities.attachment&&"supportsResize"in t.capabilities.attachment&&t.capabilities.attachment.supportsResize||!1}getAttachments(){return f(this,null,function*(){let{_attachmentLayer:e,attachmentInfos:t,orderByFields:r}=this;if(!e||typeof e.queryAttachments!="function")throw new a("invalid-layer","getAttachments(): A valid layer is required.");let i=this._getObjectId();if(typeof i!="number")throw new a("invalid-object-id","getAttachments(): Numeric object id is required");let c=r?.map(p=>`${p.field} ${p.order==="descending"?"DESC":"ASC"}`),h=new A({objectIds:[i],returnMetadata:!0,orderByFields:c}),d=[],l=e.queryAttachments(h).then(p=>p[i]||d).catch(()=>d);this._getAttachmentsPromise=l,this.notifyChange("state");let m=yield l;return t.destroyAll(),m.length&&t.addMany(m),this._getAttachmentsPromise=null,this.notifyChange("state"),m})}addAttachment(r){return f(this,arguments,function*(e,t=this.graphic){let{_attachmentLayer:i,attachmentInfos:c,capabilities:h}=this;if(!t)throw new a("invalid-graphic","addAttachment(): A valid graphic is required.",{graphic:t});if(!e)throw new a("invalid-attachment","addAttachment(): An attachment is required.",{attachment:e});if(!h.operations?.add)throw new a("invalid-capabilities","addAttachment(): add capabilities are required.");if(!i||typeof i.addAttachment!="function")throw new a("invalid-layer","addAttachment(): A valid layer is required.");let d=i.addAttachment(t,e).then(m=>this._queryAttachment(m.objectId,t)),l=yield d;return c.add(l),l})}deleteAttachment(e){return f(this,null,function*(){let{_attachmentLayer:t,attachmentInfos:r,graphic:i,capabilities:c}=this;if(!e)throw new a("invalid-attachment-info","deleteAttachment(): An attachmentInfo is required.",{attachmentInfo:e});if(!c.operations?.delete)throw new a("invalid-capabilities","deleteAttachment(): delete capabilities are required.");if(!t||typeof t.deleteAttachments!="function")throw new a("invalid-layer","deleteAttachment(): A valid layer is required.");if(!i)throw new a("invalid-graphic","deleteAttachment(): A graphic is required.");let h=t.deleteAttachments(i,[e.id]).then(()=>e),d=yield h;return r.remove(d),d.destroy(),d})}updateAttachment(r){return f(this,arguments,function*(e,t=this.activeAttachmentInfo){let{_attachmentLayer:i,attachmentInfos:c,graphic:h,capabilities:d}=this;if(!e)throw new a("invalid-attachment","updateAttachment(): An attachment is required.",{attachment:e});if(!t)throw new a("invalid-attachment-info","updateAttachment(): An attachmentInfo is required.",{attachmentInfo:t});if(!d.operations?.update)throw new a("invalid-capabilities","updateAttachment(): Update capabilities are required.");let l=c.indexOf(t);if(!i||typeof i.updateAttachment!="function")throw new a("invalid-layer","updateAttachment(): A valid layer is required.");if(!h)throw new a("invalid-graphic","updateAttachment(): A graphic is required.");let m=i.updateAttachment(h,t.id,e).then(O=>this._queryAttachment(O.objectId)),p=yield m;return c.splice(l,1,p),p})}commitFiles(){return f(this,null,function*(){return yield Promise.all(this.fileInfos.items.map(e=>this.addAttachment(e.form))),this.fileInfos.removeAll(),this.getAttachments()})}addFile(e,t){if(!e||!t)return null;let r={file:e,form:t};return this.fileInfos.add(r),r}updateFile(e,t,r=this.activeFileInfo){if(!e||!t||!r)return null;let i=this.fileInfos.indexOf(r);return i>-1&&this.fileInfos.splice(i,1,{file:e,form:t}),this.fileInfos.items[i]}deleteFile(e){let t=this.fileInfos.find(r=>r.file===e);return t?(this.fileInfos.remove(t),t):null}_queryAttachment(e,t){return f(this,null,function*(){let{_attachmentLayer:r}=this;if(!e||!r?.queryAttachments)throw new a("invalid-attachment-id","Could not query attachment.");let i=this._getObjectId(t);if(typeof i!="number")throw new a("invalid-object-id","getAttachments(): Numeric object id is required");let c=new A({objectIds:[i],attachmentsWhere:`AttachmentId=${e}`,returnMetadata:!0});return r.queryAttachments(c).then(h=>h[i][0])})}_getObjectId(e=this.graphic){return e?.getObjectId()??null}_graphicChanged(){this.graphic&&(this._setAttachmentLayer(),this.getAttachments().catch(()=>this.attachmentInfos.destroyAll()))}_setAttachmentLayer(){let{graphic:e}=this,t=L(e);this._attachmentLayer=t?t.type==="scene"&&t.associatedLayer!=null?t.associatedLayer:t:null}};s([o()],n.prototype,"capabilities",void 0),s([I("capabilities")],n.prototype,"castCapabilities",null),s([o()],n.prototype,"activeAttachmentInfo",void 0),s([o()],n.prototype,"activeFileInfo",void 0),s([o({readOnly:!0,type:C})],n.prototype,"attachmentInfos",void 0),s([o()],n.prototype,"fileInfos",void 0),s([o({type:_})],n.prototype,"graphic",void 0),s([o()],n.prototype,"mode",void 0),s([o({type:[q]})],n.prototype,"orderByFields",void 0),s([o({readOnly:!0})],n.prototype,"state",null),s([o()],n.prototype,"filesEnabled",void 0),s([o({readOnly:!0})],n.prototype,"supportsResizeAttachments",null),n=s([g("esri.widgets.Attachments.AttachmentsViewModel")],n);var W=n;export{W as a};
