import{d as _t}from"./chunk-FWBT5WUO.js";import{a as gt}from"./chunk-MTYOPLNE.js";import{a as F}from"./chunk-4TIUXNXO.js";import{a as _,b as P}from"./chunk-CX3G2QWN.js";import{a as W,d as V}from"./chunk-CZMBPC27.js";import{a as x,c as Q}from"./chunk-AKKUUEQK.js";import{c as ft}from"./chunk-NGZE6C3L.js";import{b as dt}from"./chunk-JFBLKPWZ.js";import{a as D}from"./chunk-B7PAC3NI.js";import{a as w}from"./chunk-ZOOQQO74.js";import{c as yt}from"./chunk-NIRJWS2D.js";import{a as pt}from"./chunk-XQOE7Z4Q.js";import{e as Y}from"./chunk-5LG2P6MT.js";import{l as E,n as ot,r as g}from"./chunk-HM5RIVQC.js";import{c as ht,i as lt,j as ct,k as ut}from"./chunk-DJW5LMRG.js";import{a as nt}from"./chunk-DZFUQCB6.js";import{o as at}from"./chunk-AUAZP44J.js";import{$ as j}from"./chunk-76ATOSLU.js";import{B as q,c as M,e as et,s as st,t as it,y as rt}from"./chunk-4PTIEWMT.js";import{a as R,b as v,f as S}from"./chunk-VTHXE323.js";var A=class{constructor(t,s){this._width=0,this._height=0,this._free=[],this._width=t,this._height=s,this._free.push(new w(0,0,t,s))}get width(){return this._width}get height(){return this._height}allocate(t,s){if(t>this._width||s>this._height)return new w;let e=null,i=-1;for(let r=0;r<this._free.length;++r){let a=this._free[r];t<=a.width&&s<=a.height&&(e===null||a.y<=e.y&&a.x<=e.x)&&(e=a,i=r)}return e===null?new w:(this._free.splice(i,1),e.width<e.height?(e.width>t&&this._free.push(new w(e.x+t,e.y,e.width-t,s)),e.height>s&&this._free.push(new w(e.x,e.y+s,e.width,e.height-s))):(e.width>t&&this._free.push(new w(e.x+t,e.y,e.width-t,e.height)),e.height>s&&this._free.push(new w(e.x,e.y+s,t,e.height-s))),new w(e.x,e.y,t,s))}release(t){for(let s=0;s<this._free.length;++s){let e=this._free[s];if(e.y===t.y&&e.height===t.height&&e.x+e.width===t.x)e.width+=t.width;else if(e.x===t.x&&e.width===t.width&&e.y+e.height===t.y)e.height+=t.height;else if(t.y===e.y&&t.height===e.height&&t.x+t.width===e.x)e.x=t.x,e.width+=t.width;else{if(t.x!==e.x||t.width!==e.width||t.y+t.height!==e.y)continue;e.y=t.y,e.height+=t.height}this._free.splice(s,1),this.release(t)}this._free.push(t)}};var T=class{constructor(t,s,e){this.width=0,this.height=0,this._dirties=[],this._glyphData=[],this._currentPage=0,this._glyphIndex={},this._textures=[],this._rangePromises=new Map,this.width=t,this.height=s,this._glyphSource=e,this._binPack=new A(t-4,s-4),this._glyphData.push(new Uint8Array(t*s)),this._dirties.push(!0),this._textures.push(void 0)}getGlyphItems(t,s){let e=[],i=this._glyphSource,r=new Set,a=1/256;for(let h of s){let o=Math.floor(h*a);r.add(o)}let n=[];return r.forEach(h=>{let o=t+h;if(this._rangePromises.has(o))n.push(this._rangePromises.get(o));else{let l=i.getRange(t,h).then(()=>{this._rangePromises.delete(o)},()=>{this._rangePromises.delete(o)});this._rangePromises.set(o,l),n.push(l)}}),Promise.all(n).then(()=>{let h=this._glyphIndex[t];h||(h={},this._glyphIndex[t]=h);for(let o of s){let l=h[o];if(l){e[o]={sdf:!0,rect:l.rect,metrics:l.metrics,page:l.page,code:o};continue}let m=i.getGlyph(t,o);if(!m?.metrics)continue;let p=m.metrics,u;if(p.width===0)u=new w(0,0,0,0);else{let c=p.width+6,y=p.height+2*3,b=c%4?4-c%4:4,I=y%4?4-y%4:4;b===1&&(b=5),I===1&&(I=5),u=this._binPack.allocate(c+b,y+I),u.isEmpty&&(this._dirties[this._currentPage]||(this._glyphData[this._currentPage]=null),this._currentPage=this._glyphData.length,this._glyphData.push(new Uint8Array(this.width*this.height)),this._dirties.push(!0),this._textures.push(void 0),this._binPack=new A(this.width-4,this.height-4),u=this._binPack.allocate(c+b,y+I));let O=this._glyphData[this._currentPage],Z=m.bitmap,$,tt;if(Z)for(let B=0;B<y;B++){$=c*B,tt=this.width*(u.y+B+1)+u.x;for(let z=0;z<c;z++)O[tt+z+1]=Z.at($+z)}}h[o]={rect:u,metrics:p,tileIDs:null,page:this._currentPage},e[o]={sdf:!0,rect:u,metrics:p,page:this._currentPage,code:o},this._dirties[this._currentPage]=!0}return e})}removeGlyphs(t){for(let s in this._glyphIndex){let e=this._glyphIndex[s];if(!e)continue;let i;for(let r in e)if(i=e[r],i.tileIDs.delete(t),i.tileIDs.size===0){let a=this._glyphData[i.page],n=i.rect,h,o;for(let l=0;l<n.height;l++)for(h=this.width*(n.y+l)+n.x,o=0;o<n.width;o++)a[h+o]=0;delete e[r],this._dirties[i.page]=!0}}}bind(t,s,e,i=0){if(!this._textures[e]){let a=new W;a.pixelFormat=ot.ALPHA,a.wrapMode=E.CLAMP_TO_EDGE,a.width=this.width,a.height=this.height,this._textures[e]=new V(t,a,new Uint8Array(this.width*this.height))}let r=this._textures[e];r.setSamplingMode(s),this._dirties[e]&&r.setData(this._glyphData[e]),t.bindTexture(r,i),this._dirties[e]=!1}destroy(){this.dispose()}dispose(){this._glyphData.length=0,this._binPack=null;for(let t of this._textures)t&&t.dispose();this._textures.length=0}};var C=class{constructor(t){if(this._metrics=[],!t)return void(this._allBitmaps=null);let s=new Map,e=0;for(;t.next();)switch(t.tag()){case 1:{let a=t.getMessage();for(;a.next();)switch(a.tag()){case 3:{let n=a.getMessage(),h,o,l,m,p,u,f;for(;n.next();)switch(n.tag()){case 1:h=n.getUInt32();break;case 2:o=n.getBytes();break;case 3:l=n.getUInt32();break;case 4:m=n.getUInt32();break;case 5:p=n.getSInt32();break;case 6:u=n.getSInt32();break;case 7:f=n.getUInt32();break;default:n.skip()}if(n.release(),h){let c=o?.length??0;this._metrics[h]={width:l,height:m,left:p,top:u,advance:f,startOffset:e,length:c},s.set(h,o),e+=c}break}default:a.skip()}a.release();break}default:t.skip()}let i=new Uint8Array(e),r=this._metrics;for(let[a,n]of s){let{startOffset:h,length:o}=r[a];if(n)for(let l=0;l<o;++l)i[h+l]=n[l]}this._allBitmaps=i}getMetrics(t){return this._metrics[t]}getBitmap(t){if(!this._allBitmaps)return;let s=this._metrics[t];if(s===void 0)return;let{startOffset:e,length:i}=s;return i!==0?new J(this._allBitmaps,e,i):void 0}},X=class{constructor(){this._ranges=[]}get ranges(){return this._ranges}getRange(t){return this._ranges[t]}addRange(t,s){this._ranges[t]=s}},k=class{constructor(t){this._glyphInfo={},this._baseURL=t}getRange(t,s){let e=this._getFontStack(t);if(e.getRange(s))return Promise.resolve();let i=256*s,r=i+255;if(this._baseURL){let a=this._baseURL.replace("{fontstack}",t).replace("{range}",i+"-"+r);return at(a,{responseType:"array-buffer"}).then(n=>{e.addRange(s,new C(new pt(new Uint8Array(n.data),new DataView(n.data))))}).catch(()=>{e.addRange(s,new C)})}return e.addRange(s,new C),Promise.resolve()}getGlyph(t,s){let e=this._getFontStack(t);if(!e)return;let i=Math.floor(s/256),r=e.getRange(i);return r?{metrics:r.getMetrics(s),bitmap:r.getBitmap(s)}:void 0}_getFontStack(t){let s=this._glyphInfo[t];return s||(s=this._glyphInfo[t]=new X),s}},J=class{constructor(t,s,e){this._array=t,this._start=s,this.length=e}at(t){return 0<=t&&t<this.length?this._array[this._start+t]:void 0}};var It="dasharray-",U=class d{constructor(t,s,e=0){this._size=[],this._mosaicsData=[],this._textures=[],this._dirties=[],this._maxItemSize=0,this._currentPage=0,this._pageWidth=0,this._pageHeight=0,this._mosaicRects={},this.pixelRatio=1,s<=0&&console.error("Sprites mosaic defaultWidth and defaultHeight must be greater than zero!"),this._pageWidth=t,this._pageHeight=s,e>0&&(this._maxItemSize=e),this._binPack=new A(t-4,s-4)}destroy(){this.dispose()}dispose(){this._binPack=null,this._mosaicsData.length=0,this._mosaicRects={};for(let t of this._textures)t&&t.dispose();this._textures.length=0}getWidth(t){return t>=this._size.length?-1:this._size[t][0]}getHeight(t){return t>=this._size.length?-1:this._size[t][1]}getPageSize(t){return t>=this._size.length?null:this._size[t]}setSpriteSource(t){if(this.dispose(),this.pixelRatio=t.devicePixelRatio,this._mosaicsData.length===0){this._binPack=new A(this._pageWidth-4,this._pageHeight-4);let s=Math.floor(this._pageWidth),e=Math.floor(this._pageHeight),i=new Uint32Array(s*e);this._mosaicsData[0]=i,this._dirties.push(!0),this._size.push([this._pageWidth,this._pageHeight]),this._textures.push(void 0)}this._sprites=t}getSpriteItem(t,s=!1){let e,i,r=this._mosaicRects[t];if(r)return r;if(!this._sprites||this._sprites.loadStatus!=="loaded"||(t&&t.startsWith(It)?([e,i]=this._rasterizeDash(t),s=!0):e=this._sprites.getSpriteInfo(t),!e?.width||!e.height||e.width<0||e.height<0))return null;let a=e.width,n=e.height,[h,o,l]=this._allocateImage(a,n);return h.width<=0?null:(this._copy(h,e,o,l,s,i),r={type:"sprite",rect:h,width:a,height:n,sdf:e.sdf,simplePattern:!1,rasterizationScale:e.pixelRatio??1,samplingMode:"Linear",page:o},this._mosaicRects[t]=r,r)}getSpriteItems(t){let s={};for(let e of t)s[e.name]=this.getSpriteItem(e.name,e.repeat);return s}getMosaicItemPosition(t,s){let e=this.getSpriteItem(t,s),i=e?.rect;if(!i)return null;i.width=e.width,i.height=e.height;let r=e.width,a=e.height,n=2;return{tl:[i.x+n,i.y+n],br:[i.x+n+r,i.y+n+a],page:e.page}}bind(t,s,e=0,i=0){if(e>=this._size.length||e>=this._mosaicsData.length)return;if(!this._textures[e]){let a=new W;a.wrapMode=E.CLAMP_TO_EDGE,a.width=this._size[e][0],a.height=this._size[e][1],this._textures[e]=new V(t,a,new Uint8Array(this._mosaicsData[e].buffer))}let r=this._textures[e];r.setSamplingMode(s),this._dirties[e]&&r.setData(new Uint8Array(this._mosaicsData[e].buffer)),t.bindTexture(r,i),this._dirties[e]=!1}static _copyBits(t,s,e,i,r,a,n,h,o,l,m){let p=i*s+e,u=h*a+n;if(m){u-=a;for(let f=-1;f<=l;f++,p=((f+l)%l+i)*s+e,u+=a)for(let c=-1;c<=o;c++)r[u+c]=t[p+(c+o)%o]}else for(let f=0;f<l;f++){for(let c=0;c<o;c++)r[u+c]=t[p+c];p+=s,u+=a}}_copy(t,s,e,i,r,a){if(!this._sprites||this._sprites.loadStatus!=="loaded"||e>=this._mosaicsData.length)return;let n=new Uint32Array(a?a.buffer:this._sprites.image.buffer),h=this._mosaicsData[e],o=2,l=a?s.width:this._sprites.width;d._copyBits(n,l,s.x,s.y,h,i[0],t.x+o,t.y+o,s.width,s.height,r),this._dirties[e]=!0}_allocateImage(t,s){t+=2,s+=2;let e=Math.max(t,s);if(this._maxItemSize&&this._maxItemSize<e){let n=new w(0,0,t,s);return this._mosaicsData.push(new Uint32Array(t*s)),this._dirties.push(!0),this._size.push([t,s]),this._textures.push(void 0),[n,this._mosaicsData.length-1,[t,s]]}let i=t%4?4-t%4:4,r=s%4?4-s%4:4;i===1&&(i=5),r===1&&(r=5);let a=this._binPack.allocate(t+i,s+r);return a.width<=0?(this._dirties[this._currentPage]||(this._mosaicsData[this._currentPage]=null),this._currentPage=this._mosaicsData.length,this._mosaicsData.push(new Uint32Array(this._pageWidth*this._pageHeight)),this._dirties.push(!0),this._size.push([this._pageWidth,this._pageHeight]),this._textures.push(void 0),this._binPack=new A(this._pageWidth-4,this._pageHeight-4),this._allocateImage(t,s)):[a,this._currentPage,[this._pageWidth,this._pageHeight]]}_rasterizeDash(t){let s=/\[(.*?)\]/,e=t.match(s);if(!e)return null;let i=e[1].split(",").map(Number),r=t.slice(t.lastIndexOf("-")+1),[a,n,h]=ft(i,r);return[{x:0,y:0,width:n,height:h,sdf:!0,pixelRatio:1},new Uint8Array(a.buffer)]}};var mt=class{constructor(t,s,e,i){this._layer=t,this._styleRepository=s,this.devicePixelRatio=e,this._sourceDataMaxLOD=i,this._spriteMosaic=null,this._glyphMosaic=null,this._connection=null,this._spriteSourceAbortController=null,this._startOptionsInputSignal=null,this._inputSignalEventListener=null}destroy(){this._connection?.close(),this._connection=null,this._styleRepository=null,this._layer=null,this._spriteMosaic?.destroy(),this._spriteMosaic=null,this._glyphMosaic=null,this._spriteSourceAbortController=et(this._spriteSourceAbortController),this._spriteSourcePromise=null,this._inputSignalEventListener&&this._startOptionsInputSignal?.removeEventListener("abort",this._inputSignalEventListener),this._startOptionsInputSignal=null,this._inputSignalEventListener=null}get spriteMosaic(){return this._spriteSourcePromise.then(()=>this._spriteMosaic)}get glyphMosaic(){return this._glyphMosaic}start(t){return S(this,null,function*(){this._requestSprite(t);let s=this._layer.currentStyleInfo.glyphsUrl,e=new k(s?j(s,v(R({},this._layer.customParameters),{token:this._layer.apiKey})):null);this._glyphMosaic=new T(1024,1024,e),this._broadcastPromise=yt("WorkerTileHandler",{client:this,schedule:t.schedule,signal:t.signal}).then(i=>{if(this._layer&&(this._connection?.close(),this._connection=i,this._layer&&!this._connection.closed)){let r=i.broadcast("setStyle",{style:this._layer.currentStyleInfo.style,sourceDataMaxLOD:this._sourceDataMaxLOD},t);Promise.all(r).catch(a=>it(a))}})})}_requestSprite(t){this._spriteSourceAbortController?.abort();let s=new AbortController;this._spriteSourceAbortController=s;let e=t?.signal;this._inputSignalEventListener&&this._startOptionsInputSignal?.removeEventListener("abort",this._inputSignalEventListener),this._startOptionsInputSignal=null,e&&(this._inputSignalEventListener=St(s),e.addEventListener("abort",this._inputSignalEventListener,{once:!0}));let{signal:i}=s,r=v(R({},t),{signal:i});this._spriteSourcePromise=this._layer.loadSpriteSource(this.devicePixelRatio,r),this._spriteSourcePromise.then(a=>{st(i),this._spriteMosaic=new U(1024,1024,250),this._spriteMosaic.setSpriteSource(a)})}updateStyle(t){return S(this,null,function*(){let s=[];for(let e of t)e.type===Q.SPRITES_CHANGED?s.push({type:Q.SPRITES_CHANGED,data:{spriteSource:null}}):s.push(e);return yield this._broadcastPromise,this._broadcastPromise=Promise.all(this._connection.broadcast("updateStyle",s)),this._broadcastPromise})}setSpriteSource(t){let s=new U(1024,1024,250);return s.setSpriteSource(t),this._spriteMosaic=s,this._spriteSourcePromise=Promise.resolve(t),this._spriteSourceAbortController=null,s}setStyle(t,s,e){return S(this,null,function*(){yield this._broadcastPromise,this._styleRepository=t,this._sourceDataMaxLOD=e,this._requestSprite();let i=new k(this._layer.currentStyleInfo.glyphsUrl?j(this._layer.currentStyleInfo.glyphsUrl,v(R({},this._layer.customParameters),{token:this._layer.apiKey})):null);return this._glyphMosaic=new T(1024,1024,i),this._broadcastPromise=Promise.all(this._connection.broadcast("setStyle",{style:s,sourceDataMaxLOD:this._sourceDataMaxLOD})),this._broadcastPromise})}fetchTileData(t,s){return S(this,null,function*(){let e=yield this._getRefKeys(t,s);return this._getSourcesData(Object.keys(this._layer.sourceNameToSource),e,s)})}fetchTilePBFs(t){return S(this,null,function*(){let s=Object.keys(this._layer.sourceNameToSource),e={},i=yield this._getRefKeys(t,e),r=[],a=[];for(let n=0;n<i.length;n++)if(i[n].value==null||s[n]==null)a.push(null);else{let h=i[n].value,o=this._getTilePayload(h,s[n],e);o.then(l=>{r.push(v(R({},l),{key:h}))}),a.push(o)}return Promise.all(a).then(()=>r)})}parseTileData(t,s){return S(this,null,function*(){let e=t&&t.data;if(!e)return null;let{sourceName2DataAndRefKey:i,transferList:r}=e;return Object.keys(i).length===0?null:this._broadcastPromise.then(()=>this._connection.invoke("createTileAndParse",{key:t.key.id,sourceName2DataAndRefKey:i,styleLayerUIDs:t.styleLayerUIDs},v(R({},s),{transferList:r})))})}getSprites(t){return S(this,null,function*(){return yield this._spriteSourcePromise,this._spriteMosaic.getSpriteItems(t)})}getGlyphs(t){return this._glyphMosaic.getGlyphItems(t.font,t.codePoints)}_getTilePayload(t,s,e){return S(this,null,function*(){let i=D.pool.acquire(t.id),r=this._layer.sourceNameToSource[s],{level:a,row:n,col:h}=i;D.pool.release(i);try{return{protobuff:yield r.requestTile(a,n,h,e),sourceName:s}}catch(o){if(rt(o))throw o;return{protobuff:null,sourceName:s}}})}_getRefKeys(t,s){return S(this,null,function*(){let e=this._layer.sourceNameToSource,i=new Array;for(let r in e){let a=e[r].getRefKey(t,s);i.push(a)}return q(i)})}_getSourcesData(t,s,e){let i=[];for(let r=0;r<s.length;r++)if(s[r].value==null||t[r]==null)i.push(null);else{let a=s[r].value,n=this._getTilePayload(a,t[r],e);i.push(n)}return q(i).then(r=>{let a={},n=[];for(let h=0;h<r.length;h++){let o=r[h].value;if(o&&o.protobuff&&o.protobuff.byteLength>0){let l=s[h].value.id;a[o.sourceName]={refKey:l,protobuff:o.protobuff},n.push(o.protobuff)}}return{sourceName2DataAndRefKey:a,transferList:n}})}};function St(d){return()=>d.abort()}var L=class{constructor(t,s){this.layerUIDs=[],this.isDestroyed=!1,this._data=t;let e=1,i=new Uint32Array(t);this.layerUIDs=[];let r=i[e++];for(let a=0;a<r;a++)this.layerUIDs[a]=i[e++];this.bufferDataOffset=e,s&&(this.layer=s.getStyleLayerByUID(this.layerUIDs[0]))}get isPreparedForRendering(){return this._data==null}get offset(){return this.bufferDataOffset}get data(){return this._data}destroy(){this.isDestroyed||(this.doDestroy(),this._data=null,this.isDestroyed=!0)}prepareForRendering(t){this._data!=null&&(this.doPrepareForRendering(t,this._data,this.bufferDataOffset),this._data=null)}},H=class extends L{constructor(t,s){super(t,s),this.type=x.LINE,this.lineIndexStart=0,this.lineIndexCount=0;let e=new Uint32Array(t),i=this.bufferDataOffset;this.lineIndexStart=e[i++],this.lineIndexCount=e[i++];let r=e[i++];if(r>0){this.patternMap=new Map;for(let a=0;a<r;a++){let n=e[i++],h=e[i++],o=e[i++];this.patternMap.set(n,[h,o])}}this.bufferDataOffset=i}get usedMemory(){return(this.data?.byteLength??0)+(this.vao?.cachedMemory??0)}hasData(){return this.lineIndexCount>0}triangleCount(){return this.lineIndexCount/3}doDestroy(){this.vao=M(this.vao)}doPrepareForRendering(t,s,e){let i=new Uint32Array(s),r=new Int32Array(i.buffer),a=i[e++],n=_.createVertex(t,g.STATIC_DRAW,new Int32Array(r.buffer,4*e,a));e+=a;let h=i[e++],o=_.createIndex(t,g.STATIC_DRAW,new Uint32Array(i.buffer,4*e,h));e+=h;let l=this.layer.lineMaterial;this.vao=new P(t,l.getAttributeLocations(),l.getLayoutInfo(),new Map([["geometry",n]]),o)}},N=class extends L{constructor(t,s){super(t,s),this.type=x.FILL,this.fillIndexStart=0,this.fillIndexCount=0,this.outlineIndexStart=0,this.outlineIndexCount=0;let e=new Uint32Array(t),i=this.bufferDataOffset;this.fillIndexStart=e[i++],this.fillIndexCount=e[i++],this.outlineIndexStart=e[i++],this.outlineIndexCount=e[i++];let r=e[i++];if(r>0){this.patternMap=new Map;for(let a=0;a<r;a++){let n=e[i++],h=e[i++],o=e[i++];this.patternMap.set(n,[h,o])}}this.bufferDataOffset=i}get usedMemory(){return(this.data?.byteLength??0)+(this.fillVAO?.cachedMemory??0)+(this.outlineVAO?.cachedMemory??0)}hasData(){return this.fillIndexCount>0||this.outlineIndexCount>0}triangleCount(){return(this.fillIndexCount+this.outlineIndexCount)/3}doDestroy(){this.fillVAO=M(this.fillVAO),this.outlineVAO=M(this.outlineVAO)}doPrepareForRendering(t,s,e){let i=new Uint32Array(s),r=new Int32Array(i.buffer),a=i[e++],n=_.createVertex(t,g.STATIC_DRAW,new Int32Array(r.buffer,4*e,a));e+=a;let h=i[e++],o=_.createIndex(t,g.STATIC_DRAW,new Uint32Array(i.buffer,4*e,h));e+=h;let l=i[e++],m=_.createVertex(t,g.STATIC_DRAW,new Int32Array(r.buffer,4*e,l));e+=l;let p=i[e++],u=_.createIndex(t,g.STATIC_DRAW,new Uint32Array(i.buffer,4*e,p));e+=p;let f=this.layer,c=f.fillMaterial,y=f.outlineMaterial;this.fillVAO=new P(t,c.getAttributeLocations(),c.getLayoutInfo(),new Map([["geometry",n]]),o),this.outlineVAO=new P(t,y.getAttributeLocations(),y.getLayoutInfo(),new Map([["geometry",m]]),u)}},G=class extends L{constructor(t,s,e){super(t,s),this.type=x.SYMBOL,this.iconPerPageElementsMap=new Map,this.glyphPerPageElementsMap=new Map,this.symbolInstances=[],this.isIconSDF=!1,this.opacityChanged=!1,this.lastOpacityUpdate=0,this.symbols=[];let i=new Uint32Array(t),r=new Int32Array(t),a=new Float32Array(t),n=this.bufferDataOffset;this.isIconSDF=!!i[n++];let h=i[n++],o=i[n++],l=i[n++],m=new D(h,o,l,0),p=i[n++];for(let y=0;y<p;y++){let b=i[n++],I=i[n++],O=i[n++];this.iconPerPageElementsMap.set(b,[I,O])}let u=i[n++];for(let y=0;y<u;y++){let b=i[n++],I=i[n++],O=i[n++];this.glyphPerPageElementsMap.set(b,[I,O])}let f=i[n++],c=i[n++];this.iconOpacity=new Int32Array(f),this.textOpacity=new Int32Array(c),n=_t(i,r,a,n,this.symbols,e,m),this.bufferDataOffset=n}get usedMemory(){return(this.data?.byteLength??0)+(this.iconVAO?.cachedMemory??0)+(this.textVAO?.cachedMemory??0)+Y(this.iconOpacity)+Y(this.textOpacity)}hasData(){return this.iconPerPageElementsMap.size>0||this.glyphPerPageElementsMap.size>0}triangleCount(){let t=0;for(let s of this.iconPerPageElementsMap.values())t+=s[1];for(let s of this.glyphPerPageElementsMap.values())t+=s[1];return t/3}doDestroy(){this.iconVAO=M(this.iconVAO),this.textVAO=M(this.textVAO)}updateOpacityInfo(){if(!this.opacityChanged)return;this.opacityChanged=!1;let t=this.iconOpacity,s=this.iconVAO.vertexBuffers.get("opacity");t.length>0&&t.byteLength===s.usedMemory&&s.setSubData(t,0,0,t.length);let e=this.textOpacity,i=this.textVAO.vertexBuffers.get("opacity");e.length>0&&e.byteLength===i.usedMemory&&i.setSubData(e,0,0,e.length)}doPrepareForRendering(t,s,e){let i=new Uint32Array(s),r=new Int32Array(i.buffer),a=i[e++],n=_.createVertex(t,g.STATIC_DRAW,new Int32Array(r.buffer,4*e,a));e+=a;let h=i[e++],o=_.createIndex(t,g.STATIC_DRAW,new Uint32Array(i.buffer,4*e,h));e+=h;let l=i[e++],m=_.createVertex(t,g.STATIC_DRAW,new Int32Array(r.buffer,4*e,l));e+=l;let p=i[e++],u=_.createIndex(t,g.STATIC_DRAW,new Uint32Array(i.buffer,4*e,p));e+=p;let f=_.createVertex(t,g.STATIC_DRAW,this.iconOpacity.buffer),c=_.createVertex(t,g.STATIC_DRAW,this.textOpacity.buffer),y=this.layer,b=y.iconMaterial,I=y.textMaterial;this.iconVAO=new P(t,b.getAttributeLocations(),b.getLayoutInfo(),new Map([["geometry",n],["opacity",f]]),o),this.textVAO=new P(t,I.getAttributeLocations(),I.getLayoutInfo(),new Map([["geometry",m],["opacity",c]]),u)}},K=class extends L{constructor(t,s){super(t,s),this.type=x.CIRCLE,this.circleIndexStart=0,this.circleIndexCount=0;let e=new Uint32Array(t),i=this.bufferDataOffset;this.circleIndexStart=e[i++],this.circleIndexCount=e[i++],this.bufferDataOffset=i}get usedMemory(){return(this.data?.byteLength??0)+(this.vao?.cachedMemory??0)}hasData(){return this.circleIndexCount>0}triangleCount(){return this.circleIndexCount/3}doDestroy(){this.vao=M(this.vao)}doPrepareForRendering(t,s,e){let i=new Uint32Array(s),r=new Int32Array(i.buffer),a=i[e++],n=_.createVertex(t,g.STATIC_DRAW,new Int32Array(r.buffer,4*e,a));e+=a;let h=i[e++],o=_.createIndex(t,g.STATIC_DRAW,new Uint32Array(i.buffer,4*e,h));e+=h;let l=this.layer.circleMaterial;this.vao=new P(t,l.getAttributeLocations(),l.getLayoutInfo(),new Map([["geometry",n]]),o)}};var xt=class d extends gt{constructor(t,s,e,i,r,a,n,h=null){super(t,s,e,i,r,a,4096,4096),this.styleRepository=n,this._memCache=h,this.type="vector-tile",this._referenced=1,this._hasSymbolBuckets=!1,this._usedMemory=256,this.layerData=new Map,this.status="loading",this.allSymbolsFadingOut=!1,this.lastOpacityUpdate=0,this.symbols=new Map,this.isCoverage=!1,this.neededForCoverage=!1,this.decluttered=!1,this.parentTile=null,this.childrenTiles=new Set,this.featureIndex=null,this.triangleCount=0,this._processed=!1,this.id=t.id}get hasSymbolBuckets(){return this._hasSymbolBuckets}get isFading(){return this._hasSymbolBuckets&&performance.now()-this.lastOpacityUpdate<200}get isHoldingForFade(){return this._hasSymbolBuckets&&(!this.allSymbolsFadingOut||performance.now()-this.lastOpacityUpdate<200)}get wasRequested(){return this.status==="errored"||this.status==="loaded"||this.status==="reloading"}setData(t){this.changeDataImpl(t),this.requestRender(),this.ready(),this._processed=!0}deleteLayerData(t){let s=!1;for(let e of t){let i=this.layerData.get(e);i&&(this._usedMemory-=i.usedMemory,i.type===x.SYMBOL&&this.symbols.delete(e)&&(s=!0),i.destroy(),this.layerData.delete(e))}this._memCache?.updateSize(this.key.id,this),s&&(this.featureIndex?.clear(),this.emit("symbols-changed")),this.requestRender()}processed(){return this._processed}hasData(){return this.layerData.size>0}hasFeatures(){let t=this.layerData.values();for(let s of t)if(s.hasData())return!0;return!1}dispose(){this.status!=="unloaded"&&(d._destroyRenderBuckets(this.layerData),this.layerData.clear(),this.featureIndex=null,this._usedMemory=0,this.destroy(),this.status="unloaded")}release(){--this._referenced==0&&(this.dispose(),this.stage=null)}retain(){++this._referenced}get cachedMemory(){return this._usedMemory}get usedMemory(){return this._usedMemory}get usedMemoryPerReference(){return this._usedMemory/(this._referenced||1)}changeDataImpl(t){this.featureIndex?.clear();let s=!1;if(t){let{bucketsWithData:e,emptyBuckets:i}=t,r=this._createRenderBuckets(e);if(i&&i.byteLength>0){let a=new Uint32Array(i);for(let n of a)this._deleteLayerData(n)}for(let[a,n]of r)this._deleteLayerData(a),n.type===x.SYMBOL&&(this.symbols.set(a,n.symbols),s=!0),this._usedMemory+=n.usedMemory,this.layerData.set(a,n);this._memCache?.updateSize(this.key.id,this)}this._hasSymbolBuckets=!1;for(let e of this.layerData.values())e.type===x.SYMBOL&&(this._hasSymbolBuckets=!0);s&&this.emit("symbols-changed")}attachWithContext(t){this.stage={context:t,trashDisplayObject(s){s.processDetach()},untrashDisplayObject:()=>!1}}setTransform(t){super.setTransform(t);let s=this.resolution/(t.resolution*t.pixelRatio),e=this.width/this.rangeX*s,i=this.height/this.rangeY*s,r=[0,0];t.toScreen(r,[this.x,this.y]);let a=this.transforms.tileUnitsToPixels;ht(a),lt(a,a,r),ct(a,a,Math.PI*t.rotation/180),ut(a,a,[e,i,1])}_createTransforms(){return{displayViewScreenMat3:F(),tileMat3:F(),tileUnitsToPixels:F()}}static _destroyRenderBuckets(t){if(!t)return;let s=new Set;for(let e of t.values())s.has(e)||(e.destroy(),s.add(e));t.clear()}_createRenderBuckets(t){let s=new Map,e=new Map;for(let i of t){let r=this._deserializeBucket(i,e);for(let a of r.layerUIDs)s.set(a,r)}return s}_deserializeBucket(t,s){let e=s.get(t);if(e)return e;switch(new Uint32Array(t)[0]){case x.FILL:e=new N(t,this.styleRepository);break;case x.LINE:e=new H(t,this.styleRepository);break;case x.SYMBOL:e=new G(t,this.styleRepository,this);break;case x.CIRCLE:e=new K(t,this.styleRepository)}return s.set(t,e),e}_deleteLayerData(t){if(!this.layerData.has(t))return;let s=this.layerData.get(t);this._usedMemory-=s.usedMemory,s.destroy(),this.layerData.delete(t)}};var bt=class extends dt{constructor(){super(...arguments),this._fullCacheLodInfos=null,this._levelByScale={}}getTileParentId(t){let s=D.pool.acquire(t),e=s.level===0?null:D.getId(s.level-1,s.row>>1,s.col>>1,s.world);return D.pool.release(s),e}getTileCoverage(t,s,e=!0,i){let r=super.getTileCoverage(t,s,e,i);if(!r)return r;let a=1<<r.lodInfo.level;return r.spans=r.spans.filter(n=>n.row>=0&&n.row<a),r}scaleToLevel(t){if(this._fullCacheLodInfos||this._initializeFullCacheLODs(this._lodInfos),this._levelByScale[t])return this._levelByScale[t];{let s=this._fullCacheLodInfos;if(t>s[0].scale)return s[0].level;let e,i;for(let r=0;r<s.length-1;r++)if(i=s[r+1],t>i.scale)return e=s[r],e.level+(e.scale-t)/(e.scale-i.scale);return s[s.length-1].level}}_initializeFullCacheLODs(t){let s;if(t[0].level===0)s=t.map(e=>({level:e.level,resolution:e.resolution,scale:e.scale}));else{let e=this.tileInfo.size[0],i=this.tileInfo.spatialReference;s=nt.create({size:e,spatialReference:i}).lods.map(r=>({level:r.level,resolution:r.resolution,scale:r.scale}))}for(let e=0;e<s.length;e++)this._levelByScale[s[e].scale]=s[e].level;this._fullCacheLodInfos=s}};export{mt as a,xt as b,bt as c};
