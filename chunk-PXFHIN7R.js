import{b as et}from"./chunk-FLXA3YE2.js";import{a as tt}from"./chunk-4TIUXNXO.js";import{a as Z,b as $}from"./chunk-CX3G2QWN.js";import{c as Q,d as z,h as G}from"./chunk-JLWYDAJB.js";import{a as K,b as J}from"./chunk-37H4LYIE.js";import{D as R,E as Y,F as W}from"./chunk-X7BNFUFQ.js";import{b as V,h as O,i as w,k as C,r as X}from"./chunk-HM5RIVQC.js";import{e as q}from"./chunk-EQZWYK27.js";var b=class{constructor(){this.name=this.constructor.name||"UnnamedBrush",this.brushEffect=null}prepareState(i,e){}draw(i,e,t){}drawMany(i,e,t){for(let r of e)r.visible&&this.draw(i,r,t)}};var at=class extends b{constructor(){super(...arguments),this._color=et(1,0,0,1),this._patternMatrix=tt(),this._programOptions={id:!1,pattern:!1}}dispose(){this._vao&&(this._vao.dispose(),this._vao=null)}drawMany(i,e){let{context:t,painter:r,requestRender:l,allowDelayedRender:y}=i;this._loadWGLResources(i);let f=i.displayLevel,o=i.styleLayer,v=o.backgroundMaterial,p=r.vectorTilesMaterialManager,P=o.getPaintValue("background-color",f),m=o.getPaintValue("background-opacity",f),S=o.getPaintValue("background-pattern",f),g=S!==void 0,x=1|window.devicePixelRatio,M=i.spriteMosaic,E,U,u=x>W?2:1,_=this._programOptions;_.pattern=g;let n=p.getMaterialProgram(t,v,_);if(!y||l==null||n.compiled){if(t.bindVAO(this._vao),t.useProgram(n),g){let a=M.getMosaicItemPosition(S,!0);if(a!=null){let{tl:c,br:d,page:s}=a;E=d[0]-c[0],U=d[1]-c[1];let I=M.getPageSize(s);I!=null&&(M.bind(t,C.LINEAR,s,R),n.setUniform4f("u_tlbr",c[0],c[1],d[0],d[1]),n.setUniform2fv("u_mosaicSize",I),n.setUniform1i("u_texture",R))}n.setUniform1f("u_opacity",m)}else{let a=P[3]*m;this._color[0]=a*P[0],this._color[1]=a*P[1],this._color[2]=a*P[2],this._color[3]=a,n.setUniform4fv("u_color",this._color)}n.setUniform1f("u_depth",o.z||0);for(let a of e){if(n.setUniform1f("u_coord_range",a.rangeX),n.setUniformMatrix3fv("u_dvsMat3",a.transforms.displayViewScreenMat3),g){let c=Math.max(2**(Math.round(f)-a.key.level),1),d=u*a.width*c,s=d/q(E),I=d/q(U);this._patternMatrix[0]=s,this._patternMatrix[4]=I,n.setUniformMatrix3fv("u_pattern_matrix",this._patternMatrix)}t.setStencilFunction(w.EQUAL,0,255),t.drawArrays(V.TRIANGLE_STRIP,0,4)}}else l()}_loadWGLResources(i){if(this._vao)return;let{context:e,styleLayer:t}=i,r=t.backgroundMaterial,l=new Int8Array([0,0,1,0,0,1,1,1]),y=Z.createVertex(e,X.STATIC_DRAW,l),f=new $(e,r.getAttributeLocations(),r.getLayoutInfo(),new Map([["geometry",y]]));this._vao=f}};var it=class extends b{constructor(){super(...arguments),this._programOptions={id:!1}}dispose(){}drawMany(i,e){let{context:t,displayLevel:r,requiredLevel:l,state:y,painter:f,spriteMosaic:o,styleLayerUID:v,requestRender:p,allowDelayedRender:P}=i;if(!e.some(n=>n.layerData.get(v)?.circleIndexCount??!1))return;let m=i.styleLayer,S=m.circleMaterial,g=f.vectorTilesMaterialManager,x=1.2,M=m.getPaintValue("circle-translate",r),E=m.getPaintValue("circle-translate-anchor",r),U=this._programOptions,u=g.getMaterialProgram(t,S,U);if(P&&p!=null&&!u.compiled)return void p();t.useProgram(u),u.setUniformMatrix3fv("u_displayMat3",E===G.VIEWPORT?y.displayMat3:y.displayViewMat3),u.setUniform2fv("u_circleTranslation",M),u.setUniform1f("u_depth",m.z),u.setUniform1f("u_antialiasingWidth",x);let _=-1;for(let n of e){if(!n.layerData.has(v))continue;n.key.level!==_&&(_=n.key.level,S.setDataUniforms(u,r,m,_,o));let a=n.layerData.get(v);if(!a.circleIndexCount)continue;a.prepareForRendering(t);let c=a.vao;c!=null&&(t.bindVAO(c),u.setUniformMatrix3fv("u_dvsMat3",n.transforms.displayViewScreenMat3),l!==n.key.level?t.setStencilFunction(w.EQUAL,n.stencilRef,255):t.setStencilFunction(w.GREATER,255,255),t.drawElements(V.TRIANGLES,a.circleIndexCount,O.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*a.circleIndexStart),n.triangleCount+=a.circleIndexCount/3)}}};var rt=1/65536,nt=class extends b{constructor(){super(...arguments),this._fillProgramOptions={id:!1,pattern:!1},this._outlineProgramOptions={id:!1}}dispose(){}drawMany(i,e){let{displayLevel:t,renderPass:r,spriteMosaic:l,styleLayerUID:y}=i,f=!1;for(let u of e)if(u.layerData.has(y)){let _=u.layerData.get(y);if(_.fillIndexCount>0||_.outlineIndexCount>0){f=!0;break}}if(!f)return;let o=i.styleLayer,v=o.getPaintProperty("fill-pattern"),p=v!==void 0,P=p&&v.isDataDriven,m;if(p&&!P){let u=v.getValue(t);m=l.getMosaicItemPosition(u,!0)}let S=!p&&o.getPaintValue("fill-antialias",t),g=!0,x=1;if(!p){let u=o.getPaintProperty("fill-color"),_=o.getPaintProperty("fill-opacity");if(!u?.isDataDriven&&!_?.isDataDriven){let n=o.getPaintValue("fill-color",t);x=o.getPaintValue("fill-opacity",t)*n[3],x>=1&&(g=!1)}}if(g&&r==="opaque")return;let M=o.getPaintValue("fill-translate",t),E=o.getPaintValue("fill-translate-anchor",t);(g||r!=="translucent")&&this._drawFill(i,y,o,e,M,E,p,m,P);let U=!o.hasDataDrivenOutlineColor&&o.outlineUsesFillColor&&x<1;S&&r!=="opaque"&&!U&&this._drawOutline(i,y,o,e,M,E)}_drawFill(i,e,t,r,l,y,f,o,v){if(f&&!v&&o==null)return;let{context:p,displayLevel:P,state:m,painter:S,pixelRatio:g,spriteMosaic:x,requestRender:M,allowDelayedRender:E}=i,U=t.fillMaterial,u=S.vectorTilesMaterialManager,_=g>W?2:1,n=this._fillProgramOptions;n.pattern=f;let a=u.getMaterialProgram(p,U,n);if(E&&M!=null&&!a.compiled)return void M();if(p.useProgram(a),o!=null){let{page:d}=o,s=x.getPageSize(d);s!=null&&(x.bind(p,C.LINEAR,d,R),a.setUniform2fv("u_mosaicSize",s),a.setUniform1i("u_texture",R))}a.setUniformMatrix3fv("u_displayMat3",y===G.VIEWPORT?m.displayMat3:m.displayViewMat3),a.setUniform2fv("u_fillTranslation",l),a.setUniform1f("u_depth",t.z+rt);let c=-1;for(let d of r){if(!d.layerData.has(e))continue;d.key.level!==c&&(c=d.key.level,U.setDataUniforms(a,P,t,c,x));let s=d.layerData.get(e);if(!s.fillIndexCount)continue;s.prepareForRendering(p);let I=s.fillVAO;if(I!=null){if(p.bindVAO(I),a.setUniformMatrix3fv("u_dvsMat3",d.transforms.displayViewScreenMat3),p.setStencilFunction(w.EQUAL,d.stencilRef,255),f){let h=Math.max(2**(Math.round(P)-d.key.level),1),D=d.rangeX/(_*d.width*h);a.setUniform1f("u_patternFactor",D)}if(v){let h=s.patternMap;if(!h)continue;for(let[D,L]of h){let k=x.getPageSize(D);k!=null&&(x.bind(p,C.LINEAR,D,R),a.setUniform2fv("u_mosaicSize",k),a.setUniform1i("u_texture",R),p.drawElements(V.TRIANGLES,L[1],O.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*L[0]))}}else p.drawElements(V.TRIANGLES,s.fillIndexCount,O.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*s.fillIndexStart);d.triangleCount+=s.fillIndexCount/3}}}_drawOutline(i,e,t,r,l,y){let{context:f,displayLevel:o,state:v,painter:p,pixelRatio:P,spriteMosaic:m,requestRender:S,allowDelayedRender:g}=i,x=t.outlineMaterial,M=p.vectorTilesMaterialManager,E=.75/P,U=this._outlineProgramOptions,u=M.getMaterialProgram(f,x,U);if(g&&S!=null&&!u.compiled)return void S();f.useProgram(u),u.setUniformMatrix3fv("u_displayMat3",y===G.VIEWPORT?v.displayMat3:v.displayViewMat3),u.setUniform2fv("u_fillTranslation",l),u.setUniform1f("u_depth",t.z+rt),u.setUniform1f("u_outline_width",E);let _=-1;for(let n of r){if(!n.layerData.has(e))continue;n.key.level!==_&&(_=n.key.level,x.setDataUniforms(u,o,t,_,m));let a=n.layerData.get(e);if(a.prepareForRendering(f),!a.outlineIndexCount)continue;let c=a.outlineVAO;c!=null&&(f.bindVAO(c),u.setUniformMatrix3fv("u_dvsMat3",n.transforms.displayViewScreenMat3),f.setStencilFunction(w.EQUAL,n.stencilRef,255),f.drawElements(V.TRIANGLES,a.outlineIndexCount,O.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*a.outlineIndexStart),n.triangleCount+=a.outlineIndexCount/3)}}};var ot=class extends b{constructor(){super(...arguments),this._programOptions={id:!1,pattern:!1,sdf:!1}}dispose(){}drawMany(i,e){let{context:t,displayLevel:r,state:l,painter:y,pixelRatio:f,spriteMosaic:o,styleLayerUID:v,requestRender:p,allowDelayedRender:P}=i;if(!e.some(h=>h.layerData.get(v)?.lineIndexCount??!1))return;let m=i.styleLayer,S=m.lineMaterial,g=y.vectorTilesMaterialManager,x=m.getPaintValue("line-translate",r),M=m.getPaintValue("line-translate-anchor",r),E=m.getPaintProperty("line-pattern"),U=E!==void 0,u=U&&E.isDataDriven,_,n;if(U&&!u){let h=E.getValue(r);_=o.getMosaicItemPosition(h)}let a=!1;if(!U){let h=m.getPaintProperty("line-dasharray");if(n=h!==void 0,a=n&&h.isDataDriven,n&&!a){let D=h.getValue(r),L=m.getDashKey(D,m.getLayoutValue("line-cap",r));_=o.getMosaicItemPosition(L)}}let c=1/f,d=this._programOptions;d.pattern=U,d.sdf=n;let s=g.getMaterialProgram(t,S,d);if(P&&p!=null&&!s.compiled)return void p();if(t.useProgram(s),s.setUniformMatrix3fv("u_displayViewMat3",l.displayViewMat3),s.setUniformMatrix3fv("u_displayMat3",M===G.VIEWPORT?l.displayMat3:l.displayViewMat3),s.setUniform2fv("u_lineTranslation",x),s.setUniform1f("u_depth",m.z),s.setUniform1f("u_antialiasing",c),_&&_!=null){let{page:h}=_,D=o.getPageSize(h);D!=null&&(o.bind(t,C.LINEAR,h,R),s.setUniform2fv("u_mosaicSize",D),s.setUniform1i("u_texture",R))}let I=-1;for(let h of e){if(!h.layerData.has(v))continue;h.key.level!==I&&(I=h.key.level,S.setDataUniforms(s,r,m,I,o));let D=2**(r-I)/f;s.setUniform1f("u_zoomFactor",D);let L=h.layerData.get(v);if(!L.lineIndexCount)continue;L.prepareForRendering(t);let k=L.vao;if(k!=null){if(t.bindVAO(k),s.setUniformMatrix3fv("u_dvsMat3",h.transforms.displayViewScreenMat3),t.setStencilFunction(w.EQUAL,h.stencilRef,255),u||a){let B=L.patternMap;if(!B)continue;for(let[T,F]of B){let N=o.getPageSize(T);N!=null&&(o.bind(t,C.LINEAR,T,R),s.setUniform2fv("u_mosaicSize",N),s.setUniform1i("u_texture",R),t.drawElements(V.TRIANGLES,F[1],O.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*F[0]))}}else t.drawElements(V.TRIANGLES,L.lineIndexCount,O.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*L.lineIndexStart);h.triangleCount+=L.lineIndexCount/3}}}};var kt=128/Math.PI,pt=256/360,mt=1/Math.LN2;function dt(A,i){return(A%=i)>=0?A:A+i}function j(A){return dt(A*pt,256)}function Ft(A){return Math.log(A)*mt}var gt=1/65536,lt=class extends b{constructor(){super(...arguments),this._iconProgramOptions={id:!1,sdf:!1},this._sdfProgramOptions={id:!1},this._spritesTextureSize=K()}dispose(){}drawMany(i,e){let t=i.styleLayer;this._drawIcons(i,t,e),this._drawText(i,t,e)}_drawIcons(i,e,t){let{context:r,displayLevel:l,painter:y,spriteMosaic:f,state:o,styleLayerUID:v,requestRender:p,allowDelayedRender:P}=i,m=e.iconMaterial,S=y.vectorTilesMaterialManager,g,x=!1;for(let s of t)if(s.layerData.has(v)&&(g=s.layerData.get(v),g.iconPerPageElementsMap.size>0)){x=!0;break}if(!x)return;let M=e.getPaintValue("icon-translate",l),E=e.getPaintValue("icon-translate-anchor",l),U=e.getLayoutValue("icon-rotation-alignment",l);U===z.AUTO&&(U=e.getLayoutValue("symbol-placement",l)===Q.POINT?z.VIEWPORT:z.MAP);let u=U===z.MAP,_=e.getLayoutValue("icon-keep-upright",l)&&u,n=g.isIconSDF,a=this._iconProgramOptions;a.sdf=n;let c=S.getMaterialProgram(r,m,a);if(P&&p!=null&&!c.compiled)return void p();r.useProgram(c),c.setUniformMatrix3fv("u_displayViewMat3",U===z.MAP?o.displayViewMat3:o.displayMat3),c.setUniformMatrix3fv("u_displayMat3",E===G.VIEWPORT?o.displayMat3:o.displayViewMat3),c.setUniform2fv("u_iconTranslation",M),c.setUniform1f("u_depth",e.z),c.setUniform1f("u_mapRotation",j(o.rotation)),c.setUniform1f("u_keepUpright",_?1:0),c.setUniform1f("u_level",10*l),c.setUniform1i("u_texture",R),c.setUniform1f("u_fadeDuration",200/1e3);let d=-1;for(let s of t){if(!s.layerData.has(v)||(s.key.level!==d&&(d=s.key.level,m.setDataUniforms(c,l,e,d,f)),g=s.layerData.get(v),g.iconPerPageElementsMap.size===0))continue;g.prepareForRendering(r),g.updateOpacityInfo();let I=g.iconVAO;if(I!=null){r.bindVAO(I),c.setUniformMatrix3fv("u_dvsMat3",s.transforms.displayViewScreenMat3),c.setUniform1f("u_time",(performance.now()-g.lastOpacityUpdate)/1e3);for(let[h,D]of g.iconPerPageElementsMap)this._renderIconRange(i,c,D,h,s)}}}_renderIconRange(i,e,t,r,l){let{context:y,spriteMosaic:f}=i;this._spritesTextureSize[0]=f.getWidth(r)/4,this._spritesTextureSize[1]=f.getHeight(r)/4,e.setUniform2fv("u_mosaicSize",this._spritesTextureSize),f.bind(y,C.LINEAR,r,R),this._setStencilState(i,l),y.drawElements(V.TRIANGLES,t[1],O.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*t[0]),l.triangleCount+=t[1]/3}_drawText(i,e,t){let{context:r,displayLevel:l,glyphMosaic:y,painter:f,pixelRatio:o,spriteMosaic:v,state:p,styleLayerUID:P,requestRender:m,allowDelayedRender:S}=i,g=e.textMaterial,x=f.vectorTilesMaterialManager,M,E=!1;for(let N of t)if(N.layerData.has(P)&&(M=N.layerData.get(P),M.glyphPerPageElementsMap.size>0)){E=!0;break}if(!E)return;let U=e.getPaintProperty("text-opacity");if(U&&!U.isDataDriven&&U.getValue(l)===0)return;let u=e.getPaintProperty("text-color"),_=!u||u.isDataDriven||u.getValue(l)[3]>0,n=e.getPaintProperty("text-halo-width"),a=e.getPaintProperty("text-halo-color"),c=(!n||n.isDataDriven||n.getValue(l)>0)&&(!a||a.isDataDriven||a.getValue(l)[3]>0);if(!_&&!c)return;let d=24/8,s=e.getLayoutValue("text-rotation-alignment",l);s===z.AUTO&&(s=e.getLayoutValue("symbol-placement",l)===Q.POINT?z.VIEWPORT:z.MAP);let I=s===z.MAP,h=e.getLayoutValue("text-keep-upright",l)&&I,D=.8*d/o;this._glyphTextureSize||(this._glyphTextureSize=J(y.width/4,y.height/4));let L=e.getPaintValue("text-translate",l),k=e.getPaintValue("text-translate-anchor",l),B=this._sdfProgramOptions,T=x.getMaterialProgram(r,g,B);if(S&&m!=null&&!T.compiled)return void m();r.useProgram(T),T.setUniformMatrix3fv("u_displayViewMat3",s===z.MAP?p.displayViewMat3:p.displayMat3),T.setUniformMatrix3fv("u_displayMat3",k===G.VIEWPORT?p.displayMat3:p.displayViewMat3),T.setUniform2fv("u_textTranslation",L),T.setUniform1f("u_depth",e.z+gt),T.setUniform2fv("u_mosaicSize",this._glyphTextureSize),T.setUniform1f("u_mapRotation",j(p.rotation)),T.setUniform1f("u_keepUpright",h?1:0),T.setUniform1f("u_level",10*l),T.setUniform1i("u_texture",Y),T.setUniform1f("u_antialiasingWidth",D),T.setUniform1f("u_fadeDuration",200/1e3);let F=-1;for(let N of t){if(!N.layerData.has(P)||(N.key.level!==F&&(F=N.key.level,g.setDataUniforms(T,l,e,F,v)),M=N.layerData.get(P),M.glyphPerPageElementsMap.size===0))continue;M.prepareForRendering(r),M.updateOpacityInfo();let H=M.textVAO;if(H==null)continue;r.bindVAO(H),T.setUniformMatrix3fv("u_dvsMat3",N.transforms.displayViewScreenMat3),this._setStencilState(i,N);let ut=(performance.now()-M.lastOpacityUpdate)/1e3;T.setUniform1f("u_time",ut),M.glyphPerPageElementsMap.forEach((ct,ft)=>{this._renderGlyphRange(r,ct,ft,y,T,c,_,N)})}}_renderGlyphRange(i,e,t,r,l,y,f,o){r.bind(i,C.LINEAR,t,Y),y&&(l.setUniform1f("u_halo",1),i.drawElements(V.TRIANGLES,e[1],O.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*e[0]),o.triangleCount+=e[1]/3),f&&(l.setUniform1f("u_halo",0),i.drawElements(V.TRIANGLES,e[1],O.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*e[0]),o.triangleCount+=e[1]/3)}_setStencilState(i,e){let{context:t,is3D:r,stencilSymbols:l}=i;if(t.setStencilTestEnabled(!0),l)return t.setStencilWriteMask(255),void t.setStencilFunction(w.ALWAYS,e.stencilRef,255);t.setStencilWriteMask(0),r?t.setStencilFunction(w.EQUAL,e.stencilRef,255):t.setStencilFunction(w.GREATER,255,255)}};export{b as a,at as b,it as c,nt as d,ot as e,Ft as f,lt as g};
