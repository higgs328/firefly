import{a as q}from"./chunk-2VMZZJFA.js";import{a as R}from"./chunk-QOSJTJHZ.js";import{c as G}from"./chunk-7NTCDIVV.js";import{b as I,g as b,h as D}from"./chunk-XR5FT7TQ.js";import{a as j}from"./chunk-JQAW4OB5.js";import{a as U}from"./chunk-DKGGDYJI.js";import{a as N}from"./chunk-IR6XCBC4.js";import{a as P}from"./chunk-GHKL3NOH.js";import{a as O}from"./chunk-4N4D2YQX.js";import{b as C}from"./chunk-AUAZP44J.js";import{d as M}from"./chunk-KNVXE32P.js";import{z as A}from"./chunk-76ATOSLU.js";import{a as _,e as V}from"./chunk-TG45K3WR.js";import{b as m}from"./chunk-ACP3S2CH.js";import{a as H}from"./chunk-T7DXJKX7.js";import{a}from"./chunk-QGVBCWUY.js";import{H as F,s as x}from"./chunk-MYO4NP2N.js";import{e as c}from"./chunk-NFIPKH6V.js";import{l as S}from"./chunk-5QEXLALV.js";import{c as w}from"./chunk-P6QFA5MM.js";import{K as L,p as g}from"./chunk-4PTIEWMT.js";import{b as f}from"./chunk-YOFFGXOB.js";import{g as h}from"./chunk-XRGPJ3QY.js";import{f as d}from"./chunk-VTHXE323.js";function $(e){return e.type==="feature"}function z(e){return e.type==="group"}function J(e){return e.type==="preset"}var l=class extends F{constructor(e){super(e),this.layers=new m,this.lockType="none",this.tables=new m,this.versionInfo=null,this.versionService=null}get layersAndTables(){return new m([...this.layers.toArray(),...this.tables.toArray()])}updateLockType(){this.lockType=this.versionInfo?this.versionService.getLockType(this.versionInfo.versionIdentifier)??"none":"none"}get featureServiceVersion(){return this.featureService.sourceJSON?.currentVersion??0}};a([c({constructOnly:!0})],l.prototype,"canCreateVersion",void 0),a([c({constructOnly:!0})],l.prototype,"canEditVersionedData",void 0),a([c({constructOnly:!0})],l.prototype,"featureService",void 0),a([c({constructOnly:!0})],l.prototype,"layers",void 0),a([c()],l.prototype,"layersAndTables",null),a([c()],l.prototype,"lockType",void 0),a([c({constructOnly:!0})],l.prototype,"tables",void 0),a([c()],l.prototype,"versionInfo",void 0),a([c({constructOnly:!0})],l.prototype,"versionService",void 0),a([c()],l.prototype,"hasAdvancedEditingUserTypeExtension",void 0),a([c()],l.prototype,"loggedInServiceUser",void 0),a([c()],l.prototype,"featureServiceVersion",null),l=a([S("esri.undoredo.support.ServiceVersionInfo")],l);function Z(e){return!e||e.trim().length===0}var W=new Map;function B(e){return w(W,e,()=>{let r=new y({view:e});return e.addHandles({remove(){W.delete(e),r.destroy()}}),r.load().catch(t=>{h.getLogger("esri.views.Services").error("Failed to load service metadata",t)}),r})}var y=class extends N.LoadableMixin(O.EsriPromiseMixin(H.EventedAccessor)){constructor(e){super(e),this._updatingHandles=new j,this.items=new m,this.tablesAndLayersLookup=new P,this.additionalLayers=new m,this._debouncedCheckAndUpdateServiceInfos=L(()=>d(this,null,function*(){let r=[];for(let t of this.items){if(t.layersAndTables.length===0)continue;t.layersAndTables.getItemAt(0)?.gdbVersion!==t.versionInfo?.versionIdentifier.name&&r.push(t)}r.length!==0&&(yield V(()=>!this.updating),yield this._updateVersionInfos(r))})),this._debouncedLayersChanged=L(()=>d(this,null,function*(){let r=this._detectNewLayersAndTables();r.length!==0&&(yield V(()=>!this._updatingHandles.updating),yield this._updatingHandles.addPromise(d(this,null,function*(){let t=new Set;for(let i of r)if(i.type==="feature"||i.type==="subtype-group"){if(!i.url)continue;let n=C(i.url).url.path,o=this._findServiceInfo(n);if(o)this.tablesAndLayersLookup.set(i,o),i.isTable?o.tables.push(i):o.layers.push(i);else if(!t.has(n))try{yield this._addServiceInfo(n,i)}catch(p){h.getLogger(this).error(`Failed to load feature service: ${n}`,p)}finally{t.add(n)}}})))})),this._processed=new Set}destroy(){this._set("view",null),this.items.removeAll(),this.tablesAndLayersLookup.clear()}load(e){return d(this,null,function*(){return g(e),this.addHandles([_(()=>this._allLayersAndTables,()=>{this._debouncedLayersChanged().catch(r=>{h.getLogger(this).warn("Failed to update service info",r)})}),_(()=>this.items.map(r=>r.layersAndTables.map(t=>t.gdbVersion??"").join(",")),()=>{this.checkAndUpdateServiceInfos().catch(r=>{h.getLogger(this).warn("Failed to update service info",r)})})]),this.addResolvingPromise(this._debouncedLayersChanged()),this})}get updating(){return this.loadStatus==="loading"||this._updatingHandles.updating}checkAndUpdateServiceInfos(){return this._debouncedCheckAndUpdateServiceInfos()}changeVersion(e,r,t){return this._updatingHandles.addPromise(d(this,null,function*(){yield this._changeVersionInternal(e,r,t)}))}createVersion(e){return this._updatingHandles.addPromise(d(this,null,function*(){let r=e.featureServerUrl,t=this._findServiceInfo(r);if(!t?.versionService)throw new f("services:no-version-management-service");let i=t.hasAdvancedEditingUserTypeExtension,n=t.loggedInServiceUser.toUpperCase(),o=Z(e.ownerName)?n:e.ownerName?.trim().toUpperCase();if(o!==n){if(t.featureServiceVersion<=11.1)throw new f("services:versioning-api-error");if(!i)throw new f("services:no-advanced-editing-user-type-extension")}if(o?.toUpperCase()==="SDE"&&e.versionName.toUpperCase()==="DEFAULT")throw new f("services:no-valid-version-name");if((yield t.versionService.getVersionInfos())?.find(u=>u.versionIdentifier.name.toUpperCase()===(o+"."+e.versionName).toUpperCase()||u.versionIdentifier.name.toUpperCase()===(n+"."+e.versionName).toUpperCase()))throw new f("services:no-valid-version-name");let p=yield t.versionService.createVersion({versionName:e.versionName,access:o!==n?"public":e.access,description:e.description});if(o!==n){let{guid:s,name:u}=p.versionIdentifier;yield t.versionService.alterVersion({guid:s,name:u},{ownerName:o,access:e.access})}e.switchToVersion&&(yield this._changeVersionInternal(r,p.versionIdentifier.name,p.versionIdentifier.guid)),this.emit("version-created",{versionIdentifier:p.versionIdentifier,versionManagementService:t.versionService})}))}deleteVersion(e,r,t){return this._updatingHandles.addPromise(d(this,null,function*(){let i=this._findServiceInfo(e);if(!i?.versionService)throw new f("services:no-version-management-service");if(i.featureServiceVersion<=11.1)throw new f("services:versioning-api-error");if(!i.hasAdvancedEditingUserTypeExtension)throw new f("services:no-advanced-editing-user-type-extension");let n={name:r,guid:t};(yield i.versionService.deleteVersion(n))&&(yield this._updateVersionInfo(i),this.emit("version-deleted",{versionIdentifier:n,versionManagementService:i.versionService}))}))}startEditing(e){return this._updatingHandles.addPromise(d(this,null,function*(){let r=this._findServiceInfo(e);if(!r?.versionService)throw new f("services:no-version-management-service");if(!r.hasAdvancedEditingUserTypeExtension)throw new f("services:no-advanced-editing-user-type-extension");let t=r.versionInfo?.versionIdentifier??{name:r.versionService.defaultVersionIdentifier.name,guid:r.versionService.defaultVersionIdentifier.guid},i=!0;(r.versionService.getLockType(t)!=="none"||(i=yield r.versionService.startReading(t),i))&&(i=yield r.versionService.startEditing(t),r.updateLockType())}))}finishEditing(e,r){return this._updatingHandles.addPromise(d(this,null,function*(){let t=this._findServiceInfo(e);if(!t?.versionService)throw new f("services:no-version-management-service");if(!t.hasAdvancedEditingUserTypeExtension)throw new f("services:no-advanced-editing-user-type-extension");let i=t.versionInfo?.versionIdentifier??{name:t.versionService.defaultVersionIdentifier.name,guid:t.versionService.defaultVersionIdentifier.guid},n=t.versionService.getLockType(i);if(n!=="none")return n==="read"?(yield t.versionService.stopReading(i),void t.updateLockType()):n==="edit"?(yield t.versionService.stopEditing(i,r),yield t.versionService.stopReading(i),void t.updateLockType()):void 0}))}_changeVersionInternal(e,r,t){return d(this,null,function*(){let i=this._findServiceInfo(e);if(!i?.versionService)throw new f("services:no-version-management-service");let n=i.versionInfo?.versionIdentifier??{name:i.versionService.defaultVersionIdentifier.name,guid:i.versionService.defaultVersionIdentifier.guid},o={name:r,guid:t};(yield i.versionService.changeVersion(this.view?.map,n,o))&&(yield this._updateVersionInfo(i))})}_updateVersionInfo(e){return d(this,null,function*(){let r=e.versionService;if(!r||e.layersAndTables.length===0)return;let t=e.layersAndTables.getItemAt(0)?.gdbVersion,i=t?yield r.getVersionIdentifierFromName(t):r.defaultVersionIdentifier;e.versionInfo=yield r.getVersionInfoExtended(i)})}_findServiceInfo(e){return this.items.find(r=>r.featureService.url===e)??null}_removeFeatureService(e){this.items.remove(e)}_findPortal(e){return d(this,null,function*(){let r=M?.findServerInfo(e??"");if(!r?.owningSystemUrl)return null;let t=`${r.owningSystemUrl}/sharing/rest`,i=U.getDefault();return i?.loaded&&A(i.restUrl)===A(t)?i:new U({authMode:"immediate",url:r.owningSystemUrl}).load()})}_updateVersionInfos(e){return this._updatingHandles.addPromise(d(this,null,function*(){for(let r of e)yield this._updateVersionInfo(r).catch(t=>{h.getLogger(this).error("Failed to update version details",t)})}))}_addServiceInfo(e,r){return d(this,null,function*(){let t=new R({url:e});yield t.load();let i=yield this._findPortal(e),n=i?.user?.username,o=!1;n&&(o=yield G(i,n,"advediting"));let p=null;t.versionManagementServiceUrl&&(p=new q({url:t.versionManagementServiceUrl}),yield p.load());let s=r.isTable?[]:[r],u=r.isTable?[r]:[],v=new l({loggedInServiceUser:n??"",hasAdvancedEditingUserTypeExtension:o,versionInfo:null,lockType:"none",canEditVersionedData:!0,canCreateVersion:!0,featureService:t,versionService:p,layers:new m(s),tables:new m(u)});return p&&(yield this._updateVersionInfo(v)),this.items.push(v),this.tablesAndLayersLookup.set(r,v),r.isTable?v.tables.push(r):v.layers.push(r),v})}get _allLayersAndTables(){return[...this.view.map.allLayers,...this.view.map.allTables,...this.additionalLayers]}_detectNewLayersAndTables(){let e=new Set(this._allLayersAndTables),r=[];for(let t of e)t.type!=="feature"&&t.type!=="subtype-group"||this._processed.has(t)||r.push(t);for(let t of this._processed)if(!e.has(t)&&(b(t)||I(t))){let i=this.tablesAndLayersLookup.get(t);if(!i)continue;this.tablesAndLayersLookup.delete(t),t.isTable?i.tables.remove(t):i.layers.remove(t),i.layersAndTables.length===0&&this._removeFeatureService(i)}return this._processed=e,r}};a([c({constructOnly:!0})],y.prototype,"view",void 0),a([c()],y.prototype,"items",void 0),a([c()],y.prototype,"tablesAndLayersLookup",void 0),a([c()],y.prototype,"additionalLayers",void 0),a([c()],y.prototype,"updating",null),a([c()],y.prototype,"_allLayersAndTables",null),y=a([S("esri.undoredo.support.Services")],y);var ee=()=>h.getLogger("esri.editing.templateUtils");function Ye(e){return e!=null&&"prototype"in e}function Ze(e){return Q(e)&&!("definition"in e)}function T(e){return Q(e)&&"definition"in e}function Q(e){return e!=null&&"templateId"in e}function er(e){return T(e)&&e?.type==="feature"&&(e.definition==null||$(e.definition))}function rr(e){return T(e)&&e?.type==="group"&&(e.definition==null||z(e.definition))}function tr(e){return T(e)&&e?.type==="preset"&&(e.definition==null||J(e.definition))}function ir(e){return T(e)&&e?.definition!=null}var K=e=>e==null||typeof e!="object"?[]:[..."templates"in e&&Array.isArray(e.templates)?e.templates:[],..."types"in e&&Array.isArray(e.types)?e.types.flatMap(r=>r.templates):[]];function nr(e,r,t){return d(this,null,function*(){if(r==null)return e.map(s=>({layer:s,templates:K(s)}));let i=yield ie(e,r);g(t);let n=new Map,o=Array.from(i).map(s=>re({serviceInfo:s,out:n,signal:t,view:r})),p=yield Promise.allSettled(o);for(let s of p.filter(u=>u.status==="rejected"))ee().warn("Failed to fetch shared templates for service. Will use standard templates if available.",s.reason);return e.map(s=>({layer:s,templates:n.get(s)??K(s)}))})}function re(i){return d(this,arguments,function*({serviceInfo:e,out:r,signal:t}){let{featureService:n,layersAndTables:o}=e,p=yield te({featureService:n,layers:o.toArray(),signal:t});g(t);for(let[s,u]of p.entries())if(u.length!==0)if(b(s)){let v=se(u),k=[],X=v.get(1/0)??k;for(let E of s.sublayers){let Y=v.get(E.subtypeCode)??k;r.set(E,[...Y,...X])}}else r.set(s,u)})}function te(i){return d(this,arguments,function*({featureService:e,layers:r,signal:t}){if(!e.capabilities?.editing.supportsSharedTemplates)return new Map;let n=new Map(r.map(s=>[s.layerId,s])),o=yield e.querySharedTemplates({query:{layers:Array.from(n.keys())},requestOptions:{signal:t}}),p=new Map;for(let s of o)for(let u of s.layerIds)n.has(u)&&w(p,n.get(u),()=>[]).push(s);return p})}function ie(e,r){return d(this,null,function*(){let t=yield B(r).load(),i=new Set;for(let n of e)x(i,ne(t,n));return yield Promise.all(Array.from(i).map(n=>n.featureService.load())),i})}function ne(e,r){return D(r)&&r.parent?e.tablesAndLayersLookup.get(r.parent):I(r)?e.tablesAndLayersLookup.get(r):null}function se(e){let r=new Map;for(let t of e)w(r,t.subtypeCode??1/0,()=>[]).push(t);return r}export{$ as a,B as b,Ye as c,Ze as d,T as e,Q as f,er as g,rr as h,tr as i,ir as j,nr as k};
