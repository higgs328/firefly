import{c as J,d as Q}from"./chunk-I2JD5OSI.js";import{a as $}from"./chunk-2MROBW6T.js";import{a as D}from"./chunk-PSNQ2KG3.js";import{a as q,d as c}from"./chunk-CZMBPC27.js";import{i as z}from"./chunk-VSD74FMI.js";import{a as W,b as j}from"./chunk-KPT44MCK.js";import{h as T}from"./chunk-ONYJLWAD.js";import{a as k}from"./chunk-PDQQY7RQ.js";import{k as p,l as I,n as _,z as m}from"./chunk-HM5RIVQC.js";import{b as K}from"./chunk-X2B63YVS.js";import{m as V}from"./chunk-AUAZP44J.js";import{D as B,E as O}from"./chunk-76ATOSLU.js";import{a as X}from"./chunk-T7DXJKX7.js";import{c as L,d as v,o as b,p as F,u as G}from"./chunk-4PTIEWMT.js";import{b as H}from"./chunk-YOFFGXOB.js";import{g as N}from"./chunk-XRGPJ3QY.js";import{B as A,D as f}from"./chunk-QBWJMFH5.js";import{a as S,f as d}from"./chunk-VTHXE323.js";function Z(){return Y??=d(this,null,function*(){let a=yield import("./chunk-OWNS6KMM.js"),t=yield a.default({locateFile:e=>K(`esri/libs/basisu/${e}`)});return t.initializeBasis(),t}),Y}var Y;var h=null,w=null;function tt(){return d(this,null,function*(){return w==null&&(w=Z(),h=yield w),w})}function et(a,t){if(h==null)return a.byteLength;let e=new h.BasisFile(new Uint8Array(a)),r=st(e)?at(e.getNumLevels(0),e.getHasAlpha(),e.getImageWidth(0,0),e.getImageHeight(0,0),t):0;return e.close(),e.delete(),r}function rt(a,t){if(h==null)return a.byteLength;let e=new h.KTX2File(new Uint8Array(a)),r=it(e)?at(e.getLevels(),e.getHasAlpha(),e.getWidth(),e.getHeight(),t):0;return e.close(),e.delete(),r}function at(a,t,e,r,s){let i=z(t?m.COMPRESSED_RGBA8_ETC2_EAC:m.COMPRESSED_RGB8_ETC2),o=s&&a>1?(4**a-1)/(3*4**(a-1)):1;return Math.ceil(e*r*i*o)}function st(a){return a.getNumImages()>=1&&!a.isUASTC()}function it(a){return a.getFaces()>=1&&a.isETC1S()}function ot(a,t,e){return d(this,null,function*(){h==null&&(h=yield tt());let r=new h.BasisFile(new Uint8Array(e));if(!st(r))return null;r.startTranscoding();let s=lt(a,t,r.getNumLevels(0),r.getHasAlpha(),r.getImageWidth(0,0),r.getImageHeight(0,0),(i,o)=>r.getImageTranscodedSizeInBytes(0,i,o),(i,o,n)=>r.transcodeImage(n,0,i,o,0,0));return r.close(),r.delete(),s})}function nt(a,t,e){return d(this,null,function*(){h==null&&(h=yield tt());let r=new h.KTX2File(new Uint8Array(e));if(!it(r))return null;r.startTranscoding();let s=lt(a,t,r.getLevels(),r.getHasAlpha(),r.getWidth(),r.getHeight(),(i,o)=>r.getImageTranscodedSizeInBytes(i,0,0,o),(i,o,n)=>r.transcodeImage(n,i,0,0,o,0,-1,-1));return r.close(),r.delete(),s})}function lt(a,t,e,r,s,i,o,n){let{compressedTextureETC:l,compressedTextureS3TC:x}=a.capabilities,[E,M]=l?r?[D.ETC2_RGBA,m.COMPRESSED_RGBA8_ETC2_EAC]:[D.ETC1_RGB,m.COMPRESSED_RGB8_ETC2]:x?r?[D.BC3_RGBA,m.COMPRESSED_RGBA_S3TC_DXT5_EXT]:[D.BC1_RGB,m.COMPRESSED_RGB_S3TC_DXT1_EXT]:[D.RGBA32,_.RGBA],C=t.hasMipmap?e:Math.min(1,e),g=[];for(let u=0;u<C;u++)g.push(new Uint8Array(o(u,E))),n(u,E,g[u]);return t.internalFormat=M,t.hasMipmap=g.length>1,t.samplingMode=t.hasMipmap?p.LINEAR_MIPMAP_LINEAR:p.LINEAR,t.width=s,t.height=i,new c(a,t,{type:"compressed",levels:g})}var R=()=>N.getLogger("esri.views.3d.webgl-engine.lib.DDSUtil"),pt=542327876,ut=131072,_t=4;function P(a){return a.charCodeAt(0)+(a.charCodeAt(1)<<8)+(a.charCodeAt(2)<<16)+(a.charCodeAt(3)<<24)}function ct(a){return String.fromCharCode(255&a,a>>8&255,a>>16&255,a>>24&255)}var gt=P("DXT1"),Tt=P("DXT3"),Et=P("DXT5"),At=31,ft=0,Dt=1,xt=2,Ct=3,yt=4,Mt=7,It=20,wt=21;function mt(a,t,e){let r=Rt(e,t.hasMipmap??!1);if(r==null)throw new Error("DDS texture data is null");let{textureData:s,internalFormat:i,width:o,height:n}=r;return t.samplingMode=s.levels.length>1?p.LINEAR_MIPMAP_LINEAR:p.LINEAR,t.hasMipmap=s.levels.length>1,t.internalFormat=i,t.width=o,t.height=n,new c(a,t,s)}function Rt(a,t){let e=new Int32Array(a.buffer,a.byteOffset,At);if(e[ft]!==pt)return R().error("Invalid magic number in DDS header"),null;if(!(e[It]&_t))return R().error("Unsupported format, must contain a FourCC code"),null;let r=e[wt],s,i;switch(r){case gt:s=8,i=m.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case Tt:s=16,i=m.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case Et:s=16,i=m.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;default:return R().error("Unsupported FourCC code:",ct(r)),null}let o=1,n=e[yt],l=e[Ct];(3&n||3&l)&&(R().warn("Rounding up compressed texture size to nearest multiple of 4."),n=n+3&-4,l=l+3&-4);let x=n,E=l,M,C;e[xt]&ut&&t!==!1&&(o=Math.max(1,e[Mt]));let g=a.byteOffset+e[Dt]+4,u=[];for(let U=0;U<o;++U)C=(n+3>>2)*(l+3>>2)*s,M=new Uint8Array(a.buffer,g,C),u.push(M),g+=C,n=Math.max(1,n>>1),l=Math.max(1,l>>1);return{textureData:{type:"compressed",levels:u},internalFormat:i,width:x,height:E}}var ht=class extends W{constructor(t,e){super(),this._data=t,this.type=j.Texture,this.events=new X,this._glTexture=null,this._loadingPromise=null,this._loadingController=null,this._parameters=S(S({},Ft),e),this._startPreload(t)}dispose(){this.unload(),this._data=this.frameUpdate=void 0}_startPreload(t){t!=null&&(t instanceof HTMLVideoElement?(this.frameUpdate=e=>this._frameUpdate(t,e),this._startPreloadVideoElement(t)):t instanceof HTMLImageElement&&this._startPreloadImageElement(t))}_startPreloadVideoElement(t){if(!(B(t.src)||t.preload==="auto"&&t.crossOrigin)){t.preload="auto",t.crossOrigin="anonymous";let e=!t.paused;if(t.src=t.src,e&&t.autoplay){let r=()=>{t.removeEventListener("canplay",r),t.play()};t.addEventListener("canplay",r)}}}_startPreloadImageElement(t){O(t.src)||B(t.src)||t.crossOrigin||(t.crossOrigin="anonymous",t.src=t.src)}_createDescriptor(t){let e=new q;return e.wrapMode=this._parameters.wrap??I.REPEAT,e.flipped=!this._parameters.noUnpackFlip,e.samplingMode=this._parameters.mipmap?p.LINEAR_MIPMAP_LINEAR:p.LINEAR,e.hasMipmap=!!this._parameters.mipmap,e.preMultiplyAlpha=!!this._parameters.preMultiplyAlpha,e.maxAnisotropy=this._parameters.maxAnisotropy??(this._parameters.mipmap?t.parameters.maxMaxAnisotropy:1),e}get glTexture(){return this._glTexture}get memoryEstimate(){return this._glTexture?.usedMemory||St(this._data,this._parameters)}load(t){if(this._glTexture)return this._glTexture;if(this._loadingPromise)return this._loadingPromise;let e=this._data;return e==null?(this._glTexture=new c(t,this._createDescriptor(t),null),this._glTexture):(this._parameters.reloadable||(this._data=void 0),typeof e=="string"?this._loadFromURL(t,e):e instanceof Image?this._loadFromImageElement(t,e):e instanceof HTMLVideoElement?this._loadFromVideoElement(t,e):e instanceof ImageData||e instanceof HTMLCanvasElement?this._loadFromImage(t,e):f(e)&&this._parameters.encoding===T.DDS_ENCODING?this._loadFromDDSData(t,e):A(e)&&this._parameters.encoding===T.DDS_ENCODING?this._loadFromDDSData(t,new Uint8Array(e)):(A(e)||f(e))&&this._parameters.encoding===T.KTX2_ENCODING?this._loadFromKTX2(t,e):(A(e)||f(e))&&this._parameters.encoding===T.BASIS_ENCODING?this._loadFromBasis(t,e):f(e)?this._loadFromPixelData(t,e):A(e)?this._loadFromPixelData(t,new Uint8Array(e)):null)}_frameUpdate(t,e){return this._glTexture==null||t.readyState<y.HAVE_CURRENT_DATA||e===t.currentTime?e:(this._glTexture.setData(t),this._glTexture.descriptor.hasMipmap&&this._glTexture.generateMipmap(),this._parameters.updateCallback&&this._parameters.updateCallback(),t.currentTime)}_loadFromDDSData(t,e){return this._glTexture=mt(t,this._createDescriptor(t),e),this._glTexture}_loadFromKTX2(t,e){return this._loadAsync(()=>nt(t,this._createDescriptor(t),e).then(r=>(this._glTexture=r,r)))}_loadFromBasis(t,e){return this._loadAsync(()=>ot(t,this._createDescriptor(t),e).then(r=>(this._glTexture=r,r)))}_loadFromPixelData(t,e){k(this._parameters.width>0&&this._parameters.height>0);let r=this._createDescriptor(t);return r.pixelFormat=this._parameters.components===1?_.LUMINANCE:this._parameters.components===3?_.RGB:_.RGBA,r.width=this._parameters.width??0,r.height=this._parameters.height??0,this._glTexture=new c(t,r,e),this._glTexture}_loadFromURL(t,e){return this._loadAsync(r=>d(this,null,function*(){let s=yield $(e,{signal:r});return F(r),this._loadFromImage(t,s)}))}_loadFromImageElement(t,e){return e.complete?this._loadFromImage(t,e):this._loadAsync(r=>d(this,null,function*(){let s=yield V(e,e.src,!1,r);return F(r),this._loadFromImage(t,s)}))}_loadFromVideoElement(t,e){return e.readyState>=y.HAVE_CURRENT_DATA?this._loadFromImage(t,e):this._loadFromVideoElementAsync(t,e)}_loadFromVideoElementAsync(t,e){return this._loadAsync(r=>new Promise((s,i)=>{let o=()=>{e.removeEventListener("loadeddata",n),e.removeEventListener("error",l),v(x)},n=()=>{e.readyState>=y.HAVE_CURRENT_DATA&&(o(),s(this._loadFromImage(t,e)))},l=E=>{o(),i(E||new H("Failed to load video"))};e.addEventListener("loadeddata",n),e.addEventListener("error",l);let x=G(r,()=>l(b()))}))}_loadFromImage(t,e){let r=e;if(!(r instanceof HTMLVideoElement)){let{maxTextureSize:o}=t.parameters;r=this._parameters.downsampleUncompressed?J(r,o):Q(r,o)}let s=dt(r);this._parameters.width=s.width,this._parameters.height=s.height;let i=this._createDescriptor(t);return i.pixelFormat=this._parameters.components===3?_.RGB:_.RGBA,i.width=s.width,i.height=s.height,i.shouldCompress=this._parameters.shouldCompress,this._glTexture=new c(t,i,r),this._glTexture}_loadAsync(t){let e=new AbortController;this._loadingController=e;let r=t(e.signal);this._loadingPromise=r;let s=()=>{this._loadingController===e&&(this._loadingController=null),this._loadingPromise===r&&(this._loadingPromise=null)};return r.then(s,s),r}unload(){if(this._glTexture=L(this._glTexture),this._loadingController!=null){let t=this._loadingController;this._loadingController=null,this._loadingPromise=null,t.abort()}this.events.emit("unloaded")}get parameters(){return this._parameters}};function St(a,t){if(a==null)return 0;if(A(a)||f(a))return t.encoding===T.KTX2_ENCODING?rt(a,!!t.mipmap):t.encoding===T.BASIS_ENCODING?et(a,!!t.mipmap):a.byteLength;let{width:e,height:r}=a instanceof Image||a instanceof ImageData||a instanceof HTMLCanvasElement||a instanceof HTMLVideoElement?dt(a):t;return(t.mipmap?4/3:1)*e*r*(t.components||4)||0}function dt(a){return a instanceof HTMLVideoElement?{width:a.videoWidth,height:a.videoHeight}:a}var y;(function(a){a[a.HAVE_NOTHING=0]="HAVE_NOTHING",a[a.HAVE_METADATA=1]="HAVE_METADATA",a[a.HAVE_CURRENT_DATA=2]="HAVE_CURRENT_DATA",a[a.HAVE_FUTURE_DATA=3]="HAVE_FUTURE_DATA",a[a.HAVE_ENOUGH_DATA=4]="HAVE_ENOUGH_DATA"})(y||(y={}));var Ft={wrap:{s:I.REPEAT,t:I.REPEAT},mipmap:!0,noUnpackFlip:!1,preMultiplyAlpha:!1,downsampleUncompressed:!1,shouldCompress:!1};export{tt as a,ht as b};
