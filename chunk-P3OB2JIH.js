import{b as J,c as x,f as k}from"./chunk-FWBT5WUO.js";import{a as P}from"./chunk-MTYOPLNE.js";import{a as q,b as I}from"./chunk-4TIUXNXO.js";import{c as L,d as S,h as R}from"./chunk-JLWYDAJB.js";var M=class extends P{_createTransforms(){return{displayViewScreenMat3:q(),tileMat3:q()}}};function D(d,e,t,s,o,i){let{iconRotationAlignment:c,textRotationAlignment:l,iconTranslate:r,iconTranslateAnchor:h,textTranslate:u,textTranslateAnchor:a}=s,y=0;for(let n of d.colliders){let[m,b]=n.partIndex===0?r:u,_=n.partIndex===0?h:a,f=n.minLod<=i&&i<=n.maxLod;y+=f?0:1,n.enabled=f,n.xScreen=n.xTile*o[0]+n.yTile*o[3]+o[6],n.yScreen=n.xTile*o[1]+n.yTile*o[4]+o[7],_===R.MAP?(n.xScreen+=t*m-e*b,n.yScreen+=e*m+t*b):(n.xScreen+=m,n.yScreen+=b),S.VIEWPORT===(n.partIndex===0?c:l)?(n.dxScreen=n.dxPixels,n.dyScreen=n.dyPixels):(n.dxScreen=t*(n.dxPixels+n.width/2)-e*(n.dyPixels+n.height/2)-n.width/2,n.dyScreen=e*(n.dxPixels+n.width/2)+t*(n.dyPixels+n.height/2)-n.height/2)}d.colliders.length>0&&y===d.colliders.length&&(d.unique.show=!1)}var A=class{constructor(e,t,s,o,i,c){this._symbols=e,this._styleRepository=o,this._zoom=i,this._currentLayerCursor=0,this._currentSymbolCursor=0,this._styleProps=new Map,this._allNeededMatrices=new Map,this._gridIndex=new x(t,s,32),this._si=Math.sin(Math.PI*c/180),this._co=Math.cos(Math.PI*c/180);for(let l of e)for(let r of l.symbols)this._allNeededMatrices.has(r.tile)||this._allNeededMatrices.set(r.tile,I(r.tile.transforms.tileUnitsToPixels))}work(e){let t=this._gridIndex;function s(i){let c=i.xScreen+i.dxScreen,l=i.yScreen+i.dyScreen,r=c+i.width,h=l+i.height,[u,a,y,n]=t.getCellSpan(c,l,r,h);for(let m=a;m<=n;m++)for(let b=u;b<=y;b++){let _=t.cells[m][b];for(let f of _){let p=f.xScreen+f.dxScreen,g=f.yScreen+f.dyScreen,w=p+f.width,T=g+f.height;if(!(r<p||c>w||h<g||l>T))return!0}}return!1}let o=performance.now();for(;this._currentLayerCursor<this._symbols.length;this._currentLayerCursor++,this._currentSymbolCursor=0){let i=this._symbols[this._currentLayerCursor],c=this._getProperties(i.styleLayerUID);for(;this._currentSymbolCursor<i.symbols.length;this._currentSymbolCursor++){if(this._currentSymbolCursor%100==99&&performance.now()-o>e)return!1;let l=i.symbols[this._currentSymbolCursor];if(!l.unique.show)continue;D(l,this._si,this._co,c,this._allNeededMatrices.get(l.tile),this._zoom);let r=l.unique;if(!r.show)continue;let{iconAllowOverlap:h,iconIgnorePlacement:u,textAllowOverlap:a,textIgnorePlacement:y}=c;for(let n of l.colliders){if(!n.enabled)continue;let m=r.parts[n.partIndex];m.show&&!(n.partIndex?a:h)&&s(n)&&(n.hard?r.show=!1:m.show=!1)}if(r.show)for(let n of l.colliders){if(!n.enabled||(n.partIndex?y:u)||!r.parts[n.partIndex].show)continue;let m=n.xScreen+n.dxScreen,b=n.yScreen+n.dyScreen,_=m+n.width,f=b+n.height,[p,g,w,T]=this._gridIndex.getCellSpan(m,b,_,f);for(let v=g;v<=T;v++)for(let C=p;C<=w;C++)this._gridIndex.cells[v][C].push(n)}}}return!0}_getProperties(e){let t=this._styleProps.get(e);if(t)return t;let s=this._zoom,o=this._styleRepository.getStyleLayerByUID(e),i=o.getLayoutValue("symbol-placement",s)!==L.POINT,c=o.getLayoutValue("icon-rotation-alignment",s);c===S.AUTO&&(c=i?S.MAP:S.VIEWPORT);let l=o.getLayoutValue("text-rotation-alignment",s);l===S.AUTO&&(l=i?S.MAP:S.VIEWPORT);let r=o.getPaintValue("icon-translate",s),h=o.getPaintValue("icon-translate-anchor",s),u=o.getPaintValue("text-translate",s),a=o.getPaintValue("text-translate-anchor",s),y={iconAllowOverlap:o.getLayoutValue("icon-allow-overlap",s),iconIgnorePlacement:o.getLayoutValue("icon-ignore-placement",s),textAllowOverlap:o.getLayoutValue("text-allow-overlap",s),textIgnorePlacement:o.getLayoutValue("text-ignore-placement",s),iconRotationAlignment:c,textRotationAlignment:l,iconTranslateAnchor:h,iconTranslate:r,textTranslateAnchor:a,textTranslate:u};return this._styleProps.set(e,y),y}};function W(d,e){if(d.priority-e.priority)return d.priority-e.priority;let t=d.tile.key,s=e.tile.key;return t.world-s.world?t.world-s.world:t.level-s.level?t.level-s.level:t.row-s.row?t.row-s.row:t.col-s.col?t.col-s.col:d.xTile-e.xTile?d.xTile-e.xTile:d.yTile-e.yTile}var O=class{get running(){return this._running}constructor(e,t,s,o,i,c){this._visibleTiles=e,this._symbolRepository=t,this._createCollisionJob=s,this._assignTileSymbolsOpacity=o,this._symbolLayerSorter=i,this._isLayerVisible=c,this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0}setScreenSize(e,t){this._screenWidth===e&&this._screenHeight===t||this.restart(),this._screenWidth=e,this._screenHeight=t}restart(){this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0}continue(e){if(this._selectionJob||(this._selectionJob=this._createSelectionJob()),!this._selectionJobCompleted){let t=performance.now();if(!this._selectionJob.work(e)||(this._selectionJobCompleted=!0,(e=Math.max(0,e-(performance.now()-t)))===0))return!1}if(this._collisionJob||(this._collisionJob=this._createCollisionJob(this._selectionJob.sortedSymbols,this._screenWidth,this._screenHeight)),!this._collisionJobCompleted){let t=performance.now();if(!this._collisionJob.work(e)||(this._collisionJobCompleted=!0,(e=Math.max(0,e-(performance.now()-t)))===0))return!1}if(this._opacityJob||(this._opacityJob=this._createOpacityJob()),!this._opacityJobCompleted){let t=performance.now();if(!this._opacityJob.work(e)||(this._opacityJobCompleted=!0,(e=Math.max(0,e-(performance.now()-t)))===0))return!1}return this._running=!1,!0}_createSelectionJob(){let e=this._symbolRepository.uniqueSymbols;for(let r=0;r<e.length;r++){let h=e[r];for(let u=0;u<h.uniqueSymbols.length;u++){let a=h.uniqueSymbols[u];for(let y of a.tileSymbols)y.selectedForRendering=!1}}let t=[],s=0,o=0,i=this._isLayerVisible;function c(r){let h,u=performance.now();for(;o<e.length;o++,s=0){let a=e[o],y=a.styleLayerUID;if(!i(y)){t[o]||(t[o]={styleLayerUID:y,symbols:[]});continue}t[o]=t[o]||{styleLayerUID:y,symbols:[]};let n=t[o];for(;s<a.uniqueSymbols.length;s++){if(h=a.uniqueSymbols[s],s%100==99&&performance.now()-u>r)return!1;let m=null,b=!1,_=!1;for(let f of h.tileSymbols)if(!_||!b){let p=f.tile;(!m||p.isCoverage||p.neededForCoverage&&!b)&&(m=f,(p.neededForCoverage||p.isCoverage)&&(_=!0),p.isCoverage&&(b=!0))}if(m.selectedForRendering=!0,_){n.symbols.push(m),h.show=!0;for(let f of h.parts)f.show=!0}else h.show=!1}}for(let a of t)a.symbols.sort(W);return!0}let l=this._symbolLayerSorter;return{work:c,get sortedSymbols(){return t.sort(l)}}}_createOpacityJob(){let e=this._assignTileSymbolsOpacity,t=this._visibleTiles,s=0;function o(i,c){for(let l of i.symbols.values())F(l,c);e(i,c);for(let l of i.childrenTiles)o(l,c)}return{work(i){let c=performance.now();for(;s<t.length;s++){if(performance.now()-c>i)return!1;let l=t[s];l.parentTile==null&&o(l,performance.now())}return!0}}}};function F(d,e){for(let t of d){let s=t.unique;for(let o of s.parts){let i=o.targetOpacity>.5?1:-1;o.startOpacity+=i*((e-o.startTime)/200),o.startOpacity=Math.min(Math.max(o.startOpacity,0),1),o.startTime=e,o.targetOpacity=s.show&&o.show?1:0}}}var N=32,E=8,G=64,H=20,V=class{constructor(e,t,s){this.tileCoordRange=e,this._visibleTiles=t,this._createUnique=s,this._tiles=new Map,this._uniqueSymbolsReferences=new Map}get uniqueSymbols(){return this._uniqueSymbolLayerArray==null&&(this._uniqueSymbolLayerArray=this._createUniqueSymbolLayerArray()),this._uniqueSymbolLayerArray}get uniqueSymbolsReferences(){return this._uniqueSymbolsReferences}add(e,t){this._uniqueSymbolLayerArray=null;let s=this._tiles.get(e.id);s||(s={symbols:new Map},this._tiles.set(e.id,s));let o=new Map;if(t)for(let l of t)s.symbols.has(l)&&(o.set(l,s.symbols.get(l)),s.symbols.delete(l));else for(let[l,r]of e.layerData)s.symbols.has(l)&&(o.set(l,s.symbols.get(l)),s.symbols.delete(l));this._removeSymbols(o);let i=e.symbols,c=new Map;for(let[l,r]of i){let h=r.length;if(h>=N){let u=this.tileCoordRange;do u/=2,h/=4;while(h>E&&u>G);let a=new x(this.tileCoordRange,this.tileCoordRange,u);c.set(l,{flat:r,index:a}),s.symbols.set(l,{flat:r,index:a});for(let y of r)a.getCell(y.xTile,y.yTile).push(y)}else c.set(l,{flat:r}),s.symbols.set(l,{flat:r})}this._addSymbols(e.key,i)}deleteStyleLayers(e){this._uniqueSymbolLayerArray=null;for(let[t,s]of this._tiles){let o=new Map;for(let i of e)s.symbols.has(i)&&(o.set(i,s.symbols.get(i)),s.symbols.delete(i));this._removeSymbols(o),s.symbols.size===0&&this._tiles.delete(t)}}removeTile(e){this._uniqueSymbolLayerArray=null;let t=this._tiles.get(e.id);if(!t)return;let s=new Map;for(let[o,i]of e.symbols)t.symbols.has(o)&&(s.set(o,t.symbols.get(o)),t.symbols.delete(o));this._removeSymbols(s),t.symbols.size===0&&this._tiles.delete(e.id)}querySymbols(e,t,s,o){let i=[],c=this.uniqueSymbols;for(let l of c){let r=l.styleLayerUID,h=l.uniqueSymbols;for(let u of h){let a=u.tileSymbols.find(y=>y.selectedForRendering);a&&k(a,e,t*(window.devicePixelRatio||1),s)&&i.push({vtlSymbol:a,styleLayerUID:r,tileKey:a.tile.key})}}return i}_removeSymbols(e){for(let[t,{flat:s}]of e)for(let o of s){let i=o.unique,c=i.tileSymbols,l=c.length-1;for(let r=0;r<l;r++)if(c[r]===o){c[r]=c[l];break}if(c.length=l,l===0){let r=this._uniqueSymbolsReferences.get(t);r.delete(i),r.size===0&&this._uniqueSymbolsReferences.delete(t)}o.unique=null}}_addSymbols(e,t){if(t.size===0)return;let s=this._visibleTiles;for(let o of s)o.parentTile||o.key.world!==e.world||o.key.level===e.level&&!o.key.equals(e)||this._matchSymbols(o,e,t);for(let[o,i]of t)for(let c of i)if(c.unique==null){let l=this._createUnique();c.unique=l,l.tileSymbols.push(c);let r=this._uniqueSymbolsReferences.get(o);r||(r=new Set,this._uniqueSymbolsReferences.set(o,r)),r.add(l)}}_matchSymbols(e,t,s){if(e.key.level>t.level){let i=e.key.level-t.level;if(e.key.row>>i!==t.row||e.key.col>>i!==t.col)return}if(t.level>e.key.level){let i=t.level-e.key.level;if(t.row>>i!==e.key.row||t.col>>i!==e.key.col)return}if(t.equals(e.key)){for(let i of e.childrenTiles)this._matchSymbols(i,t,s);return}let o=new Map;for(let[i,c]of s){let l=[];for(let a of c){let y=J(this.tileCoordRange,a.xTile,t.level,t.col,e.key.level,e.key.col),n=J(this.tileCoordRange,a.yTile,t.level,t.row,e.key.level,e.key.row);y>=0&&y<this.tileCoordRange&&n>=0&&n<this.tileCoordRange&&l.push({symbol:a,xTransformed:y,yTransformed:n})}let r=[],h=(e.key.level<t.level?1:1<<e.key.level-t.level)+H,u=this._tiles.get(e.id).symbols.get(i);if(u){let a=u.flat;for(let y of l){let n,m=!1,b=y.xTransformed,_=y.yTransformed;n=u.index!=null?u.index.getCell(b,_):a;let f=y.symbol,p=f.hash;for(let g of n)if(p===g.hash&&Math.abs(b-g.xTile)<=h&&Math.abs(_-g.yTile)<=h){let w=g.unique;f.unique=w,w.tileSymbols.push(f),m=!0;break}m||r.push(f)}}r.length>0&&o.set(i,r)}for(let i of e.childrenTiles)this._matchSymbols(i,t,o)}_createUniqueSymbolLayerArray(){let e=this._uniqueSymbolsReferences,t=new Array(e.size),s,o=0;for(let[i,c]of e){let l=new Array(c.size);s=0;for(let r of c)l[s++]=r;t[o]={styleLayerUID:i,uniqueSymbols:l},o++}return t}};export{A as a,O as b,V as c,M as d};
