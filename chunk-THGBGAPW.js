import{a as w,b as A,e as O,i as f,k as u}from"./chunk-TG45K3WR.js";import{f as p}from"./chunk-RAI4DTMT.js";import{a as e}from"./chunk-QGVBCWUY.js";import{H as g}from"./chunk-MYO4NP2N.js";import{e as n}from"./chunk-NFIPKH6V.js";import{l as m}from"./chunk-5QEXLALV.js";import{d as y,e as l,p as v,r as _,y as V}from"./chunk-4PTIEWMT.js";import{g as c}from"./chunk-XRGPJ3QY.js";import{c as d,f as h}from"./chunk-VTHXE323.js";var o;(function(t){t[t.PENDING=0]="PENDING",t[t.WAIT_FOR_VIEW_READY=1]="WAIT_FOR_VIEW_READY",t[t.RUNNING=2]="RUNNING"})(o||(o={}));var i=class extends g{constructor(t={}){super(t),this.view=null,this.analysisView=null,this._reconnectViewTask=null,this._forceInteractiveHandle=null,this._parentChangeFromReconnect=!1,this._startUserOperation=null;let s=t?.analysis;s!=null?this.analysis=s:(this._set("analysis",this.constructAnalysis()),this._set("isAnalysisOwner",!0)),t?.visible!=null&&(this.visible=t.visible)}normalizeCtorArgs(t){let a=t,{analysis:s}=a;return d(a,["analysis"])}initialize(){this.addHandles([w(()=>({readyAndNotSupported:this.view!=null&&this.view.ready&&!this.supported}),({readyAndNotSupported:t})=>{t&&c.getLogger(this).errorOnce(this.unsupportedErrorMessage)},u),w(()=>this.analysis?.parent,t=>{this._parentChangeFromReconnect||t===this.view||this._set("isAnalysisOwner",!1);let s=!this._parentChangeFromReconnect;this._parentChangeFromReconnect=!1,s&&this._scheduleViewReconnect()},f),w(()=>({view:this.view,ready:this.view!=null&&this.view.ready,supported:this.supported}),({view:t},s)=>{let r=s?.view;t!==r&&(this._startUserOperation=l(this._startUserOperation),this._disconnectFromView(r)),this._scheduleViewReconnect()},u)])}destroy(){this._reconnectViewTask=l(this._reconnectViewTask),this._startUserOperation=l(this._startUserOperation),this.analysisView!=null&&(this.analysisView.visible=void 0),this._disconnectFromView(this.view),this._set("view",null),this.analysis!=null&&this.isAnalysisOwner&&(this.analysis.destroy(),this._set("analysis",null))}get supported(){return this.view==null||this.view.type===this.supportedViewType}set visible(t){this._set("visible",t),this.analysisView!=null&&(this.analysisView.visible=t)}get active(){return this.tool!=null&&this.tool.active}get disabled(){return this.view==null||!this.view.ready||!this.supported}set analysis(t){t!==this._get("analysis")&&(this._startUserOperation=l(this._startUserOperation),this._disconnectFromView(this.view),this._setExternalAnalysis(t),this._scheduleViewReconnect())}get ready(){return this.analysisView!=null&&!this.connectingToView}get connectingToView(){return this._reconnectViewTask!=null}get isAnalysisOwner(){return this._get("isAnalysisOwner")}get tool(){return this.analysisView!=null?this.analysisView.tool:null}clear(){this._startUserOperation=l(this._startUserOperation),this._resetInteractiveCreationState(),this.tool!=null&&this.view!=null&&this.view.activeTool===this.tool&&(this.view.activeTool=null)}start(){return h(this,null,function*(){if(!this.visible)return void c.getLogger(this).warn("Cannot start analysis when not visible");this.clear();let t={task:null,abort:null,state:o.PENDING},s=p(r=>h(this,null,function*(){if(t.state=o.WAIT_FOR_VIEW_READY,yield O(()=>this.ready,r),t.state=o.RUNNING,this.analysisView==null||this.view==null)return;let a=this.analysisView.tool;a!=null&&(this.view.activeTool=a,A(()=>a.created,()=>{a.active&&this.view!=null&&(this.view.activeTool=null)},{initial:!0,once:!0}))}));return t.task=s,t.abort=()=>s.abort(),this._startUserOperation=t,s.promise})}onConnectToAnalysisView(t){}onDisconnectFromAnalysisView(){}_scheduleViewReconnect(){this._reconnectViewTask=l(this._reconnectViewTask);let t=p(s=>h(this,null,function*(){try{yield this._reconnectView(s)}catch(r){if(v(s),!V(r))return void c.getLogger(this).warn("Failed to use analysis in view model",r);throw r}finally{t===this._reconnectViewTask&&(this._reconnectViewTask=null)}}));this._reconnectViewTask=t}_reconnectView(t){return h(this,null,function*(){let{view:s}=this,r=s!=null&&s.ready&&this.supported,a=this.analysis;if(this._startUserOperation=b(this._startUserOperation),this._disconnectFromView(s),r&&s!=null&&a!=null){if(this.isAnalysisOwner){if(a.parent!=null)return void c.getLogger(this).errorOnce("expected owned analysis to have null parent when connecting to view");this._parentChangeFromReconnect=!0,s.analyses.add(a)}this.analysisView=yield s.whenAnalysisView(a),_(t)?this._startUserOperation=b(this._startUserOperation):(this.analysisView.visible=this.visible,this._forceInteractiveHandle=this.analysisView.forceInteractiveForViewModel(),this.addHandles(this._forceInteractiveHandle),this.onConnectToAnalysisView(this.analysisView))}})}_disconnectFromView(t){t!=null&&this.isAnalysisOwner&&t.analyses.includes(this.analysis)&&(this._parentChangeFromReconnect=!0,this.analysis.clear(),t.analyses.remove(this.analysis)),this.onDisconnectFromAnalysisView(),this._forceInteractiveHandle=y(this._forceInteractiveHandle),this.analysisView=null}_setExternalAnalysis(t){this.analysisView==null||this.isAnalysisOwner||(this.analysisView.visible=void 0,this._forceInteractiveHandle=y(this._forceInteractiveHandle)),this.analysisView=null,this._set("isAnalysisOwner",!1),this._set("analysis",t),this._parentChangeFromReconnect=!1}_resetInteractiveCreationState(){this.analysis.clear(),this.tool!=null&&this.tool.resetCreated()}get testInfo(){}};function b(t){return t!=null&&t.state>=o.RUNNING?(t.abort(),null):t}e([n()],i.prototype,"supported",null),e([n()],i.prototype,"view",void 0),e([n({type:Boolean,value:!0})],i.prototype,"visible",null),e([n()],i.prototype,"active",null),e([n()],i.prototype,"disabled",null),e([n({nonNullable:!0})],i.prototype,"analysis",null),e([n()],i.prototype,"analysisView",void 0),e([n()],i.prototype,"ready",null),e([n()],i.prototype,"connectingToView",null),e([n({readOnly:!0})],i.prototype,"isAnalysisOwner",null),e([n()],i.prototype,"_reconnectViewTask",void 0),e([n()],i.prototype,"_forceInteractiveHandle",void 0),e([n()],i.prototype,"tool",null),i=e([m("esri.widgets.support.AnalysisViewModel")],i);export{i as a};
