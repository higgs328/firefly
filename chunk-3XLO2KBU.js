import{a as f,b as h,c as v,d as m,f as F,g,h as M,i as D,j as G}from"./chunk-GXG4LM3O.js";import"./chunk-7FBNOJXT.js";import{a as P}from"./chunk-PRJOIHPH.js";import{a as T}from"./chunk-AJQXEZB3.js";import{a as S}from"./chunk-XC2P3GQB.js";import{a as w}from"./chunk-BEONHHQH.js";import{b as L}from"./chunk-6DALCDDU.js";import"./chunk-DA3SDKGO.js";import"./chunk-ZOEPYNM4.js";import"./chunk-57VFBGF3.js";import"./chunk-GWBRHLNH.js";import"./chunk-BJH4F4SM.js";import"./chunk-Z3RBZHAK.js";import"./chunk-MDZTV2VL.js";import"./chunk-RNC4P66O.js";import"./chunk-7LHOQXZT.js";import"./chunk-BCREO4Q5.js";import"./chunk-U4QEPZJ3.js";import"./chunk-KJUZWSCL.js";import"./chunk-3WO6D7MU.js";import"./chunk-BUZ3SPLE.js";import"./chunk-BOVYXYHK.js";import"./chunk-KVM6SHDX.js";import"./chunk-EQZWYK27.js";import"./chunk-2GJBUR2F.js";import{a as x}from"./chunk-DKGGDYJI.js";import"./chunk-5LA3PVK5.js";import"./chunk-IR6XCBC4.js";import"./chunk-C6JPAW54.js";import"./chunk-WD3OPXCN.js";import"./chunk-FA3WGIU4.js";import"./chunk-WWVPA6PE.js";import"./chunk-YPMM52MU.js";import"./chunk-BBR7CJCO.js";import"./chunk-ZQIC5NFT.js";import"./chunk-VIEK2X23.js";import"./chunk-XKIFGPJO.js";import"./chunk-PEW2PLAN.js";import"./chunk-Q6Y4JG7Q.js";import"./chunk-7F5DJLJT.js";import"./chunk-CX5IFQZJ.js";import"./chunk-NJWTSROP.js";import"./chunk-D3R25AF2.js";import"./chunk-ARRCN5K3.js";import"./chunk-4N4D2YQX.js";import"./chunk-G4DZJMGT.js";import"./chunk-WFKZLI6F.js";import"./chunk-X2B63YVS.js";import"./chunk-BAEF3CT6.js";import{b}from"./chunk-AUAZP44J.js";import"./chunk-PVDFCTA4.js";import"./chunk-KNVXE32P.js";import"./chunk-76ATOSLU.js";import"./chunk-CCJU4DSH.js";import"./chunk-RAI4DTMT.js";import"./chunk-TYYVNQUR.js";import"./chunk-QGVBCWUY.js";import"./chunk-MYO4NP2N.js";import"./chunk-NFIPKH6V.js";import"./chunk-JPU2PQZC.js";import"./chunk-5QEXLALV.js";import"./chunk-P6QFA5MM.js";import"./chunk-DGTD7Y73.js";import"./chunk-LI2SX4T6.js";import"./chunk-BWO7LS2H.js";import"./chunk-HEVQSRJ2.js";import"./chunk-OVHPPCBL.js";import"./chunk-SNFOAZZQ.js";import"./chunk-AML4XSEF.js";import"./chunk-4PTIEWMT.js";import"./chunk-TG2UTNEO.js";import{b as y}from"./chunk-YOFFGXOB.js";import"./chunk-XRGPJ3QY.js";import"./chunk-6MRUJ2UW.js";import"./chunk-2LI2GKBQ.js";import"./chunk-QBWJMFH5.js";import{f as p}from"./chunk-VTHXE323.js";function te(t,a){return p(this,null,function*(){let r=t.instance.portalItem;if(r?.id)return yield r.load(a),O(t),t.validateItem&&t.validateItem(r),R(t,a)})}function O(t){let a=t.instance.portalItem;if(!a?.type||!t.supportedTypes.includes(a.type))throw new y("portal:invalid-layer-item-type","Invalid layer item type '${type}', expected '${expectedType}'",{type:a?.type,expectedType:t.supportedTypes.join(", ")})}function R(t,a){return p(this,null,function*(){let r=t.instance,e=r.portalItem;if(!e)return;let{url:o,title:n}=e,l=w(e,"portal-item");if(r.type==="group")return k(r,l,t);o&&r.type!=="media"&&r.read({url:o},l);let u=new f,s=yield C(t,u,a);return s&&r.read(s,l),r.resourceReferences={portalItem:e,paths:l.readResourcePaths??[]},r.type!=="subtype-group"&&r.read({title:n},l),P(r,l)})}function k(t,a,r){return p(this,null,function*(){let e=t.portalItem;if(!t.sourceIsPortalItem)return;let{title:o,type:n}=e;if(n==="Group Layer"){if(!L(e,"Map"))throw new y("portal:invalid-layer-item-typekeyword","'Group Layer' item without 'Map' type keyword is not supported");return N(t,r)}return t.read({title:o},a),j(t,r)})}function N(t,a){return p(this,null,function*(){let r=t.portalItem,e=yield r.fetchData("json");if(!e)return;if(!a.populateGroupLayer)throw new y("portal:missing-populate-group-layer","Missing populate group layer");let o=w(r,"web-map");t.read(e,o),yield a.populateGroupLayer(t,e,{context:o}),t.resourceReferences={portalItem:r,paths:o.readResourcePaths??[]}})}function j(t,a){return p(this,null,function*(){let r,{portalItem:e}=t;if(!e)return;let o=e.type,n=a.layerModuleTypeMap;if(!n)throw new y("portal:missing-layer-module-type-map","Layer module type map is required to construct sub layers");switch(o){case"Feature Service":case"Feature Collection":r=n.FeatureLayer;break;case"Stream Service":r=n.StreamLayer;break;case"Scene Service":r=n.SceneLayer;break;default:throw new y("portal:unsupported-item-type-as-group",`The item type '${o}' is not supported as a 'IGroupLayer'`)}let l=new f,[u,s]=yield Promise.all([r(),C(a,l)]),i=()=>u;if(o==="Feature Service"){let c=m(s)?.customParameters;s=e.url?yield v(s,e.url,l):{},i=(yield z(s,n))||i;let d=yield K(e.url,{customParameters:c,loadContext:l});return yield I(t,i,i,s,n,d)}return o==="Scene Service"&&e.url&&(s=yield G(e,s,l)),g(s)>0?yield I(t,i,null,s,n):yield E(t,i,n)})}function E(t,a,r){return p(this,null,function*(){let{portalItem:e}=t;if(!e?.url)return;let o=yield S(e.url);o&&I(t,a,null,{layers:o.layers?.map(h),tables:o.tables?.map(h)},r)})}function I(t,a,r,e,o,n){return p(this,null,function*(){let l=e.layers||[],u=e.tables||[];if(t.portalItem?.type==="Feature Collection"?(l.forEach((s,i)=>{s.id=i,s?.layerDefinition?.type==="Table"&&u.push(s)}),l=l.filter(s=>s?.layerDefinition?.type!=="Table")):(l.reverse(),u.reverse()),l.forEach(s=>{let i=n?.(s);if(i||!n){let c=A(t,a(s),e,s,i);t.add(c)}}),u.length){let s=r?null:yield o.FeatureLayer();u.forEach(i=>{let c=n?.(i);if(c||!n){let d=A(t,r?r(i):s,e,i,c);t.tables.add(d)}})}})}function A(t,a,r,e,o){let n=t.portalItem,l={portalItem:n.clone(),layerId:e.id};e.url!=null&&(l.url=e.url);let u=new a(l);if("sourceJSON"in u&&(u.sourceJSON=o),u.type!=="subtype-group"&&u.type!=="catalog"&&(u.sublayerTitleMode="service-name"),n.type==="Feature Collection"){let s={origin:"portal-item",portal:n.portal||x.getDefault()};u.read(e,s);let i=r.showLegend;i!=null&&u.read({showLegend:i},s)}return u}function C(t,a,r){return p(this,null,function*(){if(t.supportsData===!1)return;let e=t.instance,o=e.portalItem;if(!o)return;let n=null;try{n=yield o.fetchData("json",r)}catch{}if(q(e)){let l=null,u=yield J(o,n,a);if((n?.layers||n?.tables)&&u>0){if(e.layerId==null){let s=M(e.type),i=s?.length?F(n,s)[0]:m(n);i&&(e.layerId=i.id)}l=$(n,e),l?.layerType==="OrientedImageryLayer"&&e.type==="oriented-imagery"&&e.supportedSourceTypes.add("Feature Layer"),l&&n.showLegend!=null&&(l.showLegend=n.showLegend)}return u>1&&"sublayerTitleMode"in e&&e.sublayerTitleMode!=="service-name"&&(e.sublayerTitleMode="item-title-and-service-name"),l}return n})}function J(t,a,r){return p(this,null,function*(){if(a?.layers&&a?.tables)return g(a);let e=b(t.url);if(!e)return 1;let o=yield r.fetchServiceMetadata(e.url.path,{customParameters:m(a)?.customParameters}).catch(()=>null);return(a?.layers?.length??o?.layers?.length??0)+(a?.tables?.length??o?.tables?.length??0)})}function $(t,a){let{layerId:r}=a,e=t.layers?.find(o=>o.id===r)||t.tables?.find(o=>o.id===r);return e&&B(e,a)?e:null}function q(t){return t.type!=="stream"&&"layerId"in t}function B(t,a){let r="layerType"in t&&t.layerType,{type:e}=a;return!(e==="feature"&&r&&t.layerType!=="ArcGISFeatureLayer"||e==="catalog"&&!r||e==="oriented-imagery"&&!r||e==="subtype-group"&&!r)}function K(t,a){return p(this,null,function*(){let{layersJSON:r}=yield T(t,a);if(!r)return null;let e=[...r.layers,...r.tables];return o=>e.find(n=>n.id===o.id)})}function z(t,a){return p(this,null,function*(){let{layers:r,tables:e}=t,o=[...r??[],...e??[]];if(!o.length)return;let n=new Set,l=[];for(let{layerType:i}of o){let c=i??"ArcGISFeatureLayer";if(n.has(c))continue;n.add(c);let d=a[D(c)];l.push(d())}let u=yield Promise.all(l),s=new Map;return Array.from(n).forEach((i,c)=>{s.set(i,u[c])}),({layerType:i})=>{let c=i??"ArcGISFeatureLayer";return s.get(c)}})}export{te as load};
