import{o as re}from"./chunk-WCHIR27X.js";import{b as Ve,c as je}from"./chunk-IGGGB3TP.js";import{a as te,b as x}from"./chunk-C5TDOKQP.js";import{b as Le}from"./chunk-MIJLPOZZ.js";import{a as Be}from"./chunk-NOHUHVCW.js";import{a as Ae}from"./chunk-WT37QSNF.js";import{a as xe}from"./chunk-IBSCSNYA.js";import{c as Re}from"./chunk-5H7NDIGP.js";import{a as He}from"./chunk-2GLWK7ZW.js";import{c as Ge}from"./chunk-BKWQOCBC.js";import{a as Me}from"./chunk-CX3G2QWN.js";import{h as H}from"./chunk-YTAJKLRN.js";import{a as Te,b as ee}from"./chunk-3ZJ4NMBE.js";import{a as M}from"./chunk-FSW536RM.js";import{a as Se,d as Ee}from"./chunk-MPI26GZ3.js";import{a as Ne,d as Pe}from"./chunk-CZMBPC27.js";import{j as Ie}from"./chunk-J5AEP4US.js";import{a as De}from"./chunk-XKFJ6GWH.js";import{a as C}from"./chunk-YEXMIDOT.js";import{a as be}from"./chunk-S52JRLJC.js";import{a as q}from"./chunk-PDQQY7RQ.js";import{a as ve}from"./chunk-EM35R6FY.js";import{k as Oe,r as Ce}from"./chunk-HM5RIVQC.js";import{a as Z}from"./chunk-ALWV3RJ2.js";import{a as _e,d as ye,f as we}from"./chunk-ZTOZWLEE.js";import{a as pe}from"./chunk-KVM6SHDX.js";import{a as fe}from"./chunk-EQZWYK27.js";import{B as ge}from"./chunk-NJWTSROP.js";import{a as y}from"./chunk-QGVBCWUY.js";import{H as me,r as ue}from"./chunk-MYO4NP2N.js";import{e as O}from"./chunk-NFIPKH6V.js";import{l as j}from"./chunk-5QEXLALV.js";import{a as V,c as ce}from"./chunk-P6QFA5MM.js";import{a as b}from"./chunk-AML4XSEF.js";import{c as de}from"./chunk-4PTIEWMT.js";import{r as X,t as le}from"./chunk-QBWJMFH5.js";var qe=class e{constructor(t,r,i,s,n=$e(t,r,i)){this._tilingScheme=s,this.id=n,this.lij=[0,0,0],this.extent=pe(),this.measures=new se,this.loadPriority=0,this.used=!1,this.lij[0]=this.measures.lodLevel=t,this.lij[1]=r,this.lij[2]=i,s.getExtent(t,r,i,this.extent)}get planetRadius(){return ge(this.spatialReference).radius}get spatialReference(){return this._tilingScheme.spatialReference}get resolution(){return this._tilingScheme.resolutionAtLevel(this.measures.lodLevel)}get level(){return this.lij[0]}get lodLevelDelta(){return this.measures.lodLevel-this.level}createChildren(){let t=this.lij[0]+1,r=2*this.lij[1],i=2*this.lij[2];return[new e(t,r,i,this._tilingScheme),new e(t,r+1,i,this._tilingScheme),new e(t,r,i+1,this._tilingScheme),new e(t,r+1,i+1,this._tilingScheme)]}},se=class{constructor(){this.visible=!0,this.distance=0,this.lodLevel=0,this.splitPriority=0,this.mergeable=!0}};function $e(e,t,r){return`${e}/${t}/${r}`}var W;(function(e){e[e.BACK_TO_FRONT=-1]="BACK_TO_FRONT",e[e.NONE=0]="NONE",e[e.FRONT_TO_BACK=1]="FRONT_TO_BACK"})(W||(W={}));var We=class{constructor(){this._queue=new b,this.remove=()=>{}}get done(){return this._queue.length===0&&(!this._last||this._last.leaf)}resetOne(t){this._queue.clear(),this._queue.push(t),this._last=void 0}reset(t=null){this._queue.clear(),t!=null&&this._queue.pushArray(t),this._last=void 0}skipSubtree(){this._last=void 0}next(){let t=this._last?.children;return t?.[0]&&this._queue.pushArray(t),this._last=this._queue.pop(),this._last}},ze=class{constructor(){this._q=new b}get done(){return this._q.length===0}reset(t){if(this._q.clear(),t!=null){this._q.pushArray(t);for(let r=0;r<this._q.length;++r){let i=this._q.data[r];i.leaf||this._q.pushArray(i.children)}}}next(){return this._q.pop()}};function pt(e,t){if(t==null)return!1;let r=Qe(t);if(r?.fullExtent==null)return!1;let i=r.fullExtent,s=e.extent;if(i.xmin>s[2]||i.ymin>s[3]||i.xmax<s[0]||i.ymax<s[1])return!1;let n=e.surface.tilingScheme.levels[e.level].scale,a=r.minScale;if(a>0&&n>1.00000001*a)return!1;let o=r.maxScale;return!(o>0&&n<.99999999*o)}function Qe(e){return re(e)?{fullExtent:e.fullExtent,minScale:e.layer.minScale,maxScale:e.layer.maxScale}:e.layer}function _t(e){return!re(e)&&e.layer&&"tilemapCache"in e.layer?e.layer.tilemapCache:null}function Je(e,t){let r=e.lij,i=t.lij;return r[0]-i[0]||r[1]-i[1]||r[2]-i[2]}function yt(e,t,r=null){r==null||r.length===0?e===W.BACK_TO_FRONT?t.sort(Xe):t.sort(Ze):t.sort((i,s)=>tt(i,s,e,r))}function Xe(e,t){let r=t.screenDepth-e.screenDepth;if(r!==0)return r;let i=e.lij,s=t.lij;return i[0]-s[0]||i[1]-s[1]||i[2]-s[2]}function Ze(e,t){let r=e.screenDepth-t.screenDepth;if(r!==0)return r;let i=e.lij,s=t.lij;return i[0]-s[0]||i[1]-s[1]||i[2]-s[2]}function et(e,t,r){let i=e.screenDepth,s=t.screenDepth;return i<s?-r:i>s?r:Je(e,t)}function tt(e,t,r,i){return Fe(e,i)===Fe(t,i)?et(e,t,r):e?r:-r}function Fe(e,t){for(let r of t)if(e.intersectsExtent(r))return!0;return!1}function rt(e,t){let r=e.distanceToPOI-t.distanceToPOI;if(r!==0)return r;let i=e.lij,s=t.lij;return i[0]-s[0]||i[1]-s[1]||i[2]-s[2]}function wt(e,t){let r=e.length;for(let i=0;i<r;++i)e.at(i).updateDistanceToPOI(t);e.sort(rt)}function vt(e,t,r){let i=1,s=0,n=0;for(;e!==t;)if(i*=.5,s*=.5,n*=.5,1&e.lij[2]&&(s+=.5),1&e.lij[1]||(n+=.5),(e=e.parent)==null)throw new Error("tile was not a descendant of upsampleTile");r.init(t,s,n,i)}function Ot(e){for(let t=0;t<e.length;t++){let r=e[t],i=r.parent;if(i)for(let s=0;s<4;s++){let n=i.children[s];if(n&&n!==r)return!0}}return!1}function Ct(e,t){if(!e||!t||e[0]===t[0])return!1;let r=e[0]<t[0],i=r?e:t,s=r?t:e,n=1<<s[0]-i[0];return Math.floor(s[1]/n)===i[1]&&Math.floor(s[2]/n)===i[2]}function Mt(e,t=I.Pos2,r=De,i=-1,s=1){let n=t===I.Pos2?new Float32Array([i,i,s,i,i,s,s,s]):new Float32Array([i,i,0,0,s,i,1,0,i,s,0,1,s,s,1,1]);return new He(e,r,new Map([["geometry",it.get(t)]]),new Map([["geometry",Me.createVertex(e,Ce.STATIC_DRAW,n)]]))}var st=4;function Ht(e){let t=new Ne(st);return t.samplingMode=Oe.NEAREST,new Pe(e,t)}var I;(function(e){e[e.Pos2=0]="Pos2",e[e.Pos2Tex=1]="Pos2Tex"})(I||(I={}));var it=new Map([[I.Pos2,Ve],[I.Pos2Tex,je]]);var D=class{constructor(t=0,r=0){this.from=t,this.to=r}get numElements(){return this.to-this.from}};function ie(e){if(e.length<2)return;let t=new Map;e.forAll(i=>t.set(i.from,i));let r=!0;for(;r;){r=!1;for(let i=0;i<e.length;++i){let s=e.data[i],n=t.get(s.to);n&&(s.to=n.to,t.delete(n.from),e.removeUnordered(n),r=!0)}}}var B=class extends D{constructor(t,r,i,s){super(r,i),this.geometry=t,this._highlightName=null,this.updateHighlightOptions(s)}updateHighlightOptions(t){let{geometry:r}=this;if(!r.hasHighlights)return void(this._highlightName=null);let i=-1,s=null;r.foreachHighlightOptions(n=>{let a=t.get(n)??-1;a>i&&(i=a,s=n)}),this._highlightName=s}get highlightName(){return this._highlightName}get isVisible(){return this.geometry.visible}get hasHighlights(){return this.isVisible&&this.geometry.hasHighlights}get hasOccludees(){return this.geometry.occludees!=null}};var z=class{constructor(){this.first=0,this.count=0}};var U=class{constructor(){this._numElements=0,this._instances=new Map,this.holes=new b({allocator:t=>t||new D,deallocator:null}),this.hasHiddenInstances=!1,this.hasOccludees=!1,this.drawCommandsDirty=!0,this.highlightNames=new Set,this.drawCommandsDefault=F(),this.drawCommandsHighlights=new Map,this.drawCommandsOccludees=F(),this.drawCommandsShadowHighlightRest=F()}get numElements(){return this._numElements}get instances(){return this._instances}get hasHighlights(){return this.highlightNames.size>0}resetInstanceSummary(){this.hasHiddenInstances=!1,this.hasOccludees=!1,this.highlightNames.clear()}updateIfDrawCommandsDirty(t,r){if(this.drawCommandsDirty){this.resetInstanceSummary();for(let i of this.instances.values())this.updateDrawState(i);this.updateDrawCommands(t,r)}}addInstance(t,r){this.deleteInstance(t),this._instances.set(t,r),this._numElements+=r.numElements}deleteInstance(t){let r=this._instances.get(t);r&&(this._numElements-=r.numElements,this._instances.delete(t))}updateInstance(t,r,i){let s=this._instances.get(t);s&&(this._numElements-=s.numElements,s.from=r,s.to=i,this._numElements+=s.numElements)}updateDrawState(t){if(t.isVisible){let{highlightName:r}=t;r&&this.highlightNames.add(r),t.hasOccludees&&(this.hasOccludees=!0)}else this.hasHiddenInstances=!0}updateDrawCommands(t,r){if(this.drawCommandsDefault.clear(),this.drawCommandsOccludees.clear(),this.drawCommandsDirty=!1,this._instances.size===0)return;let{sortedInstances:i}=this;if(this._updateHighlightDrawCommands(t,i),!this.needsMultipleCommands()){let s=this.drawCommandsDefault.pushNew(),n=this.holes.front();return this.vao!=null&&this.holes.length===1&&n.to===Math.floor(this.vao.byteSize/r)?(s.first=0,void(s.count=n.from)):(s.first=1/0,s.count=0,this._instances.forEach(a=>{s.first=Math.min(s.first,a.from),s.count=Math.max(s.count,a.to)}),void(s.count-=s.first))}for(let s of i)s.isVisible&&ne(s.hasOccludees?this.drawCommandsOccludees:this.drawCommandsDefault,s)}get sortedInstances(){return Array.from(this._instances.values()).sort((t,r)=>t.from===r.from?t.to-r.to:t.from-r.from)}updateHighlights(t){this.highlightNames.clear();let r=this.sortedInstances;for(let i of r)i.updateHighlightOptions(t),i.isVisible&&i.highlightName&&this.highlightNames.add(i.highlightName);this._updateHighlightDrawCommands(t)}_updateHighlightDrawCommands(t,r=this.sortedInstances){let{drawCommandsHighlights:i,drawCommandsShadowHighlightRest:s}=this;i.clear(),s.clear();for(let n of r){if(n.updateHighlightOptions(t),!n.isVisible)continue;let{highlightName:a}=n;a&&(this.highlightNames.add(a),ne(ce(i,a,F),n)),a&&a===H||ne(s,n)}}needsMultipleCommands(){return this.hasOccludees||this.hasHighlights||this.hasHiddenInstances}};function Ue(e){return e.vao!=null}function F(){return new b({allocator:e=>e||new z,deallocator:e=>e})}function ne(e,t){let r=e.back();if(r==null){let i=e.pushNew();return i.first=t.from,void(i.count=t.numElements)}if(nt(r,t)){let i=t.from-r.first+t.numElements;r.count=i}else{let i=e.pushNew();i.first=t.from,i.count=t.numElements}}function nt(e,t){return e.first+e.count>=t.from}var K=class{constructor(t){this.origin=t,this.buffers=new Array}dispose(){this.buffers.forEach(t=>t.vao.dispose()),this.buffers.length=0}findBuffer(t){return this.buffers.find(r=>r.instances.has(t))}};var P=class extends Re{get _hasHighlights(){return this._highlightNames.size>0}hasHighlightOptions(e){return this._highlightNames.has(e)}constructor(e){super(e),this._dataByOrigin=new Map,this._drawParameters=new Ae,this._highlightNames=new Set,this.drapedPriority=0,this._produces=new Map,this._hasOccludees=!1}destroy(){this._glMaterials=de(this._glMaterials),this._dataByOrigin.forEach(e=>e.dispose()),this._dataByOrigin.clear(),this._vaoCache=null}initialize(){this._updateProduces()}_updateProduces(){this.material.produces.forEach((e,t)=>{this._produces.set(t,r=>!(this._dataByOrigin.size===0||!(r!==C.Highlight&&r!==C.ShadowHighlight||this._hasHighlights))&&e(r))})}initializeRenderContext(e,t){this._glMaterials=new xe(this.material,t??e.materials),this._bufferWriter=this.material.createBufferWriter(),this._vaoCache=e.renderContext.rctx.getVaoCache(this.material.vertexAttributeLocations,be(this._bufferWriter.vertexBufferLayout))}uninitializeRenderContext(){}get produces(){return this._produces}get hasOccludees(){return this._hasOccludees}get hasEmissions(){return this.material.hasEmissions}get isDecoration(){return this.material.parameters.isDecoration}queryRenderOccludedState(e){return this.material.queryRenderOccludedState(e)}get numGeometries(){let e=0;return this._dataByOrigin.forEach(t=>e+=t.buffers.reduce((r,i)=>r+i.instances.size,0)),e}get usedMemory(){let e=0;return this._dataByOrigin.forEach(t=>e+=t.buffers.reduce((r,i)=>r+i.vao.cachedMemory,0)),e}forEachGeometry(e){this._dataByOrigin.forEach(t=>t.buffers.forEach(r=>r.instances.forEach(({geometry:i})=>e(i))))}modify(e){this._updateGeometries(e.updates),this._addAndRemoveGeometries(e.adds,e.removes),this._updateDrawCommands()}updateHighlights(e){this.highlightOrderMap=e,this._highlightNames.clear(),this._dataByOrigin.forEach(t=>{t.buffers.forEach(r=>{r.updateHighlights(e),r.highlightNames.forEach(i=>this._highlightNames.add(i))})}),this._updateProduces()}_updateGeometries(e){let t=this._bufferWriter;if(t==null)return;let r=t.vertexBufferLayout.stride/4;for(let i of e){let s=i.renderGeometry,n=this._dataByOrigin.get(s.localOrigin.id),a=n?.findBuffer(s.id);if(a==null)return;let o=a.instances.get(s.id);if(i.updateType&(x.GEOMETRY|x.TRANSFORMATION)){let l=$(t.elementCount(o.geometry.geometry.attributes)*r),h=t.vertexBufferLayout.createView(l.buffer);this._writeGeometry(s,h,0),a.vao.vertexBuffers.get("geometry").setSubData(l,o.from*r,0,o.numElements*r)}i.updateType&(x.HIGHLIGHT|x.OCCLUDEE|x.VISIBILITY)&&(a.drawCommandsDirty=!0)}}_computeDeltas(e,t){let r=new Be;for(let i of e){let s=i.localOrigin;if(s==null)continue;let n=r.get(s.id,null);n==null&&(n=new J(s.vec3),r.set(s.id,null,n)),n.changes.push(i)}for(let i of t){let s=i.localOrigin;if(s==null)continue;let n=this._dataByOrigin.get(s.id),a=n?.findBuffer(i.id);if(a==null)continue;let o=r.get(s.id,a);o==null&&(o=new J(s.vec3),r.set(s.id,a,o)),o.changes.push(i)}return r}_addAndRemoveGeometries(e,t){if(this._bufferWriter==null||this._vaoCache==null)return;let{_bufferWriter:r,_dataByOrigin:i}=this,s=r.vertexBufferLayout.stride/4,n=this._computeDeltas(e,t);n.forEach((a,o)=>{let l=a.get(null),h=l?.changes??[];n.delete(o,null);let g=i.get(o);if(a.forEach((m,c)=>{if(n.delete(o,c),c==null)return void q(!1,"No VAO for removed geometries");if(c.instances.size===m.changes.length)return this._vaoCache.deleteVao(c.vao),X(g.buffers,c),void(g.buffers.length===0&&h.length===0&&i.delete(o));let d=c.numElements,f=c.vao.byteSize/4,v=h.reduce((w,E)=>w+r.elementCount(E.geometry.attributes),0),u=m.changes.reduce((w,E)=>w+r.elementCount(E.geometry.attributes),0),_=Math.min((d+v-u)*s,k),p=_>f;_>L&&_<f/2?(m.changes.forEach(({id:w})=>c.deleteInstance(w)),c.instances.forEach(({geometry:w})=>h.push(w)),this._vaoCache.deleteVao(c.vao),X(g.buffers,c)):p?this._applyAndRebuild(c,h,m):this._applyRemoves(c,m)}),h.length>0)for(g==null&&(g=new K(l.origin),i.set(o,g)),g.buffers.forEach(m=>this._applyAdds(m,h));h.length>0;)g.buffers.push(this._applyAndRebuild(new U,h,null))})}_updateDrawCommands(){this._highlightNames.clear(),this._hasOccludees=!1,this._dataByOrigin.forEach(e=>{e.buffers.forEach(t=>{t.updateIfDrawCommandsDirty(this.highlightOrderMap,this._bufferWriter.vertexBufferLayout.stride),t.hasHighlights&&ue(this._highlightNames,t.highlightNames),this._hasOccludees=this._hasOccludees||t.hasOccludees})})}_applyAndRebuild(e,t,r){if(r)for(let d of r.changes)e.deleteInstance(d.id);let i=this._bufferWriter,s=i.vertexBufferLayout.stride,n=s/4,a=Math.floor(k/n),o=e.numElements;for(;t.length>0;){let d=t.pop(),f=i.elementCount(d.geometry.attributes);if(o+f>a&&o>0){t.push(d);break}o+=f;let v=new B(d,0,0,this.highlightOrderMap);q(e.instances.get(d.id)==null),e.addInstance(d.id,v)}let l=o*n,h=$(l),g=i.vertexBufferLayout.createView(h.buffer),m=0;e.resetInstanceSummary(),e.instances.forEach((d,f)=>{this._writeGeometry(d.geometry,g,m);let v=m;m+=i.elementCount(d.geometry.geometry.attributes),e.updateInstance(f,v,m),e.updateDrawState(d)}),this._vaoCache.deleteVao(e.vao),e.vao=this._vaoCache.newVao(Ye(l)),e.vao.vertexBuffers.get("geometry").setSubData(h,0,0,m*n),e.holes.clear();let c=e.holes.pushNew();return c.from=m,c.to=Math.floor(e.vao.byteSize/s),e.updateDrawCommands(this.highlightOrderMap,s),e}_applyRemoves(e,t){if(t.changes.length===0||this._bufferWriter==null)return;for(let a of t.changes){let o=a.id,l=e.instances.get(o);if(!l)continue;e.deleteInstance(o);let h=A.back();if(h){if(h.to===l.from){h.to=l.to;continue}if(h.from===l.to){h.from=l.from;continue}}let g=A.pushNew();g.from=l.from,g.to=l.to}ie(A);let r=this._bufferWriter.vertexBufferLayout.stride/4,i=A.reduce((a,o)=>Math.max(a,o.numElements),0)*r,s=$(i);s.fill(0,0,i);let n=e.vao.vertexBuffers.get("geometry");A.forAll(a=>n.setSubData(s,a.from*r,0,a.numElements*r)),e.holes.pushArray(A.data,A.length),A.forAll((a,o)=>A.data[o]=null),A.clear(),e.drawCommandsDirty=!0}_applyAdds(e,t){if(t.length===0||this._bufferWriter==null)return;if(!Ue(e))return void this._applyAndRebuild(e,t,null);let r=this._bufferWriter,i=r.vertexBufferLayout.stride/4,s=e.numElements,n=t.reduce((u,_)=>u+r.elementCount(_.geometry.attributes),0),a=Math.min((s+n)*i,k),o=4*a;if(e.vao.byteSize<Ye(k-L)&&o>e.vao.byteSize)return void this._applyAndRebuild(e,t,null);ie(e.holes);let l=new Array;for(let u of t){let _=r.elementCount(u.geometry.attributes),p=at(e.holes,_);l.push(p)}let h=e.vao.vertexBuffers.get("geometry"),g=0,m=0,c=0,d=$(a),f=r.vertexBufferLayout.createView(d.buffer);t.forEach((u,_)=>{let p=l[_];if(p==null)return;if(c!==p){let T=c-m;T>0&&h.setSubData(d,m*i,0,T*i),m=p,g=0}let w=r.elementCount(u.geometry.attributes);this._writeGeometry(u,f,g),g+=w,c=p+w;let E=new B(u,p,p+w,this.highlightOrderMap);q(e.instances.get(u.id)==null),e.addInstance(u.id,E),e.drawCommandsDirty=!0});let v=c-m;v>0&&h.setSubData(d,m*i,0,v*i),le(t,(u,_)=>l[_]==null)}_writeGeometry(e,t,r){this._bufferWriter!=null&&(_e(N,e.transformation),N[12]-=e.localOrigin.vec3[0],N[13]-=e.localOrigin.vec3[1],N[14]-=e.localOrigin.vec3[2],we(Y,N),ye(Y,Y),this._bufferWriter.write(N,Y,e.geometry.attributes,e.geometry.objectAndLayerIdColor,t,r))}updateAnimation(e){return this.material.update(e)}acquireTechniques(e){if(!this.material.shouldRender(e))return null;let{output:t,bind:r}=e;if(!this.material.produces.get(r.slot)?.(t))return null;let{highlight:s,slot:n}=r,a=t===C.ShadowHighlight,o=t===C.Highlight,l=o||a,h=s?.name;if(l&&(this._highlightNames.size===0||o&&h&&!this._highlightNames.has(h)))return null;let g=d=>o&&!!h&&!d.has(h),m=t===C.ShadowExcludeHighlight,c=!(l||m);for(let{buffers:d}of this._dataByOrigin.values())for(let f of d){if(g(f.highlightNames))continue;let v=a?f.drawCommandsHighlights.get(H):l?h?f.drawCommandsHighlights.get(h):f.drawCommandsHighlights.size>0:((m&&f.needsMultipleCommands()?f.drawCommandsShadowHighlightRest:f.drawCommandsDefault)||null)?.length??!1,u=c&&f.drawCommandsOccludees||null;if(v||u?.length){let _=this._glMaterials.load(e.rctx,n,t),p=_?.beginSlot(r);if(p)return p}}return null}render(e,t){let{output:r,bind:i}=e,{slot:s,highlight:n}=i,a=r===C.Highlight,o=n?.name??"";if(a&&!n)return;let l=r===C.ShadowHighlight,h=a||l,g=r===C.ShadowExcludeHighlight,m=!(h||g),c=s===M.OCCLUDER_MATERIAL||s===M.TRANSPARENT_OCCLUDER_MATERIAL?s:null,{rctx:d}=e;d.runAppleAmdDriverHelper();let f=d.bindTechnique(t,i,this.material.parameters);for(let v of this._dataByOrigin.values())for(let u of v.buffers){if(a&&(!u.hasHighlights||!u.drawCommandsHighlights.has(o))||l&&(!u.hasHighlights||!u.drawCommandsHighlights.has(H)))continue;let _=()=>{let S=[],G=u.drawCommandsHighlights.get(H)??new b;return G&&S.push(G),S},p=h&&!l?u.drawCommandsHighlights.get(o)??null:null,w=l?_():h?p?[p]:ot:g&&u.needsMultipleCommands()?[u.drawCommandsShadowHighlightRest]:[u.drawCommandsDefault],E=w.some(S=>S.length>0),T=m&&u.drawCommandsOccludees||null;if(E||T?.length){if(this._drawParameters.origin=v.origin,f.bindDraw(i,this.material.parameters,this._drawParameters),t.ensureAttributeLocations(u.vao),d.bindVAO(u.vao),E)for(let S of w)d.setPipelineState(t.getPipeline(!1,c)),S.forAll(G=>d.drawArrays(t.primitiveType,G.first,G.count));T?.length&&(d.setPipelineState(t.getPipeline(!0,c)),T.forAll(S=>d.drawArrays(t.primitiveType,S.first,S.count)))}}}static prune(){Q=new Float32Array(L)}get test(){}};y([O({constructOnly:!0})],P.prototype,"material",void 0),y([O({})],P.prototype,"highlightOrderMap",void 0),P=y([j("esri.views.3d.webgl-engine.materials.renderers.MergedRenderer")],P);var J=class{constructor(t){this.origin=t,this.changes=new Array}};function at(e,t){let r=e.find(s=>s.numElements>=t);if(r==null)return null;let i=r.from;return r.from+=t,r.from>=r.to&&e.removeUnordered(r),i}var N=Z(),Y=Z(),A=new b({allocator:e=>e||new D,deallocator:null}),L=65536,ae=4*L,Ke=1024,ke=16777216,k=ke/4,Q=new Float32Array(L);function $(e){return Q.length<e&&(Q=new Float32Array(e)),Q}function Ye(e){let t=4*e;return t<=Ke?Ke:t<ae?fe(t):Math.max(Math.min(Math.ceil(1.5*t/ae)*ae,ke),t)}var ot=[];var R=class extends me{constructor(e){super(e),this._pending=new he,this._changes=new Se,this._renderers=new Map,this._sortedRenderers=new b,this._geometries=new Map,this._hasHighlights=!1,this._hasWater=!1}destroy(){this._changes.prune(),this._renderers.forEach(e=>e.destroy()),this._renderers.clear(),this._sortedRenderers.clear(),this._geometries.clear(),this._pending.clear()}get updating(){return!this._pending.empty||this._changes.updates.length>0}get rctx(){return this.rendererContext.rctx}get _materials(){return this.rendererContext.materials}get _localOriginFactory(){return this.rendererContext.localOriginFactory}get hasHighlights(){return this._hasHighlights}hasHighlightOptions(e){return V(this._renderers,t=>t.hasHighlightOptions(e))}get hasWater(){return this._hasWater}get rendersOccludedDraped(){for(let e of this._renderers.values())if(e.numGeometries!==0&&!e.queryRenderOccludedState(Ie.Occlude))return!0;return!1}get isEmpty(){return!this.updating&&this._renderers.size===0&&this._geometries.size===0}getMaterialRenderer(e){return this._renderers.get(e)}get sortedRenderers(){return this._sortedRenderers}commitChanges(e){if(!this.updating)return!1;this._processAddsRemoves();let t=Ee(this._changes),r=!1;return t.forEach((i,s)=>{let n=this._renderers.get(s);!n&&i.adds.length>0&&(n=new P({material:s,highlightOrderMap:e}),n.initializeRenderContext(this.rendererContext.pluginContext,this._materials),this._renderers.set(s,n),r=!0),n&&(n.modify(i),n.updateHighlights(e),n.numGeometries===0&&(this._renderers.delete(s),n.destroy(),r=!0))}),this._changes.clear(),r&&this._updateSortedMaterialRenderers(),this._hasHighlights=V(this._renderers,i=>{let s=i.produces.get(M.DRAPED_MATERIAL);return!!s&&s(C.Highlight)}),this._hasWater=V(this._renderers,i=>{let s=i.produces.get(M.DRAPED_WATER);return!!s&&s(C.Normal)}),this.notifyChange("updating"),!0}updateHighlights(e){this._renderers.forEach(t=>t.updateHighlights(e))}addGeometries(e,t){if(e.length===0)return;let r=this._validateRenderGeometries(e);for(let s of r)this._geometries.set(s.id,s);let i=this._pending.empty;for(let s of r)this._pending.adds.add(s);i&&this.notifyChange("updating"),t===te.UPDATE&&this._notifyGraphicGeometryChanged(e)}removeGeometries(e,t){let r=this._pending.empty,i=this._pending.adds;for(let s of e)i.has(s)?(this._pending.removed.add(s),i.delete(s)):this._pending.removed.has(s)||this._pending.removes.add(s),this._geometries.delete(s.id);r&&!this._pending.empty&&this.notifyChange("updating"),t===te.UPDATE&&this._notifyGraphicGeometryChanged(e)}modifyGeometries(e,t){let r=this._changes.updates.length===0;for(let i of e){let s=this._changes.updates.pushNew();s.renderGeometry=this._validateRenderGeometry(i),s.updateType=t}switch(r&&this._changes.updates.length>0&&this.notifyChange("updating"),t){case x.TRANSFORMATION:case x.GEOMETRY:return this._notifyGraphicGeometryChanged(e);case x.VISIBILITY:return this._notifyGraphicVisibilityChanged(e)}}updateAnimation(e){let t=!1;return this._sortedRenderers.forAll(r=>t=!!r.updateAnimation&&r.updateAnimation(e)||t),t}precompile(e){return this._sortedRenderers.reduce((t,r)=>r.precompile(e)||t,!1)}render(e){this._sortedRenderers.forAll(t=>{let r=t.acquireTechniques(e);r&&t.render(e,r)})}intersect(e,t,r,i,s){for(let n of this._geometries.values()){if(!i(n))continue;this._intersectRenderGeometry(n,r,t,0,e,s);let a=this.rendererContext.longitudeCyclical;a&&(n.boundingSphere[0]-n.boundingSphere[3]<a.min&&this._intersectRenderGeometry(n,r,t,a.range,e,s),n.boundingSphere[0]+n.boundingSphere[3]>a.max&&this._intersectRenderGeometry(n,r,t,-a.range,e,s)),s++}return s}_updateSortedMaterialRenderers(){this._sortedRenderers.clear();let e=0;for(let t of this._renderers.values())t.drapedPriority=e++,this._sortedRenderers.push(t);this._sortedRenderers.sort((t,r)=>r.material?.renderPriority===t.material?.renderPriority?t.drapedPriority-r.drapedPriority:(r.material?.renderPriority||0)-(t.material?.renderPriority||0))}_processAddsRemoves(){this._changes.adds.clear(),this._changes.removes.clear(),this._changes.adds.pushArray(Array.from(this._pending.adds)),this._changes.removes.pushArray(Array.from(this._pending.removes)),this._changes.updates.filterInPlace(({renderGeometry:e})=>!this._pending.has(e)),this._pending.clear()}_intersectRenderGeometry(e,t,r,i,s,n){if(!e.visible||!e.material.visible)return;let a=0;i+=e.transformation[12],a=e.transformation[13],oe[0]=r[0]-i,oe[1]=r[1]-a,e.screenToWorldRatio=this.rendererContext.screenToWorldRatio,e.material.intersectDraped(e,null,s,oe,(o,l,h)=>{ht(t,h,n,e.material.renderPriority,s,e.layerUid,e.graphicUid)},t)}_notifyGraphicGeometryChanged(e){if(this.drapeSource.notifyGraphicGeometryChanged==null)return;let t;for(let{graphicUid:r}of e)r!=null&&r!==t&&(this.drapeSource.notifyGraphicGeometryChanged(r),t=r)}_notifyGraphicVisibilityChanged(e){if(this.drapeSource.notifyGraphicVisibilityChanged==null)return;let t;for(let{graphicUid:r}of e)r!=null&&r!==t&&(this.drapeSource.notifyGraphicVisibilityChanged(r),t=r)}_validateRenderGeometries(e){for(let t of e)this._validateRenderGeometry(t);return e}_validateRenderGeometry(e){return e.localOrigin==null&&(e.localOrigin=this._localOriginFactory.getOrigin(e.boundingSphere)),e}get test(){}};y([O()],R.prototype,"drapeSource",void 0),y([O()],R.prototype,"updating",null),y([O()],R.prototype,"rctx",null),y([O({constructOnly:!0})],R.prototype,"rendererContext",void 0),y([O()],R.prototype,"_materials",null),y([O()],R.prototype,"_localOriginFactory",null),y([O({readOnly:!0})],R.prototype,"isEmpty",null),y([O()],R.prototype,"_renderers",void 0),y([O()],R.prototype,"_geometries",void 0),R=y([j("esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer")],R);var he=class{constructor(){this.adds=new Set,this.removes=new Set,this.removed=new Set}get empty(){return this.adds.size===0&&this.removes.size===0&&this.removed.size===0}has(t){return this.adds.has(t)||this.removes.has(t)||this.removed.has(t)}clear(){this.adds.clear(),this.removes.clear(),this.removed.clear()}};function ht(e,t,r,i,s,n,a){let o=new Le(n,a,t),l=h=>{h.set(Te.OVERLAY,o,e.dist,e.normal,e.transformation,r,i)};if((s.results.min.drapedLayerOrder==null||r>=s.results.min.drapedLayerOrder)&&(s.results.min.dist==null||s.results.ground.dist<=s.results.min.dist)&&l(s.results.min),s.options.store!==ee.MIN&&(s.results.max.drapedLayerOrder==null||r<s.results.max.drapedLayerOrder)&&(s.results.max.dist==null||s.results.ground.dist>s.results.max.dist)&&l(s.results.max),s.options.store===ee.ALL){let h=Ge(s.ray);l(h),s.results.all.push(h)}}var oe=ve();export{qe as a,$e as b,W as c,We as d,ze as e,pt as f,_t as g,Je as h,yt as i,et as j,wt as k,vt as l,Ot as m,Ct as n,Mt as o,Ht as p,I as q,P as r,R as s};
