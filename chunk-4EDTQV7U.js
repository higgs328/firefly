import{a as ni,b as li,c as ci,d as hi,e as mi,f as pi,g as ui,h as di,j as It,l as gi,m as yi,p as St,q as Ct,r as fi,s as vi,t as Je,u as Ke,v as Xe,w as Ye}from"./chunk-KRNSBZIV.js";import{a as wt,b as Ja,c as Ka}from"./chunk-GO6KX2QB.js";import{a as Ua,c as $a}from"./chunk-PLVVXHQB.js";import{a as ii,c as ri,d as oi,e as si}from"./chunk-QXAGW4MX.js";import{a as $e,b as Wa,c as Za,d as qa}from"./chunk-67TN76MZ.js";import{a as Xa,b as bt,e as _t,f as Ya,g as Qa,h as Pt,k as ei,l as ti,m as Ft,n as Mt,o as ai}from"./chunk-YZ3FJXNI.js";import{A as Ze,B as za,C as La,D as Ha,E as Ea,L as Ta,M as ce,N as Da,P as he,R as Na,S as Pe,T as ge,U as Ba,_ as qe,a as oe,aa as Fe,ba as vt,c as De,ca as ja,e as yt,f as Ia,fa as ye,j as Sa,k as Ca,ka as Ue,l as xa,m as ft,n as Ra,o as Oa,p as Va,q as Aa,r as ka,s as Ne,t as Be,u as je,v as We,y as Ga}from"./chunk-XXEY6HOD.js";import{a as Ma}from"./chunk-J6L7HGQG.js";import{a as Te}from"./chunk-4SB27PWV.js";import{a as Fa}from"./chunk-OBHZ6OKG.js";import{c as Pa}from"./chunk-3GVCQR7N.js";import{t as _a}from"./chunk-LJGY4ZC4.js";import{a as Ee}from"./chunk-EPKVBNFW.js";import{a as He}from"./chunk-FHBFWDFD.js";import{a as ba}from"./chunk-O6VBCDES.js";import{d as wa}from"./chunk-4JIR4MZV.js";import{j as va}from"./chunk-BC7GBJHB.js";import{a as Le}from"./chunk-H7EBUK3L.js";import{a as fa}from"./chunk-DXDHIMTP.js";import{a as ze}from"./chunk-GUIIGAD3.js";import{a as re}from"./chunk-7XYYDAZO.js";import{a as ya}from"./chunk-V7E55JV7.js";import{a as ga}from"./chunk-3YHPJJNR.js";import{a as da}from"./chunk-4Y7EKSO4.js";import{A as Ge,s as pa,x as ua}from"./chunk-3WNFY6Z5.js";import{j as gt}from"./chunk-3X6CYJC6.js";import{a as ra,b as oa,c as sa,d as ut,e as ca,f as dt,g as ha,h as ma}from"./chunk-OK5V73EE.js";import{c as na,d as la}from"./chunk-5C57S7IZ.js";import{b as ia}from"./chunk-3RH2TOVP.js";import{a as aa}from"./chunk-VJZDN6ZB.js";import{a as ta}from"./chunk-44ACGF3Z.js";import{a as R}from"./chunk-LAX5536Z.js";import{a as ea}from"./chunk-O4V2VBSK.js";import{a as Qt}from"./chunk-SZMEI3WL.js";import{a as Yt}from"./chunk-AVMO6LCR.js";import{a as Kt}from"./chunk-JQAW4OB5.js";import{b as Xt}from"./chunk-2HYVVLKS.js";import{i as pt}from"./chunk-QXXXCEV5.js";import{a as ke}from"./chunk-3JGYBNJA.js";import{p as K}from"./chunk-DA3SDKGO.js";import{a as Jt}from"./chunk-ZOEPYNM4.js";import{a as Ae}from"./chunk-MIS6QMFE.js";import{a as Ut}from"./chunk-MDZTV2VL.js";import{h as Y}from"./chunk-RNC4P66O.js";import{i as $t}from"./chunk-7LHOQXZT.js";import{a as le}from"./chunk-U4QEPZJ3.js";import{a as qt}from"./chunk-DZFUQCB6.js";import{b as X,i as ne,j as _e}from"./chunk-EQZWYK27.js";import{b as mt}from"./chunk-JLPLCY2B.js";import{m as Zt}from"./chunk-ZQIC5NFT.js";import{a as Wt,c as L}from"./chunk-VIEK2X23.js";import{a as B}from"./chunk-PEW2PLAN.js";import{i as be}from"./chunk-Q6Y4JG7Q.js";import{a as D}from"./chunk-7F5DJLJT.js";import{a as ct}from"./chunk-CX5IFQZJ.js";import{ca as ht}from"./chunk-NJWTSROP.js";import{a as jt}from"./chunk-ARRCN5K3.js";import{a as Ht}from"./chunk-GHKL3NOH.js";import{a as Ve}from"./chunk-5XCFNEYX.js";import{a as Oe}from"./chunk-GQL2MBZT.js";import{a as Tt}from"./chunk-4N4D2YQX.js";import{a as Bt}from"./chunk-G4DZJMGT.js";import{a as Et}from"./chunk-BAEF3CT6.js";import{o as Re}from"./chunk-AUAZP44J.js";import{ba as Lt}from"./chunk-76ATOSLU.js";import{f as ae}from"./chunk-CCJU4DSH.js";import{a as I,b as Dt,c as lt,i as Nt,j as we,k as x}from"./chunk-TG45K3WR.js";import{f as ie}from"./chunk-RAI4DTMT.js";import{b as z}from"./chunk-ACP3S2CH.js";import{a as de}from"./chunk-T7DXJKX7.js";import{a as o}from"./chunk-QGVBCWUY.js";import{d as Ce}from"./chunk-MYO4NP2N.js";import{e as s}from"./chunk-NFIPKH6V.js";import{l as T}from"./chunk-5QEXLALV.js";import{O as xe,b as E,e as te,p as C,t as zt,y as U}from"./chunk-4PTIEWMT.js";import{b as N}from"./chunk-YOFFGXOB.js";import{g as G}from"./chunk-XRGPJ3QY.js";import{h as nt}from"./chunk-2LI2GKBQ.js";import{j as st,y as Se}from"./chunk-QBWJMFH5.js";import{a as S,b as H,c as ot,f as y}from"./chunk-VTHXE323.js";var xt=class{static getCameraOrientation(e){return ha(e)}static register(e,t,a){sa.set(e,{desc:t,constructor:a})}};xt=o([T("esri.layers.orientedImagery.core.cameraOrientationFactory")],xt);var wi=xt;function xi(e){throw new N("exposure-point:missing-default-value",`a value for ${e} is missing in default properties`)}function Ri(e,t){throw new N("exposure-point:missing-attribute-value",`a value for ${e} is missing in attribute table`,{exposurePoint:t})}var me=e=>({cast:t=>{let a=parseFloat(t);return Number.isFinite(a)?a:void 0},json:{name:e,write:{writer:(t,a,i)=>{a[i]=Number.isFinite(t)?t:void 0}}}}),Rt=e=>({cast:t=>typeof t=="string"?t.split(";").map(Number):t,json:{default:e,write:{writer:(t,a,i)=>{a[i]=t?.join(";")}}}}),v=class extends ke.ClonableMixin(ae){constructor(e){super(e),this.cameraOrientation=null,this.elevation=null,this.elevationSource=null,this.name=null,this.sourceMap=null}read(e,t){let a={},{attributes:i,layer:r,geometry:n}=e,c={};for(let l in i)a[l.toLowerCase()]=i[l],c[l.toLowerCase()]=l;super.read(S({geometry:n,layer:r??{},sourceMap:c},a),t)}write(e,t){let a=super.write(e,t),{sourceMap:i}=this;if(!i||!a)return a;let r={};for(let n in a){let c=i[n.toLowerCase()];c&&(r[c]=a[n])}return r}readCameraHeading(e,t){let{cameraheading:a,camheading:i,layer:r}=t;return a??i??r.cameraHeading}readCameraHeight(e,t){let{cameraheight:a,avghtag:i,layer:r}=t;return a??i??r.cameraHeight}readCamOffset(e,t){let{cameraoffset:a,camoffset:i}=t;return a?.split(";").map(Number)??i?.split(";").map(Number)??null}writeCameraOffset(e,t){e&&(t.cameraOffset=e.join(";"))}readCameraOrientation(e,t){let{cameraorientation:a,camori:i}=t;return a??i}readCameraPitch(e,t){let{camerapitch:a,campitch:i,layer:r}=t;return a??i??r.cameraPitch}readCameraRoll(e,t){let{cameraroll:a,camroll:i,layer:r}=t;return a??i??r.cameraRoll}readDepthImage(e,t){let{depthimage:a,depthimg:i,layer:r}=t,n=a??i??null,{depthImagePathPrefix:c,depthImagePathSuffix:l}=r??{};return ut(n,c,l)}readElevationSource(e,t){let{elevationsource:a,layer:i}=t,{demPathSuffix:r,demPathPrefix:n}=i;if(a){let c=this._parseIfJSON(a);return ca(c,n,r)}return i.effectiveElevationSource}readFarDistance(e,t){let{fardistance:a,fardist:i,layer:r}=t;return a??i??r.farDistance}readHFOV(e,t){let{horizontalfieldofview:a,hfov:i,layer:r}=t;return a??i??r.horizontalFieldOfView}readImageURL(e,t){let{imagepath:a,layer:i}=t;a||Ri("imagePath",this);let{imagePathPrefix:r,imagePathSuffix:n}=i;return ut(a,r,n)}readImageRotation(e,t){let{imagerotation:a,imgrot:i,layer:r}=t;return a??i??r.imageRotation}get isHorizontal(){return this.orientedImageryType==="horizontal"}get isInspection(){return this.orientedImageryType==="inspection"}get isNadir(){return this.orientedImageryType==="nadir"}get isOblique(){return this.orientedImageryType==="oblique"}get isSpherical(){return this.orientedImageryType==="360"}get location(){let{cameraOrientation:e,cameraHeight:t,elevation:a}=this;if(e){let{type:r,x:n,y:c,z:l,horizontalWKID:h,verticalWKID:m}=e,p=typeof h=="number"?{wkid:h}:{wkt:h};if(r===oa.LTP){let{latitude:f,longitude:_,ellipsoidRadius:w,squaredEccentricity:F,properties:P}=e,{x:b,y:M,z:k}=P;return new L(Ta([b,M,k],[f,_,w,F]))}let d=new L({x:n,y:c,z:l,spatialReference:p}),g=m?Jt("point",{wkid:m},p):null;return g&&g(d),d}if(typeof t!="number")throw xi("cameraHeight");let i=this.geometry.clone();return i.z=i.hasZ?i.z:(a??0)+t,i}set matrix(e){if(!e||e.length!==9)return G.getLogger(this).warn("Ignoring rotation matrix because it doesn't have 9 values",{value:e}),void this._set("matrix",null);this._set("matrix",e)}readNearDistance(e,t){let{neardistance:a,neardist:i,layer:r}=t;return a??i??r.nearDistance}readOrientationAccuracy(e,t){let{accuracy:a,orientationaccuracy:i}=t;return i?.split(";").map(Number)??a?.split(";").map(Number)??null}writeOrientationAccuracy(e,t){e&&(t.orientationAccuracy=e.join(";"))}readOIType(e,t){let{orientedimagerytype:a,oitype:i,camerapitch:r,campitch:n,layer:c}=t,l=dt.read(a??i??c.orientedImageryType),h=r??n??c.cameraPitch;return l==="oblique"?h<10?"nadir":"oblique":l}set radial(e){if(e)if(typeof e!="string")this._set("radial",e);else{let[t,a,i]=e.split(";").map(Number);this._set("radial",[t??0,a??0,i??0])}else this._set("radial",[0,0,0])}set tangential(e){if(e)if(typeof e!="string")this._set("tangential",e);else{let[t,a]=e.split(";").map(Number);this._set("tangential",[t??0,a??0])}else this._set("tangential",[0,0])}readVFOV(e,t){let{verticalfieldofview:a,vfov:i,layer:r}=t;return a??i??r.verticalFieldOfView}_parseIfJSON(e){let t=null;try{t=JSON.parse(e)}catch(a){G.getLogger(this).error("couldn't parse the given elevation source JSON",e,a)}return t}};o([s(me())],v.prototype,"a0",void 0),o([s(me())],v.prototype,"a1",void 0),o([s(me())],v.prototype,"a2",void 0),o([s({type:Date,json:{write:{enabled:!0,target:"acquisitionDate"},name:"acquisitiondate"}})],v.prototype,"acquisitionDate",void 0),o([s(me())],v.prototype,"b0",void 0),o([s(me())],v.prototype,"b1",void 0),o([s(me())],v.prototype,"b2",void 0),o([s({type:Number,json:{write:!0,read:{source:["cameraheading","camheading","layer.cameraHeading"]}}})],v.prototype,"cameraHeading",void 0),o([B("cameraHeading")],v.prototype,"readCameraHeading",null),o([s({type:Number,json:{write:!0}})],v.prototype,"cameraHeight",void 0),o([B("cameraHeight",["cameraheight","avghtag","layer.cameraHeight"])],v.prototype,"readCameraHeight",null),o([s()],v.prototype,"cameraOffset",void 0),o([B("cameraOffset",["cameraoffset","camoffset"])],v.prototype,"readCamOffset",null),o([ct("cameraOffset")],v.prototype,"writeCameraOffset",null),o([s({json:{write:{writer:(e,t,a)=>{t[a]=e.toString()}}},type:ra}),Bt(e=>e?wi.getCameraOrientation(e):null)],v.prototype,"cameraOrientation",void 0),o([B("cameraOrientation",["cameraorientation","camori"])],v.prototype,"readCameraOrientation",null),o([s({type:Number,json:{write:!0}})],v.prototype,"cameraPitch",void 0),o([B("cameraPitch",["camerapitch","campitch","layer.cameraPitch"])],v.prototype,"readCameraPitch",null),o([s({type:Number,json:{write:!0}})],v.prototype,"cameraRoll",void 0),o([B("cameraRoll",["cameraroll","camroll","layer.cameraRoll"])],v.prototype,"readCameraRoll",null),o([s({json:{write:!0},type:String})],v.prototype,"depthImage",void 0),o([B("depthImage",["depthimage","depthimg"])],v.prototype,"readDepthImage",null),o([s({type:Number,json:{write:!0}})],v.prototype,"elevation",void 0),o([s({json:{write:!0},clonable:"reference"})],v.prototype,"elevationSource",void 0),o([B("elevationSource",["elevationsource","layer.effectiveElevationSource"])],v.prototype,"readElevationSource",null),o([s({json:{name:"exposurestationid",write:{target:"exposureStationId"}},type:String})],v.prototype,"exposureStationId",void 0),o([s({type:Number,json:{write:!0}})],v.prototype,"farDistance",void 0),o([B("farDistance",["fardistance","fardist","layer.farDistance"])],v.prototype,"readFarDistance",null),o([s(me("focallength"))],v.prototype,"focalLength",void 0),o([s({type:L,json:{name:"geometry"}})],v.prototype,"geometry",void 0),o([s({type:Number,json:{write:!0}})],v.prototype,"horizontalFieldOfView",void 0),o([B("horizontalFieldOfView",["horizontalfieldofview","hfov","layer.horizontalFieldOfView"])],v.prototype,"readHFOV",null),o([s({json:{write:!0},type:String})],v.prototype,"imagePath",void 0),o([B("imagePath",["imagepath"])],v.prototype,"readImageURL",null),o([s({type:Number,json:{write:!0}})],v.prototype,"imageRotation",void 0),o([B("imageRotation",["imagerotation","imgrot","layer.imageRotation"])],v.prototype,"readImageRotation",null),o([s()],v.prototype,"isHorizontal",null),o([s()],v.prototype,"isInspection",null),o([s()],v.prototype,"isNadir",null),o([s()],v.prototype,"isOblique",null),o([s()],v.prototype,"isSpherical",null),o([s()],v.prototype,"location",null),o([s(Rt())],v.prototype,"matrix",null),o([s({json:{write:!0},type:String})],v.prototype,"name",void 0),o([s({type:Number,json:{write:!0}})],v.prototype,"nearDistance",void 0),o([B("nearDistance",["neardistance","neardist","layer.nearDistance"])],v.prototype,"readNearDistance",null),o([s({json:{write:!0,name:"objectid"},type:Number})],v.prototype,"objectId",void 0),o([s()],v.prototype,"orientationAccuracy",void 0),o([B("orientationAccuracy",["accuracy","orientationaccuracy"])],v.prototype,"readOrientationAccuracy",null),o([ct("orientationAccuracy")],v.prototype,"writeOrientationAccuracy",null),o([Ae(dt)],v.prototype,"orientedImageryType",void 0),o([B("orientedImageryType",["orientedimagerytype","oitype","layer.orientedImageryType"])],v.prototype,"readOIType",null),o([s({type:Number,json:{write:!0,read:{source:"principalx"}}})],v.prototype,"principalX",void 0),o([s({type:Number,json:{write:!0,read:{source:"principaly"}}})],v.prototype,"principalY",void 0),o([s(Rt([0,0,0]))],v.prototype,"radial",null),o([s({type:Number,json:{name:"sortorder",write:{target:"sortOrder"}}})],v.prototype,"sortOrder",void 0),o([s({type:Object})],v.prototype,"sourceMap",void 0),o([s(Rt([0,0]))],v.prototype,"tangential",null),o([s({type:Number,json:{write:!0}})],v.prototype,"verticalFieldOfView",void 0),o([B("verticalFieldOfView",["verticalfieldofview","vfov","layer.verticalFieldOfView"])],v.prototype,"readVFOV",null),v=o([T("esri.layers.orientedImagery.core.ExposurePoint")],v);var Qe=v;var Me={},Oi=1e3;function bi(e,t){return y(this,null,function*(){let{point:a,queryParams:i}=e;if(a==null)return null;let r={},n=e.layerInstanceOrURL,c=a.spatialReference.isGeographic?be(a.clone()):a.clone();if(r.outSpatialReference=c.spatialReference,i&&(r.maxRecordCountFactor=i.maxRecordCountFactor??5,r.outFields=i.outFields??["*"],r.where=i.where??"1=1",r.returnGeometry=i.returnGeometry??!0,r.outSpatialReference=i.outSpatialReference),typeof n=="string"&&(Me.layer&&Me.layer.url===n?n=Me.layer:(Me.layer?.destroy(),n=Me.layer=new ma({url:n}))),n)try{yield n.load();let l=n,h=Ai(c,i?.maximumDistance??l.maximumDistance??Oi);r.returnZ=l.hasZ;let m=new Xt(S({geometry:h},r)),p=yield l.queryFeatures(m,t);return Vi(l)(p)}catch(l){zt(l)}return null})}function Vi(e){return t=>{let{features:a,spatialReference:i}=t;return a.forEach(r=>{r.geometry&&(r.geometry.spatialReference=i);let n=Qe.fromJSON(H(S({},r.toJSON()),{layer:e}));n&&(r.attributes=n),r.layer=e,r.spatialReference=i}),t}}function Ai(e,t){let a=e.x-t,i=e.x+t,r=e.y-t,n=e.y+t;return new Zt({xmin:a,xmax:i,ymin:r,ymax:n,spatialReference:e.spatialReference})}function _i(e){let{camera:t,features:a,selectedPoint:i}=e;if(!a.length)return[];e.currentImage??={attributes:{cameraHeading:0,cameraPitch:0}};let r=ki(t,i,e.currentImage);return a.map(r)}function ki(e,t,a){return t.z??=0,t.elevation??=0,i=>{let{hfovWeight:r,vfovWeight:n,distanceWeight:c}=Gi(i.attributes,e?"3d":"2d"),l=i.attributes,{cameraHeight:h,cameraHeading:m,cameraPitch:p,farDistance:d,horizontalFieldOfView:g,verticalFieldOfView:f,isOblique:_}=l,w=l.geometry,F=180*Math.atan2(w.y-t.y,w.x-t.x)/Math.PI,P=Wt(t,w),b,M,k=g,q=f,O=!1;e?(b=e.heading,M=e.tilt,k=180,q=180,O=!0):!_||p<10?(b=m,M=p,O=!1):(b=a.attributes.cameraHeading,M=p,O=!0,k=180),b>180&&(b-=360);let Z=1;w.spatialReference.isWebMercator&&(Z=1/Math.cos(Math.PI/2-2*Math.atan(Math.exp(-1*w.y/jt.radius))));let $=Math.sqrt((Math.sqrt((t.x-w.x)**2+(t.y-w.y)**2)/Z)**2+((t.z??0)-(t.elevation??0)-h)**2),J=90-180*Math.atan2(t.y-w.y,t.x-w.x)/Math.PI,ue=(Math.abs(J-b)>180?Math.abs(360-Math.abs(J-b)):Math.abs(J-b))/k;ue=4*ue+1;let kt=180*Math.acos((l.cameraHeight-(t.z??0)+(t.elevation??0))/$)/Math.PI,at=Math.abs(kt-M)/q;at=4*at+1;let Ie=$/Math.sqrt(d**2+h**2);Ie=4*Ie+1;let Gt=r*ue+n*at+c*Ie,it;if(O){let rt=m>180?m-360:m;it=r*((Math.abs(J-rt)>180?Math.abs(360-Math.abs(J-rt)):Math.abs(J-rt))/g*4+1)+n*(Math.abs(kt-p)/f*4+1)+c*Ie}else it=Gt;return{suitability:Gt,trueSuitability:it,feature:i,angle:F,distance:P,verticalAngle:Math.abs(180*Math.atan(P/h)/Math.PI)}}}function Gi(e,t){let a="isOblique"in e?e:new Qe(e),{isOblique:i,isSpherical:r,isNadir:n}=a;return r?{hfovWeight:t==="2d"?0:1,vfovWeight:t==="2d"?0:.6,distanceWeight:t==="2d"?1:.5}:n?{hfovWeight:.25,vfovWeight:1,distanceWeight:1}:i?{hfovWeight:1,vfovWeight:.25,distanceWeight:1}:{hfovWeight:1,vfovWeight:1,distanceWeight:1}}var Q=class extends ke.ClonableMixin(ae){constructor(e){super(e),this.maxFOV=0,this.minFOV=0,this.view=null,this.zoomFactor=5}get canZoomIn(){return!!this.view&&(this.minFOV===0||this.view.camera.fov>this.minFOV)}get canZoomOut(){return!!this.view&&(this.maxFOV===0||this.view.camera.fov<this.maxFOV)}};o([s({type:Boolean,readOnly:!0})],Q.prototype,"canZoomIn",null),o([s({type:Boolean,readOnly:!0})],Q.prototype,"canZoomOut",null),o([s({type:Number})],Q.prototype,"maxFOV",void 0),o([s({type:Number})],Q.prototype,"minFOV",void 0),o([s()],Q.prototype,"view",void 0),o([s({type:Number})],Q.prototype,"zoomFactor",void 0),Q=o([T("esri.widgets.PanoramicViewer.PanoramicZoomConditions")],Q);var fe=Q;var se=class extends Fa{constructor(e){super(e),this.panoramicZoomConditions=new fe,this.zoomTo=t=>{this.view.camera.fov=this.constrainFOV(t),this.view.camera=this.view.camera.clone()}}initialize(){this.addHandles([I(()=>[this.view?.ready,this.panoramicZoomConditions],()=>{this.view?.ready&&(this.panoramicZoomConditions.view=this.view,this.zoomTo(this.view.camera.fov))},x),I(()=>[this.panoramicZoomConditions.maxFOV,this.panoramicZoomConditions.minFOV],([e,t])=>{e!=null&&t!=null&&this.zoomTo(this.view.camera.fov)},Nt)])}get canZoomIn(){return this.panoramicZoomConditions.canZoomIn}get canZoomOut(){return this.panoramicZoomConditions.canZoomOut}get state(){return this.view?.ready?"ready":"disabled"}set view(e){this._set("view",e)}constrainFOV(e){let{maxFOV:t,minFOV:a}=this.panoramicZoomConditions;return X(e,a,t)}zoomIn(){if(!this.canZoomIn)return;let e=this.view.camera.fov-this.panoramicZoomConditions.zoomFactor;this.zoomTo(e)}zoomOut(){if(!this.canZoomOut)return;let e=this.view.camera.fov+this.panoramicZoomConditions.zoomFactor;this.zoomTo(e)}};o([s()],se.prototype,"canZoomIn",null),o([s()],se.prototype,"canZoomOut",null),o([s({type:fe})],se.prototype,"panoramicZoomConditions",void 0),o([s()],se.prototype,"state",null),o([s()],se.prototype,"view",null),se=o([T("esri.widgets.PanoramicViewer.PanoramicZoomViewModel")],se);var Pi=se;function Fi(e,t=Ze,a=za){let i=t.clone();i.z=-500;let r=ia.createSphere(i,{size:a,densificationFactor:2,vertexSpace:"georeferenced",material:new aa({colorTexture:new ta({data:e})})});if(r.components[0].trustSourceNormals=!0,r.vertexAttributes.uv){let n=r.vertexAttributes.uv.length??0;for(let c=0;c<n;c++)r.vertexAttributes.uv[2*c+0]=1-r.vertexAttributes.uv[2*c+0],r.vertexAttributes.uv[2*c+1]=r.vertexAttributes.uv[2*c+1]}return r.centerAt(i),r}function Mi(e){return new R({geometry:e,symbol:new ea({symbolLayers:new z([new Qt])})})}function et(e,t){return 2*_e(Math.atan(Math.tan(ne(e/2))*Math.sqrt(t**2+1)))}var ve={autoLoad:"auto-load",default:"default",navigation:"navigation",fovConstraint:"fov-constraint",clickAction:"image-click-action"},V=class extends de.EventedAccessor{constructor(e){super(e),this._startPosition=null,this._targetPosition=null,this._graphics=new re({elevationInfo:{mode:"relative-to-ground"}}),this._imageGraphic=null,this._loadController=null,this._map=new Le({ground:new fa({opacity:0,navigationConstraint:null}),layers:new z([this._graphics])}),this._zoomViewModel=null,this.autoLoad=!1,this.clickAction="none",this.imageSize=null,this.imageSource=null,this.pitch=90,this.state="ready",this.yaw=0,this._addNavigationHandles=()=>{this.imageRenderer.basemapTerrain.suspended=!0,this.imageRenderer.constraints.tilt.max=180,this.removeHandles(ve.navigation),this.addHandles([this.imageRenderer.on("mouse-wheel",this._handleWheel),this.imageRenderer.on("double-click",this._handleDoubleClick),this.imageRenderer.on("drag",this._handleDrag),this.imageRenderer.on("key-down",t=>{let a=["+","-","Shift","_","=","ArrowUp","ArrowDown","ArrowRight","ArrowLeft"],i=t.key;a.includes(i)&&t.stopPropagation()})],ve.navigation)},this._addHFOVHandles=()=>{this.removeHandles(ve.fovConstraint),this.addHandles(I(()=>[this.maxHFOV,this.minHFOV],()=>{this._zoomViewModel&&(this._zoomViewModel.panoramicZoomConditions=new fe({view:this.imageRenderer,maxFOV:this.maxHFOV,minFOV:this.minHFOV}))},x),ve.fovConstraint)},this._addZoomHandles=()=>{this._zoomViewModel=new Pi({view:this.imageRenderer,panoramicZoomConditions:new fe({maxFOV:this.maxHFOV,minFOV:this.minHFOV})});let t=this.imageRenderer.ui.find("zoom");t&&(t.viewModel=this._zoomViewModel),this._addHFOVHandles()},this._cancelLoadWithController=()=>{this._loadController?.abort(),this._loadController=null},this._handleDoubleClick=t=>{t.stopPropagation(),t.native.ctrlKey?this._zoomOut():this._zoomIn()},this._handleDrag=t=>{t.stopPropagation();let{action:a,x:i,y:r}=t;switch(a){case"start":this._startPosition=this._targetPosition={x:i,y:r};break;case"update":this._targetPosition={x:i,y:r},this._updateCameraHeadingAndTilt()}},this._handleImageClick=t=>{if(this.state==="image-loaded"&&this.imageRenderer.ready)switch(this.clickAction){case"emit":t.stopPropagation(),this.emit("click",t);break;case"hittest":t.stopPropagation(),t.async(()=>y(this,null,function*(){let a=yield this.imageRenderer.hitTest(t.screenPoint,{include:this._graphics});this.emit("hittest-response",a)}));break;case"pixel-location":{if(t.stopPropagation(),!this.imageSize||!t.mapPoint)return void this.emit("pixel-location",null);let a=Da(t.mapPoint,this.imageSize[0],this.imageSize[1]);this.emit("pixel-location",H(S({},a),{spatialReference:D.WebMercator}));break}}},this._handleWheel=t=>{let a=t.deltaX??t.native.deltaX;t.stopPropagation(),a>0||t.deltaY>0?this._zoomOut():this._zoomIn()},this._loadWithController=()=>{this._cancelLoadWithController(),this._loadController=new AbortController,this.loadImage(this._loadController)},this._zoomIn=()=>this._zoomViewModel?.zoomIn(),this._zoomOut=()=>this._zoomViewModel?.zoomOut(),this.addGraphic=(t,a)=>this.state==="image-loaded"&&!this._graphics.graphics.includes(t)&&(this._graphics.graphics.add(t,a),!0),this.addManyGraphics=t=>{if(this.state!=="image-loaded")return!1;let a=t.filter(i=>!this._graphics.graphics.includes(i));return this._graphics.graphics.addMany(a),!0},this.clearGraphics=()=>{this._graphics.graphics.removeAll()},this.clearImage=()=>{this.imageSize=null,this._removeImageSphere()},this.removeGraphic=t=>!(this.state!=="image-loaded"||!this._graphics.graphics.includes(t))&&(this._graphics.remove(t),!0),this.removeManyGraphics=t=>{if(this.state!=="image-loaded")return!1;let a=t.filter(i=>this._graphics.graphics.includes(i));return this._graphics.removeMany(a),!0},this._imageRenderer=new Ma({map:this._map,viewingMode:"local",camera:{position:Ze},environment:{atmosphereEnabled:!1,starsEnabled:!1,lighting:{type:"virtual"}},popupEnabled:!1,spatialReference:D.WebMercator,ui:{components:["zoom"]}})}destroy(){this._imageRenderer.destroy()}initialize(){this.state="initialized",this.addHandles([I(()=>this.imageSource,()=>{this.imageSource&&this.autoLoad&&this._loadWithController()},x),I(()=>this.fov,()=>{this._reloadCamera()},x),I(()=>this.yaw,e=>{this.camera.heading=e,this._reloadCamera()},x),I(()=>this.pitch,e=>{this.camera.tilt=e,this._reloadCamera()},x),Dt(()=>this.imageRenderer.ready,()=>{this._addNavigationHandles(),this._addZoomHandles()},x),I(()=>this.clickAction,e=>{this.removeHandles(ve.clickAction),e!=="none"&&this.addHandles(this.imageRenderer.on("click",this._handleImageClick))},x)],ve.default)}get camera(){return this.imageRenderer.camera}set camera(e){e&&(this.imageRenderer.camera=e.clone())}get fov(){return this.camera.fov}set fov(e){Number.isFinite(e)&&this._zoomViewModel?.zoomTo(e)}get hfov(){let{fov:e}=this.camera,{size:[t,a]}=this.imageRenderer,i=t/a,r=Math.atan(i);return 2*_e(Math.atan(Math.tan(ne(e/2))*Math.sin(r)))}get imageRenderer(){return this._imageRenderer}get maxHFOV(){let{size:[e,t]}=this.imageRenderer;return et(Ha,e/t)}get minHFOV(){let{size:[e,t]}=this.imageRenderer;return et(Ea,e/t)}get vfov(){let{fov:e}=this.camera,{size:[t,a]}=this.imageRenderer,i=t/a,r=Math.atan(i);return 2*_e(Math.atan(Math.tan(ne(e/2))*Math.cos(r)))}_loadImageInternal(e,t){return y(this,null,function*(){let a;this.state="image-loading";try{a=(yield Re(e,S({responseType:"image"},t))).data}catch(i){throw U(i)?this.state="image-load-aborted":this.state="image-load-error",i}return this._updateImageSphere(a,t)})}_reloadCamera(){this.camera=this.camera.clone()}_removeImageSphere(){this._imageGraphic&&(this._graphics.remove(this._imageGraphic),this._imageGraphic=E(this._imageGraphic)),this.state="ready",this.imageSize=null}_updateCameraHeadingAndTilt(){if(!this._startPosition||!this._targetPosition)return;let e=this.camera.heading+(this._startPosition.x-this._targetPosition.x)/this.imageRenderer.width*this.camera.fov;this.yaw=(e+360)%360;let t=this.camera.tilt-(this._startPosition.y-this._targetPosition.y)/this.imageRenderer.height*this.imageRenderer.camera.tilt;this.pitch=Math.min(179.5,Math.max(.5,t)),this._startPosition=this._targetPosition}_updateImageSphere(e,t){return y(this,null,function*(){yield xe(t);let{size:[a,i]}=this.imageRenderer;return this._imageGraphic=Mi(Fi(e)),this._graphics.add(this._imageGraphic),this.fov=et(La,a/i),this.state="image-loaded",this.imageSize=[e.width,e.height],this._imageGraphic.geometry})}loadImage(e){return y(this,null,function*(){return this._removeImageSphere(),this.imageSource?this._loadImageInternal(this.imageSource,e):je(this.declaredClass,new N(Ne("panoramic-viewer"),Be("PanoramicViewerViewModel","imageSource")))})}};o([s()],V.prototype,"_graphics",void 0),o([s()],V.prototype,"_imageGraphic",void 0),o([s()],V.prototype,"_imageRenderer",void 0),o([s()],V.prototype,"_loadController",void 0),o([s()],V.prototype,"_map",void 0),o([s()],V.prototype,"_zoomViewModel",void 0),o([s({type:Boolean})],V.prototype,"autoLoad",void 0),o([s({type:ze})],V.prototype,"camera",null),o([Ae(new Et({emit:"emit",hittest:"hittest",none:"none","pixel-location":"pixel-location"}))],V.prototype,"clickAction",void 0),o([s({type:Number})],V.prototype,"fov",null),o([s({readOnly:!0})],V.prototype,"hfov",null),o([s({readOnly:!0})],V.prototype,"imageRenderer",null),o([s()],V.prototype,"imageSize",void 0),o([s()],V.prototype,"imageSource",void 0),o([s({readOnly:!0})],V.prototype,"maxHFOV",null),o([s({readOnly:!0})],V.prototype,"minHFOV",null),o([s({type:Number})],V.prototype,"pitch",void 0),o([s()],V.prototype,"state",void 0),o([s({readOnly:!0})],V.prototype,"vfov",null),o([s({type:Number})],V.prototype,"yaw",void 0),V=o([T("esri.widgets.PanoramicViewer.PanoramicViewerViewModel")],V);var Ot=V;var zi="esri-panoramic-viewer",j=class extends Oe{constructor(e){super(e),this.viewModel=new Ot,this._afterContainerCreate=t=>{this.imageRenderer.container=t},this.addGraphic=(t,a)=>{this.viewModel.addGraphic(t,a)},this.addManyGraphics=t=>{this.viewModel.addManyGraphics(t)},this.clearGraphics=()=>{this.viewModel.clearGraphics()},this.clearImage=()=>{this.viewModel.clearImage()},this.loadImage=t=>this.viewModel.loadImage(t),this.removeGraphic=t=>{this.viewModel.removeGraphic(t)},this.removeManyGraphics=t=>{this.viewModel.removeManyGraphics(t)}}get autoLoad(){return this.viewModel.autoLoad}set autoLoad(e){this.viewModel.autoLoad=e}get camera(){return this.viewModel.camera}set camera(e){e&&(this.viewModel.camera=e)}get clickAction(){return this.viewModel.clickAction}set clickAction(e){this.viewModel.clickAction=e}get fov(){return this.camera.fov}set fov(e){this.viewModel.fov=e}get hfov(){return this.viewModel.hfov}get icon(){return"i360-view"}set icon(e){this._overrideIfSome("icon",e)}get imageRenderer(){return this.viewModel.imageRenderer}get imageSize(){return this.viewModel.imageSize}get imageSource(){return this.viewModel.imageSource}set imageSource(e){this.viewModel.imageSource=e}get pitch(){return this.viewModel.pitch}set pitch(e){this.viewModel.pitch=e}get state(){return this.viewModel.state}get vfov(){return this.viewModel.vfov}get yaw(){return this.viewModel.yaw}set yaw(e){this.viewModel.yaw=e}render(){return Ve("div",{afterCreate:this._afterContainerCreate,bind:this,class:this.classes(He.widget,zi)})}};o([s({type:Boolean})],j.prototype,"autoLoad",null),o([s({type:ze})],j.prototype,"camera",null),o([s()],j.prototype,"clickAction",null),o([s({type:Number})],j.prototype,"fov",null),o([s({readOnly:!0,type:Number})],j.prototype,"hfov",null),o([s()],j.prototype,"icon",null),o([s({readOnly:!0})],j.prototype,"imageRenderer",null),o([s({readOnly:!0})],j.prototype,"imageSize",null),o([s()],j.prototype,"imageSource",null),o([s({type:Number})],j.prototype,"pitch",null),o([s({readOnly:!0})],j.prototype,"state",null),o([s({readOnly:!0,type:Number})],j.prototype,"vfov",null),o([Ee(["click","hittest-response","pixel-location"]),s({type:Ot})],j.prototype,"viewModel",void 0),o([s({type:Number})],j.prototype,"yaw",null),j=o([T("esri.widgets.PanoramicViewer")],j);var Ii=j;var tt=e=>e==="FA",Vt=(e,t,a)=>y(void 0,null,function*(){let i=new(yield import("./chunk-NHJUSBFD.js").then(l=>l.default))({objectIds:[t]}),r=yield e.queryAttachments(i,a),n=r[`${t}`]?.[0],c=n?.url;if(!c)throw new N("NoAttachmentError","no attachments found",{[e.objectIdField]:t,layer:e});return{datasetFormat:n.contentType.split("/")[1].toUpperCase(),url:c}});function Li(e,t){return y(this,null,function*(){let a=typeof e=="string",i=a?e:e.url,{pathname:r,searchParams:n,origin:c}=new URL(i),l=a?Lt(r):e.datasetFormat;l||(l=yield We(i));let h=yield import("./chunk-DI4WT4OE.js").then(p=>p.default),m=yield h.open({ioConfig:{customFetchParameters:Object.fromEntries(n),skipMapInfo:!0},datasetFormat:l?.toUpperCase(),url:`${c}${r}`,signal:t?.signal});return m?Hi(m,{signal:t?.signal}):null})}function Hi(e,t){return y(this,null,function*(){let{level:a,offset:i,size:r}=Ei(e),{pixelBlock:n}=yield e.fetchRawPixels(a,i,r,t);return C(t),n})}function Ei(e){let{storageInfo:t,width:a,height:i}=e.rasterInfo,{maximumPyramidLevel:r,pyramidScalingFactor:n}=t,c=n??2;return{level:r,offset:{x:0,y:0},size:{width:Math.ceil(a/c**r),height:Math.ceil(i/c**r)}}}function ps(e,t,a){return y(this,null,function*(){if(!e)throw new N("NoLayerError","No layer provided, cannot load image from attachment",{layer:e,objectId:t});let{datasetFormat:i,url:r}=yield Vt(e,+t,a);return xa(i)?yield Li({datasetFormat:i,url:r},a):(yield Re(r,H(S({},a),{useRequestQueue:!0,responseType:"image",query:{w:Ia}}))).data})}function us(e,t,a=0){let{height:i,width:r}=e;t.width=r,t.height=i;let n=t.getContext("2d");if(!n)return;let c=Ti(e,t,n);c.getContext("2d")&&(a>0?Di(n,c,r,i,a):n.drawImage(c,0,0))}function Ti(e,t,a){let i=document.createElement("canvas"),r=i.getContext("2d");if(e instanceof HTMLImageElement)i.width=e.width,i.height=e.height,r?.drawImage(e,0,0);else{let n=a.createImageData(t.width,t.height);n&&(n.data.set(e.getAsRGBA()),i.width=n.width,i.height=n.height,r?.putImageData(n,0,0))}return i}function Di(e,t,a,i,r){let n=ne(r),c=[Pe(0,0,n),Pe(a,0,n),Pe(a,i,n),Pe(0,i,n)],l=Math.max(...c.map(p=>p[0]))-Math.min(...c.map(p=>p[0])),h=Math.max(...c.map(p=>p[1]))-Math.min(...c.map(p=>p[1])),m=Math.min(a/l,i/h);e.save(),e.clearRect(0,0,a,i),e.translate(a/2,i/2),e.rotate(n),e.scale(m,m),e.drawImage(t,-a/2,-i/2,a,i),e.restore()}var Si={click:"click-handle",enhancements:"enhancements-handle",rotation:"rotation-handle"},A=class extends de.EventedAccessor{constructor(e){super(e),this._imageChanged=!1,this._panConstraint=null,this._image=null,this._loadController=null,this._overlays=new re({blendMode:"source-atop"}),this._map=new Le,this.autoLoad=!1,this.clickAction="none",this.error=null,this.imageSource=null,this.imageRotation=0,this.state="ready",this._cancelLoadWithController=()=>{this._loadController?.abort(),this._loadController=null},this._createImageHandles=()=>{this.removeHandles(Si.enhancements),this.addHandles(I(()=>[this.brightness,this.contrast,this.sharpness],([t,a,i])=>{this.image?.loaded&&(this.image.effect=`contrast(${10*(a+10)}%) brightness(${10*(t+10)}%)`,this.sharpenImage(this.image,i))},x))},this._createPanConstraint=()=>{let{image:t,imageRenderer:a}=this,i=r=>{if(!(t&&a&&r.targetGeometry&&t.serviceRasterInfo))return r;let{extent:n}=t.serviceRasterInfo,{constraints:c,rotation:l,width:h,height:m}=a,{extent:p}=Ge(Y.fromExtent(n),l),{width:d,height:g}=p,f=r.targetGeometry.clone(),_=c.scaleToZoom(r.scale),w=1/2**_,F=h/m,P=w*d,b=w*g;_&&(d/h>g/m?b=P/F:P=b*F);let M=p.clone();return M.xmin+=P/2,M.xmax-=P/2,M.ymin+=b/2,M.ymax-=b/2,r.targetGeometry=ua(M,f).coordinate,this.state="image-loaded",r};return{constrain:i,applyPanConstraint:i}},this._createResizeHandles=t=>{t.removeHandles("resize"),t.addHandles(I(()=>{if(!this.imageRenderer.ready)return;let{extent:a}=t.serviceRasterInfo,{width:i,height:r,rotation:n}=this.imageRenderer,{extent:c}=Ge(Y.fromExtent(a),n),{width:l,height:h}=c;return Math.max(l/i,h/r)},a=>{if(!this.imageRenderer||a==null)return;let{constraints:i,scale:r,spatialReference:n}=this.imageRenderer,c=i.minScale,l=va(n),h=.25*l,m=l*a,p=m,d=[];for(;p>h;)d.push(p),p/=2;d.push(p);let{lods:g}=qt.create({scales:d});if(i.set({minScale:m,lods:g}),this._imageChanged)return this.imageRenderer.scale=m,void(this._imageChanged=!1);this.imageRenderer.scale=Math.abs(r-c)<=1e-6?m:r},x),"resize")},this._loadImageInternal=(t,a={})=>{this.state="image-loading",this.clearImage(),this.error=null,this._imageChanged=!0;let i=typeof t=="string",r=i?void 0:t.datasetFormat,n=i?t:t.url,{customParameters:c,options:l}=a;return this._image=new ya({ioConfig:{skipExtensions:["aux.xml","jgw"],skipMapInfo:!0,datasetFormat:r},url:n,customParameters:c}),this._image.when(h=>y(this,null,function*(){this._updatePanConstraint(),this._createResizeHandles(h),this._map.add(h),this.state="image-loaded"}),h=>{U(h)?this.state="image-load-aborted":(this.state="image-load-error",this.error=h,G.getLogger(this).error(`error occurred while loading image ${i?t:JSON.stringify(t)}`,h),this.imageSource=null)}),this._image.load(l)},this._loadWithController=()=>{this._cancelLoadWithController(),this._loadController=new AbortController,this.loadImage(this._loadController)},this._updatePanConstraint=()=>{this._panConstraint&&this.imageRenderer.constraints.customConstraints.remove(this._panConstraint),this._panConstraint=this._createPanConstraint(),this.imageRenderer.constraints.customConstraints.add(this._panConstraint)},this.addGraphic=(t,a)=>{this._overlays.graphics.add(t,a)},this.addManyGraphics=t=>{this._overlays.addMany(t)},this.clearGraphics=()=>{this._overlays.graphics.removeAll()},this.clearImage=()=>{this.image&&(this._map.layers.remove(this.image),this._image=E(this._image))},this.loadImage=t=>{let{customParameters:a,imageSource:i}=this;return i?this._loadImageInternal(i,{customParameters:a,options:t}):je(this.declaredClass,new N(Ne("image-viewer"),Be("ImageViewerViewModel","imageSource")))},this.removeGraphic=t=>{this._overlays.remove(t)},this.removeManyGraphics=t=>{this._overlays.removeMany(t)},this._imageRenderer=new Te({constraints:{snapToZoom:!0,rotationEnabled:!1},map:this._map,popupEnabled:!1,spatialReference:D.WebMercator,ui:{components:["zoom"]}})}destroy(){this._imageRenderer.destroy()}initialize(){this.state="initialized",this.addHandles([I(()=>this.imageSource,e=>{e&&this.autoLoad&&this._loadWithController()},x),I(()=>this.image?.loaded,()=>{this._createImageHandles()}),I(()=>this.imageRotation,()=>{this._rotateImage()}),I(()=>this.imageRenderer.map,(e,t)=>{t?.layers.remove(this._overlays),e?.layers.add(this._overlays)},we),I(()=>this.imageRenderer.map.allLayers.length,e=>{e&&this.imageRenderer.map.layers.reorder(this._overlays,e-1)},x),I(()=>this.clickAction,e=>{this.removeHandles(Si.click),e!=="none"&&this.addHandles(this.imageRenderer.on("click",t=>{if(this.image?.loaded&&this.imageRenderer.ready)switch(e){case"emit":t.stopPropagation(),this.emit("click",t);break;case"hittest":t.stopPropagation(),t.async(()=>y(this,null,function*(){let a=yield this.imageRenderer.hitTest(t.screenPoint,{include:this._overlays});this.emit("hittest-response",a)}));break;case"pixel-location":{if(t.stopPropagation(),!this.image?.serviceRasterInfo||!t.mapPoint)return void this.emit("pixel-location",null);let{extent:a,pixelSize:i}=this.image.serviceRasterInfo,r=(t.mapPoint.x-a.xmin)*i.x,n=(a.ymax-t.mapPoint.y)*i.y,c=new L({x:r,y:n,spatialReference:a.spatialReference});this.emit("pixel-location",c);break}}}))},x)])}get brightness(){return this._get("brightness")??0}set brightness(e){this._set("brightness",X(e,-10,10))}get contrast(){return this._get("contrast")??0}set contrast(e){this._set("contrast",X(e,-10,10))}get image(){return this._image}get imagePointsInView(){let{extent:e,ready:t}=this.imageRenderer,a=this.imageRotation,i=this.image?.fullExtent,r=this.image?.serviceRasterInfo,n=this._imageRenderer.allLayerViews.find(({layer:p})=>p===this.image)?.attached===!0;if(!(t&&e&&i&&r&&n))return null;let c=Ge(Y.fromExtent(e),a),l=Y.fromExtent(i),h=pa(c,l),{rings:m}=h;return m.flat().map(([p,d])=>({x:(p-r.extent.xmin)*r.pixelSize.x,y:(r.extent.ymax-d)*r.pixelSize.y}))}get imageSize(){let{image:e}=this;if(!e?.raster)return null;let{width:t,height:a}=e.raster.rasterInfo;return[t,a]}get imageRenderer(){return this._imageRenderer}get imageView(){return this.imageRenderer.allLayerViews.find(e=>e.layer===this.image)}get sharpness(){return this._get("sharpness")??0}set sharpness(e){this._set("sharpness",X(e,0,1))}_rotateImage(){this.imageRenderer.constraints.rotationEnabled=!0,this.imageRenderer.rotation=this.imageRotation,this.imageRenderer.constraints.rotationEnabled=!1}sharpenImage(e,t){if(!t)return void(e.rasterFunction=null);let a=[0,-1*t,0,-1*t,4*t+1,-1*t,0,-1*t,0],i=new ga({functionName:"Convolution",functionArguments:{type:gt.userDefined,cols:3,rows:3,kernel:a,convolutionType:gt.userDefined}});e.rasterFunction=i}};o([s()],A.prototype,"_image",void 0),o([s()],A.prototype,"_imageRenderer",void 0),o([s()],A.prototype,"_loadController",void 0),o([s()],A.prototype,"_overlays",void 0),o([s()],A.prototype,"_map",void 0),o([s({type:Boolean})],A.prototype,"autoLoad",void 0),o([s({type:Number})],A.prototype,"brightness",null),o([s()],A.prototype,"clickAction",void 0),o([s({type:Number})],A.prototype,"contrast",null),o([s({type:Object})],A.prototype,"customParameters",void 0),o([s({type:N})],A.prototype,"error",void 0),o([s({readOnly:!0})],A.prototype,"image",null),o([s({readOnly:!0})],A.prototype,"imagePointsInView",null),o([s({readOnly:!0})],A.prototype,"imageSize",null),o([s({cast:Va})],A.prototype,"imageSource",void 0),o([s({readOnly:!0})],A.prototype,"imageRenderer",null),o([s({type:Number})],A.prototype,"imageRotation",void 0),o([s()],A.prototype,"imageView",null),o([s({type:Number})],A.prototype,"sharpness",null),o([s()],A.prototype,"state",void 0),A=o([T("esri.widgets.OrientedImageryViewer.components.ImageViewerViewModel")],A);var At=A;var Ni="esri-image-viewer",W=class extends Oe{constructor(){super(...arguments),this.viewModel=new At,this._afterContainerCreate=e=>{this.imageRenderer.container=e},this.addGraphic=(e,t)=>{this.viewModel.addGraphic(e,t)},this.addManyGraphics=e=>{this.viewModel.addManyGraphics(e)},this.clearGraphics=()=>{this.viewModel.clearGraphics()},this.clearImage=()=>{this.viewModel.clearImage()},this.loadImage=e=>y(this,null,function*(){return this.viewModel.loadImage(e)}),this.removeGraphic=e=>{this.viewModel.removeGraphic(e)},this.removeManyGraphics=e=>{this.viewModel.removeManyGraphics(e)}}get autoLoad(){return this.viewModel.autoLoad}set autoLoad(e){this.viewModel.autoLoad=e}get brightness(){return this.viewModel.brightness}set brightness(e){this.viewModel.brightness=e}get clickAction(){return this.viewModel.clickAction}set clickAction(e){this.viewModel.clickAction=e}get contrast(){return this.viewModel.contrast}set contrast(e){this.viewModel.contrast=e}get customParameters(){return this.viewModel.customParameters}set customParameters(e){this.viewModel.customParameters=e}get error(){return this.viewModel.error}get imageSize(){let e=this.viewModel.image?.serviceRasterInfo;return e?[e.width,e.height]:[0,0]}get imagePointsInView(){return this.viewModel.imagePointsInView}get imageRenderer(){return this.viewModel.imageRenderer}get imageRotation(){return this.viewModel.imageRotation}set imageRotation(e){this.viewModel.imageRotation=e}get imageSource(){return this.viewModel.imageSource}set imageSource(e){this.viewModel.imageSource=e}get sharpness(){return this.viewModel.sharpness}set sharpness(e){this.viewModel.sharpness=e}get state(){return this.viewModel.state}render(){return Ve("div",{afterCreate:this._afterContainerCreate,bind:this,class:this.classes(He.widget,Ni)})}};o([s({type:Boolean})],W.prototype,"autoLoad",null),o([s({type:Number}),s()],W.prototype,"brightness",null),o([s()],W.prototype,"clickAction",null),o([s({type:Number})],W.prototype,"contrast",null),o([s({type:Object})],W.prototype,"customParameters",null),o([s({readOnly:!0})],W.prototype,"error",null),o([s()],W.prototype,"imageSize",null),o([s({readOnly:!0})],W.prototype,"imagePointsInView",null),o([s({readOnly:!0,type:Te})],W.prototype,"imageRenderer",null),o([s()],W.prototype,"imageRotation",null),o([s()],W.prototype,"imageSource",null),o([Ee(["click","hittest-response","pixel-location"]),s({type:At})],W.prototype,"viewModel",void 0),o([s({type:Number})],W.prototype,"sharpness",null),o([s({readOnly:!0})],W.prototype,"state",null),W=o([T("esri.widgets.OrientedImageryViewer.components.ImageViewer")],W);var Ci=W;var ee={click:"view-click",imageClick:"image-click",interactionHandles:"interaction-handles",footprintHandles:"footprint-handles",sketchHandles:"sketch-handles"},Bi=new Set(["JPG","JPEG"]),ji=/\.(\w+)$/,pe=()=>new N("orientedimageryviewer:sketch-not-initialized","Sketch property is not initialized, call loadSketch first"),u=class extends de.EventedMixin(Tt){constructor(e){super(e),this.additionalFeatures=new z,this.additionalCameraLocations=new z,this.additionalFootprints=new z,this.areaMeasurementResult=0,this.areaMeasurementAccuracy=0,this.bestFeatureAngle=0,this.bestFeatureCurrentFootprint=null,this.bestFeatureFootprint=null,this.collectionId=null,this.conversionProps=null,this.coverageFrustums=new z,this.coveragePolygons=new z,this.currentBestFeature=null,this.currentBestFeatureLocation=null,this.currentCoverageVisible=!0,this.determineWorkflowForFeature=(t,a,i)=>y(this,null,function*(){let{currentBestFeature:r,selectedPoint:n,view:c}=this;if(c?.closePopup(),r&&n){this._initialCurrentCoverageUpdate=!0,this._updateGroundElevation=!0;try{yield this._updatePointsAndPolygons(i),yield this._loadImage(i)}catch(l){U(l)||(this.loadImageError(l),G.getLogger(this).error("#loadIImage()","error occured while loading image",l))}}}),this.disabled=!1,this.displayMessage={key:"onLoadMessage",type:"info"},this.displayNewMeasurementButton=!0,this.distanceMeasurementResult=0,this.distanceAccuracyArray=[],this.dataCaptureLayer=null,this.features=new z,this.groundCoordinates=null,this.heightMeasurementPixels=[],this.heightGraphic=null,this.heightMeasurementResult=0,this.heightMeasurementAccuracy=0,this.measurementAngle=null,this.tempDistance=null,this.imageGeometryField=null,this.imageLocationToolState=!1,this.isAdditionalCoverageVisible=!1,this.isAdditionalPointSourcesVisible=!1,this.layer=null,this.localPort=null,this.mapImageConversionToolState=!1,this.measureType=null,this.measurementGraphic=null,this.navigatorCurrentBestFeature=null,this.oiObjectIdField=null,this.overlayedCameraLocations=new z,this.overlayedMapFeatures=new Ht,this.pixelCoordinates=null,this.pointSources=new z,this.previousFeatureAngle=0,this.selectedPoint=null,this.shouldShowSelectedImage=!1,this.sketch=null,this.draw=null,this.sketchAdapter=null,this.updateFootprint=(t,a)=>y(this,null,function*(){this.state==="image-loaded"&&(yield this._adapter?.updateFootprint(t,a))}),this.updateFootprintPanorama=(t,a)=>y(this,null,function*(){yield this._adapter?.updateFootprintPanorama(t,a)}),this._adapter=null,this._highlightedFeatureHandle=null,this._imageViewer=new Ci,this._initialCurrentCoverageUpdate=!0,this._locationPointOnImage=null,this._overlays=new re({listMode:"hide",internal:!0,elevationInfo:{mode:"absolute-height"}}),this._panoramicViewer=new Ii,this._previousCursor=null,this._referencePointOnGround=null,this._referencePointOnImage=null,this._sectorData=null,this._updatingHandles=new Kt,this._clickTask=null,this._crossSymbol=null,this.footprintExtent=null,this._featureChangedTask=null,this._openPopupTask=null,this._suitabilities=null,this._transformController=new AbortController,this._updateFootprintTask=null,this._updateGroundElevation=!1,this.hideImageGeometry=t=>{},this.highlight=t=>{if(!this._overlaysView)return;this.removeHighlight();let a=this.additionalFootprints.find(({attributes:{imageID:i}})=>i===Number(t));this._highlightedFeatureHandle=a?this._overlaysView?.highlight(a):null},this.loadDataCaptureAdapter=t=>y(this,null,function*(){yield this.loadSketch(t);let a=import("./chunk-AROQBUFG.js"),{default:i}=yield a;return C(t),this.sketchAdapter=new i({viewModel:this}),this.sketchAdapter}),this.loadImageFromSource=(t,a)=>y(this,null,function*(){return this._updatingHandles.addPromise(this._loadImageFromSourceInternal(t,a))}),this.loadImageViewer=t=>{this._imageViewer.container=t},this.loadPanoramicViewer=t=>{this._panoramicViewer.container=t},this.removeHighlight=()=>this._highlightedFeatureHandle?.remove(),this.revealImageGeometry=t=>{},this.toggleImageAttributes=()=>{te(this._openPopupTask),this._openPopupTask=ie(t=>y(this,null,function*(){let{currentBestFeature:a,popupEnabled:i,layer:r,view:n}=this;if(n?.closePopup(),!(n&&a&&i&&r))return;let{attributes:c,geometry:l}=a,h=new R({geometry:l,attributes:c.toJSON(),layer:r});C(t),yield n.openPopup({features:[h],location:c.location.clone()})}))},this._createViewClickHandle=()=>{if(this.removeHandles(ee.click),this.state==="disabled"||this.view==null)return;let t=this.mapImageConversionToolState&&this.state==="image-loaded"?this._mapImageConversionToolViewClickHandler:this._viewClickHandler;this.addHandles(this.view.on("click",t,wa.WIDGET),ee.click)},this._createImageClickHandle=()=>{this.removeHandles(ee.imageClick);let{mapImageConversionToolState:t,mode:a,activeViewer:i,currentBestFeature:r,footprintExtent:n}=this,c=i?.imageSize;if(!(t&&a!=="none"&&c&&n&&r))return;i.clickAction="pixel-location";let l=null,h=lt(()=>i,"pixel-location",m=>{this.plotReferencePointOnImage(m),l?.abort(),l=ie(p=>y(this,null,function*(){if(!m)return;let d=yield this.getMapPoint(m,{feature:r,imageSize:c,mode:a}).then(g=>{let f=this.view?.spatialReference;return Ba(!f,g.spatialReference.equals(f))?g:K(g,f)});C(p),this.plotReferencePointOnGround(d)}))});this.addHandles(h,ee.imageClick)},this._createImageLocationHandle=()=>{this.removeHandles(ee.imageClick);let{imageLocationToolState:t,mode:a,activeViewer:i,currentBestFeature:r,footprintExtent:n}=this,c=i?.imageSize;if(!(t&&a!=="none"&&c&&n&&r))return;i.clickAction="pixel-location";let l=null,h=lt(()=>i,"pixel-location",m=>{this.pixelCoordinates=m,this.plotLocationPointOnImage(m),l?.abort(),l=ie(p=>y(this,null,function*(){if(!m)return;let d=yield this.getMapPoint(m,{feature:r,imageSize:c,mode:a});C(p);let g=this.view?.spatialReference;g&&!d.spatialReference.equals(g)&&(d=yield K(d,g),C(p)),this.groundCoordinates=d}))});this.addHandles(h,ee.imageClick)},this._loadImage=t=>y(this,null,function*(){let{currentBestFeature:a,layer:i,mode:r}=this;if(this.clearGraphics(),!i||!a||r==="none")return;let{attributes:n}=a,{imagePath:c,imageRotation:l,cameraHeading:h,cameraRoll:m,cameraPitch:p,objectId:d,cameraOrientation:g,location:f}=n,_=(m??0)+(l??0),w=f.spatialReference.isWGS84&&g?.type!==4?be(f):new L(f),F=c;if(tt(c))try{F=yield Vt(i,d,t)}catch(P){return U(P)?void 0:ka(P)?(G.getLogger(this).error(P),void this.setMessage("noAttachment","error",`${i.objectIdField}: ${d}`)):(G.getLogger(this).error(P,{[i.objectIdField]:d,layer:i}),void this.setMessage("imageLoadError","error",`query-attachments-failed:${i.objectIdField} ${d}`))}try{yield this.loadImageFromSource(F,{imageRotation:_,options:t,pitch:p,yaw:h,mode:r,cameraLocation:w}),C(t),yield this.transformAndPlotSelectedLocation(t)}catch(P){U(P)||this.loadImageError(P)}}),this._loadImageFromSourceInternal=(t,a)=>y(this,null,function*(){let{mode:i,imageRotation:r,options:n}=a,c=typeof t=="string",l=c?t:t.url,{pathname:h,searchParams:m}=new URL(l),p=c?h.match(ji)?.[1]:t.datasetFormat;if(!p)try{p=yield We(l,S({},a.options))}catch(d){U(d)||G.getLogger(this).error("#getContentType()",d)}switch(p??="UNKNOWN FORMAT",i){case"default":this._imageViewer.imageSource={datasetFormat:p.toUpperCase(),url:l.split("?")[0]},this._imageViewer.customParameters=Object.fromEntries(m),this._imageViewer.imageRotation=r??0,yield this._imageViewer.loadImage(n);break;case"panoramic":if(Bi.has(p.toUpperCase())){let{selectedPoint:d}=this,{pitch:g,yaw:f,cameraLocation:_,viewAngle:w}=a;this._panoramicViewer.imageSource=l;let F=f??0;typeof w=="number"?F=w-F:_&&d&&(F=(yield Na(_,d))-F),this._panoramicViewer.pitch=g??0,this._panoramicViewer.yaw=F,yield this._panoramicViewer.loadImage(n)}else this.setMessage("unsupportedPanoramicImageryError","error",void 0,{datasetFormat:p});break}}),this._loadViewAdapter=t=>y(this,null,function*(){let{view:a}=this;if(a)switch(a.type){case"2d":{let{default:i}=yield import("./chunk-YVOUHVZN.js");C(t),this._adapter=new i(this);break}case"3d":{let{default:i}=yield import("./chunk-KNZWOCXM.js");C(t),this._adapter=new i(this);break}}else this._adapter=null}),this._mapImageConversionToolViewClickHandler=t=>{t.stopPropagation(),t.preventDefault(),t.mapPoint&&this.plotMapPoint(t.mapPoint)},this._viewClickHandler=t=>{this._clickTask?.abort(),this._clickTask=ie(a=>y(this,null,function*(){let{pointerType:i,button:r,mapPoint:n}=t;if((i!=="mouse"||r===0)&&n)return t.stopPropagation(),t.preventDefault(),this._updatingHandles.addPromise(this.loadBestImage(n,{signal:a}))}))},this.plotSelectedPointOnImage=(t,a)=>y(this,null,function*(){if(yield xe(a),!t)return;let i=new L(S({},ae.isSerializable(t)?t.toJSON():t));if(this.mode==="default")i.x-=.5,i.y=.5-i.y,i.spatialReference=this._imageViewer.imageRenderer.spatialReference.clone(),this._crossSymbol=new R({geometry:i,symbol:Pt}),this._imageViewer.addGraphic(this._crossSymbol,0);else if(this.mode==="panoramic"){let{imageSize:r}=this._panoramicViewer;if(!r)return;let[n,c]=r,{heading:l,pitch:h}=ce(t,n,c),m=he(l,h);this._crossSymbol=new R({geometry:new L(m,D.WebMercator),symbol:Ya}),this._panoramicViewer.addGraphic(this._crossSymbol,0)}}),this.handleSectorClick=this.handleSectorClick.bind(this),this.searchBestImage=this.searchBestImage.bind(this),this.transformAndPlotReferencePointOnImage=this.transformAndPlotReferencePointOnImage.bind(this),this.updateSuitabilities=this.updateSuitabilities.bind(this),this.selectBestFeature=this.selectBestFeature.bind(this)}initialize(){this.addHandles([I(()=>this.view,()=>{this.load()},x),I(()=>this.view?.map,(e,t)=>{t?.layers.remove(this._overlays),e?.layers.add(this._overlays)},we),I(()=>this.view?.map?.allLayers?.length,e=>{e&&this.view?.map?.layers.reorder(this._overlays,e-1)},we),I(()=>[this.state,this.mapImageConversionToolState,this.view],()=>{this._createViewClickHandle(),this._createImageClickHandle()},x),I(()=>[this.state,this.imageLocationToolState,this.view],()=>{if(this._createImageLocationHandle(),!this.imageLocationToolState)return this.clearPreviousGroundLocation(),void this._resetCursor();this._setMeasurementCursor()},x),I(()=>this.measureType,()=>{this.clearPreviousMeasurements()},x),I(()=>this.bestFeatureAngle,(e,t)=>{this.previousFeatureAngle=t??0},x),I(()=>this.currentBestFeature,(e,t)=>y(this,null,function*(){te(this._featureChangedTask),this._featureChangedTask=ie(a=>y(this,null,function*(){return this.determineWorkflowForFeature.apply(this,[e,t,{signal:a}])})),yield this._featureChangedTask.promise}),{sync:!0}),I(()=>this.mode,e=>{switch(this.removeHandles(ee.interactionHandles),e){case"default":this.addHandles(I(()=>{let{state:t}=this;return t==="image-loaded"?this._imageViewer.imagePointsInView:null},t=>{t&&(te(this._updateFootprintTask),this._updateFootprintTask=ie(a=>y(this,null,function*(){yield this.updateFootprint(t,{signal:a})})))},H(S({},x),{equals:(t,a)=>st(t,a,nt)})),ee.interactionHandles);break;case"panoramic":this.addHandles(I(()=>{let{currentBestFeature:t,state:a}=this,{imageSize:i,vfov:r,hfov:n,pitch:c,yaw:l}=this._panoramicViewer;return t&&i&&!a.includes("loading")?[r,n,l,c]:null},t=>{if(!t||this.state.includes("loading"))return;let[a,i,r,n]=t;te(this._updateFootprintTask),this._updateFootprintTask=ie(c=>y(this,null,function*(){yield this.updateFootprintPanorama({verticalFieldOfView:a,horizontalFieldOfView:i,yaw:r,pitch:n},{signal:c})}))},H(S({},x),{equals:(t,a)=>st(t,a,nt)})),ee.interactionHandles)}},x),I(()=>[this.brightness,this.contrast,this.sharpness],()=>{let{_imageViewer:e,brightness:t,contrast:a,mode:i,sharpness:r}=this;i==="default"&&(e.brightness=t,e.contrast=a,e.sharpness=r)},x),I(()=>this.activeViewer?.imageRenderer,()=>{this.sketch&&(this.sketch.view=this.activeViewer?.imageRenderer)})]),this.when().finally(()=>{this.notifyChange("state")})}destroy(){this._updateFootprintTask=te(this._updateFootprintTask),this._clickTask=te(this._clickTask),this.coverageFrustums.destroy(),this.coveragePolygons.destroy(),this.pointSources.destroy(),this.additionalFootprints.destroy(),this.additionalCameraLocations.destroy(),this.bestFeatureFootprint=E(this.bestFeatureFootprint),this.bestFeatureCurrentFootprint=E(this.bestFeatureCurrentFootprint),this._crossSymbol=E(this._crossSymbol),this._referencePointOnGround=E(this._referencePointOnGround),this._referencePointOnImage=E(this._referencePointOnImage),this._locationPointOnImage=E(this._locationPointOnImage),this._overlays&&this.view?.map?.remove(this._overlays),this._overlays.destroy(),this._imageViewer.destroy(),this._panoramicViewer.destroy()}get activeLayer(){return Ce(G.getLogger(this),"activeLayer",{replacement:"layer"}),this.layer}set activeLayer(e){Ce(G.getLogger(this),"activeLayer",{replacement:"layer"}),this.layer=e}get activeViewer(){let{_imageViewer:e,_panoramicViewer:t,mode:a}=this;switch(a){case"default":return e;case"panoramic":return t;default:return null}}get accuracyParametersMissing(){return this.layer?.orientationAccuracy?.every(e=>e===0)??!0}get brightness(){return this._get("brightness")??0}set brightness(e){this._set("brightness",X(e,-10,10))}get contrast(){return this._get("contrast")??0}set contrast(e){this._set("contrast",X(e,-10,10))}get featureCount(){return this.features?.length??0}get imageGalleryEnabled(){let{currentBestFeature:e}=this;if(!e)return!1;let t=e.attributes.imagePath?.trim();return ft(t)||tt(t)}get imageLoaded(){return Ce(G.getLogger(this),"imageLoaded",{replacement:'Use OrientedImageryViewer.state === "image-loaded"',version:"4.29",warnOnce:!0}),this.state==="image-loaded"}get invalidCameraHeading(){return this.currentBestFeature?.attributes?.cameraHeading===yt}get imagePointsInView(){let{mode:e,_imageViewer:t}=this;return e==="default"?t.imagePointsInView:null}get layerView(){let{layer:e,view:t}=this;if(e&&t)return t.allLayerViews.find(Aa(e))}get layerFloorFilterClause(){let{layerView:e}=this;return e?da(e):null}get mode(){let e=this.currentBestFeature?.attributes;if(!e)return"none";let{horizontalFieldOfView:t,isSpherical:a}=e;return t===360||a?"panoramic":"default"}get popupEnabled(){return this.layer?.popupEnabled===!0}get referencePoint(){return this._referencePointOnGround?.geometry}get sectorData(){let{_sectorData:e}=this;return e?De.map(t=>e[t]):null}get sharpness(){return this._get("sharpness")??0}set sharpness(e){this._set("sharpness",X(e,0,1))}get sketchGraphicsLayer(){return this.sketch?.layer}get state(){let{mode:e,disabled:t,_updatingHandles:{updating:a},_featureChangedTask:i}=this;if(t)return"disabled";if(!this.isFulfilled()||a||i?.finished===!1)return"loading";if(this.isRejected())return"error";if(this.displayMessage?.type==="error")return"image-load-error";switch(e){case"default":return this._imageViewer.state;case"panoramic":return this._panoramicViewer.state}return"ready"}get thumbnails(){let{features:e}=this;return e?new z(e.map(({attributes:{imagePath:t,objectId:a,cameraRoll:i,imageRotation:r}})=>{let n=t?.trim();return ft(n)||tt(n)?{url:n,objectId:a,rotation:(i??0)+(r??0)}:null}).filter(Se)):null}set view(e){this._set("view",e)}get _sketchGraphicsLayer(){let{mode:e}=this;switch(e){case"panoramic":return new re({elevationInfo:{mode:"absolute-height"}});case"default":return new re;case"none":return}}get _overlaysView(){return this.view?.layerViews.find(({layer:e})=>e===this._overlays)}computeHeight(e,t,a=!0){return y(this,null,function*(){let{currentBestFeature:i,activeViewer:r,layer:n,footprintExtent:c}=this,l=r?.imageSize,h=i?.attributes,m=n?.orientationAccuracy;if(!h||!l||!e||e.length<2||!m)return;let p=t==="panoramic"?yield this.getMeasurementPropertiesPanoramic():Fe(h,l[0],l[1]),d=e.at(0),g=e.at(-1);if(!(p&&d&&g&&m&&c))return;let f=[g,d],_=It(f,!1),w=t==="panoramic"?yield vi(f,p,m,i,!0,!1):yield fi(f,p,m,!0,a);if(!w)return;let F=t==="panoramic"?yield mi(m,_,p,w,i,!0):yield hi(m,_,p,w,!0);return F?{value:w,accuracy:F}:{value:w}})}calculateAreaMeasurement(e,t,a){return y(this,null,function*(){if(e.length<3||!this.currentBestFeature||!this.activeViewer?.imageSize||t==="none")return null;let i=t==="default"?yield this.getMeasurementProperties():yield this.getMeasurementPropertiesPanoramic();return C(a),i?t==="default"?yield Je(e,i,!0):yield Ke(e,i,!0,a):null})}calculateDistanceMeasurement(e,t,a){return y(this,null,function*(){let{currentBestFeature:i,activeViewer:r}=this;if(e.length<2||!i||!r?.imageSize||t==="none")return null;let n=t==="default"?yield this.getMeasurementProperties():yield this.getMeasurementPropertiesPanoramic();return C(a),n?t==="default"?yield Xe([e.at(0),e.at(-1)],n,!0):yield Ye([e.at(0),e.at(-1)],n,!0):null})}calculateAccuracy(e,t,a){return y(this,null,function*(){let{layer:i,currentBestFeature:r,activeViewer:n}=this,c=i?.orientationAccuracy,l=c?.every(P=>P===0)||!c?.length;if(t==="area"&&e.length<3||t==="distance"&&e.length<2||!r||!n?.imageSize||l)return null;let h=yield this.getMeasurementProperties();if(C(a),!h)return null;let m=t==="area"?yield Je(e,h,!0):yield Xe([e.at(0),e.at(-1)],h,!0);C(a);let F=h,{updateElevationProps:p}=F,d=ot(F,["updateElevationProps"]),g=gi(d,c);if(!g?.length)return null;let f=g.map(P=>H(S({},P),{updateElevationProps:p})).map(P=>y(this,null,function*(){let b=t==="area"?yield Je(e,P,!0):yield Xe([e.at(0),e.at(-1)],P,!0);if(C(a),b&&m){if(t==="area"){let M=typeof b!="number"?b.area:null;return M?Math.abs(M-m.area):null}return Math.abs(b-m)}return null})),_=yield Promise.all(f);C(a);let w=_.filter(P=>P!==null);return w.length===0?null:St(w)})}calculateAccuracyPanoramic(e,t,a){return y(this,null,function*(){let{layer:i,currentBestFeature:r,activeViewer:n,mode:c}=this,l=i?.orientationAccuracy,h=l?.every(b=>b===0)||!l?.length;if(t==="area"&&e.length<3||t==="distance"&&e.length<2||!r||!n?.imageSize||h||c!=="panoramic")return null;let m=yield this.getMeasurementPropertiesPanoramic();if(C(a),!m)return null;let p=t==="area"?yield Ke(e,m,!0):yield Ye([e.at(0),e.at(-1)],m,!0);C(a);let P=m,{updateElevationProps:d}=P,g=ot(P,["updateElevationProps"]),f=yi(g,l);if(!f?.length)return null;let _=f.map(b=>H(S({},b),{updateElevationProps:d})).map(b=>y(this,null,function*(){let M=t==="area"?yield Ke(e,b,!0):yield Ye([e.at(0),e.at(-1)],b,!0);if(C(a),M&&p){if(t==="area"){let k=typeof M!="number"?M.area:null;return k?Math.abs(k-p.area):null}return Math.abs(M-p)}return null})),w=yield Promise.all(_);C(a);let F=w.filter(b=>b!==null);return F.length===0?null:St(F)})}calculateHeightMeasurementInfo(e,t,a){return y(this,null,function*(){let{currentBestFeature:i,activeViewer:r}=this,n=r?.imageSize;if(!i||!r||!n?.length||t==="none")return;let{attributes:c}=i,[l]=It([e],t!=="panoramic"),h=t==="panoramic"?yield this.getMeasurementPropertiesPanoramic():Fe(c,n[0],n[1]);if(t==="panoramic"){if(!h)return;let g=yield di(l,h,i,a);if(!g)return;g?.heading>180&&(g.heading-=360);let f=li(l,g),_=pt([l.x,l.y],[g.x,g.y]);return!f||!_?void 0:{measurementAngle:f,tempDistance:_}}let m=yield ui(l,h,a);if(!m)return;let p=ni(l,m),d=pt([l.x,l.y],[m.x,m.y]);return p&&d?{measurementAngle:p,tempDistance:d}:void 0})}clearPreviousMeasurements(){this.clearMeasurementGraphics(),this.resetMeasurementData(),this.stopMeasurement()}clearPreviousGroundLocation(){this.groundCoordinates=null,this.pixelCoordinates=null,this.clearLocationPointOnImage()}clearMeasurementGraphics(){this.measurementGraphic&&(this.activeViewer?.removeGraphic(this.measurementGraphic),this.measurementGraphic=null),this.heightGraphic&&(this.activeViewer?.removeGraphic(this.heightGraphic),this.heightGraphic=null)}digitizeCancel(){return this.sketch?.cancel()}digitizeCanRedo(){return this.sketch?.canRedo()??!1}digitizeCanUndo(){return this.sketch?.canUndo()??!1}digitizeComplete(){return this.sketch?.complete()}digitizeCreate(e,t){return y(this,null,function*(){let{sketch:a,dataCaptureLayer:i}=this;if(!a)throw pe();ri(i,e,a),yield a.create(e,H(S({},t),{defaultZ:0}))})}digitizeDelete(){return y(this,null,function*(){if(!this.sketch)throw pe();return this.sketch.delete()})}digitizeDuplicate(){if(!this.sketch)throw pe();return this.sketch.duplicate()}digitizePlace(e,t){if(!this.sketch)throw pe();return this.sketch.place(e,t)}digitizeRedo(){if(!this.sketch)throw pe();return this.sketch.redo()}digitizeUndo(){if(!this.sketch)throw pe();return this.sketch.undo()}digitizeUpdate(e,t){if(!this.sketch)throw pe();return this.sketch.update(e,t)}displayHeightResults(){return y(this,null,function*(){let{currentBestFeature:e,activeViewer:t,heightMeasurementPixels:a,mode:i}=this,r=t?.imageSize;if(!e?.attributes||!r)return;let c=yield this.computeHeight(a,i);c?.value&&c?.accuracy&&(this.heightMeasurementResult=c.value,this.heightMeasurementAccuracy=c.accuracy)})}filterByFootprints(e,t){let a=[],i=[],r=[];return e.forEach(n=>{let{layer:{coveragePercent:c},attributes:l}=n,h,m=ht(n.geometry.spatialReference);l.cameraHeight/=m,l.farDistance/=m,l.nearDistance/=m,na(l.elevationSource)&&(l.elevationSource.constantElevation/=m);let{polygon:p,frustum:d}=$e(l);if(h=p.clone(),l.isInspection&&(h=Za(l)),c&&(h=qa(h,c)),Wa(h,t)){r.push(n);let{geometry:g,objectId:f,cameraHeight:_,cameraHeading:w}=l,F=g.clone();F.z=_,F.imageID=f,this.pointSources.push(F),w!==yt&&(a.push(p),d&&i.push(d))}}),{features:r,polygons:a,frustums:i}}getMeasurementProperties(){let{currentBestFeature:e,activeViewer:t}=this;if(!e||!t?.imageSize)return;let{elevationSample:a,attributes:i}=e,{elevationSource:r,cameraHeight:n}=i,c=Fe(i,t.imageSize[0],t.imageSize[1]),l=c.cameraLocation;return(l.spatialReference.isGeographic?K(l,D.WebMercator):Promise.resolve(l)).then(h=>(l=h,ye((l.z??0)-n,{elevationSample:a,elevationSource:r,extent:this.footprintExtent}))).then(h=>("elevationSample"in h&&qe(h.elevationSample)&&(e.elevationSample=h.elevationSample),H(S({},c),{cameraLocation:l,updateElevationProps:h})))}getMeasurementPropertiesPanoramic(){let{currentBestFeature:e,activeViewer:t}=this;if(!e||!t?.imageSize)return;let{elevationSample:a,attributes:i}=e,{elevationSource:r,cameraHeight:n}=i,c=vt(i,t.imageSize[0],t.imageSize[1]),l=c.cameraLocation;return(l.spatialReference.isGeographic?K(l,D.WebMercator):Promise.resolve(l)).then(h=>(l=h,ye((l.z??0)-n,{elevationSample:a,elevationSource:r,extent:this.footprintExtent}))).then(h=>("elevationSample"in h&&qe(h.elevationSample)&&(e.elevationSample=h.elevationSample),H(S({},c),{cameraLocation:l,updateElevationProps:h})))}deleteDataCaptureFeatures(e){return y(this,null,function*(){let{dataCaptureLayer:t}=this;if(!t)throw new N("Data capture layer is not available");return t.queryFeatures({objectIds:e}).then(({features:a})=>t.applyEdits({deleteFeatures:a}))})}handleSectorClick(e){if(isNaN(e))return;let t=this._sectorData?.[De[e]];t?.length&&this._updateCurrentBestFeature(t.at(0))}handleFeatureClick(e){let{sector:t,featureIndexInSector:a}=e;if(isNaN(a))return;let i=this._sectorData?.[t];i?.length&&this._updateCurrentBestFeature(i.at(a))}handleDrawCursorUpdateEvents(e){let{measurementAngle:t,tempDistance:a,heightMeasurementPixels:i,mode:r,activeViewer:n}=this,c=n?.imageSize;if(!e.vertices||!c)return;let l=Ct(e.vertices.at(-1),r,c);if(i.length<1||!l||!a||!t||r==="none")return;let h=ci(i[0],l,t);if(!h?.length)return;this.heightMeasurementPixels.push(h),r==="panoramic"?this.createPolylineGraphicPano():this.createPolylineGraphic();let m=pi(this.heightMeasurementPixels,a);m&&(this.heightMeasurementResult=m)}handleDrawVertexAddEvents(e,t){return y(this,null,function*(){let{currentBestFeature:a,activeViewer:i,heightMeasurementPixels:r,mode:n}=this;if(!a||!i||!e.vertices?.length||n==="none")return;let c=i?.imageSize;if(!r.length&&c){let l=Ct(e.vertices.at(-1),n,c);this.heightMeasurementPixels.push(l);let h=yield this.calculateHeightMeasurementInfo(l,n,t);if(!h?.measurementAngle||!h?.tempDistance)return;this.measurementAngle=h.measurementAngle,this.tempDistance=h.tempDistance}})}load(e){return y(this,null,function*(){return this.addResolvingPromise(this._loadViewAdapter(e).catch(t=>{if(!U(t))throw t})),this})}loadBestImage(e,t){return y(this,null,function*(){return this.view?.closePopup(),this.displayMessage=null,this.clearPreviousGroundLocation(),this.imageLocationToolState=!1,this.selectedPoint=e.spatialReference.isGeographic?be(e):e.clone(),this.features.removeAll(),this.currentBestFeature=null,this.additionalFeatures.removeAll(),this.additionalFootprints.removeAll(),this.additionalCameraLocations.removeAll(),this.bestFeatureCurrentFootprint=E(this.bestFeatureCurrentFootprint),this._overlays?.removeAll(),this._fetchFeaturesWithController(e,t)})}loadImageError(e){G.getLogger(this).error("oriented-imagery-viewer:load-image",e),this.setMessage("imageLoadError","error",e.message)}loadSketch(e){return y(this,null,function*(){if(!this.sketch){let t=import("./chunk-ECURWNUD.js"),{default:a}=yield t;C(e),this.sketch=new a({layer:this._sketchGraphicsLayer,view:this.activeViewer?.imageRenderer,updateOnGraphicClick:!1,defaultUpdateOptions:{reshapeOptions:{edgeOperation:"none",shapeOperation:"none",vertexOperation:void 0},enableMoveAllGraphics:!1,enableRotation:!1,enableScaling:!1,multipleSelectionEnabled:!1,toggleToolOnClick:!1,tool:"transform"}})}return this.sketch})}loadMeasurementAdapter(e){return y(this,null,function*(){if(!this.sketchAdapter){let t=import("./chunk-6TV73G2G.js"),{default:a}=yield t;if(C(e),this.sketchAdapter=new a({viewModel:this}),!this.sketchAdapter.viewModel.isResolved())return}return this.sketchAdapter})}startMeasurement(e,t){return y(this,null,function*(){yield this.loadSketch(t),yield this.loadMeasurementAdapter(t);let{sketch:a,sketchAdapter:i,activeViewer:r,mode:n}=this;if(!a||!i||!r||n==="none")return;if(this.displayNewMeasurementButton=!1,n==="panoramic"&&(a.defaultCreateOptions.defaultZ=0),yield a.create(e),n==="panoramic"){let{drawOperation:l}=a.view.activeTool;l.constraintsEnabled=!1,l._set("elevationDrawSurface",null)}let c=this.activeViewer?.imageRenderer.effectiveTheme.accentColor;c&&this.sketch&&(this.sketch.polygonSymbol=ai(c),this.sketch.polylineSymbol=n==="panoramic"?Mt:Ft(c))})}startHeightMeasurement(){this.heightMeasurementPixels=[],this.displayNewMeasurementButton=!1,this.draw??=new ba({view:this.activeViewer?.imageRenderer}),this.draw.create("polyline").on(["cursor-update","vertex-add","draw-complete"],e=>this.handleDrawEvents(e))}createPolylineGraphic(){let e=[this.heightMeasurementPixels[0],this.heightMeasurementPixels.at(-1)],t=this.activeViewer?.imageRenderer.spatialReference;if(this.heightGraphic)this.heightGraphic.geometry=new le({paths:[e],spatialReference:t});else{let a=new le({paths:[e],spatialReference:t}),i=this.activeViewer?.imageRenderer.effectiveTheme.accentColor;this.heightGraphic=new R({geometry:a,symbol:Ft(i,2.5)}),this.activeViewer?.addGraphic(this.heightGraphic)}}createPolylineGraphicPano(){let e=this.activeViewer?.imageRenderer.spatialReference,t=this.activeViewer?.imageSize;if(!t)return;let a={x:this.heightMeasurementPixels[0][0],y:this.heightMeasurementPixels[0][1]},i={x:this.heightMeasurementPixels.at(-1)[0],y:this.heightMeasurementPixels.at(-1)[1]},{heading:r,pitch:n}=ce(a,t[0],t[1]),{heading:c,pitch:l}=ce(i,t[0],t[1]),h=[[...he(r,n)],[...he(c,l)]];if(this.heightGraphic)this.heightGraphic.geometry=new le({paths:[h],spatialReference:e});else{let m=new le({paths:[h],spatialReference:e});this.heightGraphic=new R({geometry:m,symbol:Mt}),this._panoramicViewer.addGraphic(this.heightGraphic,0)}}handleDrawEvents(e,t){return y(this,null,function*(){if(this.draw)switch(e.type){case"cursor-update":this.handleDrawCursorUpdateEvents(e);break;case"vertex-add":this.handleDrawVertexAddEvents(e,t);break;case"draw-complete":yield this.displayHeightResults()}})}initializeMeasurement(e){switch(this.clearMeasurementGraphics(),this.resetMeasurementData(),e){case"distance":this.startMeasurement("polyline");break;case"area":this.startMeasurement("polygon");break;case"height":this.startHeightMeasurement()}}overlayCameraLocations(e){return y(this,null,function*(){let{activeViewer:t,currentBestFeature:a,overlayedCameraLocations:i,layer:r,mode:n,state:c}=this,l=t?.imageSize;if(!l||!a||!r||n==="none"||c.includes("loading"))return;let{polygon:h}=$e(a.attributes);if(t.removeManyGraphics(i.toArray()),i.removeAll(),e){let{features:m}=yield r.queryFeatures({where:`${r.objectIdField} <> ${a.attributes.objectId}`,geometry:h,returnGeometry:!0,outFields:[r.objectIdField]}),p=yield Promise.all(m.map(d=>y(this,null,function*(){let{attributes:g,geometry:f}=d,_=yield this.getPixels(f,{feature:a,imageSize:l,mode:n}),w=bt.clone();return w.outline=new Yt({color:[0,0,0],width:1}),new R({attributes:g,symbol:w,geometry:_})})));i.addMany(p),t.addManyGraphics(i.toArray())}})}overlayGraphicsOnImage(e,t){this.removeOverlayedGraphicsOnImage(e),this.overlayedMapFeatures.set(e,t),this.activeViewer?.addManyGraphics(t.toArray())}overlayMapFeatures(e,t=!1){return y(this,null,function*(){let{activeViewer:a,currentBestFeature:i,mode:r,state:n,layer:c}=this,l=a?.imageSize;if(!l||!i||r==="none"||n.includes("loading")||!c)return;let{polygon:h}=$e(i.attributes);try{let{imageGeometryField:d,oiObjectIdField:g}=oi(e,c.imageGeometryField,c.imageReferenceField);this.imageGeometryField=d.name,this.oiObjectIdField=g.name}catch(d){G.getLogger(this).warn("oriented-imagery-viewer:overlay-map-features",d)}let{features:m}=yield e.queryFeatures({geometry:h,returnGeometry:!0,outFields:["*"]}),p=new z((yield Promise.all(m.map(d=>y(this,null,function*(){let g=d.symbol?.clone()??e.renderer?.getSymbol(d)?.clone(),{attributes:f,geometry:_}=d,w=_,{imageGeometryField:F,oiObjectIdField:P}=this;if(F&&P&&ii(e,F,P)&&`${f[P]}`==`${i.attributes.objectId}`)try{return si(f,F,e,t,l,r,g)}catch(b){G.getLogger(this).warn("oriented-imagery-viewer:overlay-map-features","couldn't create graphic from attributes, geometry will be used",{error:b,feature:d,layer:e,imageGeometryField:this.imageGeometryField,imageReferenceField:this.oiObjectIdField})}switch(w?.type){case"point":{let b=yield this.getPixels(w,{feature:i,imageSize:l,mode:r});return new R({attributes:f,layer:e,symbol:g,geometry:b,visible:e.visible&&t})}case"polygon":{let{rings:b,spatialReference:M}=w,k=b.map(O=>O.map(([Z,$,J])=>new L({x:Z,y:$,z:J,spatialReference:M}))),q=yield Promise.all(k.map(O=>y(this,null,function*(){return this.getPixels(O,{feature:i,imageSize:l,mode:r}).then(Z=>Z.map(ge))})));return new R({attributes:f,layer:e,symbol:g,geometry:new Y({rings:q,spatialReference:D.WebMercator}),visible:e.visible&&t})}case"polyline":{let{paths:b,spatialReference:M}=w,k=b.map(O=>O.map(([Z,$,J])=>new L({x:Z,y:$,z:J,spatialReference:M}))),q=yield Promise.all(k.map(O=>y(this,null,function*(){return this.getPixels(O,{feature:i,imageSize:l,mode:r}).then(Z=>Z.map(ge))})));return new R({attributes:f,layer:e,symbol:g,geometry:new le({paths:q,spatialReference:D.WebMercator}),visible:e.visible&&t})}case"multipoint":{let{points:b,spatialReference:M}=w,k=b.map(([O,Z,$])=>new L({x:O,y:Z,z:$,spatialReference:M})),q=yield this.getPixels(k,{feature:i,imageSize:l,mode:r}).then(O=>O.map(ge));return new R({attributes:f,layer:e,symbol:g,geometry:new Ut({points:q,spatialReference:D.WebMercator}),visible:e.visible&&t})}}return null})))).filter(Se));this.overlayGraphicsOnImage(`${e.id}`,p)})}getPixels(e,t){return y(this,null,function*(){let{imageSize:a,mode:i}=t,r=(yield this.worldToImage(Array.isArray(e)?e:[e])).map(n=>{if(i==="default")return new L({x:n.x-.5,y:.5-n.y,spatialReference:D.WebMercator});let[c,l]=a,{heading:h,pitch:m}=ce(n,c,l),p=he(h,m);return new L(p,D.WebMercator)});return Array.isArray(e)?r:r[0]})}getMapPoint(e,t){return y(this,null,function*(){let{feature:a,mode:i,imageSize:r}=t,{elevationSample:n,attributes:c}=a,{elevationSource:l,location:h,elevation:m,cameraHeight:p}=c,d=h.clone();d.spatialReference.isGeographic&&(d=yield K(d,D.WebMercator));let g=yield ye(m??(h.z??0)-p,{elevationSample:n,elevationSource:l,extent:this.footprintExtent}),f;if("elevationSample"in g&&qe(g.elevationSample)&&(a.elevationSample=g.elevationSample),i==="default"){let _=Fe(c,r[0],r[1]);f=yield Ja(Array.isArray(e)?e:[e],H(S({},_),{cameraLocation:d}),g)}else{let _=vt(c,r[0],r[1]);f=yield Ka(Array.isArray(e)?e:[e],H(S({},_),{cameraLocation:d}),g)}return Array.isArray(e)?f:f[0]})}plotMapPoint(e){return y(this,null,function*(){return this.plotReferencePoint(e),this.transformAndPlotReferencePointOnImage({feature:this.currentBestFeature,selectedLocation:e,options:{signal:this._transformController?.signal}})})}plotReferencePointOnGround(e){this._referencePointOnGround&&(this._overlays?.remove(this._referencePointOnGround),this._referencePointOnGround.destroy()),e!=null&&(this._referencePointOnGround=new R({geometry:new L(S({},e.toJSON())),symbol:_t}),this.view?this._overlays?.add(this._referencePointOnGround):this.emit("plot-ground-point",{data:{point:this._referencePointOnGround?.geometry}}))}plotReferencePointOnImage(e){if(this.state==="image-loaded")switch(this.clearReferencePointOnImage(),this.mode){case"default":{let t=ae.isSerializable(e)?e.toJSON():e;t.x-=.5,t.y=.5-t.y,this._referencePointOnImage=new R({geometry:new L(S({spatialReference:this._imageViewer.imageRenderer.spatialReference},t)),symbol:_t}),this._imageViewer.addGraphic(this._referencePointOnImage,0);break}case"panoramic":{let{imageSize:t}=this._panoramicViewer;if(!t)return;let[a,i]=t,{heading:r,pitch:n}=ce(e,a,i),c=he(r,n);this._referencePointOnImage=new R({geometry:new L(c,D.WebMercator),symbol:Qa}),this._panoramicViewer.addGraphic(this._referencePointOnImage,0);break}}}plotLocationPointOnImage(e){if(this.state==="image-loaded")switch(this.clearLocationPointOnImage(),this.mode){case"default":this._plotLocationPointOnDefaultImage(e);break;case"panoramic":this._plotLocationPointOnPanoramicImage(e)}}removeAllOverlayMapFeatures(){this.overlayedMapFeatures.forEach(e=>{this._imageViewer.removeManyGraphics(e.toArray())}),this.overlayedMapFeatures.clear()}removeOverlayedGraphicsOnImage(e){let t=this.overlayedMapFeatures.get(e);t?.length&&(this.activeViewer?.removeManyGraphics(t.toArray()),this.overlayedMapFeatures.delete(e))}resetImage(){switch(this.setMessage("onLoadMessage","info"),this.mode){case"default":this._imageViewer.clearImage(),this._imageViewer.clearGraphics();break;case"panoramic":this._panoramicViewer.clearGraphics()}this._clickTask=te(this._clickTask)}resetMeasurementData(){this.areaMeasurementResult=0,this.areaMeasurementAccuracy=0,this.distanceMeasurementResult=0,this.distanceAccuracyArray=[],this.heightMeasurementPixels=[],this.heightMeasurementResult=0,this.tempDistance=null,this.measurementAngle=null,this.heightMeasurementAccuracy=0,this.heightGraphic=null}saveDrawing(){return y(this,null,function*(){let{dataCaptureLayer:e,sketchAdapter:t}=this;if(!e||t?.type!=="data-capture")return;let{pendingGraphics:a,savedGraphics:i}=t,r=a.get(e.id),n=r?.toArray();if(!r||!n?.length)return;let{addFeatureResults:c}=yield this.saveDataCaptureFeatures(n),l=c.reduce((h,{objectId:m,globalId:p,error:d},g)=>{let f=n[g],{attributes:_}=f;return d?h.error.push(f):(m&&(_[e.objectIdField]=m),p&&e.globalIdField&&(_[e.globalIdField]=p),h.success.push(f)),h},{success:[],error:[]});i.addMany(l.success),r.removeAll(),r.addMany(l.error)})}saveDataCaptureFeatures(e){return y(this,null,function*(){let{activeViewer:t,currentBestFeature:a,dataCaptureLayer:i,mode:r}=this,n=t?.imageSize;if(!n||!a||r==="none")throw new N("Image size, current best feature and mode are required to save data capture features");if(!i)throw new N("Data capture layer is not available");let c=yield Promise.all(e.map(h=>y(this,null,function*(){let m=h.clone(),{geometry:p}=m;if(!p)return;let d=p.type,g=i.hasZ,f=i.geometryType,_=d!==f,w=_?yield import("./chunk-2PYGTYSD.js"):null,F=w?.default[f],P=_?F?.(p):p;if(P)switch(P.type){case"point":return m.geometry=yield this.getMapPoint(Ue(r,P,n),{feature:a,imageSize:n,mode:r}),g||(delete m.geometry.z,m.geometry.hasZ=!1),m.geometry.hasM=!1,m;case"polygon":{let b=yield Promise.all(P.rings.map(M=>y(this,null,function*(){return this.getMapPoint(M.map(([k,q,O])=>Ue(r,{x:k,y:q,z:O},n)),{feature:a,imageSize:n,mode:r})})));return m.geometry=new Y({spatialReference:b[0][0].spatialReference,hasZ:g,hasM:!1,rings:b.map(M=>M.map(ge))}),m}case"polyline":{let b=yield Promise.all(P.paths.map(M=>y(this,null,function*(){return this.getMapPoint(M.map(([k,q,O])=>Ue(r,{x:k,y:q,z:O},n)),{feature:a,imageSize:n,mode:r})})));return m.geometry=new le({spatialReference:b[0][0].spatialReference,hasZ:g,hasM:!1,paths:b.map(M=>M.map(ge))}),m}}}))),l=c.filter(Se);return i.applyEdits({addFeatures:l}).then(h=>{let{addFeatureResults:m}=h,p=0,d=c.map(g=>{let f=m[p++];return g?f:{error:new N("Error in saving data capture features"),objectId:null,globalId:null}});return H(S({},h),{addFeatureResults:d})})})}searchBestImage(e,t){return y(this,null,function*(){try{let a=yield bi(e,t);a&&(yield this._processFeatureResponse(a,e.point,{signal:t?.signal}))}catch(a){U(a)||(this.setMessage("imageLoadError","error",a.message),G.getLogger(this).error("error occurred while finding best image",a))}})}selectBestFeature(e){this.currentBestFeature=this.features?.find(({attributes:t})=>t.objectId===Number(e))}setAdditionalCameraLocationsVisibility(e){this.additionalCameraLocations.forEach(t=>{t.visible=e})}setAdditionalCoverageVisibility(e){this.additionalFootprints.forEach(t=>{t.visible=e})}setCurrentCoverageVisibility(e){this.bestFeatureCurrentFootprint&&(this.bestFeatureCurrentFootprint.visible=e),this.currentBestFeatureLocation&&(this.currentBestFeatureLocation.visible=e)}setMapImageConversionToolState(e){this.mapImageConversionToolState=e}startDataCapture(e,t){return y(this,null,function*(){let a=this.activeViewer?.imageRenderer,{oiObjectIdField:i,currentBestFeature:r}=this;if(!a||!r||!i)return;let{attributes:{objectId:n}}=r,c=this.overlayedMapFeatures.get(e.id)?.toArray()??[],l=[],h=[];for(let d of c)`${d.getAttribute(i)}`==`${n}`?l.push(d):h.push(d);this.overlayGraphicsOnImage(e.id,new z(h)),this.collectionId=e.id;let m=yield this.loadSketch(t),p=yield this.loadDataCaptureAdapter(t);C(t),m.layer.addMany(l),m.layer.blendMode="source-atop",p.savedGraphics.addMany(l),a.ui.find("zoom").visible=!1,a.map.layers.add(this.sketchGraphicsLayer)})}stopDataCapture(e=!1){return y(this,null,function*(){this.sketch?.cancel(),this.sketchGraphicsLayer?.removeAll(),this.sketchAdapter=E(this.sketchAdapter),this.sketch=E(this.sketch),this.collectionId=null;let{dataCaptureLayer:t}=this,a=this.activeViewer?.imageRenderer;if(!a||a.destroyed)return;a.map.layers.remove(this.sketchGraphicsLayer),e&&t&&(yield this.overlayMapFeatures(t,!0));let i=a.ui.find("zoom");i&&(i.visible=!0)})}stopMeasurement(){this.heightMeasurementPixels=[],this.draw?.reset(),this.sketch?.cancel()}toggleAllOverlayMapFeatures(e){this.overlayedMapFeatures.forEach(t=>{this._toggleVisiblity(t,e)})}toggleOverlayMapFeatures(e,t){let a=this.overlayedMapFeatures.get(e);a&&this._toggleVisiblity(a,t)}toggleSelection(e){let{sketch:t}=this;t&&(t.updateOnGraphicClick=e,t.cancel())}transformAndPlotReferencePointOnImage(e){return y(this,null,function*(){let{selectedLocation:t,options:a}=e,i=!1,r=!1,n=this.bestFeatureFootprint?.geometry;switch(n?.type){case"polygon":{let l=t.spatialReference.equals(n.spatialReference)?t:yield K(t,n.spatialReference);i=n.contains(l);break}case"mesh":{let l=t.spatialReference.equals(n.spatialReference)?t:yield K(t,n.spatialReference);r=n.extent.contains(l);break}}if(!i&&!r)return void this.clearReferencePointOnImage();let c=yield this.worldToImage(t,a);if(c)return C(a),this.plotReferencePointOnImage(c),{x:c.x,y:c.y};this.clearReferencePointOnImage()})}updateSuitabilities(e){e.sort((a,i)=>a.suitability-i.suitability),this._suitabilities=e;let t=this._suitabilities.map(({feature:a})=>a);this._initialCurrentCoverageUpdate=!0,this._updateFeatures(t),this._groupFeaturesBySectors()}_fetchFeatures(e,t){return y(this,null,function*(){if(!this.view)return;let a=this.layer;if(a){let i={include:a},r=this.view.toScreen(e);if(!r)return;let n=yield this.view.hitTest(r,i);return this._processHitTestResults(a,n,t)}})}_fetchFeaturesWithController(e,t){return y(this,null,function*(){try{yield this._fetchFeatures(e,t)}catch(a){if(U(a))return;this.setMessage("imageLoadError","error"),G.getLogger(this).error("error occurred while fetching features",a)}})}_groupFeaturesBySectors(){let{_suitabilities:e,additionalFeatures:t,currentBestFeature:a,features:i,invalidCameraHeading:r}=this;if(!e||!t||!a||!i||r)return void(this._sectorData=null);this._sectorData={};for(let h of De)this._sectorData[h]=new z;let n=e.map((h,m)=>H(S({},h),{featureIndex:m}));n.sort((h,m)=>h.trueSuitability-m.trueSuitability);let c=n.map(({distance:h})=>h),l=Math.max(...c);n.forEach(h=>{let{distance:m,angle:p,featureIndex:d}=h,g=m/l*oe[2],f=Oa(m,l),_=Ra(p);if(!this._sectorData)return;let w=oe[3]+g*Math.sin(p*Math.PI/180),F=oe[3]+g*Math.cos(p*Math.PI/180),P,b=i.at(d),M=b===this.currentBestFeature,k=this.currentBestFeature?.attributes.cameraPitch&&this.currentBestFeature?.attributes.cameraPitch<5;if(M&&k)P=-90;else{let Z=w-oe[3],$=F-oe[3],J=$/Math.sqrt(Z**2+$**2),ue=180*Math.acos(J)/Math.PI;(Z<0&&$<0||Z<0&&$>0)&&(ue*=-1),P=ue}let q=f===""?_:`${f}_${_}`;M&&(P===this.bestFeatureAngle?this.previousFeatureAngle=P:this.bestFeatureAngle=P,this.navigatorCurrentBestFeature=k?null:{x:w,y:F,direction:_});let O=this._sectorData[q];O.add({angle:p,featureIndex:d,x:w,y:F,objectID:b.attributes.objectId,sector:q,featureIndexInSector:O.length})})}_plotLocationPointOnDefaultImage(e){let t=ae.isSerializable(e)?e.toJSON():e;t.x-=.5,t.y=.5-t.y,this._locationPointOnImage=new R({geometry:new L(S({spatialReference:this._imageViewer.imageRenderer.spatialReference},t)),symbol:ei}),this._imageViewer.addGraphic(this._locationPointOnImage,0)}_plotLocationPointOnPanoramicImage(e){let{imageSize:t}=this._panoramicViewer;if(!t)return;let[a,i]=t,{heading:r,pitch:n}=ce(e,a,i),c=he(r,n);this._locationPointOnImage=new R({geometry:new L(c,D.WebMercator),symbol:ti}),this._panoramicViewer.addGraphic(this._locationPointOnImage,0)}_processFeatureResponse(e,t,a){return y(this,null,function*(){let{features:i}=e;if(!i?.length)return this.setMessage("noImageError","error"),void(this.currentBestFeature=null);this.coveragePolygons.removeAll(),this.coverageFrustums.removeAll(),this.pointSources.removeAll();let{features:r,polygons:n,frustums:c}=this.filterByFootprints(i,t);if(!r.length)return this.setMessage("noImageError","error"),void(this.currentBestFeature=null);let l;if(this.coveragePolygons.addMany(n),this.coverageFrustums.addMany(c),n[0]){let h=new Y({spatialReference:n[0].spatialReference});for(let p of n)h=yield _a(h,p);let m=[];for(let{geometry:p}of r)h.contains(p)||m.push([p.x,p.y]);if(m.sort((p,d)=>+$t([p,d])),h.addRing(m),this.footprintExtent=Pa(h.extent,2,2),this.view?.supportsGround)try{l=yield this.view.map.ground.createElevationSampler(this.footprintExtent,a)}catch(p){U(p)||G.getLogger(this).error(p)}}if((l||r[0].attributes.elevationSource)&&this.footprintExtent){let h=r[0].attributes.elevationSource;la(h)&&!l&&(l=yield Ga({extent:this.footprintExtent,lod:h.lod,url:h.url,rasterFunction:h.rasterFunction}));let m=yield ye((r[0].attributes.location.z??0)-r[0].attributes.cameraHeight,{elevationSample:l,elevationSource:h,extent:this.footprintExtent}),[p,...d]=yield wt([t,...r.map(g=>g.attributes.geometry.clone())],m);r[0].elevationSample=l??m.elevationSample,t.elevation=p.z,r.forEach((g,f)=>{g.attributes.elevation=d[f].z})}r[0].elevationSample&&r.forEach(h=>{h.elevationSample=r[0].elevationSample}),this._suitabilities=_i({features:r,selectedPoint:t,camera:Sa(this.view)?this.view.camera:null,currentImage:this.currentBestFeature}),this.updateSuitabilities(this._suitabilities)})}_processHitTestResults(e,t,a){return y(this,null,function*(){let{screenPoint:i,results:[r]}=t,n=r?.type==="graphic"&&this.shouldShowSelectedImage,c=r?.mapPoint??this.view?.toMap(i);if(!c)return;let{layerFloorFilterClause:l}=this,h=e.spatialReference.equals(c.spatialReference)?c:yield K(c,e.spatialReference),m=mt("1=1",mt(e.definitionExpression,l)),p=h.spatialReference.isGeographic?1:ht(h.spatialReference),d={layerInstanceOrURL:e,point:h,queryParams:{where:m,maximumDistance:e.maximumDistance?e.maximumDistance/p:void 0,objectIds:n?[r.graphic.getAttribute(e.objectIdField)]:void 0}};yield this.searchBestImage(d,a)})}_resetCursor(){let{activeViewer:e}=this;e&&(e.imageRenderer.cursor=this._previousCursor)}_setMeasurementCursor(){let{activeViewer:e}=this;e&&(this._previousCursor=e.imageRenderer.cursor,e.imageRenderer.cursor="crosshair")}_toggleVisiblity(e,t){e.forEach(a=>{a.visible=t})}_updateFeatures(e){if(!e.length)return this.currentBestFeature=null,void this.additionalFeatures.removeAll();this.features.removeAll(),this.features.addMany(e),e.length>1?this.additionalFeatures.addMany(e.slice(1)):this.additionalFeatures.removeAll(),this._updateGroundElevation=!0,this.currentBestFeature=e[0]}_updatePointsAndPolygons(e){return y(this,null,function*(){let{pointSources:t,currentBestFeature:a,currentCoverageVisible:i,isAdditionalPointSourcesVisible:r}=this;if(a&&(this.additionalFootprints.removeAll(),this.additionalCameraLocations.removeAll(),this.bestFeatureCurrentFootprint&&(this.bestFeatureCurrentFootprint.destroy(),this.bestFeatureCurrentFootprint=null,this.bestFeatureFootprint=null),!this.invalidCameraHeading)){yield this._adapter?.createFootprints(e),C(e);for(let n of t)n.imageID===a.attributes.objectId?this.currentBestFeatureLocation=new R({attributes:{imageID:n.imageID},geometry:n.clone(),symbol:Xa,visible:i}):this.additionalCameraLocations.push(new R({attributes:{imageID:n.imageID},geometry:n.clone(),symbol:bt,visible:r}))}})}_updateCurrentBestFeature(e){if(!e)return;this.currentBestFeature=this.features?.at(e.featureIndex);let t=this.currentBestFeature?.attributes.cameraPitch&&this.currentBestFeature?.attributes.cameraPitch<5,a;if(t)a=-90;else{let i=e.x-oe[3],r=e.y-oe[3],n=r/Math.sqrt(i**2+r**2),c=180*Math.acos(n)/Math.PI;(i<0&&r<0||i<0&&r>0)&&(c*=-1),a=c}a===this.bestFeatureAngle?this.previousFeatureAngle=a:this.bestFeatureAngle=a,this.navigatorCurrentBestFeature=t?null:{x:e.x,y:e.y,direction:e.sector.includes("_")?e.sector.split("_")[1]:e.sector}}clearGraphics(){this._imageViewer.clearGraphics(),this._panoramicViewer.clearGraphics()}clearReferencePointOnImage(){this._referencePointOnImage&&(this._imageViewer.removeGraphic(this._referencePointOnImage),this._panoramicViewer.removeGraphic(this._referencePointOnImage),this._referencePointOnImage=E(this._referencePointOnImage))}clearLocationPointOnImage(){this._locationPointOnImage&&(this._imageViewer.removeGraphic(this._locationPointOnImage),this._panoramicViewer.removeGraphic(this._locationPointOnImage),this._locationPointOnImage=E(this._locationPointOnImage))}plotReferencePoint(e){"mapPoint"in e?this.plotReferencePointOnGround(e.mapPoint):this.plotReferencePointOnGround(e)}setMessage(e,t,a,i){this.displayMessage={key:e,type:t,data:a,map:i}}transformAndPlotSelectedLocation(e){return y(this,null,function*(){let{currentBestFeature:t,invalidCameraHeading:a,selectedPoint:i,activeViewer:r}=this;if(this._crossSymbol&&(this._panoramicViewer.removeGraphic(this._crossSymbol),this._imageViewer.removeGraphic(this._crossSymbol),this._crossSymbol=E(this._crossSymbol)),!i||!t||r?.state!=="image-loaded"||a)return;let n;try{n=yield this.worldToImage(i,e),C(e),yield this.plotSelectedPointOnImage(n,e)}catch(c){U(c)||G.getLogger(this).error("failed to transform map point to pixel, cross symbol will not be plotted on image",{error:c,selectedPoint:i,feature:t})}})}worldToImage(e,t){return y(this,null,function*(){let{footprintExtent:a}=this,{imageSize:i}=this.activeViewer;if(this.mode==="none"||!this.currentBestFeature||!i||!a)return;let{attributes:{location:r,elevationSource:n,cameraHeading:c,elevation:l,cameraHeight:h},elevationSample:m}=this.currentBestFeature,p=r.clone(),d=yield ye(l??(r.z??0)-h,{elevationSample:m,elevationSource:n});this.currentBestFeature.elevationSample=d.elevationSample;let g=Array.isArray(e)?e:[e],f,_=yield Promise.all(g.map(w=>new Promise(F=>{if(!w.hasZ)return F(wt(w,d));F(w)})));if(r.spatialReference.isGeographic&&(p=yield K(p,D.WebMercator,t)),_=yield Promise.all(_.map(w=>y(this,null,function*(){return p.spatialReference.equals(w.spatialReference)?w:yield K(w,p.spatialReference,t)}))),C(t),this.mode==="panoramic")f=$a(_,{imageHeight:i[1],imageWidth:i[0],cameraHeading:c,cameraLocation:p});else{let w=ja(this.currentBestFeature.attributes,i[0],i[1]);f=Ua(_,H(S({},w),{cameraLocation:p}))}return Array.isArray(e)?f:f[0]})}updateCurrentCoveragePolygon(e){let{additionalFootprints:t,additionalCameraLocations:a,currentBestFeature:i,currentBestFeatureLocation:r,currentCoverageVisible:n,selectedPoint:c,view:l,_adapter:h,mode:m}=this,{attributes:{objectId:p},elevationSample:d}=i;if(this._initialCurrentCoverageUpdate){if(this._overlays?.removeAll(),this._initialCurrentCoverageUpdate=!1,this.bestFeatureCurrentFootprint=E(this.bestFeatureCurrentFootprint),e&&!this.invalidCameraHeading&&(e.visible=n,this.bestFeatureCurrentFootprint=e),l){let g=[...t,...a,r].filter(Ca);l.supportsGround&&d&&h?.updateGroundElevation&&(this._updateGroundElevation&&h.updateGroundElevation(g,d),m==="panoramic"&&h.updateGroundElevation([this.bestFeatureCurrentFootprint],d)),this._updateGroundElevation=!1,c&&(g.splice(-2,0,this.bestFeatureCurrentFootprint),g.push(new R({geometry:c.clone(),symbol:Pt.clone(),attributes:{imageID:p}}))),this._overlays.graphics.addMany(g)}}else if(l){if(this.invalidCameraHeading)return;this.bestFeatureCurrentFootprint&&(this._overlays?.remove(this.bestFeatureCurrentFootprint),this.bestFeatureCurrentFootprint=E(this.bestFeatureCurrentFootprint));let g=this.bestFeatureCurrentFootprint&&this._overlays?this._overlays.graphics.indexOf(this.bestFeatureCurrentFootprint):-1;e&&(this.bestFeatureCurrentFootprint=e,l?.supportsGround&&d&&h?.updateGroundElevation&&m==="panoramic"&&h.updateGroundElevation([e],d),e.visible=this.currentCoverageVisible,this._overlays?.graphics.add(this.bestFeatureCurrentFootprint,g>=0?g:this._overlays.graphics.length-1))}}};o([s()],u.prototype,"activeLayer",null),o([s({readOnly:!0})],u.prototype,"activeViewer",null),o([s()],u.prototype,"accuracyParametersMissing",null),o([s()],u.prototype,"additionalFeatures",void 0),o([s({type:z.ofType(R)})],u.prototype,"additionalCameraLocations",void 0),o([s({type:z.ofType(R)})],u.prototype,"additionalFootprints",void 0),o([s()],u.prototype,"areaMeasurementResult",void 0),o([s()],u.prototype,"areaMeasurementAccuracy",void 0),o([s()],u.prototype,"bestFeatureAngle",void 0),o([s()],u.prototype,"bestFeatureCurrentFootprint",void 0),o([s({type:R})],u.prototype,"bestFeatureFootprint",void 0),o([s({type:Number})],u.prototype,"brightness",null),o([s()],u.prototype,"collectionId",void 0),o([s({type:Number})],u.prototype,"contrast",null),o([s()],u.prototype,"conversionProps",void 0),o([s()],u.prototype,"coverageFrustums",void 0),o([s()],u.prototype,"coveragePolygons",void 0),o([s()],u.prototype,"currentBestFeature",void 0),o([s()],u.prototype,"currentBestFeatureLocation",void 0),o([s()],u.prototype,"currentCoverageVisible",void 0),o([s({json:{write:!1}})],u.prototype,"determineWorkflowForFeature",void 0),o([s()],u.prototype,"disabled",void 0),o([s()],u.prototype,"displayMessage",void 0),o([s()],u.prototype,"displayNewMeasurementButton",void 0),o([s()],u.prototype,"distanceMeasurementResult",void 0),o([s()],u.prototype,"distanceAccuracyArray",void 0),o([s()],u.prototype,"dataCaptureLayer",void 0),o([s({readOnly:!0})],u.prototype,"featureCount",null),o([s()],u.prototype,"features",void 0),o([s()],u.prototype,"groundCoordinates",void 0),o([s()],u.prototype,"heightMeasurementPixels",void 0),o([s()],u.prototype,"heightGraphic",void 0),o([s()],u.prototype,"heightMeasurementResult",void 0),o([s()],u.prototype,"heightMeasurementAccuracy",void 0),o([s()],u.prototype,"measurementAngle",void 0),o([s()],u.prototype,"tempDistance",void 0),o([s({readOnly:!0})],u.prototype,"imageGalleryEnabled",null),o([s()],u.prototype,"imageGeometryField",void 0),o([s({readOnly:!0})],u.prototype,"imageLoaded",null),o([s()],u.prototype,"imageLocationToolState",void 0),o([s({readOnly:!0})],u.prototype,"invalidCameraHeading",null),o([s()],u.prototype,"imagePointsInView",null),o([s()],u.prototype,"isAdditionalCoverageVisible",void 0),o([s()],u.prototype,"isAdditionalPointSourcesVisible",void 0),o([s()],u.prototype,"layer",void 0),o([s()],u.prototype,"layerView",null),o([s({readOnly:!0})],u.prototype,"layerFloorFilterClause",null),o([s({type:Number})],u.prototype,"localPort",void 0),o([s()],u.prototype,"mapImageConversionToolState",void 0),o([s()],u.prototype,"measureType",void 0),o([s()],u.prototype,"measurementGraphic",void 0),o([s({readOnly:!0,value:"none"})],u.prototype,"mode",null),o([s()],u.prototype,"navigatorCurrentBestFeature",void 0),o([s()],u.prototype,"oiObjectIdField",void 0),o([s({type:z.ofType(R)})],u.prototype,"overlayedCameraLocations",void 0),o([s()],u.prototype,"overlayedMapFeatures",void 0),o([s()],u.prototype,"pixelCoordinates",void 0),o([s()],u.prototype,"pointSources",void 0),o([s({readOnly:!0})],u.prototype,"popupEnabled",null),o([s()],u.prototype,"previousFeatureAngle",void 0),o([s()],u.prototype,"referencePoint",null),o([s({readOnly:!0})],u.prototype,"sectorData",null),o([s()],u.prototype,"selectedPoint",void 0),o([s({type:Number})],u.prototype,"sharpness",null),o([s()],u.prototype,"shouldShowSelectedImage",void 0),o([s()],u.prototype,"sketch",void 0),o([s()],u.prototype,"draw",void 0),o([s()],u.prototype,"sketchAdapter",void 0),o([s({readOnly:!0})],u.prototype,"sketchGraphicsLayer",null),o([s({readOnly:!0})],u.prototype,"state",null),o([s({readOnly:!0})],u.prototype,"thumbnails",null),o([s()],u.prototype,"updateFootprint",void 0),o([s()],u.prototype,"updateFootprintPanorama",void 0),o([s({value:null})],u.prototype,"view",null),o([s()],u.prototype,"_adapter",void 0),o([s()],u.prototype,"_sketchGraphicsLayer",null),o([s()],u.prototype,"_highlightedFeatureHandle",void 0),o([s()],u.prototype,"_imageViewer",void 0),o([s()],u.prototype,"_initialCurrentCoverageUpdate",void 0),o([s()],u.prototype,"_locationPointOnImage",void 0),o([s()],u.prototype,"_overlays",void 0),o([s({readOnly:!0})],u.prototype,"_overlaysView",null),o([s()],u.prototype,"_panoramicViewer",void 0),o([s()],u.prototype,"_previousCursor",void 0),o([s()],u.prototype,"_referencePointOnGround",void 0),o([s()],u.prototype,"_referencePointOnImage",void 0),o([s()],u.prototype,"_sectorData",void 0),o([s({readOnly:!0})],u.prototype,"_updatingHandles",void 0),o([s()],u.prototype,"footprintExtent",void 0),o([s()],u.prototype,"_featureChangedTask",void 0),u=o([T("esri.widgets.OrientedImageryViewer.OrientedImageryViewerViewModel")],u);var cl=u;export{tt as a,Li as b,ps as c,us as d,cl as e};
