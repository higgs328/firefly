import{h as Ye}from"./chunk-CTPO46HK.js";import{b as Re,c as Ge,d as Qe,e as ee,f as je,g as ze,h as Be,i as Ke,j as Ze,k as Je,l as $e,n as Xe}from"./chunk-3CNRS47L.js";import{a as O}from"./chunk-KGFZFPKU.js";import{a as te}from"./chunk-ZZRMWUJR.js";import{a as et}from"./chunk-COKTCKDL.js";import{a as De}from"./chunk-XLETJAG6.js";import{a as xe}from"./chunk-XA6M6D63.js";import{a as N}from"./chunk-3W5FW4UA.js";import{c as Oe}from"./chunk-ETLJEDNA.js";import{a as Y}from"./chunk-EFTNLZSK.js";import{a as X}from"./chunk-PKVI3POI.js";import{d as Ne}from"./chunk-4JIR4MZV.js";import{a as ue}from"./chunk-7IOOWZFM.js";import{a as Ue}from"./chunk-2HQALWZQ.js";import{a as qe}from"./chunk-7XYYDAZO.js";import{j as He}from"./chunk-Z7TBAZRW.js";import{a as Pe}from"./chunk-RCWIX6EL.js";import{a as Le}from"./chunk-CVKHXVTW.js";import{i as U}from"./chunk-YTAJKLRN.js";import{a as Ee}from"./chunk-456M7HFK.js";import{D as We,n as Te,o as Ve}from"./chunk-Y4PJQPM4.js";import{A as ce,b as Ie,e as Se,g as R,h as S}from"./chunk-XR5FT7TQ.js";import{a as $}from"./chunk-LAX5536Z.js";import{a as J}from"./chunk-JQAW4OB5.js";import{b as Z}from"./chunk-JLPLCY2B.js";import{a as ne}from"./chunk-O3EGNJTY.js";import{b as Me}from"./chunk-SLAWDKDA.js";import{a as _,b as Ce,e as K,i as le,j as de}from"./chunk-TG45K3WR.js";import{f as z}from"./chunk-RAI4DTMT.js";import{b as B}from"./chunk-ACP3S2CH.js";import{a as s}from"./chunk-QGVBCWUY.js";import{H as q,z as se}from"./chunk-MYO4NP2N.js";import{e as n}from"./chunk-NFIPKH6V.js";import{l as b}from"./chunk-5QEXLALV.js";import{K as H,L as Fe,b as ke,e as W,o as _e,p as be,r as D,u as Ae,z as j}from"./chunk-4PTIEWMT.js";import{a as I,f as Q}from"./chunk-TG2UTNEO.js";import{b as w}from"./chunk-YOFFGXOB.js";import{g as ve}from"./chunk-XRGPJ3QY.js";import{a as L,b as P,e as V,f as l}from"./chunk-VTHXE323.js";var pe,T=pe=class extends q{constructor(o){super(o),this.editorItem=null,this.feature=null,this.utilityNetwork=null,this.associationType=null,this.parent=null,this.associationInput=null,this.viewModel=null}static create(o){return l(this,null,function*(){let{feature:e,parent:t,viewModel:a,utilityNetwork:i,associationType:r,associationInput:d}=o,c=a.editorItems.find(u=>u.layer===e.layer);if(!c)throw new w("no-editorItem-found","The EditorViewModel provided did not have an EditorItem associated with the specified Graphic's layer");return new pe({editorItem:c,feature:e,parent:t,viewModel:a,utilityNetwork:i,associationType:r,associationInput:d})})}};s([n({constructOnly:!0})],T.prototype,"editorItem",void 0),s([n()],T.prototype,"feature",void 0),s([n({constructOnly:!0})],T.prototype,"utilityNetwork",void 0),s([n({constructOnly:!0})],T.prototype,"associationType",void 0),s([n()],T.prototype,"parent",void 0),s([n()],T.prototype,"associationInput",void 0),s([n()],T.prototype,"viewModel",void 0),T=pe=s([b("esri.widgets.Editor.AddAssociationWorkflowData")],T);var tt=T;function he(o){return new Pe({fromNetworkElement:at(o.fromFeature,o.utilityNetwork),toNetworkElement:at(o.toFeature,o.utilityNetwork),associationType:o.associationType,globalId:Me()})}function at(o,e){let t=S(o.sourceLayer)?o.sourceLayer.parent:o.sourceLayer;if(t&&"globalIdField"in t&&"layerId"in t&&t.globalIdField){let a=e.getSourceIdByLayerId(t.layerId),i=e.getSourceTypeById(a)==="junction"?e.getTerminalConfiguration(o):void 0,r=i?.terminals.at(0)?.id,d=t.fieldsIndex.get("assetGroup").name,c=t.fieldsIndex.get("assetType").name,u=o.attributes[d],p=o.attributes[c],m=o.attributes[t.globalIdField];if(m&&a!=null)return new Le({globalId:m,networkSourceId:a,assetGroupCode:u,assetTypeCode:p,terminalId:r})}}var ye=100,it="association-key",y=class extends q{constructor(o){super(o),this.graphic=null,this.layer=null,this.map=null,this.utilityNetwork=null,this.associationType=null,this.featureCount=0,this._queryAbortController=null,this._queryPageAbortController=null,this._queryFeatureCountAbortController=null,this.featuresPerPage=30,this.selectedFeature=null,this.association=null,this.filterOptionsVisible=!1,this.filterWhereClause=null,this._rulesTable=null,this._canAssociate=!1,this._whereClause=null,this._setUpItemsTask=null,this._updatingHandlesSetUp=new J,this._queryFeaturesTask=null,this._updatingHandlesQueryFeatures=new J,this._validateAssociationTask=null,this._updatingHandlesAssociation=new J,this._cancelQuery=()=>{let{_queryAbortController:e}=this;e&&e.abort(),this._queryAbortController=null},this._cancelQueryFeatureCount=()=>{let{_queryFeatureCountAbortController:e}=this;e&&e.abort(),this._queryFeatureCountAbortController=null},this._cancelQueryPage=()=>{let{_queryPageAbortController:e}=this;e&&e.abort(),this._queryPageAbortController=null},this._queryController=()=>l(this,null,function*(){this._cancelQuery();let e=new AbortController;this._queryAbortController=e,yield j(this._query()).catch(()=>this._cancelQuery()),this._queryAbortController===e&&(this._queryAbortController=null)}),this._queryFeatureCountController=e=>l(this,null,function*(){this._cancelQueryFeatureCount();let t=new AbortController;this._queryFeatureCountAbortController=t,yield j(this._queryFeatureCount(e)).catch(()=>this._cancelQueryFeatureCount()),this._queryFeatureCountAbortController===t&&(this._queryFeatureCountAbortController=null)}),this._queryPageController=()=>l(this,null,function*(){let e=new AbortController;this._queryPageAbortController=e,yield j(this._queryPage()).catch(()=>this._cancelQueryPage()),this._queryPageAbortController===e&&(this._queryPageAbortController=null)}),this._queryDebounced=H(this._queryController,ye),this._queryFeatureCountDebounced=H(this._queryFeatureCountController,ye),this._queryPageDebounced=H(this._queryPageController,ye)}initialize(){this.addHandles([_(()=>[this.graphic,this.layer,this.map,this.utilityNetwork,this.globalId,this.associationType],()=>this._syncLayerItems(),de),_(()=>[this.selectedLayer,this.filterWhereClause,this.featuresPerPage],()=>{this.selectedLayer&&this._setUpFeatures()}),_(()=>this.selectedFeature,()=>{this._setUpAssociation()}),_(()=>this.featurePage,()=>this._queryPageDebounced())])}destroy(){this._setUpItemsTask=W(this._setUpItemsTask),this._updatingHandlesSetUp.destroy(),this._queryFeaturesTask=W(this._queryFeaturesTask),this._updatingHandlesQueryFeatures.destroy(),this._validateAssociationTask=W(this._validateAssociationTask),this._updatingHandlesAssociation.destroy(),this._cancelQuery(),this._cancelQueryFeatureCount(),this._cancelQueryPage()}get mapLayers(){let{map:o}=this;if(!o)return null;let e=new Set,t=i=>{!Te(i)||R(i)||e.has(i)||e.add(i)},a=i=>{Ue(i)||i.type==="catalog-footprint"||(Se(i)?(i.layers?.forEach(t),i.tables?.forEach(t)):Ye(i)?(i.sublayers?.forEach(t),i.subtables?.forEach(t)):R(i)?i.sublayers?.forEach(t):t(i))};return o.allLayers.forEach(a),o.allTables.forEach(a),new B([...e])}get state(){let{_queryAbortController:o,_queryPageAbortController:e,canQuery:t}=this;return o||e||this._updatingHandlesQueryFeatures.updating?"querying":this.canLoad&&this._updatingHandlesSetUp.updating?"loading":this._updatingHandlesAssociation.updating?"validating":t?"ready":"disabled"}get canAddAssociation(){return!(this.updating||!this.association)&&this._canAssociate}get globalId(){return(this.globalIdField&&this.graphic?.attributes?.[this.globalIdField])??null}get globalIdField(){let{layer:o}=this;return o?.globalIdField??null}get layerItems(){return this._get("layerItems")||new B}get featureItems(){return this._get("featureItems")||new B}set featurePage(o){let{featuresPerPage:e,featureCount:t}=this,a=1,i=Math.ceil(t/e)||1;this._set("featurePage",Math.min(Math.max(o,a),i))}get featurePage(){return this._get("featurePage")}get canLoad(){let{map:o,utilityNetwork:e,graphic:t,associationType:a}=this;return!!(o&&e&&t&&a)}get canQuery(){let{utilityNetwork:o,graphic:e,associationType:t,selectedLayer:a}=this;return!!(o&&e&&t&&a)}get updating(){return this._updatingHandlesSetUp.updating||this._updatingHandlesAssociation.updating}get selectedLayer(){return this._get("selectedLayer")}set selectedLayer(o){o!==this.selectedLayer&&(this.filterWhereClause=null),this._set("selectedLayer",o)}get queryWhereClause(){let{_whereClause:o,filterWhereClause:e}=this;return Z(o,e)}_queryFeatureCount(o){return l(this,null,function*(){let{selectedLayer:e,_queryFeatureCountAbortController:t}=this;if(this._set("featureCount",0),!e)return;yield e.load();let a=e.createQuery();a.returnGeometry=!1,a.where=Z(a.where,o);let i=yield e.queryFeatureCount(a,{signal:t?.signal});i>0&&this._set("featureCount",i)})}_query(){return l(this,null,function*(){let{canQuery:o,queryWhereClause:e,_queryAbortController:t,featureItems:a}=this;o&&(this.featurePage=1,a.destroyAll(),this.featureCount&&!this.destroyed&&a.addMany(yield this._queryAssociatedFeatures(e,{signal:t?.signal})))})}_queryPage(){return l(this,null,function*(){let{canQuery:o,queryWhereClause:e,featurePage:t,_queryPageAbortController:a,featureCount:i,featureItems:r}=this;o&&(t<2||!i||r.addMany(yield this._queryAssociatedFeatures(e,{signal:a?.signal})))})}_convertTypeToDirection(o){switch(o){case"attachment":return[{type:"attachment",direction:"from"}];case"connectivity":return[{type:"junction-junction-connectivity"},{type:"junction-edge-from-connectivity"},{type:"junction-edge-midspan-connectivity"},{type:"junction-edge-to-connectivity"}];case"container":return[{type:"containment",direction:"to"}];case"content":return[{type:"containment",direction:"from"}];case"structure":return[{type:"attachment",direction:"to"}]}}getRulesTable(){return l(this,null,function*(){let{utilityNetwork:o}=this;if(!o)return null;if(this._rulesTable)return this._rulesTable;let e=yield o.getRulesTable();return yield e?.load(),this._rulesTable=e,e})}_syncLayerItems(){return l(this,null,function*(){W(this._setUpItemsTask);let{graphic:o,associationType:e,layerItems:t,canLoad:a}=this,i=z(r=>l(this,null,function*(){if(this.selectedLayer=null,t.destroyAll(),!a)return;let d=this.mapLayers?.toArray();if(!d||r.aborted)return;let c=yield this.getRulesTable(),u=this._convertTypeToDirection(e.type),p=c?.getLayersCanAssociateWith(o,d,u);r.aborted||t.addMany(p||[])}));this._updatingHandlesSetUp.addPromise(i.promise),this._setUpItemsTask=i})}_setUpFeatures(){return l(this,null,function*(){W(this._queryFeaturesTask);let{graphic:o,associationType:e,selectedLayer:t,canQuery:a}=this;if(!a)return;let i=z(r=>l(this,null,function*(){let d=yield this.getRulesTable(),c=this._convertTypeToDirection(e.type),u=d?.getFeaturesCanAssociateWithClause(o,t,c);this._whereClause=u,r.aborted||(yield this._queryFeatureCountDebounced(this.queryWhereClause),yield this._queryDebounced())}));this._updatingHandlesQueryFeatures.addPromise(i.promise),this._queryFeaturesTask=i})}_determineFromAndTo(o,e,t){return t==="from"?{fromFeature:o,toFeature:e}:{fromFeature:e,toFeature:o}}_determineJunctionEdgeConnectivity(o,e){let{utilityNetwork:t}=this,a=S(o.sourceLayer)?o.sourceLayer.parent:o.sourceLayer,i=S(e.sourceLayer)?e.sourceLayer.parent:e.sourceLayer;if(!(t&&a&&"layerId"in a&&i&&"layerId"in i))return{fromFeature:o,toFeature:e,type:"junction-junction-connectivity"};let r=t.getSourceIdByLayerId(a.layerId),d=t.getSourceIdByLayerId(i.layerId);if(!r||!d)return{fromFeature:o,toFeature:e,type:"junction-junction-connectivity"};let c=t.getSourceTypeById(r)==="junction",u=t.getSourceTypeById(d)==="junction";return c&&u?{fromFeature:o,toFeature:e,type:"junction-junction-connectivity"}:u?{fromFeature:e,toFeature:o,type:"junction-edge-midspan-connectivity"}:{fromFeature:o,toFeature:e,type:"junction-edge-midspan-connectivity"}}_setUpAssociationHandles(){this.removeHandles(it),this.association&&this.addHandles(_(()=>[this.association?.associationType,this.association?.fromNetworkElement,this.association?.fromNetworkElement?.terminalId,this.association?.toNetworkElement,this.association?.toNetworkElement?.terminalId],()=>this.validateAssociation(),de),it)}_setUpAssociation(){let{utilityNetwork:o,graphic:e,selectedFeature:t,associationType:a}=this;if(!(o&&e&&t&&a))return void(this.association=null);let i=this._convertTypeToDirection(a.type);if(i.length>1){let{fromFeature:c,toFeature:u,type:p}=this._determineJunctionEdgeConnectivity(e,t.feature);return this.association=he({fromFeature:c,toFeature:u,utilityNetwork:o,associationType:p}),void this._setUpAssociationHandles()}let{fromFeature:r,toFeature:d}=this._determineFromAndTo(e,t.feature,i[0].direction);this.association=he({fromFeature:r,toFeature:d,utilityNetwork:o,associationType:i[0].type}),this._setUpAssociationHandles()}_processFeatures(o){return l(this,null,function*(){return Promise.all(o.map(e=>l(this,null,function*(){let{sourceLayer:t}=e;return t&&"getFeatureTitle"in t?{label:yield t.getFeatureTitle(e),feature:e}:{label:X(e),feature:e}})))})}_queryAssociatedFeatures(o,e){return l(this,null,function*(){let{featuresPerPage:t,layer:a,featurePage:i,featureCount:r,selectedLayer:d}=this,{canQuery:c,globalId:u}=this;if(!c||!a||!d||u==null)return[];let p=((i-1)*t+r)%r,m=t,{historicMoment:h,gdbVersion:F}=d,f=d.createQuery();f.where=Z(f.where,o),f.start=p,f.num=m,f.returnGeometry=!1,f.historicMoment=h,f.gdbVersion=F,f.outFields=["*"];let k=yield d.queryFeatures(f,{signal:e?.signal});return yield this._processFeatures(k.features)})}validateAssociation(){W(this._validateAssociationTask);let{utilityNetwork:o,association:e}=this,t=z(()=>l(this,null,function*(){o&&e&&(this._canAssociate=yield o.canAddAssociation(e))}));this._updatingHandlesAssociation.addPromise(t.promise),this._validateAssociationTask=t}};s([n({type:$})],y.prototype,"graphic",void 0),s([n()],y.prototype,"layer",void 0),s([n()],y.prototype,"map",void 0),s([n({readOnly:!0})],y.prototype,"mapLayers",null),s([n()],y.prototype,"utilityNetwork",void 0),s([n()],y.prototype,"associationType",void 0),s([n()],y.prototype,"state",null),s([n({readOnly:!0})],y.prototype,"canAddAssociation",null),s([n({readOnly:!0})],y.prototype,"globalId",null),s([n({readOnly:!0})],y.prototype,"globalIdField",null),s([n()],y.prototype,"featureCount",void 0),s([n({readOnly:!0})],y.prototype,"layerItems",null),s([n({readOnly:!0})],y.prototype,"featureItems",null),s([n()],y.prototype,"_queryAbortController",void 0),s([n()],y.prototype,"_queryPageAbortController",void 0),s([n()],y.prototype,"_queryFeatureCountAbortController",void 0),s([n({value:1})],y.prototype,"featurePage",null),s([n()],y.prototype,"featuresPerPage",void 0),s([n({readOnly:!0})],y.prototype,"canLoad",null),s([n({readOnly:!0})],y.prototype,"canQuery",null),s([n({readOnly:!0})],y.prototype,"updating",null),s([n()],y.prototype,"selectedLayer",null),s([n()],y.prototype,"selectedFeature",void 0),s([n()],y.prototype,"association",void 0),s([n()],y.prototype,"filterOptionsVisible",void 0),s([n()],y.prototype,"filterWhereClause",void 0),s([n()],y.prototype,"queryWhereClause",null),s([n()],y.prototype,"_rulesTable",void 0),s([n()],y.prototype,"_canAssociate",void 0),s([n()],y.prototype,"_whereClause",void 0),y=s([b("esri.widgets.FeatureForm.UtilityNetworkAssociationAddAssociationViewModel")],y);var ot=y;var me,rt={exit:Symbol()},A=me=class o extends O{constructor(e){super(e),this._utilityNetworkAssociationAddAssociationViewModel=new ot,this._highlightHelper=null,this.sourceFeatureItem=null,this.type="add-association"}initialize(){let{data:e}=this,{view:t}=e.viewModel;t&&(this._highlightHelper=new N({view:t,highlightName:U}),this.addHandles(I(()=>this._highlightHelper?.removeAll())));let a=new AbortController;this.addHandles(Q(a)),this._updatingHandles.addPromise(this._setup(a))}get editorItem(){return this.data.editorItem}get featureFormViewModel(){return this._featureFormViewModel}get utilityNetworkAssociationAddAssociationViewModel(){return this._utilityNetworkAssociationAddAssociationViewModel}get hasPendingEdits(){return!!this._utilityNetworkAssociationAddAssociationViewModel.selectedFeature}get layer(){return this.data.editorItem.layer}get parent(){return this.data.parent}get parentLayer(){return this.parent?.data.editorItem.layer}get reliesOnOwnerAdminPrivileges(){return this.editorItem.capabilities.create.reliesOnOwnerAdminPrivileges}enter(){return l(this,null,function*(){this._initializeUtilityNetworkAssociationAddAssociationViewModel()})}exit(){this.removeHandles(rt.exit)}start(){return l(this,null,function*(){return yield V(o.prototype,this,"start").call(this),null})}_setup(e){return l(this,null,function*(){let{data:t}=this,{feature:a}=t;try{let i=yield ee(a,t.viewModel.view.spatialReference,e.signal);if(D(e))return;let r=i.sourceLayer&&"getFeatureTitle"in i.sourceLayer?yield i.sourceLayer.getFeatureTitle(i):X(i);if(D(e))return;this.sourceFeatureItem={feature:a,label:r},this._initializeUtilityNetworkAssociationAddAssociationViewModel()}catch(i){this.cancel({force:!0,error:new w("editor:failed-to-fetch-full-feature","Failed to retrieve all information for this feature. The update cannot proceed.",{detail:{error:i}})})}})}_initializeUtilityNetworkAssociationAddAssociationViewModel(){let{viewModel:{view:e},utilityNetwork:t,associationType:a}=this.data,i=this._utilityNetworkAssociationAddAssociationViewModel;i.graphic=this.sourceFeatureItem.feature,i.map=e?.map,i.utilityNetwork=t,i.layer=this.layer,i.associationType=a,t.networkSystemLayers.loadAssociationsTable(),this.addHandles([_(()=>i.selectedLayer,r=>{r&&this.go("add-association-select-feature")}),_(()=>i.selectedFeature,r=>{r&&this.go("add-association-create-association")})],rt.exit)}static create(e){return l(this,null,function*(){let t=new me({data:yield tt.create(e),onCommit:this._onCommitFactory(e.applyEditsFeatureService)});return t._set("steps",this._createWorkflowSteps(t)),t})}static _createWorkflowSteps(e){return[{id:"add-association-select-layer",setUp(){return l(this,null,function*(){let{utilityNetworkAssociationAddAssociationViewModel:r}=e.data.viewModel;r&&(r.selectedLayer=null,r.selectedFeature=null,r.association=null)})},tearDown(){return l(this,null,function*(){})}},{id:"add-association-select-feature",setUp(){return l(this,null,function*(){let{utilityNetworkAssociationAddAssociationViewModel:r}=e.data.viewModel;r&&(r.selectedFeature=null,r.association=null)})},tearDown(){return l(this,null,function*(){})}},{id:"add-association-create-association",setUp(){return l(this,null,function*(){})},tearDown(){return l(this,null,function*(){})}}]}};A._onCommitFactory=o=>e=>l(void 0,null,function*(){let{feature:t,utilityNetwork:a,associationInput:i}=e,{utilityNetworkAssociationAddAssociationViewModel:r}=e.viewModel,{association:d}=r;yield a.networkSystemLayers.loadAssociationsTable();let c=a?.generateAddAssociations([d]);if(!c)throw new w("editor:failed-to-add-association","Could not create payload needed to add association");let u=t.sourceLayer,p=S(u)&&u.parent?u.parent:u,m=te([p]),h=m.values().next().value?.featureService;if(!h)throw new w("editor:failed-to-delete-association","Could not retrieve feature service needed to delete association");yield h?.load();let F=a?.gdbVersion??void 0;yield o(h,[c],{gdbVersion:F}),yield i.refresh()}),s([n()],A.prototype,"_utilityNetworkAssociationAddAssociationViewModel",void 0),s([n()],A.prototype,"_featureFormViewModel",void 0),s([n()],A.prototype,"editorItem",null),s([n()],A.prototype,"featureFormViewModel",null),s([n()],A.prototype,"utilityNetworkAssociationAddAssociationViewModel",null),s([n()],A.prototype,"sourceFeatureItem",void 0),s([n()],A.prototype,"hasPendingEdits",null),s([n()],A.prototype,"layer",null),s([n()],A.prototype,"parent",null),s([n()],A.prototype,"parentLayer",null),s([n()],A.prototype,"reliesOnOwnerAdminPrivileges",null),A=me=s([b("esri.widgets.Editor.AddAssociationWorkflow")],A);var ae,M=ae=class extends q{constructor(o){super(o),this.association=null,this.editorItem=null,this.edits=null,this.parent=null,this.featureFormCallbacks=null,this.viewModel=null}get attachmentsCapabilities(){let o=this.editorItem.capabilities.update.attachments.enabled;return{editing:!0,operations:{add:o,update:o,delete:o}}}get formTemplate(){return this.editorItem.formTemplate}static create(o){return l(this,null,function*(){let e=ae._makeConstructorProps(o);return new ae(e)})}static _makeConstructorProps(o){let{association:e,feature:t,parent:a,featureFormCallbacks:i,viewModel:r}=o,d=r.editorItems.find(c=>c.layer===t.layer);if(!d)throw new w("no-editorItem-found","The EditorViewModel provided did not have an EditorItem associated with the specified Graphic's layer");return{association:e,editorItem:d,edits:new De({feature:t}),parent:a,featureFormCallbacks:i,viewModel:r}}};s([n()],M.prototype,"association",void 0),s([n()],M.prototype,"attachmentsCapabilities",null),s([n({constructOnly:!0})],M.prototype,"editorItem",void 0),s([n()],M.prototype,"edits",void 0),s([n()],M.prototype,"formTemplate",null),s([n()],M.prototype,"parent",void 0),s([n()],M.prototype,"featureFormCallbacks",void 0),s([n()],M.prototype,"viewModel",void 0),M=ae=s([b("esri.widgets.Editor.UpdateRecordWorkflowData")],M);var ie=M;var oe,x=oe=class extends ie{constructor(o){super(o),this.sketchOptions=null,this.snappingManager=null}static create(o){return l(this,null,function*(){let{feature:e,snappingManager:t,viewModel:a}=o,i=o.sketchOptions??new Y,{view:r}=a;if(!r)throw new w("editor:cannot-create-workflow-data","The provided EditorViewModel does not have an associated view");let d=yield Ze(r,e.layer);return new oe(P(L({},oe._makeConstructorProps(o)),{layerView:d,sketchOptions:i,snappingManager:t}))})}};s([n()],x.prototype,"layerView",void 0),s([n({constructOnly:!0})],x.prototype,"sketchOptions",void 0),s([n()],x.prototype,"snappingManager",void 0),x=oe=s([b("esri.widgets.Editor.UpdateFeatureWorkflowData")],x);var st=x;var we,re={exit:Symbol()},v=we=class o extends O{constructor(e){super(e),this._highlightHelper=null,this.fullFeature=null,this.type="update-table-record"}initialize(){let{data:e}=this,{edits:t}=e,{view:a}=e.viewModel,i=t.feature;a&&(this._highlightHelper=new N({view:a,highlightName:U}),this.addHandles(I(()=>this._highlightHelper?.removeAll())));let r=new AbortController;this.addHandles(Q(r)),this._updatingHandles.addPromise(ee(i,e.viewModel.view.spatialReference,r.signal).then(d=>{D(r)||(this._onFullFeatureLoaded(d),this._initializeFeatureFormViewModel())},d=>this.cancel({force:!0,error:new w("editor:failed-to-fetch-full-feature","Failed to retrieve all information for this feature. The update cannot proceed.",{detail:{error:d}})})))}get editorItem(){return this.data.editorItem}get featureFormViewModel(){return this._featureFormViewModel}get hasPendingEdits(){return this.data.edits.modified}get layer(){return this.data.editorItem.layer}get parent(){return this.data.parent}get parentLayer(){return this.parent?.data.editorItem.layer}get shouldShowAttachments(){return this.editorItem.capabilities.attachments.enabled}get shouldAllowAttachmentEditing(){return this.editorItem.capabilities.update.attachments.enabled}get reliesOnOwnerAdminPrivileges(){let e=this.editorItem.capabilities;return e.update.reliesOnOwnerAdminPrivileges||e.delete.reliesOnOwnerAdminPrivileges}deleteAndCommit(){return l(this,null,function*(){return this.data.edits.stageDelete(),this.commit()})}enter(){return l(this,null,function*(){this._configureAttachmentsViewModel()})}exit(e){this.removeHandles(re.exit)}start(){return l(this,null,function*(){return yield V(o.prototype,this,"start").call(this),null})}_configureAttachmentsViewModel(){let{data:e,fullFeature:t}=this,{attachmentsCapabilities:a,viewModel:i}=e,{attachmentsViewModel:r}=i;r.set({capabilities:a,graphic:t,filesEnabled:!1,mode:"view"}),this.addHandles([I(()=>r.fileInfos.removeAll()),_(()=>r.mode,d=>{switch(d){case"add":this.go("adding-attachment");break;case"edit":this.go("editing-attachment")}})],re.exit)}_initializeFeatureFormViewModel(){let{association:e,edits:t,formTemplate:a,viewModel:{view:i}}=this.data,r=this._featureFormViewModel=new xe({activeAssociation:e,arcadeEditType:"UPDATE",feature:this.fullFeature,formTemplate:a,highlightHelper:this._highlightHelper,map:i?.map,spatialReference:i.spatialReference,timeZone:i?.timeZone});r.callbacks=P(L({},this.data.featureFormCallbacks),{showAllRelatedRecords:c=>r.relationshipId=c.relationshipId,viewAssociatedLayers:c=>r.associationId=c.associationId,viewAssociatedFeatures:c=>r.associatedLayer=c.associatedLayer});let{initialFeature:d}=t;d&&r.overrideInitialFeature(d),this.addHandles([r.on("value-change",()=>{t.updateAttributes(r.getValues()),this.fullFeature.attributes=t.feature.attributes}),_(()=>i?.timeZone,c=>r.timeZone=c)])}_onFullFeatureLoaded(e){this.fullFeature=e;let{edits:t}=this.data;t.updateAttributes(e.attributes),t.trackChanges()}static create(e){return l(this,null,function*(){let t=new we({data:yield ie.create(e),onCommit:this._onCommitFactory(e.applyEdits)});return t._set("steps",this._createWorkflowSteps(t)),t})}static _createWorkflowSteps(e){let{attachmentsViewModel:t}=e.data.viewModel;return[{id:"editing-attributes",setUp(){return l(this,null,function*(){})},tearDown(){return l(this,null,function*(){})}},{id:"adding-attachment",setUp(){return l(this,null,function*(){})},tearDown(){return l(this,null,function*(){t.mode="view"})}},{id:"editing-attachment",setUp(){return l(this,null,function*(){})},tearDown(){return l(this,null,function*(){t.mode="view"})}}]}};v._onCommitFactory=o=>e=>l(void 0,null,function*(){let{edits:t}=e,{feature:a}=t;if(!a)return;let i=a.sourceLayer,r=a.clone();if(!t.attributesModified||t.stagedForDelete){let c=i.objectIdField;if(r.attributes={[c]:a.getAttribute(c)},i.type==="scene"&&i.infoFor3D!=null){let u=i.associatedLayer?.globalIdField;u!=null&&r.setAttribute(u,a.getAttribute(u))}}t.geometryModified&&!t.stagedForDelete||(r.geometry=null);let d=t.stagedForDelete?"deleteFeatures":"updateFeatures";yield o(i,{[d]:[r]})}),s([n()],v.prototype,"_featureFormViewModel",void 0),s([n()],v.prototype,"editorItem",null),s([n()],v.prototype,"featureFormViewModel",null),s([n()],v.prototype,"fullFeature",void 0),s([n()],v.prototype,"hasPendingEdits",null),s([n()],v.prototype,"layer",null),s([n()],v.prototype,"parent",null),s([n()],v.prototype,"parentLayer",null),s([n()],v.prototype,"shouldShowAttachments",null),s([n()],v.prototype,"shouldAllowAttachmentEditing",null),s([n()],v.prototype,"reliesOnOwnerAdminPrivileges",null),v=we=s([b("esri.widgets.Editor.UpdateRecordWorkflow")],v);var fe,C=P(L({},re),{highlights:Symbol(),sketchGraphics:Symbol(),sketchViewModel:Symbol(),waitingForTool:Symbol()}),E=fe=class o extends v{constructor(e){super(e),this.type="update-feature",this._layerViewEditSession=null,this._sketchGraphicClone=null,this._sketchViewModel=null,this._webStyleCache=new Map}destroy(){this._layerViewEditSession?.rollback()}commit(){return l(this,null,function*(){this.removeHandles(C.sketchGraphics);try{let e=this.data.edits.stagedForDelete;yield V(o.prototype,this,"commit").call(this);let t=this._layerViewEditSession;e?t?.rollback():t?.commit()}catch(e){throw yield this._configureSketchViewModel(),new w("editor-workflow:failed-to-commit","An error occurred when sending the updates to the service",{error:e})}})}start(){return l(this,null,function*(){return yield V(o.prototype,this,"start").call(this),yield this._initializeSketchViewModel()})}_initializeFeatureFormViewModel(){super._initializeFeatureFormViewModel(),this.addHandles([this._featureFormViewModel.on("value-change",e=>{this._layerViewEditSession?.setAttribute(e.fieldName,e.value)}),_(()=>this._featureFormViewModel.feature?.sourceLayer,e=>this._sketchGraphicClone.sourceLayer=e)])}_configureHighlight(){let{edits:e,layerView:t}=this.data;Ee(t)&&this.addHandles(t.highlight(e.feature),C.highlights)}_configureSketchViewModel(){return l(this,null,function*(){let e=this._sketchViewModel;if(!e)return;let{data:t,_featureFormViewModel:a,_sketchGraphicClone:i}=this,{edits:r,viewModel:d}=t,c=r.feature,{view:u}=d,p=Re(c),m=yield je({feature:c,featureClone:i,visualVariableAttributes:p,sketchViewModel:e,view:u,onUpdate:({geometry:h,attributes:F},f)=>{if(r.updateAttributes(F),r.updateGeometry(h),a.feature&&(a.feature.geometry=h),p.rotation!=null){let{field:k}=p.rotation;a.setValue(k,F[k])}if(p.size!=null){let{field:k}=p.size;a.setValue(k,F[k])}(f.type==="undo"||f.type==="redo"||f.type==="update"&&f.toolEventInfo!=null&&Ke(f.toolEventInfo.type))&&a.notifyFeatureGeometryChanged()},addUpdatingPromise:h=>{this._updatingHandles.addPromise(h)},addHandle:h=>{this.addHandles(h,C.waitingForTool)},webStyleCache:this._webStyleCache});this.addHandles(m,C.sketchGraphics),e.addHandles(m)})}_initializeSketchViewModel(){return l(this,null,function*(){let{data:e,_sketchGraphicClone:t}=this,a=e.edits.feature,{capabilities:i,layer:r}=e.editorItem,{view:d}=e.viewModel;if(this.removeHandles([C.highlights,C.sketchGraphics,C.sketchViewModel,C.waitingForTool]),!i.update.geometry||d?.type==="3d"&&He(r.elevationInfo))return{enter:()=>l(this,null,function*(){this.hasHandles(C.highlights)||this._configureHighlight()}),exit:()=>this.removeHandles([C.highlights])};let c=new qe({elevationInfo:r.elevationInfo,internal:!0,listMode:"hide"}),u=new Oe({allowDeleteKey:!1,layer:c,sketchOptions:e.sketchOptions,snappingManager:e.snappingManager,updateOnGraphicClick:!1,view:d});return this._sketchViewModel=u,d?.map.add(c),this.addHandles(I(()=>{d?.destroyed||d?.map.remove(c),c.destroy(),this._sketchViewModel=ke(u)}),C.sketchViewModel),yield Ge(t,this._webStyleCache,d?.type==="2d"?d.scale:null),this.addHandles([yield ze(u,a,t)]),{enter:()=>l(this,null,function*(){this.hasHandles(C.sketchGraphics)||(yield this._configureSketchViewModel())}),exit:()=>this.removeHandles([C.sketchGraphics]),viewModel:u}})}_onFullFeatureLoaded(e){super._onFullFeatureLoaded(e);let t=this._sketchGraphicClone=$e(e),{edits:a,layerView:i}=this.data;a.updateGeometry(e.geometry),a.trackChanges(),Je(i)&&(this._layerViewEditSession=i.createInteractiveEditSession(t))}static create(e){return l(this,null,function*(){let t=new fe({data:yield st.create(e),onCommit:this._onCommitFactory(e.applyEdits)});return t._set("steps",this._createWorkflowSteps(t)),t})}get test(){}};s([n()],E.prototype,"_layerViewEditSession",void 0),s([n()],E.prototype,"_sketchGraphicClone",void 0),s([n()],E.prototype,"_sketchViewModel",void 0),E=fe=s([b("esri.widgets.Editor.UpdateFeatureWorkflow")],E);var ge,lt="esri.widgets.Editor.UpdateWorkflow",ct=()=>ve.getLogger(lt),g=ge=class o extends O{constructor(e){super(e),this._workflowStack=new ne(se),this._sketchStack=new ne(se),this.data=void 0,this.type="update"}destroy(){this._drainWorkflowStack(e=>e.cancel({force:!0}))}get activeEditorItem(){return this.activeWorkflow?.data.editorItem??void 0}get activeFeatureFormViewModel(){return this.activeWorkflow?.featureFormViewModel}get activeUtilityNetworkAssociationAddAssociationViewModel(){return this.activeWorkflow?.type==="add-association"?this.activeWorkflow.utilityNetworkAssociationAddAssociationViewModel:null}get activeSketchViewModel(){return this._sketchStack.peek()?.viewModel}get canDeleteAssociation(){let{activeFeatureFormViewModel:e}=this;if(!this.activeWorkflow||!this.data.viewModel.view?.map||!e)return!1;let{activeAssociation:t,feature:a}=e;return!(!t||!a?.sourceLayer||!Ie(a?.sourceLayer)&&!S(a?.sourceLayer))}get activeWorkflow(){return this._workflowStack.last()}get updating(){return this._updatingHandles.updating||!!this.activeWorkflow?.updating}get hasPreviousStep(){let e=this.activeWorkflow?.featureFormViewModel;return this._stepIndex>0||this.nestedWorkflowCount>1||e?.relationshipId!=null||this.data.viewModel.attachmentsViewModel.mode!=="view"||e?.associationId!=null||e?.associatedLayer!=null}get hasUpdatableCandidates(){let{candidates:e,viewModel:t}=this.data;return e.some(({layer:a})=>t.findEditorItemForLayer(a)?.supportsUpdateWorkflow)}get nestedWorkflowCount(){return this._workflowStack.length}get shouldShowAttachments(){return!!this.activeEditorItem?.capabilities.attachments.enabled}get shouldAllowAttachmentEditing(){return!!this.activeEditorItem?.capabilities.update.attachments.enabled}get hasPendingEdits(){return Array.from(this._workflowStack).some(e=>e.hasPendingEdits)}get helpMessage(){return this.activeWorkflow?.helpMessage?this.activeWorkflow.helpMessage:this.stepId==="awaiting-feature-to-update"?"select":void 0}get reliesOnOwnerAdminPrivileges(){return this.activeWorkflow?.reliesOnOwnerAdminPrivileges??!1}get hasInvalidFormTemplate(){return!!this.activeEditorItem?.hasInvalidFormTemplate}back(e=()=>Promise.resolve(!0)){return l(this,null,function*(){let{activeWorkflow:t}=this,a=t?.featureFormViewModel;if(a?.activeRelationshipInput){let i=a.activeRelationshipInput;if(i.activeCategory)return void(i.activeCategory=null);if(a.relationshipId!=null)return void(a.relationshipId=null);if(i.showAllEnabled)return void(i.showAllEnabled=!1)}if(t?.type==="add-association"){let{activeUtilityNetworkAssociationAddAssociationViewModel:i}=this;if(i?.filterOptionsVisible)return void(i.filterOptionsVisible=!1)}if(a?.associatedLayer==null)if(a?.associationId==null)if(t?.type==="create-features"&&t.hasPreviousStep)yield t.previous({cancelCurrentStep:!0});else if(t){if(t.hasPendingEdits&&!(yield e()))return;t.hasPreviousStep?yield t.previous({cancelCurrentStep:!0}):yield this.cancelActiveWorkflow({force:!0})}else this.hasPreviousStep?yield this.previous({cancelCurrentStep:!0}):yield this.cancel({force:!0});else a.associationId=null;else a.associatedLayer=null})}cancelActiveWorkflow(e){return l(this,null,function*(){yield this.activeWorkflow?.cancel(e),yield this._popWorkflow()})}commit(){return l(this,null,function*(){yield this._drainWorkflowStack(e=>e.commit()),yield V(o.prototype,this,"commit").call(this)})}static create(e){let{viewModel:t,snappingManager:a,startAt:i,addAttachmentsCallback:r,applyEditsCallback:d,applyEditsFeatureServiceCallback:c}=e,u=e.sketchOptions??new Y,p=new ge({data:new et({addAttachmentsCallback:r,applyEditsCallback:d,applyEditsFeatureServiceCallback:c,sketchOptions:u,snappingManager:a,viewModel:t}),onCommit:()=>l(this,null,function*(){})});return p._set("steps",this._createWorkflowSteps(p,i)),p}save(){return l(this,null,function*(){this.nestedWorkflowCount>1?(yield this.activeWorkflow?.commit(),yield this._popWorkflow()):yield this.commit()})}startCreatingRelatedRecord(e){return l(this,null,function*(){try{let t=yield this._createNestedCreateFeaturesWorkflow(e);yield this._pushWorkflow(t)}catch(t){throw new w("editor:unable-to-start-creating","Could not begin updating the provided feature or table record.",{error:t})}})}startUpdating(e,t){return l(this,null,function*(){try{let a=yield this._createNestedUpdateWorkflow(e,t);yield this._pushWorkflow(a)}catch(a){throw new w("editor:unable-to-start-updating","Could not begin updating the provided feature or table record.",{error:a})}})}startAddAssociation(e,t,a){return l(this,null,function*(){try{let i=yield this._createNestedAddAssociationWorkflow(e,t,a);yield this._pushWorkflow(i)}catch(i){throw new w("editor:unable-to-start-updating","Could not begin updating the provided feature or table record.",{error:i})}})}deleteActiveFeature(){return l(this,null,function*(){let{activeWorkflow:e}=this;if(!e)throw new w("editor:nothing-to-delete","There is no feature to delete");ut(e)?yield e.deleteAndCommit():yield e.cancel(),this.nestedWorkflowCount===1?yield this.reset():(yield this._popWorkflow(),yield this._returnToPageWithContent())})}deleteActiveAssociation(){return l(this,null,function*(){if(!this.canDeleteAssociation)throw new w("editor:nothing-to-delete","There is no association to delete");yield this._deleteActiveAssociation(),yield this._popWorkflow(),yield this._returnToPageWithContent()})}cancelAll(){return l(this,null,function*(){yield this._drainWorkflowStack(e=>e.cancel({force:!0}))})}_deleteActiveAssociation(){return l(this,null,function*(){let{activeFeatureFormViewModel:e,data:t}=this,{activeAssociation:a,feature:i}=e,{applyEditsFeatureServiceCallback:r,viewModel:d}=t,{sourceLayer:c}=i,u=S(c)&&c.parent?c.parent:c,p=te([u]),m=p.values().next().value?.featureService;if(!m)throw new w("editor:failed-to-delete-association","Could not retrieve feature service needed to delete association");yield m?.load();let h=d.view.map,F=We(h,u);yield F?.networkSystemLayers.loadAssociationsTable();let f=F?.generateDeleteAssociations([a]);if(!f)throw new w("editor:failed-to-delete-association","Could not create payload needed to delete association");let k=F?.gdbVersion??void 0;yield r(m,[f],{gdbVersion:k,globalIdUsed:!0})})}_returnToPageWithContent(){return l(this,null,function*(){let{activeFeatureFormViewModel:e}=this;if(!e?.activeAssociationInput)return;let{activeAssociationInput:t,associationId:a}=e;yield t.refresh(),t.associatedLayer&&!t.associatedFeatures?.length&&(e.associatedLayer=null),a==null||t.associatedFeatureInfos.size||(e.associationId=null)})}_createNestedCreateFeaturesWorkflow(e){return l(this,null,function*(){let{relatedLayer:t}=e,{addAttachmentsCallback:a,applyEditsCallback:i,applyEditsFeatureServiceCallback:r,sketchOptions:d,snappingManager:c,viewModel:u}=this.data;if(!ue(t))throw new w("editor:unsupported-layer","Editing is not supported on the provided layer");let p=this._getCreationInfoForNestedCreateFeaturesWorkflow(e),m=p.template||p.initialFeature?"creating-features":"awaiting-feature-creation-info",h=this.activeWorkflow?.type!=="create-features"&&this.activeWorkflow?.type!=="add-association"?this.activeWorkflow:void 0;return Xe.create({addAttachmentsCallback:a,applyEditsCallback:i,applyEditsFeatureServiceCallback:r,creationInfo:p,isNested:!0,parent:h,sketchOptions:d,snappingManager:c,startAt:m,viewModel:u})})}_getCreationInfoForNestedCreateFeaturesWorkflow(e){let{relatedLayer:t}=e;if(!ue(t)||R(t))throw new w("editor:unsupported-layer","Editing is not supported on the provided layer");let{viewModel:a}=this.data,i={layer:t,maxFeatures:1},r=this._makeRelatedRecordAttributes(e),d=a.getTemplatesForLayer(t);return d?.length>0?(i.attributeOverrides=r,d.length===1&&(i.template=d[0])):i.initialFeature=new $({sourceLayer:t,attributes:r}),i}_createNestedUpdateWorkflow(e,t){return l(this,null,function*(){let a=ce(e.sourceLayer)?v:E,{applyEditsCallback:i,applyEditsFeatureServiceCallback:r,sketchOptions:d,snappingManager:c,viewModel:u}=this.data,p=this.activeWorkflow?.type!=="create-features"&&this.activeWorkflow?.type!=="add-association"?this.activeWorkflow:void 0,m=yield a.create({association:t,feature:e,parent:p,sketchOptions:d,snappingManager:c,viewModel:u,applyEdits:i,applyEditsFeatureService:r,featureFormCallbacks:{addRelatedRecord:h=>l(this,null,function*(){return yield this.startCreatingRelatedRecord(h)}),editRelatedRecord:F=>l(this,[F],function*({relatedFeature:h}){return yield this.startUpdating(h)}),selectAssociatedFeature:f=>l(this,[f],function*({feature:h,association:F}){return yield this.startUpdating(h,F)}),addAssociation:h=>l(this,null,function*(){return yield this.startAddAssociation(h.feature,h.utilityNetwork,h.associationType)})}});return yield K(()=>!m.updating),m})}_createNestedAddAssociationWorkflow(e,t,a){return l(this,null,function*(){let i=A,{applyEditsCallback:r,applyEditsFeatureServiceCallback:d,viewModel:c}=this.data,u=this.activeWorkflow?.type!=="create-features"&&this.activeWorkflow?.type!=="add-association"?this.activeWorkflow:void 0,p=this.activeFeatureFormViewModel?.activeAssociationInput,m=yield i.create({utilityNetwork:t,associationType:a,feature:e,parent:u,viewModel:c,associationInput:p,applyEdits:r,applyEditsFeatureService:d});return yield K(()=>!m.updating),m})}_drainWorkflowStack(e){return l(this,null,function*(){let t=this._workflowStack,a=[];for(;t.length>0;){let i=t.pop();this._sketchStack.pop();let r=e(i).then(()=>i.destroy());this._updatingHandles.addPromise(r),a.push(r)}yield Promise.all(a)})}_makeRelatedRecordAttributes(e){let{parentFeature:t,relatedLayer:a,relationshipId:i}=e;if(!Ve(t))return;let r=a.relationships?.find(h=>h.id===i);if(!r)return void G("relationship-not-found","Could not begin creating a related record because the relationship specified could not be found on the destination layer.");if(r.role==="origin")return void G("unsupported-role","Creating new related records in the 'origin' table of a relationship is not yet supported");let d=t.sourceLayer;r.relatedTableId!==d.layerId&&G("invalid-argument-combination","The given parent feature does not belong to the relationship designated by the given relationship ID.");let c=d.relationships?.find(h=>h.id===i);if(!c)return void G("relationship-not-found","Could not begin creating a related record because the relationship specified could not be found on the origin layer.");let u=nt(d,c),p=t.getAttribute(u);return p||G("no-key-on-origin-feature","The given parent feature does not have a value for the relationship's origin primary key field."),{[nt(a,r)]:p}}_popWorkflow(){return l(this,null,function*(){this._workflowStack.pop()?.destroy(),this._sketchStack.pop();let e=yield this._reconcileWorkflowStack();if(e.failureCount>0)throw new w("editor:next-workflow-failed","Popped the top workflow, but the next workflow in the stack failed to activate",e)})}_pushWorkflow(e){return l(this,null,function*(){let t=this._workflowRequiresSketchViewModel(e);this.activeWorkflow?.exit({removeSketchHandles:t});let a=this._sketchStack,i=yield e?.start(),r=a.peek();i?(r?.exit(),a.push(i)):a.push(this._cloneSketchController(r)),this._workflowStack.push(e);let d=yield this._reconcileWorkflowStack();if(d.failureCount>0)throw new w("editor:failed-to-start-updating-feature","Failed to enter the provided workflow.",d)})}_reconcileWorkflowStack(){return l(this,null,function*(){let e=this._workflowStack,t=this._sketchStack;try{let a=e.peek();return yield a?.enter(),yield t.peek()?.enter(),{activeWorkflow:a,failureCount:0}}catch{e.pop().destroy(),t.pop();let{activeWorkflow:i,failureCount:r}=yield this._reconcileWorkflowStack();return{activeWorkflow:i,failureCount:r+1}}})}_cloneSketchController(e){return{enter:e?.enter??(()=>l(this,null,function*(){})),exit:e?.exit??(()=>l(this,null,function*(){})),viewModel:e?.viewModel}}_workflowRequiresSketchViewModel(e){let{type:t}=e;return t==="update-feature"||t==="create-features"&&!ce(e.data.creationInfo?.layer)}static _createWorkflowSteps(e,t="awaiting-feature-to-update"){let{data:a}=e;return Be(["awaiting-feature-to-update","awaiting-update-feature-candidate","editing-existing-feature","adding-attachment","editing-attachment"],t,{"awaiting-feature-to-update":()=>({id:"awaiting-feature-to-update",setUp(){return l(this,null,function*(){let{spinnerViewModel:r}=a.viewModel,d=a.viewModel.view;d.activeTool=null;let c=null;e.addHandles(I(()=>{c=W(c)}),this.id),a.rootFeature=null,a.candidates=[];let u=d.on("immediate-click",m=>l(this,null,function*(){let h=Fe();e._updatingHandles.addPromise(h.promise);try{r.location=m.mapPoint,r.visible=!0,c?.abort();let{editorItems:F}=a.viewModel;c=new AbortController;let f=yield m.async(()=>new Promise((k,dt)=>{Ae(c?.signal,()=>dt(_e())),k(Qe(F,d,m,c?.signal))}));if(be(c),a.candidates=f.filter(k=>k.status==="fulfilled").flatMap(k=>k.value).filter(k=>!k.isAggregate),r.visible=a.candidates.length===1,a.candidates.length===0)return;m.stopPropagation(),a.candidates.length===1?(a.rootFeature=a.candidates[0],e.go("editing-existing-feature").catch(()=>{}).then(()=>r.visible=!1)):e.next()}finally{h.resolve()}}),Ne.TOOL),p=Ce(()=>d.activeTool!=null,()=>e.cancel({force:!0}),{once:!0});d.focus(),e.addHandles([u,p],this.id)})},tearDown(){return l(this,null,function*(){a.candidates.length===0&&(a.viewModel.spinnerViewModel.visible=!1),e.removeHandles(this.id)})}}),"awaiting-update-feature-candidate":()=>({id:"awaiting-update-feature-candidate",setUp(){return l(this,null,function*(){a.rootFeature=null;let{view:r}=a.viewModel;if(!r)return;let d=new N({view:r,highlightName:U});e.addHandles([_(()=>a.rootFeature,(c,u)=>{d.remove(u),d.add(c)},le),I(()=>d.removeAll())],this.id)})},tearDown(){return l(this,null,function*(){e.removeHandles(this.id)})}}),"editing-existing-feature":()=>({id:"editing-existing-feature",setUp(){return l(this,null,function*(){let{rootFeature:r,viewModel:d}=e.data;if(!r)throw new w("editor:no-feature-specified","Cannot setup the 'updating-existing-feature' step until the root feature is defined");yield e.startUpdating(r),d.spinnerViewModel.visible=!1;let c=H(()=>l(this,null,function*(){yield K(()=>!e.updating),e.previous()}));e.addHandles([_(()=>e.nestedWorkflowCount,(u,p)=>{u===0&&p!==0&&c()},le)],this.id)})},tearDown(){return l(this,null,function*(){yield e.cancelAll(),e.removeHandles(this.id)})}}),"adding-attachment":()=>({id:"adding-attachment",parent:"editing-existing-feature",setUp(){return l(this,null,function*(){})},tearDown(){return l(this,null,function*(){a.viewModel.attachmentsViewModel.mode="view"})}}),"editing-attachment":()=>({id:"editing-attachment",parent:"editing-existing-feature",setUp(){return l(this,null,function*(){})},tearDown(){return l(this,null,function*(){a.viewModel.attachmentsViewModel.mode="view"})}})})}};function nt(o,{keyField:e}){return o.getField(e)?.name??e}s([n()],g.prototype,"activeEditorItem",null),s([n()],g.prototype,"activeFeatureFormViewModel",null),s([n()],g.prototype,"activeUtilityNetworkAssociationAddAssociationViewModel",null),s([n()],g.prototype,"activeSketchViewModel",null),s([n()],g.prototype,"canDeleteAssociation",null),s([n()],g.prototype,"activeWorkflow",null),s([n()],g.prototype,"updating",null),s([n()],g.prototype,"data",void 0),s([n()],g.prototype,"hasPreviousStep",null),s([n()],g.prototype,"hasUpdatableCandidates",null),s([n()],g.prototype,"nestedWorkflowCount",null),s([n()],g.prototype,"shouldShowAttachments",null),s([n()],g.prototype,"shouldAllowAttachmentEditing",null),s([n()],g.prototype,"hasPendingEdits",null),s([n()],g.prototype,"helpMessage",null),s([n()],g.prototype,"reliesOnOwnerAdminPrivileges",null),s([n()],g.prototype,"hasInvalidFormTemplate",null),g=ge=s([b(lt)],g);var G=(o,e)=>ct().warn(`editor:${o}`,e,"The create operation will be allowed to proceed, but the resulting feature may not be related to the given parent feature."),ut=o=>!!o&&/update-/.test(o.type),ao=g;export{ot as a,ao as b};
