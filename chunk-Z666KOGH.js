import{b as ut}from"./chunk-D2FDGJMW.js";import"./chunk-WT37QSNF.js";import"./chunk-WYXAYMB7.js";import"./chunk-LXYWEX2U.js";import"./chunk-IBSCSNYA.js";import"./chunk-T3LMCJNQ.js";import"./chunk-BWSUZDSV.js";import{d as gt}from"./chunk-5MJEFA5N.js";import"./chunk-5H7NDIGP.js";import"./chunk-KJFE7WVE.js";import"./chunk-ZYYN4NWF.js";import{f as ht}from"./chunk-MRKUOXYW.js";import"./chunk-CL7L227X.js";import"./chunk-2GLWK7ZW.js";import{i as pt}from"./chunk-QXSQOLB3.js";import"./chunk-BKWQOCBC.js";import"./chunk-XACQ2RJ5.js";import"./chunk-LCFWGHLF.js";import"./chunk-CX3G2QWN.js";import"./chunk-YTAJKLRN.js";import"./chunk-D6N4VI5S.js";import"./chunk-5YS73I3T.js";import"./chunk-3ZJ4NMBE.js";import{b as lt}from"./chunk-HH3C3QEN.js";import"./chunk-4S7THJAS.js";import{a as mt,b as ft}from"./chunk-2XTO2IAR.js";import"./chunk-CQVHC5U2.js";import"./chunk-P7MVFIZJ.js";import"./chunk-FSW536RM.js";import"./chunk-VN5FPMRB.js";import"./chunk-N7DSOI7B.js";import"./chunk-F4HA2HQL.js";import"./chunk-DQZHSTUF.js";import"./chunk-CY62WWD7.js";import"./chunk-VDNRZCIE.js";import"./chunk-I2JD5OSI.js";import"./chunk-2MROBW6T.js";import"./chunk-QAHTJVUZ.js";import"./chunk-X4VZU4O3.js";import"./chunk-XE4T4457.js";import"./chunk-BWHHYBB5.js";import"./chunk-XWEUR6F7.js";import"./chunk-PSNQ2KG3.js";import"./chunk-MPI26GZ3.js";import"./chunk-2ZB26SH7.js";import"./chunk-ZVSQXQ5X.js";import"./chunk-2IWALBQY.js";import"./chunk-3HEFIJB6.js";import"./chunk-K6RQLPKJ.js";import"./chunk-7V6BRQYE.js";import"./chunk-PORMJXR6.js";import"./chunk-Y7XG5IWW.js";import"./chunk-LSV6EK6V.js";import"./chunk-X5NPIY3C.js";import"./chunk-5252J253.js";import"./chunk-7WCQBAQY.js";import"./chunk-VQSLKKYN.js";import"./chunk-JBAMJB5J.js";import"./chunk-VAOSSSLB.js";import"./chunk-AMISFAT3.js";import"./chunk-CUV3BSEW.js";import"./chunk-3ZJU5D2H.js";import"./chunk-2UHZH5L3.js";import"./chunk-DQINVX66.js";import"./chunk-CSFAHB4Y.js";import"./chunk-T5UBLAP4.js";import"./chunk-PTXLSCMJ.js";import"./chunk-DA3NC6W4.js";import"./chunk-6L543SC5.js";import"./chunk-FRN24G7D.js";import"./chunk-FGABE2LC.js";import"./chunk-CU7FHMWW.js";import"./chunk-CZMBPC27.js";import"./chunk-VANM5A4M.js";import"./chunk-VSD74FMI.js";import"./chunk-KALTBP5D.js";import"./chunk-O2J7LFYY.js";import"./chunk-BIU7ZFAB.js";import"./chunk-6FZTFPIH.js";import"./chunk-J5AEP4US.js";import"./chunk-YHRLMRSO.js";import"./chunk-KPT44MCK.js";import"./chunk-XKFJ6GWH.js";import"./chunk-SFANISLX.js";import"./chunk-UJ7KVQR6.js";import"./chunk-GSXOR3JU.js";import"./chunk-55OTJIMU.js";import"./chunk-EM2AEAFS.js";import"./chunk-YEPHAEAY.js";import"./chunk-TK4PPGQL.js";import"./chunk-ELCBU4NP.js";import"./chunk-GMZFCQJQ.js";import"./chunk-5WDH2LXO.js";import"./chunk-L7NOU4T2.js";import"./chunk-VGAXEXH3.js";import"./chunk-HMNTGQTR.js";import"./chunk-ZLIWNUFM.js";import"./chunk-GVSOJUIP.js";import"./chunk-GWSX6PRO.js";import"./chunk-G2JMPZCN.js";import"./chunk-IRQF7UTO.js";import"./chunk-3KOZOOEP.js";import"./chunk-OL54OOJH.js";import"./chunk-EG2DTURK.js";import"./chunk-NQ3CCFQA.js";import"./chunk-YVCKQBWT.js";import"./chunk-WOZSH7YY.js";import"./chunk-2PJRHNJW.js";import"./chunk-B2RVSTL3.js";import"./chunk-4XEE5PE3.js";import"./chunk-2CKJLDTO.js";import"./chunk-F6TN7E7K.js";import"./chunk-4LDVFWME.js";import"./chunk-HUUJBVXR.js";import"./chunk-7G56KLCZ.js";import"./chunk-L56OBJFS.js";import"./chunk-7HMNN4FJ.js";import"./chunk-UKAGN54W.js";import{a as ct}from"./chunk-342NGUMP.js";import"./chunk-NIYDRLW4.js";import"./chunk-PHMJ7KPL.js";import"./chunk-ESSDCWGF.js";import"./chunk-WVKBXQWE.js";import"./chunk-42SGGFLN.js";import"./chunk-EDOVNTC7.js";import"./chunk-FSWSNKJD.js";import"./chunk-FGEB67EG.js";import"./chunk-YEXMIDOT.js";import"./chunk-T7PUQGWM.js";import"./chunk-GV3ZFCVD.js";import"./chunk-SOEEM7Z7.js";import"./chunk-MVDZB4AK.js";import"./chunk-44A27HB7.js";import"./chunk-47NSYSFY.js";import"./chunk-QXNVQZT7.js";import"./chunk-QSQIQSC6.js";import"./chunk-AYNBEMCC.js";import"./chunk-LNYBTIG7.js";import"./chunk-VYZHOYXV.js";import"./chunk-ECA5I2I7.js";import"./chunk-XAHD7XBV.js";import"./chunk-Y7XRSFOZ.js";import{b as R}from"./chunk-YQNUGDFH.js";import{a as dt}from"./chunk-QCZ3ZIGQ.js";import"./chunk-7SDNM7YV.js";import"./chunk-4NUW747S.js";import"./chunk-T6WMVIUG.js";import"./chunk-ONYJLWAD.js";import"./chunk-PHODKV66.js";import"./chunk-JPMGMA4B.js";import"./chunk-LAX5536Z.js";import"./chunk-N3HRYLNW.js";import"./chunk-4DBMALZW.js";import"./chunk-CVWWHM2V.js";import"./chunk-6OQYVEQJ.js";import"./chunk-YOXOWGT6.js";import"./chunk-EFZOSMYP.js";import"./chunk-WI7F4ZKJ.js";import"./chunk-MJ7M24NH.js";import"./chunk-GJH4QFRX.js";import"./chunk-T63F7663.js";import"./chunk-O4V2VBSK.js";import"./chunk-5TKRKB5E.js";import"./chunk-XAGMDNNR.js";import"./chunk-OP2TLIUN.js";import"./chunk-T2THIR6K.js";import"./chunk-LORHDXEB.js";import"./chunk-BBBPJI4H.js";import"./chunk-45BTW5EG.js";import"./chunk-TPFBHGDM.js";import"./chunk-73NLRHJD.js";import"./chunk-PNFEUBDF.js";import"./chunk-6RCCEJDL.js";import"./chunk-PQ2TNDUX.js";import"./chunk-6X6MKRQ3.js";import"./chunk-FQFHMHYU.js";import"./chunk-SZMEI3WL.js";import"./chunk-KKVGD67U.js";import{a as ot,b as at}from"./chunk-MYOJWRDU.js";import"./chunk-L7UKJKHG.js";import"./chunk-V2IENAEU.js";import"./chunk-QAGQFNF2.js";import"./chunk-SY7JS2VW.js";import"./chunk-WK57SDN6.js";import"./chunk-AG4V3ZUO.js";import"./chunk-YWLMJ26A.js";import"./chunk-QAWNU3UJ.js";import"./chunk-HRQT4R6X.js";import"./chunk-44BHLWQ4.js";import"./chunk-5BPM64SU.js";import"./chunk-PMVHHMQJ.js";import"./chunk-NAFOM5UA.js";import"./chunk-DO7UF2F2.js";import"./chunk-ZTR6OS44.js";import"./chunk-VRTKAD2J.js";import"./chunk-DBLKLHK2.js";import"./chunk-UTE3ASAZ.js";import"./chunk-2AFEAPEX.js";import"./chunk-GNGXUEWV.js";import"./chunk-QBI5NDCA.js";import"./chunk-NOHW2DKR.js";import"./chunk-HVJAAM3A.js";import"./chunk-ACPEJEHK.js";import"./chunk-I7B3LWNP.js";import"./chunk-YP2E5N4E.js";import"./chunk-QLMNLSCT.js";import"./chunk-P55G5ATK.js";import"./chunk-JT3K52KQ.js";import"./chunk-SPLEGG4R.js";import"./chunk-Y4TJDUGP.js";import"./chunk-6PAFOJ4W.js";import"./chunk-74SDGE57.js";import"./chunk-FRXWHX3T.js";import"./chunk-DTDQ5X42.js";import"./chunk-RX2HFR4X.js";import"./chunk-AZW7YPTQ.js";import"./chunk-NJLJX4X6.js";import"./chunk-DZHFTD24.js";import"./chunk-K57Z4J34.js";import"./chunk-VWG3KVOU.js";import"./chunk-JOEUVLAN.js";import"./chunk-JZQDGIDQ.js";import"./chunk-CZ6CGC7I.js";import"./chunk-7B6U3N62.js";import"./chunk-46WDO5LS.js";import"./chunk-G5EYK5KM.js";import"./chunk-YJKJQU3F.js";import"./chunk-OK4K3OQT.js";import"./chunk-BPWNCOXC.js";import"./chunk-VNS4CQ27.js";import"./chunk-AVMO6LCR.js";import"./chunk-TEGPMVWT.js";import"./chunk-CLQRQC3Y.js";import"./chunk-KSNU73LO.js";import"./chunk-FACEVGRE.js";import"./chunk-5XTCPT52.js";import{c as it}from"./chunk-72MRWGPJ.js";import"./chunk-2GF6YDKP.js";import"./chunk-DDZ3KR2Q.js";import"./chunk-R3XLNYYB.js";import{b as ye}from"./chunk-2HYVVLKS.js";import"./chunk-XRTA5GHC.js";import"./chunk-Y6XW36QP.js";import"./chunk-ZXKU6WBY.js";import{b as nt,c as st}from"./chunk-RBVFFAW6.js";import{a as rt}from"./chunk-XQOE7Z4Q.js";import"./chunk-BMYVPMAK.js";import"./chunk-6F25LG6O.js";import{c as Ye}from"./chunk-S7U4DSGB.js";import"./chunk-G27DRLGO.js";import"./chunk-ZGHRJMZW.js";import"./chunk-XLL67PCY.js";import"./chunk-MCO7DSFO.js";import"./chunk-IIROCMOY.js";import"./chunk-K3Z3MI77.js";import"./chunk-EDZQZA57.js";import"./chunk-V6AA2XHK.js";import"./chunk-25WBXAEY.js";import"./chunk-7QY3BMVN.js";import{a as Ve}from"./chunk-Y7GY5YIF.js";import{a as G}from"./chunk-LMGYHZE3.js";import{b as q,e as ze,g as A,h as He}from"./chunk-5LG2P6MT.js";import{d as Qe,e as ke,u as We}from"./chunk-GJ2QRXGN.js";import"./chunk-6QXEFK4U.js";import{a as Ke,d as et}from"./chunk-5L2EJ5RT.js";import"./chunk-S52JRLJC.js";import"./chunk-E2QKN2KY.js";import"./chunk-PDQQY7RQ.js";import"./chunk-W5OI4BJ2.js";import{a as _}from"./chunk-RWCIDBNQ.js";import"./chunk-2NH7HOKA.js";import"./chunk-EM35R6FY.js";import"./chunk-HM5RIVQC.js";import"./chunk-HKJZ7WI6.js";import"./chunk-CXOFHVIF.js";import{b as tt}from"./chunk-EO2H4LIH.js";import"./chunk-DJW5LMRG.js";import"./chunk-DMO5HQM3.js";import"./chunk-DEH76MSI.js";import{a as S}from"./chunk-ALWV3RJ2.js";import{a as Ze,b as $}from"./chunk-CKJDDSAD.js";import"./chunk-DQOFEB5P.js";import"./chunk-2ZFXOJDB.js";import"./chunk-QXXXCEV5.js";import"./chunk-6B5XFA6F.js";import"./chunk-PUVSV35R.js";import"./chunk-FCWOKKZM.js";import"./chunk-TJ6P6NLD.js";import"./chunk-NX5B6XBR.js";import"./chunk-2JABY6DU.js";import"./chunk-MPRKSQLC.js";import"./chunk-57TARQ4F.js";import"./chunk-6RBQSBA2.js";import"./chunk-Z42K5ECK.js";import"./chunk-NVTU6MJO.js";import"./chunk-56M6LBCJ.js";import"./chunk-HZK6UIET.js";import"./chunk-T2RV3ABV.js";import"./chunk-CSNRCIB5.js";import"./chunk-6FW4T2SJ.js";import"./chunk-4ZVBFHBA.js";import"./chunk-3JGYBNJA.js";import{g as Je,s as Xe}from"./chunk-DA3SDKGO.js";import"./chunk-ZOEPYNM4.js";import{k as $e}from"./chunk-57VFBGF3.js";import"./chunk-GWBRHLNH.js";import"./chunk-BJH4F4SM.js";import"./chunk-Z3RBZHAK.js";import"./chunk-IO35PPBL.js";import"./chunk-F5AJITOA.js";import"./chunk-IHATPE6U.js";import"./chunk-PU4AK46X.js";import"./chunk-3CLJ5OX5.js";import"./chunk-E6C7G5SC.js";import"./chunk-73K3NWCV.js";import{b as qe}from"./chunk-SP2CO3KX.js";import"./chunk-PTZYZULI.js";import"./chunk-NMLYCCKN.js";import"./chunk-FYZRIMPP.js";import"./chunk-ZC6EBRE4.js";import{a as Ue}from"./chunk-ZAZJB7CV.js";import"./chunk-KALOJIUA.js";import"./chunk-KMMTNF7G.js";import"./chunk-E7AX56GD.js";import"./chunk-IDVLLREH.js";import"./chunk-DWLSVYOY.js";import"./chunk-PQGCNP5H.js";import"./chunk-UASS7NJI.js";import"./chunk-WZRAC35O.js";import"./chunk-KUYAWYSS.js";import"./chunk-MIS6QMFE.js";import"./chunk-MDZTV2VL.js";import"./chunk-RNC4P66O.js";import"./chunk-7LHOQXZT.js";import"./chunk-BCREO4Q5.js";import"./chunk-U4QEPZJ3.js";import"./chunk-KJUZWSCL.js";import"./chunk-3WO6D7MU.js";import"./chunk-BUZ3SPLE.js";import"./chunk-K75TK42V.js";import"./chunk-CELWVZPW.js";import"./chunk-VV5G7VY5.js";import"./chunk-OLOKUDVI.js";import"./chunk-DYTVXYAV.js";import{a as je,c as Ge,d as Le,f as De,i as Ne}from"./chunk-ZTOZWLEE.js";import"./chunk-RJWOVI3M.js";import"./chunk-RSDQHAJX.js";import{a as M,e as _e}from"./chunk-BOVYXYHK.js";import{e as Fe,f as Be,o as Ee,v as Pe}from"./chunk-KVM6SHDX.js";import"./chunk-WATIOYLF.js";import"./chunk-POX73EYJ.js";import"./chunk-NKUXRYJG.js";import"./chunk-33RXTDEX.js";import"./chunk-P33JWG3G.js";import"./chunk-HX2VGIR2.js";import"./chunk-ERDKAICI.js";import"./chunk-EQZWYK27.js";import"./chunk-JLPLCY2B.js";import"./chunk-DKGGDYJI.js";import"./chunk-5LA3PVK5.js";import"./chunk-IR6XCBC4.js";import"./chunk-C6JPAW54.js";import"./chunk-WD3OPXCN.js";import"./chunk-FA3WGIU4.js";import"./chunk-WWVPA6PE.js";import{m as Oe}from"./chunk-ZQIC5NFT.js";import"./chunk-VIEK2X23.js";import"./chunk-XKIFGPJO.js";import"./chunk-PEW2PLAN.js";import"./chunk-Q6Y4JG7Q.js";import{a as ge}from"./chunk-7F5DJLJT.js";import"./chunk-CX5IFQZJ.js";import"./chunk-NJWTSROP.js";import"./chunk-D3R25AF2.js";import"./chunk-ARRCN5K3.js";import{a as pe}from"./chunk-GHKL3NOH.js";import{a as Re}from"./chunk-WGAOVKGR.js";import"./chunk-4N4D2YQX.js";import"./chunk-G4DZJMGT.js";import"./chunk-UST6HCE7.js";import"./chunk-K5T5FD5C.js";import"./chunk-MVHHPJM7.js";import"./chunk-VDO6JJ3Y.js";import"./chunk-WFKZLI6F.js";import"./chunk-X2B63YVS.js";import"./chunk-BAEF3CT6.js";import"./chunk-AUAZP44J.js";import"./chunk-PVDFCTA4.js";import"./chunk-KNVXE32P.js";import"./chunk-76ATOSLU.js";import"./chunk-CCJU4DSH.js";import{a as Te,j as Me}from"./chunk-TG45K3WR.js";import"./chunk-RAI4DTMT.js";import"./chunk-ACP3S2CH.js";import"./chunk-HVAXZ2NA.js";import{a as U}from"./chunk-T7DXJKX7.js";import"./chunk-TYYVNQUR.js";import{a as y}from"./chunk-QGVBCWUY.js";import{H as Se}from"./chunk-MYO4NP2N.js";import{e as b}from"./chunk-NFIPKH6V.js";import"./chunk-JPU2PQZC.js";import{l as V}from"./chunk-5QEXLALV.js";import"./chunk-P6QFA5MM.js";import"./chunk-DGTD7Y73.js";import"./chunk-LI2SX4T6.js";import"./chunk-BWO7LS2H.js";import"./chunk-HEVQSRJ2.js";import"./chunk-OVHPPCBL.js";import"./chunk-SNFOAZZQ.js";import"./chunk-AML4XSEF.js";import{o as fe,p as j,y as Ae}from"./chunk-4PTIEWMT.js";import"./chunk-TG2UTNEO.js";import{b as ve}from"./chunk-YOFFGXOB.js";import"./chunk-XRGPJ3QY.js";import"./chunk-6MRUJ2UW.js";import"./chunk-2LI2GKBQ.js";import{a as he,y as Ce}from"./chunk-QBWJMFH5.js";import{a as z,b as H,f as m}from"./chunk-VTHXE323.js";var x=class extends Se{constructor(s){super(s),this._updatingCount=0,this._tileHandles=new pe,this._wanted=new pe}destroy(){for(let s of this._tileHandles.values())s.abort();this._tileHandles.clear(),this._wanted.clear()}get updating(){return this._updatingCount>0}get _boundingRect(){let{extent:s}=this;return s==null?null:Fe(s)}get _missingTiles(){let s=new Array,e=this._wanted;for(let t of this._tileHandles.values())e.has(t.id)&&!L(t)&&s.push(t);return s}onTileTreeChange(s){return m(this,null,function*(){++this._updatingCount;try{let{added:e,removed:t}=s,r=this._tileHandles,{_boundingRect:n}=this,i=n!=null?e.filter(d=>Pe(n,d.extent)):e,o=this._wanted,a=new Array;for(let d of t){let{id:c}=d;if(o.delete(c),e.some(l=>T(l,d)||T(d,l)))continue;let u=r.get(c);u!=null&&a.push(this._removeTile(u))}for(let d of i)o.set(d.id,d),a.push(this._addTile(d));yield Promise.allSettled(a)}finally{--this._updatingCount}})}_removeTile(s){return m(this,null,function*(){this._tileHandles.delete(s.id),s.abort(),this._validate();let{tile:e}=s,t=new O(s.untilSettled(),e!=null?this.createRemoveTileCommand(e):null);s.nextEvent=null;let{command:r}=yield t.getCommand();r?.execute()})}_addTile(s){return m(this,null,function*(){let{_tileHandles:e}=this,t=e.get(s.id);if(t!=null)return!L(t)||t.tile.isComplete||(t.tile=t.tile.reset(),t.nextEvent=this._onTileLoad(t)),void(yield t.untilSettled());let r=new xe(s);this._tileHandles.set(r.id,r);let n=this.loadTile(s,r.signal);r.nextEvent=n;let i=yield n;if(r.aborted)throw fe();r.tile=i,St(r),r.nextEvent=this._onTileLoad(r),yield r.untilSettled()})}_onTileLoad(s){return m(this,null,function*(){let{_wanted:e,_tileHandles:t,_missingTiles:r}=this,n=s.descriptor,i=new Array,o=new Array,a=new Set;for(let c of t.values()){if(c===s)continue;let{descriptor:u,id:l}=c;if(e.has(l)||r.some(({descriptor:f})=>T(f,u)||T(u,f))){if(L(c)){if(T(n,u)){let f=c.tile;for(let p of f.objectIds())a.add(p)}if(T(u,n)){let f=s.tile,p=new Set(f.objectIds()),h=c.tile,g=h.exclude(p);c.tile=g;let w=AbortSignal.any([c.signal,s.signal]),I=c.untilSettled();i.push(new O(I,this.createRemoveTileCommand(h))),i.push(new O(I,this.createAddTileCommand(g,w),w)),o.push(c),this._validateRemoval(g,p)}}}else{c.abort(),t.delete(l);let{tile:f}=c;f!=null&&i.push(new O(c.untilSettled(),this.createRemoveTileCommand(f))),c.nextEvent=null}}a.size>0&&(s.tile=s.tile.exclude(a),this._validateRemoval(s.tile,a)),i.push(new O(s.untilSettled(),this.createAddTileCommand(s.tile,s.signal),s.signal)),o.push(s),this._validate();let d=this._joinCommands(i);for(let c of o)c.nextEvent=d;yield d})}_joinCommands(s){return m(this,null,function*(){let e=(yield Promise.allSettled(s.map(t=>m(this,null,function*(){return t.getCommand()})))).map(t=>t.status!=="fulfilled"||t.value.signal?.aborted?null:t.value.command).filter(Ce);e.length!==0&&e.reduce((t,r)=>(t.append(r),t)).execute()})}_validate(){if(!he("feature-pipeline-3d-test-validation"))return;let s=new Array;for(let e of this._tileHandles.values()){if(!L(e))continue;let{tile:t}=e,r=t.featureCount,n=new Uint32Array(r);t.readObjectIds(n),s.push({tile:t,objectIds:new Set(n)})}for(let e=0;e<s.length;++e){let{tile:t,objectIds:r}=s[e];for(let n=e+1;n<s.length;++n){let{tile:i,objectIds:o}=s[n];for(let a of o)if(r.has(a)){let d=T(i.descriptor,t.descriptor),c=T(t.descriptor,i.descriptor);throw new Error(`${t.descriptor.id} and ${i.descriptor.id} both contain ${a}. aInB: ${d}; bInA: ${c}`)}}}}_validateRemoval(s,e){if(he("feature-pipeline-3d-test-validation")){for(let t of s.objectIds())if(e.has(t))throw new Error(`Failed to remove ${t} from ${s.descriptor.id}!`)}}};function T({lij:[s,e,t]},{lij:[r,n,i]}){let o=r-s;return o>=0&&e===n>>o&&t===i>>o}y([b()],x.prototype,"updating",null),y([b({constructOnly:!0})],x.prototype,"loadTile",void 0),y([b({constructOnly:!0})],x.prototype,"createAddTileCommand",void 0),y([b({constructOnly:!0})],x.prototype,"createRemoveTileCommand",void 0),y([b()],x.prototype,"_updatingCount",void 0),y([b()],x.prototype,"extent",void 0),y([b()],x.prototype,"_boundingRect",null),y([b()],x.prototype,"_missingTiles",null),x=y([V("esri.views.3d.layers.graphics.pipeline.Tile3DManager")],x);var xe=class{constructor(e){this.descriptor=e,this._controller=new AbortController,this._tile=Re(null),this.nextEvent=null}get id(){return this.descriptor.id}get tile(){return this._tile.value}set tile(e){this._tile.value=e}get signal(){return this._controller.signal}abort(){this._controller.abort()}get aborted(){return this._controller.signal.aborted}untilSettled(){return m(this,null,function*(){try{yield this.nextEvent}catch(e){Ae(e)||console.error(e)}})}};function L(s){return s.tile!=null}function St(s){if(!L(s))throw new Error}var O=class{constructor(e,t,r){this.previousEventSettled=e,this.commandPromise=t,this.signal=r}getCommand(){return m(this,null,function*(){let{previousEventSettled:e,commandPromise:t,signal:r}=this,[n]=yield Promise.all([t,e]);if(r?.aborted)throw fe();return{command:n,signal:r}})}};var J=class s{constructor(e,t){this.tile=e,this._tileIndices=t}get id(){return this.tile.id}get featureCount(){return this._tileIndices?.length??this.tile.featureCount}get usedMemory(){return A+(this._tileIndices?.byteLength??0)}get extent(){return this.tile.descriptor.extent}readObjectIds(e,t){let{_tileIndices:r,tile:n}=this;return n.readObjectIds(e,r,t)}readCoordinates(e,t){let{_tileIndices:r,tile:n}=this;return n.readCoordinates(e,r,t)}subset(e){let{_tileIndices:t,tile:r}=this;if(t==null)return new s(r,e);let n=new Uint32Array(e.length);for(let i=0;i<n.length;++i)n[i]=t[e[i]];return new s(r,n)}};var X=class{constructor(){this._tileToFeatureData=new Map}add(e){this._tileToFeatureData.set(e.tile,e)}remove(e){this._tileToFeatureData.delete(e)}get(e){return this._tileToFeatureData.get(e)}};var N=class{constructor(e,t){this._index=e,this._view=t}get usedMemory(){return A+q}getObjectId(){return this._view.getObjectId(this._index)}getAttribute(e){return this._view.getAttribute(this._index,e)}getAttributeAsTimestamp(e){return this._view.getAttributeAsTimestamp(this._index,e)}getAttributes(){return this._view.getAttributes(this._index)}getOptimizedGeometry(){return this._view.getOptimizedGeometry(this._index)}getCentroid(e){return this._view.getCentroid(this._index,e)}getBounds(){return this._view.getBounds(this._index)}getBoundingBox(){return this._view.getBoundingBox(this._index)}cloneWithGeometry(e){return new be(this._index,this._view,e)}},be=class extends N{constructor(e,t,r){super(e,t),this._geometryOverride=r}getOptimizedGeometry(){return this._geometryOverride}getCentroid(e){return Ve(new G,this._geometryOverride,e.hasZ,e.hasM)}},Y=class{constructor(){this._tileBounds=new Map,this.events=new U,this.featureAdapter=Q.shared}get usedMemory(){return A+A*this._tileBounds.size}addTile(e){let{featureCount:t}=e;if(t===0)return;let r=new Ze(9,i=>e.getBounds(i)),n=new Array;for(let i=0;i<t;++i)n[i]=i;r.load(n),this._tileBounds.set(e,r),this.events.emit("changed")}removeTile(e){this._tileBounds.delete(e),this.events.emit("changed")}clear(){this._tileBounds.clear(),this.events.emit("changed")}forEach(e){for(let[t,r]of this._tileBounds)r.all(n=>e(new N(n,t)))}forEachInBounds(e,t){D.minX=e[0],D.minY=e[1],D.maxX=e[2],D.maxY=e[3];for(let[r,n]of this._tileBounds)n.search(D,i=>t(new N(i,r)))}forEachBounds(e,t){for(let r of e)t(r.getBoundingBox())}getFullExtent(e){let t=1/0,r=1/0,n=-1/0,i=-1/0;for(let o of this._tileBounds.values()){let{minX:a,minY:d,maxX:c,maxY:u}=o.toJSON();t=Math.min(t,a),r=Math.min(r,d),n=Math.min(n,c),i=Math.min(i,u)}return{xmin:t,ymin:r,xmax:n,ymax:i,spatialReference:e}}},Q=class{getObjectId(e){return e.getObjectId()}getAttribute(e,t){return e.getAttribute(t)}getAttributeAsTimestamp(e,t){return e.getAttributeAsTimestamp(t)}getAttributes(e){return e.getAttributes()}getGeometry(e){return e.getOptimizedGeometry()}getCentroid(e,t){return e.getCentroid(t)}cloneWithGeometry(e,t){return e.cloneWithGeometry(t)}};Q.shared=new Q;var D=new $;var Z=class s{constructor(e,t,r=Rt(t)){this.descriptor=e,this._pages=t,this._addressTable=r;let n=He+t.reduce((a,{usedMemory:d})=>a+d,0),i=3*q,o=ze(r);this.usedMemory=A+n+i+o,this.featureCount=Math.floor(this._addressTable.length/2),this.isComplete=this.featureCount===t.reduce((a,d)=>a+d.featureCount,0)}get id(){return this.descriptor.id}getObjectId(e){let{pageIndex:t,featurePageIndex:r}=this._translateIndex(e);return this._pages[t].getObjectId(r)}getAttribute(e,t){let{pageIndex:r,featurePageIndex:n}=this._translateIndex(e);return this._pages[r].getAttribute(n,t)}getAttributeAsTimestamp(e,t){let{pageIndex:r,featurePageIndex:n}=this._translateIndex(e);return this._pages[r].getAttributeAsTimestamp(n,t)}getAttributes(e){let{pageIndex:t,featurePageIndex:r}=this._translateIndex(e);return this._pages[t].getAttributes(r)}getCoordinates(e,t,r){let{pageIndex:n,featurePageIndex:i}=this._translateIndex(e);this._pages[n].getCoordinates(i,t,r)}getOptimizedGeometry(e){let{pageIndex:t,featurePageIndex:r}=this._translateIndex(e);return this._pages[t].getOptimizedGeometry(r)}getCentroid(e,t){let{pageIndex:r,featurePageIndex:n}=this._translateIndex(e);return this._pages[r].getCentroid(n,t)}getBounds(e){let{pageIndex:t,featurePageIndex:r}=this._translateIndex(e);return this._pages[t].getBounds(r)}getBoundingBox(e){let{pageIndex:t,featurePageIndex:r}=this._translateIndex(e);return this._pages[t].getBoundingBox(r)}readObjectIds(e,t=this._allFeatureIndices(),r=0){let n=r;for(let{page:i,indices:o}of this._batchPageIndices(t))n=i.readObjectIds(e,o,n);return n}readCoordinates(e,t=this._allFeatureIndices(),r=0){let n=r;for(let{page:i,indices:o}of this._batchPageIndices(t))n=i.readCoordinates(e,o,n);return n}*objectIds(e=this._allFeatureIndices()){for(let{page:t,indices:r}of this._batchPageIndices(e))for(let n of t.objectIds(r))yield n}exclude(e){if(e.size===0)return this;let{_addressTable:t,featureCount:r}=this,n=new Array;for(let i=0;i<r;++i){let o=this.getObjectId(i);e.has(o)||(n.push(t[2*i]),n.push(t[2*i+1]))}return new s(this.descriptor,this._pages,n)}reset(){let{isComplete:e,_pages:t}=this;return e?this:new s(this.descriptor,t)}*_allFeatureIndices(){let{featureCount:e}=this;for(let t=0;t<e;++t)yield t}_translateIndex(e){let{_addressTable:t}=this;return{pageIndex:t[2*e],featurePageIndex:t[2*e+1]}}*_batchPageIndices(e){let t=new Array;{let n=0,i=new Array;for(let o of e){let{pageIndex:a,featurePageIndex:d}=this._translateIndex(o);n!==a&&(i.length!==0&&t.push({pageIndex:n,indices:i}),n=a,i=[]),i.push(d)}i.length!==0&&t.push({pageIndex:n,indices:i})}let{_pages:r}=this;for(let{pageIndex:n,indices:i}of t)yield{page:r[n],indices:i}}};function Rt(s){let e=s.reduce((n,{featureCount:i})=>n+i,0),t=new Array;if(e===0)return t;let r=s[0].featureCount;for(let n=0;n<e;++n)t[2*n]=Math.floor(n/r),t[2*n+1]=n%r;return t}var ee=class{constructor(e){this._reader=new rt(new Uint8Array(e),new DataView(e)),this._index=Tt(this._reader)}get featureCount(){return this._index.featureIndices.length}get exceededTransferLimit(){return this._index.exceededTransferLimit}get usedMemory(){return this._reader.usedMemory}getObjectId(e){return this.getAttribute(e,this._index.objectIdFieldName)}getAttribute(e,t){let{_index:{fieldsIndex:r,attributeIndices:n}}=this,i=r.get(t)?.index;if(i==null)return;let o=n[e*r.fields.length+i],a=this._reader;return a.move(o),K(a)}getAttributeAsTimestamp(e,t){let r=this.getAttribute(e,t);return typeof r=="string"?new Date(r).getTime():typeof r=="number"||r==null?r:null}getAttributes(e){let{_index:{fieldsIndex:t,attributeIndices:r}}=this,n=e*t.fields.length,i=this._reader,o={};for(let a of t.fields){let d=r[n+a.index];i.move(d),o[a.name]=K(i)}return o}getCoordinates(e,t,r=0){let n=this._reader,{transform:i,featureIndices:o}=this._index,{scale:a,translate:d}=i;n.move(o[e]),this._readCoordinates(a,d,t,r)}getOptimizedGeometry(e){let t=M();return this.getCoordinates(e,t),new G([],t)}getCentroid(e,{hasZ:t,hasM:r}){this.getCoordinates(e,B);let[n,i,o]=B,a=[n,i];return t&&(a[3]=o),r&&(a[t?4:3]=0),new G([],a)}getBounds(e){this.getCoordinates(e,B);let[t,r]=B,n=new $;return n.minX=t,n.minY=r,n.maxX=t,n.maxY=r,n}getBoundingBox(e){this.getCoordinates(e,B);let[t,r,n]=B;return ke(t,r,n,t,r,n)}readObjectIds(e,t=this._allFeatureIndices(),r=0){let n=this._reader,{objectIdFieldName:i,attributeIndices:o,fieldsIndex:a}=this._index,d=a.get(i).index,c=a.fields.length;for(let u of t){let l=o[u*c+d];n.move(l),e[r++]=K(n)}return r}readCoordinates(e,t=this._allFeatureIndices(),r=0){let n=this._reader,{transform:i,featureIndices:o}=this._index,{scale:a,translate:d}=i;for(let c of t){let u=o[c];n.move(u),r=this._readCoordinates(a,d,e,r)}return r}*objectIds(e=this._allFeatureIndices()){let t=this._reader,{objectIdFieldName:r,attributeIndices:n,fieldsIndex:i}=this._index,o=i.get(r).index,a=i.fields.length;for(let d of e){let c=n[d*a+o];t.move(c),yield K(t)}}*_allFeatureIndices(){let{featureCount:e}=this;for(let t=0;t<e;++t)yield t}_readCoordinates([e,t,r],[n,i,o],a,d){let l=this._reader,f=l.getLength(),p=l.pos()+f;for(;l.pos()<p&&l.next();)switch(l.tag()){case 2:{let h=l.getLength(),g=l.pos()+h;for(;l.pos()<g&&l.next();)l.tag()===3?(l.getUInt32(),a[d++]=n+e*l.getSInt64(),a[d++]=i+t*l.getSInt64(),a[d++]=o+r*l.getSInt64()):l.skip();break}default:l.skip()}return d}};function Tt(s){for(;s.next();){if(s.tag()===2)return Mt(s.getMessage());s.skip()}te()}function Mt(s){for(;s.next();){if(s.tag()===1)return Ot(s.getMessage());s.skip()}te()}function Ot(s){let u,l,f=!1,p=!1,h=0,g=new Array,w=new Array,I=new Array;for(;s.next();)switch(s.tag()){case 1:l=s.getString();break;case 7:s.getEnum()!==0&&te();break;case 9:f=s.getBool()??!1;break;case 12:u=qe(s.processMessage(st));break;case 13:{let C=s.processMessage(nt);C.index=h++,g.push(C);break}case 15:{w.push(s.pos());let C=s.getUInt32(),me=s.pos()+C;for(;s.pos()<me&&s.next();)s.tag()===1&&I.push(s.pos()),s.skip();break}case 10:p=s.getBool()??!1;break;default:s.skip()}let F=new Ue(g);return u!=null&&p&&l!=null&&F.has(l)||te(),{transform:u,exceededTransferLimit:f,fieldsIndex:F,objectIdFieldName:l,featureIndices:w,attributeIndices:I}}function te(){let s=new ve("pbf-parsing-failed","Error while parsing PBF",new Error);throw console.error(s),s}function K(s){let u=s.getLength(),l=s.pos()+u;for(;s.pos()<l&&s.next();)switch(s.tag()){case 1:return s.getString();case 2:return s.getFloat();case 3:return s.getDouble();case 4:return s.getSInt32();case 5:return s.getUInt32();case 6:return s.getInt64();case 7:return s.getUInt64();case 8:return s.getSInt64();case 9:return s.getBool();default:return s.skip(),null}return null}var B=M();var _t=8e3,Ft=4,Bt=4,re=class{constructor(e,t,r,n,i){this.spatialReference=e,this.url=r,this.objectIdField=n,this.capabilities=i;let{supportsMaxRecordCountFactor:o,maxRecordCount:a}=this.capabilities.query,d=o?Ft:1,c=(a??_t)*d;this._pageSize=Math.min(_t,c);let u=t.clone();u.cacheHint=!0,u.resultType="tile",u.outSpatialReference=e,u.returnGeometry=!0,u.returnZ=!0,u.maxRecordCountFactor=d,u.num=this._pageSize,u.outFields=[n],this._baseQuery=u}fetch(e,t){return m(this,null,function*(){let{spatialReference:r}=this,n=Be(e.extent,r),i=this._baseQuery.clone();i.geometry=n;let o=new Array,a=0,d=!1,c=1;for(;!d;){let u=[];for(let f=0;f<c;++f)u.push(this._fetchPage(i,a++,t));let l=yield Promise.all(u);j(t);for(let f of l){let p=f.featureCount!==0;d||=!f.exceededTransferLimit||!p,p&&o.push(f)}c=Math.min(c+1,Bt)}return new Z(e,o)})}_fetchPage(e,t,r){return m(this,null,function*(){let n=e.clone();n.start=t*this._pageSize;let i=(yield it(this.url,n,{signal:r})).data;return j(r),new ee(i)})}};var k=class{constructor(e){this._bufferWriter=null,this._bufferWriter=e.createBufferWriter()}createBuffer(e,t){let r=this._bufferWriter,n=null;if(e.transformation&&t)je(E,e.transformation),E[12]-=t[0],E[13]-=t[1],E[14]-=t[2],n=E;else{if(t)throw new Error("not implemented");e.transformation&&(n=e.transformation)}let i=null;n&&(De(ne,E),Le(ne,ne),i=ne);let o=e.attributes,a=r.elementCount(o),d=r.vertexBufferLayout.stride/4;a>Math.floor(Et/d)&&console.warn("geometry with very large number of elements encountered");let c=r.vertexBufferLayout.createBuffer(a);return r.write(n,i,o,e.objectAndLayerIdColor,c,0),{data:c.buffer,elementCount:a}}},E=S(),ne=S(),Et=16777216/4;var se=class{constructor(e){this._context=e,this._commands=[],this._transferables=new Set}createMaterial(e){let t=this._context,r=t.generateId("material");switch(e){case"default":{let n=new lt({},{spherical:this._context.globalViewingMode,doublePrecisionRequiresObfuscation:!0}),i=new k(n);t.registerRenderGeometryBufferWriter(r,i)}break;case"hud":{let n=ut(null,this._context.globalViewingMode)[0],i=new k(n);t.registerRenderGeometryBufferWriter(r,i)}}return this._commands.push({id:"create-material",type:e,materialId:r}),r}createDirectRenderer(e){let t=this._context.generateId("material-renderer");return this._commands.push({id:"create-direct-renderer",materialRendererId:t,materialId:e}),t}addDirectRendererGeometry(e,t,r){let n=t.materialId,i=this._context.getRenderGeometryBufferWriter(n);if(i==null)throw new Error(`no bufferwriter found for material ${n}`);let o=i.createBuffer(t,r);this._transferables.add(o.data),this._commands.push({id:"add-direct-renderer-geometry",renderGeometryId:e,materialId:n,renderGeometryBuffer:o,localOrigin:r})}removeDirectRendererGeometry(e){this._commands.push({id:"remove-direct-renderer-geometry",renderGeometryId:e})}createLodRenderer(e){let t=this._context.generateId("lod-renderer"),r={levels:e.levels.map(n=>({components:n.components.map(i=>{let o=i.attributes.get(_.POSITION);if(!o||o.indices.length===0)throw new Error("positions attribute expected");let a=3,d=et(o.indices.length/a),c=new mt(d,a,o),u=this._context.getRenderGeometryBufferWriter(i.materialId);if(u==null)throw new Error("writer not found");let l=u.createBuffer(i,null);return this._transferables.add(l.data),{materialId:i.materialId,renderGeometryBuffer:l,boundingInfo:{bbMax:c.bbMax,bbMin:c.bbMin}}}),minScreenSpaceRadius:n.minScreenSpaceRadius}))};return this._commands.push({id:"create-lod-renderer",lodRendererId:t,lodRenderGeometry:r}),t}addLodInstances(e,t){this._commands.push({id:"add-lod-instances",lodRendererId:e,data:t}),this._transferables.add(t.featureIds.buffer),this._transferables.add(t.globalTransforms.buffer),this._transferables.add(t.localTransforms.buffer)}removeLodInstances(e,t){this._commands.push({id:"remove-lod-instances",lodRendererId:e,featureIds:t}),this._transferables.add(t.buffer)}append(e){if(e._context!==this._context)throw new Error("Cannot append encoders from different contexts");let{_commands:t,_transferables:r}=this;for(let n of e._commands)t.push(n);for(let n of e._transferables)r.add(n)}dispatch(){return m(this,null,function*(){let e=this._commands,t=Array.from(this._transferables);this._clearCommandBuffer(),yield this._context.dispatchRenderCommands(e,t)})}_clearCommandBuffer(){this._commands=[],this._transferables.clear()}};var ie=class{constructor(e){this._idCounter=0,this._bufferWriters=new Map,this._dispatchRenderCommandsCallback=()=>m(this,null,function*(){}),this.globalViewingMode=!1,this.globalViewingMode=e.viewingMode===dt.Global,this._dispatchRenderCommandsCallback=e.dispatchRenderCommandsCallback}generateId(e=""){return`${e}${this._idCounter++}`}createEncoder(){return new se(this)}dispatchRenderCommands(e,t){return m(this,null,function*(){e.length!==0&&(yield this._dispatchRenderCommandsCallback(e,t))})}registerRenderGeometryBufferWriter(e,t){this._bufferWriters.set(e,t)}getRenderGeometryBufferWriter(e){return this._bufferWriters.get(e)}};var P=class{constructor(e,t){this._renderCommands=e,this._pipelineStateCommands=t}append(e){this.appendRenderCommands(e._renderCommands),this.appendPipelineStateCommands(e._pipelineStateCommands)}appendRenderCommands(e){this._renderCommands.append(e)}appendPipelineStateCommand(e){this._pipelineStateCommands.push(e)}appendPipelineStateCommands(e){let{_pipelineStateCommands:t}=this;for(let r of e)t.push(r)}execute(){for(let e of this._pipelineStateCommands)e();this._renderCommands.dispatch()}};function W(s,e){let{featureCount:t}=s;if(t===0)return new Uint32Array;let r=new Uint32Array(t);return s.readObjectIds(r),r}function we(s,e){let{featureCount:t}=s;if(t===0)return new Float64Array;let r=new Float64Array(3*t);return s.readCoordinates(r),r}function yt(s,e){let{featureCount:t}=s;if(t===0)return new Float64Array;let r=we(s),n=e.viewSpatialReference,i=e.renderSpatialReference,o=new Float64Array(3*t);if(!$e(r,n,0,o,i,0,t))throw new Error("Failed to project coordinates");return o}function xt(s,e){let t=e.viewSpatialReference,r=e.renderSpatialReference,{extent:n}=s,i=Ee(n),o=M();return ct([i[0],i[1],0],t,o,r),o}function oe(s){let e=new Map;for(let[t,r]of s)e.set(t,H(z({},r),{indices:Ke(r.indices)}));return e}function wt(s,e){let t=(r,n,i=!1)=>({levels:r.map(o=>{let a=oe(n(o.tesselation));return i&&Pt(a),{components:[{attributes:a,objectAndLayerIdColor:void 0,transformation:null,materialId:e}],minScreenSpaceRadius:o.minScreenSpaceRadius}})});switch(s){case"cone":return t(jt,r=>pt(1,.5,r,!1),!0);case"sphere":case"cube":case"inverted-cone":case"cylinder":case"tetrahedron":case"diamond":throw new Error("not implemented");default:return}}function Pt(s){let e=s,t=e.get(_.POSITION).data,r=e.get(_.NORMAL).data;if(r){let n=bt(s,_.NORMAL).data;for(let i=0;i<r.length;i+=3){let o=r[i+1];n[i+1]=-r[i+2],n[i+2]=o}}if(t){let n=bt(s,_.POSITION).data;for(let i=0;i<t.length;i+=3){let o=t[i+1];n[i+1]=-t[i+2],n[i+2]=o}}}function bt(s,e){let t=s.get(e);return t&&!t.exclusive&&(t=H(z({},t),{exclusive:!0,data:ft(t.data)}),s.set(e,t)),t}var jt=[{tesselation:6,minScreenSpaceRadius:0},{tesselation:18,minScreenSpaceRadius:7},{tesselation:64,minScreenSpaceRadius:65}];var de=class{constructor(e){this._context=e,this.lodRendererId=null,this._loaded=!1,this._loadingPromise=null,this._primitive="cone"}get loaded(){return this._loaded}load(){return this._loadingPromise==null&&(this._loadingPromise=this._load()),this._loadingPromise}_load(){return m(this,null,function*(){let e=this._context.renderCommandContext.createEncoder(),t=e.createMaterial("default"),r=wt(this._primitive,t);this.lodRendererId=e.createLodRenderer(r),yield e.dispatch(),this._loaded=!0})}createAddCommand(e){return m(this,null,function*(){let t=this._context.renderCommandContext.createEncoder();if(this.lodRendererId==null)throw new Error("expected lod renderer id to not be null");let{featureCount:r}=e;if(r===0)return t;let n=!0,i=Qe(at(this._primitive)),o=_e(We(i)),a=_e(ot(o,{isPrimitive:n,width:100,depth:null,height:null})),d=new Float64Array(16*r),c=new Float64Array(16*r),u=we(e,this._context);for(let p=0;p<r;++p){let h=p,g=u[3*p+0],w=u[3*p+1],I=u[3*p+2],F=this._computeGlobalTransform(g,w,I,this._context.viewSpatialReference,Lt),C=this._computeLocalTransform(a,o,Gt);this._writeMatrixToTypedBuffer(d,h,C),this._writeMatrixToTypedBuffer(c,h,F)}let l=W(e,this._context),f={featureIds:new Uint32Array(l),localTransforms:d,globalTransforms:c};return t.addLodInstances(this.lodRendererId,f),t})}createRemoveCommand(e){return m(this,null,function*(){let t=this._context.renderCommandContext.createEncoder();if(this.lodRendererId==null)return t;let r=W(e,this._context);return t.removeLodInstances(this.lodRendererId,r),t})}_writeMatrixToTypedBuffer(e,t,r){let n=16*t;for(let i=0;i<16;i++)e[n++]=r[i]}_computeGlobalTransform(e,t,r,n,i){return ae[0]=e,ae[1]=t,ae[2]=r,tt(n,ae,i,this._context.renderSpatialReference),i}_computeLocalTransform(e,t,r){return Ge(r),this._applyObjectScale(e,t,r),r}_applyObjectScale(e,t,r){let n=ht(e,e,t,this._context.renderCoordsHelper.unitInMeters);n[0]===1&&n[1]===1&&n[2]===1||Ne(r,r,n)}},ae=M(),Gt=S(),Lt=S();var ce=class{constructor(e){this._context=e,this.materialId=null,this._loaded=!1,this._loadingPromise=null}get loaded(){return this._loaded}load(){return this._loadingPromise==null&&(this._loadingPromise=this._load()),this._loadingPromise}_load(){return m(this,null,function*(){let e=this._context.renderCommandContext.createEncoder();this.materialId=e.createMaterial("hud"),e.createDirectRenderer(this.materialId),yield e.dispatch(),this._loaded=!0})}createAddCommand(e){return m(this,null,function*(){let t=this._context.renderCommandContext.createEncoder();if(this.materialId==null)throw new Error("expected material not to be null");let{featureCount:r,id:n}=e;if(r===0)return t;let i=yt(e,this._context),o=xt(e,this._context),a=new Float64Array([0,0,1]),d=new Float64Array([255,255,255,255]),c=new Float64Array([24,24]),u=new Float64Array([0,0,0,1]),l=new Float64Array([0,0]),f=new Float64Array([0]),p=new Uint32Array(r);for(let v=0;v<r;++v)p[v]=v;let h=new Uint32Array(r);for(let v=0;v<r;++v)h[v]=0;let g=new R(i,p,3,!0),w=new R(a,h,3,!0),I=new R(l,h,2,!0),F=new R(d,h,4,!0),C=new R(f,h,1,!0),me=new R(c,h,2,!0),Ct=new R(u,h,4,!0),vt=[[_.POSITION,g],[_.NORMAL,w],[_.UV0,I],[_.COLOR,F],[_.ROTATION,C],[_.SIZE,me],[_.CENTEROFFSETANDDISTANCE,Ct]],At={attributes:oe(vt),objectAndLayerIdColor:void 0,transformation:S(),materialId:this.materialId};return t.addDirectRendererGeometry(n,At,o),t})}createRemoveCommand(e){return m(this,null,function*(){let t=this._context.renderCommandContext.createEncoder();return t.removeDirectRendererGeometry(e.id),t})}};var le=class{constructor(e){this._symbols=new Array,this._featureDataPartitioning=new Map,this._context=e}load(){return m(this,null,function*(){this._symbols[0]=new ce(this._context),this._symbols[1]=new de(this._context)})}createAddCommand(e){return m(this,null,function*(){let t=this._partition(e),r=yield Promise.all(t.map(a=>m(this,[a],function*({index:i,features:o}){return yield(yield this._provisionSymbol(i))?.createAddCommand(o)}))),n=this._context.renderCommandContext.createEncoder();for(let i of r)i!=null&&n.append(i);return new P(n,[()=>{this._featureDataPartitioning.set(e,t)}])})}createRemoveCommand(e){return m(this,null,function*(){let{_featureDataPartitioning:t}=this,r=t.get(e),n=this._context.renderCommandContext.createEncoder();if(r==null)return new P(this._context.renderCommandContext.createEncoder(),[]);let i=yield Promise.all(r.map(d=>m(this,[d],function*({index:o,features:a}){return yield this._getLoadedSymbol(o)?.createRemoveCommand(a)})));for(let o of i)o!=null&&n.append(o);return new P(n,[()=>{t.delete(e)}])})}_provisionSymbol(e){return m(this,null,function*(){if(e==null)return null;let t=this._symbols[e];return t?(t.loaded||(yield t.load()),t):null})}_getLoadedSymbol(e){if(e==null)return null;let t=this._symbols[e];return t!=null&&t.loaded?t:null}_partition(e){let t=W(e,this._context);if(t==null)throw new Error("unable to fetch objectIds");let{featureCount:r}=e,n=[[],[]];for(let i=0;i<r;++i)n[t[i]%2].push(i);return n.map((i,o)=>new Ie(o,e.subset(new Uint32Array(i)))).filter(i=>i.features.featureCount>0)}},Ie=class{constructor(e,t){this.index=e,this.features=t}};var ue=class extends U.EventedAccessor{constructor(){super(...arguments),this.remoteClient=null,this._featureDataStore=new X,this._featureStore=new Y,this._tileManager=null,this._renderer=null,this._fetcher=null,this._queryEngine=null,this._defaultQueryJSON=null}get updating(){return this._tileManager.updating}destroy(){this._featureStore.clear(),this._tileManager?.destroy()}setup(u){return m(this,arguments,function*({viewSpatialReference:s,renderSpatialReference:e,viewingMode:t,baseQuery:r,url:n,objectIdField:i,capabilities:o,fieldsIndex:a,timeInfo:d,fullExtent:c}){let l=ge.fromJSON(s),f=ge.fromJSON(e);this._fetcher=new re(l,ye.fromJSON(r),n,i,o),this._queryEngine=new Ye({hasZ:!0,hasM:!1,geometryType:"esriGeometryPoint",objectIdField:i,fieldsIndex:a,availableFields:[i],spatialReference:s,featureStore:this._featureStore,timeInfo:d}),this._renderer=new le({viewSpatialReference:l,renderSpatialReference:f,renderCoordsHelper:gt.create(t,f),renderCommandContext:new ie({viewingMode:t,dispatchRenderCommandsCallback:(h,g)=>this.remoteClient.invoke("dispatchRenderCommands",h,{transferList:g})})}),this._defaultQueryJSON=new ye({outSpatialReference:l}).toJSON();let p=null;if(c!=null){let h=Oe.fromJSON(c);yield Xe(h.spatialReference,l),p=Je(h,l)}return this._tileManager=new x({loadTile:(h,g)=>this._fetcher.fetch(h,g),createAddTileCommand:(h,g)=>this._createAddTileCommand(h,g),createRemoveTileCommand:h=>this._createRemoveTileCommand(h),extent:p}),this.addHandles(Te(()=>this.updating,h=>{this.emit("notify-updating",{updating:h})}),Me),yield this._renderer.load(),It})}executeQuery(s,e){return m(this,null,function*(){return{result:yield this._queryEngine.executeQuery(this._ensureQuery(s),e)}})}executeQueryForIds(s,e){return m(this,null,function*(){let t=yield this._queryEngine.executeQueryForIdSet(this._ensureQuery(s),e);return{result:Array.from(t)}})}executeQueryForCount(s,e){return m(this,null,function*(){return{result:yield this._queryEngine.executeQueryForCount(this._ensureQuery(s),e)}})}executeQueryForExtent(s,e){return m(this,null,function*(){return{result:yield this._queryEngine.executeQueryForExtent(this._ensureQuery(s),e)}})}executeQueryForLatestObservations(s,e){return m(this,null,function*(){return{result:yield this._queryEngine.executeQueryForLatestObservations(this._ensureQuery(s),e)}})}onTileTreeChange(s){return m(this,null,function*(){return yield this._tileManager.onTileTreeChange(s),It})}_createAddTileCommand(s,e){return m(this,null,function*(){let t=new J(s),r=yield this._renderer.createAddCommand(t);return j(e),r.appendPipelineStateCommand(()=>{this._featureDataStore.add(t),this._featureStore.addTile(s)}),r})}_createRemoveTileCommand(s){return m(this,null,function*(){let e=this._featureStore,t=this._featureDataStore,r=this._renderer,n=t.get(s);if(n==null)return null;let i=yield r.createRemoveCommand(n);return i.appendPipelineStateCommand(()=>{t.remove(s),e.removeTile(s)}),i})}_ensureQuery(s){return s??this._defaultQueryJSON}};y([b()],ue.prototype,"updating",null),ue=y([V("esri.views.3d.layers.graphics.pipeline.Feature3DPipelineWorker")],ue);var Xn=ue,It={result:void 0};export{Xn as default};
