import{a as X}from"./chunk-XBSD6EUF.js";import{a as I}from"./chunk-TJ6P6NLD.js";import{e as J,f as j,i as h}from"./chunk-IO35PPBL.js";import{f as W,i as A,m as _,n as E}from"./chunk-F5AJITOA.js";import{a as k,b as L,c as H,r as b}from"./chunk-3CLJ5OX5.js";import{$ as Z,da as G}from"./chunk-KALOJIUA.js";import{a as P}from"./chunk-E7AX56GD.js";import{a as M,b as U}from"./chunk-PQGCNP5H.js";import{p as B}from"./chunk-4PTIEWMT.js";import{y as D}from"./chunk-QBWJMFH5.js";import{f as q}from"./chunk-VTHXE323.js";var te=/_value$/i,ie=Math.LOG10E,le={SECOND:1e3,MINUTE:6e4,HOUR:36e5},ae=10;function $e(e){return e.map(n=>n.toJSON())}function qe(e,n){let i=[],l=e.layer,t="featureReduction"in l?l.featureReduction:null,a=t?.type==="binning",r=t!=null&&"fields"in t?t.fields?.map(o=>o.name?.toLowerCase()).filter(Boolean):[];if(!a||!n)return i;for(let o of n)r.includes(o.toLowerCase())||i.push(o);return i}function Le(e,n,i){let l=[];if(n)for(let t of n){let a=e.getField(t);a&&i&&"availableFields"in i&&!i.availableFields?.includes(a.name)&&l.push(a.name)}return l}function Oe(e,n){let i=e&&e.features;if(i?.length===0)return{avg:null,count:0,max:null,median:null,min:null,nullcount:0,stddev:null,sum:null,variance:null};let l=i?.[0]?.attributes,t={};for(let a in l)t[a.replace(te,"").toLowerCase()]=l[a];return t.totalcount!=null&&t.totalcount>=t.count&&(t.nullcount=t.totalcount-t.count),delete t.totalcount,t.min===t.max&&t.min!=null&&t.stddev==null&&(t.stddev=t.variance=0),n&&(["min","max","avg","stddev","sum","variance"].forEach(a=>{t[a]!=null&&(t[a]=Math.ceil(t[a]))}),t.min===t.max&&t.min!=null&&(t.avg=t.min,t.stddev=t.variance=0)),t}function be(e){let n=[],i=e.classBreaks,l=i[0].minValue,t=i[i.length-1].maxValue;i.forEach(r=>{n.push([r.minValue,r.maxValue])});let a={field:e.field,normalizationType:e.normalizationType,normalizationField:e.normalizationField,normalizationTotal:e.normalizationTotal,layer:e.layer};return{min:l,max:t,intervals:n,sqlExpr:K(a),excludeZerosExpr:e.where,normTotal:e.normalizationTotal}}function K(e){let{field:n,normalizationType:i,normalizationField:l,normalizationTotal:t,layer:a}=e,r=_(a,n),o=n;return i==="percent-of-total"?o=`((${r?E(n):n} / ${t}) * 100)`:i==="log"?o=`(log(${n}) * ${ie})`:i==="field"?o=`(${r?E(n):n} / ${l})`:i==="natural-log"?o=`(log(${r?E(n):n}))`:i==="square-root"&&(o=`(power(${r?E(n):n}, 0.5))`),o}function Y(e,n){let i;if(n=n.toLowerCase(),e){for(let l in e)if(l.toLowerCase()!==n){i=e[l];break}}return i}function $(e,n){let i;if(n=n.toLowerCase(),e){for(let l in e)if(l.toLowerCase()===n){i=e[l];break}}return i}function Ie(e,n,i,l,t){let a={},r="countOFExpr";e&&e.features&&e.features.forEach(m=>{let s=m.attributes,u=Y(s,r),p=$(s,r);u!=null&&p!=null&&u!==0&&(a[u]=p)});let o=[];return b(n,i,l).forEach((m,s)=>{let u=(s+1).toString();o.push({minValue:m[0],maxValue:m[1],count:a.hasOwnProperty(u)?a[u]:0})}),{bins:o,minValue:n,maxValue:i,normalizationTotal:t}}function Ne(e,n){return q(this,null,function*(){let i=e&&e.features,{field:l,field2:t,field3:a,fieldDelimiter:r,layer:o,view:m,signal:s,labels:u}=n,p=`countOF${(!l||!t)&&l||"Expr"}`,c={},v=!1;for(let F of i){let f=F.attributes,T=$(f,p),y=l?$(f,l):Y(f,p),S=t?$(f,t):null,x=a?$(f,a):null;y===null&&T===0&&(v=!0),(y==null||typeof y=="string"&&y.trim()==="")&&(y=null),t&&(S==null||typeof S=="string"&&S.trim()==="")&&(S=null),a&&(x==null||typeof x=="string"&&x.trim()==="")&&(x=null);let d=y;t&&(d=`${L(d)}${r}${L(S)}`,a&&(d=`${d}${r}${L(x)}`)),c[d]==null?c[d]={count:T,data:d}:c[d].count=c[d].count+T}if(l&&v){let F=l+" is NULL";try{let f=yield o.queryFeatureCount({whereClause:F,view:m,signal:s});return c.null.count=c.null.count+f,N(c,u)}catch{return B(s),N(c,u)}}return N(c,u)})}function N(e,n){if(n)for(let i in e)e[i].label=n[i];return{count:e}}function R(e,n,i){return q(this,null,function*(){let l=e?i.getField(e):null,t=l?i.getFieldDomain(l.name):null;if(t)return t;let{uniqueValueInfos:a}=yield i.uniqueValues({field:e,sqlWhere:n.sqlWhere,features:n.features,useFeaturesInView:n.useFeaturesInView,view:n.view,signal:n.signal}),r=a.map(o=>new M({code:o.value}));return new U({codedValues:r})})}function Re(e,n){return q(this,null,function*(){if(!e.returnAllCodedValues)return[];let{field:i,field2:l,field3:t}=e;if(i&&!l){let r=i?n.getField(i):null,o=r?n.getFieldDomain(r.name):null;return o?[o]:[]}let a=[];return i&&(a.push(R(i,e,n)),l&&(a.push(R(l,e,n)),t&&a.push(R(t,e,n)))),Promise.all(a)})}function oe(e,n){return A(e,new Date(0),n,"milliseconds").sqlExpression}function re(e,n){return`EXTRACT(${n} FROM ${e}) * ${le[n]}`}function se(e){return e?E(["HOUR","MINUTE","SECOND"].map(n=>`(${re(e,n)})`).join(" + ")):null}function Qe(e){return{viewingMode:e.type==="2d"?"map":e.viewingMode,scale:e.scale,spatialReference:e.spatialReference?.toJSON()}}function De(e,n){let i=new Set(e.map(t=>t.value)),l=n.filter(t=>!i.has(t));for(let t of l)e.push({value:t,count:0});e.sort((t,a)=>n.indexOf(t.value)-n.indexOf(a.value));for(let t of e)t.value===X&&(t.value=null);return{predominantCategoryInfos:e}}function Be(e){let n="featureReduction"in e?e.featureReduction:null;return((n!=null&&"fields"in n?n.fields:null)??[]).map(i=>{let l=ue(i,e.fieldsIndex);return l?new P({type:l,name:i.name,alias:i.alias}):null}).filter(D)}function ue(e,n){switch(e.statisticType){case"avg":case"avg_angle":return"double";case"count":return"integer";case"min":case"max":case"sum":return e.onStatisticField?n.get(e.onStatisticField)?.type??null:e.onStatisticExpression?e.onStatisticExpression.returnType==="string"?null:"double":null;case"mode":return e.onStatisticField?n.get(e.onStatisticField)?.type??null:e.onStatisticExpression?e.onStatisticExpression.returnType==="string"?"string":"double":null;default:return null}}function ce(e,n){return W(n)?oe(e,n?.name):G(n)?se(n?.name):null}function Me(e,n,i){let{field:l,normalizationType:t,normalizationField:a,normalizationTotal:r,minValue:o,maxValue:m,filter:s}=n,u=e.supportsSQLExpression?ce(e,i)||n.sqlExpression:null,p=K({field:l,normalizationType:t,normalizationField:a,normalizationTotal:r,layer:e}),c=u||p,v=c?j(c,o,m):null,F=J({field:l,normalizationField:a,normalizationType:t}),f=h(n.sqlWhere,F),T=h(f,v),y=H({normalizationField:a,normalizationType:t,sqlExpression:u,supportsSQLExpression:e.supportsSQLExpression,minValue:o,maxValue:m}),S=Z(e.getField(l??void 0)),{include:x,exclude:d}=n.outStatisticTypes||{},ne=k.filter(g=>(!x||x.includes(g))&&(!d||!d.includes(g))&&(g==="nullcount"?y:!S||g==="count")),w=e.createQuery();return w.where=h(w.where,T),w.sqlFormat=u?"standard":null,w.outStatistics=ne.map(g=>{let V=new I,z=null,C=null,Q=`${g}_value`;if(g==="variance")z="var",C=c;else if(g==="nullcount"){let O=e.objectIdField;z="count",C=O&&e.getField(O)?O:"1",Q="totalcount_value"}else g==="median"?(z="percentile-continuous",C=c,V.statisticParameters={value:.5}):(z=g,C=c);return V.statisticType=z,V.onStatisticField=C,V.outStatisticFieldName=Q,V}),ee(w,s),w}function ee(e,n){n&&(e.geometry=n.geometry,e.spatialRelationship=n.spatialRelationship)}function Ue(e,n){let{field:i,field2:l,field3:t,sqlExpression:a}=n,r=!(!i||!l),o=e.createQuery();return o.where=h(o.where,n.sqlWhere),o.sqlFormat=a?"standard":null,o.outStatistics=[me(r?null:i,r?"1":a)].filter(Boolean),o.groupByFieldsForStatistics=[i||a,l,t].filter(Boolean),ee(o,n.filter),o}function me(e,n){let i="countOF"+(e||"Expr"),l=new I;return l.statisticType="count",l.onStatisticField=n?"1":e,l.outStatisticFieldName=i,l}function Pe(e,n,i,l=ae,t,a,r){let{min:o,max:m,normTotal:s,excludeZerosExpr:u}=n,p=n.intervals||b(o,m,l),c=n.sqlExpr||i;return fe(e,p,c,u,t,a,r).then(v=>({bins:v.map((F,f)=>({minValue:p[f][0],maxValue:p[f][1],count:F.status==="fulfilled"?F.value:0})),minValue:o,maxValue:m,normalizationTotal:s}))}function fe(e,n,i,l,t,a,r){let o=[],m=n.length;for(let s=0;s<m;s++){let u=h(l,h(i+" >= "+n[s][0],n[s][1]!==null?i+(s===m-1?" <= ":" < ")+n[s][1]:""));o.push(u)}return Promise.allSettled(o.map(s=>e.queryFeatureCount({whereClause:s,view:t,filter:a,signal:r})))}export{ae as a,$e as b,qe as c,Le as d,Oe as e,be as f,K as g,Ie as h,Ne as i,Re as j,Qe as k,De as l,Be as m,ce as n,Me as o,ee as p,Ue as q,Pe as r};
