import{a as kt,b as Mt}from"./chunk-NKO4QA5F.js";import{a as Vt}from"./chunk-KGFZFPKU.js";import{a as St}from"./chunk-7TJD5X3P.js";import{f as pe,g as fe,h as Tt}from"./chunk-KRZOFX2N.js";import{b as It,c as ue,e as ee,f as j,g as de,h as R,i as B,j as Ft}from"./chunk-JK6BWFR4.js";import{a as vt}from"./chunk-XA6M6D63.js";import{a as Se}from"./chunk-3W5FW4UA.js";import{a as wt,c as bt}from"./chunk-ETLJEDNA.js";import{a as Te}from"./chunk-U675DN4C.js";import{a as gt,c as Fe}from"./chunk-E6JHCD7G.js";import{a as ht}from"./chunk-EG4FJL5O.js";import{a as yt}from"./chunk-EFTNLZSK.js";import{a as ft,b as mt}from"./chunk-TFDME2PB.js";import{i as q}from"./chunk-SJAM4JSC.js";import{a as pt}from"./chunk-UZ6PRO67.js";import{b as dt}from"./chunk-7UE7WQ2N.js";import{a as ut}from"./chunk-XE6PIB3P.js";import{a as ce}from"./chunk-7XYYDAZO.js";import{a as Y}from"./chunk-6HT3BT3B.js";import{i as st}from"./chunk-YTAJKLRN.js";import{d as Xe}from"./chunk-BMZ3PE5Y.js";import{a as rt,e as it,i as ot,j as nt}from"./chunk-TPNSUEHH.js";import{c as at}from"./chunk-RNZY2XUD.js";import{A as ne,h as Je}from"./chunk-XR5FT7TQ.js";import{a as L}from"./chunk-LAX5536Z.js";import{a as tt}from"./chunk-CZ6CGC7I.js";import{a as et}from"./chunk-BPWNCOXC.js";import{a as le}from"./chunk-AVMO6LCR.js";import{a as Qe}from"./chunk-R3XLNYYB.js";import{a as Ye}from"./chunk-6F25LG6O.js";import{c as Ke}from"./chunk-ZC6EBRE4.js";import{s as Ie,ua as ct,y as lt}from"./chunk-KALOJIUA.js";import{b as se}from"./chunk-OLOKUDVI.js";import{b as W}from"./chunk-SLAWDKDA.js";import{a as M,b as Be,c as Ze,e as P,j as ve,k as $e}from"./chunk-TG45K3WR.js";import{f as je}from"./chunk-RAI4DTMT.js";import{a as S}from"./chunk-QGVBCWUY.js";import{e as k}from"./chunk-NFIPKH6V.js";import{l as qe}from"./chunk-5QEXLALV.js";import{c as oe}from"./chunk-P6QFA5MM.js";import{I as z,K as X,b as ze,d as re,p as K,w as Q,z as We}from"./chunk-4PTIEWMT.js";import{a as F,d as C,f as ie}from"./chunk-TG2UTNEO.js";import{b as E}from"./chunk-YOFFGXOB.js";import{g as N}from"./chunk-XRGPJ3QY.js";import{b as Ne}from"./chunk-2LI2GKBQ.js";import{g as He,j as De,y as Re}from"./chunk-QBWJMFH5.js";import{a as _,b as J,e as be,f as h}from"./chunk-VTHXE323.js";var Jt={"buffer-line-to-polygon":()=>import("./chunk-76QTYYSF.js"),"buffer-point-to-polygon":()=>import("./chunk-AAXAGERN.js"),"buffer-polygon-to-polygon":()=>import("./chunk-7N2QBMMX.js"),"connection-point":()=>import("./chunk-3PI5Q3SX.js"),"equally-spaced":()=>import("./chunk-XBZ3INHA.js"),"offset-line":()=>import("./chunk-XGHHUPVZ.js"),"offset-primary-line":()=>import("./chunk-73CCBJB2.js"),"point-at-all-vertices-of-line":()=>import("./chunk-ZW27JFLX.js"),"point-at-beginning-of-line":()=>import("./chunk-CAVFIWSO.js"),"point-at-beginning-of-radial":()=>import("./chunk-WKWZZFZT.js"),"point-at-end-of-line":()=>import("./chunk-DDI67XD3.js"),"point-at-interior-vertices":()=>import("./chunk-BJD4LEIR.js"),"point-at-intersection-vertices-of-line":()=>import("./chunk-6HH4IQDV.js"),"point-at-not-beginning-of-line":()=>import("./chunk-PQ4PRDIQ.js"),"point-at-not-end-of-line":()=>import("./chunk-UB4POP25.js"),"point-at-polygon-centroid":()=>import("./chunk-6OLZ2WDS.js"),"point-at-polygon-not-start":()=>import("./chunk-L76DBOZB.js"),"point-at-polygon-start":()=>import("./chunk-55SFHTIK.js"),"point-identity":()=>import("./chunk-PYTRJWPF.js"),"point-primary-identity":()=>import("./chunk-2VWT6SKK.js"),"polygon-boundary":()=>import("./chunk-GFIPFGVF.js"),"polygon-boundary-two-point":()=>import("./chunk-PASWA5GY.js"),"polygon-identity":()=>import("./chunk-23BXBPFN.js"),"polygon-primary-identity":()=>import("./chunk-KV6RZIAW.js"),"polygon-vertices":()=>import("./chunk-TD3YLNNA.js"),"radial-lines":()=>import("./chunk-A2NA444N.js"),"two-point-lines":()=>import("./chunk-IU5OVEM7.js")};function At(t){let e=Jt[t];if(!e)throw new Error(`Builder type ${t} is not supported.`);return e()}var _t=()=>N.getLogger("esri.editing.sharedTemplates.executor.createTemplateExecutor"),Z="globalid";function Ct(t){return h(this,null,function*(){if(!Ft(t))throw new E("template-executor:template-not-loaded","The template must be loaded before it can be executed.");if(de(t))return Kt(t);if(R(t))return Qt(t);if(B(t))return Yt(t);throw new E("template-executor:unsupported-template-type","The template type is not supported.")})}function Kt(t){return e=>{let a=[],i=[];Tt({geometry:e,template:t,edits:a,relationships:i});let r=pe(a);return{edits:fe(a),relationships:i,primary:a[0]??null,featureExtent:r,rotationPoint:r?.center??null}}}function Qt(t){return h(this,null,function*(){let{definition:e}=t,a=yield Promise.all(e.allParts.map(Xt));return(i,r)=>{let s=[],o=[],n=new Set,c=()=>{if(e.createUtilityNetworkAssociations&&r==="completion"){let{utilityNetwork:d,utilityNetworkAssociationsTable:f}=e;d&&f?ea({associationGraphics:n,associationsTable:f,edits:s,relationships:o,utilityNetworkHelper:d}):_t().warn("Unable to create utility network associations between group template features. The utility network or its associations table is unavailable.")}let u=pe(s);return{associationGraphics:n,edits:fe(s),relationships:o,primary:s[0]??null,featureExtent:u,rotationPoint:u?.center??null}};if(i==null)return _t().warn("No geometry provided to group template executor. Result will be empty."),c();let l=a.map(u=>u({edits:s,mode:r,parentTemplate:t,relationships:o,shape:i})).filter(z);return l.length===0?c():Promise.all(l).then(()=>c())}})}function Xt(t){return h(this,null,function*(){let e=yield At(t.builderType);return a=>e.execute(J(_({},a),{templatePart:t}))})}function Yt(t){return h(this,null,function*(){let{createPresetServiceEdit:e}=yield import("./chunk-WLK3UCYE.js");return(a,i,r=0)=>{if(!Ke(a))throw new E("template-executor:invalid-input-geometry","The input goemetry for a preset template must be a point.");let s=[],o=[],n=e({geometry:a,template:t,edits:s,relationships:o,rotation:r,mode:i});return{edits:fe(s),relationships:o,primary:s[0]??null,featureExtent:pe(s),rotationPoint:n}}})}function ea(t){let{edits:e,utilityNetworkHelper:a}=t,i=new Map;for(let r of e)r.tag!==""&&a.layerIdToSourceIdLookup.has(r.id)&&oe(i,r.tag,()=>[]).push(r);for(let r of i.values())if(!(r.length<2))for(let s=0;s<r.length;s++){let o=r[s];for(let n=s+1;n<r.length;n++)ta(o,r[n],t)}}function ta(t,e,a){let{associationGraphics:i,associationsTable:r,edits:s,utilityNetworkHelper:o,relationships:n}=a,c=o.findAgat(t.graphic,t.layer),l=o.findAgat(e.graphic,e.layer);if(!c||!l)return;let u=o.findRules(c).map(p=>p.fromNetworkSource?.sourceId!==c.networkSourceId||p.fromAssetGroup?.assetGroupCode!==c.assetGroup||p.fromAssetType?.assetTypeCode!==null&&p.fromAssetType?.assetTypeCode!==c.assetType||p.toNetworkSource.sourceId!==l.networkSourceId||p.toAssetGroup?.assetGroupCode!==l.assetGroup||p.toAssetType!==null&&p.toAssetType?.assetTypeCode!==l.assetType?p.toNetworkSource.sourceId!==c.networkSourceId||p.toAssetGroup?.assetGroupCode!==c.assetGroup||p.toAssetType!==null&&p.toAssetType?.assetTypeCode!==c.assetType||p.fromNetworkSource.sourceId!==l.networkSourceId||p.fromAssetGroup?.assetGroupCode!==l.assetGroup||p.fromAssetType?.assetTypeCode!==null&&p.fromAssetType?.assetTypeCode!==l.assetType?null:{rule:p,from:{agat:l,item:e},to:{agat:c,item:t}}:{rule:p,from:{agat:c,item:t},to:{agat:l,item:e}}).filter(p=>p?.rule.ruleType===Y.RTJunctionEdgeConnectivity||p?.rule.ruleType===Y.RTEdgeJunctionEdgeConnectivity||p?.rule.ruleType===Y.RTContainment?null:p).filter(p=>p!==null);if(u.length===0)return;let d=ut(r),f=new Set;for(let p of u){let y={};y[d.fromNetworkSourceId]=p.rule.fromNetworkSource.sourceId,y[d.fromGlobalId]=p.from.item.graphic.attributes[p.from.item.layer.globalIdField??Z],y[d.fromTerminalId]=null,p.rule.fromTerminal&&(y[d.fromTerminalId]=p.rule.fromTerminal.terminalId),y[d.toNetworkSourceId]=p.rule.toNetworkSource.sourceId,y[d.toGlobalId]=p.to.item.graphic.attributes[p.to.item.layer.globalIdField??Z],y[d.toTerminalId]=null,p.rule.toTerminal&&(y[d.toTerminalId]=p.rule.toTerminal.terminalId),y[d.associationType]=p.rule.ruleType,y[d.percentAlong]=null,y[d.isContentVisible]=p.rule.ruleType===Y.RTContainment?1:0,y[d.status]=0,y[d.globalId]=W();let w=`${y[d.fromNetworkSourceId]}-${y[d.fromGlobalId]}-${y[d.toNetworkSourceId]}-${y[d.toGlobalId]}-${y[d.associationType]}`;if(f.has(w))continue;f.add(w);let m=new L({attributes:y,sourceLayer:r});i.add(m),s.push({id:r.layerId,graphic:m,tag:"",layer:r}),n.push({sourceGraphic:p.to.item.graphic,sourceLayerId:p.to.item.layer.layerId,destinationGraphic:m,destinationLayerId:r.layerId,sourceField:p.to.item.layer.globalIdField??Z,destinationField:d.toGlobalId??Z}),n.push({sourceGraphic:p.from.item.graphic,sourceLayerId:p.from.item.layer.layerId,destinationGraphic:m,destinationLayerId:r.layerId,sourceField:p.from.item.layer.globalIdField??Z,destinationField:d.fromGlobalId??Z})}}function Pt(t,e){let a={};e=e||{continueOnCircularDependency:!1};let i=[],r={};t.forEach(o=>{let n=o[0],c;(c=a[n])||(c=a[n]=new me(n)),o.forEach(l=>{l!==n&&(a[l]||(a[l]=new me(l)),c.afters.push(l))})});let s=Object.keys(a);return s.sort(Et),s.forEach(function o(n,c){let l=a[n],u=l.id;if(r[n])return;let d=Array.isArray(c)?c:[];d.push(u),r[n]=!0,l.afters.sort(Et),l.afters.forEach(f=>{if(d.includes(f)){if(e?.continueOnCircularDependency)return;throw new Error("Circular chain found: "+u+" must be before "+f+" due to a direct order specification, but "+f+" must be before "+u+" based on other specifications.")}o(f,d.slice())}),i.push(u)}),i.reverse()}var me=class{constructor(e){this.id=e,this.afters=[]}};function Et(t,e){return t<e?1:t>e?-1:0}var aa=()=>N.getLogger("esri.widgets.Editor.workflowUtils");function Lr(t){return t.type==="update"}function _e(t){let e=t.sourceLayer;if(!e||e.type!=="feature"||!sa(e.renderer))return{rotation:null,size:null};let a=null,i=null,r=e.renderer.getVisualVariablesForType("rotation").filter(o=>(!o.axis||o.axis==="heading")&&o.field&&!o.valueExpression&&ot(o,t)!=null);r.length===1&&(a=ra(r[0],e));let s=e.renderer.getVisualVariablesForType("size").filter(o=>o.field&&!o.useSymbolValue&&!o.valueExpression&&it(o)===rt.RealWorldSize&&nt(o,t)!=null);return s.length===1&&(i=na(s[0],e)),{rotation:a,size:i}}function ra(t,e){let a=(t.axis||"heading")==="heading"&&t.rotationType==="arithmetic"?-1:1,i=t.field,r=e.fields&&e.fields.filter(n=>n.name===i),s=r&&r.length===1?r[0].type:"double",o={initial:0,current:0};return{field:i,fieldType:s,getDefault:()=>Promise.resolve(0),getValue:n=>(o.current=o.initial-a*n,Me((o.current+360)%360,s)),setInitialValue:n=>{o.initial=n,o.current=0},isUpdatingInteractively:!1,rotationType:t.rotationType??"geographic"}}function ia(t,e){switch(e){case"width":return t[0];case"depth":return t[1];case"height":return t[2];default:return t[2]||t[1]||t[0]}}function oa(t,e,a){return h(this,null,function*(){if(e==null)return 0;let{symbol:i}=at(e);if(i==null||i.type==="web-style"||i.type==="cim")return 0;let r=i.symbolLayers.at(0);if(!r)return 0;switch(r.type){case"icon":{let{computeIconLayerResourceSize:s}=yield import("./chunk-HA2YJC3H.js");return r.size||Math.min(H.icon,(yield s(r,H.icon))[0])||H.icon}case"text":return r.size||H.text;case"line":return r.size||H.line;case"object":{let{computeObjectLayerResourceSize:s}=yield import("./chunk-HA2YJC3H.js");return ia(yield s(r,t.scale/H.viewScaleSizeFactor),a)}case"path":return(r.width!=null?r.width:r.height)||t.scale/H.viewScaleSizeFactor;case"extrude":return r.size||t.scale/H.viewScaleSizeFactor;default:return 0}})}function na(t,e){let a=t.field,i=t.axis,r=e.fields&&e.fields.filter(l=>l.name===a),s=r&&r.length===1?r[0].type:"double",o={initial:0,current:0},n=Qe[t.valueUnit]??1,c;return c=t.valueRepresentation==="area"?l=>(l*n/2)**2*Math.PI:t.valueRepresentation==="radius"||t.valueRepresentation==="distance"?l=>l*n/2:l=>l*n,{field:a,fieldType:s,getDefault:(l,u)=>h(this,null,function*(){return Me(c(yield oa(u,l,i)),s)}),getValue:(l,u)=>(o.initial||(o.initial=u.pixelSizeAt(u.center)),o.current=o.initial*l,Me(o.current,s)),setInitialValue:l=>{o.initial=l,o.current=0},isUpdatingInteractively:!1,displayUnit:Sa(t.valueUnit),axis:t.axis}}function Me(t,e){switch(e){case"small-integer":case"integer":case"long":return Math.round(t);case"double":case"single":return t;default:return 0}}function sa(t){switch(t?.type){case"class-breaks":case"simple":case"unique-value":case"dot-density":case"dictionary":case"pie-chart":return!0;default:return!1}}function x(t,e,a){return h(this,null,function*(){let i=yield q(t,{useSourceLayer:!0,ignoreGraphicSymbol:!0,webStyleCache:e,scale:a});Xe(t.symbol,i)!=null&&(t.symbol=i)})}function Ce(t,e){if(!t||!e)throw new Error("no geometry type");if(t==="multipatch")return{tool:"mesh",createOptions:{mode:"hybrid"}};let a=new Map;a.set("circle",{mode:"freehand"}),a.set("rectangle",{mode:"freehand"});let i={mode:dt,optionsPerTool:a};if(j(e)){let r=e.defaultTool,s=R(e)?e.definition?.inputGeometryType??t:t;switch(r){case"freehand":case"stream-line":return{tool:s==="polyline"?"freehandPolyline":"freehandPolygon",createOptions:i};case"autocomplete-freehand-polygons":case"stream-polygon":return{tool:"freehandPolygon",createOptions:i};case"autocomplete-polygons":case"difference-polygon":case"create-structures":case"polygon":case"trace":return{tool:s==="polygon"?"polygon":"polyline",createOptions:i};case"circle":return a.get("circle").preserveAspectRatio=!0,{tool:"circle",createOptions:i};case"ellipse":return a.get("circle").preserveAspectRatio=!1,{tool:"circle",createOptions:i};case"create-points-along-line":case"multipoint":return{tool:"multipoint",createOptions:i};case"line":case"radial-line":case"right-angle-line":case"split":case"two-point-line":return{tool:"polyline",createOptions:i};case"rectangle":case"regular-polygon":case"right-angle-polygon":return{tool:"rectangle",createOptions:i};case"elevation-point-from-contour":case"elevation-point-from-dem":case"parcel-seed":case"point":case"point-and-rotation":case"point-at-end-of-line":return{tool:"point",createOptions:i}}}else{let r=e.drawingTool;if(r==="circle"||r==="ellipse")return a.get("circle").preserveAspectRatio=r==="circle",{tool:"circle",createOptions:i};if(r==="rectangle")return{tool:"rectangle",createOptions:i};if(r==="freehand")return{tool:t==="polygon"?"freehandPolygon":"freehandPolyline",createOptions:i}}return{tool:t,createOptions:i}}function xt(t,e,a){return h(this,null,function*(){let{creationInfo:i,fullTemplate:r}=e;if(!i)throw new E("No creation info provided.");let s=i.layer,o=$(r,i.attributeOverrides),{view:n}=t,c=n?.type==="2d";R(r)||B(r)||(yield Ht(t,s,o,a,c?n.scale:null));let{capabilities:l}=s;t.layer.elevationInfo=s.elevationInfo;let u=Ce(s.geometryType,r);t.defaultCreateOptions={graphicProperties:{attributes:o,sourceLayer:s},mode:u.createOptions.mode,optionsPerTool:u.createOptions.optionsPerTool,preserveAspectRatio:u.createOptions.preserveAspectRatio,hasZ:l.data.supportsZ,defaultZ:(c?l.editing.zDefault:null)??t.defaultCreateOptions.defaultZ},i.geometryToPlace==null?yield t.create(u.tool):yield t.place(i.geometryToPlace,{graphicProperties:{attributes:o,sourceLayer:s}})})}function Ot(t){return h(this,null,function*(){return C([yield la(t),yield ca(t)])})}function la(s){return h(this,arguments,function*({creationAttributes:t,data:e,sketchViewModel:a,view:i,webStyleCache:r}){let{creationInfo:o}=e,{fullTemplate:n}=e;if(!o||i?.type!=="2d"||R(n)||B(n))return null;let c=X(l=>Ht(a,o.layer,t,r,l));return M(()=>i.scale,l=>c(l))})}function ca(i){return h(this,arguments,function*({data:t,sketchViewModel:e,view:a}){let{templateExecutorInfo:r}=t;if(!r)return null;let s=e.activeComponent;if(!a||!wt(s))return aa().error(new E("Failed to set up template feedback.")),null;let o=new ce({effect:"saturate(0.6) opacity(0.8)",listMode:"hide",title:"Shared Template Feedback Graphics"});a.map?.add(o);let{executor:n,serviceLayersById:c}=r,l=a.theme?.accentColor??new Ye([255,165,0,1]);return C([Ze(()=>s,["cursor-update","vertex-add"],()=>{o.removeAll();let u=s.graphic?.geometry;if(!u||!ua(u))return;let d=n(u,"digitizing");if(!z(d))for(let f of d.edits){let p=c.get(f.id);if(p&&f.addFeatures&&f.addFeatures.length!==0){for(let y of p)if(!y.isTable)for(let w of f.addFeatures){let m=da(w,l);m&&o.add(m)}}}}),F(()=>{a.map.remove(o),o.destroy()})])})}function ua(t){switch(t.type){case"point":case"multipoint":return!0;case"polyline":return t.paths[0].length>1;case"polygon":{let e=t.rings[0];return De(e.at(0),e.at(-1))?e.length>2:e.length>1}default:return!1}}function da(t,e){let a=null;switch(t.geometry?.type){case"point":case"multipoint":a=new tt({angle:0,color:e,outline:new le({cap:"round",color:e,join:"round",miterLimit:1,style:"solid",width:1}),path:"undefined",size:8,style:"circle",xoffset:0,yoffset:0});break;case"polygon":a=new et({color:e,outline:new le({cap:"round",color:e,join:"round",miterLimit:1,style:"solid",width:3}),style:"none"});break;case"polyline":a=new le({cap:"round",color:e,join:"round",miterLimit:1,style:"solid",width:2});break;default:return null}return new L({geometry:t.geometry,symbol:a,attributes:_({},t.attributes)})}function Ee(t,e){return h(this,null,function*(){let a=yield It(e).load(),i=Je(t)?t.parent:t;return a.tablesAndLayersLookup.get(i)})}function Ut(t,e){return h(this,null,function*(){let a=yield Ee(t,e);if(!a)return new Map;let i=new Map;for(let r of a.layersAndTables)oe(i,r.layerId,()=>[]).push(r);return i})}function ke(t){let e=t.objectIdField,a=t.globalIdField??"";return{id:t.layerId,identifierFields:{objectIdField:e,globalIdField:a},addFeatures:[],deleteAttachments:[],addAttachments:[],deleteFeatures:[],updateFeatures:[]}}function Gt(t){let{edits:e,serviceInfo:a,view:i,findOriginalFeature:r}=t,s=pa(a.layersAndTables),o=a.layersAndTables.toArray(),{allEditData:n,editDataByLayerIdMap:c,editDataByIdMap:l}=ma(e,s,r),u=ha(n,fa(o,c),c);if(ga(n,u,i),u.length===0)return e;let d=Pt(u,{continueOnCircularDependency:!0}).map(m=>l.get(m)).filter(Re),f=new Map;for(let m of d)f.set(m.uniqueId,m);let p=[];for(let m of n)f.has(m.uniqueId)||p.push(m);let y=[],w=null;for(let m of d){let{layer:b}=m;switch(w==null?w=ke(b):w.id!==b.layerId&&(y.push(w),w=ke(b)),m.operationType){case"add":case"modify":w.addFeatures.push(m.after);break;case"delete":w.deleteFeatures.push(m.before)}}w!==null&&y.push(w);for(let m of p){let b=m.layer.layerId,v=y.find(g=>g.id===b)??ke(m.layer);switch(y.includes(v)||y.push(v),m.operationType){case"add":v.addFeatures.push(m.after);break;case"modify":v.updateFeatures.push(m.after);break;case"delete":v.deleteFeatures.push(m.before);break;case"deleteAttachment":v.deleteAttachments.push(m.attachmentId);break;case"addAttachment":v.addAttachments.push(m.attachment)}}for(let m of y)m.deleteAttachments!==void 0&&m.deleteAttachments.length===0&&delete m.deleteAttachments,m.addAttachments!==void 0&&m.addAttachments.length===0&&delete m.addAttachments;return y}function pa(t){let e=new Map;for(let a of t)e.set(a.layerId,a);return e}function fa(t,e){let a=new Map;for(let i of t)for(let r of i.relationships??[])if(a.set(Ve(i,r),""),e.has(r.relatedTableId)){let s=e.get(r.relatedTableId);if(s.length>0){for(let o of s[0].layer.relationships??[])if(o.id===r.id){a.set(Ve(i,r),o.keyField);break}}}return a}function ma(t,e,a){let i=new Map,r=[],s=new Map,o=1;for(let n of t){let c=[],l=e.get(n.id);if(!l)throw new E(`Failed to prepare applyEdits payload. Layer with id ${n.id} not found.`);for(let u of n.addFeatures??[])c.push({uniqueId:"T"+o++,operationType:"add",layer:l,after:u});for(let u of n.deleteFeatures??[])c.push({uniqueId:"T"+o++,operationType:"delete",before:u,layer:l});for(let u of n.deleteAttachments??[])c.push({uniqueId:"T"+o++,operationType:"deleteAttachment",attachmentId:u,layer:l});for(let u of n.addAttachments??[])c.push({uniqueId:"T"+o++,operationType:"addAttachment",attachment:u,layer:l});for(let u of n.updateFeatures??[])c.push({uniqueId:"T"+o++,operationType:"modify",before:a(u),after:u,layer:l});i.set(l.layerId,c);for(let u of c)r.push(u),s.set(u.uniqueId,u)}return{allEditData:r,editDataByIdMap:s,editDataByLayerIdMap:i}}function ha(t,e,a){let i=[];for(let r of t){let s=r.layer.relationships??[],{uniqueId:o}=r;for(let n of s){let c=n.keyField;if(n.role==="origin"){let l=a.get(n.relatedTableId);if(!l||l.length===0)continue;let u=Ve(r.layer,n),d=e.get(u);if(d===void 0||d==="")continue;switch(r.operationType){case"add":for(let f of l)f!==r&&(f.operationType!=="add"&&f.operationType!=="modify"||f.after.attributes[d]===r.after.attributes[c]&&i.push([o,f.uniqueId]));break;case"modify":if(r.before.attributes[c]!==r.after.attributes[c])for(let f of l){let p=f.uniqueId;f!==r&&(f.operationType==="delete"?f.before.attributes[d]===r.before.attributes[c]?i.push([p,o]):f.before.attributes[d]===r.after.attributes[c]&&i.push([o,p]):f.operationType==="add"?f.after.attributes[d]===r.after.attributes[c]?i.push([o,p]):f.after.attributes[d]===r.before.attributes[c]&&i.push([p,o]):f.operationType==="modify"&&(f.before.attributes[d]!==f.after.attributes[d]?f.after.attributes[d]===r.after.attributes[c]?i.push([o,p]):i.push([p,o]):i.push([o,p])))}break;case"delete":for(let f of l)f!==r&&(f.operationType!=="delete"&&f.operationType!=="modify"||f.before.attributes[d]===r.before.attributes[c]&&i.push([f.uniqueId,o]))}}}}return i}function Ve(t,e){return`${t.layerId}:${e.id}`}function ya(t,e){return!!(e?.map&&"utilityNetworks"in e.map&&e.map.utilityNetworks?.length&&e.map.utilityNetworks.some(a=>!(!a.loaded||!t.url?.startsWith(a.featureServiceUrl)||t.layerId!==a.networkSystemLayers.associationsTableId)))}function ga(t,e,a){let i=[];for(let s of t)ya(s.layer,a)&&i.push(s);if(i.length===0)return;let r=[];for(let s of i){let o=s.layer;switch(s.operationType){case"delete":r=[...he(s.before.attributes[o.fieldsIndex.get("fromglobalid").name],t),...he(s.before.attributes[o.fieldsIndex.get("toglobalid").name],t)];for(let n of r)e.push([s.uniqueId,n.uniqueId]);break;case"add":r=[...he(s.after.attributes[o.fieldsIndex.get("fromglobalid").name],t),...he(s.after.attributes[o.fieldsIndex.get("toglobalid").name],t)];for(let n of r)e.push([n.uniqueId,s.uniqueId])}}}function he(t,e){let a=[],i=e.filter(({layer:r})=>r.globalIdField!==""&&r.globalIdField!=null);for(let r of i){let s=r.layer.globalIdField;("before"in r&&r.before?.attributes[s]===t||"after"in r&&r.after?.attributes[s]===t)&&a.push(r)}return a}function $(t,e={}){return R(t)||B(t)?{}:ue(t)?_(_({},t.prototype.attributes),e):de(t)?_(_({},t.definition?.defaultValues),e):_({},e)}function Ht(t,e,a,i,r){return h(this,null,function*(){let s=new L({sourceLayer:e,attributes:a}),{rotation:o,size:n}=_e(s),c=yield q(s,{useSourceLayer:!0,webStyleCache:i,scale:r}),l=!1;for(let u of[n,o])u!=null&&a[u.field]==null&&(a[u.field]=yield u.getDefault(c,t.view),l=!0);switch(l&&(c=yield q(s,{useSourceLayer:!0,webStyleCache:i,scale:r})),c?.type){case"simple-fill":case"polygon-3d":t.polygonSymbol=c;break;case"simple-line":case"line-3d":t.polylineSymbol=c;break;case"simple-marker":case"picture-marker":case"point-3d":case"cim":t.pointSymbol=c;break;case"mesh-3d":t.meshSymbol=c}Dt(t.tooltipOptions,n,o)})}function Dt(t,e,a){t.visualVariables=e!=null||a!=null?{size:e!=null?{unit:e.displayUnit,axis:e.axis,valueType:e.fieldType}:null,rotation:a!=null?{valueType:a.fieldType,rotationType:a.rotationType??"geographic"}:null}:null}function Pe(t,e){return t?.find(a=>a.layer===e)}function xr(t,e,a,i){return h(this,null,function*(){switch(e.type){case"3d":return wa(t,e,a,i);case"2d":return ba(t,e,a,i)}})}function wa(t,e,a,i){return h(this,null,function*(){if(t.length===0)return[];let{updatable:r,graphicsByLayer:s}=yield a.async(()=>h(this,null,function*(){let{results:o}=yield Q(gt(e,a),i),n=new Map,c=u=>{let d=u.layer,f=n.get(d);if(!f){let p=new Array;return n.set(d,p),p}return f};Fe(o).forEach(({graphic:u})=>c(u).push(u));let l=t.filter(({capabilities:u,layer:d})=>u.update.enabled&&n.has(d));return l.length!==0&&a.stopPropagation(),{updatable:l,graphicsByLayer:n}}));return Q(Promise.allSettled(r.map(n=>h(this,[n],function*({layer:o}){let c=s.get(o),l=Rt(o);if(c.every(f=>ct(l,f)))return c;let u=[];for(let f of c){u.push(f.getObjectId());let p=Object.keys(f.attributes);He(l,p)}let d=o.createQuery();return d.returnGeometry=!1,d.objectIds=u,d.outFields=Ie(o.fieldsIndex,l),o.queryFeatures(d,{signal:i}).then(({features:f})=>f)}))),i)})}function ba(t,e,a,i){return h(this,null,function*(){if(t.length===0)return[];let{mapPoint:r}=a;if(r==null)return[];let s=null,o=yield a.async(()=>h(this,null,function*(){let{results:n}=yield Q(e.hitTest(a),i);if(n.length===0)return[];let c=new Set;s=Fe(n),s.forEach(({graphic:u})=>u&&c.add(u.layer));let l=t.filter(u=>c.has(u.layer)&&u.supportsUpdateWorkflow);return l.length>0&&a.stopPropagation(),l}));return Q(Promise.allSettled(o.map(c=>h(this,[c],function*({layer:n}){let l=n.createQuery();l.returnGeometry=!0,l.outFields=Rt(n);let u="renderer"in n?ft({renderer:n.renderer,pointerType:a.pointerType}):0;l.geometry=mt(r,u,e),l.outSpatialReference=e.spatialReference;let{features:d}=yield n.queryFeatures(l,{signal:i});return s?.forEach(({graphic:f})=>{f.layer!==n||d.some(p=>p.getObjectId()===f.getObjectId())||d.push(f)}),d}))),i)})}function Rt(t){return Ie(t.fieldsIndex,[t.objectIdField,lt({displayField:"displayField"in t?t.displayField:null,fields:t.fields})])}function Or(t,e,a){return h(this,null,function*(){let{sourceLayer:i}=t,r=i.createQuery();r.objectIds=[t.getAttribute(i.objectIdField)],r.outFields=["*"],r.returnM=i.capabilities.data.supportsM,r.returnZ=i.capabilities.data.supportsZ,i.type==="scene"&&i.infoFor3D!=null||(r.outSpatialReference=e);let s=yield i.queryFeatures(r,{signal:a});return K(a),s.features[0]})}function te(t){return h(this,null,function*(){let{graphic:e,sketchViewModel:a,sourceLayer:i,visualVariables:r}=t;yield Le(t);let s={multipleSelectionEnabled:!1};return i.geometryType==="point"&&(s.enableRotation=r.rotation!=null,s.enableScaling=r.size!=null),a.update(e,s)})}function Le(t){return h(this,null,function*(){let{graphic:e,sketchViewModel:a,sourceLayer:i,visualVariables:r,webStyleCache:s}=t,o=!1,{rotation:n,size:c}=r;if([n,c].forEach(l=>h(this,null,function*(){if(l==null)return;let u=e.getAttribute(l.field);if(u!=null)l.setInitialValue(u);else{let d=yield l.getDefault(e.symbol,a.view);l.setInitialValue(d),e.setAttribute(l.field,d),o=!0}})),o){let l=a.view?.type==="2d"?a.view.scale:null;yield x(e,s,l)}Dt(a.tooltipOptions,c,n),a.layer.elevationInfo=i.elevationInfo})}function va(t){return t==null||t.type!=="rotate-start"&&t.type!=="rotate"&&t.type!=="rotate-stop"?null:t}function Ia(t){return t==null||t.type!=="scale-start"&&t.type!=="scale"&&t.type!=="scale-stop"?null:t}function xe(t,e,a,i,r){return h(this,null,function*(){if(e.geometry==null||e.geometry?.type!=="point")return;let s=i.rotation,o=va(a.toolEventInfo);if(s!=null&&o!=null){let{field:l,getValue:u}=s;o.type==="rotate-stop"?(s.isUpdatingInteractively=!1,s.setInitialValue(e.getAttribute(l))):(s.isUpdatingInteractively=!0,e.setAttribute(l,u(o.angle,t)))}let n=i.size,c=Ia(a.toolEventInfo);if(n!=null&&c!=null){let{field:l,getValue:u}=n;c.type==="scale-stop"?(n.isUpdatingInteractively=!1,n.setInitialValue(e.getAttribute(l))):(n.isUpdatingInteractively=!0,e.setAttribute(l,u(c.xScale,t)))}yield x(e,r,t.type==="2d"?t.scale:null)})}function Ur(l){return h(this,arguments,function*({feature:t,featureClone:e,visualVariableAttributes:a,sketchViewModel:i,view:r,onUpdate:s,webStyleCache:o,addUpdatingPromise:n,addHandle:c}){yield x(e,o,r.type==="2d"?r.scale:null);let u=null;if(i?.view?.type==="2d"){let g=X(I=>x(e,o,I));u=M(()=>i?.view?.scale,I=>g(I))}let d=e.sourceLayer,f=Ae(r,d);yield te({graphic:e,sketchViewModel:i,sourceLayer:d,visualVariables:a,webStyleCache:o});let p=null;f.then(g=>p=g).catch(()=>{});let y=a.size,w=a.rotation,m=M(()=>t.attributes,g=>h(this,null,function*(){let I=!1;for(let V in g){let A=g[V];A!==e.getAttribute(V)&&(e.setAttribute(V,A),y==null||y.isUpdatingInteractively||y.field!==V||y.setInitialValue(A),w==null||w.isUpdatingInteractively||w.field!==V||w.setInitialValue(A),(p==null||p.requiredFields.includes(V))&&(I=!0))}I&&(yield x(e,o,r.type==="2d"?r.scale:null))})),b=i.on("update",g=>h(this,null,function*(){let I=g.graphics[0],V={graphic:I,sketchViewModel:i,sourceLayer:d,visualVariables:a,webStyleCache:o};if(g.state==="complete"){if(r.activeTool===null)return te(V);let A=new AbortController,D=ie(A);return c(D),n(P(()=>r.activeTool===null,A.signal).then(()=>(A.abort(),te(V))))}yield xe(r,I,g,a,o),s(Lt(I),g)})),v=i.on(["undo","redo"],g=>h(this,null,function*(){s(Lt(g.graphics[0]),g)}));return C([v,b,F(()=>i.cancel()),m,u])})}function Gr(t,e,a){return h(this,null,function*(){let i=t.view;t.layer.add(a);let r=e.sourceLayer,s=e.layer,o=e.getAttribute(s.objectIdField),n=null;function c(l){n?.abort(),n=je(u=>h(this,null,function*(){let d=yield Ae(i,r);K(u),d.setVisibility?.(o,l)}))}return yield Ta(i,a),c(!1),C([Fa(i,a,l=>c(!l)),F(()=>h(this,null,function*(){c(!0);try{let l=yield Ae(i,r);yield P(()=>!l.updating)}finally{t.layer.remove(a)}}))])})}function Fa(t,e,a){if(t.type==="3d"){let i=new Te({graphic:e});return C([t.trackGraphicState(i),M(()=>i.displaying,a)])}return M(()=>e.visible,a)}function Ta(t,e){return h(this,null,function*(){if(t.type==="3d"){let a=new Te({graphic:e}),i=t.trackGraphicState(a);yield P(()=>a.displaying||a.error),i.remove()}else yield P(()=>e.visible)})}var H={icon:se(24),text:se(12),line:se(1),viewScaleSizeFactor:100};function Nt(t,e,a){let i=!1;return t.filter(r=>!!i||(i=r===e,i)).map(r=>a[r]())}function zt(t,e){t.viewModel.syncFeatureTemplates();let a=t.creationInfo;if(e[0].id==="awaiting-feature-creation-info"&&a){let i=a.layer,r=t.viewModel.getTemplatesForLayer(i);r.length===1&&i.type!=="scene"&&(a.template=r[0],e.shift())}return e}function Sa(t){return t==="unknown"?null:t}function Wt(t){t.filesEnabled=!0,t.mode="view",t.capabilities={editing:!0,operations:{add:!0,update:!0,delete:!0}}}var qt=t=>/-stop/.test(t)||/vertex-/.test(t),Ae=(t,e)=>{let a=e.type==="subtype-sublayer"?e.parent:e;return t.whenLayerView(a)};function Hr(t){return"createInteractiveEditSession"in t}function Lt(t){let e=t.geometry;if(e?.type==="mesh"){let a=t.cloneShallow();return a.attributes=Ne(t.attributes),a.geometry=e.cloneShallow(),a.geometry.transform=e.transform?.clone()??null,a}return t.clone()}function ye(t){let e=t.cursor;return t.cursor="progress",F(()=>t.cursor=e)}function jt(t,e){return h(this,null,function*(){let{template:a}=t;if(a==null)return null;if(ee(a))return a.load();if(j(a)){let i=kt(e,{makeSharedTemplateFromJSON:ka}),r=yield i.getTemplates({templateIds:[a.templateId],featureService:a.featureService});if(r.length===0)throw new E("editor:failed-to-load-template","Unable to load the provided template");return r[0].load()}return a})}function Oe(t){for(let e of t){let{destinationGraphic:a,destinationField:i,sourceGraphic:r,sourceField:s}=e;a.setAttribute(i,r.getAttribute(s))}}function Bt(t){let e=t.templateExecutorInfo?.completionResults;return e?.length?(e.forEach(a=>Oe(a.relationships)),e.flatMap(a=>a.edits)):null}var ka=t=>Mt.fromJSON(t);function Zt(s){return h(this,arguments,function*({view:t,data:e,signal:a,next:i,cancel:r}){let{creationInfo:o}=e;if(!o)return F();if(!O(o))return F();let{layer:n}=o,c=o.geometryToPlace!=null;if(o.geometryToPlace=null,c)return r(),F();let{Upload:l}=yield import("./chunk-AXIJOPOG.js");K(a);let u=new l;e.upload=u;let d=null,f=()=>d?.remove(),p=C([M(()=>u.state,y=>{switch(y){case"default":case"error":f();break;case"pending":f(),d=ye(t);break;case"success":{o.maxFeatures=1;let{result:w}=u;w?.type==="georeferenced"||w?.type==="georeferenced-reprojected"?(o.geometryToPlace=w.mesh,o.initialFeature=new L({attributes:$(e.fullTemplate,o.attributeOverrides),geometry:w.mesh,sourceLayer:n}),t.goTo(o.initialFeature,{animate:!1}).catch(We)):o.geometryToPlace=w?.mesh,f(),i();break}}}),F(()=>{u.cancel(),f()})]);return u.uploadTo(n),p})}function O(t){return t?.layer?.type==="scene"}var we,Ma=Symbol(),ae=Symbol(),ge=Symbol(),$t=Symbol(),Va={point:["point"],multipoint:["multipoint"],polygon:["polygon","freehandPolygon","rectangle","circle"],polyline:["polyline","freehandPolyline"],mesh:[],multipatch:[]},T=we=class t extends Vt{constructor(e){super(e),this.type="create-features",this.createFeatureState="create-new",this.data=void 0,this.isNested=!1,this._getDrawMeshHelpMessage=void 0,this._webStyleCache=new Map,this._featureFormHandle=null,this._visualVariableAttributes={rotation:null,size:null},this._featureFormViewModel=new vt,this._sketchViewModel=null,this._attachmentFileInfos=new Map,this._isActive=!0}initialize(){this.isNested&&(this._isActive=!1),this._initializeSketchViewModel()}destroy(){this._sketchViewModel.destroy()}get featureFormViewModel(){return this._featureFormViewModel}get hasPendingEdits(){if(this.pendingFeatures.some(o=>!!this.data.getEditsForPendingFeature(o)?.modified))return!0;let{creationInfo:e,upload:a}=this.data,i=this._sketchViewModel,{activeComponent:r}=i,s=i.createGraphic?.geometry?.type;return!(s!=="polyline"&&s!=="polygon"&&s!=="multipoint"||r?.type!=="draw-2d"&&r?.type!=="draw-3d")&&r.drawOperation.committedVertices.length>0||!(!a||a.state!=="pending"&&a.state!=="success")||!!e?.geometryToPlace}get hasPreviousStep(){return this._stepIndex>0||this.createFeatureState==="update-pending"&&!!this.data.selectedPendingFeature&&!this.parent&&!O(this.data.creationInfo)}get helpMessage(){let{creationInfo:e,viewModel:a}=this.data;if(this.stepId!=="creating-features"||!e)return;let i=e.layer.geometryType,r=this._sketchViewModel.createGraphic;if(i==="mesh"){this._getDrawMeshHelpMessage||import("./chunk-5RVVICOK.js").then(c=>{this._getDrawMeshHelpMessage=c.getDrawMeshHelpMessage});let{view:n}=a;return n?.type==="3d"?this._getDrawMeshHelpMessage?.(r,n):void 0}let s=this._sketchViewModel.activeCreateToolDrawMode,o=this._sketchViewModel.activeTool;return ht(o==="rectangle"?"rectangle":o==="circle"?"circle":i,r?.geometry,s)}get layer(){return this.data.creationInfo?.layer}get numPendingFeatures(){return this.pendingFeatures.length}get numPendingFeaturesExcludingHidden(){return this.pendingFeatures.filter(e=>this.data.isDisplayable(e)).length}get parent(){return this.data.parent}get parentLayer(){return this.parent?.data.editorItem.layer}get pendingFeatures(){return this.data.pendingFeatures}get keyboardCancellationEnabled(){return this.numPendingFeatures===0}get reliesOnOwnerAdminPrivileges(){return this.data.editorItem?.capabilities.create.reliesOnOwnerAdminPrivileges??!1}get shouldShowAttachments(){return(this.data.selectedPendingFeature&&this.data.editorItem?.capabilities.create.attachments.enabled)??!1}get shouldAllowAttachmentEditing(){return this.shouldShowAttachments}get sketchViewModel(){return this._sketchViewModel}get test(){}get availableCreateTools(){let e=this.data.creationInfo?.layer.geometryType,a=this.data.viewModel.view;if(!e)return[];if(this.data.creationInfo?.maxFeatures&&this.data.creationInfo.maxFeatures<=this.numPendingFeatures)return[];if(j(this.data.fullTemplate)){let{tool:i}=Ce(e,this.data.fullTemplate);return[i]}return a?.type!=="2d"&&e==="multipoint"?[]:[...Va[e]]}get _attachmentsActive(){let e=this.data.viewModel.attachmentsViewModel.mode,a=this.stepId;return this.shouldShowAttachments&&(e==="add"||e==="edit"||a==="adding-attachment"||a==="editing-attachment")}enter(){return h(this,null,function*(){this._isActive=!0,this.stepId!=="awaiting-feature-creation-info"&&(yield this._updatingHandles.addPromise(this._setUpCreatingFeaturesStep()))})}exit(){this._isActive=!1,this.removeHandles([ge])}updatePendingFeature(e){return h(this,null,function*(){if(e!==this.data.selectedPendingFeature)return this._sketchViewModel.cancel(),this._startUpdating({feature:e})})}start(){return h(this,null,function*(){return yield be(t.prototype,this,"start").call(this),ne(this.data.creationInfo?.layer)?null:{enter:()=>h(this,null,function*(){}),exit:()=>h(this,null,function*(){}),viewModel:this._sketchViewModel}})}save(){return h(this,null,function*(){let{featureFormViewModel:e}=this;if(e.pendingSubtypeChoice)return;e.submit(),this._stashValidationState();let a=this.data.selectedPendingFeature,i=this._hasValidationErrors(a)?a:this.data.pendingFeatures.find(r=>this._hasValidationErrors(r));return i?(yield this._startUpdating({feature:i}),void e?.submit()):be(t.prototype,this,"save").call(this)})}back(e){return this.createFeatureState!=="update-pending"||!this.data.selectedPendingFeature||O(this.data.creationInfo)||this._attachmentsActive||this.parent?super.back(e):this._clearSelectedFeature()}previous(e){return this.createFeatureState!=="update-pending"||!this.data.selectedPendingFeature||O(this.data.creationInfo)||this._attachmentsActive?super.previous(e):this._clearSelectedFeature()}cancelFeature(e){this.data.isSharedTemplateWorkflow?N.getLogger(this).warn("Cannot cancel individual features created by shared templates."):(this.data.removePendingFeature(e),this.sketchViewModel.layer.graphics.remove(e))}static create(e){let{addAttachmentsCallback:a,applyEditsCallback:i,applyEditsFeatureServiceCallback:r,isNested:s,creationInfo:o,parent:n,snappingManager:c,startAt:l,viewModel:u}=e,d=e.sketchOptions??new yt,f=o?.layer,p=f?u.findEditorItemForLayer(f):void 0,y=new we({data:new St({creationInfo:o,editorItem:p,parent:n,sketchOptions:d,snappingManager:c,viewModel:u}),isNested:s,onCommit:w=>h(this,null,function*(){let{creationInfo:m}=w;if(!m)return;y._sketchViewModel.cancel();let b=w.pendingFeatures.toArray(),{layer:v}=m,g=v.capabilities?.editing.supportsGlobalId&&"globalIdField"in v,I=y._attachmentFileInfos,{fullTemplate:V}=w,A=Bt(y.data),D=ee(V)&&A;if(g){if(Ea(b),D){let G=La(A,I),Ue=yield Ee(v,u.view);Ue&&(G=Gt({edits:G,serviceInfo:Ue,view:u.view,findOriginalFeature:Ge=>w.getEditsForPendingFeature(Ge)?.initialFeature??Ge})),yield r(V.featureService,G,{globalIdUsed:!0,gdbVersion:V.layer.gdbVersion??void 0})}else{let G=Pa(b,I);yield i(v,G,{globalIdUsed:!0})}return}let U=D?yield r(V.featureService,A,{gdbVersion:V.layer.gdbVersion??void 0}):[yield i(v,{addFeatures:b})];U&&I.size>0&&(yield Promise.all(U.map(G=>{if(G?.addFeatureResults)return a(v,Ca(b,G.addFeatureResults,v,I))})))})});return y._set("steps",this._createWorkflowSteps(y,l)),y}_fadeExistingFeatures(e){if("effect"in e){let i=e.effect;return e.effect="saturate(0.6) opacity(0.8)",F(()=>e.effect=i)}let a=e.opacity;return e.opacity=.7,F(()=>e.opacity=a)}_initializeFullTemplateAndExecutorInfo(e){return h(this,null,function*(){let{creationInfo:a}=e,{view:i}=e.viewModel;if(!a||!i)return null;let r=yield jt(a,i);if(e.fullTemplate=r,r&&ee(r)){let s={completionResults:[],executor:yield Ct(r),serviceLayersById:yield Ut(a.layer,i)};e.templateExecutorInfo=s}return r})}_startCreating(){return h(this,null,function*(){this.removeHandles(ae);let{data:e}=this;if(!e.creationInfo)return;let a=this.data.creationInfo?.maxFeatures;if(a&&this.numPendingFeatures>=a)return this.sketchViewModel.cancel(),void(this.numPendingFeatures&&(yield this._startUpdating({feature:this.pendingFeatures.at(-1)})));this.createFeatureState="create-new",yield xt(this._sketchViewModel,e,this._webStyleCache)})}_clearSelectedFeature(){return h(this,null,function*(){let e=this._featureFormViewModel.pendingSubtypeChoice;e&&(e.resolve("undo"),yield e.promise),this._stashValidationState(),this.sketchViewModel.cancel(),this.data.selectedPendingFeature=null,this._featureFormHandle=re(this._featureFormHandle),this._featureFormViewModel.feature=null;let a=this.data.viewModel.attachmentsViewModel;a.mode!=="add"&&a.mode!=="edit"||this.data.viewModel.activeWorkflow?.previous()})}_stashValidationState(){let e=this._featureFormViewModel.feature,a=e&&this.data.getEditsForPendingFeature(e);a&&(a.submittable=this._featureFormViewModel.submittable)}_selectFeatureForUpdate(i){return h(this,arguments,function*({feature:e,initialFeature:a=e}){this._stashValidationState();let{data:r,pendingFeatures:s,_webStyleCache:o}=this;s.includes(e)||r.addPendingFeature(e,a),r.selectedPendingFeature=e;let{_featureFormViewModel:n,_sketchViewModel:c}=this,{creationInfo:l,viewModel:u}=r,{attachmentsViewModel:d,layerInfos:f,view:p}=u;if(!p||!l)return;re(this._featureFormHandle);let y=e.sourceLayer,w=Pe(f,y),m=w?.formTemplate,b=p.spatialReference;n.set({arcadeEditType:"INSERT",feature:e,formTemplate:m,spatialReference:b,map:p.map}),d.mode!=="add"&&d.mode!=="edit"||u.activeWorkflow?.previous(),d.graphic=e,d.fileInfos.removeAll(),d.mode="view",(this._attachmentFileInfos.get(e)||[]).forEach(({file:g,form:I})=>d.addFile(g,I)),yield x(e,o,p.type==="2d"?p.scale:null);let v=r.getEditsForPendingFeature(e);this._featureFormHandle=C([n.on("value-change",()=>h(this,null,function*(){v?.updateAttributes(n.getValues()),yield x(e,o,p.type==="2d"?p.scale:null)})),c.on(["update","undo","redo"],g=>{(g.type==="undo"||g.type==="redo"||g.type==="update"&&g.toolEventInfo!=null&&qt(g.toolEventInfo.type))&&n.notifyFeatureGeometryChanged()}),M(()=>n.feature?.sourceLayer,g=>e.sourceLayer=g),M(()=>[n.feature,n.submittable],()=>this._stashValidationState())]),this.createFeatureState="update-pending"})}_startUpdating(i){return h(this,arguments,function*({feature:e,initialFeature:a=e}){yield this._selectFeatureForUpdate({feature:e,initialFeature:a});let{_sketchViewModel:r,data:s}=this,{creationInfo:o,viewModel:n}=s,{view:c}=n;if(!c||!o)return;let l=e.sourceLayer??o.layer;return ne(l)?void 0:(this._visualVariableAttributes=_e(e),te({graphic:e,sketchViewModel:r,sourceLayer:l,visualVariables:this._visualVariableAttributes,webStyleCache:this._webStyleCache}))})}static _createWorkflowSteps(e,a="awaiting-feature-creation-info"){let{data:i}=e,r=Nt(["awaiting-feature-creation-info","creating-features","adding-attachment","editing-attachment"],a,{"awaiting-feature-creation-info":()=>({id:"awaiting-feature-creation-info",setUp(){return h(this,null,function*(){let{creationInfo:o,viewModel:n}=i,{view:c}=n;c&&(O(o)?e.addHandles(yield Zt({view:c,data:i,next:()=>e.next(),cancel:()=>n.cancelWorkflow({warnIfNoWorkflow:!1})}),this.id):(i.parent&&o&&e.addHandles(n.restrictFeatureTemplatesViewModelToLayer(o.layer),this.id),e.addHandles(n.featureTemplatesViewModel.on("select",({item:l})=>{l&&(i.creationInfo=J(_({},i.creationInfo),{layer:l.layer,template:l.template}),e.next())}),this.id)))})},tearDown(){return h(this,null,function*(){e.removeHandles(this.id)})}}),"creating-features":()=>({id:"creating-features",setUp(){return h(this,null,function*(){e._isActive&&(yield e._setUpCreatingFeaturesStep())})},tearDown(o){return h(this,null,function*(){let{viewModel:n}=i;o.canceled&&(e.removeHandles([ge,Ma,ae,$t]),n.attachmentsViewModel.fileInfos.removeAll(),e._attachmentFileInfos.clear())})}}),"adding-attachment":()=>({id:"adding-attachment",parent:"creating-features",setUp(){return h(this,null,function*(){})},tearDown(){return h(this,null,function*(){let{attachmentsViewModel:o}=i.viewModel,{graphic:n,fileInfos:c}=o;e._attachmentFileInfos.set(n,c.toArray()),o.mode="view"})}}),"editing-attachment":()=>({id:"editing-attachment",parent:"creating-features",setUp(){return h(this,null,function*(){})},tearDown(){return h(this,null,function*(){let{attachmentsViewModel:o}=i.viewModel,{graphic:n,fileInfos:c}=o;e._attachmentFileInfos.set(n,c.toArray()),o.mode="view"})}})});return zt(i,r)}static _configureSketchViewModel(e){let{data:a}=e,i=e._webStyleCache,{creationInfo:r,viewModel:s}=a,{view:o}=s,n=e._sketchViewModel,c=[];if(!o)return F();if(o.type==="2d"){r&&c.push(e._fadeExistingFeatures(r.layer));let m=X((b,v)=>Promise.all(b.map(g=>x(g,i,v))));c.push(M(()=>o.scale,b=>m(n.layer.graphics,b)))}let l=$(a.fullTemplate,r?.attributeOverrides),u=M(()=>n.createGraphic,m=>{m&&!e.hasHandles(ae)&&e._updatingHandles.addPromise(Ot({creationAttributes:l,data:a,sketchViewModel:n,view:o,webStyleCache:i}).then(b=>e.addHandles(b,ae)))}),d=m=>h(this,null,function*(){if(m.state!=="cancel"&&m.state!=="complete"||e.removeHandles(ae),m.state==="cancel"&&o.activeTool!==null&&o.activeTool!==e.sketchViewModel.activeComponent&&(yield e._waitForActiveToolCleared(),yield e._startCreating()),m.state==="complete"&&m.graphic){let b=yield e._processEdits(m.graphic,{scale:o.type==="2d"?o.scale:null,useSourceLayer:!0,webStyleCache:e._webStyleCache});b&&(yield e._waitForActiveToolCleared(),yield e._startUpdating({feature:b}))}}),f=m=>h(this,null,function*(){let{attachmentsViewModel:b}=s,{_featureFormViewModel:v}=e;if(m.graphics.length>1)return void(yield e._clearSelectedFeature());let g=m.graphics[0];if(m.state==="complete"){let{submittable:I}=v;if(e.numPendingFeatures!==r?.maxFeatures&&I||v.submit(),yield e._clearSelectedFeature(),b.mode!=="add"&&b.mode!=="edit"||s.activeWorkflow?.previous(),!m.aborted&&o.activeTool===e.sketchViewModel.activeComponent&&(yield e.sketchViewModel.wait(),e.sketchViewModel.state==="ready"&&e.data.creationInfo?.layer.geometryType!=="mesh"))return e._startCreating()}else{if(m.state==="start")return g.sourceLayer??=a.creationInfo?.layer,yield Le({sketchViewModel:n,graphic:g,visualVariables:e._visualVariableAttributes,webStyleCache:e._webStyleCache,sourceLayer:g.sourceLayer}),e._selectFeatureForUpdate({feature:g});if(m.state==="active"){yield e.updatePendingFeature(g);let I=e._visualVariableAttributes;yield xe(o,g,m,I,e._webStyleCache);let V=g.attributes,{rotation:A,size:D}=I;if(A!=null){let{field:U}=A;v.setValue(U,V[U])}if(D!=null){let{field:U}=D;v.setValue(U,V[U])}}}}),p=m=>h(this,null,function*(){if(m.graphics.forEach(b=>{a.removePendingFeature(b)}),!O(a.creationInfo))return e._startCreating()}),y=()=>h(this,null,function*(){if(O(a.creationInfo))try{yield e.data.viewModel.back()}catch{}return e._startCreating()});c.push(u,n.on("create",m=>e._updatingHandles.addPromise(d(m))),n.on("update",m=>e._updatingHandles.addPromise(f(m))),n.on("delete",m=>e._updatingHandles.addPromise(p(m))),Be(()=>!e.numPendingFeatures,()=>e._updatingHandles.addPromise(y())),F(()=>{n.cancel()}),Aa(n,a),..._a(a));let w=C(c);return n.addHandles(w),w}_initializeSketchViewModel(){let{data:e}=this,{view:a}=e.viewModel,i=new ce({elevationInfo:e.creationInfo?.layer.elevationInfo,internal:!0,listMode:"hide",title:"createFeaturesWorkflow-internal"}),r=new bt({layer:i,creationMode:"single",sketchOptions:e.sketchOptions,snappingManager:e.snappingManager,updateOnGraphicClick:!1,defaultUpdateOptions:{multipleSelectionEnabled:!1},view:a});this._sketchViewModel=r,a?.map.add(i),this.addHandles([F(()=>{a?.destroyed||a?.map.remove(i),i.destroy()}),M(()=>this.numPendingFeatures>0,s=>this._sketchViewModel.updateOnGraphicClick=s,ve)])}_hasValidationErrors(e){return!!e&&(!this.data.isSubmittable(e)||!!this._featureFormViewModel.validateContingencyConstraints(e.attributes,{includeIncompleteViolations:!0})?.length)}_processEdits(e,a){return h(this,null,function*(){let{data:i}=this,{layerInfos:r,view:s}=i.viewModel,o=this._featureFormViewModel,{templateExecutorInfo:n}=i;if(!n){let f=e.clone();return f.geometry=null,i.addPendingFeature(e,f),e}let c=this.sketchViewModel.layer;c.remove(e);let{executor:l}=n,u=l(e.geometry,"completion"),d=z(u)?yield u:u;n.completionResults.push(d),Oe(d.relationships),o.arcadeEditType="INSERT",o.map=s?.map,o.spatialReference=s?.spatialReference,d.primary&&i.creationInfo?.attributeOverrides&&(d.primary.graphic.attributes=_(_({},d.primary.graphic.attributes),i.creationInfo.attributeOverrides));for(let f of d.edits){let p=null;if(f.addFeatures)for(let y of f.addFeatures){let w=y.clone();w.geometry=null,y.geometry!=null&&(y.symbol=yield q(y,a),c.add(y));let m=i.addPendingFeature(y,w,{isAssociation:!!d.associationGraphics?.has(y)});y.sourceLayer!==p?.layer&&(p=Pe(r,y.sourceLayer)),o.feature=y,o.formTemplate=p?.formTemplate,yield P(()=>!o.updating),m.submittable=o.submittable}}return o.feature=null,yield P(()=>!o.updating),d.edits.reduce((f,p)=>f+(p.addFeatures?.length??0),0)>1?null:d.primary?.graphic})}_setUpCreatingFeaturesStep(){return h(this,null,function*(){if(this.hasHandles(ge))return;let{data:e,sketchViewModel:a}=this,{creationInfo:i,viewModel:r}=e,{attachmentsViewModel:s,view:o}=r;if(!o||!i?.layer)throw new E("missing-parameters","CreateFeaturesWorkflow requires a view and creationInfo.");let{initialFeature:n,layer:c}=i,l=[],u=[];this._featureFormHandle=re(this._featureFormHandle),this._visualVariableAttributes={rotation:null,size:null},e.editorItem=r.findEditorItemForLayer(i.layer),i.template&&(e.fullTemplate==null&&(yield this._initializeFullTemplateAndExecutorInfo(e)),u.push(F(()=>{e.templateExecutorInfo&&(e.templateExecutorInfo.completionResults=[])}))),a.allowDeleteKey=!e.isSharedTemplateWorkflow,Wt(s),l.push(M(()=>s.mode,g=>{switch(g){case"add":this.go("adding-attachment");break;case"edit":this.go("editing-attachment")}}));let d=ye(o);l.push(d);let f=ne(i.layer),{template:p}=i,y=!p||ue(p)||j(p)&&p.type==="feature",w=f&&y;try{if(w){let g=n??new L({attributes:$(e.fullTemplate,i.attributeOverrides),sourceLayer:c}),I=yield this._processEdits(g);I&&(yield this._startUpdating({feature:I}))}else l.push(we._configureSketchViewModel(this)),n?(a.layer.add(n),yield this._startUpdating({feature:n})):yield this._startCreating()}finally{d.remove()}let m=F(()=>{for(let g of e.pendingFeatures)a.layer.remove(g),e.removePendingFeature(g)}),b=M(()=>o?.timeZone,g=>{this._featureFormViewModel.timeZone=g,this.data.timeZone=g},ve),v=F(()=>{O(i)&&r.cancelWorkflow({warnIfNoWorkflow:!1})});this._featureFormHandle&&l.push(this._featureFormHandle),this.addHandles(l,this._handleKeys.beforeCommit),this.addHandles(u,this._handleKeys.afterCommit),this.addHandles([F(()=>s.fileInfos.removeAll()),C(l),C(u),v,m,b],ge)})}_waitForActiveToolCleared(){return h(this,null,function*(){let e=this.data.viewModel.view;if(e?.activeTool==null)return;let a=new AbortController;this.addHandles(ie(a),$t),yield P(()=>e?.activeTool==null,a.signal),a.abort()})}};function Aa(t,e){let a=null,i=()=>t.snappingOptions.featureSources,r=()=>(a=new pt({layer:t.layer}),i().add(a),a),s=()=>{a!=null&&(i().remove(a),a=ze(a))};return C([M(()=>{let o=e.creationInfo?.layer,n=i().find(c=>c.layer===o);return{hasFeatureLayerSource:!!n,enabled:n?.enabled??!1}},({hasFeatureLayerSource:o,enabled:n})=>{if(!o)return s();a??=r(),a.enabled=n},$e),F(s)])}function _a(t){let e=t.viewModel.view;if(!e)return[];let a=[];if(e.type==="3d"){let r=new Se({view:e});a.push(M(()=>t.selectedPendingFeature,(s,o)=>{r.remove(s),r.add(o)}),F(()=>r.destroy()))}let i=new Se({view:e,highlightName:st});return a.push(M(()=>t.temporaryHighlightFeature,r=>{i.removeAll(),i.add(r)}),F(()=>i.destroy())),a}function Ca(t,e,a,i){let r=[];return e.forEach((s,o)=>{if(!s.error){let n=t[o],c=i.get(n)||[];n.attributes[a.objectIdField]=s.objectId,c.forEach(({form:l})=>r.push({feature:n,attachment:l}))}}),r}function Ea(t){for(let e of t){let{sourceLayer:a}=e;a&&"globalIdField"in a&&a.globalIdField!=null&&(e.attributes[a.globalIdField]??=W())}}function Pa(t,e){let a=[];if(!e||e.size===0)return{addFeatures:t};for(let[i,r]of e)for(let{file:s}of r)a.push({feature:i,attachment:{globalId:W(),data:s}});return a.length?{addFeatures:t,addAttachments:a}:{addFeatures:t}}function La(t,e){return t.map(a=>{let{addFeatures:i}=a;if(!i||i.length===0)return a;let r=[];for(let s of i){let o=e.get(s);if(o)for(let{file:n}of o)r.push({feature:s,attachment:{globalId:W(),data:n}})}return r.length?J(_({},a),{addAttachments:r}):a})}S([k()],T.prototype,"createFeatureState",void 0),S([k()],T.prototype,"data",void 0),S([k({constructOnly:!0})],T.prototype,"isNested",void 0),S([k()],T.prototype,"featureFormViewModel",null),S([k()],T.prototype,"hasPendingEdits",null),S([k()],T.prototype,"hasPreviousStep",null),S([k()],T.prototype,"_getDrawMeshHelpMessage",void 0),S([k()],T.prototype,"helpMessage",null),S([k()],T.prototype,"layer",null),S([k()],T.prototype,"parent",null),S([k()],T.prototype,"parentLayer",null),S([k()],T.prototype,"keyboardCancellationEnabled",null),S([k()],T.prototype,"reliesOnOwnerAdminPrivileges",null),S([k()],T.prototype,"shouldShowAttachments",null),S([k()],T.prototype,"shouldAllowAttachmentEditing",null),S([k()],T.prototype,"sketchViewModel",null),S([k()],T.prototype,"availableCreateTools",null),S([k()],T.prototype,"_attachmentsActive",null),T=we=S([qe("esri.widgets.Editor.CreateFeaturesWorkflow")],T);var Ti=T;export{Lr as a,_e as b,x as c,xr as d,Or as e,Ur as f,Gr as g,Nt as h,qt as i,Ae as j,Hr as k,Lt as l,O as m,Ti as n};
