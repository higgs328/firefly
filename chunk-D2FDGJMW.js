import{a as A}from"./chunk-WT37QSNF.js";import{a as B}from"./chunk-WYXAYMB7.js";import{a as F}from"./chunk-IBSCSNYA.js";import{f as T}from"./chunk-T3LMCJNQ.js";import{a as H,c as U,d as k,e as z}from"./chunk-BWSUZDSV.js";import{c as S}from"./chunk-5H7NDIGP.js";import{b as $}from"./chunk-ZYYN4NWF.js";import{c as V,d as q,e as N}from"./chunk-D6N4VI5S.js";import{b as W}from"./chunk-HH3C3QEN.js";import{a as g}from"./chunk-FSW536RM.js";import{d as O}from"./chunk-JBAMJB5J.js";import{a as h}from"./chunk-YEXMIDOT.js";import{a as P}from"./chunk-QCZ3ZIGQ.js";import{a as R}from"./chunk-ONYJLWAD.js";import{a as D}from"./chunk-S52JRLJC.js";import{a as E}from"./chunk-RWCIDBNQ.js";import{g as L}from"./chunk-PTZYZULI.js";import{j as _}from"./chunk-BOVYXYHK.js";import{a as c}from"./chunk-QGVBCWUY.js";import{H as C}from"./chunk-MYO4NP2N.js";import{e as f}from"./chunk-NFIPKH6V.js";import{l as u}from"./chunk-5QEXLALV.js";import{f as M,p as x}from"./chunk-4PTIEWMT.js";import{a as G}from"./chunk-TG2UTNEO.js";import{a as I}from"./chunk-QBWJMFH5.js";import{f as d}from"./chunk-VTHXE323.js";var p=class extends S{constructor(e){super(e),this._glMaterials=null,this._produces=new Map,this._renderGeometries=new Map,this._vaoCache=null,this._drawParameters=new A,this._bufferWriter=null}get produces(){return this._produces}get numFeatures(){let r=0;return this._renderGeometries.forEach(t=>r+=t.numElements/6),r}get usedMemory(){let e=0;return this._renderGeometries.forEach(r=>{e+=r.vao.usedMemory}),e}initialize(){this._bufferWriter=this.material.createBufferWriter(),this.material.produces.forEach((e,r)=>{this._produces.set(r,t=>t!==h.Highlight&&t!==h.ShadowHighlight&&e(t))})}destroy(){this._glMaterials.dispose();let e=this._renderGeometries.keys();for(let r of e)this.removeRenderGeometry(r)}acquireTechniques(e){let r=this.material;if(!r.shouldRender(e))return null;let{output:t,bind:s}=e;return!r.produces.get(s.slot)?.(t)||t===h.Highlight||t===h.ShadowHighlight?null:this._glMaterials.load(e.rctx,s.slot,t)?.beginSlot(s)}render(e,r){let t=this._renderGeometries;if(t.size===0)return;let{bind:s}=e,a=s.slot===g.OCCLUDER_MATERIAL||s.slot===g.TRANSPARENT_OCCLUDER_MATERIAL?s.slot:null,i=e.rctx;i.runAppleAmdDriverHelper(),i.bindTechnique(r,s,this.material.parameters);let o=r.program;for(let[l,n]of t)this._drawParameters.origin=n.localOrigin,o.bindDraw(s,this.material.parameters,this._drawParameters),r.ensureAttributeLocations(n.vao),i.bindVAO(n.vao),i.setPipelineState(r.getPipeline(!1,a)),i.drawArrays(r.primitiveType,0,n.numElements)}initializeRenderContext(e,r){this._glMaterials=new F(this.material,e.materials),this._vaoCache=e.renderContext.rctx.getVaoCache(this.material.vertexAttributeLocations,D(this._bufferWriter.vertexBufferLayout))}uninitializeRenderContext(){}addRenderGeometry(e,r,t){this.removeRenderGeometry(e);let s=this._vaoCache.newVao(r.data.byteLength);s.vertexBuffers.get("geometry").setSubData(new Uint8Array(r.data),0,0,r.data.byteLength);let a={localOrigin:t,vao:s,numElements:r.elementCount};return this._renderGeometries.set(e,a),a}removeRenderGeometry(e){let r=this._renderGeometries.get(e);r!=null&&(this._vaoCache.deleteVao(r.vao),this._renderGeometries.delete(e))}hasHighlightOptions(e){return!1}};c([f({constructOnly:!0})],p.prototype,"material",void 0),p=c([u("esri.views.3d.layers.graphics.pipeline.rendering.DirectRenderer")],p);var y=class{constructor(e){this._optionalFields=new Array,this._featureIdToInstanceIndex=new Map,this._disposeResourceHandles=new Array,this._lodRendererResources=null,this.layerUid=e.layerUid,this.view=e.view,this.sharedResources=this.view.sharedSymbolResources,this.scheduler=this.view.resourceController.scheduler}get numFeatures(){return this._featureIdToInstanceIndex.size}get usedMemory(){return(this._lodRendererResources?.lodRenderer?.symbol?.computeUsedMemory()??0)+16*this._featureIdToInstanceIndex.size}destroy(){this._disposeResourceHandles.forEach(e=>e())}doLoad(e,r,t){return d(this,null,function*(){I("enable-feature:objectAndLayerId-rendering")&&this._optionalFields.push(E.OBJECTANDLAYERIDCOLOR);let s=J(n=>r(n),e),a=this.view._stage,i=s.getMaterials();a.addMany(i),this._addDisposeResource(()=>a.removeMany(i));let o=s.getTextures();a.addMany(o),this._addDisposeResource(()=>{o.forEach(n=>n.unload()),a.removeMany(o)}),yield Promise.all(o.map(n=>this.view._stage.schedule(()=>n.load(a.renderView.renderingContext),t))),x(t);let l=yield this._createLodRenderer(s,t);this._lodRendererResources={lodRenderer:l,materials:i,textures:o}})}addInstances(e){let r=this._lodRendererResources;if(r==null)return;let{featureIds:t,localTransforms:s,globalTransforms:a}=e,i=r.lodRenderer;if(i==null)return;let o=i.instanceData,l=t.length;for(let n=0;n<l;++n){let j=t[n],m=o.addInstance(),v=o.view,b=16*n;v.localTransform.copyFromTypedBuffer(m,s,b),v.globalTransform.copyFromTypedBuffer(m,a,b),o.updateModelTransform(m),o.setVisible(m,!0),this._featureIdToInstanceIndex.set(j,m)}}removeInstances(e){let r=this._lodRendererResources;if(r==null)return;let t=r.lodRenderer.instanceData,s=this._featureIdToInstanceIndex,a=e.length;for(let i=0;i<a;++i){let o=e[i],l=s.get(o);l!=null&&(t.removeInstance(l),s.delete(o))}}_addDisposeResource(e){this._disposeResourceHandles.push(e)}_createLodRenderer(e,r){return d(this,null,function*(){let t=this.view._stage,s={layerUid:this.layerUid,graphicUid:i=>1,notifyGraphicGeometryChanged:i=>1,notifyGraphicVisibilityChanged:i=>1},a=new B({symbol:e,optionalFields:this._optionalFields,metadata:s,shaderTransformation:null},this.scheduler);return a.slicePlaneEnabled=!1,this._addDisposeResource(()=>{t.removeRenderPlugin(a),a.destroy()}),yield t.addRenderPlugin(a,r),a})}};function J(e,r){let t=r.levels.map(s=>{let a=s.components.map(i=>{let o=e(i.materialId);if(!Y(o))throw new Error("LodRenderer only supports DefaultMaterial");let l=new H(o,i.renderGeometryBuffer.data,i.renderGeometryBuffer.elementCount,i.boundingInfo);return new U(l)});return new k(a,s.minScreenSpaceRadius)});return new z(t)}function Y(e){return e!=null&&"materialType"in e&&e.materialType==="default"}y=c([u("esri.views.3d.layers.graphics.pipeline.rendering.LodRenderer")],y);var w=class extends C{constructor(e){super(),this.view=null,this.layerUid=null,this._renderGeometries=new Map,this._materials=new Map,this._directRenderers=new Map,this._lodRenderers=new Map,this.totalFeatures=0,this.view=e.view,this.layerUid=e.layerUid}initialize(){}destroy(){this.removeAllHandles(),this._lodRenderers.forEach(e=>e.destroy())}executeRenderCommands(e){return d(this,null,function*(){for(let r of e)switch(r.id){case"create-material":yield this._createMaterial(r);break;case"create-direct-renderer":yield this._createDirectRenderer(r);break;case"add-direct-renderer-geometry":yield this._addDirectRendererGeometry(r),this._updateFeatureCount();break;case"remove-direct-renderer-geometry":yield this._removeDirectRendererGeometry(r),this._updateFeatureCount();break;case"create-lod-renderer":yield this._createLodRenderer(r);break;case"add-lod-instances":yield this._addLodInstances(r),this._updateFeatureCount();break;case"remove-lod-instances":yield this._removeLodInstances(r),this._updateFeatureCount()}})}_updateFeatureCount(){let e=0;for(let r of this._directRenderers.values())e+=r.numFeatures;for(let r of this._lodRenderers.values())e+=r.numFeatures;this._set("totalFeatures",e)}get usedMemory(){let e=0;for(let r of this._directRenderers.values())e+=r.usedMemory;for(let r of this._lodRenderers.values())e+=r.usedMemory;return e}_createMaterial(e){return d(this,null,function*(){let{view:r}=this,{sharedSymbolResources:t}=r;if(t==null)throw new Error("No shared symbol resources found!");let{textures:s}=t,a=r.state.viewingMode===P.Global,i=null;switch(e.type){case"default":i=Q(t,{physicalBasedRenderingEnabled:!0,slicePlaneEnabled:!1,castShadows:!0,isPrimitive:!0,screenSizePerspectiveEnabled:!0,doublePrecisionRequiresObfuscation:r._stage.renderView.renderingContext.driverTest.doublePrecisionRequiresObfuscation.result},a);break;case"hud":{let[o,l]=K(s,a);this.addHandles([G(()=>M(l))]),i=o}break;default:throw new Error(`unable to create unknown material type ${e.type}`)}this._materials.set(e.materialId,i)})}_getMaterial(e){return this._materials.get(e)}_createDirectRenderer(e){return d(this,null,function*(){let r=e.materialId,t=this._getMaterial(r);if(t==null)throw new Error(`material not found ${r}`);let{view:s}=this,a=new p({material:t});this._directRenderers.set(r,a),s._stage.addRenderPlugin(a),s._stage.renderView.renderer.updateHasFlags()})}_addDirectRendererGeometry(e){return d(this,null,function*(){let r=e.renderGeometryId,t=e.materialId;yield this._removeDirectRendererGeometry({renderGeometryId:r});let s=this._directRenderers.get(t);if(s==null)return void console.error("no renderer assigned to provided material");let a=s.addRenderGeometry(r,e.renderGeometryBuffer,e.localOrigin);this._renderGeometries.set(r,{renderGeometry:a,materialId:t}),this.view._stage.renderView.requestRender()})}_removeDirectRendererGeometry(e){return d(this,null,function*(){let r=e.renderGeometryId,t=this._renderGeometries.get(r);if(t==null)return;let s=t.materialId,a=this._directRenderers.get(s);a!=null?a.removeRenderGeometry(e.renderGeometryId):console.error("no renderer assigned to provided material")})}_createLodRenderer(e){return d(this,null,function*(){let r=new y({view:this.view,layerUid:this.layerUid}),t=new AbortController,s=a=>this._getMaterial(a);yield r.doLoad(e.lodRenderGeometry,s,t.signal),this._lodRenderers.set(e.lodRendererId,r)})}_addLodInstances(e){return d(this,null,function*(){let r=this._lodRenderers.get(e.lodRendererId);if(r==null)throw new Error("no lod renderer assigned to provided lod renderer Id");r.addInstances(e.data)})}_removeLodInstances(e){return d(this,null,function*(){let r=this._lodRenderers.get(e.lodRendererId);if(r==null)throw new Error("no lod renderer assigned to provided lod renderer Id");r.removeInstances(e.featureIds)})}};function K(e,r){let t={anchorPosition:T.center,occlusionTest:!0,hasSlicePlane:!1,color:[1,0,0,1],outlineColor:[0,0,0,1],outlineSize:1,distanceFieldBoundingBox:V},s=null;if(e!=null){let a=e.fromData("circle-icon",()=>N("circle"));t.textureId=a.texture.id,t.textureIsSignedDistanceField=!0,t.sampleSignedDistanceFieldTexelCenter=q("circle")}return[new $(t,r),s]}function Q(e,r,t){let s={usePBR:r.physicalBasedRenderingEnabled,isSchematic:!0,mrrFactors:O,ambient:_,diffuse:_,hasSlicePlane:r.slicePlaneEnabled,castShadows:r.castShadows,offsetTransparentBackfaces:!r.isPrimitive};return X(s),r.screenSizePerspectiveEnabled&&(s.screenSizePerspective=e.screenSizePerspectiveSettings),s.externalColor=L,s.isInstanced=!0,new W(s,{spherical:t,doublePrecisionRequiresObfuscation:!0})}function X(e){let r=e.opacity??1,t=r<1;return e.transparent=t,e.opacity=r,e.cullFace=t?R.None:R.Back,e}c([f({readOnly:!0})],w.prototype,"totalFeatures",void 0),w=c([u("esri.views.3d.layers.graphics.pipeline.rendering.FeaturePipelineRenderManager")],w);export{w as a,K as b};
