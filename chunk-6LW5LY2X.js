import{a as k}from"./chunk-HFE2PHQ6.js";import{a as x}from"./chunk-5JVT33KX.js";import{a as J}from"./chunk-F7UGNZLD.js";import{a as _}from"./chunk-LORHDXEB.js";import{a as P,b as j}from"./chunk-PU4AK46X.js";import{a as B}from"./chunk-2GJBUR2F.js";import{a as M}from"./chunk-DKGGDYJI.js";import{a as A}from"./chunk-IR6XCBC4.js";import{a as T}from"./chunk-7F5DJLJT.js";import{a as N}from"./chunk-CX5IFQZJ.js";import{o as v}from"./chunk-AUAZP44J.js";import{N as S,k as I}from"./chunk-76ATOSLU.js";import{f as $}from"./chunk-CCJU4DSH.js";import{b as u}from"./chunk-ACP3S2CH.js";import{a as n}from"./chunk-QGVBCWUY.js";import{e as l}from"./chunk-NFIPKH6V.js";import{l as R}from"./chunk-5QEXLALV.js";import{b as O,p as g}from"./chunk-4PTIEWMT.js";import{g as L}from"./chunk-XRGPJ3QY.js";import{b as F,d as w}from"./chunk-2LI2GKBQ.js";import{a as h,b,f as y}from"./chunk-VTHXE323.js";var f,C=0,i=f=class extends $.JSONSupportMixin(A){constructor(e){super(e),this.id=null,this.portalItem=null,this.spatialReference=null,this.style=null,this.thumbnailUrl=null,this.title="Basemap",this.id=Date.now().toString(16)+"-basemap-"+C++,this.baseLayers=new u,this.referenceLayers=new u;let t=r=>{r.parent&&r.parent!==this&&"remove"in r.parent&&r.parent.remove(r),r.parent=this,r.type==="elevation"&&L.getLogger(this).error(`Layer '${r.title}, id:${r.id}' of type '${r.type}' is not supported as a basemap layer and will therefore be ignored.`)},a=r=>{r.parent=null};this.addHandles([this.baseLayers.on("after-add",r=>t(r.item)),this.referenceLayers.on("after-add",r=>t(r.item)),this.baseLayers.on("after-remove",r=>a(r.item)),this.referenceLayers.on("after-remove",r=>a(r.item))])}initialize(){this.when().catch(e=>{L.getLogger(this).error("#load()",`Failed to load basemap (title: '${this.title}', id: '${this.id}')`,e)}),this.resourceInfo&&this.read(this.resourceInfo.data,this.resourceInfo.context)}destroy(){let e=this.baseLayers.toArray();for(let a of e)a.destroy();let t=this.referenceLayers.toArray();for(let a of t)a.destroy();this.baseLayers.destroy(),this.referenceLayers.destroy(),this.portalItem=O(this.portalItem)}normalizeCtorArgs(e){return e&&"resourceInfo"in e&&(this._set("resourceInfo",e.resourceInfo),delete(e=h({},e)).resourceInfo),e}set baseLayers(e){this._set("baseLayers",_(e,this._get("baseLayers")))}_writeBaseLayers(e,t,a){let r=[];e&&(a=b(h({},a),{layerContainerType:"basemap"}),this.baseLayers.forEach(s=>{let o=x(s,a.webmap?a.webmap.getLayerJSONFromResourceInfo(s):null,a);o!=null&&r.push(o)}),this.referenceLayers.forEach(s=>{let o=x(s,a.webmap?a.webmap.getLayerJSONFromResourceInfo(s):null,a);o!=null&&(s.type!=="scene"&&(o.isReference=!0),r.push(o))})),t.baseMapLayers=r}set referenceLayers(e){this._set("referenceLayers",_(e,this._get("referenceLayers")))}writeTitle(e,t){t.title=e||"Basemap"}load(e){return this.addResolvingPromise(this._loadFromSource(e)),Promise.resolve(this)}loadAll(){return J(this,e=>{e(this.baseLayers,this.referenceLayers)})}clone(){let e={id:this.id,title:this.title,portalItem:this.portalItem,baseLayers:this.baseLayers.map(t=>w(t)?t.clone():t),referenceLayers:this.referenceLayers.map(t=>w(t)?t.clone():t)};return this.loaded&&(e.loadStatus="loaded"),new f({resourceInfo:this.resourceInfo}).set(e)}read(e,t){this.resourceInfo||this._set("resourceInfo",{data:e,context:t}),super.read(e,t)}write(e,t){return e=e||{},t?.origin||(t=h({origin:"web-map"},t)),super.write(e,t),!this.loaded&&this.resourceInfo?.data.baseMapLayers&&(e.baseMapLayers=this.resourceInfo.data.baseMapLayers.map(a=>{let r=F(a);return r.url&&S(r.url)&&(r.url=`https:${r.url}`),r.templateUrl&&S(r.templateUrl)&&(r.templateUrl=`https:${r.templateUrl}`),r})),e}_loadFromSource(e){return y(this,null,function*(){let{resourceInfo:t,portalItem:a,style:r}=this;g(e);let s=[];if(t){let o=t.context?t.context.url:null;if(s.push(this._loadLayersFromJSON(t.data,o,e)),t.data.id&&!t.data.title){let c=t.data.id;s.push(P(c).then(p=>{p&&this.read({title:p},t.context)}))}}else a?s.push(this._loadFromItem(a,e)):r&&s.push(this._loadFromStylesService(r,e));yield Promise.all(s)})}_loadLayersFromJSON(e,t,a){return y(this,null,function*(){let r=this.resourceInfo?.context,s=this.portalItem?.portal||r?.portal||null,o=W[r?.origin||""]??"web-map",{populateOperationalLayers:c}=yield import("./chunk-4PI6XTSR.js"),p=[];if(g(a),e.baseMapLayers&&Array.isArray(e.baseMapLayers)){let m={context:b(h({},r),{origin:o,url:t,portal:s,layerContainerType:"basemap"}),defaultLayerType:"DefaultTileLayer"},U=d=>o==="web-scene"&&d.layerType==="ArcGISSceneServiceLayer"||d.isReference,D=c(this.baseLayers,e.baseMapLayers.filter(d=>!U(d)),m);p.push(D);let K=c(this.referenceLayers,e.baseMapLayers.filter(U),m);p.push(K)}yield Promise.allSettled(p)})}_loadFromItem(e,t){return y(this,null,function*(){let a=yield e.load(t),r=yield a.fetchData("json",t),s=I(e.itemUrl??"");return this._set("resourceInfo",{data:r.baseMap??{},context:{origin:q[e.type||""]??"web-map",portal:e.portal||M.getDefault(),url:s}}),this.read(this.resourceInfo.data,this.resourceInfo.context),this.read({spatialReference:r.spatialReference},this.resourceInfo.context),this.read({title:e.title,thumbnailUrl:e.thumbnailUrl},{origin:"portal-item",portal:e.portal||M.getDefault(),url:s}),this._loadLayersFromJSON(this.resourceInfo.data,s,t)})}_loadFromStylesService(e,t){return y(this,null,function*(){let a=e.serviceUrl.endsWith("/webmaps")?e.serviceUrl.slice(0,-8):e.serviceUrl,r=`${a}/styles/${e.id}/self`,s=`${a}/webmaps/${e.id}`,[o,c]=yield Promise.all([(yield v(r,{query:{token:e.apiKey},signal:t?.signal})).data,(yield v(s,{query:{language:e.languageParameter,places:e.places,worldview:e.worldview,token:e.apiKey},signal:t?.signal})).data]);this.thumbnailUrl??=o.thumbnailUrl;let p=I(s);if(this._set("resourceInfo",{data:c.baseMap??{},context:{origin:"web-map",url:p}}),this.read(this.resourceInfo.data,this.resourceInfo.context),this.read({spatialReference:c.spatialReference},this.resourceInfo.context),yield this._loadLayersFromJSON(this.resourceInfo.data,p,t),e.apiKey)for(let m of[...this.baseLayers,...this.referenceLayers])"apiKey"in m&&(m.apiKey=e.apiKey)})}static fromId(e){let t=j[e];return t?t.itemId?new f({portalItem:{id:t.itemId,portal:{url:"https://www.arcgis.com"}}}):f.fromJSON(t,{origin:t.is3d?"web-scene":"web-map"}):null}};n([l({json:{write:{ignoreOrigin:!0,target:"baseMapLayers",writer(e,t,a,r){this._writeBaseLayers(e,t,r)}},origins:{"web-scene":{write:{ignoreOrigin:!0,target:{baseMapLayers:{type:u}},writer(e,t,a,r){this._writeBaseLayers(e,t,r)}}}}}})],i.prototype,"baseLayers",null),n([l({type:String,json:{origins:{"web-scene":{write:!0}}}})],i.prototype,"id",void 0),n([l({type:B})],i.prototype,"portalItem",void 0),n([l()],i.prototype,"referenceLayers",null),n([l({readOnly:!0})],i.prototype,"resourceInfo",void 0),n([l({type:T})],i.prototype,"spatialReference",void 0),n([l({type:k})],i.prototype,"style",void 0),n([l()],i.prototype,"thumbnailUrl",void 0),n([l({type:String,json:{origins:{"web-scene":{write:{isRequired:!0}}}}})],i.prototype,"title",void 0),n([N("title")],i.prototype,"writeTitle",null),i=f=n([R("esri.Basemap")],i);var q={"Web Scene":"web-scene","Web Map":"web-map","Link Chart":"link-chart"},W={"web-scene":"web-scene","web-map":"web-map","link-chart":"link-chart"},ye=i;export{ye as a};
