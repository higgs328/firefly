import{b as ft}from"./chunk-LSYBUGGM.js";import{a as mt}from"./chunk-OLOYQ6KE.js";import{a as ot,b as ut,c as ct}from"./chunk-E7DFFC2Y.js";import{d as at}from"./chunk-7T2VXP7X.js";import{b as rt,c as nt,d as dt,e as yt,g as O,h as ht}from"./chunk-SJAM4JSC.js";import{b as st}from"./chunk-5C7K2G4S.js";import{a as lt}from"./chunk-4A4DMQSS.js";import{a as it}from"./chunk-B3VPRADQ.js";import{a as de,b as Ye,c as et,d as tt}from"./chunk-HJQNAAJT.js";import{a as Je,b as Qe,d as Ze,e as ue,f as Ke,g as Xe,h as ce}from"./chunk-KP75LCOH.js";import{a as je}from"./chunk-J4NXMDBD.js";import{b as Ge}from"./chunk-5AFOYCWC.js";import{f as Ue}from"./chunk-YB6RTOHR.js";import{a as $e}from"./chunk-5VU7MVV7.js";import{a as oe}from"./chunk-E56W4PK4.js";import{a as qe}from"./chunk-KLZGQ7M6.js";import{b as He,c as K}from"./chunk-QS3EYJPF.js";import{b as Ne}from"./chunk-5RH7OPHX.js";import{b as Me}from"./chunk-XR5FT7TQ.js";import{a as q}from"./chunk-CZ6CGC7I.js";import{a as ae}from"./chunk-BPWNCOXC.js";import{a as ne}from"./chunk-6F25LG6O.js";import{ya as We}from"./chunk-KALOJIUA.js";import{d as ke}from"./chunk-QKO56XO6.js";import{b as Ae}from"./chunk-OLOKUDVI.js";import{a as Be}from"./chunk-JLPLCY2B.js";import{a as De}from"./chunk-7P44K2YD.js";import{b as xe}from"./chunk-UST6HCE7.js";import{a as Ve}from"./chunk-BAEF3CT6.js";import{o as re}from"./chunk-AUAZP44J.js";import{g as Re}from"./chunk-KNVXE32P.js";import{$ as Fe}from"./chunk-76ATOSLU.js";import{a as I,c as Te,e as Pe,j as Oe}from"./chunk-TG45K3WR.js";import{b as ze}from"./chunk-ACP3S2CH.js";import{a as _}from"./chunk-QGVBCWUY.js";import{H as Ie,h as H}from"./chunk-MYO4NP2N.js";import{e as w}from"./chunk-NFIPKH6V.js";import{l as Ee}from"./chunk-5QEXLALV.js";import{K as Ce}from"./chunk-4PTIEWMT.js";import{g as V}from"./chunk-XRGPJ3QY.js";import{a as Le,y as N}from"./chunk-QBWJMFH5.js";import{a as J,f as m}from"./chunk-VTHXE323.js";function pt(e,i,t){let l=e.effectiveClusterRenderer;if(!l||!("visualVariables"in l)||!l.visualVariables)return null;let s=l.visualVariables.find(y=>y.type==="size");if(!("stops"in s)||!s.stops)return null;let r=s.stops.find(y=>y.useMinValue),n=s.stops.find(y=>y.useMaxValue);if(r==null||n==null)return null;let o=t.featuresTilingScheme.getClosestInfoForScale(t.scale).level,a=s.field,u=i.getDisplayStatistics(o,a);return u?new K({field:s.field,minSize:e.clusterMinSize,minDataValue:u.minValue,maxSize:e.clusterMaxSize,maxDataValue:u.maxValue}):null}var gt=16,Rt="https://utility.arcgis.com/sharing/tools/legend",Vt="esri.layers.ImageryLayer",Dt="esri.layers.ImageryTileLayer",xt="esri.layers.WCSLayer",X=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i,zt=new Ve({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryMultiPatch:"multipatch"}),Y=new q({size:6,outline:{color:[128,128,128,.5],width:.5}}),Tt=new ae({style:"solid"});function me(e){return e.type==="flow"}function _t(e){return e.type==="vector-field"}function wt(e){return e.type==="raster-colormap"}function vt(e){return e.type==="raster-stretch"}function Lt(e){return e.type==="raster-shaded-relief"}function U(e){return e.declaredClass==="esri.renderers.SimpleRenderer"}function M(e){return e.declaredClass==="esri.renderers.ClassBreaksRenderer"}function A(e){return e.declaredClass==="esri.renderers.UniqueValueRenderer"}function Ct(e){return e.declaredClass==="esri.renderers.HeatmapRenderer"}function Pt(e){return fe(e)||pe(e)||ge(e)||Ot(e)}function Ot(e){return e.declaredClass==="esri.renderers.PointCloudRGBRenderer"}function fe(e){return e.declaredClass==="esri.renderers.PointCloudClassBreaksRenderer"}function pe(e){return e.declaredClass==="esri.renderers.PointCloudStretchRenderer"}function ge(e){return e.declaredClass==="esri.renderers.PointCloudUniqueValueRenderer"}function Et(e){return e.declaredClass==="esri.renderers.DotDensityRenderer"}function It(e){return e.declaredClass==="esri.renderers.PieChartRenderer"}function Mt(e,i){return U(e)||M(e)||A(e)||Ct(e)||Et(e)||It(e)?i.type==="2d"||mt(e):vt(e)||wt(e)||Lt(e)||fe(e)||pe(e)||ge(e)||_t(e)||me(e)}function At(e){return e.declaredClass==="esri.layers.BuildingSceneLayer"}function ye(e){return e.declaredClass==="esri.layers.SubtypeGroupLayer"}function kt(e){return e.declaredClass==="esri.layers.VoxelLayer"}function Bt(e){return e.declaredClass==="esri.layers.WMSLayer"}function Nt(e){return e.declaredClass==="esri.layers.WMTSLayer"}function he(e){return e.declaredClass==="esri.layers.MapImageLayer"}function bt(e){return e.declaredClass==="esri.layers.TileLayer"}function $(e){return e.declaredClass===Vt}function ee(e){return e.declaredClass===Dt}function Ht(e){return e.declaredClass===xt}function qt(e){return e.type==="stretch-ramp"}function $t(e){return("authoringInfo"in e?e?.authoringInfo:null)?.type==="univariate-color-size"}function Wt(e){let i="authoringInfo"in e?e?.authoringInfo:null;return i?.type==="univariate-color-size"&&i?.univariateTheme==="above-and-below"}function St(e){return"sublayers"in e}function x(e,i){return m(this,null,function*(){let t=yield xe("esri/widgets/Legend/t9n/Legend");return e!=="previewTemplateAriaLabel"||i||(e="previewAriaLabel"),De(t[e],{label:i})})}function Ut(e,i){let{field:t,field2:l,field3:s,fieldDelimiter:r,valueExpression:n}=e;if(!t)return null;let o=!t&&!n||!l&&!s?[i]:i?.toString().split(r||""),a=t?{[t]:o?.[0]}:null;return a&&(l&&(a[l]=o?.[1]),s&&(a[s]=o?.[2])),a}var Gt=new q({style:"path",path:"M10,5 L5,0 0,5 M5,0 L5,15",size:15,outline:{width:1,color:[85,85,85,1]}}),W={},g=class extends Ie{constructor(e){super(e),this._hasColorRamp=!1,this._hasOpacityRamp=!1,this._hasSizeRamp=!1,this._webStyleSymbolCache=new Map,this._dotDensityUrlCache=new Map,this._scaleDrivenSizeVariable=null,this._hasClusterSizeVariable=!1,this._layerDefinitionExpression=null,this._layerDefinitionExpressionClause=null,this._layerDisplayFilterId=null,this._layerDisplayFilterClause=null,this.children=new ze,this.layerView=null,this.layer=null,this.legendElements=[],this.parent=null,this.hideLayersNotInCurrentView=!1,this.keepCacheOnDestroy=!1,this.respectLayerDefinitionExpression=!1,this.respectLayerVisibility=!0,this.sublayerIds=[],this.title=null,this.view=null}initialize(){let e=()=>this.notifyChange("ready");this.addHandles([Te(()=>this.children,"change",i=>{let{added:t,removed:l}=i;t.forEach(s=>{let r=`activeLayerInfo-ready-watcher-${s.layer.uid}`;this.addHandles(I(()=>s.ready,e,Oe),r)}),l.forEach(s=>this.removeHandles(s.layer.uid)),e()})]),this.keepCacheOnDestroy||(W={})}destroy(){this._webStyleSymbolCache=null,this._dotDensityUrlCache=null,this._scaleDrivenSizeVariable=null,this.keepCacheOnDestroy||(W=null),this._layerDefinitionExpressionClause=null}get effectList(){let e=this.layer,i=null;return"effect"in e&&e.effect&&(i=new je,i.effect=e.effect,i.endTransition(),i.scale=this.scale),i}get opacity(){let e=this.layer.opacity,i=this.parent?.opacity,t=this.layer.parent,l=t&&"uid"in t?this._getParentLayerOpacity(t):null;return i!=null?i*e:l!=null?l*e:e}get ready(){return this.layer===null||(this.children.length>0?this._isGroupActive():this.legendElements.length>0)}get scale(){return this.view?.scale??0}get isScaleDriven(){let e=this.layer;if(e===null)return!1;if("effect"in e&&e.effect&&Array.isArray(e.effect))return!0;if("featureReduction"in e&&e.featureReduction){if(e.featureReduction.type==="cluster")return!0;if(e.featureReduction.type==="binning"&&"renderer"in e.featureReduction&&e.featureReduction.renderer)return this._isRendererScaleDriven(e.featureReduction.renderer)}return"renderer"in e&&e.renderer?!!("displayFilterInfo"in e&&e.displayFilterInfo&&A(e.renderer))||this._isRendererScaleDriven(e.renderer):this._isLayerScaleDriven(this.layer)}get version(){return this._get("version")+1}buildLegendElementsForFeatureCollections(e){return m(this,null,function*(){if(!(!this.hideLayersNotInCurrentView||(yield this._isLayerInCurrentView())))return this.legendElements=[],void this.notifyChange("ready");let i=Array.from(e,t=>{if(Me(t))return this._getRendererLegendElements(t.renderer,{title:t.title});if(t.featureSet?.features.length){let l=t.layerDefinition,s=l?.drawingInfo,r=s&&qe(s.renderer),n=zt.read(l.geometryType);return r?this._getRendererLegendElements(r,{title:t.name,geometryType:n}):(V.getLogger(this).warn("drawingInfo not available!"),null)}return null});try{let t=[],l=yield Promise.allSettled(i);for(let s of l)if(s.status==="fulfilled")for(let r of s.value??[])t.push(r);this.legendElements=t,this.notifyChange("ready")}catch(t){V.getLogger(this).warn("error while building legend for layer!",t)}})}buildLegendElementsForRenderer(e){return m(this,null,function*(){try{let i=!this.hideLayersNotInCurrentView||(yield this._isLayerInCurrentView());this.legendElements=i?yield this._getRendererLegendElements(e):[],this.notifyChange("ready")}catch(i){V.getLogger(this).warn("error while building legend for layer!",i)}})}buildLegendElementsForFeatureReduction(e){return m(this,null,function*(){try{let i=!this.hideLayersNotInCurrentView||(yield this._isLayerInCurrentView());this.legendElements=i?yield this._getLegendElementsForFeatureReduction(e):[],this.notifyChange("ready")}catch(i){V.getLogger(this).warn("error while building legend for layer!",i)}})}buildLegendElementsForTools(){return m(this,null,function*(){let e=this.layer;if(kt(e))this._constructLegendElementsForVoxelLayer();else if(Nt(e))this._constructLegendElementsForWMTSlayer();else if(Bt(e))yield this._constructLegendElementsForWMSSublayers();else if(At(e))yield this._constructLegendElementsForBuildingSceneLayer();else if(he(e)||bt(e)||ye(e))yield this._constructLegendElementsForSublayers();else{this.removeHandles("imageryLayers-watcher");let i="default";if($(e)&&(i=(e?.rasterFunction?.functionName||"default")+"_"+(e.bandIds?.length?e.bandIds.join(""):"###")),ee(e)||e.type==="link-chart")return;yield this._getLegendLayers(`${e.uid}-${i}`).then(t=>m(this,null,function*(){this.legendElements=[],this.notifyChange("ready");let l=t.map(s=>m(this,null,function*(){if($(e)){let n=I(()=>[e.rasterFunction,e.bandIds],()=>Ce(()=>m(this,null,function*(){W.default=null,e.renderer?yield this.buildLegendElementsForRenderer(e.renderer):yield this.buildLegendElementsForTools()}))());this.addHandles(n,"imageryLayers-watcher")}let r=this._generateSymbolTableElementForLegendLayer(s);r?.infos.length&&($(e)&&(r.title=e.title),this.legendElements.push(r)),this.notifyChange("ready")}));yield Promise.allSettled(l)})).catch(t=>{V.getLogger(this).warn("Request to server for legend has failed!",t)})}})}_isLayerInCurrentView(){return m(this,null,function*(){let e=this.layer,i=this.layerView,t=i&&"createQuery"in i&&"queryFeatureCount"in i;if(!t&&!(i&&"createQuery"in e&&"queryFeatureCount"in e))return!0;yield Pe(()=>!i.updating);let l=t?"createQuery"in i&&i.createQuery():"createQuery"in e&&e.createQuery();return l?(l.geometry=this.view.extent,(t?"queryFeatureCount"in i&&(yield i.queryFeatureCount(l)):"queryFeatureCount"in e&&(yield e.queryFeatureCount(l)))!==0):!0})}_getParentLayerOpacity(e){let i=1,t=e.parent;return t&&"uid"in t&&(i=this._getParentLayerOpacity(t)),e.opacity*i}_isGroupActive(){return this.children.some(e=>e.ready)}_isRendererScaleDriven(e){if(e.type==="dot-density")return!0;let i="valueExpression"in e?e.valueExpression:null;return X.test(i)?!0:!!("visualVariables"in e?e.visualVariables:null)?.some(l=>this._isScaleDrivenSizeVariable(l))||this._hasScaleDrivenSymbols(e)}_hasScaleDrivenSymbols(e){switch(e.type){case"simple":return this._isScaleDrivenSymbol(e.symbol);case"class-breaks":return this._isScaleDrivenSymbol(e.defaultSymbol)||e.classBreakInfos.some(i=>this._isScaleDrivenSymbol(i.symbol));case"unique-value":return this._isScaleDrivenSymbol(e.defaultSymbol)||!!e.uniqueValueInfos?.some(i=>this._isScaleDrivenSymbol(i.symbol))}return!1}_isScaleDrivenSymbol(e){if(e?.type==="cim"){let{primitiveOverrides:i,minScale:t,maxScale:l}=e.data,s=i?.some(r=>/\$view\.scale/.test(r.valueExpressionInfo?.expression||""))??!1;return t!=null||l!=null||s}return!1}_isScaleDrivenSizeVariable(e){if(e&&e.type!=="size")return!1;let i=e,t=i.minSize,l=i.maxSize;return!(typeof t!="object"||!t||!this._isScaleDrivenSizeVariable(t))||!(typeof l!="object"||!l||!this._isScaleDrivenSizeVariable(l))||X.test(i.valueExpression)}_isLayerScaleDriven(e){if("minScale"in e&&e.minScale>0||"maxScale"in e&&e.maxScale>0)return!0;if("sublayers"in e&&e.sublayers)return e.sublayers.some(t=>this._isLayerScaleDriven(t));let i=e.parent;if(e.loaded===!1&&i&&he(i)&&"source"in e&&e.source&&e.source.type==="map-layer"){for(let t of i.sourceJSON.layers??[])if(t.id===e.source.mapLayerId&&(t.minScale>0||t.maxScale>0))return!0}return!1}_constructLegendElementsForVoxelLayer(){return m(this,null,function*(){this.legendElements=[],this.removeHandles("voxel-style-watcher"),this.removeHandles("voxel-current-variable");let e=this.layer;this.addHandles(I(()=>e.currentVariableId,()=>this._constructLegendElementsForVoxelLayer()),"voxel-current-variable"),this.addHandles(I(()=>e.getVariableStyles(),()=>this._constructLegendElementsForVoxelLayer()),"voxel-style-watcher");let i=e.getVariableStyle(null),t=[];if(i){if(i.uniqueValues?.length){let r=[];i.uniqueValues.forEach(n=>{n.enabled&&r.push({label:n.label||`${n.value}`,value:n.value,symbol:new ae({color:n.color,outline:null})})}),r.length&&t.push({type:"symbol-table",title:i.label,infos:r})}else if(i.transferFunction){let{colorStops:r,stretchRange:n}=i.transferFunction,o=r.toArray().reverse(),a=n.map((y,c)=>`${c===0?Je:Qe} ${ft(y)}`).reverse(),u=o.map(y=>({color:y.color,value:null,label:null}));u[0].label=a[0],u[u.length-1].label=a[1],t.push({type:"color-ramp",title:i.label,infos:u,preview:O(o.map(y=>y.color),{ariaLabel:yield x("previewColorRampAriaLabel")})})}}let l=e.opacity,s=t.reduce((r,n)=>[...r,...this._getAllInfos(n)],[]).filter(r=>!!r?.symbol).map(r=>this._getSymbolPreview(r,l));yield Promise.allSettled(s),this.legendElements=t,this.notifyChange("ready")})}_constructLegendElementsForWMTSlayer(){this.legendElements=[],this.removeHandles("wmts-activeLayer-watcher");let e=this.layer.activeLayer;this.addHandles(I(()=>{let{layer:t}=this;return t&&"activeLayer"in t&&t.activeLayer},()=>this._constructLegendElementsForWMTSlayer()),"wmts-activeLayer-watcher");let i=e.styleId?e.styles?.find(({id:t})=>t===e.styleId)?.legendUrl:void 0;i&&(this.legendElements=[{type:"symbol-table",title:e.title,infos:[{src:i,opacity:this.opacity}]}]),this.notifyChange("ready")}_constructLegendElementsForWMSSublayers(){return m(this,null,function*(){this.legendElements=[],this.removeHandles("wms-sublayers-watcher");let e=this.layer,i=null;(e.customParameters||e.customLayerParameters)&&(i=J(J({},e.customParameters),e.customLayerParameters)),this.addHandles(I(()=>{let{layer:t}=this;return t&&"sublayers"in t&&t.sublayers},()=>this._constructLegendElementsForWMSSublayers()),"wms-sublayers-watcher"),this.legendElements=yield this._generateLegendElementsForWMSSublayers(e.sublayers,i),this.notifyChange("ready")})}_generateLegendElementsForWMSSublayers(e,i){return m(this,null,function*(){let t=this.layer,l=[];this.addHandles(e.on("change",()=>this._constructLegendElementsForWMSSublayers()),"wms-sublayers-watcher");let s=this.sublayerIds?.map(n=>t.findSublayerById(n))?.filter(N)??[],r=s.length?s:e.toArray();for(let n of r){let o=I(()=>[n.title,n.visible,n.legendEnabled],()=>this._constructLegendElementsForWMSSublayers());if(this.addHandles(o,"wms-sublayers-watcher"),!this.respectLayerVisibility||n.visible&&n.legendEnabled){let a=yield this._generateSymbolTableElementForWMSSublayer(n,i);a?.infos.length&&l.unshift(a)}}return l})}_generateSymbolTableElementForWMSSublayer(e,i){return m(this,null,function*(){if(!e.legendUrl&&e.sublayers){let t=(yield this._generateLegendElementsForWMSSublayers(e.sublayers,i)).filter(l=>l);return{type:"symbol-table",title:e.title,infos:t}}return this._generateSymbolTableElementForLegendUrl(e,i)})}_generateSymbolTableElementForLegendUrl(e,i){return m(this,null,function*(){let t=e.legendUrl;if(!t)return;let l={type:"symbol-table",title:e.title||e.name||String(e.id??""),infos:[]};i&&(t=Fe(t,i));let s=null,r=e.layer?.opacity;try{s=(yield re(t,{responseType:"image"})).data,s&&(s.style.opacity=r)}catch{}return l.infos.push({src:t,preview:s,opacity:r}),l})}_getLegendLayers(e,i){let t=W&&W[e];return t?Promise.resolve(t):this._legendRequest(i).then(l=>{let s=l.layers;return W[e]=s,s})}_legendRequest(e){let i=this.layer,t={f:"json",dynamicLayers:e};if($(i)){let s=i.exportImageServiceParameters.rasterFunction;if(s&&(t.renderingRule=JSON.stringify(s.functionDefinition?.toJSON()||s.toJSON())),i.bandIds&&(t.bandIds=i.bandIds.join()),i.raster||i.viewId||i.customParameters){let{raster:r,viewId:n,customParameters:o}=i;t=J(J({raster:r,viewId:n},t),o)}}let l=i.url.replace(/(\/)+$/,"");if("version"in i&&+i.version>=10.01){let s=l.indexOf("?");s>-1?l=l.slice(0,s)+"/legend"+l.slice(s):l+="/legend"}else{let s=l.toLowerCase().indexOf("/rest/"),r=s===-1?l:l.slice(0,s)+l.slice(s+5);l=Rt+"?soapUrl="+encodeURI(r)+"&returnbytes=true"}return re(l,{query:t}).then(s=>s.data)}_constructLegendElementsForBuildingSceneLayer(){return m(this,null,function*(){this.legendElements=[],this.removeHandles("sublayers-watcher");let e=this.layer;this.addHandles(I(()=>e.sublayers,()=>this._constructLegendElementsForBuildingSceneLayer()),"sublayers-watcher");try{this.legendElements=yield this._generateLegendElementsForBuildingSublayers(e.sublayers,this.opacity),this.notifyChange("ready")}catch(i){V.getLogger(this).warn("Request to server for legend has failed!",i)}})}_generateLegendElementsForBuildingSublayers(e,i){return m(this,null,function*(){let t=[];this.addHandles(e.on("change",()=>this._constructLegendElementsForBuildingSceneLayer()),"sublayers-watcher");let l=e.toArray();for(let s of l){let r=I(()=>["renderer"in s&&s.renderer,s.opacity,s.title,s.visible],()=>this._constructLegendElementsForBuildingSceneLayer());if(this.addHandles(r,"sublayers-watcher"),!this.respectLayerVisibility||s.visible){let n=s?.opacity!=null?s.opacity:null,o=n!=null?n*i:i;if(s.type==="building-group"){let a={type:"symbol-table",title:s.title,infos:[]},u=yield this._generateLegendElementsForBuildingSublayers(s.sublayers,o);a.infos.push(...u),t=[a,...t]}else s.renderer&&(t=[...yield this._getRendererLegendElements(s.renderer,{title:s.title,opacity:o,sublayer:s}),...t])}}return t.filter(s=>!!s&&(!("infos"in s)||!s.infos||s.infos.length>0))})}_constructLegendElementsForSublayers(){return m(this,null,function*(){this.legendElements=[],this.removeHandles("sublayers-watcher");let e=this.layer;if(he(e)||bt(e)||ye(e)){this.addHandles(I(()=>e.sublayers,()=>this._constructLegendElementsForSublayers),"sublayers-watcher");try{this.legendElements=yield this._generateLegendElementsForSublayers(e.sublayers,this.opacity),this.notifyChange("ready")}catch(i){V.getLogger(this).warn("Request to server for legend has failed!",i)}}})}_generateLegendElementsForSublayers(e,i,t){return m(this,null,function*(){let l=this.layer,s=[];this.addHandles(e.on("change",()=>this._constructLegendElementsForSublayers()),"sublayers-watcher");let r=e.toArray();!t&&this.sublayerIds&&this.sublayerIds.length&&(r=ye(l)?this.sublayerIds.map(n=>l.findSublayerForSubtypeCode(n)).filter(N):this.sublayerIds.map(n=>l.findSublayerById(n)).filter(N));for(let n of r){let o=I(()=>[n.renderer,n.opacity,n.title,n.visible,n.legendEnabled],()=>this._constructLegendElementsForSublayers());if(this.addHandles(o,"sublayers-watcher"),!this.respectLayerVisibility||n.visible&&n.legendEnabled&&this._isSublayerInScale(n)){let a=n?.opacity!=null?n.opacity:null,u=a!=null?a*i:i,y=!St(n)||n.originIdOf("renderer")>H.SERVICE&&!n.sublayers;if(n.renderer&&y)yield n.load(),s=[...yield this._getRendererLegendElements(n.renderer,{title:n.title,opacity:u,sublayer:n}),...s];else if(St(n)){let c=yield this._generateSymbolTableElementForSublayer(n,u,t);c&&s.unshift(c)}}}return s.filter(n=>!!n&&(!("infos"in n)||!n.infos||n.infos.length>0))})}_generateSymbolTableElementForSublayer(e,i,t){return m(this,null,function*(){if(!t){t=new Map;let s=this.layer,r=e.source,n=null;if(!(!r||r.type==="map-layer"&&r.mapLayerId===e.id&&(!r.gdbVersion||r.gdbVersion===("gdbVersion"in s&&s.gdbVersion)))||e.originIdOf("renderer")>H.SERVICE||e.originIdOf("labelingInfo")>H.SERVICE||e.originIdOf("labelsVisible")>H.SERVICE){let a=new $e({layer:this.layer});n=a.hasDynamicLayers?a.dynamicLayers:null,a.destroy()}let o=n||`${s.uid}-default`;(yield this._getLegendLayers(o,n)).forEach(a=>t.set(a.layerId,a))}let l=t.get(e.id);if((!l||l?.subLayerIds&&l.defaultVisibility)&&e.sublayers){let s=yield this._generateLegendElementsForSublayers(e.sublayers,i,t);return{type:"symbol-table",title:e.title,infos:s}}return this._generateSymbolTableElementForLegendLayer(l,e,i)})}_generateSymbolTableElementForLegendLayer(e,i,t){if(!e?.legend||this.respectLayerVisibility&&!this._isLegendLayerInScale(e,i))return null;let l=i?.renderer,s=i?.title||e.layerName;if(l&&(!i||i?.originIdOf("renderer")>H.SERVICE)){let o=i?.title||this._getRendererTitle(l,i);o&&(s&&typeof o!="string"&&"title"in o&&(o.title=s),s=o)}let r={type:"symbol-table",title:s,legendType:e.legendType||null,infos:[]},n=i?this._sanitizeLegendForSublayer(e.legend.slice(),i):e.legend;return e.legendGroups&&e.legendGroups.length>0?e.legendGroups.forEach(o=>{let a={type:"symbol-table",title:o.heading,legendType:e.legendType||null,infos:this._generateSymbolTableElementInfosForLegendLayer(n.filter(u=>u.groupId===o.id),e.layerId,t)};a.infos?.length>0&&r.infos.push(a)}):r.infos=this._generateSymbolTableElementInfosForLegendLayer(n,e.layerId,t),r.infos.length>0?r:null}_generateSymbolTableElementInfosForLegendLayer(e,i,t){return e.map(l=>{let s=l.url;if(l.imageData&&l.imageData.length>0)s=`data:image/png;base64,${l.imageData}`;else{if(s.indexOf("http")===0)return null;s=Re(`${this.layer.url}/${i}/images/${s}`)}return{label:l.label,src:s,opacity:t??this.opacity,width:l.width,height:l.height}}).filter(N)}_isSublayerInScale(e){let i=e.minScale||0,t=e.maxScale||0;return!(i>0&&i<this.scale||t>this.scale)}_isLegendLayerInScale(e,i){let t=i||this.layer,l=null,s=null,r=!0;return!t.minScale&&t.minScale!==0||!t.maxScale&&t.maxScale!==0?(e.minScale===0&&t.tileInfo&&(l=t.tileInfo.lods[0].scale),e.maxScale===0&&t.tileInfo&&(s=t.tileInfo.lods[t.tileInfo.lods.length-1].scale)):(l=Math.min(t.minScale,e.minScale)||t.minScale||e.minScale,s=Math.max(t.maxScale,e.maxScale)),(l>0&&l<this.scale||s>this.scale)&&(r=!1),r}_sanitizeLegendForSublayer(e,i){if("version"in this.layer&&+this.layer.version<10.1||e.length===0)return e;let t=i.renderer,l=e.some(n=>n.values),s=0,r=null;return l&&e.some((n,o)=>(n.values||(s=o,r=n,r.label||(r.label="others")),r!=null)),t?t.type==="unique-value"?r&&(e.splice(s,1),e.push(r)):t.type==="class-breaks"&&(r&&e.splice(s,1),t.legendOptions?.order||e.reverse(),r&&e.push(r)):r&&(e.splice(s,1),e.push(r)),e}_getRendererLegendElements(t){return m(this,arguments,function*(e,i={}){if(!Mt(e,this.view))return V.getLogger(this).warn(`Renderer of type '${e.type}' not supported!`),[];if(Pt(e))return this._constructPointCloudRendererLegendElements(e,i);if(Et(e))return this._constructDotDensityRendererLegendElements(e);let l=yield this._loadRenderer(e);return It(l)?this._constructPieChartRendererLegendElements(l):this._constructRendererLegendElements(l,i)})}_getLegendElementsForFeatureReduction(e){return m(this,null,function*(){let i=null;return e.type==="binning"?i=e.renderer:e.type==="cluster"&&(i=this._getClusterRenderer(e)),i?this._getRendererLegendElements(i):[]})}_getPointCloudRendererTitle(e){return(e.legendOptions?.title||e.field)??""}_constructPointCloudRendererLegendElements(t){return m(this,arguments,function*(e,i={}){let l=i.title,s=[],r=null,n=null;if(fe(e))r={type:"symbol-table",title:l||this._getPointCloudRendererTitle(e),infos:[]},e.colorClassBreakInfos.forEach(a=>{r.infos.unshift({label:a.label||a.minValue+" - "+a.maxValue,value:[a.minValue,a.maxValue],symbol:this._getAppliedCloneSymbol(Y,a.color)})});else if(pe(e)){let a=e.stops,u=null;if(a?.length&&(a.length===1&&(u=a[0].color),!u)){let c=a[0].value,v=a[a.length-1].value;c!=null&&v!=null&&(u=et(c+(v-c)/2,a))}r={type:"symbol-table",title:null,infos:[{label:null,value:null,symbol:this._getAppliedCloneSymbol(Y,u||Y.color)}]};let y=Ye(e.stops??[])??[];n={type:"color-ramp",title:l||this._getPointCloudRendererTitle(e),infos:y,preview:O(y.map(c=>c.color),{ariaLabel:yield x("previewColorRampAriaLabel")})}}else ge(e)&&(r={type:"symbol-table",title:l||this._getPointCloudRendererTitle(e),infos:[]},e.colorUniqueValueInfos?.forEach(a=>{r.infos.push({label:a.label||a.values.join(", "),value:a.values.join(", "),symbol:this._getAppliedCloneSymbol(Y,a.color)})}));r?.infos.length&&s.push(r),n?.infos.length&&s.push(n);let o=s.reduce((a,u)=>[...a,...u.infos??[]],[]).filter(a=>!!a.symbol).map(a=>this._getSymbolPreview(a,this.opacity,{symbolConfig:{applyColorModulation:!!e.colorModulation}}));return yield Promise.allSettled(o),s})}_getElementInfoForDotDensity(e,i){return m(this,null,function*(){let{color:t,label:l,valueExpressionTitle:s}=i,{backgroundColor:r,outline:n,dotSize:o}=e,a=this.effectList,u=a?.effects.map(te=>te.toJSON()),y=ke(u),c=yield x("previewTemplateAriaLabel",l||s),v=o+"-"+t+"-"+r+"-"+(n&&JSON.stringify(n.toJSON()))+"-"+y,L=this._dotDensityUrlCache,C=L.has(v)?L.get(v):dt(e,t,{ariaLabel:c});L.set(v,C);let F={shape:{type:"image",x:0,y:0,width:C.width,height:C.height,src:C.src},fill:null,stroke:null,offset:[0,0]},T=st([[F]],[C.width,C.height],{effectView:this.effectList,ariaLabel:c});return{opacity:1,src:C.src,preview:T,width:C.width,height:C.height}})}_constructDotDensityRendererLegendElements(e){return m(this,null,function*(){let i=e.calculateDotValue(this.view.scale),t=e.legendOptions?.unit,l={type:"symbol-table",title:{value:i&&Math.round(i),unit:t||""},infos:[]};for(let s of e.attributes){let r=yield this._getElementInfoForDotDensity(e,s);r.label=s.label||s.valueExpressionTitle||s.field,l.infos.push(r)}return[l]})}_constructPieChartRendererLegendElements(e){return m(this,null,function*(){let i=this.layer.opacity,t=[],l=null,s=e.outline;e.attributes.forEach(a=>{let u=new q({color:a.color,outline:s}),y=a.label||a.valueExpressionTitle||a.field;t.push({label:y,symbol:u})});let r=t.length?[...t]:[];if(e.othersCategory?.color&&e.othersCategory?.threshold!==0){let a=new q({color:e.othersCategory.color,outline:s});l=e.othersCategory.label||"Other",t.push({label:l,symbol:a})}if(e.defaultColor?.a){let a=new q({color:e.defaultColor,outline:s});t.push({label:e.defaultLabel,symbol:a})}let n=(yield this._getVisualVariableLegendElements(e,this.layer))||[];if(t.length){n.unshift({type:"symbol-table",title:null,infos:t});let a=r.filter(y=>y.label!==l).map(y=>y.symbol.color).filter(Boolean),u=yt(a,{holePercentage:e.holePercentage,backgroundColor:e.backgroundFillSymbol?.color,effectList:this.effectList,outline:s,ariaLabel:yield x("previewPieChartAriaLabel")});n.unshift({type:"pie-chart-ramp",title:this._getRendererTitle(e,this.layer),infos:t,preview:u})}let o=n.reduce((a,u)=>[...a,...this._getAllInfos(u)],[]).filter(a=>!!a?.symbol&&!a?.preview).map(a=>this._getSymbolPreview(a,i,{effectList:this.effectList}));return yield Promise.allSettled(o),n})}_getWhereClause(e,i,t){return m(this,null,function*(){let l=yield Be(e,t),s=yield We(i,t),r=new Set(s.map(o=>o.toLowerCase()));return l?.fieldNames.map(o=>o.toLowerCase())?.some(o=>!r.has(o))?null:l})}_processDefinitionExpression(e,i){return m(this,null,function*(){if(!("definitionExpression"in e))return;let t=e.definitionExpression;t&&this.respectLayerDefinitionExpression?this._layerDefinitionExpression!==t&&(this._layerDefinitionExpressionClause=yield this._getWhereClause(t,i,e.fieldsIndex)):this._layerDefinitionExpressionClause=null,this._layerDefinitionExpression=t})}_processDisplayFilter(e,i){return m(this,null,function*(){if(!("displayFilterInfo"in e))return;let t=e.displayFilterInfo?Ne(e.displayFilterInfo,this.view):null;return t?.where?this._layerDisplayFilterId!==t?.id&&(this._layerDisplayFilterClause=yield this._getWhereClause(t.where,i,e.fieldsIndex)):this._layerDisplayFilterClause=null,this._layerDisplayFilterId=t?.id,t})}_constructRendererLegendElements(t){return m(this,arguments,function*(e,i={}){let{title:l,sublayer:s}=i,r=s||this.layer,n=ce(e),o=null;A(e)&&(yield this._processDefinitionExpression(r,e),o=yield this._processDisplayFilter(r,e)),this._hasColorRamp=!1,this._hasOpacityRamp=!1,this._hasSizeRamp=!1,this._scaleDrivenSizeVariable=null;let a=(yield this._getVisualVariableLegendElements(e,r))||[],u={type:"symbol-table",title:l||this._getRendererTitle(e,r),infos:[]},y=null,c=!1,v=new Set;if(me(e)&&!this._hasSizeRamp){let d=yield Ke(e);u.infos.push({label:null,symbol:d})}else if($t(e)){let d=l,h=Wt(e)?"univariate-above-and-below-ramp":"univariate-color-size-ramp",f=a.findIndex(R=>R.type==="color-ramp"),b=f!==-1?a.splice(f,1)[0]:null,p=a.findIndex(R=>R.type==="size-ramp"),E=p!==-1?a.splice(p,1)[0]:null,S=[];b&&(d=b.title,S.push(b)),E&&(d=E.title,S.push(E)),S.length>0&&a.push({type:h,title:d,infos:S})}else if(Ct(e)){let d=it(e);a.push({type:"heatmap-ramp",title:l||this._getRendererTitle(e,r),infos:d,preview:O(d.map(h=>h.color),{effectList:this.effectList,ariaLabel:yield x("previewColorRampAriaLabel")})})}else if(A(e)){let d=e.authoringInfo;if(d&&d.type==="relationship"){let{numClasses:h,field1:f,field2:b}=d,p=d.focus;if(h&&f&&b){let E=[f,b],S=nt(p)||0;for(let P of E){let{field:z,normalizationField:D,label:G}=P,Q=G||{field:this._getFieldAlias(z,r),normField:D&&this._getFieldAlias(D,r)},k=Gt.clone();k.angle=S,u.infos.push({label:Q,symbol:k}),v.add(k),S+=90}let R=rt({focus:p,numClasses:h,infos:e.uniqueValueInfos??[]});a.unshift(R)}}else if($(this.layer)||ee(this.layer))e.uniqueValueInfos?.forEach(h=>{h.symbol&&this._checkClausesForUVR(e,h.value)&&u.infos.push({label:h.label||h.value,value:h.value,symbol:h.symbol})});else{let{field:h,field2:f,field3:b,fieldDelimiter:p,valueExpression:E,defaultSymbol:S}=e,R=!(!h&&!E||!f&&!b),P=this._layerDisplayFilterClause?o?.title:null,z=[];if(e.uniqueValueGroups?.forEach(D=>{let G={type:"symbol-table",title:P||D.heading,infos:[]};D.classes?.forEach(Q=>{let{symbol:k,values:Ft}=Q;if(k){let ie=[],be=[];for(let B of Ft??[]){let{value:_e,value2:we,value3:ve}=B,j=[],Z=[];(h||E)&&(j.push(_e),Z.push(this._getDomainName(h,_e,r))),f&&(j.push(we),Z.push(this._getDomainName(f,we,r))),b&&(j.push(ve),Z.push(this._getDomainName(b,ve,r))),ie.push(R?j.join(p||""):j[0]),be.push(Z.join(" - "))}let Se=ie.join(", "),le=Q.label;if(!le){let B=be.filter(Boolean);le=B.length?B.join(", "):Se}let se=k.clone();se.type==="cim"&&n&&at(se,{innerDotSize:.5*gt,outerRingSize:gt}),ie.some(B=>this._checkClausesForUVR(e,B))&&G.infos.push({label:le,value:Se,symbol:se})}}),G.infos.length&&z.push(G)}),z.length){let D=z[0];z.length===1&&"title"in D&&!D.title?u.infos.push(...D.infos??[]):(S&&(z.push({type:"symbol-table",infos:[{label:e.defaultLabel||"others",symbol:S}]}),c=!0),u.infos.push(...z)),l||e.legendOptions?.title||e.valueExpressionTitle||(u.title=null)}}e.defaultSymbol&&!c&&(u.infos.push({label:e.defaultLabel||"others",symbol:e.defaultSymbol}),c=!0)}else if(M(e)){if(!n){if(y=this._isUnclassedRenderer(e),!y||!this._hasSizeRamp){let d=e.classBreakInfos.filter(({symbol:f})=>f),h=e.legendOptions?.order==="ascending-values";for(let{label:f,minValue:b,maxValue:p,symbol:E}of d){let S={label:f||(y?null:`${b} - ${p}`),value:[b,p],symbol:E};h?u.infos.push(S):u.infos.unshift(S)}y&&(u.title=null),this._updateInfosForClassedSizeRenderer(e,u.infos)}e.defaultSymbol&&!y&&(u.infos.push({label:e.defaultLabel||"others",symbol:e.defaultSymbol}),c=!0)}}else if(vt(e))if(ee(this.layer)||Ht(this.layer)){let d=yield this._constructTileImageryStretchRendererElements(e);qt(d)?a.push(d):u.infos=d}else{let d=this.layer,h,f;e.customStatistics?.length&&({min:h,max:f}=e.customStatistics[0]);let b=[],p=d.serviceRasterInfo;if(d.rasterFunction)try{p=yield d.generateRasterInfo(d.rasterFunction)}catch{}let E=oe(p.pixelType);if(p.bandCount===1){let S=d.bandIds?.[0]||0;h=h??(p.statistics?p.statistics[S].min:E[0]),f=f??(p.statistics?p.statistics[S].max:E[1]),h||f?a.push(yield this._getStretchLegendElements(e,{min:h,max:f})):this._getServerSideLegend()}else if(d.bandIds&&d.bandIds.length===1)h=h??(p.statistics?p.statistics[d.bandIds[0]].min:E[0]),f=f??(p.statistics?p.statistics[d.bandIds[0]].max:E[1]),h||f?a.push(yield this._getStretchLegendElements(e,{min:h,max:f})):this._getServerSideLegend();else if(p.bandCount>=3){let{bandInfos:S}=p,{bandIds:R}=d;S.length>=p.bandCount?R?.length===3?(b=R.map(P=>S[P].name),u.infos=this._createSymbolTableElementMultiBand(b)):d.format==="lerc"?(b=[0,1,2].map(P=>S[P].name),u.infos=this._createSymbolTableElementMultiBand(b)):this._getServerSideLegend():d.format==="lerc"?(b=["band1","band2","band3"],u.infos=this._createSymbolTableElementMultiBand(b)):this._getServerSideLegend()}else this._getServerSideLegend()}else if(wt(e))e.colormapInfos.forEach(d=>{u.infos.push({label:d.label,value:d.value,symbol:this._getAppliedCloneSymbol(Tt,d.color)})});else if(U(e)){let d=e.symbol;switch(i.geometryType){case"point":d="pointSymbol"in r?r.pointSymbol:null;break;case"polyline":d="lineSymbol"in r?r.lineSymbol:null;break;case"polygon":d="polygonSymbol"in r?r.polygonSymbol:null}let h=this._hasClusterSizeVariable&&this._getClusterSymbol()||!this._hasSizeRamp;e.symbol&&h&&u.infos.push({label:e.label,symbol:d})}else if(_t(e)){e.outputUnit&&(this.title="("+e.toJSON().outputUnit+")"),u.title=e.attributeField;let d=e.getClassBreakInfos();d?.length?d.forEach(h=>{u.infos.push({label:h.minValue+" - "+h.maxValue,symbol:h.symbol})}):u.infos.push({label:e.attributeField,symbol:e.getDefaultSymbol()})}else Lt(e)&&a.push(yield this._getStretchLegendElements(e,{min:0,max:255}));let L=e.defaultSymbol;!L||c||U(e)||y&&!this._hasColorRamp&&!this._hasSizeRamp&&!this._hasOpacityRamp||a.push({type:"symbol-table",infos:[{label:e.defaultLabel||"others",symbol:L}]}),u.infos.length&&a.unshift(u);let C=i.opacity==null?this.opacity:i.opacity,F=this._isTallSymbol("visualVariables"in e?e.visualVariables:null),T=$(this.layer)||ee(this.layer),te=a.reduce((d,h)=>[...d,...this._getAllInfos(h)],[]).filter(d=>!!d?.symbol).filter(d=>{if(d.symbol.type==="cim"){let{minScale:h,maxScale:f}=d.symbol.data;if(h&&h<this.scale||f&&f>this.scale)return!1}return!0}).map(d=>this._getSymbolPreview(d,C,{isDefault:d.symbol===L,applyScaleDrivenSize:!v.has(d.symbol),symbolConfig:{isTall:F,isSquareFill:T},effectList:v.has(d.symbol)?null:this.effectList}));return e=null,yield Promise.allSettled(te),a})}_checkClausesForUVR(e,i){let t=Ut(e,i);return!t||(!this._layerDefinitionExpressionClause||this._layerDefinitionExpressionClause.testFeature(t))&&(!this._layerDisplayFilterClause||this._layerDisplayFilterClause.testFeature(t))}_getServerSideLegend(){setTimeout(()=>this.buildLegendElementsForTools(),0)}_getAllInfos(e){let i=e?.infos;return i?i.reduce((t,l)=>t.concat(this._getAllInfos(l)),[]):[e]}_constructTileImageryStretchRendererElements(e){return m(this,null,function*(){let i=this.layer,t=i.symbolizer.rasterInfo??i.raster.rasterInfo,l,s,r=e?.customStatistics?.length?e.customStatistics:t?.statistics;if(r)({min:l,max:s}=r[0]);else{let o=oe(t.pixelType);l=o[0],s=o[1]}if(i.hasStandardTime()&&(l=i.getStandardTimeValue(l),s=i.getStandardTimeValue(s)),t.bandCount===1||i.bandIds?.length===1)return this._getStretchLegendElements(e,{min:l,max:s});let n=(i?.bandIds?.length?i.bandIds:Array.from(Array(Math.min(t.bandCount,3)).keys())).map(o=>t.bandInfos[o].name);return n.length<3?n.push(n[1]):n.length>3&&n.splice(3),this._createSymbolTableElementMultiBand(n)})}_getStretchLegendElements(e,i){return m(this,null,function*(){let t=e.colorRamp,l=tt(t,i);return{type:"stretch-ramp",title:"",infos:l,preview:O(l.map(s=>s.color),{ariaLabel:yield x("previewColorRampAriaLabel")})}})}_getClusterSymbol(){let e=this.layer,i="featureReduction"in e&&e.featureReduction,t=i&&"symbol"in i&&i.renderer;return t&&t?.authoringInfo?.isAutoGenerated!==!0?null:i&&"symbol"in i?i.symbol:null}_getSizeLegendElement(e,i,t,l){return m(this,null,function*(){return{type:"size-ramp",title:this._hasClusterSizeVariable?this._getClusterTitle(i):e,infos:yield ct(t,i,yield ue(t),this.scale,this.view,l,this._hasClusterSizeVariable?this._getClusterSymbol():null)}})}_createSymbolTableElementMultiBand(e){let i=[],t=["red","green","blue"];return e.forEach((l,s)=>{i.push({label:{colorName:t[s],bandName:l},src:Ze[s],opacity:this.opacity??1})}),i}_updateInfosForClassedSizeRenderer(e,i){let t=e.authoringInfo&&e.authoringInfo.type==="class-breaks-size",l=e.classBreakInfos.some(s=>Ge(s.symbol));if(t&&l){let s=ot,r=ut,n=e.classBreakInfos.length,o=(s-r)/(n>1?n-1:n);i.forEach((a,u)=>{a.size=s-o*u})}}_isTallSymbol(e){let i=!1,t=!1;if(e)for(let l=0;l<e.length&&(!i||!t);l++){let s=e[l];s.type==="size"&&(s.axis==="height"&&(i=!0),s.axis==="width-and-depth"&&(t=!0))}return i&&t}_getSymbolPreview(e,i,t){return m(this,null,function*(){let l=!t?.isDefault&&e.size==null&&this._hasSizeRamp?Ae(lt.size):e.size;if(this._scaleDrivenSizeVariable&&t?.applyScaleDrivenSize){let{getSize:r}=yield import("./chunk-R45N3IFT.js");l=r(this._scaleDrivenSizeVariable,null,{view:this.view.type,scale:this.scale,shape:e.symbol.type==="simple-marker"?e.symbol.style:null})}let s=!t?.isDefault&&this._hasSizeRamp||!(!this._scaleDrivenSizeVariable||!t?.applyScaleDrivenSize);return ht(e.symbol,{size:l,opacity:i,scale:!1,symbolConfig:t?.symbolConfig,effectView:t?.effectList,style:"legend",cimOptions:{allowScalingUp:s,viewParams:this.isScaleDriven?{viewingMode:this.view?.type==="2d"?"map":this.view?.viewingMode,scale:this.view?.scale}:null},ariaLabel:e.label&&typeof e.label!="string"?null:yield x("previewTemplateAriaLabel",e.label)}).then(r=>(e.preview=r,e)).catch(()=>(e.preview=null,e))})}_getClusterRenderer(e){this._hasClusterSizeVariable=!1;let i="renderer"in this.layer?this.layer.renderer:null,t=e.renderer?.clone()||i?.clone(),l=pt(e,this.layerView,this.view);if(l&&t!=null&&"visualVariables"in t&&!t.visualVariables?.some(r=>r.type==="size"&&r.target!=="outline"&&!X.test(r.valueExpression))){if("clusterMinSize"in e&&"clusterMaxSize"in e){let{clusterMinSize:n,clusterMaxSize:o}=e;l.legendOptions=new He({showLegend:n!==o})}let r=t.visualVariables||[];t.visualVariables=r.concat([l]),this._hasClusterSizeVariable=!0}return t}_loadRenderer(e){return m(this,null,function*(){let i=[],t=e.clone(),l=yield ue(t);if(M(t)||A(t)){let s=(t.classBreakInfos||t.uniqueValueInfos).map(r=>this._fetchSymbol(r.symbol,l).then(n=>{r.symbol=n}).catch(()=>{r.symbol=null}));Array.prototype.push.apply(i,s)}return i.push(this._fetchSymbol(t.symbol||t.defaultSymbol,t.defaultSymbol?null:l).then(s=>{this._applySymbolToRenderer(t,s,U(t))}).catch(()=>{this._applySymbolToRenderer(t,null,U(t))})),yield Promise.allSettled(i),t})}_applySymbolToRenderer(e,i,t){t?e.symbol=i:e.defaultSymbol=i}_fetchSymbol(e,i){return m(this,null,function*(){if(!e)throw new Error;if(e.type==="web-style"){let t=this._webStyleSymbolCache;try{let l=yield this.view.type==="2d"?e.fetchCIMSymbol({cache:t}):e.fetchSymbol({cache:t});return this._getAppliedCloneSymbol(l,i)}catch{throw V.getLogger(this).warn("Fetching web-style failed!"),new Error}}return this._getAppliedCloneSymbol(e,i)})}_getAppliedCloneSymbol(e,i){if(!e||!i)return e;let t=e.clone(),l=i&&i.toRgba();return t.type.includes("3d")?this._applyColorTo3dSymbol(t,l):t.type==="cim"?Ue(t,i):t.color&&(t.color=new ne(l||t.color)),t}_applyColorTo3dSymbol(e,i){i&&e.symbolLayers.forEach(t=>{t&&(t.material||(t.material={}),t.material.color=new ne(i))})}_getVisualVariableLegendElements(e,i){return m(this,null,function*(){if(!("visualVariables"in e)||e.type==="vector-field")return null;let t=e.visualVariables??[],l=[],s=[],r=[],n=ce(e);if(n?.sizeStops?.length===2&&(M(e)||A(e))){let[c,v]=n.sizeStops;s.push(new K({field:n.field??void 0,normalizationField:n.normalizationField,minSize:c.size,maxSize:v.size,minDataValue:c.value,maxDataValue:v.value}))}for(let c of t)c.type==="color"?l.push(c):c.type==="size"?s.push(c):c.type==="opacity"&&r.push(c);let o=[...l,...s,...r],a,u;if(l.length===0&&M(e)&&e.classBreakInfos&&e.classBreakInfos.length===1){let c=e.classBreakInfos[0];a=c&&c.symbol}if(l.length===0&&U(e)&&(a=e.symbol),a)if(a.type.includes("3d")){let c=a.symbolLayers.at(0);c.type==="water"?c.color!=null&&(u=c.color):c.material?.color!=null&&(u=c.material.color)}else a.url||(u=a.color);let y=this.effectList;return(yield Promise.all(o.map(c=>m(this,null,function*(){if(!c.legendOptions||c.legendOptions.showLegend!==!1){let v=me(e)?c.field:this._getRampTitle(c,i),L=null,C=Xe(i,c,this.view.timeZone);if(c.type==="color"){let F=(yield de(c,null,C))??[];L={type:"color-ramp",title:v,infos:F,preview:O(F.map(T=>T.color),{effectList:y,ariaLabel:yield x("previewColorRampAriaLabel")})},this._hasColorRamp||(this._hasColorRamp=F.length>0)}else if(c.type==="size"&&c.target!=="outline")X.test(c.valueExpression)?this._hasClusterSizeVariable||(this._scaleDrivenSizeVariable=c):(L=yield this._getSizeLegendElement(v,c,e,C),this._hasSizeRamp||(this._hasSizeRamp=!(L.infos==null||!L.infos.length)));else if(c.type==="opacity"){let F=(yield de(c,u,C))??[];L={type:"opacity-ramp",title:v,infos:F,preview:O(F.map(T=>T.color),{effectList:y,ariaLabel:yield x("previewColorRampAriaLabel")})},this._hasOpacityRamp||(this._hasOpacityRamp=F.length>0)}return L?.infos?L:null}})))).filter(N)})}_getDomainName(e,i,t){if(e&&typeof e!="function"){let l="getField"in t&&t.getField?.(e),s=l&&"getFieldDomain"in t&&t.getFieldDomain?t.getFieldDomain(l.name,{excludeImpliedDomains:Le("esri-widget-legacy-field-domain-calculation")}):null;return s?.type==="coded-value"?s.getName(i):null}return null}_getClusterTitle(e){let i=this.layer,t=e.field;if("featureReduction"in i&&i.featureReduction&&i.featureReduction.type==="cluster"){let l=i.featureReduction,s="popupTemplate"in l&&l.popupTemplate,r=s&&s.fieldInfos;if(r){for(let n of r)if(n.fieldName===t)return t==="cluster_count"?n.label||{showCount:!0}:n.label}}return{showCount:!0}}_getRampTitle(e,i){let t=e.field,l=e.normalizationField,s=!1,r=!1,n=!1,o=null;t=typeof t=="function"?null:t,l=typeof l=="function"?null:l;let a=e.legendOptions?.title;if(a!=null)o=a;else if(e.valueExpressionTitle)o=e.valueExpressionTitle;else{if("renderer"in i&&i.renderer&&"authoringInfo"in i.renderer&&i.renderer.authoringInfo?.visualVariables){let u=i.renderer.authoringInfo.visualVariables;for(let y=0;y<u.length;y++){let c=u[y];if(c.type==="color"){if(c.style==="ratio"){s=!0;break}if(c.style==="percent"){r=!0;break}if(c.style==="percent-of-total"){n=!0;break}}}}o={field:t&&this._getFieldAlias(t,i),normField:l&&this._getFieldAlias(l,i),ratio:s,ratioPercent:r,ratioPercentTotal:n}}return o}_getRendererTitle(e,i){let t=e;if(t.legendOptions?.title)return t.legendOptions.title;if(t.valueExpressionTitle)return t.valueExpressionTitle;let l=t.field,s=null,r=null;if(M(t)&&(s=t.normalizationField,r=t.normalizationType==="percent-of-total"),l=typeof l=="function"?null:l,s=typeof s=="function"?null:s,A(t)){let{field2:o,field3:a,fieldDelimiter:u}=t,y=l&&this._getFieldAlias(l,i);return o&&(y=`<${y}>${u}<${this._getFieldAlias(o,i)}>`,a&&(y=`${y}${u}<${this._getFieldAlias(a,i)}>`)),y}let n=null;return(l||s)&&(n={field:l&&this._getFieldAlias(l,i),normField:s&&this._getFieldAlias(s,i),normByPct:r}),n}_getFieldAlias(e,i){let s=("popupTemplate"in i?i.popupTemplate:null)?.fieldInfos?.find(y=>e===y.fieldName),r=null;"getField"in i&&i.getField?r=i.getField(e):"fieldsIndex"in i&&i.fieldsIndex&&(r=i.fieldsIndex.get(e));let n=null,o="featureReduction"in i&&i.featureReduction;o&&(s??="popupTemplate"in o?o.popupTemplate?.fieldInfos?.find(y=>e?.toLowerCase()===y.fieldName?.toLowerCase()):void 0,"fields"in o&&o.fields&&(n=o.fields.find(y=>y.name?.toLowerCase()===e?.toLowerCase())));let a=s||r||n,u=null;return a&&(u=s?.label||r?.alias||n?.alias||"name"in a&&a.name||"fieldName"in a&&a.fieldName||null),u}_isUnclassedRenderer(e){let i=e.visualVariables,t=!1;return M(e)&&e.classBreakInfos&&e.classBreakInfos.length===1&&i&&(t=e.field?i.some(l=>!(!l||e.field!==l.field||(e.normalizationField||l.normalizationField)&&e.normalizationField!==l.normalizationField)):!!i.length),t}};_([w()],g.prototype,"children",void 0),_([w({readOnly:!0})],g.prototype,"effectList",null),_([w()],g.prototype,"layerView",void 0),_([w()],g.prototype,"layer",void 0),_([w()],g.prototype,"legendElements",void 0),_([w({readOnly:!0})],g.prototype,"opacity",null),_([w()],g.prototype,"parent",void 0),_([w({readOnly:!0,dependsOn:[]})],g.prototype,"ready",null),_([w()],g.prototype,"hideLayersNotInCurrentView",void 0),_([w()],g.prototype,"keepCacheOnDestroy",void 0),_([w()],g.prototype,"respectLayerDefinitionExpression",void 0),_([w()],g.prototype,"respectLayerVisibility",void 0),_([w({readOnly:!0})],g.prototype,"scale",null),_([w()],g.prototype,"sublayerIds",void 0),_([w({readOnly:!0})],g.prototype,"isScaleDriven",null),_([w()],g.prototype,"title",void 0),_([w({readOnly:!0,dependsOn:["ready"],value:0})],g.prototype,"version",null),_([w()],g.prototype,"view",void 0),g=_([Ee("esri.widgets.Legend.support.ActiveLayerInfo")],g);var qi=g;export{qi as a};
