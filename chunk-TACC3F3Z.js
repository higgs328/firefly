import{a as io,c as no}from"./chunk-JOJ5MHAJ.js";import{c as Xt}from"./chunk-YHYXMWMO.js";import{n as $t,s as eo,t as to,v as Xe,z as oo}from"./chunk-5UAVTNPR.js";import{a as ro,c as so}from"./chunk-SNBZ4X5J.js";import{a as Kt,m as Zt}from"./chunk-IGGGB3TP.js";import{a as Qt,f as Je,i as Yt,q as Jt}from"./chunk-EB24NRSQ.js";import{a as Wt}from"./chunk-6ZTUPVYX.js";import{a as jt}from"./chunk-2I3LIA7G.js";import{a as Ee,g as qt}from"./chunk-MRKUOXYW.js";import{a as zt}from"./chunk-2GLWK7ZW.js";import{a as Vt}from"./chunk-CX3G2QWN.js";import{b as Ye}from"./chunk-HH3C3QEN.js";import{c as ae}from"./chunk-2XTO2IAR.js";import{a as Ht}from"./chunk-7WCQBAQY.js";import{a as be,b as Se}from"./chunk-T5UBLAP4.js";import{l as xe,m as Ce}from"./chunk-DA3NC6W4.js";import{a as Bt}from"./chunk-YHRLMRSO.js";import{b as ne}from"./chunk-KPT44MCK.js";import{a as Ut}from"./chunk-XKFJ6GWH.js";import{b as kt}from"./chunk-L7NOU4T2.js";import{a as we}from"./chunk-IRQF7UTO.js";import{a as q,b as j}from"./chunk-3KOZOOEP.js";import{b as Gt}from"./chunk-7DIV5AMU.js";import{b as Lt}from"./chunk-EDOVNTC7.js";import{b as F}from"./chunk-YQNUGDFH.js";import{a as _e}from"./chunk-QCZ3ZIGQ.js";import{a as Nt,c as Ze,d as Qe}from"./chunk-IHOR6VMF.js";import{a as oe}from"./chunk-HBZAOVHW.js";import{a as Ae}from"./chunk-ONYJLWAD.js";import{a as vt,b as Ve}from"./chunk-G27DRLGO.js";import{a as I,c as U,d as St,f as wt,y as Et}from"./chunk-GJ2QRXGN.js";import{a as It,b as Mt}from"./chunk-MSDJIYGD.js";import{b as te,e as fe}from"./chunk-5L2EJ5RT.js";import{a as P}from"./chunk-RWCIDBNQ.js";import{a as je,b as We,f as Ke,i as ie,j as z,r as Tt}from"./chunk-HM5RIVQC.js";import{b as ye}from"./chunk-XIZXEWWA.js";import{b as ge}from"./chunk-EO2H4LIH.js";import{q as Dt}from"./chunk-DJW5LMRG.js";import{a as Ft}from"./chunk-DEH76MSI.js";import{a as H}from"./chunk-ALWV3RJ2.js";import{G as qe,b as Rt,c as V,e as ze,m as Ot,u as ee,w as He,y as se}from"./chunk-6B5XFA6F.js";import{k as Pt}from"./chunk-57VFBGF3.js";import{h as Ct}from"./chunk-RNC4P66O.js";import{a as xt}from"./chunk-BCREO4Q5.js";import{e as _t,f as bt}from"./chunk-ZTOZWLEE.js";import{a as E,b as gt,e as yt,i as At}from"./chunk-BOVYXYHK.js";import{m as ft}from"./chunk-ZQIC5NFT.js";import{c as dt}from"./chunk-VIEK2X23.js";import{aa as ut}from"./chunk-NJWTSROP.js";import{a as ke,k as Ue}from"./chunk-TG45K3WR.js";import{b as Be}from"./chunk-ACP3S2CH.js";import{a as v}from"./chunk-QGVBCWUY.js";import{H as ht}from"./chunk-MYO4NP2N.js";import{e as T}from"./chunk-NFIPKH6V.js";import{l as $}from"./chunk-5QEXLALV.js";import{b as Ge}from"./chunk-4PTIEWMT.js";import{b as mt}from"./chunk-YOFFGXOB.js";import{b as de}from"./chunk-2LI2GKBQ.js";import{a as J,b as X,f as Le}from"./chunk-VTHXE323.js";function Zo(e,t,o){let s=(t.length>0?t[0]:e.length/3)-1,r=Nt(e,s,o);if(r!==xt.Z){e=e.slice();for(let i=0;i<e.length;i+=3)e[i+r]=e[i+2]}return oe(e,t,3)}function Qo(e){let t=[[P.POSITION,new F(e.attributeData.position,e.indices,3,!0)]],o=fe(e.indices.length);return e.attributeData.colorFeature!=null?t.push([P.COLORFEATUREATTRIBUTE,new F([e.attributeData.colorFeature],o,1,!0)]):e.attributeData.color&&t.push([P.COLOR,new F(e.attributeData.color,o,4,!0)]),e.attributeData.uvMapSpace&&t.push([P.UVMAPSPACE,new F(e.attributeData.uvMapSpace,e.indices,4,!0)]),e.attributeData.boundingRect&&t.push([P.BOUNDINGRECT,new F(e.attributeData.boundingRect,e.indices,9,!0)]),new ae(e.material,t,e.mapPositions,ne.Mesh,e.attributeData.objectAndLayerIdColor)}function Yo(e,t=null){let o=[[P.POSITION,new F(e.attributeData.position,e.indices,3,!0)],[P.UV0,new F(e.attributeData.uv0,e.indices,2,!0)]];return new ae(e.material,o,e.mapPositions,ne.Mesh,t)}function co(e){switch(e.type){case"extent":if(e instanceof ft)return Ct.fromExtent(e);break;case"polygon":return e}return null}var ao=class{constructor(t,o,s){this.renderData=t,this.layerUid=o,this.graphicUid=s,this.outGeometries=new Array}};function ve(e,t,o,s){let r=Ze(e.rings,!!e.hasZ&&s.mode!=="on-the-ground",Qe.CCW_IS_HOLE,e.spatialReference),i=I(r.position.length),n=Qt(r.position,e.spatialReference,0,i,0,r.position,0,r.position.length/3,t,o,s),c=n!=null;return new tt(r.position,i,po(r.polygons,r.position,i),lo(r.outlines,r.position,i),c,n)}function rr(e,t){let o=Ze(e.rings,!1,Qe.CCW_IS_HOLE),s=Pt(o.position,e.spatialReference,0,o.position,t,0);for(let r=2;r<o.position.length;r+=3)o.position[r]=Zt;return{position:o.position,polygons:po(o.polygons,o.position),outlines:lo(o.outlines,o.position),projectionSuccess:s}}function lo(e,t,o=null){return e.filter(({count:s})=>s>1).map(({index:s,count:r})=>{let i=3*s,n=3*r;return o!=null?new Pe(s,r,U(t,i,n),U(o,i,n)):new ce(s,r,U(t,i,n))})}function po(e,t,o=null){let s=new Array;for(let{index:r,count:i,holeIndices:n,pathLengths:c}of e){if(i<=1)continue;let a=3*r,u=3*i,d=n.map(g=>g-r),b=o!=null?new $e(r,i,U(t,3*r,3*i),U(o,a,u),d,c):new et(r,i,U(t,3*r,3*i),d,c);s.push(b)}return s}var ce=class{constructor(t,o,s){this.index=t,this.count=o,this.position=s}},Pe=class extends ce{constructor(t,o,s,r){super(t,o,s),this.mapPositions=r}},$e=class extends Pe{constructor(t,o,s,r,i,n){super(t,o,s,r),this.holeIndices=i,this.pathLengths=n}},et=class extends ce{constructor(t,o,s,r,i){super(t,o,s),this.holeIndices=r,this.pathLengths=i}},tt=class{constructor(t,o,s,r,i,n){this.position=t,this.mapPositions=o,this.polygons=s,this.outlines=r,this.projectionSuccess=i,this.sampledElevation=n}};var Po=["polygon","extent"],mo=class extends oo{constructor(t,o,s,r){super(t,o,s,r),this.ensureDrapedStatus(!1)}doLoad(){return Le(this,null,function*(){if(!this._drivenProperties.size){let u=qt(this._getSymbolSize());if(u)throw new mt("graphics3dextrudesymbollayer:invalid-size",u)}let t=this.symbolLayer?.material?.color,o=this._getCombinedOpacityAndColor(t),s=yt(o),r=o[3],i=r<1||this.needsDrivenTransparentPass,n=this.symbolLayer?.material?.emissiveFactor,c=n?Ot(gt(n)):At,a={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,diffuse:s,ambient:s,opacity:r,transparent:i,cullFace:i?Ae.None:Ae.Back,hasVertexColors:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,emissiveFactor:c,offsetTransparentBackfaces:!0,normalType:Lt.Compressed};this._materials[D.Main]=new Ye(a,this._context),this._materials[D.Bottom]=new Ye(X(J({},a),{cullFace:Ae.Back}),this._context),this._context.stage.addMany(this._materials)})}destroy(){super.destroy(),this._context.stage.removeMany(this._materials),this._materials.length=0}createGraphics3DGraphic(t){let o=t.graphic;if(!this._validateGeometry(o.geometry,Po,this.symbolLayer.type))return null;let s=this._getVertexOpacityAndColor(t.renderingInfo,255),r=this.setGraphicElevationContext(o);return this._createAs3DShape(o,t.renderingInfo,s,r,o.uid)}layerOpacityChanged(t,o){let s=this.symbolLayer?.material?.color,r=this._getCombinedOpacity(s),i=r<1||this.needsDrivenTransparentPass;this._materials[D.Main]?.setParameters({opacity:r,transparent:i}),this._materials[D.Bottom]?.setParameters({opacity:r,transparent:i});let n=this._getLayerOpacity();t.forEach(c=>o(c)?.layerOpacityChanged(n,this._context.isAsync))}layerElevationInfoChanged(t,o){return this.updateGraphics3DGraphicElevationInfo(t,o,Je)}slicePlaneEnabledChanged(t,o){return this._materials[D.Main]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),this._materials[D.Bottom]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),t.forEach(s=>{let r=o(s);r?.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)}),!0}physicalBasedRenderingChanged(){let t={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0};return this._materials[D.Main]?.setParameters(t),this._materials[D.Bottom]?.setParameters(t),!0}_getExtrusionSize(t){let o;return o=t.size&&this._drivenProperties.size?Xt(t.size,2)??0:this._getSymbolSize(),o/=this._context.renderCoordsHelper.unitInMeters,o}applyRendererDiff(t,o){return this._drivenPropertiesChanged(o)?Xe.RecreateSymbol:Xe.RecreateGraphics}queryForSnapping(t,o,s,r){return Le(this,null,function*(){let i=this._getExtrusionSize(s)*this._context.renderCoordsHelper.unitInMeters/ut(o),{objectId:n,target:c}=t,a=de(c);switch(a.z=(a.z??0)+i,t.type){case"edge":{let{start:u,end:d}=t,b=de(u),g=de(d);return b.z=(b.z??0)+i,g.z=(g.z??0)+i,[Ve(n,a,1/0,b,g)]}case"vertex":return[vt(n,a,1/0),Ve(n,c,1/0,c,a)];default:return[]}})}_getSymbolSize(){return this.symbolLayer.size??1}_createAs3DShape(t,o,s,r,i){let n=co(t.geometry);if(n==null)return null;if(n.rings.length===0||!n.rings.some(O=>O.length>0))return this._logGeometryValidationWarnings(n.rings,"rings","ExtrudeSymbol3DLayer"),null;let c=ve(n,this._context.elevationProvider,this._context.renderCoordsHelper,r);this._logGeometryCreationWarnings(c,n.rings,"rings","ExtrudeSymbol3DLayer");let a=Ee(n);if(a==null)return null;let u=new Array,d=new Array,b=St(),g=H(),x=E(),p=this._context.renderCoordsHelper.viewingMode===_e.Global;p||this._context.renderCoordsHelper.worldUpAtPosition(null,x),ge(n.spatialReference,[a.x,a.y,0],g,this._context.renderCoordsHelper.spatialReference);let y=H();bt(y,g);let A=Ft();Dt(A,y);let{polygons:f,mapPositions:h,position:_}=c,m=new Map,C=this._materials[D.Main];for(let O of f){let L=O.count;if(this._context.clippingExtent&&(wt(O.mapPositions,b),!Et(b,this._context.clippingExtent)))continue;let G=oe(O.mapPositions,O.holeIndices,3);if(G.length===0)continue;let B=G.length,k=6*L,Me=te(k+B),De=te(B),ue=I(3*k),nt=I(3*k),at=I(3*k),ct=I(k);it(_,h,G,O,ue,at,nt,ct,Me,De,this._getExtrusionSize(o),x,p),ye(ue,ue,y);let lt=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:i,layerUid:this._context.layer.uid}),Fe=new rt(ue,at,Mt(nt),ct),Ne=ho(C,Me,Me.length-De.length,Fe,s,lt),So=L,wo=L,Eo=2*O.count,pt=new st(So,wo,Eo,B/3);xo(Ne,pt,g),m.set(Ne,pt),u.push(Ne,ho(this._materials[D.Bottom],De,0,Fe,s,lt)),d.push(Fe.heights)}if(u.length===0)return null;let l=new Wt({geometries:u,layerUid:this._context.layer.uid,graphicUid:i,isElevationSource:!0});l.transformation=g;let S=Gt(this.symbolLayer,{opacity:this._getLayerOpacity()}),w=S?new eo(this._materials[D.Main],S,this._context.slicePlaneEnabled):null,N=new to(this,l,u,null,null,(O,L,G,B,k)=>Oo(O,L,G,B,k,d,m),r,w);return N.alignedSampledElevation=c.sampledElevation,N.needsElevationUpdates=Je(r.mode),N}};function ho(e,t,o,s,r,i){let n=fe(t.length),c=[[P.POSITION,new F(s.positions,t,3,!0)],[P.NORMALCOMPRESSED,new F(s.normals,t,2,!0)],[P.COLOR,new F(r,n,4,!0)]];return new ae(e,c,s.elevation,ne.Mesh,i,o)}function it(e,t,o,s,r,i,n,c,a,u,d,b,g){{let x=o.length/3,p=2*s.count;vo(e,t,s.index,s.count,o,0,x,r,i,n,c,a,u,p,d,b,g)}{let x=0,p=2*s.count,y=0,A=s.pathLengths[0];uo(r,i,c,n,x,A,s.count,p,a,y,d),p+=4*A,y+=2*A,x+=A;for(let f=1;f<s.pathLengths.length;++f){let h=s.pathLengths[f];uo(r,i,c,n,x,h,s.count,p,a,y,d),p+=4*h,y+=2*h,x+=h}}}function vo(e,t,o,s,r,i,n,c,a,u,d,b,g,x,p,y,A){Rt(M,y);{let f=p>0?1:-1,h=3*o,_=0,m=3*_,C=s,l=3*C;for(let S=0;S<s;++S){let w=e[h],N=e[h+1],O=e[h+2];A&&(M[0]=w,M[1]=N,M[2]=O,ee(M,M)),c[m+0]=w,c[m+1]=N,c[m+2]=O;let L=t[h+0],G=t[h+1],B=t[h+2];a[m+0]=L,a[m+1]=G,a[m+2]=B,u[m+0]=-f*M[0],u[m+1]=-f*M[1],u[m+2]=-f*M[2],d[_]=0,c[l+0]=w+p*M[0],c[l+1]=N+p*M[1],c[l+2]=O+p*M[2],a[l+0]=L,a[l+1]=G,a[l+2]=B,d[C]=p,m+=3,l+=3,h+=3,_+=1,C+=1}}{let f=3*i,h=0,_=3*x,m=p<0?bo:_o,C=p<0?_o:bo;for(let l=0;l<n;++l)g[h]=r[f+m[0]],g[h+1]=r[f+m[1]],g[h+2]=r[f+m[2]],b[_]=r[f+C[0]]+s,b[_+1]=r[f+C[1]]+s,b[_+2]=r[f+C[2]]+s,h+=3,_+=3,f+=3}}function Re(e,t,o,s,r,i,n){s[i]=s[n],n*=3,e[i*=3]=e[n],e[i+1]=e[n+1],e[i+2]=e[n+2],t[i]=t[n],t[i+1]=t[n+1],t[i+2]=t[n+2],o[i]=r[0],o[i+1]=r[1],o[i+2]=r[2]}var le=E();function uo(e,t,o,s,r,i,n,c,a,u,d){let b=r,g=r+1,x=r+n,p=r+n+1,y=c,A=c+1,f=c+2*i,h=c+2*i+1;d<0&&(b=r+n+1,p=r);let _=3*u;for(let m=0;m<i;++m)m===i-1&&(g=r,d>0?p=r+n:b=r+n),Ro(e,b,g,x,le),Re(e,t,s,o,le,y,b),Re(e,t,s,o,le,A,g),Re(e,t,s,o,le,f,x),Re(e,t,s,o,le,h,p),a[_]=y,a[_+1]=f,a[_+2]=h,a[_+3]=y,a[_+4]=h,a[_+5]=A,_+=6,b++,g++,x++,p++,y+=2,A+=2,f+=2,h+=2}var ot=E(),fo=E(),go=E(),yo=E(),Ao=E();function Ro(e,t,o,s,r){t*=3,o*=3,s*=3,V(ot,e[t++],e[t++],e[t++]),V(fo,e[o++],e[o++],e[o++]),V(go,e[s++],e[s++],e[s++]),ze(yo,fo,ot),ze(Ao,go,ot),He(r,Ao,yo),ee(r,r)}var re=E();function Oo(e,t,o,s,r,i,n){let c=e.stageObject,a=c.geometries,u=a.length,d=t.mode!=="absolute-height",b=0,g=c.transformation,x=_t(H(),g);for(let p=0;p<u;p+=2){let y=a[p];if(!$t(y))continue;let A=y.getMutableAttribute(P.POSITION).data,f=i[p/2],h=new jt(y.mapPositions),_=A.length/3,m=!1,C=0;{let l=0;for(let S=0;S<_;S++){re[0]=A[l],re[1]=A[l+1],re[2]=A[l+2],s(h,Oe),d&&(C+=Oe.sampledElevation),Bt.TESTS_DISABLE_OPTIMIZATIONS?(V(R,h.array[h.offset],h.array[h.offset+1],Oe.z+f[l/3]),o!=null&&r.toRenderCoords(R,o,R),se(R,R,x)):(V(R,A[l],A[l+1],A[l+2]),se(R,R,g),r.setAltitude(R,Oe.z+f[l/3]),se(R,R,x)),A[l]=R[0],A[l+1]=R[1],A[l+2]=R[2];let w=To/r.unitInMeters;(Math.abs(re[0]-A[l])>=w||Math.abs(re[1]-A[l+1])>=w||Math.abs(re[2]-A[l+2])>=w)&&(m=!0),h.offset+=3,l+=3}}if(m){let l=n.get(y);l&&xo(y,l,g),c.geometryVertexAttributeUpdated(a[p],P.NORMALCOMPRESSED),y.invalidateBoundingInfo(),c.geometryVertexAttributeUpdated(a[p],P.POSITION),a[p+1].invalidateBoundingInfo(),c.geometryVertexAttributeUpdated(a[p+1],P.POSITION)}b+=C/_}return b/u}function xo(e,t,o){let s=e.getMutableAttribute(P.POSITION),r=e.getMutableAttribute(P.NORMALCOMPRESSED).data,{topVertexStart:i,topVertexCount:n,topFaceStart:c,topFaceCount:a}=t,u=s.data,d=n,b=e.attributes.get(P.POSITION).indices,g=c+a,x=i+n,p=I(3*d);for(let m=0;m<d;++m){let C=3*m;p[C+0]=0,p[C+1]=0,p[C+2]=0}let y=Io,A=Mo,f=Do,h=Fo,_=M;for(let m=c;m<g;++m){let C=3*m;for(let l=0;l<3;++l){let S=b[C+l];h[l]=S;let w=3*S;V(R,u[w+0],u[w+1],u[w+2]),se(y[l],R,o)}qe(A,y[1],y[0]),qe(f,y[2],y[0]),He(_,A,f),ee(_,_);for(let l=0;l<3;++l){let S=3*(h[l]-i);p[S+0]+=_[0],p[S+1]+=_[1],p[S+2]+=_[2]}}for(let m=i;m<x;++m){let C=3*(m-i),l=p[C+0],S=p[C+1],w=p[C+2],N=Math.sqrt(l*l+S*S+w*w);It(r,m,l/N,S/N,w/N)}}var R=E(),M=E(),Oe=new Yt,_o=[0,2,1],bo=[0,1,2],To=.01,Io=[E(),E(),E()],Mo=E(),Do=E(),Fo=[0,0,0],D;(function(e){e[e.Main=0]="Main",e[e.Bottom=1]="Bottom"})(D||(D={}));var rt=class{constructor(t,o,s,r){this.positions=t,this.elevation=o,this.normals=s,this.heights=r}},st=class{constructor(t,o,s,r){this.topVertexStart=t,this.topVertexCount=o,this.topFaceStart=s,this.topFaceCount=r}};var pe=class extends Se{constructor(t,o){super(t,o,new be(so,()=>import("./chunk-6K4GTC22.js")))}initializePipeline(){return Ce({colorWrite:xe})}};var W=class extends we{constructor(e){super(X(J({},e),{view:e.focusAreas.view})),this.consumes={required:[q.COMPOSITE,j.FOCUSAREA]},this.produces=q.COMPOSITE,this._passParameters=new ro}precompile(){this.techniques.precompile(pe)}render(e){let t=this.techniques.get(pe),o=e.find(({name:d})=>d===q.COMPOSITE);if(!t.compiled)return this.requestRender(),o;let s=this.bindParameters,r=s.camera,i=r.fullViewport[2],n=r.fullViewport[3],c=e.find(({name:d})=>d===j.FOCUSAREA),a=this.fboCache.acquire(i,n,this.produces),u=this.renderingContext;return u.gl.clear(u.gl.STENCIL_BUFFER_BIT),u.bindFramebuffer(a.fbo),this._passParameters.color=o.getTexture(),this._passParameters.focusArea=c.getTexture(),this._passParameters.effect=No[this.focusAreas.style],u.bindTechnique(t,s,this._passParameters),u.screen.draw(),a.attachDepth(o.getAttachment(this.gl.DEPTH_STENCIL_ATTACHMENT)),a}},me;v([T()],W.prototype,"consumes",void 0),v([T()],W.prototype,"produces",void 0),v([T({constructOnly:!0})],W.prototype,"focusAreas",void 0),W=v([$("esri.views.3d.webgl-engine.effects.focusArea.FocusAreaColorNode")],W),function(e){e[e.NONE=0]="NONE",e[e.BRIGHT=1]="BRIGHT",e[e.DARK=2]="DARK"}(me||(me={}));var No={none:me.NONE,bright:me.BRIGHT,dark:me.DARK};var he=class extends Se{constructor(t,o){super(t,o,new be(no,()=>import("./chunk-CBOQSH7N.js")))}initializePipeline(){return Ce({colorWrite:xe,depthTest:{func:ie.LEQUAL}})}};var K=class extends we{constructor(e){super(X(J({},e),{view:e.focusAreas.view})),this.consumes={required:[j.FOCUSAREA,q.TRANSPARENT]},this.produces=j.FOCUSAREA,this._vaos=new Array,this._counts=new Array,this._origins=new Array,this._maskParameters=new io}initialize(){this.updateGeometries()}destroy(){this._vaos.forEach(e=>e.dispose()),this._vaos.length=this._counts.length=this._origins.length=0}precompile(){this.techniques.precompile(he)}render(e){let t=this.techniques.get(he),o=this.bindParameters,s=o.camera,r=s.fullViewport[2],i=s.fullViewport[3],n=this.fboCache.acquire(r,i,j.FOCUSAREA,Ht.RGBA);if(!t.compiled||!this._vaos)return this.requestRender(),n;let c=e.find(({name:d})=>d===q.TRANSPARENT),a=this.renderingContext;n.attachDepth(c.getAttachment(this.gl.DEPTH_STENCIL_ATTACHMENT)),a.bindFramebuffer(n.fbo),a.clear(je.COLOR|je.STENCIL),a.setViewport(0,0,r,i),a.gl.clearStencil(0),a.gl.clear(a.gl.STENCIL_BUFFER_BIT),a.setClearStencil(0);let u=a.bindTechnique(t,o);a.setFaceCullingEnabled(!1),a.setStencilTestEnabled(!0),a.setStencilOpSeparate(Ke.FRONT,z.KEEP,z.INCR_WRAP,z.KEEP),a.setStencilOpSeparate(Ke.BACK,z.KEEP,z.DECR_WRAP,z.KEEP),a.setDepthWriteEnabled(!1);for(let d=0;d<this._vaos.length;d++){let b=this._vaos[d],g=this._counts[d];this._maskParameters.origin=this._origins[d],u.bindDraw(o,kt,this._maskParameters),a.bindVAO(b),a.setStencilWriteMask(255),a.setStencilFunction(ie.ALWAYS,0,255),a.setColorMask(!1,!1,!1,!1),a.drawArrays(We.TRIANGLES,0,g),a.setStencilWriteMask(0),a.setStencilFunction(ie.NOTEQUAL,0,255),a.setColorMask(!0,!0,!0,!0),a.drawArrays(We.TRIANGLES,0,g)}return n}updateGeometries(){if(!this.view._stage)return;this._vaos.forEach(t=>t.dispose()),this._vaos.length=this._counts.length=this._origins.length=0;let e=this.focusAreas.geometries;for(let t of e){let o=new Array,s=t.indicesBottom;for(let c=0;c<s.length;c++)o.push(t.positions[3*(s[c]-1)]),o.push(t.positions[3*(s[c]-1)+1]),o.push(t.positions[3*(s[c]-1)+2]);let r=t.indicesExtruded;for(let c=0;c<r.length;c++)o.push(t.positions[3*r[c]]),o.push(t.positions[3*r[c]+1]),o.push(t.positions[3*r[c]+2]);let i=new Float32Array(o),n=new zt(this.renderingContext,Ut,new Map([["geometry",Kt]]),new Map([["geometry",Vt.createVertex(this.renderingContext,Tt.STATIC_DRAW,i)]]));this._vaos.push(n),this._counts.push(s.length+r.length),this._origins.push(t.origin)}this.requestRender()}};v([T()],K.prototype,"consumes",void 0),v([T()],K.prototype,"produces",void 0),v([T({constructOnly:!0})],K.prototype,"focusAreas",void 0),K=v([$("esri.views.3d.webgl-engine.effects.focusArea.FocusAreaMaskNode")],K);var Te=class{constructor(t,o,s,r,i,n){this.positions=t,this.indicesBottom=o,this.indicesExtruded=s,this.height=r,this.origin=i,this.color=n}},Co;(function(e){e[e.NONE=0]="NONE",e[e.BRIGHT=1]="BRIGHT",e[e.DARK=2]="DARK"})(Co||(Co={}));var Z=0,Lo=5e6,Ie=.42,Q=.32;function ci(e,t){if(e){if(t==="bright"){let o=(e[0]+e[1]+e[2])/3;return[o*Q+(1-Q),o*Q+(1-Q),o*Q+(1-Q),e[3]*Q]}return t==="dark"?[e[0]*Ie,e[1]*Ie,e[2]*Ie,e[3]*Ie]:e}}var Y=class extends ht{constructor(e){super(e),this.style="dark",this.geometries=new Array,this._areas=new Be,this._elevationContext=new Jt}initialize(){this.addHandles([ke(()=>this.style,()=>this._updateRenderNodes(),Ue)]),this.addHandles([ke(()=>this.activePolygons,()=>this._updateFocusAreaGeometries(),Ue)])}get activePolygons(){let e=new Be;for(let t of this.areas)if(t.enabled)for(let o of t.geometries)e.push(o);return e}add(e){this.areas.add(e),this._updateFocusAreaGeometries()}addMany(e){this.areas.addMany(e),this._updateFocusAreaGeometries()}remove(e){this.areas.remove(e),this._updateFocusAreaGeometries()}removeMany(e){this.areas.removeMany(e),this._updateFocusAreaGeometries()}removeAll(){this.areas.removeAll(),this._updateFocusAreaGeometries()}containsGeometry(e){let t=!0,o=new dt(e);return t=this.areas.some(s=>!!s.enabled&&!!s?.geometries.length&&s.geometries.some(r=>r.contains(o))),t}get areas(){return this._areas}_updateFocusAreaGeometries(){this._extrudePolygons(),this._updateRenderNodes()}_extrudePolygons(){if(!this.view.renderCoordsHelper)return;this.geometries.length=0;let e=Lo-Z,t=E(),o=this.view.renderCoordsHelper.viewingMode===_e.Global,s=H(),r=H();o||this.view.renderCoordsHelper.worldUpAtPosition([0,0,0],t);for(let i of this.areas)if(i.enabled)for(let n of i.geometries){let c=Ee(n);if(c==null)continue;ge(n.spatialReference,[c.x,c.y,0],s,this.view.renderCoordsHelper.spatialReference);let a=ee(Go,[s[12]-Z*t[0],s[13]-Z*t[1],s[14]-Z*t[2]]);r[12]=-s[12],r[13]=-s[13],r[14]=-s[14];let u=ve(n,this.view.elevationProvider,this.view.renderCoordsHelper,this._elevationContext),{polygons:d,mapPositions:b,position:g}=u;for(let x of d){let p=x.count,y=oe(x.mapPositions,x.holeIndices,3);if(y.length===0)continue;let A=y.length,f=6*p,h=te(f+A),_=te(A),m=I(3*f),C=I(3*f),l=I(3*f),S=I(f);it(g,b,y,x,m,l,C,S,h,_,e,t,o),ye(m,m,r);let w=new Te(m,_,h,e,[s[12]+Z*a[0],s[13]+Z*a[1],s[14]+Z*a[2]],i.outline?.color);this.geometries.push(w)}}this._maskRenderNode?.updateGeometries()}_updateRenderNodes(){this.view._stage&&(this.style==="none"||this.geometries.length===0?(this._maskRenderNode=Ge(this._maskRenderNode),this._colorRenderNode=Ge(this._colorRenderNode)):(this._maskRenderNode??=new K({focusAreas:this}),this._colorRenderNode??=new W({focusAreas:this})))}};v([T()],Y.prototype,"activePolygons",null),v([T()],Y.prototype,"style",void 0),v([T()],Y.prototype,"geometries",void 0),v([T({constructOnly:!0})],Y.prototype,"view",void 0),v([T()],Y.prototype,"_areas",void 0),Y=v([$("esri.views.FocusAreas")],Y);var Go=E();export{Zo as a,Qo as b,Yo as c,co as d,ao as e,ve as f,rr as g,mo as h,ci as i,Y as j};
