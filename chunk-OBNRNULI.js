import{a as J}from"./chunk-7XCNI7SW.js";import"./chunk-W2OKV7PY.js";import"./chunk-S5TVWI2Y.js";import{a as Le}from"./chunk-DQLNXYPP.js";import{a as L}from"./chunk-6LFLOKR6.js";import"./chunk-BGZQG6D3.js";import{a as W}from"./chunk-2CFID6ZR.js";import"./chunk-4PK4ZJM7.js";import"./chunk-6M2JPF2J.js";import"./chunk-GXK5J4VA.js";import{a as Ie}from"./chunk-CCSZEQ2U.js";import{d as _e,e as Ae}from"./chunk-MRJ2OVLQ.js";import{a as Se}from"./chunk-4RIP5SWC.js";import{b as be}from"./chunk-VEL25CVB.js";import"./chunk-GVABYWYT.js";import"./chunk-EQ3KQIXX.js";import"./chunk-V5F6BKCJ.js";import"./chunk-6C6REUBB.js";import"./chunk-VCDBJCKM.js";import"./chunk-7ZNZEEPK.js";import"./chunk-BDATQNGN.js";import"./chunk-YR3X52QY.js";import"./chunk-M3OAU7W5.js";import"./chunk-TCTLHOSE.js";import"./chunk-INL6HB7Y.js";import"./chunk-E3FPV7ZA.js";import{a as F}from"./chunk-NTU4GX2J.js";import"./chunk-QIO7OVOF.js";import"./chunk-J3QLC2LP.js";import"./chunk-VBFF4VHB.js";import"./chunk-Q2IUY7EW.js";import"./chunk-6HINJY73.js";import{a as ve}from"./chunk-EBLTZITF.js";import{a as ge}from"./chunk-XB5YLDHB.js";import{a as we}from"./chunk-H7EBUK3L.js";import"./chunk-7IOOWZFM.js";import"./chunk-PTFN55DA.js";import"./chunk-2HQALWZQ.js";import"./chunk-4R3QIUL4.js";import"./chunk-6TDGFCVQ.js";import"./chunk-AUXXQIHS.js";import"./chunk-DXDHIMTP.js";import"./chunk-C5Z6B7V6.js";import"./chunk-6LW5LY2X.js";import"./chunk-HFE2PHQ6.js";import"./chunk-GUIIGAD3.js";import"./chunk-SFSN6ZUK.js";import{a as fe}from"./chunk-4ZBUTOIE.js";import"./chunk-JA4ASPSI.js";import"./chunk-5JVT33KX.js";import"./chunk-H2NTHPNN.js";import{a as ue,b as ye}from"./chunk-Z5UBWN4B.js";import"./chunk-PPBOBNTL.js";import"./chunk-TUUOR3MF.js";import{a as re}from"./chunk-F7UGNZLD.js";import"./chunk-JAM5M2OZ.js";import{a as me}from"./chunk-VGAXEXH3.js";import{a as G}from"./chunk-QCZ3ZIGQ.js";import{a as v}from"./chunk-WDTJILD4.js";import{a as x}from"./chunk-FQTXYWH5.js";import"./chunk-KLXERNY4.js";import{b as he}from"./chunk-5ZFVJPU5.js";import{a as ae,b as se}from"./chunk-H25DKJGS.js";import{b as C}from"./chunk-BEONHHQH.js";import{e as N,g as j}from"./chunk-6DALCDDU.js";import"./chunk-TUF2Y2FX.js";import{a as ce}from"./chunk-YZJDOXQC.js";import"./chunk-XR5FT7TQ.js";import"./chunk-LORHDXEB.js";import"./chunk-44BHLWQ4.js";import"./chunk-5BPM64SU.js";import"./chunk-BMYVPMAK.js";import"./chunk-6F25LG6O.js";import"./chunk-XLL67PCY.js";import"./chunk-MCO7DSFO.js";import"./chunk-IIROCMOY.js";import"./chunk-6B5XFA6F.js";import"./chunk-57TARQ4F.js";import"./chunk-6RBQSBA2.js";import"./chunk-3JGYBNJA.js";import{q as pe}from"./chunk-DA3SDKGO.js";import"./chunk-ZOEPYNM4.js";import"./chunk-57VFBGF3.js";import"./chunk-GWBRHLNH.js";import"./chunk-BJH4F4SM.js";import"./chunk-Z3RBZHAK.js";import{f as U}from"./chunk-IHATPE6U.js";import"./chunk-PU4AK46X.js";import{f as le}from"./chunk-ZC6EBRE4.js";import"./chunk-DWLSVYOY.js";import"./chunk-MIS6QMFE.js";import"./chunk-MDZTV2VL.js";import"./chunk-RNC4P66O.js";import"./chunk-7LHOQXZT.js";import"./chunk-BCREO4Q5.js";import"./chunk-U4QEPZJ3.js";import"./chunk-KJUZWSCL.js";import"./chunk-3WO6D7MU.js";import"./chunk-BUZ3SPLE.js";import{a as ne}from"./chunk-D3CUKSGS.js";import"./chunk-QK56OQGR.js";import"./chunk-K75TK42V.js";import{a as de}from"./chunk-CELWVZPW.js";import"./chunk-VV5G7VY5.js";import"./chunk-OLOKUDVI.js";import"./chunk-DYTVXYAV.js";import"./chunk-ZTOZWLEE.js";import"./chunk-RJWOVI3M.js";import"./chunk-RSDQHAJX.js";import"./chunk-BOVYXYHK.js";import"./chunk-KVM6SHDX.js";import"./chunk-EQZWYK27.js";import"./chunk-6CPVQBKS.js";import{a as T}from"./chunk-2GJBUR2F.js";import{a as O}from"./chunk-DKGGDYJI.js";import"./chunk-5LA3PVK5.js";import{a as te}from"./chunk-IR6XCBC4.js";import"./chunk-C6JPAW54.js";import"./chunk-WD3OPXCN.js";import"./chunk-FA3WGIU4.js";import"./chunk-WWVPA6PE.js";import"./chunk-YPMM52MU.js";import"./chunk-BBR7CJCO.js";import{m as oe}from"./chunk-ZQIC5NFT.js";import"./chunk-VIEK2X23.js";import"./chunk-XKIFGPJO.js";import{a as R}from"./chunk-PEW2PLAN.js";import"./chunk-Q6Y4JG7Q.js";import{a as g}from"./chunk-7F5DJLJT.js";import{a as w}from"./chunk-CX5IFQZJ.js";import{i as ie}from"./chunk-NJWTSROP.js";import"./chunk-D3R25AF2.js";import"./chunk-ARRCN5K3.js";import"./chunk-WGAOVKGR.js";import"./chunk-SLAWDKDA.js";import{a as Y}from"./chunk-4N4D2YQX.js";import"./chunk-G4DZJMGT.js";import"./chunk-WTB3O6DJ.js";import"./chunk-7P44K2YD.js";import"./chunk-32OAXCA4.js";import"./chunk-UST6HCE7.js";import"./chunk-K5T5FD5C.js";import"./chunk-MVHHPJM7.js";import"./chunk-VDO6JJ3Y.js";import"./chunk-WFKZLI6F.js";import"./chunk-X2B63YVS.js";import"./chunk-BAEF3CT6.js";import"./chunk-AUAZP44J.js";import"./chunk-PVDFCTA4.js";import{c as X}from"./chunk-KNVXE32P.js";import{_ as Q,k as E}from"./chunk-76ATOSLU.js";import{c as z,f as H}from"./chunk-CCJU4DSH.js";import{a as Z,c as ee}from"./chunk-TG45K3WR.js";import"./chunk-RAI4DTMT.js";import{b as P}from"./chunk-ACP3S2CH.js";import"./chunk-HVAXZ2NA.js";import"./chunk-T7DXJKX7.js";import"./chunk-TYYVNQUR.js";import{a}from"./chunk-QGVBCWUY.js";import"./chunk-MYO4NP2N.js";import{e as l}from"./chunk-NFIPKH6V.js";import"./chunk-JPU2PQZC.js";import{f as K,l as V}from"./chunk-5QEXLALV.js";import"./chunk-P6QFA5MM.js";import"./chunk-DGTD7Y73.js";import"./chunk-LI2SX4T6.js";import"./chunk-BWO7LS2H.js";import"./chunk-HEVQSRJ2.js";import"./chunk-OVHPPCBL.js";import"./chunk-SNFOAZZQ.js";import"./chunk-AML4XSEF.js";import{K as D,b as k}from"./chunk-4PTIEWMT.js";import"./chunk-TG2UTNEO.js";import{b as c}from"./chunk-YOFFGXOB.js";import{g as I}from"./chunk-XRGPJ3QY.js";import"./chunk-6MRUJ2UW.js";import{b as B}from"./chunk-2LI2GKBQ.js";import"./chunk-QBWJMFH5.js";import{a as y,b as f,f as m}from"./chunk-VTHXE323.js";var Pe="webscene:schema-validation";function Ve(e){return new c(Pe,"Failed to save webscene due to schema validation errors. See 'details.errors' for more detailed information",{errors:e})}var $,_=$=class extends H{constructor(e){super(e)}clone(){return new $({name:this.name,path:this.path,title:this.title})}};a([l({type:String,json:{write:{isRequired:!0}}})],_.prototype,"name",void 0),a([l({type:String,json:{write:{isRequired:!0}}})],_.prototype,"path",void 0),a([l({type:String,json:{write:{isRequired:!0}}})],_.prototype,"title",void 0),_=$=a([V("esri.webscene.TransportationNetwork")],_);var Ee=_;var b=class extends ce{constructor(t,r){super(t,r,"webscene")}get supportsGround(){return this.greaterEqual(1,8)}get supportsVisibleElevationLayersInSlides(){return this.lessThan(1,8)}};var Te=null;function Re(){return Te}var Oe,S=new b(1,36),Ue=()=>{let t=[],r=S.major;for(let i=8;i<=S.minor;i++)t.push(`${r}.${i}`);return t},q="Web Scene",s=class extends te.LoadableMixin(Y.EsriPromiseMixin(ae(we))){constructor(e){super(e),this[Oe]=!0,this._layersIdGCTimeoutId=void 0,this._updateFromPromise=null,this.applicationProperties=null,this.clippingArea=null,this.clippingEnabled=!1,this.floorInfo=null,this.heightModelInfo=void 0,this.sourceVersion=null,this.transportationNetworks=null,this.presentation=new J,this.initialViewProperties=new L,this.portalItem=null,this.resourceInfo=null,this.widgets=null,this._debouncedSaveOperations=D((t,r,i)=>m(this,null,function*(){switch(t){case v.SAVE:return this._saveImpl(r);case v.SAVE_AS:return this._saveAsImpl(i,r)}})),this._resourceReferences={portalItem:null,paths:[]},this.authoringApp=null,this.authoringAppVersion=null,this._isAuthoringAppSetByUser=!1,this._isAuthoringAppVersionSetByUser=!1}initialize(){if(this.when().catch(e=>{I.getLogger(this).error("#load()","Failed to load web scene",e)}),this.resourceInfo){let e;try{e=this._validateJSON(this.resourceInfo)}catch(t){return void this.addResolvingPromise(Promise.reject(t))}this.read(e),this.addResolvingPromise(this._validateSpatialReference()),this.addResolvingPromise(this._validateHeightModelInfo())}this.addHandles(ee(()=>this.allLayers,"change",()=>this._scheduleLayersIdGC()))}destroy(){this._unscheduleLayersIdGC(),this.presentation&&this.presentation.destroy(),this.portalItem=k(this.portalItem)}writeClippingArea(e,t){t.clippingArea||(t.clippingArea={}),t.clippingArea.geometry=e.toJSON()}readClippingEnabled(e,t){return!!t.clippingArea&&!!t.clippingArea.clip}writeClippingEnabled(e,t){this.clippingArea&&(t.clippingArea||(t.clippingArea={}),t.clippingArea.clip=e)}writeLayers(e,t,r,i){t[r]=this._layersToJSON(e,"operational-layers",i)}readSourceVersion(e,t){let[r,i]=t.version.split(".");return new b(parseInt(r,10),parseInt(i,10))}writeSourceVersion(e,t,r){t[r]=`${S.major}.${S.minor}`}writeTables(e,t,r,i){let o=this._layersToJSON(e,"tables",i);o.length&&(t[r]=o)}get thumbnailUrl(){return this.portalItem?.thumbnailUrl??null}set thumbnailUrl(e){e?this._override("thumbnailUrl",e):(this._clearOverride("thumbnailUrl"),this.clear("thumbnailUrl","user"))}set authoringApp(e){this._isAuthoringAppSetByUser=!0,this._set("authoringApp",e)}writeAuthoringApp(e,t){e&&this._isAuthoringAppSetByUser?t.authoringApp=e:t.authoringApp="ArcGIS API for JavaScript"}set authoringAppVersion(e){this._isAuthoringAppVersionSetByUser=!0,this._set("authoringAppVersion",e)}writeAuthoringAppVersion(e,t){e&&this._isAuthoringAppVersionSetByUser?t.authoringAppVersion=e:t.authoringAppVersion=X}writeGround(e,t,r,i){t[r]=e?e.write({},i):{transparency:0,layers:[]}}readInitialViewProperties(e,t){let r={};t.initialState?.environment&&(r.environment=W.fromJSON(t.initialState.environment)),r.spatialReference=t.spatialReference?g.fromJSON(t.spatialReference):g.WebMercator,r.viewingMode=t.viewingMode??"global",t.initialState?.viewpoint&&(r.viewpoint=ve.fromJSON(t.initialState.viewpoint));let i=t.initialState?.timeExtent;return i!=null&&(r.timeExtent=de.fromArray(i)),new L(r)}get spatialReference(){return this.initialViewProperties?.spatialReference??g.WebMercator}get viewingMode(){return this.initialViewProperties?.viewingMode??"global"}load(e){let t=this.ground;return this.addResolvingPromise(this._loadFromSource().then(()=>{t&&t!==this.ground&&t.destroy(),this._validateFeatureLayerSymbolVisibility()})),Promise.resolve(this)}loadAll(){return re(this,e=>{let t=this.presentation&&this.presentation.slides;e(this.ground,this.basemap,this.layers,t&&t.map(r=>r.basemap),this.tables)})}read(e,t){t=f(y({},t),{origin:"web-scene"});let r=this._isAuthoringAppVersionSetByUser,i=this._isAuthoringAppSetByUser;if(z(this,e,o=>super.read(e,o),t),i||(this._isAuthoringAppSetByUser=!1),r||(this._isAuthoringAppVersionSetByUser=!1),e.baseMap&&Array.isArray(e.baseMap.elevationLayers)&&this.sourceVersion?.supportsVisibleElevationLayersInSlides){let o=e.baseMap.elevationLayers.map(p=>({id:p.id})),d=this.presentation.slides,u=(p,h)=>p.visibleLayers.some(A=>A.id===h),n=o.filter(p=>!d.some(h=>u(h,p.id)));d.forEach(p=>{p.visibleLayers.addMany(n)})}}_writeBasemapElevationLayers(e){let t=e.ground?.layers;!e.baseMap&&t?.length&&(e.baseMap={title:"Basemap",baseMapLayers:[]}),e.baseMap&&(e.baseMap.elevationLayers=B(t))}_layersToJSON(e,t,r){let i=f(y({},r),{layerContainerType:t});return e.map(o=>this._verifyWritableLayer(o,r)?o.write({},i):null).filter(o=>!!o).toArray()}_verifyWritableLayer(e,t){return!!e.persistenceEnabled&&("write"in e||(t?.messages&&t.messages.push(new c("layer:unsupported",`Layers (${e.title}, ${e.id}) of type '${e.declaredClass}' cannot be persisted in web scenes`,{layer:e})),!1))}write(e,t){if(this.loadStatus!=="loaded"){let o=new c("webscene:not-loaded","Web scene must be loaded before it can be serialized");throw I.getLogger(this).error("#toJSON()","Web scene must be loaded before it can be serialized",this.loadError||this.loadStatus),o}this._runLayersIdGC();let r=!t?.messages;t=f(y({messages:[]},t),{origin:"web-scene"});let i=super.write(e,t);if(r){let o=t.messages?.filter(d=>d.name==="web-document-write:property-required")??[];if(o.length){let d=new c("web-document:property-required","One or more properties that are required in the webscene JSON are missing, see details for the specific errors",{errors:o});throw I.getLogger(this).error("#toJSON()","One or more properties that are required in the webscene JSON are missing",o),d}}return this._writeBasemapElevationLayers(i),i}save(e){return m(this,null,function*(){return this._debouncedSaveOperations(v.SAVE,e)})}_saveImpl(e){return m(this,null,function*(){if(!this.portalItem)throw new c("webscene:portal-item-not-set","Portal item to save to has not been set on the WebScene");if(this.portalItem?.type!==q)throw new c("webscene:portal-item-wrong-type",`Portal item needs to have type "${q}"`);let t=this._updateFromPromise;yield this._ensureLoadBeforeSave();let r=this._enableVerifyItemRelativeUrls(C(this.portalItem,"web-scene",!0)),i=this.write({},r);return yield Promise.all(r.resources.pendingOperations),yield this._verifySave(i,r,v.SAVE,e),this._updateTypeKeywords(this.portalItem),yield ye(this.portalItem,i,this._resourceReferences,r),x(r),t&&(yield t),yield this._saveThumbnail(),this.portalItem})}saveAs(e,t){return m(this,null,function*(){return this._debouncedSaveOperations(v.SAVE_AS,t,e)})}_saveAsImpl(e,t){return m(this,null,function*(){let r=T.from(e);if(!r)throw new c("webscene:portal-item-required","saveAs requires a portal item to save to");r.id&&(r=r.clone(),r.id=null);let i=r.portal||O.getDefault();yield this._ensureLoadBeforeSave(),r.type=q,r.portal=i;let o=this._enableVerifyItemRelativeUrls(C(r,"web-scene",!0)),d=this.write({},o);yield Promise.all(o.resources.pendingOperations),yield this._verifySaveAs(d,o,t);let u=this.thumbnailUrl,n=!this._isOverridden("thumbnailUrl");this._updateTypeKeywords(r),yield i.signIn();let p=this.portalItem,h={item:p,authenticated:!(!p?.id||!p.portal.user)},{copyAllowed:A,itemReloaded:M}=yield _e(h,i);if(h.authenticated||=M,!A)throw new c(`${o.name}:save-as-copy-not-allowed`,"Owner of this map does not allow others to save a copy");let Me=f(y({},t),{copyAllResources:!0});return(yield Ae(r,h,d,Me))&&(this._resourceReferences.portalItem=r),yield ue(this._resourceReferences,o),this.portalItem=r,se.prototype.read.call(this,{version:d.version,authoringApp:d.authoringApp,authoringAppVersion:d.authoringAppVersion},{name:"web-scene",ignoreDefaults:!0,url:r.itemUrl?E(r.itemUrl):void 0}),x(o),u&&(this.thumbnailUrl=n?Q(u,"w","8192"):u),o.portalItem=r,yield this._saveThumbnail(),r})}_saveThumbnail(){return m(this,null,function*(){this._isOverridden("thumbnailUrl")&&(yield this.portalItem?.updateThumbnail({thumbnail:this.thumbnailUrl}),this._clearOverride("thumbnailUrl"),this.clear("thumbnailUrl","user"))})}_verifySave(e,t,r,i){return m(this,null,function*(){if(!ie(this.spatialReference))throw new c("webscene:unsupported-spatial-reference","Webscenes using spatial reference systems from Mars or Moon can not be saved currently.");let{ignoreUnsupported:o,requiredPropertyChecksDisabled:d,strictSchemaValidationEnabled:u}=i||{};he(t,{errorName:"webscene:save"},{ignoreUnsupported:o,supplementalUnsupportedErrors:["scenemodification:unsupported"],requiredPropertyChecksDisabled:d});let n=Re();if(u&&n){let p=(yield n()).validate(e);if(!p.length)return;let h=`webscene did not validate:
${p.join(`
`)}`;I.getLogger(this).error(`${r===v.SAVE_AS?"saveAs":"save"}(): ${h}`);let A=p.map(M=>new c("webscene:schema-validation",M));throw Ve(A)}})}_verifySaveAs(e,t,r){return this._verifySave(e,t,v.SAVE_AS,r)}verifySaveAs(e){let t=this._enableVerifyItemRelativeUrls({origin:"web-scene",messages:[]}),r=this.write({},t);return this._verifySaveAs(r,t,e)}canNotSaveAs(){return!1}updateFrom(r){return m(this,arguments,function*(e,t={}){let i=this._updateFrom(e,t);this._updateFromPromise=i,yield i,this._updateFromPromise===i&&(this._updateFromPromise=null)})}_updateFrom(r){return m(this,arguments,function*(e,t={}){if(yield e.whenReady(),!t.environmentExcluded&&e.environment&&(this.initialViewProperties.environment=W.prototype.clone.apply(e.environment)),!t.viewpointExcluded&&e.viewpoint&&(this.initialViewProperties.viewpoint=e.viewpoint.clone()),this.initialViewProperties.spatialReference=e.spatialReference.clone(),this.initialViewProperties.viewingMode=e.viewingMode,this.initialViewProperties.timeExtent=e.timeExtent?.clone()??null,e.clippingArea!=null?e.clippingArea!==this.clippingArea&&(this.clippingArea=e.clippingArea.clone(),this.clippingEnabled=!0):this.clippingEnabled=!1,e.heightModelInfo&&(this.heightModelInfo=e.heightModelInfo.clone()),e.map===this)for(let i of e.allLayerViews){let o="visible";o in i&&o in i.layer&&i._isOverridden(o)&&(i.layer[o]=i[o])}if(!t.widgetsExcluded)for(let i of e.persistableViewModels)i.updateWebDocument(this);(t.thumbnailExcluded===!1||t.thumbnailExcluded==null&&!t.viewpointExcluded)&&(yield this._updateFromThumbnail(e,t.thumbnailSize??void 0))})}_updateFromThumbnail(e,t){return m(this,null,function*(){let r=Se(e,t),i=yield e.takeScreenshot({format:"jpg",width:r.width,height:r.height,disableDecorations:!0});this.thumbnailUrl=i.dataUrl})}_loadFromSource(){return this.resourceInfo?this._loadFromJSON(this.resourceInfo,{origin:"web-scene"}):this.portalItem?.id?this._loadFromItem(this.portalItem):this._loadObjectsWithLayers()}_readAndLoadFromJSON(e,t){let r=this._validateJSON(e);return this.read(r,t),this._loadFromJSON(r,t)}_extractOperationalLayers(e){let t=[];if(!this.sourceVersion?.supportsGround&&e.baseMap&&Array.isArray(e.baseMap.elevationLayers))for(let o of e.baseMap.elevationLayers)t.push(o);let r=[],i=o=>(o.layers&&(o.layers=o.layers.filter(i)),o.layerType!=="ArcGISTiledElevationServiceLayer"||(this.sourceVersion?.supportsGround||r.push(o),!1));return{operationalLayers:e.operationalLayers?e.operationalLayers.filter(i):[],operationalElevationLayers:r,basemapElevationLayers:t}}_loadFromJSON(e,t){return m(this,null,function*(){let r=new P;yield this._validateSpatialReference(),yield this._validateHeightModelInfo();let{populateOperationalLayers:i}=yield import("./chunk-4PI6XTSR.js"),{operationalLayers:o,operationalElevationLayers:d,basemapElevationLayers:u}=this._extractOperationalLayers(e),n=[],p={context:f(y({},t),{layerContainerType:"operational-layers"})};if(this.portalItem&&(p.context.portal=this.portalItem.portal||O.getDefault()),u.length>0){let h=f(y({},p),{context:f(y({},p.context),{layerContainerType:"ground"})});h.defaultLayerType="ArcGISTiledElevationServiceLayer",n.push(i(this.ground.layers,u,h))}if(d.length>0){let h=f(y({},p),{context:f(y({},p.context),{layerContainerType:"ground"})});h.defaultLayerType="ArcGISTiledElevationServiceLayer",n.push(i(r,d,h))}o&&o.length>0&&n.push(i(this.layers,o,p)),e.tables?.length&&n.push(i(this.tables,e.tables,f(y({},p),{context:f(y({},p.context),{layerContainerType:"tables"}),defaultLayerType:"ArcGISFeatureLayer"}))),yield Promise.allSettled(n),yield this._loadObjectsWithLayers(),this.ground.layers.addMany(r.filter(h=>h.type==="base-elevation"||h.type==="elevation"))})}_ensureLoadBeforeSave(){return m(this,null,function*(){yield this.load(),yield this._loadObjectsWithLayers();let e=[],t=[...this.allLayers.items];for(let{basemap:r}of this.presentation.slides.items)r&&(t.push(...r.baseLayers.items),t.push(...r.referenceLayers.items));for(let r of t)if("beforeSave"in r&&typeof r.beforeSave=="function"){let i=r.beforeSave();i&&e.push(i)}yield Promise.allSettled(e)})}_loadObjectsWithLayers(){return m(this,null,function*(){let e=[];this.ground&&e.push(this.ground.load()),this.basemap&&e.push(this.basemap.load()),this.presentation.slides.forEach(t=>{t.basemap&&e.push(t.basemap.load())}),yield Promise.allSettled(e)})}_loadFromItem(e){return m(this,null,function*(){if(yield e.load().catch(i=>{throw new c("webscene:load-portal-item","Failed to load portal item",{error:i})}),e.type!=="Web Scene")throw new c("webscene:invalid-portal-item","Invalid portal item type '${type}', expected 'Web Scene'",{type:e.type});let t=yield e.fetchData();this.resourceInfo=t;let r={origin:"web-scene",url:E(e.itemUrl),portal:e.portal||O.getDefault(),portalItem:e,readResourcePaths:[]};yield this._readAndLoadFromJSON(t,r),this._resourceReferences={portalItem:e,paths:r.readResourcePaths??[]}})}_validateSpatialReference(){let e=this.initialViewProperties,t=this._sceneSpatialReference,r;if(e.viewingMode!=="local"){if(!F(t,G.Global))return Promise.reject(new c("webscene:unsupported-spatial-reference","Unsupported spatial reference (${spatialReference.wkid}) in global mode, only Web Mercator, WGS84 GCS or CGCS2000 are supported",{spatialReference:t,viewingMode:e.viewingMode}));r=n=>!n||pe(n,t)}else{if(!F(t,G.Local))return Promise.reject(new c("webscene:unsupported-spatial-reference","Unsupported spatial reference (${spatialReference.wkid}) in local mode, only projected coordinate systems are supported",{spatialReference:t,viewingMode:e.viewingMode}));r=n=>!n||n.equals(t)}let i=n=>n?.camera?.position.spatialReference??n?.targetGeometry?.spatialReference,o=e.viewpoint,d=i(o);if(d&&!r(d))return Promise.reject(new c("webscene:incompatible-camera-spatial-reference","Camera spatial reference (${cameraSpatialReference.wkid}) is incompatible with the scene spatial reference (${sceneSpatialReference.wkid})",{cameraSpatialReference:d,sceneSpatialReference:t,viewingMode:e.viewingMode}));let u=this.presentation.slides.find(n=>!r(i(n.viewpoint)));if(u){let n=i(u.viewpoint);return Promise.reject(new c("webscene:incompatible-slide-spatial-reference","Slide spatial reference (${slideSpatialReference.wkid}) is incompatible with the scene spatial reference (${sceneSpatialReference.wkid})",{slideSpatialReference:n,sceneSpatialReference:t,viewingMode:e.viewingMode}))}return Promise.resolve()}_validateHeightModelInfo(){let e=this._sceneSpatialReference,t=Ie(this.heightModelInfo,e);return t?Promise.reject(t):Promise.resolve()}_validateFeatureLayerSymbolVisibility(){this.sourceVersion?.greaterEqual(1,35)||this.layers.forEach(e=>{e.type==="feature"&&e.addHandles(Z(()=>e.loaded,()=>{e.elevationInfo?.mode==="on-the-ground"&&e.renderer?.type==="simple"&&e.renderer.symbol?.type==="polygon-3d"&&e.renderer.symbol.symbolLayers.some(t=>t.type==="fill"&&t.material!=null&&(!t.material.color||t.material.color.a*e.opacity<me)&&(e.loadWarnings.push(new K("feature-layer:invisible-draped-symbols","FeatureLayer has fully transparent symbols which will no longer render or highlight",{layer:e})),!0))},{once:!0,sync:!0}))})}_validateJSON(e){let t=b.parse(e.version||"","webscene");return S.validate(t),e.version=`${t.major}.${t.minor}`,t.major===1&&t.minor<=2&&(e.spatialReference=g.WebMercator.toJSON()),e}_updateTypeKeywords(e){N(e,j.LOCAL_SCENE,this.initialViewProperties.viewingMode==="local"),N(e,j.DEVELOPER_BASEMAP,U(this.basemap)||this.presentation.slides.some(({basemap:t})=>!!t&&U(t))),e.typeKeywords&&(e.typeKeywords=e.typeKeywords.filter((t,r,i)=>i.indexOf(t)===r))}get _sceneSpatialReference(){return this.initialViewProperties.spatialReference||g.WebMercator}get _verifyItemRelativeRootPath(){return this.portalItem?.itemUrl?E(this.portalItem.itemUrl).path:null}_enableVerifyItemRelativeUrls(e){let t=this._verifyItemRelativeRootPath;return t&&(e.verifyItemRelativeUrls={rootPath:t,writtenUrls:[]}),e}_unscheduleLayersIdGC(){this._layersIdGCTimeoutId&&(clearTimeout(this._layersIdGCTimeoutId),this._layersIdGCTimeoutId=0)}_scheduleLayersIdGC(){this._unscheduleLayersIdGC(),this._layersIdGCTimeoutId=setTimeout(()=>{this._layersIdGCTimeoutId=0,this._runLayersIdGC()},3e3)}_runLayersIdGC(){this._unscheduleLayersIdGC();let e=this.applicationProperties?.viewing?.search,t=i=>this.allLayers.some(o=>o.id===i&&o.persistenceEnabled);e?.layers&&(e.layers=e.layers.filter(i=>t(i.id)));let r=this.presentation&&this.presentation.slides;r&&r.forEach(i=>{i.visibleLayers&&(i.visibleLayers=i.visibleLayers.filter(o=>t(o.id)))})}static fromJSON(e){if(!e)throw new c("webscene:empty-resource","Expected a JSON resource but got nothing");return new this({resourceInfo:e})}};Oe=fe,s.version=`${S.major}.${S.minor}`,a([l({type:Le,json:{write:!0}})],s.prototype,"applicationProperties",void 0),a([l({type:oe,json:{read:{source:"clippingArea.geometry",reader:le},write:{target:"clippingArea.geometry"}}})],s.prototype,"clippingArea",void 0),a([w("clippingArea")],s.prototype,"writeClippingArea",null),a([l({type:Boolean,json:{write:{target:"clippingArea.clip"}}})],s.prototype,"clippingEnabled",void 0),a([R("clippingEnabled",["clippingArea"])],s.prototype,"readClippingEnabled",null),a([w("clippingEnabled")],s.prototype,"writeClippingEnabled",null),a([l({type:ge,json:{read:{source:"mapFloorInfo"},write:{target:"mapFloorInfo"}}})],s.prototype,"floorInfo",void 0),a([l({type:ne,json:{write:!0}})],s.prototype,"heightModelInfo",void 0),a([l({json:{write:{target:"operationalLayers",ignoreOrigin:!0}}})],s.prototype,"layers",void 0),a([w("layers")],s.prototype,"writeLayers",null),a([l({readOnly:!0,type:b,json:{type:Ue(),write:{ignoreOrigin:!0,target:"version",isRequired:!0,overridePolicy:()=>({enabled:!0,allowNull:!0,ignoreOrigin:!0})}}})],s.prototype,"sourceVersion",void 0),a([R("sourceVersion",["version"])],s.prototype,"readSourceVersion",null),a([w("sourceVersion")],s.prototype,"writeSourceVersion",null),a([l({json:{read:!1,write:{enabled:!0,ignoreOrigin:!0}}})],s.prototype,"tables",void 0),a([w("tables")],s.prototype,"writeTables",null),a([l()],s.prototype,"thumbnailUrl",null),a([l({type:String,json:{write:{writerEnsuresNonNull:!0,ignoreOrigin:!0}}})],s.prototype,"authoringApp",null),a([w("authoringApp")],s.prototype,"writeAuthoringApp",null),a([l({type:String,json:{write:{writerEnsuresNonNull:!0,ignoreOrigin:!0}}})],s.prototype,"authoringAppVersion",null),a([w("authoringAppVersion")],s.prototype,"writeAuthoringAppVersion",null),a([l({json:{write:{isRequired:!0,allowNull:!0,ignoreOrigin:!0,enabled:!0}}})],s.prototype,"ground",void 0),a([w("ground")],s.prototype,"writeGround",null),a([l({type:P.ofType(Ee),json:{write:!0}})],s.prototype,"transportationNetworks",void 0),a([l({type:J,nonNullable:!0,json:{write:{ignoreOrigin:!0,writer:(e,t,r,i)=>{if(e.slides&&e.slides.length>0){let o=f(y({},i),{isPresentation:!0});t.presentation=e.write({},o)}}}}})],s.prototype,"presentation",void 0),a([l({type:L,nonNullable:!0,json:{write:{target:"initialState",isRequired:!0,ignoreOrigin:!0},default:()=>new L({viewingMode:"global",spatialReference:g.WebMercator})}})],s.prototype,"initialViewProperties",void 0),a([R("initialViewProperties",["initialState.timeExtent","initialState.environment","initialState.viewpoint","spatialReference","viewingMode"])],s.prototype,"readInitialViewProperties",null),a([l({type:g,json:{read:!1,write:{isRequired:!0,ignoreOrigin:!0}}})],s.prototype,"spatialReference",null),a([l({type:["local","global"],json:{read:!1,write:{isRequired:!0,ignoreOrigin:!0}}})],s.prototype,"viewingMode",null),a([l({type:T})],s.prototype,"portalItem",void 0),a([l()],s.prototype,"resourceInfo",void 0),a([l({type:be,json:{write:!0}})],s.prototype,"widgets",void 0),s=a([V("esri.WebScene")],s);var Qt=s;export{Qt as default};
