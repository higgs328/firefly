import{a as A}from"./chunk-BEIT7H7J.js";import{a as q}from"./chunk-R3V767DI.js";import{b as N}from"./chunk-4Y7EKSO4.js";import{b as U}from"./chunk-63F5HAQH.js";import{a as P}from"./chunk-GNEAU6X4.js";import{b as M}from"./chunk-NX5B6XBR.js";import{a as j,b as v,c as F}from"./chunk-6RBQSBA2.js";import{g as D}from"./chunk-ZC6EBRE4.js";import{b as w}from"./chunk-JLPLCY2B.js";import{g as V}from"./chunk-NJWTSROP.js";import{o as L}from"./chunk-AUAZP44J.js";import{a as I,b as J,f as $}from"./chunk-VTHXE323.js";function C(r,t){let{dpi:i,gdbVersion:s,geometry:e,geometryPrecision:f,height:c,historicMoment:g,layerOption:d,mapExtent:p,maxAllowableOffset:u,returnFieldName:x,returnGeometry:y,returnUnformattedValues:S,returnZ:n,spatialReference:h,timeExtent:a,tolerance:o,width:m}=r.toJSON(),{dynamicLayers:b,layerDefs:O,layerIds:T}=H(r),G=t?.geometry!=null?t.geometry:null,l={historicMoment:g,geometryPrecision:f,maxAllowableOffset:u,returnFieldName:x,returnGeometry:y,returnUnformattedValues:S,returnZ:n,tolerance:o},E=G?.toJSON()||e;l.imageDisplay=`${m},${c},${i}`,s&&(l.gdbVersion=s),E&&(delete E.spatialReference,l.geometry=JSON.stringify(E),l.geometryType=D(E));let R=h??E?.spatialReference??p?.spatialReference;if(R&&(l.sr=V(R)),l.time=a?[a.start,a.end].join(","):null,p){let{xmin:Z,ymin:k,xmax:z,ymax:B}=p;l.mapExtent=`${Z},${k},${z},${B}`}return O&&(l.layerDefs=O),b&&!O&&(l.dynamicLayers=b),l.layers=d==="popup"?"visible":d,T&&!b&&(l.layers+=`:${T.join(",")}`),l}function H(r){let{mapExtent:t,floors:i,width:s,sublayers:e,layerIds:f,layerOption:c,gdbVersion:g}=r,d=e?.find(n=>n.layer!=null)?.layer?.serviceSublayers,p=c==="popup",u={},x=P({extent:t,width:s,spatialReference:t?.spatialReference}),y=[],S=n=>{let h=x===0,a=n.minScale===0||x<=n.minScale,o=n.maxScale===0||x>=n.maxScale;if(n.visible&&(h||a&&o))if(n.sublayers)n.sublayers.forEach(S);else{if(f?.includes(n.id)===!1||p&&(!n.popupTemplate||!n.popupEnabled))return;y.unshift(n)}};if(e?.forEach(S),e&&!y.length)u.layerIds=[];else{let n=U(y,d,g),h=y.map(a=>{let o=N(i,a);return a.toExportImageJSON(o)});if(n)u.dynamicLayers=JSON.stringify(h);else{if(e){let o=y.map(({id:m})=>m);f&&(o=o.filter(m=>f.includes(m))),u.layerIds=o}else f?.length&&(u.layerIds=f);let a=K(i,y);if(a!=null&&a.length){let o={};for(let m of a)m.definitionExpression&&(o[m.id]=m.definitionExpression);Object.keys(o).length&&(u.layerDefs=JSON.stringify(o))}}}return u}function K(r,t){let i=!!r?.length,s=t.filter(e=>e.definitionExpression!=null||i&&e.floorInfo!=null);return s.length?s.map(e=>{let f=N(r,e),c=w(f,e.definitionExpression);return{id:e.id,definitionExpression:c??void 0}}):null}function ue(r,t,i){return $(this,null,function*(){let s=(t=W(t)).geometry?[t.geometry]:[],e=v(r);return e.path+="/identify",M(s).then(f=>{let c=C(t,{geometry:f?.[0]}),g=F(I(J(I({},e.query),{f:"json"}),c)),d=j(g,i);return L(e.path,d).then(Q).then(p=>X(p,t.sublayers))})})}function Q(r){let t=r.data;return t.results=t.results||[],t.exceededTransferLimit=!!t.exceededTransferLimit,t.results=t.results.map(i=>q.fromJSON(i)),t}function W(r){return r=A.from(r)}function X(r,t){if(!t?.length)return r;let i=new Map;function s(e){i.set(e.id,e),e.sublayers&&e.sublayers.forEach(s)}t.forEach(s);for(let e of r.results)e.feature.sourceLayer=i.get(e.layerId);return r}export{ue as a};
