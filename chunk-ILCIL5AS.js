import{a as Q}from"./chunk-FPCHE4I2.js";import{a as D,b as G}from"./chunk-VEL25CVB.js";import{a as M}from"./chunk-CSSRRM4C.js";import{a as b,j as q,k as H}from"./chunk-TG45K3WR.js";import{f as A}from"./chunk-RAI4DTMT.js";import{b as T}from"./chunk-ACP3S2CH.js";import{a}from"./chunk-QGVBCWUY.js";import{H as V}from"./chunk-MYO4NP2N.js";import{e as n}from"./chunk-NFIPKH6V.js";import{l as C}from"./chunk-5QEXLALV.js";import{p as z}from"./chunk-4PTIEWMT.js";import{b as W}from"./chunk-YOFFGXOB.js";import{f as L}from"./chunk-VTHXE323.js";function P(e){return e.declaredClass==="esri.WebScene"}var o=class extends Q(V){constructor(e){super(e),this.filterMenuOpen=!1,this.filterMenuType="site",this.filterMode="base-floors",this.levelsExpanded=!0,this.searchTerm=null,this.view=null,this._updateFloorFilterTask=null,this._viewHeightBreakpoint=null,this._viewWidthBreakpoint=null}initialize(){this.addHandles([b(()=>this.view?.map,e=>{this._updateFloorFilterTask!=null&&(this._updateFloorFilterTask.abort(),this._updateFloorFilterTask=null),this._updateFloorFilterTask=A(t=>L(this,null,function*(){yield this._updateFloorFilterFromMap(e),z(t),this._setInitialViewState(e)}))},q),b(()=>this.view,(e,t)=>{this._unregisterWidget(t),this._registerWidget(e),this._watchSearchResults(e)},H),b(()=>this.view?.widthBreakpoint??null,e=>{this._viewWidthBreakpoint=e}),b(()=>this.view?.heightBreakpoint??null,e=>{this._viewHeightBreakpoint=e})])}destroy(){this._unregisterWidget(this.view),this.view=null,this._updateFloorFilterTask!=null&&(this._updateFloorFilterTask.abort(),this._updateFloorFilterTask=null)}set enabled(e){this._callOverride("enabled",e)}set facility(e){if(e&&this._isOverridden("facility")){let t=this.getFacility(e);this.hasMultipleSites&&(this.site=t?.siteId||null)}this._callOverride("facility",e)}set filterFeatures(e){this._callOverride("filterFeatures",e)}set filterLayers(e){this._callOverride("filterLayers",e)}get hasFacilities(){return this.filterLayers?.facilityLayer!=null&&this.filterFeatures?.facilities?.facilitiesInfo?.length>0}get hasLevels(){return this.filterLayers?.levelLayer!=null&&this.filterFeatures?.levels?.levelsInfo?.length>0}get hasMultipleSites(){return this.filterLayers?.siteLayer!=null&&this.filterFeatures?.sites?.sitesInfo?.length>1}get isNormalMode(){let e=!0,t=this._viewWidthBreakpoint;return this._viewHeightBreakpoint!=="xsmall"&&t!=="xsmall"||(e=!1),e}set level(e){if(!e)return this._callOverride("level",e),this.facility=null,this.site=null,void this.setFloors(null);let t=null,i=null,s=e?.split("--");s?.length>1&&s[0]==="all"?(i=s[1],t={id:e,facilityId:i,shortName:null,longName:null,levelNumber:null,verticalOrder:null}):(t=this.getLevel(e),i=t?.facilityId??null),this.level!==e||this.isNormalMode||this.levelsExpanded?(t&&this.hasFacilities&&this.hasLevels?(this.facility=i,this.hasMultipleSites&&(this.site=this.getFacility(i)?.siteId||null),this.setFloors(t)):this._isOverridden("level")&&(this.facility=null,this.site=null,this.hasMultipleSites&&(this.filterMenuType="site"),this.setFloors(null)),this._callOverride("level",e)):this.getFacilityLevels(i)?.length>1&&(this.levelsExpanded=!0)}set longNames(e){this._callOverride("longNames",e)}set minimized(e){this._callOverride("minimized",e)}set pinnedLevels(e){this._callOverride("pinnedLevels",e)}set site(e){this._callOverride("site",e)}get state(){return this.view&&this.filterFeatures&&this.hasFacilities&&this.hasLevels?"ready":this.view&&!this.filterFeatures?"loading":"disabled"}filterFacilities(e){let t=e;return this.searchTerm&&(this.searchTerm=this.searchTerm.trim(),t=e.filter(i=>{let{name:s}=i;return s.toLowerCase().includes(this.searchTerm?.toLowerCase())})),this.site&&(t=t.filter(i=>i.siteId===this.site)),t.sort((i,s)=>{let l=i.name,r=s.name;return l.localeCompare(r,void 0,{sensitivity:"base"})})}filterSites(e){let t=e;return this.searchTerm&&(this.searchTerm=this.searchTerm.trim(),t=e.filter(i=>{let{name:s}=i;return s.toLowerCase().includes(this.searchTerm?.toLowerCase())})),t.sort((i,s)=>{let l=i.name,r=s.name;return l.localeCompare(r,void 0,{sensitivity:"base"})})}getBaseLevel(e){let t=this.filterFeatures?.levels?.levelsInfo,i=null;if(e){let{id:s}=e;if(t&&t.length>0&&(t.forEach(l=>{l.verticalOrder===0&&l.facilityId===s&&(i=l)}),!i)){let l=null;t.forEach(r=>{r.facilityId===s&&(l?(r.verticalOrder??0)>=0?l.verticalOrder!=null&&(l.verticalOrder<0||(r.verticalOrder??0)<l.verticalOrder)&&(l=r):l.verticalOrder!=null&&r.verticalOrder!=null&&l.verticalOrder<0&&r.verticalOrder>l.verticalOrder&&(l=r):l=r)}),l&&(i=l)}}return i}getFacility(e){return this.filterFeatures?.facilities?.facilitiesInfo?.find(t=>t.id===e)??null}getFacilityLevels(e){return!e||!this.filterFeatures?.levels?.levelsInfo?[]:this.filterFeatures.levels.levelsInfo.filter(t=>t.facilityId===e).sort((t,i)=>{let s=t.verticalOrder??0,l=i.verticalOrder??0;return s>l?-1:s===l?0:1})}getLevel(e){return this.filterFeatures?.levels?.levelsInfo?.find(t=>t.id===e)??null}getSite(e){return this.filterFeatures?.sites?.sitesInfo?.find(t=>t.id===e)??null}goTo(e){let{view:t}=this;if(!t||!e)return;let{geometry:i}=e;i&&i.extent&&this.callGoTo({target:i.extent,options:{duration:1e3,easing:"in-out-quad"}})}setFloors(e){let{view:t}=this;t&&(t?.map?.allLayers?.forEach(i=>{i.type==="feature"&&this._computeViewAllModeFloors(i)}),t.floors=new T(this._computeFloors(e)))}updateWebDocument(e){if(M(e)){let t=new D({enabled:this.enabled,longNames:this.longNames,minimized:this.minimized,pinnedLevels:this.pinnedLevels,site:this.site??null,facility:this.facility??null,level:this.level??null});e.widgets?e.widgets.floorFilter=t:e.widgets=new G({floorFilter:t})}}_computeFloors(e){if(this.filterMode==="single-floor")this._computeSingleFloor(e);else if(this.filterMode==="base-floors")return this.view?.type==="3d"?this._computeBaseFloors3D(e):this._computeBaseFloors(e);return this._computeEmptyFloors()}_computeSingleFloor(e){if(!e)return this._computeEmptyFloors();let t=[];return e?.id==="all"?this.getFacilityLevels(e.facilityId).forEach(i=>{i.id&&t.push(i.id)}):e&&t.push(e.id),t}_computeBaseFloors(e){let t=this.filterFeatures?.levels?.levelsInfo;if(!t?.length)return this._computeEmptyFloors();let i=[];e?.id==="all"?this.getFacilityLevels(e.facilityId).forEach(l=>{l.id&&i.push(l.id)}):e&&i.push(e.id);let s=e?.facilityId;return t.forEach(l=>{let{id:r,facilityId:h,verticalOrder:f}=l;(s||f!==0||i.includes(r))&&(h===s||f!==0||i.includes(r))||i.push(r)}),i}_computeBaseFloors3D(e){let t=this.filterFeatures?.levels?.levelsInfo;if(!t?.length)return this._computeEmptyFloors();let i=[],s=e?.id.split("--")??[];s?.length>1&&s[0]==="all"?this.getFacilityLevels(e?.facilityId).forEach(r=>{r.id&&i.push(r.id)}):e&&i.push(e.id);let l=e?.facilityId;return t.forEach(r=>{let{id:h,facilityId:f}=r;(l||i.includes(h))&&(f===l||i.includes(h))||i.push(h)}),i}_computeEmptyFloors(){return[]}_setFilterLayers(){return L(this,null,function*(){let{view:e}=this;if(e&&!this._isOverridden("filterLayers")){if(!M(e.map)&&!P(e.map))throw new W("Map must be a webmap or webscene");{let t=e.map,i=t?.allLayers;if(i?.items?.length>0){let s={siteLayer:null,facilityLayer:null,levelLayer:null},l=t.floorInfo?.siteLayer?.layerId,r=t.floorInfo?.facilityLayer?.layerId,h=t.floorInfo?.levelLayer?.layerId,f=t.floorInfo?.siteLayer?.sublayerId||t.floorInfo?.facilityLayer?.sublayerId||t.floorInfo?.levelLayer?.sublayerId;if(!r||!h)return;let p=i.items.filter(d=>d.type==="feature"||d.type==="scene"),m=i.items.filter(d=>d.type==="map-image");if(m?.length>0&&f){yield Promise.all(m.map(c=>c.load()));let d=t.floorInfo?.siteLayer?.sublayerId,u=t.floorInfo?.facilityLayer?.sublayerId,F=t.floorInfo?.levelLayer?.sublayerId;m.forEach(c=>{let y=c.id,v=c?.allSublayers,I=v?.items;(y===l||y===r||y===h)&&I?.length>0&&v.items.forEach(g=>{let _=g.id;y===l&&_===d?s.siteLayer=g:_===u?s.facilityLayer=g:_===F&&(s.levelLayer=g)})})}p?.length>0&&p.forEach(d=>{let u=d.id;u===l?s.siteLayer=d:u===r?s.facilityLayer=d:u===h&&(s.levelLayer=d)}),this.filterLayers=s}}}})}_getFilterFeatures(){return L(this,null,function*(){if(this._isOverridden("filterFeatures"))return this.filterFeatures;let[e,t,i]=yield Promise.all([this._getSites(),this._getFacilities(),this._getLevels()]);return{sites:e,facilities:t,levels:i}})}_getSites(){return L(this,null,function*(){let e={sitesInfo:[]},{filterLayers:t,view:i}=this,s=i?.map,{siteLayer:l}=t;if(!l||!s?.floorInfo?.siteLayer)return e;let r=l.createQuery();r.returnGeometry=!0,r.outFields=["*"],r.returnZ=!0,"type"in l&&l.type==="scene"&&(r.multipatchOption="xyFootprint");let{siteIdField:h,nameField:f}=s.floorInfo.siteLayer,p=yield l.queryFeatures(r);if(p?.features?.length>0){let m=p.features,d=l?.fieldsIndex.get(h)?.name||h,u=l?.fieldsIndex.get(f)?.name||f;d!=null&&u!=null&&m.forEach(F=>{let c=F.attributes,y=F.geometry,v=c[d],I=c[u];v&&I&&e.sitesInfo.push({id:v,name:I,geometry:y})})}return e})}_getFacilities(){return L(this,null,function*(){let{filterLayers:e,view:t}=this,i=t?.map,{facilityLayer:s}=e,l={facilitiesInfo:[]};if(!s||!i?.floorInfo?.facilityLayer)return l;let r=s.createQuery();r.returnGeometry=!0,r.outFields=["*"],r.returnZ=!0,"type"in s&&s.type==="scene"&&(r.multipatchOption="xyFootprint");let{facilityIdField:h,siteIdField:f,nameField:p}=i.floorInfo.facilityLayer,m=yield s.queryFeatures(r);if(m?.features?.length>0){let d=m.features,u=s?.fieldsIndex.get(h)?.name||h,F=s?.fieldsIndex.get(f)?.name||f,c=s?.fieldsIndex.get(p)?.name||p;u&&F&&c&&d.forEach(y=>{let v=y.attributes,I=y.geometry,g=v[u],_=v[F],O=v[c];g&&O&&l.facilitiesInfo.push({id:g,siteId:_,name:O,geometry:I})})}return l})}_getLevels(){return L(this,null,function*(){let{filterLayers:e,view:t}=this,i=t?.map,{levelLayer:s}=e,l={levelsInfo:[]};if(!s||!i?.floorInfo?.levelLayer)return l;let r=s.createQuery();r.returnGeometry=!0,r.outFields=["*"],r.returnZ=!0;let{levelIdField:h,facilityIdField:f,longNameField:p,shortNameField:m,levelNumberField:d,verticalOrderField:u}=i.floorInfo.levelLayer,F=yield s.queryFeatures(r);if(F?.features?.length>0){let c=F.features,y=s?.fieldsIndex.get(h)?.name||h,v=s?.fieldsIndex.get(f)?.name||f,I=s?.fieldsIndex.get(p)?.name||p,g=s?.fieldsIndex.get(m)?.name||m,_=s?.fieldsIndex.get(d)?.name||d,O=s?.fieldsIndex.get(u)?.name||u;y&&v&&I&&g&&_&&O&&c.forEach(Z=>{let w=Z.attributes,E=w[y],x=w[v],N=w[I],k=w[g],S=w[_],B=w[O];E&&x&&N&&k&&typeof S=="number"&&typeof B=="number"&&l.levelsInfo.push({id:E,facilityId:x,longName:N,shortName:k,levelNumber:S,verticalOrder:B})})}return l})}_registerWidget(e){e?.persistableViewModels.includes(this)||e?.persistableViewModels.add(this)}_unregisterWidget(e){e?.persistableViewModels.remove(this)}_watchSearchResults(e){e?.on("select-result-floor",t=>{let i=this.getLevel(t);i&&this.level!==t&&(this.level=t,this.setFloors(i))})}_setInitialViewState(e){return L(this,null,function*(){if(this.view)try{yield this.view.when(),yield this._setFilterLayers();let t=yield this._getFilterFeatures();if(!t)return;if(this.filterFeatures=t,!this.hasFacilities||!this.hasLevels)return void console.error("Facilities and Levels are required for the Floor Filter widget");if(this.hasMultipleSites||(this.filterMenuType="facility"),this.facility&&this.level){this.filterMenuType="facility";let i=this.getFacility(this.facility),s=this.getLevel(this.level);this.site||(this.site=i?.siteId||void 0),this.setFloors(s)}else if(this.facility&&!this.level){this.filterMenuType="facility";let i=this.getFacility(this.facility),s=this.getBaseLevel(i);this.site||(this.site=i?.siteId||void 0),this.level=s?.id||void 0,this.setFloors(s)}else if(!this.facility&&this.level){this.filterMenuType="facility";let i=this.getLevel(this.level),s=this.getFacility(i?.facilityId);this.facility=s?.id||void 0,this.site||(this.site=s?.siteId||void 0),this.setFloors(i)}else if(!this.site||this.facility||this.level){if(!e||!M(e))return void this.setFloors(null);let i=e?.widgets?.floorFilter;if(!i)return void this.setFloors(null);i.site&&!this.site&&(this.site=i.site,this.filterMenuType="facility"),this.setFloors(null)}else this.filterMenuType="site",this.setFloors(null)}catch(t){console.error("Couldn't retrieve sites, facilities, and levels",t)}})}_callOverride(e,t){this._override(e,t)}_updateFloorFilterFromMap(e){return L(this,null,function*(){if(!e||!M(e))return;let t=e?.widgets?.floorFilter;t&&(this._isOverridden("enabled")||(this.enabled=t.enabled),this._isOverridden("longNames")||(this.longNames=t.longNames),this._isOverridden("minimized")||(this.minimized=t.minimized),this._isOverridden("pinnedLevels")||(this.pinnedLevels=t.pinnedLevels),this._isOverridden("site")||(this.site=t.site),this._isOverridden("facility")||(this.facility=t.facility),this._isOverridden("level")||(this.level=t.level))})}_computeViewAllModeFloors(e){let{filterFeatures:t}=this;if(e.floorInfo?.viewAllMode&&this.hasLevels&&this.hasFacilities&&this.filterMode==="base-floors"){let{level:i,facility:s}=this,l=[];t.levels.levelsInfo.forEach(r=>{let{id:h,facilityId:f}=r;s&&f===s?i&&h===i&&l.push(h):l.push(h)}),e.floorInfo.viewAllLevelIds=new T(l)}}};a([n({value:!1})],o.prototype,"enabled",null),a([n({value:void 0})],o.prototype,"facility",null),a([n({value:null})],o.prototype,"filterFeatures",null),a([n({value:null})],o.prototype,"filterLayers",null),a([n()],o.prototype,"filterMenuOpen",void 0),a([n()],o.prototype,"filterMenuType",void 0),a([n()],o.prototype,"filterMode",void 0),a([n()],o.prototype,"hasFacilities",null),a([n()],o.prototype,"hasLevels",null),a([n()],o.prototype,"hasMultipleSites",null),a([n({readOnly:!0})],o.prototype,"isNormalMode",null),a([n({value:void 0})],o.prototype,"level",null),a([n({value:!1})],o.prototype,"longNames",null),a([n()],o.prototype,"levelsExpanded",void 0),a([n({value:!1})],o.prototype,"minimized",null),a([n({value:!1})],o.prototype,"pinnedLevels",null),a([n()],o.prototype,"searchTerm",void 0),a([n({value:void 0})],o.prototype,"site",null),a([n({readOnly:!0})],o.prototype,"state",null),a([n()],o.prototype,"view",void 0),a([n()],o.prototype,"_viewHeightBreakpoint",void 0),a([n()],o.prototype,"_viewWidthBreakpoint",void 0),a([n()],o.prototype,"updateWebDocument",null),o=a([C("esri.widgets.FloorFilter.FloorFilterViewModel")],o);var de=o;export{de as a};
