import{a as ue}from"./chunk-MOTLSRMA.js";import{F as he,G as ce}from"./chunk-WCHIR27X.js";import"./chunk-QGGZPZNN.js";import{a as ae,b as oe,c as ne}from"./chunk-V6QXH7C6.js";import"./chunk-FWBT5WUO.js";import"./chunk-26JWDTE3.js";import{a as re}from"./chunk-PMIZEMLB.js";import{a as se}from"./chunk-QNQQOHRL.js";import"./chunk-CCSZEQ2U.js";import"./chunk-MCWKELO6.js";import"./chunk-BBM5BVWD.js";import{b as J,c as X,d as ee,e as te,g as ie}from"./chunk-PXFHIN7R.js";import"./chunk-MTYOPLNE.js";import"./chunk-FLXA3YE2.js";import"./chunk-ASWKMS6K.js";import"./chunk-YEGIAUQF.js";import{a as le}from"./chunk-FY4QM6AV.js";import{c as $}from"./chunk-4TIUXNXO.js";import"./chunk-CX3G2QWN.js";import"./chunk-CZMBPC27.js";import"./chunk-VANM5A4M.js";import"./chunk-VSD74FMI.js";import"./chunk-456M7HFK.js";import"./chunk-BYXBJQAS.js";import{e as k}from"./chunk-D4ZCCSW3.js";import"./chunk-THX6XNHV.js";import"./chunk-AKKUUEQK.js";import{a as p,b as H}from"./chunk-JLWYDAJB.js";import"./chunk-NGZE6C3L.js";import"./chunk-P3AGG7SB.js";import"./chunk-N62DQME2.js";import"./chunk-JFBLKPWZ.js";import{a as Q}from"./chunk-B7PAC3NI.js";import"./chunk-37H4LYIE.js";import"./chunk-VYZHOYXV.js";import"./chunk-ECA5I2I7.js";import"./chunk-ZOOQQO74.js";import"./chunk-3KUXZU2N.js";import"./chunk-X7BNFUFQ.js";import"./chunk-QCZ3ZIGQ.js";import"./chunk-NIRJWS2D.js";import"./chunk-H3ZWZZ2B.js";import"./chunk-ZM24RY22.js";import"./chunk-VOB6IBIW.js";import"./chunk-63B3IOWG.js";import"./chunk-XR5FT7TQ.js";import"./chunk-JQAW4OB5.js";import"./chunk-XQOE7Z4Q.js";import"./chunk-6F25LG6O.js";import"./chunk-5LG2P6MT.js";import"./chunk-W5OI4BJ2.js";import{c as L,i as Y}from"./chunk-HM5RIVQC.js";import"./chunk-DJW5LMRG.js";import"./chunk-QXXXCEV5.js";import"./chunk-PTZYZULI.js";import"./chunk-NMLYCCKN.js";import"./chunk-7LHOQXZT.js";import"./chunk-BCREO4Q5.js";import"./chunk-D3CUKSGS.js";import"./chunk-K75TK42V.js";import"./chunk-RJWOVI3M.js";import"./chunk-RSDQHAJX.js";import"./chunk-DZFUQCB6.js";import"./chunk-V2JYXY4D.js";import{a as Z}from"./chunk-KVM6SHDX.js";import"./chunk-PIHANKUA.js";import{a as K}from"./chunk-NKUXRYJG.js";import"./chunk-EQZWYK27.js";import"./chunk-ZQIC5NFT.js";import"./chunk-VIEK2X23.js";import"./chunk-XKIFGPJO.js";import"./chunk-PEW2PLAN.js";import"./chunk-Q6Y4JG7Q.js";import"./chunk-7F5DJLJT.js";import"./chunk-CX5IFQZJ.js";import"./chunk-NJWTSROP.js";import"./chunk-D3R25AF2.js";import"./chunk-ARRCN5K3.js";import"./chunk-O3EGNJTY.js";import"./chunk-GHKL3NOH.js";import"./chunk-WGAOVKGR.js";import"./chunk-4N4D2YQX.js";import"./chunk-G4DZJMGT.js";import"./chunk-WTB3O6DJ.js";import"./chunk-7P44K2YD.js";import"./chunk-32OAXCA4.js";import"./chunk-UST6HCE7.js";import"./chunk-K5T5FD5C.js";import"./chunk-MVHHPJM7.js";import"./chunk-VDO6JJ3Y.js";import"./chunk-WFKZLI6F.js";import"./chunk-X2B63YVS.js";import"./chunk-BAEF3CT6.js";import"./chunk-AUAZP44J.js";import"./chunk-PVDFCTA4.js";import"./chunk-KNVXE32P.js";import"./chunk-76ATOSLU.js";import"./chunk-CCJU4DSH.js";import{a as U,e as W,k as j}from"./chunk-TG45K3WR.js";import"./chunk-RAI4DTMT.js";import"./chunk-ACP3S2CH.js";import"./chunk-HVAXZ2NA.js";import"./chunk-T7DXJKX7.js";import"./chunk-TYYVNQUR.js";import{a as d}from"./chunk-QGVBCWUY.js";import"./chunk-MYO4NP2N.js";import{e as m}from"./chunk-NFIPKH6V.js";import"./chunk-JPU2PQZC.js";import{l as G}from"./chunk-5QEXLALV.js";import"./chunk-P6QFA5MM.js";import"./chunk-DGTD7Y73.js";import"./chunk-LI2SX4T6.js";import"./chunk-BWO7LS2H.js";import"./chunk-HEVQSRJ2.js";import"./chunk-OVHPPCBL.js";import"./chunk-SNFOAZZQ.js";import"./chunk-AML4XSEF.js";import{b as P,c as x,e as z,p as N,r as O}from"./chunk-4PTIEWMT.js";import"./chunk-TG2UTNEO.js";import{b as A}from"./chunk-YOFFGXOB.js";import"./chunk-XRGPJ3QY.js";import"./chunk-6MRUJ2UW.js";import"./chunk-2LI2GKBQ.js";import{a as V}from"./chunk-QBWJMFH5.js";import{f as M}from"./chunk-VTHXE323.js";var I=class{constructor(e,t,s){this._scale=e,this._shift=t,this._levelShift=s}getLevelRowColumn(e){let t=this.getLevelShift(e[0]),s=this._shift+t;return s?[e[0]-t,e[1]>>s,e[2]>>s]:e}getLevelShift(e){return Math.min(e,this._levelShift)}getOffset(e,t){let s=0,l=0,i=this._shift+this.getLevelShift(e[0]);if(i){let o=(1<<i)-1,r=t/(this._scale*(1<<i-1));s=(e[2]&o)*r,l=(e[1]&o)*r}return[s,l]}getScale(e){return this._scale*(1<<this._shift+this.getLevelShift(e))}};var S=class extends ae{constructor(e,t,s,l){super(e,t,s,e.tileInfo.lods.length-1),this._memCache=l,this._ongoingTileRequests=new Map,this._ongoingRequestToController=new Map,this._tileInfoView=new ne(e.tileInfo,e.fullExtent)}destroy(){super.destroy(),this._ongoingRequestToController.forEach(e=>e.abort()),this._ongoingRequestToController.clear(),this._ongoingTileRequests.clear()}getVectorTile(e,t){return M(this,null,function*(){let s=new Q(e[0],e[1],e[2],0),l=this._memCache.get(s.id);if(l)return l.retain(),l;let i=yield this._getVectorTileData(s);if(N(t),!this._layer)return null;if(l=this._memCache.get(s.id),l)return l.retain(),l;let o=this._layer.tileInfo.getTileBounds(Z(),s),r=this._tileInfoView.getTileResolution(e[0]);return l=new oe(s,r,o[0],o[3],512,512,this._styleRepository,this._memCache),l.setData(i),i&&(l.retain(),this._memCache.put(s.id,l,K)),l.neededForCoverage=!0,l.transforms.tileUnitsToPixels=$(1/8,0,0,0,1/8,0,0,0,1),l})}_getVectorTileData(e){let t=e.id;if(this._ongoingTileRequests.has(t))return this._ongoingTileRequests.get(t);let s=new AbortController,l={signal:s.signal},i=this._getParsedVectorTileData(e,l).then(o=>(this._ongoingTileRequests.delete(t),this._ongoingRequestToController.delete(t),o)).catch(()=>(this._ongoingTileRequests.delete(t),this._ongoingRequestToController.delete(t),null));return this._ongoingTileRequests.set(t,i),this._ongoingRequestToController.set(t,s),i}_getParsedVectorTileData(e,t){return this.fetchTileData(e,t).then(s=>this.parseTileData({key:e,data:s},t))}};var f={vtlBackground:J,vtlFill:ee,vtlLine:te,vtlCircle:X,vtlSymbol:ie};var _=1e-6,w=class{constructor(e,t){this.spriteMosaic=e,this.glyphMosaic=t,this._brushCache={vtlBackground:null,vtlFill:null,vtlLine:null,vtlCircle:null,vtlSymbol:null},this._vtlMaterialManager=new se}dispose(){this._brushCache.vtlBackground?.dispose(),this._brushCache.vtlFill?.dispose(),this._brushCache.vtlLine?.dispose(),this._brushCache.vtlCircle?.dispose(),this._brushCache.vtlSymbol?.dispose(),this._brushCache=null,this._vtlMaterialManager=x(this._vtlMaterialManager),this.spriteMosaic.dispose(),this.glyphMosaic.dispose()}get vectorTilesMaterialManager(){return this._vtlMaterialManager}drawSymbols(e,t,s){let l=s.layers;e.renderPass="translucent";let i=this._brushCache.vtlSymbol;i==null&&(i=new f.vtlSymbol,this._brushCache.vtlSymbol=i),y[0]=t;for(let o=0;o<l.length;o++){let r=l[o];if(r.type!==p.SYMBOL)continue;let n=r.getLayoutProperty("visibility");if(n&&n.getValue()===H.NONE)continue;let h=e.displayLevel;r.minzoom!==void 0&&r.minzoom>h+_||r.maxzoom!==void 0&&r.maxzoom<=h-_||(e.styleLayerUID=r.uid,e.styleLayer=r,i.drawMany(e,y))}y[0]=null}drawBackground(e,t,s){if(s.backgroundBucketIds.length===0)return;let{context:l,displayLevel:i,requiredLevel:o}=e;t.key.level=o,l.setBlendingEnabled(!0),l.setDepthTestEnabled(!1),l.setStencilTestEnabled(!1),e.renderPass="background";let r=this._brushCache.vtlBackground;r==null&&(r=new f.vtlBackground,this._brushCache.vtlBackground=r),y[0]=t,s.backgroundBucketIds.forEach(n=>{let h=s.getLayerById(n);if(h.type!==p.BACKGROUND)return;let C=h.getLayoutProperty("visibility");C&&C.getValue()===H.NONE||h.minzoom!==void 0&&h.minzoom>i+_||h.maxzoom!==void 0&&h.maxzoom<=i-_||(e.styleLayerUID=h.uid,e.styleLayer=h,r.drawMany(e,y))}),y[0]=null}drawTile(e,t,s,l){let{context:i}=e,o=s.layers;i.setBlendingEnabled(!1),i.setDepthTestEnabled(!0),i.setDepthWriteEnabled(!0),i.setDepthFunction(Y.LEQUAL);let r=o.filter(n=>l!=null&&l!==n.type||!t.layerData.has(n.uid)?!1:n.getLayoutProperty("visibility")?.getValue()!==H.NONE);e.renderPass="opaque";for(let n=r.length-1;n>=0;--n)this._renderStyleLayer(r[n],e,t);i.setDepthWriteEnabled(!1),i.setBlendingEnabled(!0),i.setBlendFunctionSeparate(L.ONE,L.ONE_MINUS_SRC_ALPHA,L.ONE,L.ONE_MINUS_SRC_ALPHA),e.renderPass="translucent",r.forEach(n=>this._renderStyleLayer(n,e,t)),i.setDepthTestEnabled(!1),i.bindVAO()}_renderStyleLayer(e,t,s){let{renderPass:l}=t,i;switch(e.type){case p.BACKGROUND:if(l!=="background")return;i=this._brushCache.vtlBackground,i||(i=new f.vtlBackground,this._brushCache.vtlBackground=i);break;case p.FILL:if(l!=="opaque"&&t.renderPass!=="translucent")return;i=this._brushCache.vtlFill,i==null&&(i=new f.vtlFill,this._brushCache.vtlFill=i);break;case p.LINE:if(l!=="translucent")return;i=this._brushCache.vtlLine,i==null&&(i=new f.vtlLine,this._brushCache.vtlLine=i);break;case p.CIRCLE:if(l!=="translucent")return;i=this._brushCache.vtlCircle,i==null&&(i=new f.vtlCircle,this._brushCache.vtlCircle=i);break;case p.SYMBOL:if(l!=="translucent")return;i=this._brushCache.vtlSymbol,i==null&&(i=new f.vtlSymbol,this._brushCache.vtlSymbol=i)}let{displayLevel:o}=t,{minzoom:r,maxzoom:n}=e;if(r!==void 0&&r>o+_||n!==void 0&&n<=o-_)return;let{context:h}=t;h.setStencilTestEnabled(!1),h.setStencilWriteMask(0),t.styleLayerUID=e.uid,t.styleLayer=e,y[0]=s,i.drawMany(t,y),y[0]=null}},y=[null];var c=class extends ue(re(le)){constructor(){super(...arguments),this._tileHandlerController=null,this.type="vector-tile-3d",this.levelShift=V("disable-feature:vtl-level-shift")?0:1}initialize(){if(this.layer.fullExtent==null)return void this.addResolvingPromise(Promise.reject(new A("vectortilelayerview:full-extent-undefined","This layer view's layer does not define a fullExtent.")));let{basemapTerrain:a,spatialReference:e,state:t,viewingMode:s}=this.view,l=s==="local"&&!he(e)||ce.force512VTL?this.layer.tileInfo:this.layer.tileInfo.getCompatibleForVTL(256),i=this._getTileInfoSupportError(l,this.layer.fullExtent);if(i!=null)return this.addResolvingPromise(Promise.reject(i));let o=W(()=>this.view?.basemapTerrain?.tilingSchemeLocked).then(()=>{let u=a.tilingScheme,g=u.pixelSize,E=g===256?1:2,v=a.spatialReference?.isGeographic&&g===256?1:0,T=a.spatialReference?.isGeographic||g!==256?0:1,b;this.schemaHelper=new I(E,v,this.levelShift+T),b=g===256||g===512?this.layer.tileInfo.getCompatibleForVTL(g):this.layer.tileInfo;let R=this._getTileInfoCompatibilityError(b,u);if(R)throw R;this.tileInfo=b});this._tileHandlerController=new AbortController;let r=this.view.resourceController;this._memCache=r.memoryController.newCache(`vtl-${this.layer.uid}`,u=>u.release()),this.addHandles(U(()=>this.view.qualitySettings.memoryLimit,u=>this._memCache.maxSize=Math.ceil(u/10*1048576),j));let n=new k(this.layer.currentStyleInfo.style);this._tileHandler=new S(this.layer,n,t.contentPixelRatio,this._memCache);let h=this._tileHandlerController.signal,C=ye(r),D=this._tileHandler.start({signal:h,schedule:C}),q=this._tileHandler.spriteMosaic;q.then(u=>{!O(h)&&this._tileHandler&&(this.painter=new w(u,this._tileHandler.glyphMosaic))}),D.then(()=>this._tileHandlerController=null);let B=()=>{this._tileHandlerController&&this._tileHandlerController.abort(),this._tileHandlerController=new AbortController,this._memCache.clear();let u=this.layer.currentStyleInfo.style,g=this.view.state?.contentPixelRatio??1,E=new k(u),v=new S(this.layer,E,g,this._memCache),T=v.start({signal:this._tileHandlerController.signal,schedule:C}),b=v.spriteMosaic;T.then(()=>this._tileHandlerController=null),this._updatingHandles.addPromise(Promise.all([T,b]).then(([,R])=>{let me=this._tileHandler,F=this.painter;this.painter=new w(R,v.glyphMosaic),this._tileHandler=v,this.emit("data-changed"),me.destroy(),F&&F.dispose()}))};this._updatingHandles.add(()=>({style:this.layer.currentStyleInfo.style,pixelRatio:this.view.state?.contentPixelRatio}),B),this.addHandles([this.layer.on("paint-change",()=>this.emit("data-changed")),this.layer.on("style-layer-change",B),this.layer.on("delete-style-layer",B),this.layer.on("spriteSource-change",()=>this.emit("data-changed")),this.layer.on("layout-change",()=>this.emit("data-changed")),this.layer.on("style-layer-visibility-change",()=>this.emit("data-changed"))]);let de=Promise.all([o,D,q]);this.addResolvingPromise(de)}destroy(){this.painter=x(this.painter),this._tileHandlerController=z(this._tileHandlerController),this._tileHandler=P(this._tileHandler),this._memCache=P(this._memCache)}get contentZoom(){return V("disable-feature:vtl-level-shift")?1:this.view.qualitySettings.tiledSurface.vtlContentZoom}get displayLevelRange(){let a=this.tileInfo.lods,e=this.layer.minScale||a[0].scale,t=this.layer.maxScale||a[a.length-1].scale,s=this.levelRangeFromScaleRange(e,t);return this.layer.maxScale?s.maxLevel++:s.maxLevel+=this.levelShift,s}get dataScaleRange(){let a=this.tileInfo.lods;return{minScale:a[0].scale,maxScale:a[a.length-1].scale}}get dataLevelRange(){let{minScale:a,maxScale:e}=this.dataScaleRange,t=this.levelRangeFromScaleRange(a,e);return t.minLevel===1&&this.tileInfo.size[0]===256&&(t.minLevel=0),t.maxLevel+=this.levelShift,t}fetchTile(a,e){return M(this,null,function*(){let t=this.schemaHelper.getLevelRowColumn(a);return this._tileHandler.getVectorTile(t,e)})}get hasVisibleFeatures(){return!0}};d([m()],c.prototype,"layer",void 0),d([m()],c.prototype,"levelShift",void 0),d([m()],c.prototype,"contentZoom",null),d([m()],c.prototype,"displayLevelRange",null),d([m()],c.prototype,"tileInfo",void 0),d([m()],c.prototype,"dataScaleRange",null),d([m()],c.prototype,"dataLevelRange",null),d([m()],c.prototype,"updatingProgressValue",void 0),c=d([G("esri.views.3d.layers.VectorTileLayerView3D")],c);var it=c;function ye(a){return e=>a.immediate.schedule(e)}export{it as default};
