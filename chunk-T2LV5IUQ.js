import{a as R}from"./chunk-H25DKJGS.js";import{a as C}from"./chunk-TIWKONVC.js";import{e as O,h as T}from"./chunk-PBAMEKFE.js";import{g as p}from"./chunk-3CLJ5OX5.js";import{c as j}from"./chunk-7QNKS2X6.js";import{a as w}from"./chunk-VCCMJ6BV.js";import{a as V}from"./chunk-QK56OQGR.js";import{a as S}from"./chunk-POX73EYJ.js";import{a as _}from"./chunk-GHKL3NOH.js";import{a as b}from"./chunk-WGAOVKGR.js";import{a as L}from"./chunk-TG45K3WR.js";import{b as v}from"./chunk-ACP3S2CH.js";import{a as i}from"./chunk-QGVBCWUY.js";import{e as o}from"./chunk-NFIPKH6V.js";import{l as g}from"./chunk-5QEXLALV.js";import{a as c,c as m,r as f}from"./chunk-P6QFA5MM.js";import{a as d}from"./chunk-TG2UTNEO.js";var r=class extends w(j(R(V))){constructor(e){super(e),this._layerCache=new S(20,t=>t.destroy()),this._oidToReference=new _,this._layerToReference=new Map,this.legendEnabled=!0,this.layers=new v,this.maximumVisibleSublayers=10,this.opacity=1,this.parent=null,this.persistenceEnabled=!0,this.title="Layers in view",this.type="catalog-dynamic-group",this.visible=!0}initialize(){this.addHandles([this.layers.on("after-add",({item:e})=>{e.parent=this}),this.layers.on("after-remove",({item:e})=>{e.parent=null}),L(()=>this._orderBy,()=>{this._updateLayerSortValues(),this._sortAllLayers()})])}load(e){return this.addResolvingPromise(this.parent.load()),Promise.resolve(this)}destroy(){this._layerCache.destroy(),this._oidToReference.clear(),this._layerToReference.clear()}get _orderBy(){return this.parent?this.parent.orderBy?.find(e=>!e.valueExpression&&e.field)??new C({field:this.parent.objectIdField}):null}get _referenceComparator(){let e=this._orderBy;if(!this.parent||!e)return()=>0;let t=this.parent.fieldsIndex.get(e.field),n=p(t?.toJSON().type,e.order==="descending"),s=p("esriFieldTypeOID",e.order==="descending");return(l,a)=>n(a.sortValue,l.sortValue)||s(a.objectId,l.objectId)}get fullExtent(){return this.parent?.fullExtent??null}get updating(){return c(this._oidToReference,({pending:e})=>e!=null)}acquireLayer(e){if(this.destroyed)return d();let t=this._getLayerReference(e);return t.count++,d(()=>{t.count--,t.count||this._destroyLayerReference(t)})}_getLayerReference(e){let t=e.getObjectId();return m(this._oidToReference,t,()=>{let n=e.getObjectId(),s=`${n}`,l=e.getAttribute(this.parent.itemSourceField),a=new y(e,n,l),h=this._layerCache.pop(s);return h?(this._addLayer(a,h),a):(a.pending=this.parent.createLayerFromFootprint(e).then(u=>{a.count?this._addLayer(a,u):(this.destroyed||this._layerCache.get(s)||this._layerCache.put(s,u),a.layer=null)}).catch(()=>{}).finally(()=>{a.pending=null}),a)})}_destroyLayerReference(e){e.layer&&(this._layerToReference.delete(e.layer),this.layers.remove(e.layer),this.destroyed?e.layer.destroy():this._layerCache.put(`${e.objectId}`,e.layer),e.layer=null),this._oidToReference.delete(e.objectId)}_addLayer(e,t){e.layer=t,t.persistenceEnabled=!1,this._layerToReference.set(t,e),this._updateLayerSortValue(e),this.layers.add(t),this._sortAllLayers()}_updateLayerSortValues(){for(let e of this._layerToReference.values())this._updateLayerSortValue(e)}_updateLayerSortValue(e){this._orderBy&&(e.sortValue=e.footprint.getAttribute(this._orderBy.field))}_sortAllLayers(){this.layers.sort((e,t)=>this._referenceComparator(this._layerToReference.get(e),this._layerToReference.get(t)))}};i([o()],r.prototype,"_orderBy",null),i([o({readOnly:!0})],r.prototype,"_referenceComparator",null),i([o(O)],r.prototype,"legendEnabled",void 0),i([o({type:["show","hide","hide-children"],json:{write:!0}})],r.prototype,"listMode",void 0),i([o({readOnly:!0})],r.prototype,"fullExtent",null),i([o({type:String,json:{origins:{service:{read:!1},"portal-item":{read:!1}},write:{ignoreOrigin:!0,isRequired:!0}}})],r.prototype,"id",void 0),i([o({readOnly:!0})],r.prototype,"layers",void 0),i([o({type:f,range:{min:0,max:50},json:{write:!0,default:10}})],r.prototype,"maximumVisibleSublayers",void 0),i([o(T)],r.prototype,"opacity",void 0),i([o({clonable:!1})],r.prototype,"parent",void 0),i([o({type:String,nonNullable:!0,json:{write:{ignoreOrigin:!0,isRequired:!0}}})],r.prototype,"title",void 0),i([o({json:{read:!1}})],r.prototype,"type",void 0),i([o({readOnly:!0})],r.prototype,"updating",null),i([o({type:Boolean,json:{name:"visibility",write:!0}})],r.prototype,"visible",void 0),r=i([g("esri.layers.catalog.CatalogDynamicGroupLayer")],r);var W=r,y=class{constructor(t,n,s){this.footprint=t,this.objectId=n,this.itemSource=s,this.count=0,this.layer=null,this.sortValue=void 0,this._pending=b(null)}get pending(){return this._pending.value}set pending(t){this._pending.value=t}};export{W as a};
