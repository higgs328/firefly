import{m as v}from"./chunk-D43YNUSN.js";import{l as z}from"./chunk-B3VPRADQ.js";import{f as T}from"./chunk-TPNSUEHH.js";import{a as h}from"./chunk-GNGXUEWV.js";import{a as w}from"./chunk-HVJAAM3A.js";import{a as I}from"./chunk-DZHFTD24.js";import{a as y}from"./chunk-K57Z4J34.js";import{a as b}from"./chunk-VWG3KVOU.js";import{W as V}from"./chunk-KALOJIUA.js";import{a as F}from"./chunk-7P44K2YD.js";import{b as x}from"./chunk-UST6HCE7.js";import{i as g}from"./chunk-QBWJMFH5.js";import{f as c}from"./chunk-VTHXE323.js";var M=0;var N="expression/";function R(e){return"hasVisualVariables"in e&&e.hasVisualVariables()?e.visualVariables.filter(i=>!T.test(i.valueExpression)&&(!("target"in i)||i.target!=="outline")):[]}function d(e,i){return i?v(e)?.find(t=>t.name.toLowerCase()===i.toLowerCase()):null}function $(e,i,l){let t=null;if(l&&"featureReduction"in e){let r=e.featureReduction;r&&"popupTemplate"in r&&r.popupTemplate&&(t=r.popupTemplate.fieldInfos)}else"popupTemplate"in e&&e.popupTemplate&&(t=e.popupTemplate.fieldInfos);let a=l?d(e,i):e.getField(i),o=null;if(t&&t.some(r=>!(!r||r.fieldName?.toLowerCase()!==a?.name.toLowerCase())&&(o=r.clone(),!0)),!o){let r=V.includes(a.type),p=a.type==="integer"||a.type==="small-integer";o=new y({fieldName:a.name,isEditable:a.editable,visible:!0,format:r?new b({places:p?0:2,digitSeparator:!0}):void 0})}return o.label||(o.label=a.alias),o}function E(e){let{expression:i,title:l,returnType:t}=e;return new w({name:"expr"+M++,expression:i,title:l,returnType:t})}function L(e){let i=e.returnType==="number"?new b({places:2,digitSeparator:!0}):void 0;return new y({fieldName:`${N}${e.name}`,visible:!0,format:i})}function ee(e){return c(this,null,function*(){let i=yield x("esri/smartMapping/t9n/smartMapping"),{renderer:l,layer:t,normFieldExpressionTemplate:a,isFeatureReduction:o}=e,r=[],p=[],f=z(l,R);for(let n of f)if(n.type==="field")r.push($(t,n.field,o));else if(n.type==="normalized-field"){let s=o?d(t,n.field):t.getField(n.field),m=o?d(t,n.normalizationField):t.getField(n.normalizationField),u=E({type:"expression",expression:`
      $feature["${s.name}"];
      $feature["${m.name}"];
      ${a==="percentage"?`($feature["${s.name}"] / $feature["${m.name}"]) * 100;`:`$feature["${s.name}"] / $feature["${m.name}"];`}
      `,title:F(a==="percentage"?i.normFieldLabelAsPercent:i.normFieldLabel,{expression1:s.alias,expression2:m.alias}),returnType:"number"});r.push(L(u),$(t,n.field,o),$(t,n.normalizationField,o)),p.push(u)}else if(n.type==="expression"){let s=E(n);r.push(L(s)),p.push(s)}return{fieldInfos:g(r,(n,s)=>n.fieldName===s.fieldName),expressionInfos:g(p,(n,s)=>n.expression===s.expression)}})}function ie(e,i,l){return c(this,null,function*(){let{fieldInfos:t,expressionInfos:a}=i,o=yield x("esri/smartMapping/t9n/smartMapping");if(t.length>2)return[new I({fieldInfos:t})];let r=[];for(let p of t){let f=p.fieldName||"",n=p.label;if(!n){let s=l?d(e,f):e.getField(f);if(s)n=s.alias||f;else if(a){let m=f.split(N)[1],u=a[a.findIndex(C=>C.name===m)];u&&(n=u.title||u.name)}}r.push(new h({text:F(o.fieldInfo,{fieldLabel:n,fieldValue:`{${f}}`})}))}return r})}function te(e){return!(!("normalizationField"in e)||!e.normalizationField)||"hasVisualVariables"in e&&e.hasVisualVariables()&&e.visualVariables.some(i=>!(!("normalizationField"in i)||!i.normalizationField))}export{N as a,R as b,$ as c,ee as d,ie as e,te as f};
