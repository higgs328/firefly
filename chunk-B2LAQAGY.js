import{a as x,d as l}from"./chunk-CZMBPC27.js";import{k as c,l as _}from"./chunk-HM5RIVQC.js";import{p as o}from"./chunk-2ZFXOJDB.js";var a=class{constructor(t){this._maxCount=t,this._nextIndex=0,this._recycledIndices=[]}get activeCount(){return this._nextIndex-this._recycledIndices.length}get availableCount(){return this._recycledIndices.length+this._maxCount-this._nextIndex}acquire(){return this._recycledIndices.length>0?this._recycledIndices.pop():this.availableCount?this._nextIndex++:void 0}release(t){this._recycledIndices.push(t)}};var u=class{constructor(t,e=1){this._rctx=t,this._fieldCount=e,this.textureWidth=4096,this._dirty=!0;let s=new x(this.textureWidth,1);s.samplingMode=c.NEAREST,s.wrapMode=_.CLAMP_TO_EDGE,this._texture=new l(this._rctx,s),this._data=new o(new ArrayBuffer(4*this.textureWidth))}dispose(){this._texture.dispose(),this._texture=void 0,this._data=void 0}setData(t,e,s,r,h,g){let i=t*this._fieldCount+e;this._dirty=!0,this._data.set(i,0,s),this._data.set(i,1,r),this._data.set(i,2,h),this._data.set(i,3,g)}setDataElement(t,e,s,r){let h=t*this._fieldCount+e;this._dirty=!0,this._data.set(h,s,r)}getDataElement(t,e,s){let r=t*this._fieldCount+e;return this._dirty=!0,this._data.get(r,s)}resizeToFit(t){let e=(t+1)*this._fieldCount;if(e>this._data.count){let s=Math.ceil(e/this.textureWidth)*this.textureWidth,r=new o(new ArrayBuffer(4*s));r.typedBuffer.set(this._data.typedBuffer),this._data=r}}updateTexture(){if(!this._dirty)return;let t=this._texture.descriptor.width,e=this._texture.descriptor.height;this._data.count>t*e&&this._texture.resize(t,this._data.count/t),this._texture.setData(this._data.typedBuffer),this._dirty=!1}get texture(){return this._texture}};var f=65536,n=class{constructor(t,e=1){this.textureBuffer=new u(t,e),this._indexManager=new a(f)}dispose(){this.textureBuffer.dispose(),this.textureBuffer=void 0}get availableCount(){return this._indexManager.availableCount}get activeCount(){return this._indexManager.activeCount}acquireIndex(){let t=this._indexManager.acquire();return this.textureBuffer.resizeToFit(t),t}releaseIndex(t){this._indexManager.release(t)}};var p=class{constructor(t,e=1){this._rctx=t,this._fieldCount=e,this._buffers=[]}garbageCollect(){this._buffers=this._buffers.filter(t=>t.activeCount!==0||(t.dispose(),!1))}destroy(){this._buffers.forEach(t=>t.dispose()),this._buffers=[]}getBuffer(t){for(let s of this._buffers)if(s.availableCount>=t)return s;if(t>f)return null;let e=new n(this._rctx,this._fieldCount);return this._buffers.push(e),e}updateTextures(){for(let t of this._buffers)t.textureBuffer.updateTexture()}};export{p as a};
