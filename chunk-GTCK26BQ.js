import{a as H}from"./chunk-AC55GQHL.js";import{a as it}from"./chunk-HB42CTAY.js";import{a as rt}from"./chunk-55O4EG62.js";import{a as tt}from"./chunk-FHBFWDFD.js";import{a as et}from"./chunk-KGCPVVBF.js";import{q as Le}from"./chunk-EJ2UYJJS.js";import{a as pe}from"./chunk-7U52UAO2.js";import{a as Xe}from"./chunk-2WYOVBUR.js";import{A as Ke,B as We,a as qe,b as B,d as se,e as oe,f as ye,g as Ze,h as k,i as ge,j as _e,m as Be,n as He,q as De,r as Qe,s as Je,t as be,u as ae,v as ne,w as le,x as Ge,y as ze,z as C}from"./chunk-Y4PJQPM4.js";import{c as ve}from"./chunk-P4JHTV62.js";import{a as je}from"./chunk-2DFFQEIV.js";import{a as Z}from"./chunk-LAX5536Z.js";import{a as re}from"./chunk-GNGXUEWV.js";import{a as Ue}from"./chunk-HVJAAM3A.js";import{b as $e}from"./chunk-YP2E5N4E.js";import{a as Pe}from"./chunk-NJLJX4X6.js";import{a as Oe}from"./chunk-DZHFTD24.js";import{a as ie}from"./chunk-K57Z4J34.js";import{a as Ne}from"./chunk-JZQDGIDQ.js";import{b as te}from"./chunk-2HYVVLKS.js";import{a as Se}from"./chunk-TJ6P6NLD.js";import{_ as Ye}from"./chunk-KALOJIUA.js";import{a as Ve}from"./chunk-K75TK42V.js";import{c as ee}from"./chunk-VIEK2X23.js";import{a as Re}from"./chunk-7F5DJLJT.js";import{a as Y}from"./chunk-G4DZJMGT.js";import{a as Me}from"./chunk-MVHHPJM7.js";import{o as Fe}from"./chunk-AUAZP44J.js";import{a as E,b as X,c as Ee,e as ke,j as S}from"./chunk-TG45K3WR.js";import{f as q}from"./chunk-RAI4DTMT.js";import{b as Ce}from"./chunk-ACP3S2CH.js";import{a as l}from"./chunk-QGVBCWUY.js";import{H as M}from"./chunk-MYO4NP2N.js";import{e as c}from"./chunk-NFIPKH6V.js";import{l as F}from"./chunk-5QEXLALV.js";import{B as L,e as T,p as $,w as Te,y as me}from"./chunk-4PTIEWMT.js";import{b as he}from"./chunk-YOFFGXOB.js";import{g as N}from"./chunk-XRGPJ3QY.js";import{i as fe,y as W}from"./chunk-QBWJMFH5.js";import{a as y,b as Ae,f as _}from"./chunk-VTHXE323.js";var ce=class{constructor(t,i){this.preLayerQueryCallback=t,this.preRequestCallback=i,this.preLayerQueryCallback||(this.preLayerQueryCallback=r=>{}),this.preRequestCallback||(this.preLayerQueryCallback=r=>{})}};var z=class extends et{constructor(e){super(e),this.description=null,this.title=null}};l([c()],z.prototype,"description",void 0),l([c()],z.prototype,"title",void 0),z=l([F("esri.widgets.Feature.FeatureAttachments.FeatureAttachmentsViewModel")],z);var st=z;var P=class extends M{constructor(e){super(e),this._loadingPromise=null,this.created=null,this.creator=null,this.destroyer=null,this.graphic=null,this.addHandles(E(()=>this.creator,t=>{this._destroyContent(),this._createContent(t)},S))}destroy(){this._destroyContent()}get state(){return this._loadingPromise?"loading":"ready"}_destroyContent(){let{created:e,graphic:t,destroyer:i}=this;e&&t&&(B({type:"content",value:i,event:{graphic:t}}),this._set("created",null))}_createContent(e){return _(this,null,function*(){let t=this.graphic;if(!t||!e)return;let i=B({type:"content",value:e,event:{graphic:t}});this._loadingPromise=i,this.notifyChange("state");let r=yield i;i===this._loadingPromise&&(this._loadingPromise=null,this.notifyChange("state"),this._set("created",r))})}};l([c({readOnly:!0})],P.prototype,"created",void 0),l([c()],P.prototype,"creator",void 0),l([c()],P.prototype,"destroyer",void 0),l([c({type:Z})],P.prototype,"graphic",void 0),l([c({readOnly:!0})],P.prototype,"state",null),P=l([F("esri.widgets.Feature.FeatureContent.FeatureContentViewModel")],P);var K=P;var R=class extends M{constructor(e){super(e),this.attributes=null,this.expressionInfos=null,this.description=null,this.fieldInfos=null,this.title=null}get formattedFieldInfos(){let{expressionInfos:e,fieldInfos:t}=this,i=[];return t?.forEach(r=>{if(!(!r.hasOwnProperty("visible")||r.visible))return;let s=r.clone();s.label=oe(s,e),i.push(s)}),i}};l([c()],R.prototype,"attributes",void 0),l([c({type:[Ue]})],R.prototype,"expressionInfos",void 0),l([c()],R.prototype,"description",void 0),l([c({type:[ie]})],R.prototype,"fieldInfos",void 0),l([c({readOnly:!0})],R.prototype,"formattedFieldInfos",null),l([c()],R.prototype,"title",void 0),R=l([F("esri.widgets.Feature.FeatureFields.FeatureFieldsViewModel")],R);var de=R;var Ft="esri.widgets.Feature.support.relatedFeatureUtils",ot=()=>N.getLogger(Ft),at=new Map;function D(e){if(!C(e))return null;let[t,i]=e.split("/").slice(1);return{layerId:t,fieldName:i}}function Mt(e,t){if(!t.relationships)return null;let i=null,{relationships:r}=t;return r.some(s=>s.id===parseInt(e,10)&&(i=s,!0)),i}function Ct({originRelationship:e,relationships:t,layerId:i}){return t.find(({relatedTableId:r,id:s})=>`${r}`===i&&s===e?.id)??null}function Et(e,t){let i=t.toLowerCase();for(let r in e)if(r.toLowerCase()===i)return e[r];return null}function nt(e,t){let i=Mt(e,t);if(i)return{url:`${t.url}/${i.relatedTableId}`,sourceSpatialReference:t.spatialReference,relation:i,relatedFields:[],outStatistics:[]}}function lt(e,t){if(!t||!e)return;let{features:i,statsFeatures:r}=e,s=i?.value;t.relatedFeatures=s?s.features:[];let o=r?.value;t.relatedStatsFeatures=o?o.features:[]}function kt(e,t,i,r){let s=new je;return s.outFields=["*"],s.relationshipId=typeof t.id=="number"?t.id:parseInt(t.id,10),s.objectIds=[e.attributes[i.objectIdField]],s.gdbVersion=i.gdbVersion??null,s.historicMoment=i.historicMoment??null,i.queryRelatedFeatures?.(s,r)??Promise.resolve({})}function Rt(e,t,i){let r=0,s=[];for(;r<t.length;)s.push(`${e} IN (${t.slice(r,i+r)})`),r+=i;return s.join(" OR ")}function Vt(e){return e?fe(e):void 0}function Lt(e){return e?fe(e,(t,i)=>JSON.stringify(t.toJSON())===JSON.stringify(i.toJSON())):void 0}function St(e,t,i,r){return _(this,null,function*(){let s=i.layerId.toString(),{layerInfo:o,relation:n,relatedFields:a,outStatistics:d,url:p,sourceSpatialReference:u}=t,f=Vt(a),m=Lt(d);if(!o||!n)return null;let g=Ct({originRelationship:n,relationships:o.relationships,layerId:s});if(g?.relationshipTableId&&g.keyFieldInRelationshipTable){let w=(yield kt(e,g,i,r))[e.attributes[i.objectIdField]];if(!w)return null;let A=w.features.map(I=>I.attributes[o.objectIdField]);if(m?.length&&o.supportsStatistics){let I=new te;I.where=Rt(o.objectIdField,A,1e3),I.outFields=f,I.outStatistics=m,I.sourceSpatialReference=u;let J={features:Promise.resolve(w),statsFeatures:pe(p,I)};return L(J)}}let b=g?.keyField;if(b){let w=Ye(Ot(o.fields,b)),A=Et(e.attributes,n.keyField),I=w?`${b}=${A}`:`${b}='${A}'`,J=i.historicMoment,O=i.gdbVersion,G=pe(p,new te({where:I,outFields:f,sourceSpatialReference:u,historicMoment:J,gdbVersion:O}),r),V=m?.length&&o.supportsStatistics?pe(p,new te({where:I,outFields:f,outStatistics:m,sourceSpatialReference:u}),r):null,j={features:G};return V&&(j.statsFeatures=V),L(j)}return null})}function Pt(e,t){return Fe(e,{query:{f:"json"},signal:t?.signal})}function pt({relatedInfos:e,layer:t},i){let r={};return e.forEach((s,o)=>{let{relation:n}=s;if(!n){let f=new he("relation-required","A relation is required on a layer to retrieve related records.");throw ot().error(f),f}let{relatedTableId:a}=n;if(typeof a!="number"){let f=new he("A related table ID is required on a layer to retrieve related records.");throw ot().error(f),f}let d=`${t.url}/${a}`,p=at.get(d),u=p??Pt(d);p||at.set(d,u),r[o]=u}),Te(L(r),i)}function ct({graphic:e,relatedInfos:t,layer:i},r){let s={};return t.forEach((o,n)=>{o.layerInfo&&(s[n]=St(e,o,i,r))}),L(s)}function dt({relatedInfo:e,fieldName:t,fieldInfo:i}){if(e.relatedFields?.push(t),i.statisticType){let r=new Se({statisticType:i.statisticType,onStatisticField:t,outStatisticFieldName:t});e.outStatistics?.push(r)}}function Ot(e,t){if(e!=null){t=t.toLowerCase();for(let i of e)if(i&&i.name.toLowerCase()===t)return i}return null}var ut={chartAnimation:!0},v=class extends M{constructor(e){super(e),this.abilities=y({},ut),this.activeMediaInfoIndex=0,this.attributes=null,this.description=null,this.fieldInfoMap=null,this.formattedAttributes=null,this.expressionAttributes=null,this.isAggregate=!1,this.layer=null,this.mediaInfos=null,this.popupTemplate=null,this.relatedInfos=null,this.title=null}castAbilities(e){return y(y({},ut),e)}get activeMediaInfo(){return this.formattedMediaInfos[this.activeMediaInfoIndex]||null}get formattedMediaInfos(){return this._formatMediaInfos()||[]}get formattedMediaInfoCount(){return this.formattedMediaInfos.length}setActiveMedia(e){this._setContentElementMedia(e)}next(){this._pageContentElementMedia(1)}previous(){this._pageContentElementMedia(-1)}_setContentElementMedia(e){let{formattedMediaInfoCount:t}=this,i=(e+t)%t;this.activeMediaInfoIndex=i}_pageContentElementMedia(e){let{activeMediaInfoIndex:t}=this,i=t+e;this._setContentElementMedia(i)}_formatMediaInfos(){let{mediaInfos:e,layer:t}=this,i=this.attributes??{},r=this.formattedAttributes??{},s=this.expressionAttributes??{},o=this.fieldInfoMap??new Map;return e?.map(n=>{let a=n?.clone();return a?(a.title=k({attributes:i,fieldInfoMap:o,globalAttributes:r,expressionAttributes:s,layer:t,text:a.title}),a.caption=k({attributes:i,fieldInfoMap:o,globalAttributes:r,expressionAttributes:s,layer:t,text:a.caption}),a.altText=k({attributes:i,fieldInfoMap:o,globalAttributes:r,expressionAttributes:s,layer:t,text:a.altText}),a.type==="image"?a.value?(this._setImageValue({value:a.value,formattedAttributes:r,layer:t}),a.value.sourceURL?a:void 0):void 0:a.type==="pie-chart"||a.type==="line-chart"||a.type==="column-chart"||a.type==="bar-chart"?a.value?(this._setChartValue({value:a.value,chartType:a.type,attributes:i,formattedAttributes:r,layer:t,expressionAttributes:s}),a):void 0:null):null}).filter(W)??[]}_setImageValue(e){let t=this.fieldInfoMap??new Map,{value:i,formattedAttributes:r,layer:s}=e,{linkURL:o,sourceURL:n}=i;if(n){let a=_e(n,s);i.sourceURL=ge({formattedAttributes:r,template:a,fieldInfoMap:t})}if(o){let a=_e(o,s);i.linkURL=ge({formattedAttributes:r,template:a,fieldInfoMap:t})}}_setChartValue(e){let{value:t,attributes:i,formattedAttributes:r,chartType:s,layer:o,expressionAttributes:n}=e,{popupTemplate:a,relatedInfos:d}=this,{fields:p,normalizeField:u}=t,f=o;if(t.fields=Ze(p,f),u&&(t.normalizeField=ye(u,f)),!p.some(g=>!!(r[g]!=null||C(g)&&d?.size)))return;let m=a?.fieldInfos??[];p.forEach((g,b)=>{let w=t.colors?.[b];if(C(g))return void(t.series=[...t.series,...this._getRelatedChartInfos({fieldInfos:m,fieldName:g,formattedAttributes:r,chartType:s,value:t,color:w})]);let A=this._getChartOption({value:t,attributes:i,chartType:s,formattedAttributes:r,expressionAttributes:n,fieldName:g,fieldInfos:m,color:w});t.series.push(A)})}_getRelatedChartInfos(e){let{fieldInfos:t,fieldName:i,formattedAttributes:r,chartType:s,value:o,color:n}=e,a=[],d=D(i),p=d&&this.relatedInfos?.get(d.layerId.toString());if(!p)return a;let{relatedFeatures:u,relation:f}=p;if(!f||!u)return a;let{cardinality:m}=f;return u.forEach(g=>{let{attributes:b}=g;b&&Object.keys(b).forEach(w=>{w===d.fieldName&&a.push(this._getChartOption({value:o,attributes:b,formattedAttributes:r,fieldName:i,chartType:s,relatedFieldName:w,hasMultipleRelatedFeatures:u?.length>1,fieldInfos:t,color:n}))})}),m==="one-to-many"||m==="many-to-many"?a:[a[0]]}_getTooltip({label:e,value:t,chartType:i}){return i==="pie-chart"?`${e}`:`${e}: ${t}`}_getChartOption(e){let{value:t,attributes:i,formattedAttributes:r,expressionAttributes:s,fieldName:o,relatedFieldName:n,fieldInfos:a,chartType:d,hasMultipleRelatedFeatures:p,color:u}=e,f=this.layer,m=this.fieldInfoMap??new Map,{normalizeField:g,tooltipField:b}=t,w=g?C(g)?i[D(g).fieldName]:i[g]:null,A=se(o)&&s&&s[o]!==void 0?s[o]:n&&i[n]!==void 0?i[n]:i[o]!==void 0?i[o]:r[o],I=new Ne({fieldName:o,color:u,value:A===void 0?null:A&&w?A/w:A});if(C(o)){let j=m.get(o.toLowerCase()),wt=b&&m.get(b.toLowerCase()),xt=j?.fieldName??o,ue=p&&b?D(b).fieldName:wt?.fieldName??b,At=p&&ue?i[ue]:r[ue]??j?.label??j?.fieldName??n,Tt=p&&n?i[n]:r[xt];return I.tooltip=this._getTooltip({label:At,value:Tt,chartType:d}),I}let J=De(a,o),O=ye(o,f),G=b&&r[b]!==void 0?r[b]:oe(J||new ie({fieldName:O}),this.popupTemplate?.expressionInfos),V=r[O];return I.tooltip=this._getTooltip({label:G,value:V,chartType:d}),I}};l([c()],v.prototype,"abilities",void 0),l([Y("abilities")],v.prototype,"castAbilities",null),l([c()],v.prototype,"activeMediaInfoIndex",void 0),l([c({readOnly:!0})],v.prototype,"activeMediaInfo",null),l([c()],v.prototype,"attributes",void 0),l([c()],v.prototype,"description",void 0),l([c()],v.prototype,"fieldInfoMap",void 0),l([c()],v.prototype,"formattedAttributes",void 0),l([c()],v.prototype,"expressionAttributes",void 0),l([c({readOnly:!0})],v.prototype,"formattedMediaInfos",null),l([c()],v.prototype,"isAggregate",void 0),l([c()],v.prototype,"layer",void 0),l([c({readOnly:!0})],v.prototype,"formattedMediaInfoCount",null),l([c()],v.prototype,"mediaInfos",void 0),l([c()],v.prototype,"popupTemplate",void 0),l([c()],v.prototype,"relatedInfos",void 0),l([c()],v.prototype,"title",void 0),v=l([F("esri.widgets.Feature.FeatureMedia.FeatureMediaViewModel")],v);var U=v;var Nt="esri.widgets.Feature.support.arcadeFeatureUtils",Ie=()=>N.getLogger(Nt);function ft(e){return typeof e=="string"?ne(ae(e)):Array.isArray(e)?$t(e):e?.declaredClass==="esri.arcade.Dictionary"?Ut(e):e}function $t(e){return`<ul class="esri-widget__list">${e.map(t=>`<li>${typeof t=="string"?ne(ae(t)):t}</li>`).join("")}</ul>`}function Ut(e){let t=e.keys().map(i=>{let r=e.field(i);return`<tr><th>${i}</th><td>${typeof r=="string"?ne(ae(r)):r}</td></tr>`}).join("");return`<table class="${tt.table}">${t}</table>`}function we(){return _(this,null,function*(){let[e,t]=yield Promise.all([import("./chunk-ZQONKR2J.js"),import("./chunk-Z4F7AISQ.js")]);return{executor:e,syntaxUtils:t}})}function jt(e){return"createQuery"in e&&"queryFeatures"in e}function qt(r){return _(this,arguments,function*({graphic:e,view:t,options:i}){let{isAggregate:s,layer:o}=e;if(!s||!o||t?.type!=="2d")return[];let n=yield t.whenLayerView(o);if(!jt(n))return[];let a=n.createQuery(),d=e.getObjectId();a.aggregateIds=d!=null?[d]:[];let{features:p}=yield n.queryFeatures(a,i);return p})}function Zt({layer:e,aggregatedFeatures:t,interceptor:i}){let{fields:r,objectIdField:s,geometryType:o,spatialReference:n,displayField:a}=e;return new Xe(Ae(y({fields:r,objectIdField:s,geometryType:o,spatialReference:n,displayField:a,interceptor:i},e.type==="feature"?{templates:e.templates,typeIdField:e.typeIdField,types:e.types}:null),{source:t}))}function Bt(e){let t=e.declaredClass==="esri.views.3d.layers.VoxelGraphic";return e.isAggregate?"popup-feature-reduction":t?"popup-voxel":"popup"}function ht(e){return{scale:e?.scale,timeProperties:{currentStart:e?.timeExtent?.start,currentEnd:e?.timeExtent?.end,startIncluded:!0,endIncluded:!0}}}function Ht(e){return{$voxel:e}}function Dt(e,t,i,r,s){return _(this,null,function*(){let o=null;if(s.has("$aggregatedfeatures")){let n=yield qt({graphic:e,view:t,options:i}),a=e.sourceLayer||e.layer;o=Zt({layer:a,aggregatedFeatures:n,interceptor:r})}return{vars:{$feature:e,$aggregatedFeatures:o,$view:ht(t)},[Symbol.dispose]:()=>o?.[Symbol.dispose]()}})}function Qt(e,t,i,r){let s=(e.sourceLayer||e.layer)??void 0;return{$feature:e,$layer:s!=null&&Le(s)?s:s?.type==="scene"&&s.associatedLayer!=null?s.associatedLayer:void 0,$map:t,$datastore:s?.url,$userInput:i,$graph:s?.type==="knowledge-graph-sublayer"?s?.parentCompositeLayer?.knowledgeGraph:void 0,$view:ht(r)}}function Jt(d,p){return _(this,arguments,function*(e,{graphic:t,map:i,location:r,view:s,options:o,interceptor:n,arcadeExecutor:a}){switch(e){case"popup":return{vars:Qt(t,i,r,s),[Symbol.dispose](){}};case"popup-feature-reduction":{let u=new Set(a.variablesUsed);return yield Dt(t,s,o,n,u)}case"popup-voxel":return{vars:Ht(t),[Symbol.dispose](){}};default:throw new Error(`Unexpected profile name ${e}`)}})}function xe(s){return _(this,arguments,function*({expressionInfo:e,arcade:{executor:t,syntaxUtils:i},graphic:r}){let o=e?.expression;if(!o)return null;let n=Bt(r),a=t.createArcadeProfile(n),d;try{d=yield t.createArcadeExecutor(o,a)}catch(f){return Ie().error("arcade-executor-error",{error:f,expressionInfo:e}),null}let p=new Set;return d.variablesUsed.includes("$view")&&(i.scriptUsesViewProperties(d.syntaxTree,["scale"])&&p.add("view-scale"),i.scriptUsesViewProperties(d.syntaxTree,["timeProperties"])&&p.add("view-time-extent")),{dependencies:p,evaluate(J){return _(this,arguments,function*({graphic:f,interceptor:m,location:g,map:b,options:w,spatialReference:A,view:I}){let O=yield Jt(n,{graphic:f,map:b,location:g,view:I,options:w,interceptor:m,arcadeExecutor:d}),G={abortSignal:w?.signal??void 0,interceptor:m??void 0,rawOutput:!0,spatialReference:A??void 0,timeZone:I?.timeZone,console(...V){Ie().info(...V)}};try{return yield d.executeAsync(O.vars,G)}catch(V){return void Ie().error("arcade-execution-error",{error:V,graphic:f,expressionInfo:e})}finally{O[Symbol.dispose]()}})}}})}function mt(e,t){return _(this,null,function*(){if(!e?.length)return{dependencies:new Set,expressions:new Map};let i=yield we(),r=new Set,s=new Map;for(let o of e){let n=yield xe({expressionInfo:o,arcade:i,graphic:t});s.set(`expression/${o.name}`,n),n?.dependencies.forEach(a=>r.add(a))}return{dependencies:r,expressions:s}})}var yt=1,x=class extends M{constructor(e){super(e),this._compileTask=null,this._evaluateTask=null,this.expressionInfo=null,this.graphic=null,this.contentElementViewModel=null,this.interceptor=null,this.location=null,this.view=null,this._createVM=()=>{let t=this.contentElement?.type;this.contentElementViewModel?.destroy();let i=t==="fields"?new de:t==="media"?new U:t==="text"?new K:null;this._set("contentElementViewModel",i)},this._compileThrottled=H(this._startCompile,()=>this.notifyChange("state"),yt,this),this._evaluateThrottled=H(this._startEvaluate,()=>this.notifyChange("state"),yt,this),this.addHandles([E(()=>[this.expressionInfo,this.graphic],()=>this._compileThrottled(),S),E(()=>[this.contentElement],()=>this._createVM(),S),X(()=>{if(!this._compileTask?.finished)return null;let t=this._compileTask.value,i=t?.dependencies;return[t,this.spatialReference,this.map,this.view,i?.has("view-scale")?this.view?.scale:null,i?.has("view-time-extent")?this.view?.timeExtent?.start:null,i?.has("view-time-extent")?this.view?.timeExtent?.end:null]},([t])=>this._evaluateThrottled(t))])}initialize(){this.addHandles([this._compileThrottled,this._evaluateThrottled])}destroy(){this._compileTask=T(this._compileTask),this._evaluateTask=T(this._evaluateTask),this.contentElementViewModel?.destroy(),this._set("contentElementViewModel",null)}get contentElement(){return this._evaluateTask?.value}get spatialReference(){return this.view?.spatialReference??null}set spatialReference(e){this._override("spatialReference",e)}get state(){let{contentElement:e,contentElementViewModel:t}=this;return this._compileThrottled.hasPendingUpdates()||this._evaluateThrottled.hasPendingUpdates()||!this._compileTask?.finished||!this._evaluateTask?.finished?"loading":e||t?"ready":"disabled"}get map(){return this.view?.map??null}set map(e){this._override("map",e)}_startCompile(){this._evaluateTask=T(this._evaluateTask),this._compileTask=T(this._compileTask),this._compileTask=q(e=>_(this,null,function*(){let{expressionInfo:t,graphic:i}=this;if(!t||!i)return null;let r=yield we();$(e);let s=yield xe({expressionInfo:t,arcade:r,graphic:i});return $(e),s}))}_startEvaluate(e){this._evaluateTask=T(this._evaluateTask),this._evaluateTask=q(t=>_(this,null,function*(){let{graphic:i}=this;if(!e||!i)return null;let{interceptor:r,spatialReference:s,map:o,location:n,view:a}=this,d=yield e.evaluate({graphic:i,interceptor:r,location:n,map:o,options:{signal:t},spatialReference:s,view:a});$(t);let p=d;if(!p||p.declaredClass!=="esri.arcade.Dictionary")return null;let u=yield p.castAsJsonAsync(t);$(t);let f=u?.type,m=f==="media"?$e.fromJSON(u):f==="text"?re.fromJSON(u):f==="fields"?Oe.fromJSON(u):null;return m.type==="media"&&!m.mediaInfos||m.type==="fields"&&!m.fieldInfos||m.type==="text"&&!m.text?null:m}))}};l([c()],x.prototype,"_compileTask",void 0),l([c()],x.prototype,"_evaluateTask",void 0),l([c({type:Pe})],x.prototype,"expressionInfo",void 0),l([c({type:Z})],x.prototype,"graphic",void 0),l([c({readOnly:!0})],x.prototype,"contentElement",null),l([c({readOnly:!0})],x.prototype,"contentElementViewModel",void 0),l([c()],x.prototype,"interceptor",void 0),l([c({type:ee})],x.prototype,"location",void 0),l([c()],x.prototype,"spatialReference",null),l([c({readOnly:!0})],x.prototype,"state",null),l([c()],x.prototype,"map",null),l([c()],x.prototype,"view",void 0),x=l([F("esri.widgets.Feature.FeatureExpression.FeatureExpressionViewModel")],x);var gt=x;var Q,_t=1,bt="content-view-models",vt="relationship-view-models",Gt="association-view-models",It={attachmentsContent:!0,chartAnimation:!0,customContent:!0,expressionContent:!0,fieldsContent:!0,mediaContent:!0,textContent:!0,relationshipContent:!0,utilityNetworkAssociationsContent:!0},h=Q=class extends Ve.IdentifiableMixin(M){constructor(e){super(e),this._error=null,this._graphicChangedTask=null,this._evaluateExpressionAttributesTask=null,this._associationVMAbortController=null,this._expressionAttributes=null,this._graphicExpressionAttributes=null,this.abilities=y({},It),this.content=null,this.contentViewModels=[],this.description=null,this.defaultPopupTemplateEnabled=!1,this.formattedAttributes=null,this.lastEditInfo=null,this.location=null,this.relatedInfos=new Map,this.title="",this.view=null,this._graphicChangedThrottled=H(this._graphicChanged,()=>this.notifyChange("waitingForContent"),_t,this),this._isAllowedContentType=t=>{let{abilities:i}=this;return t.type==="attachments"&&!!i.attachmentsContent||t.type==="custom"&&!!i.customContent||t.type==="fields"&&!!i.fieldsContent||t.type==="media"&&!!i.mediaContent||t.type==="text"&&!!i.textContent||t.type==="expression"&&!!i.expressionContent||t.type==="relationship"&&!!i.relationshipContent||t.type==="utility-network-associations"&&!!i.utilityNetworkAssociationsContent},this._evaluateExpressionAttributesThrottled=H(this._evaluateExpressionAttributes,()=>this.notifyChange("waitingForContent"),_t,this),this.addHandles([E(()=>[this.graphic,this._effectivePopupTemplate,this.abilities,this.timeZone],()=>this._graphicChangedThrottled(),S),X(()=>{if(!this._graphicChangedTask?.finished||this._graphicChangedTask.value==null)return null;let t=this._graphicChangedTask.value,i=t?.expressionInfos?.dependencies;return[t,i?.has("view-scale")?this.view?.scale:null,i?.has("view-time-extent")?this.view?.timeExtent?.start:null,i?.has("view-time-extent")?this.view?.timeExtent?.end:null]},([t])=>this._evaluateExpressionAttributesThrottled(t))])}initialize(){this.addHandles([this._graphicChangedThrottled,this._evaluateExpressionAttributesThrottled])}destroy(){this._clear(),this._graphicChangedTask=T(this._graphicChangedTask),this._evaluateExpressionAttributesTask=T(this._evaluateExpressionAttributesTask),this._error=null,this.graphic=null,this._destroyContentViewModels(),this.relatedInfos.clear()}get _effectivePopupTemplate(){return this.graphic!=null?this.graphic.getEffectivePopupTemplate(this.defaultPopupTemplateEnabled):null}get _fieldInfoMap(){return Je(be(this._effectivePopupTemplate),this._sourceLayer)}get _sourceLayer(){return qe(this.graphic)}castAbilities(e){return y(y({},It),e)}get isTable(){return this._sourceLayer?.isTable||!1}get state(){return this.graphic?this._error?"error":this.waitingForContent?"loading":"ready":"disabled"}set graphic(e){this._set("graphic",e?.clone()??null)}get spatialReference(){return this.view?.spatialReference??null}set spatialReference(e){this._override("spatialReference",e)}get timeZone(){return this.view?.timeZone??Me}set timeZone(e){this._overrideIfSome("timeZone",e)}get map(){return this.view?.map||null}set map(e){this._override("map",e)}get waitingForContent(){let{_graphicChangedThrottled:e,_evaluateExpressionAttributesThrottled:t,_graphicChangedTask:i,_evaluateExpressionAttributesTask:r,_associationVMAbortController:s}=this;return e.hasPendingUpdates()||t.hasPendingUpdates()||i!=null&&!i.finished||r!=null&&!r.finished||!!s}setActiveMedia(e,t){let i=this.contentViewModels[e];i instanceof U&&i.setActiveMedia(t)}nextMedia(e){let t=this.contentViewModels[e];t instanceof U&&t.next()}previousMedia(e){let t=this.contentViewModels[e];t instanceof U&&t.previous()}updateGeometry(){return _(this,null,function*(){let{graphic:e,spatialReference:t,_sourceLayer:i}=this;yield i?.load();let r=i?.objectIdField;if(!r||!e||!i)return;let s=e?.attributes?.[r];if(s==null)return;let o=[s];if(!e.geometry){let n=yield Ge({layer:i,graphic:e,outFields:[],objectIds:o,returnGeometry:!0,spatialReference:t}),a=n?.geometry;a&&(e.geometry=a)}})}_clear(){this._set("title",""),this._set("content",null),this._set("formattedAttributes",null)}_graphicChanged(){this._evaluateExpressionAttributesTask=T(this._evaluateExpressionAttributesTask),this._graphicChangedTask=T(this._graphicChangedTask),this._graphicChangedTask=q(e=>_(this,null,function*(){this._error=null,this._clear();let{graphic:t}=this;try{if(!t)return null;let{_sourceLayer:i,_effectivePopupTemplate:r}=this,s=this.spatialReference;yield ze({graphic:t,popupTemplate:r,layer:i,spatialReference:s},{signal:e});let[{value:o},{value:n}]=yield L([this._getContent(),this._getTitle()]),[,{value:a}]=yield L([this._checkForRelatedFeatures({signal:e}),mt(r?.expressionInfos,t)]);return{expressionInfos:a,content:o,title:n}}catch(i){throw me(i)||(this._error=i,N.getLogger(this).error("error","The popupTemplate could not be displayed for this feature.",{error:i,graphic:t,popupTemplate:this._effectivePopupTemplate})),i}}))}_compileContentElement(e,t){return e.type==="attachments"?this._compileAttachments(e,t):e.type==="custom"?this._compileCustom(e,t):e.type==="fields"?this._compileFields(e,t):e.type==="media"?this._compileMedia(e,t):e.type==="text"?this._compileText(e,t):e.type==="expression"?this._compileExpression(e,t):e.type==="relationship"?this._compileRelationship(e,t):e.type==="utility-network-associations"?this._compileUtilityNetworkAssociation(e,t):void 0}_compileContent(e){if(this._destroyContentViewModels(),this.graphic)return Array.isArray(e)?e.filter(this._isAllowedContentType).map((t,i)=>this._compileContentElement(t,i)).filter(W):typeof e=="string"?this._compileText(new re({text:e}),0).text:e}_destroyContentViewModels(){this.removeHandles(vt),this.removeHandles(bt),this.contentViewModels.forEach(e=>e&&!e.destroyed&&e.destroy()),this._set("contentViewModels",[])}_matchesFeature(e,t){let i=e?.graphic?.getObjectId(),r=t?.getObjectId();return i!=null&&r!=null&&i===r}_setRelatedFeaturesViewModels({relatedFeatureViewModels:e,relatedFeatures:t,map:i}){let{view:r,spatialReference:s,timeZone:o}=this;t?.filter(Boolean).forEach(n=>{e.some(a=>this._matchesFeature(a,n))||e.add(new Q({abilities:{relationshipContent:!1},map:i,view:r,spatialReference:s,timeZone:o,graphic:n}))}),e.forEach(n=>{t?.find(d=>this._matchesFeature(n,d))||e.remove(n)})}_setExpressionContentVM(e,t){let i=this.formattedAttributes,{contentElement:r,contentElementViewModel:s}=e,o=r?.type;s&&o&&(o==="fields"&&(this._createFieldsFormattedAttributes({contentElement:r,contentElementIndex:t,formattedAttributes:i}),s.set(this._createFieldsVMParams(r,t))),o==="media"&&(this._createMediaFormattedAttributes({contentElement:r,contentElementIndex:t,formattedAttributes:i}),s.set(this._createMediaVMParams(r,t))),o==="text"&&s.set(this._createTextVMParams(r)))}_compileRelationship(e,t){let{displayCount:i,orderByFields:r,relationshipId:s,title:o,description:n}=e,{_sourceLayer:a,graphic:d,map:p}=this;if(!Be(a))return;let u=new it(y({displayCount:i,graphic:d,orderByFields:r,relationshipId:s,layer:a,map:p},this._compileTitleAndDesc({title:o,description:n})));return this.contentViewModels[t]=u,this.addHandles(Ee(()=>u.relatedFeatures,"change",()=>this._setRelatedFeaturesViewModels(u)),vt),e}_matchesGlobalFeature(e,t){let i=e?.association.globalId,r=t?.association.globalId;return i!=null&&r!=null&&i===r}_setUpUtilityNetworkAssociationsViewModels(e,t,i){return _(this,null,function*(){let{view:r,spatialReference:s,timeZone:o}=this;e.forEach((a,d)=>{let p=t.get(d);p?a.forEach(u=>{p.find(f=>this._matchesGlobalFeature(u,f))||(a.remove(u),a.length===0&&e.delete(d))}):(a.removeAll(),e.delete(d))}),t.forEach((a,d)=>{let p=e.get(d)||new Ce;a?.filter(Boolean).forEach(u=>{p.some(f=>this._matchesGlobalFeature(f,u))||p.add({association:u.association,featureViewModel:new Q({abilities:{utilityNetworkAssociationsContent:!1},map:i,view:r,spatialReference:s,timeZone:o,graphic:u.feature}),terminalName:u.terminalName})}),e.set(d,p)});let n=new AbortController;this._associationVMAbortController=n,yield this._sortListObjectsByTitle(e,{signal:n.signal}),this._associationVMAbortController===n&&(this._associationVMAbortController=null)})}_sortListObjectsByTitle(e,t){return _(this,null,function*(){for(let i of e.values()){let r=i.map(s=>ke(()=>s.featureViewModel.state==="ready",t?.signal));yield Promise.all(r),i.sort(this._compareByFeatureTitle)}})}_compareByFeatureTitle(e,t){let i=ve(e.featureViewModel),r=ve(t.featureViewModel);return i.localeCompare(r,void 0,{numeric:!0})}_compileUtilityNetworkAssociation(e,t){let{displayCount:i,title:r,description:s,associationTypes:o}=e,{_sourceLayer:n,graphic:a,map:d}=this;if(!He(n))return;let p=new rt(y({graphic:a,displayCount:i,associationTypes:o,layer:n,map:d},this._compileTitleAndDesc({title:r,description:s})));return this.contentViewModels[t]=p,this.addHandles([E(()=>p.associationFeatures.values(),()=>this._setUpUtilityNetworkAssociationsViewModels(p.associationViewModels,p.associationFeatures,p.map))],Gt),e}_compileExpression(e,t){let{expressionInfo:i}=e,{graphic:r,map:s,spatialReference:o,view:n,location:a}=this,d=new gt({expressionInfo:i,graphic:r,interceptor:Q.interceptor,map:s,spatialReference:o,view:n,location:a});return this.contentViewModels[t]=d,this.addHandles(E(()=>d.contentElementViewModel,()=>this._setExpressionContentVM(d,t),S),bt),e}_compileAttachments(e,t){let{graphic:i}=this,{description:r,title:s,orderByFields:o}=e;return this.contentViewModels[t]=new st(y({graphic:i,orderByFields:o},this._compileTitleAndDesc({title:s,description:r}))),e}_compileCustom(e,t){let{graphic:i}=this,{creator:r,destroyer:s}=e;return this.contentViewModels[t]=new K({graphic:i,creator:r,destroyer:s}),e}_compileTitleAndDesc({title:e,description:t}){let{_fieldInfoMap:i,_sourceLayer:r,graphic:s,formattedAttributes:o}=this,n=s?.attributes,a=this._expressionAttributes,d=o.global;return{title:k({attributes:n,fieldInfoMap:i,globalAttributes:d,expressionAttributes:a,layer:r,text:e}),description:k({attributes:n,fieldInfoMap:i,globalAttributes:d,expressionAttributes:a,layer:r,text:t})}}_createFieldsVMParams(e,t){let i=this._effectivePopupTemplate,r=this.formattedAttributes,s=y(y({},r?.global),r?.content[t]),o=e?.fieldInfos||i?.fieldInfos,n=o?.filter(({fieldName:u})=>!!u&&(se(u)||C(u)||s.hasOwnProperty(u))),a=i?.expressionInfos,{description:d,title:p}=e;return y({attributes:s,expressionInfos:a,fieldInfos:n},this._compileTitleAndDesc({title:p,description:d}))}_compileFields(e,t){let i=e.clone(),r=new de(this._createFieldsVMParams(e,t));return this.contentViewModels[t]=r,i.fieldInfos=r.formattedFieldInfos.slice(),i}_createMediaVMParams(e,t){let{abilities:i,graphic:r,_fieldInfoMap:s,_effectivePopupTemplate:o,relatedInfos:n,_sourceLayer:a,_expressionAttributes:d}=this,p=this.formattedAttributes,u=r?.attributes??{},{description:f,mediaInfos:m,title:g}=e;return y({abilities:{chartAnimation:i.chartAnimation},activeMediaInfoIndex:e.activeMediaInfoIndex||0,attributes:u,isAggregate:r?.isAggregate,layer:a,fieldInfoMap:s,formattedAttributes:y(y({},p?.global),p?.content[t]),expressionAttributes:d,mediaInfos:m,popupTemplate:o,relatedInfos:n},this._compileTitleAndDesc({title:g,description:f}))}_compileMedia(e,t){let i=e.clone(),r=new U(this._createMediaVMParams(e,t));return i.mediaInfos=r.formattedMediaInfos.slice(),this.contentViewModels[t]=r,i}_createTextVMParams(e){let{graphic:t,_fieldInfoMap:i,_sourceLayer:r,_expressionAttributes:s}=this;if(e&&e.text){let o=t?.attributes??{},n=this.formattedAttributes?.global??{};e.text=k({attributes:o,fieldInfoMap:i,globalAttributes:n,expressionAttributes:s,layer:r,text:e.text})}return{graphic:t,creator:e.text}}_compileText(e,t){let i=e.clone();return this.contentViewModels[t]=new K(this._createTextVMParams(i)),i}_compileLastEditInfo(){let{_effectivePopupTemplate:e,_sourceLayer:t,graphic:i,timeZone:r}=this;if(!e)return;let{lastEditInfoEnabled:s}=e,o=t?.editFieldsInfo;return s&&o?Qe(o,i?.attributes,r,t):void 0}_compileTitle(e){let{_fieldInfoMap:t,_sourceLayer:i,graphic:r,_expressionAttributes:s}=this,o=r?.attributes??{},n=this.formattedAttributes?.global??{};return k({attributes:o,fieldInfoMap:t,globalAttributes:n,expressionAttributes:s,layer:i,text:e})}_getTitle(){return _(this,null,function*(){let{_effectivePopupTemplate:e,graphic:t}=this;return t?B({type:"title",value:e?.title,event:{graphic:t}}):null})}_getContent(){return _(this,null,function*(){let{_effectivePopupTemplate:e,graphic:t}=this;return t?B({type:"content",value:e?.content,event:{graphic:t}}):null})}_evaluateExpressionAttributes({title:e,content:t,expressionInfos:i}){this._evaluateExpressionAttributesTask=T(this._evaluateExpressionAttributesTask),this._evaluateExpressionAttributesTask=q(r=>_(this,null,function*(){let{graphic:s,map:o,view:n,spatialReference:a,location:d}=this;try{if(!s)return;let p;if(i!=null){let u=[];for(let[f,m]of i.expressions.entries())m!=null?u.push(m.evaluate({graphic:s,interceptor:Q.interceptor,location:d,map:o,options:{signal:r},spatialReference:a,view:n}).then(g=>[f,ft(g)]).catch(()=>[f,void 0])):u.push(Promise.resolve([f,void 0]));p=Object.fromEntries(yield Promise.all(u)),$(r)}this._expressionAttributes=p,this._graphicExpressionAttributes=y(y({},s.attributes),p),this._set("formattedAttributes",this._createFormattedAttributes(t)),this._set("title",this._compileTitle(e)),this._set("lastEditInfo",this._compileLastEditInfo()||null),this._set("content",this._compileContent(t)||null)}catch(p){me(p)||(this._error=p,N.getLogger(this).error("error","The popupTemplate could not be displayed for this feature.",{error:p,graphic:s,popupTemplate:this._effectivePopupTemplate}))}}))}_createMediaFormattedAttributes({contentElement:e,contentElementIndex:t,formattedAttributes:i}){let{_effectivePopupTemplate:r,graphic:s,relatedInfos:o,_sourceLayer:n,_fieldInfoMap:a,_graphicExpressionAttributes:d,timeZone:p}=this;i.content[t]=le({fieldInfos:r?.fieldInfos,graphic:s,attributes:y(y({},d),e.attributes),layer:n,fieldInfoMap:a,relatedInfos:o,timeZone:p})}_createFieldsFormattedAttributes({contentElement:e,contentElementIndex:t,formattedAttributes:i}){if(e.fieldInfos){let{graphic:r,relatedInfos:s,_sourceLayer:o,_fieldInfoMap:n,_graphicExpressionAttributes:a,timeZone:d}=this;i.content[t]=le({fieldInfos:e.fieldInfos,graphic:r,attributes:y(y({},a),e.attributes),layer:o,fieldInfoMap:n,relatedInfos:s,timeZone:d})}}_createFormattedAttributes(e){let{_effectivePopupTemplate:t,graphic:i,relatedInfos:r,_sourceLayer:s,_fieldInfoMap:o,_graphicExpressionAttributes:n,timeZone:a}=this,d=t?.fieldInfos,p={global:le({fieldInfos:d,graphic:i,attributes:n,layer:s,fieldInfoMap:o,relatedInfos:r,timeZone:a}),content:[]};return Array.isArray(e)&&e.forEach((u,f)=>{u.type==="fields"&&this._createFieldsFormattedAttributes({contentElement:u,contentElementIndex:f,formattedAttributes:p}),u.type==="media"&&this._createMediaFormattedAttributes({contentElement:u,contentElementIndex:f,formattedAttributes:p})}),p}_checkForRelatedFeatures(e){let{graphic:t,_effectivePopupTemplate:i}=this;return this._queryRelatedInfos(t,be(i),e)}_queryRelatedInfos(e,t,i){return _(this,null,function*(){let{relatedInfos:r,_sourceLayer:s}=this;r.clear();let o=s?.associatedLayer!=null?yield s?.associatedLayer.load(i):s;if(!o||!e||!t.filter(p=>!!p.fieldName&&C(p.fieldName))?.length)return;t.forEach(p=>this._configureRelatedInfo(p,o));let a=yield pt({relatedInfos:r,layer:o},i);Object.keys(a).forEach(p=>{let u=r.get(p.toString()),f=a[p]?.value;u&&f&&(u.layerInfo=f.data)});let d=yield ct({graphic:e,relatedInfos:r,layer:o},i);Object.keys(d).forEach(p=>{lt(d[p]?.value,r.get(p.toString()))})})}_configureRelatedInfo(e,t){let{relatedInfos:i}=this,r=D(e.fieldName||"");if(!r)return;let{layerId:s,fieldName:o}=r;if(!s)return;let n=i.get(s.toString())||nt(s,t);n&&(dt({relatedInfo:n,fieldName:o,fieldInfo:e}),this.relatedInfos.set(s,n))}};h.interceptor=new ce(Ke,We),l([c()],h.prototype,"_error",void 0),l([c()],h.prototype,"_graphicChangedTask",void 0),l([c()],h.prototype,"_evaluateExpressionAttributesTask",void 0),l([c()],h.prototype,"_associationVMAbortController",void 0),l([c({readOnly:!0})],h.prototype,"_effectivePopupTemplate",null),l([c({readOnly:!0})],h.prototype,"_fieldInfoMap",null),l([c({readOnly:!0})],h.prototype,"_sourceLayer",null),l([c()],h.prototype,"abilities",void 0),l([Y("abilities")],h.prototype,"castAbilities",null),l([c({readOnly:!0})],h.prototype,"content",void 0),l([c({readOnly:!0})],h.prototype,"contentViewModels",void 0),l([c()],h.prototype,"description",void 0),l([c({type:Boolean})],h.prototype,"defaultPopupTemplateEnabled",void 0),l([c({readOnly:!0})],h.prototype,"isTable",null),l([c({readOnly:!0})],h.prototype,"state",null),l([c({readOnly:!0})],h.prototype,"formattedAttributes",void 0),l([c({type:Z,value:null})],h.prototype,"graphic",null),l([c({readOnly:!0})],h.prototype,"lastEditInfo",void 0),l([c({type:ee})],h.prototype,"location",void 0),l([c({readOnly:!0})],h.prototype,"relatedInfos",void 0),l([c({type:Re})],h.prototype,"spatialReference",null),l([c()],h.prototype,"timeZone",null),l([c({readOnly:!0})],h.prototype,"title",void 0),l([c()],h.prototype,"map",null),l([c({readOnly:!0})],h.prototype,"waitingForContent",null),l([c()],h.prototype,"view",void 0),h=Q=l([F("esri.widgets.Feature.FeatureViewModel")],h);var bs=h;export{st as a,K as b,de as c,U as d,gt as e,bs as f};
