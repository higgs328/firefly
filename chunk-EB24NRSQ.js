import{b as N,c as g}from"./chunk-2I3LIA7G.js";import{c as S}from"./chunk-CL7L227X.js";import{a as z}from"./chunk-LCFWGHLF.js";import{a as P,b as F}from"./chunk-F2BQ2GD6.js";import{a as I}from"./chunk-RWCIDBNQ.js";import{b}from"./chunk-EO2H4LIH.js";import{a as D}from"./chunk-ALWV3RJ2.js";import{k as U}from"./chunk-57VFBGF3.js";import{b as G}from"./chunk-KMMTNF7G.js";import{a as T}from"./chunk-ZTOZWLEE.js";import{a as _}from"./chunk-BOVYXYHK.js";import{p as R}from"./chunk-4PTIEWMT.js";import{g as O}from"./chunk-XRGPJ3QY.js";import{f as A}from"./chunk-VTHXE323.js";function le(e,t,n,r,o,a,s,i,l,f,c){let m=Q[c.mode],u,d,p=0;if(U(e,t,n,r,l.spatialReference,o,i))return m?.requiresAlignment(c)?(p=m.applyElevationAlignmentBuffer(r,o,a,s,i,l,f,c),u=a,d=s):(u=r,d=o),U(u,l.spatialReference,d,a,f.spatialReference,s,i)?p:void 0}function w(e,t,n,r,o){let a=(z(e)?e.z:N(e)?e.array[e.offset+2]:e[2])||0;switch(n.mode){case"on-the-ground":{let s=g(t,e,"ground")??0;return o.verticalDistanceToGround=0,o.sampledElevation=s,void(o.z=s)}case"relative-to-ground":{let s=g(t,e,"ground")??0,i=n.geometryZWithOffset(a,r);return o.verticalDistanceToGround=i,o.sampledElevation=s,void(o.z=i+s)}case"relative-to-scene":{let s=g(t,e,"scene")??0,i=n.geometryZWithOffset(a,r);return o.verticalDistanceToGround=i,o.sampledElevation=s,void(o.z=i+s)}case"absolute-height":{let s=n.geometryZWithOffset(a,r),i=g(t,e,"ground")??0;return o.verticalDistanceToGround=s-i,o.sampledElevation=i,void(o.z=s)}default:return void(o.z=0)}}function ue(e,t,n,r){return w(e,t,n,r,E),E.z}function fe(e,t,n){return t==="on-the-ground"&&n==="on-the-ground"?e.staysOnTheGround:t===n||t!=="on-the-ground"&&n!=="on-the-ground"?t==null||n==null?e.definedChanged:C.UPDATE:e.onTheGroundChanged}function ce(e){return e==="relative-to-ground"||e==="relative-to-scene"}function de(e){return e!=="absolute-height"}function me(e,t,n,r,o){w(t,n,o,r,E),k(e,E.verticalDistanceToGround);let a=E.sampledElevation,s=T(X,e.transformation);return v[0]=t.x,v[1]=t.y,v[2]=E.z,b(t.spatialReference,v,s,r.spatialReference)?e.transformation=s:console.warn("Could not locate symbol object properly, it might be misplaced"),a}function k(e,t){for(let n=0;n<e.geometries.length;++n){let r=e.geometries[n].getMutableAttribute(I.CENTEROFFSETANDDISTANCE);r&&r.data[3]!==t&&(r.data[3]=t,e.geometryVertexAttributeUpdated(e.geometries[n],I.CENTEROFFSETANDDISTANCE))}}function H(e,t,n,r,o,a){let s=0,i=a.spatialReference;t*=3,r*=3;for(let l=0;l<o;++l){let f=e[t],c=e[t+1],m=e[t+2],u=a.getElevation(f,c,m,i,"ground")??0;s+=u,n[r]=f,n[r+1]=c,n[r+2]=u,t+=3,r+=3}return s/o}function L(e,t,n,r,o,a,s,i){let l=0,f=i.calculateOffsetRenderUnits(s),c=i.featureExpressionInfoContext,m=a.spatialReference;t*=3,r*=3;for(let u=0;u<o;++u){let d=e[t],p=e[t+1],x=e[t+2],h=a.getElevation(d,p,x,m,"ground")??0;l+=h,n[r]=d,n[r+1]=p,n[r+2]=c==null?x+h+f:h+f,t+=3,r+=3}return l/o}function $(e,t,n,r,o,a,s,i){let l=0,f=i.calculateOffsetRenderUnits(s),c=i.featureExpressionInfoContext,m=a.spatialReference;t*=3,r*=3;for(let u=0;u<o;++u){let d=e[t],p=e[t+1],x=e[t+2],h=a.getElevation(d,p,x,m,"scene")??0;l+=h,n[r]=d,n[r+1]=p,n[r+2]=c==null?x+h+f:h+f,t+=3,r+=3}return l/o}function J(e){let t=e.meterUnitOffset,n=e.featureExpressionInfoContext;return t!==0||n!=null}function K(e,t,n,r,o,a,s,i){let l=i.calculateOffsetRenderUnits(s),f=i.featureExpressionInfoContext;t*=3,r*=3;for(let c=0;c<o;++c){let m=e[t],u=e[t+1],d=e[t+2];n[r]=m,n[r+1]=u,n[r+2]=f==null?d+l:l,t+=3,r+=3}return 0}var y=class{constructor(){this.verticalDistanceToGround=0,this.sampledElevation=0,this.z=0}},C;(function(e){e[e.NONE=0]="NONE",e[e.UPDATE=1]="UPDATE",e[e.RECREATE=2]="RECREATE"})(C||(C={}));var Q={"absolute-height":{applyElevationAlignmentBuffer:K,requiresAlignment:J},"on-the-ground":{applyElevationAlignmentBuffer:H,requiresAlignment:()=>!0},"relative-to-ground":{applyElevationAlignmentBuffer:L,requiresAlignment:()=>!0},"relative-to-scene":{applyElevationAlignmentBuffer:$,requiresAlignment:()=>!0}},X=D(),E=new y,v=_();var Y=()=>O.getLogger("esri.views.3d.layers.graphics.featureExpressionInfoUtils");function q(e){return{cachedResult:e.cachedResult,arcade:e.arcade?{func:e.arcade.func,context:e.arcade.modules.arcadeUtils.createExecContext(null,{sr:e.arcade.context.spatialReference}),modules:e.arcade.modules}:null}}function ve(e){let t=e?.expression;if(typeof t=="string"){let n=Z(t);if(n!=null)return{cachedResult:n}}return null}function Ue(e,t,n,r){return A(this,null,function*(){let o=e?.expression;if(typeof o!="string")return null;let a=Z(o);if(a!=null)return{cachedResult:a};let s=yield G();R(n);let i=s.arcadeUtils,l=i.createSyntaxTree(o);return i.dependsOnView(l)?(r?.error("Expressions containing '$view' are not supported on ElevationInfo"),{cachedResult:0}):{arcade:{func:i.createFunction(l),context:i.createExecContext(null,{sr:t}),modules:s}}})}function B(e,t,n){return e.arcadeUtils.createFeature(t.attributes,t.geometry,n)}function M(e,t){if(e!=null&&!W(e)){if(!t||!e.arcade)return void Y().errorOncePerTick("Arcade support required but not provided");let n=t;n._geometry&&(n._geometry=S(n._geometry)),e.arcade.modules.arcadeUtils.updateExecContext(e.arcade.context,t)}}function V(e){if(e!=null){if(W(e))return e.cachedResult;let t=e.arcade,n=t?.modules.arcadeUtils.executeFunction(t.func,t.context);return typeof n!="number"&&(e.cachedResult=0,n=0),n}return 0}function Ie(e,t=!1){let n=e?.featureExpressionInfo,r=n?.expression;return t||r==="0"||(n=null),n??null}var ye={cachedResult:0};function W(e){return e.cachedResult!=null}function Z(e){return e==="0"?0:null}var j=class e{constructor(){this._meterUnitOffset=0,this._renderUnitOffset=0,this._unit="meters",this._metersPerElevationInfoUnit=1,this._featureExpressionInfoContext=null,this.centerPointInElevationSR=null,this.mode=null}get featureExpressionInfoContext(){return this._featureExpressionInfoContext}get meterUnitOffset(){return this._meterUnitOffset}get unit(){return this._unit}set unit(t){this._unit=t,this._metersPerElevationInfoUnit=F(t)}get requiresSampledElevationInfo(){return this.mode!=="absolute-height"}reset(){this.mode=null,this._meterUnitOffset=0,this._renderUnitOffset=0,this._featureExpressionInfoContext=null,this.unit="meters"}set offsetMeters(t){this._meterUnitOffset=t,this._renderUnitOffset=0}set offsetElevationInfoUnits(t){this._meterUnitOffset=t*this._metersPerElevationInfoUnit,this._renderUnitOffset=0}addOffsetRenderUnits(t){this._renderUnitOffset+=t}geometryZWithOffset(t,n){let r=this.calculateOffsetRenderUnits(n);return this.featureExpressionInfoContext!=null?r:t+r}calculateOffsetRenderUnits(t){let n=this._meterUnitOffset,r=this.featureExpressionInfoContext;return r!=null&&(n+=V(r)*this._metersPerElevationInfoUnit),n/t.unitInMeters+this._renderUnitOffset}setFromElevationInfo(t){this.mode=t.mode,this.unit=P(t.unit)?t.unit:"meters",this.offsetElevationInfoUnits=t.offset??0}updateFeatureExpressionInfoContext(t,n,r){if(t==null)return void(this._featureExpressionInfoContext=null);let o=t?.arcade;o&&n!=null&&r!=null?(this._featureExpressionInfoContext=q(t),M(this._featureExpressionInfoContext,B(o.modules,n,r))):this._featureExpressionInfoContext=t}static fromElevationInfo(t){let n=new e;return t!=null&&n.setFromElevationInfo(t),n}};export{le as a,w as b,ue as c,fe as d,ce as e,de as f,me as g,k as h,y as i,C as j,ve as k,Ue as l,B as m,M as n,Ie as o,ye as p,j as q};
