import{z as W}from"./chunk-PKVI3POI.js";import{C as S,f as $,m as N}from"./chunk-Y4PJQPM4.js";import{a as j}from"./chunk-2DFFQEIV.js";import{a as H}from"./chunk-LAX5536Z.js";import{a as B}from"./chunk-3JGYBNJA.js";import{a as E}from"./chunk-K75TK42V.js";import{a as m,j as D}from"./chunk-TG45K3WR.js";import{b as R}from"./chunk-ACP3S2CH.js";import{a as o}from"./chunk-QGVBCWUY.js";import{H as x}from"./chunk-MYO4NP2N.js";import{e as l}from"./chunk-NFIPKH6V.js";import{l as K}from"./chunk-5QEXLALV.js";import{K as f,z as _}from"./chunk-4PTIEWMT.js";import{y as O}from"./chunk-QBWJMFH5.js";import{f as y}from"./chunk-VTHXE323.js";var Q=100,r=class extends B.ClonableMixin(E.IdentifiableMixin(x)){constructor(e){super(e),this._loaded=!1,this._queryAbortController=null,this._queryPageAbortController=null,this._queryFeatureCountAbortController=null,this.featuresPerPage=10,this.activeCategory=null,this.allCategories=null,this.description=null,this.graphic=null,this.layer=null,this.map=null,this.orderByFields=null,this.featureCount=0,this.relationshipId=null,this.showAllEnabled=!1,this.title=null,this._cancelQuery=()=>{let{_queryAbortController:t}=this;t&&t.abort(),this._queryAbortController=null},this._cancelQueryFeatureCount=()=>{let{_queryFeatureCountAbortController:t}=this;t&&t.abort(),this._queryFeatureCountAbortController=null},this._cancelQueryPage=()=>{let{_queryPageAbortController:t}=this;t&&t.abort(),this._queryPageAbortController=null},this._queryController=()=>y(this,null,function*(){this._cancelQuery();let t=new AbortController;this._queryAbortController=t,yield _(this._query()),this._queryAbortController===t&&(this._queryAbortController=null)}),this._queryFeatureCountController=()=>y(this,null,function*(){this._loaded=!1,this._cancelQueryFeatureCount();let t=new AbortController;this._queryFeatureCountAbortController=t,yield _(this._queryFeatureCount()),this._queryFeatureCountAbortController===t&&(this._queryFeatureCountAbortController=null),this._loaded=!0}),this._queryPageController=()=>y(this,null,function*(){let t=new AbortController;this._queryPageAbortController=t,yield _(this._queryPage()),this._queryPageAbortController===t&&(this._queryPageAbortController=null)}),this._queryDebounced=f(this._queryController,Q),this._queryFeatureCountDebounced=f(this._queryFeatureCountController,Q),this._queryPageDebounced=f(this._queryPageController,Q),this._query=()=>y(this,null,function*(){let{_queryAbortController:t,relatedFeatures:a}=this;this.featureCount&&(this.relatedLayer?.type!=="subtype-group"||this.activeCategory)&&(this._destroyRelatedFeatureViewModels(),this.featurePage=1,a.destroyAll(),this.destroyed||a.addMany(this._sliceFeatures(yield this._queryRelatedFeatures({signal:t?.signal}))))}),this.addHandles([m(()=>[this.displayCount,this.graphic,this.layer,this.layer?.loaded,this.map,this.orderByFields,this.relationshipId,this.featuresPerPage,this.showAllEnabled,this.canQuery,this.featureCount,this.activeCategory],()=>this._queryDebounced(),D),m(()=>[this.featurePage,this.showAllEnabled],()=>this._queryPageDebounced()),m(()=>[this.layer,this.relationshipId,this.objectId,this.canQuery,this.activeCategory],()=>this._queryFeatureCountDebounced())])}destroy(){this._destroyRelatedFeatureViewModels(),this.relatedFeatures.destroyAll(),this._cancelQuery(),this._cancelQueryFeatureCount(),this._cancelQueryPage()}set featurePage(e){let{featuresPerPage:t,featureCount:a}=this,i=1,s=Math.ceil(a/t)||1;this._set("featurePage",Math.min(Math.max(e,i),s))}get featurePage(){return this._get("featurePage")}get orderByFieldsFixedCasing(){let{orderByFields:e,relatedLayer:t}=this;return e&&t?.loaded?e.map(a=>{let i=a.clone();return i.field=$(a.field,t),i}):e??[]}get supportsCacheHint(){return!!this.layer?.capabilities?.queryRelated?.supportsCacheHint}get canLoad(){return!!this.map&&this.relationshipId!=null&&typeof this.objectId=="number"}get canQuery(){let e=this.layer?.capabilities?.queryRelated;return!!(this.relatedLayer&&this.relationship&&this.relationshipId!=null&&this.objectId!=null&&e?.supportsCount&&e?.supportsPagination)}get allCategoriesCount(){return this.allCategories?.length??0}get categories(){let{allCategories:e}=this;return this.showAllEnabled?e:e?.slice(0,this.displayCount)??null}set displayCount(e){this._set("displayCount",Math.min(Math.max(e??3,0),10))}get displayCount(){return this._get("displayCount")}get itemDescriptionFieldName(){return this.orderByFieldsFixedCasing[0]?.field||null}get objectId(){return(this.objectIdField&&this.graphic?.attributes?.[this.objectIdField])??null}get objectIdField(){return this.layer?.objectIdField||null}get relatedFeatures(){return this._get("relatedFeatures")||new R}get relatedLayer(){let{layer:e,map:t,relationship:a}=this;if(!e?.loaded||!t||!a)return null;let i=e.type==="subtype-sublayer"&&e.parent&&N(e.parent)?e.parent:e;return S(t,i,a)??null}get relatedLayerKeyField(){let{relatedLayer:e,relationshipId:t}=this;return e?.loaded&&t!=null?e.relationships?.find(a=>a.id===t)?.keyField:null}get relatedLayerKeyFields(){let{relatedLayer:e}=this;return e?.loaded?e.relationships?.map(t=>t.keyField).filter(O)??[]:[]}get relationship(){let{relationshipId:e,layer:t}=this;return e!=null&&t?.loaded?t.relationships?.find(({id:a})=>a===e)??null:null}get relationshipKey(){let{relationshipKeyField:e}=this;return(e&&this.graphic?.attributes?.[e])??null}get relationshipKeyField(){return this.relationship?.keyField||null}get relatedFeatureViewModels(){return this._get("relatedFeatureViewModels")||new R}get state(){let{_queryAbortController:e,_queryFeatureCountAbortController:t,_queryPageAbortController:a,canQuery:i,_loaded:s,canLoad:n}=this;return t||n&&!s?"loading":e||a?"querying":i?"ready":"disabled"}getRelatedFeatureByObjectId(e){return this.relatedFeatures.find(t=>t.getObjectId()===e)}refresh(){this._queryFeatureCountDebounced()}_destroyRelatedFeatureViewModels(){this.relatedFeatureViewModels?.destroyAll()}_queryFeatureCount(){return y(this,null,function*(){let{layer:e,relatedLayer:t}=this;yield e?.load(),yield t?.load();let{_queryFeatureCountAbortController:a,activeCategory:i,canQuery:s,objectId:n,relatedLayerKeyField:h,relationshipId:u,relationshipKey:C,supportsCacheHint:q}=this;if(!s||!e||!t||n==null)return this._set("featureCount",0),void this._set("allCategories",null);if(t?.type==="subtype-group"&&!i){if(this._set("featureCount",0),this._destroyRelatedFeatureViewModels(),this.featurePage=1,this.relatedFeatures.destroyAll(),h&&C!=null){let{default:P}=yield import("./chunk-BTK3FT4H.js"),{uniqueValueInfos:v}=yield P({layer:t,sqlWhere:`${h} = '${C}'`,field:t.subtypeField,signal:a?.signal}),I=v.map(({count:c,value:g})=>{let F=t.subtypes?.find(L=>L.code===g)?.name;return g!=null&&F?{count:c,value:g,name:F}:void 0}).filter(O);this._set("allCategories",I)}return}let{historicMoment:b,gdbVersion:A}=e,w=new j({cacheHint:q,gdbVersion:A,historicMoment:b,relationshipId:u,returnGeometry:!1,objectIds:[n],where:this._getRelationshipWhereClause(t)}),p=yield e.queryRelatedFeaturesCount(w,{signal:a?.signal});this._set("allCategories",null),this._set("featureCount",p[n]||0)})}_getRelationshipWhereClause(e){let{activeCategory:t}=this,a=e.createQuery(),i="subtypeField"in e?e.subtypeField:void 0,s=t&&i?`${i} = ${t.value}`:void 0,n=a.where;return n&&s?`(${n}) AND (${s})`:n??s}_sliceFeatures(e){let{showAllEnabled:t,displayCount:a}=this;return t?e:a?e.slice(0,a):[]}_queryPage(){return y(this,null,function*(){let{relatedFeatures:e,featurePage:t,showAllEnabled:a,_queryPageAbortController:i,featureCount:s}=this;!a||t<2||!s||this.relatedLayer?.type==="subtype-group"&&!this.activeCategory||e.addMany(yield this._queryRelatedFeatures({signal:i?.signal}))})}_queryRelatedFeatures(e){return y(this,null,function*(){let{displayCount:t,featureCount:a,featurePage:i,featuresPerPage:s,layer:n,orderByFieldsFixedCasing:h,relatedLayer:u,relatedLayerKeyFields:C,relationshipId:q,showAllEnabled:b,supportsCacheHint:A}=this,{canQuery:w,objectId:p}=this;if(!w||!n||!u||p==null)return[];let P=b?((i-1)*s+a)%a:0,v=b?s:t,I=u.objectIdField,c="subtypeField"in u?u.subtypeField:void 0,g=[...h.map(d=>d.field),...W(u),...C,I,c].filter(J),F=h.map(d=>`${d.field} ${d.order}`),{historicMoment:L,gdbVersion:k}=n,G=new j({orderByFields:F,start:P,num:v,outFields:g,cacheHint:A,historicMoment:L,gdbVersion:k,relationshipId:q,returnGeometry:!1,objectIds:[p],where:this._getRelationshipWhereClause(u)}),T=yield n.queryRelatedFeatures(G,{signal:e?.signal}),M=T[p]?.features||[];return u.type==="subtype-group"&&c?M.forEach(d=>{let z=d.attributes[c],V=u.findSublayerForSubtypeCode?.(z);d.sourceLayer=V,d.layer=V}):M.forEach(d=>{d.sourceLayer=u,d.layer=u}),M})}};function J(e){return e!=null&&e!==""}o([l()],r.prototype,"_loaded",void 0),o([l()],r.prototype,"_queryAbortController",void 0),o([l()],r.prototype,"_queryPageAbortController",void 0),o([l()],r.prototype,"_queryFeatureCountAbortController",void 0),o([l({value:1})],r.prototype,"featurePage",null),o([l()],r.prototype,"featuresPerPage",void 0),o([l({readOnly:!0})],r.prototype,"orderByFieldsFixedCasing",null),o([l({readOnly:!0})],r.prototype,"supportsCacheHint",null),o([l({readOnly:!0})],r.prototype,"canLoad",null),o([l({readOnly:!0})],r.prototype,"canQuery",null),o([l()],r.prototype,"activeCategory",void 0),o([l({readOnly:!0})],r.prototype,"allCategories",void 0),o([l({readOnly:!0})],r.prototype,"allCategoriesCount",null),o([l({readOnly:!0})],r.prototype,"categories",null),o([l()],r.prototype,"description",void 0),o([l({value:3})],r.prototype,"displayCount",null),o([l({type:H})],r.prototype,"graphic",void 0),o([l({readOnly:!0})],r.prototype,"itemDescriptionFieldName",null),o([l()],r.prototype,"layer",void 0),o([l()],r.prototype,"map",void 0),o([l({readOnly:!0})],r.prototype,"objectId",null),o([l({readOnly:!0})],r.prototype,"objectIdField",null),o([l()],r.prototype,"orderByFields",void 0),o([l({readOnly:!0})],r.prototype,"relatedFeatures",null),o([l({readOnly:!0})],r.prototype,"relatedLayer",null),o([l({readOnly:!0})],r.prototype,"relatedLayerKeyField",null),o([l({readOnly:!0})],r.prototype,"relatedLayerKeyFields",null),o([l({readOnly:!0})],r.prototype,"relationship",null),o([l({readOnly:!0})],r.prototype,"relationshipKey",null),o([l({readOnly:!0})],r.prototype,"relationshipKeyField",null),o([l({readOnly:!0})],r.prototype,"featureCount",void 0),o([l({readOnly:!0})],r.prototype,"relatedFeatureViewModels",null),o([l()],r.prototype,"relationshipId",void 0),o([l()],r.prototype,"showAllEnabled",void 0),o([l()],r.prototype,"state",null),o([l()],r.prototype,"title",void 0),r=o([K("esri.widgets.Feature.FeatureRelationship.FeatureRelationshipViewModel")],r);var he=r;export{he as a};
