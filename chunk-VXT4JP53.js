import{a as Le,b as Pe}from"./chunk-BGL5237J.js";import{b as N}from"./chunk-HH3C3QEN.js";import{c as Ie}from"./chunk-2XTO2IAR.js";import{b as Ce}from"./chunk-VDNRZCIE.js";import{a as Fe,c as Oe,d as Ve,e as Ee}from"./chunk-JBAMJB5J.js";import{b as J}from"./chunk-EDOVNTC7.js";import{c as Re,d as we}from"./chunk-37H4LYIE.js";import{b as B}from"./chunk-YQNUGDFH.js";import{b as Me,d as Ae}from"./chunk-Q6EKUW7R.js";import{a as Se}from"./chunk-DNO4WN4I.js";import{b as P}from"./chunk-3GP4YRLZ.js";import{a as Z,b as ve,g as w}from"./chunk-ONYJLWAD.js";import{b as Be}from"./chunk-B2QMHWYJ.js";import{F as ae,l as k}from"./chunk-GJ2QRXGN.js";import{a as F}from"./chunk-6QXEFK4U.js";import{a as R}from"./chunk-RWCIDBNQ.js";import{g as pe}from"./chunk-EM35R6FY.js";import{b as ye,e as Q}from"./chunk-3YLFGUFH.js";import{b as ge,d as be,f as z,i as K}from"./chunk-XIZXEWWA.js";import{a as xe,h as $,q as he}from"./chunk-DJW5LMRG.js";import{a as I,c as L}from"./chunk-DEH76MSI.js";import{a as Te}from"./chunk-ALWV3RJ2.js";import{c as W,d as H,o as ce,p as me,s as fe,t as de}from"./chunk-2ZFXOJDB.js";import{a as ie,e as ne,g as U,u as ue,x as le,y as q}from"./chunk-6B5XFA6F.js";import{f as se}from"./chunk-ZTOZWLEE.js";import{f as _}from"./chunk-RJWOVI3M.js";import{a as C}from"./chunk-BOVYXYHK.js";import{v as G}from"./chunk-EQZWYK27.js";import{a as A,b as E,f as oe}from"./chunk-VTHXE323.js";function M(r){if(r==null)return null;let t=r.offset!=null?r.offset:Re,s=r.rotation!=null?r.rotation:0,o=r.scale!=null?r.scale:we,c=L(1,0,0,0,1,0,t[0],t[1],1),m=L(Math.cos(s),-Math.sin(s),0,Math.sin(s),Math.cos(s),0,0,0,1),n=L(o[0],0,0,0,o[1],0,0,0,1),l=I();return $(l,m,n),$(l,c,l),l}var X=class{constructor(){this.geometries=new Array,this.materials=new Array,this.textures=new Array}},D=class{constructor(t,s,o){this.name=t,this.lodThreshold=s,this.pivotOffset=o,this.stageResources=new X,this.numberOfVertices=0}};function Ar(r,t){return oe(this,null,function*(){let s=_e(Be(r));if(s.fileType==="wosr"){let u=yield t.cache?t.cache.loadWOSR(s.url,t):Le(s.url,t),{engineResources:p,referenceBoundingBox:h}=Pe(u,t);return{lods:p,referenceBoundingBox:h,isEsriSymbolResource:!1,isWosr:!0}}let o;if(t.cache)o=yield t.cache.loadGLTF(s.url,t,!!t.usePBR);else{let{loadGLTF:u}=yield import("./chunk-WARLT76F.js");o=yield u(new Se(t.streamDataRequester),s.url,t,t.usePBR)}let c=o.model.meta?.ESRI_proxyEllipsoid,m=o.meta.isEsriSymbolResource&&c!=null&&o.meta.ESRI_webstyle==="EsriRealisticTreesStyle";m&&!o.customMeta.esriTreeRendering&&(o.customMeta.esriTreeRendering=!0,He(o,c));let n=!!t.usePBR,l=o.meta.isEsriSymbolResource?{usePBR:n,isSchematic:!1,treeRendering:m,mrrFactors:Ee}:{usePBR:n,isSchematic:!1,treeRendering:!1,mrrFactors:Oe},e=E(A({},t.materialParameters),{treeRendering:m}),{engineResources:a,referenceBoundingBox:i}=ke(o,l,e,t,s.specifiedLodIndex);return{lods:a,referenceBoundingBox:i,isEsriSymbolResource:o.meta.isEsriSymbolResource,isWosr:!1}})}function _e(r){let t=r.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return t?{fileType:"gltf",url:t[1],specifiedLodIndex:t[4]!=null?Number(t[4]):null}:r.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:r,specifiedLodIndex:null}:{fileType:"unknown",url:r,specifiedLodIndex:null}}function ke(r,t,s,o,c){let m=r.model,n=new Array,l=new Map,e=new Map,a=m.lods.length,i=ae();return m.lods.forEach((u,p)=>{let h=o.skipHighLods===!0&&(a>1&&p===0||a>3&&p===1)||o.skipHighLods===!1&&c!=null&&p!==c;if(h&&p!==0)return;let f=new D(u.name,u.lodThreshold,[0,0,0]);u.parts.forEach(g=>{let T=h?new N({},o):Ue(m,g,f,t,s,l,e,o),{geometry:b,vertexCount:d}=qe(g,T??new N({},o)),x=b.boundingInfo;x!=null&&p===0&&(k(i,x.bbMin),k(i,x.bbMax)),T!=null&&(f.stageResources.geometries.push(b),f.numberOfVertices+=d)}),h||n.push(f)}),{engineResources:n,referenceBoundingBox:i}}function Ue(r,t,s,o,c,m,n,l){let e=r.materials.get(t.material);if(e==null)return null;let{normal:a,color:i,texCoord0:u,tangent:p}=t.attributes,h=t.material+(a?"_normal":"")+(i?"_color":"")+(u?"_texCoord0":"")+(p?"_tangent":""),f=t.attributes.texCoord0!=null,g=t.attributes.normal!=null,T=We(e.alphaMode);if(!m.has(h)){if(f){let v=(V,Ge=!1)=>{if(V!=null&&!n.has(V)){let j=r.textures.get(V);if(j){let y=j.data;n.set(V,new Ce(P(y)?y.data:y,E(A({},j.parameters),{preMultiplyAlpha:!P(y)&&Ge,encoding:P(y)?y.encoding:void 0})))}}};v(e.colorTexture,T!==w.Opaque),v(e.normalTexture),v(e.occlusionTexture),v(e.emissiveTexture),v(e.metallicRoughnessTexture)}let d=1/_,x=e.color[0]**d,Y=e.color[1]**d,ee=e.color[2]**d,Ne=e.emissiveFactor[0]**d,De=e.emissiveFactor[1]**d,je=e.emissiveFactor[2]**d,O=e.colorTexture!=null&&f?n.get(e.colorTexture):null,re=Fe(e),te=e.normalTextureTransform?.scale!=null?e.normalTextureTransform?.scale:pe;m.set(h,new N(A(E(A({},o),{transparent:T===w.Blend,customDepthTest:ve.Lequal,textureAlphaMode:T,textureAlphaCutoff:e.alphaCutoff,diffuse:[x,Y,ee],ambient:[x,Y,ee],opacity:e.opacity,doubleSided:e.doubleSided,doubleSidedType:"winding-order",cullFace:e.doubleSided?Z.None:Z.Back,hasVertexColors:!!t.attributes.color,hasVertexTangents:!!t.attributes.tangent,normalType:g?J.Attribute:J.ScreenDerivative,castShadows:!0,receiveShadows:e.receiveShadows,receiveAmbientOcclusion:e.receiveAmbientOcclustion,textureId:O?.id,colorMixMode:e.colorMixMode,normalTextureId:e.normalTexture!=null&&f?n.get(e.normalTexture).id:void 0,textureAlphaPremultiplied:O!=null&&!!O.parameters.preMultiplyAlpha,occlusionTextureId:e.occlusionTexture!=null&&f?n.get(e.occlusionTexture).id:void 0,emissiveTextureId:e.emissiveTexture!=null&&f?n.get(e.emissiveTexture).id:void 0,metallicRoughnessTextureId:e.metallicRoughnessTexture!=null&&f?n.get(e.metallicRoughnessTexture).id:void 0,emissiveFactor:[Ne,De,je],mrrFactors:re?Ve:[e.metallicFactor,e.roughnessFactor,o.mrrFactors[2]],isSchematic:re,colorTextureTransformMatrix:M(e.colorTextureTransform),normalTextureTransformMatrix:M(e.normalTextureTransform),scale:[te[0],te[1]],occlusionTextureTransformMatrix:M(e.occlusionTextureTransform),emissiveTextureTransformMatrix:M(e.emissiveTextureTransform),metallicRoughnessTextureTransformMatrix:M(e.metallicRoughnessTextureTransform)}),c),l))}let b=m.get(h);if(s.stageResources.materials.push(b),f){let d=x=>{x!=null&&s.stageResources.textures.push(n.get(x))};d(e.colorTexture),d(e.normalTexture),d(e.occlusionTexture),d(e.emissiveTexture),d(e.metallicRoughnessTexture)}return b}function qe(r,t){let s=r.attributes.position.count,o=Ae(r.indices||s,r.primitiveType),c=F(3*s),{typedBuffer:m,typedBufferStride:n}=r.attributes.position;ge(c,m,r.transform,3,n);let l=[[R.POSITION,new B(c,o,3,!0)]];if(r.attributes.normal!=null){let a=F(3*s),{typedBuffer:i,typedBufferStride:u}=r.attributes.normal;he(S,r.transform),be(a,i,S,3,u),G(S)&&K(a,a),l.push([R.NORMAL,new B(a,o,3,!0)])}if(r.attributes.tangent!=null){let a=F(4*s),{typedBuffer:i,typedBufferStride:u}=r.attributes.tangent;xe(S,r.transform),ye(a,i,S,4,u),G(S)&&K(a,a,4),l.push([R.TANGENT,new B(a,o,4,!0)])}if(r.attributes.texCoord0!=null){let a=F(2*s),{typedBuffer:i,typedBufferStride:u}=r.attributes.texCoord0;Me(a,i,2,u),l.push([R.UV0,new B(a,o,2,!0)])}let e=r.attributes.color;if(e!=null){let a=new Uint8Array(4*s);e.elementCount===4?e instanceof H?Q(a,e,1,255):(e instanceof me||e instanceof de)&&Q(a,e,1/255,255):(a.fill(255),e instanceof W?z(a,e.typedBuffer,1,255,4,e.typedBufferStride):(r.attributes.color instanceof ce||r.attributes.color instanceof fe)&&z(a,e.typedBuffer,1/255,255,4,r.attributes.color.typedBufferStride)),l.push([R.COLOR,new B(a,o,4,!0)])}return{geometry:new Ie(t,l),vertexCount:s}}var S=I();function We(r){switch(r){case"BLEND":return w.Blend;case"MASK":return w.Mask;case"OPAQUE":case null:case void 0:return w.Opaque}}function He(r,t){for(let s=0;s<r.model.lods.length;++s){let o=r.model.lods[s];for(let c of o.parts){let m=c.attributes.normal;if(m==null)return;let n=c.attributes.position,l=n.count,e=C(),a=C(),i=C(),u=new Float32Array(4*l),p=new Float32Array(3*l),h=se(Te(),c.transform),f=0,g=0;for(let T=0;T<l;T++){n.getVec(T,a),m.getVec(T,e),q(a,a,c.transform),ne(i,a,t.center),U(i,i,t.radius);let b=i[2],d=ie(i),x=Math.min(.45+.55*d*d,1)**_;U(i,i,t.radius),h!==null&&q(i,i,h),ue(i,i),s+1!==r.model.lods.length&&r.model.lods.length>1&&le(i,i,e,b>-1?.2:Math.min(-4*b-3.8,1)),p[f]=i[0],p[f+1]=i[1],p[f+2]=i[2],f+=3,u[g]=x,u[g+1]=x,u[g+2]=x,u[g+3]=1,g+=4}c.attributes.normal=new W(p),c.attributes.color=new H(u)}}}export{M as a,Ar as b,_e as c};
