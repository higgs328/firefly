import{a as V}from"./chunk-VCLDFV7F.js";import{a as O}from"./chunk-DOB47SIN.js";import{a as G}from"./chunk-CESHMSBL.js";import{a as v,b as f,c as x,l as w}from"./chunk-2BJHWKO6.js";import{a as g}from"./chunk-7XYYDAZO.js";import{a as y}from"./chunk-NIYDRLW4.js";import{a as p}from"./chunk-QCZ3ZIGQ.js";import{f as a}from"./chunk-OLOKUDVI.js";import{a as u}from"./chunk-T7DXJKX7.js";import{a as n}from"./chunk-QGVBCWUY.js";import{e as o}from"./chunk-NFIPKH6V.js";import{l as _}from"./chunk-5QEXLALV.js";import{b as c,z as m}from"./chunk-4PTIEWMT.js";import{b as l}from"./chunk-2LI2GKBQ.js";import{a as h}from"./chunk-VTHXE323.js";var d,i=d=class extends u.EventedAccessor{constructor(e){super(e),this._hasZ=null,this._cursorScreenPoint=null,this._activePointerId=null,this._stagedVertexUnsnapped=null,this._lastVertexUnsnapped=null,this.interactiveUndoDisabled=!1,this.history=[],this.redoHistory=[],this.snapToScene=!1,this.view=null,this.elevationInfo=null,this.defaultZ=0,this._coordinateHelper=v(!!e.hasZ,!1,e.view.spatialReference),this._snappingManager=e.snappingManager,this._editGeometryOperations=new w(new x(e.editGeometryType??"polygon",this._coordinateHelper),p.Local),this._snappingGraphicsLayer=new g({id:d.SNAPPING_GRAPHICS_LAYER_ID,listMode:"hide",internal:!0}),this._snappingContext=new G({editGeometryOperations:this._editGeometryOperations,elevationInfo:{mode:"on-the-ground",offset:0},pointer:"mouse",visualizer:new V(this._snappingGraphicsLayer)}),this._activeComponent=new f(e.view.spatialReference,p.Local),this._editGeometryOperations.data.components.push(this._activeComponent)}normalizeCtorArgs(e){let t=h({},e);return delete t.editGeometryType,delete t.snappingManager,t}initialize(){this._snappingOperation=new O({view:this.view}),this.view.type==="2d"&&this.view.map.layers.add(this._snappingGraphicsLayer)}destroy(){this.view.map.layers.remove(this._snappingGraphicsLayer),this._snappingGraphicsLayer.destroy(),this._snappingManager!=null&&this._snappingManager.doneSnapping(),this._snappingOperation=c(this._snappingOperation),this._editGeometryOperations.destroy()}get _committedVertices(){return this._editGeometryOperations.data.components[0].vertices.map(e=>e.pos)}get vertices(){return this._stagedVertex!=null?[...this._committedVertices,this._coordinateHelper.pointToArray(this._stagedVertex)]:this._committedVertices}get hasZ(){return this._hasZ!=null?this._hasZ:this.view.type==="3d"}set hasZ(e){this._hasZ=e,this.notifyChange("hasZ")}get _stagedVertex(){return this._snappingOperation?.stagedPoint}set _stagedVertex(e){this._snappingOperation&&(this._snappingOperation.stagedPoint=l(e))}canUndo(){return this._editGeometryOperations.canUndo}canRedo(){return this._editGeometryOperations.canRedo}undo(){this.canUndo&&this._editGeometryOperations.undo()}redo(){this.canRedo&&this._editGeometryOperations.redo()}getCoordsFromScreenPoint(e){let t=e&&this.screenToMap(e);return t==null?null:t.hasZ?[t.x,t.y,t.z]:[t.x,t.y]}getCoordsAndPointFromScreenPoint(e){let t=this.screenToMap(e);return t==null?null:t.hasZ?{vertex:[t.x,t.y,t.z],mapPoint:t}:{vertex:[t.x,t.y],mapPoint:t}}screenToMap(e){let t=null;if(this.view.type==="3d")if(this.hasZ){let r=this.elevationInfo??P;t=this.view.sceneIntersectionHelper.intersectElevationFromScreen(a(e.x,e.y),r,this._getGeometryZValue())}else{let r=this.elevationInfo??S;t=this.view.sceneIntersectionHelper.intersectElevationFromScreen(a(e.x,e.y),r,0),t!=null&&(t.z=void 0)}else t=this.view.toMap(e),t!=null&&(t.z=this.hasZ?this._getGeometryZValue():void 0);return t}_pushCursorVertex(e,t){let r=y(e[0],e[1],void 0,this.view.spatialReference);this._stagedVertexUnsnapped=r;let s=this._snappingManager;if(s==null)return this._stagedVertex=r,void t();m(this._snappingOperation.snap({point:r},s,this._snappingContext)).then(()=>{t()})}_popCursorVertex(){this._stagedVertexUnsnapped=null,this._stagedVertex=null}_getGeometryZValue(){return this.defaultZ}_abortSnapping(){this._snappingOperation.abort()}_isDuplicateOfLastVertex(e){let t=this._editGeometryOperations.data.components[0].getLastVertex()?.pos;if(t&&e[0]===t[0]&&e[1]===t[1])return!0;let{x:r,y:s}=this._coordinateHelper.vectorToDehydratedPoint(e);return this._lastVertexUnsnapped!=null&&r===this._lastVertexUnsnapped.x&&s===this._lastVertexUnsnapped.y}_shouldHandlePointerEvent(e){return Z(e)&&(this._activePointerId==null||this._activePointerId===e.pointerId)}_vertexAddHandler(e){let t=this._stagedVertex!=null?this._coordinateHelper.pointToArray(this._stagedVertex):this.getCoordsFromScreenPoint(this._cursorScreenPoint);t!=null&&this._addVertex(t,e.native)}_drawCompleteHandler(e){this._completeDrawing(e.native)}};i.SNAPPING_GRAPHICS_LAYER_ID="DrawAction-snapping-graphics-layer",n([o({readOnly:!0})],i.prototype,"vertices",null),n([o({type:Boolean,nonNullable:!0})],i.prototype,"interactiveUndoDisabled",void 0),n([o({readOnly:!0})],i.prototype,"history",void 0),n([o({readOnly:!0})],i.prototype,"redoHistory",void 0),n([o()],i.prototype,"snapToScene",void 0),n([o()],i.prototype,"view",void 0),n([o()],i.prototype,"elevationInfo",void 0),n([o({nonNullable:!0})],i.prototype,"defaultZ",void 0),n([o()],i.prototype,"hasZ",null),n([o()],i.prototype,"_snappingOperation",void 0),n([o()],i.prototype,"_stagedVertex",null),i=d=n([_("esri.views.draw.DrawAction")],i);var P={mode:"absolute-height",offset:0},S={mode:"on-the-ground",offset:0};function Z(e){return e.pointerType!=="mouse"||e.button===0}var q=i;export{q as a};
