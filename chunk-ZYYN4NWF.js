import{a as N}from"./chunk-FSW536RM.js";import{j as ot,k as le,l as ce,m as nt,n as lt,o as ct,p as ft}from"./chunk-VN5FPMRB.js";import{a as $e,h as et}from"./chunk-N7DSOI7B.js";import{a as pt}from"./chunk-CY62WWD7.js";import{b as O}from"./chunk-QAHTJVUZ.js";import{b as fe,c as ht}from"./chunk-XE4T4457.js";import{a as dt}from"./chunk-BWHHYBB5.js";import{a as je,b as ke}from"./chunk-T5UBLAP4.js";import{f as Xe,k as Ye,l as Ze,m as Je}from"./chunk-DA3NC6W4.js";import{a as at}from"./chunk-FRN24G7D.js";import{a as tt,e as it,f as rt}from"./chunk-FGABE2LC.js";import{f as st}from"./chunk-6FZTFPIH.js";import{c as He,d as oe,e as We,f as Ge,i as Qe,j as Ke}from"./chunk-J5AEP4US.js";import{a as qe}from"./chunk-YHRLMRSO.js";import{a as ne}from"./chunk-EM2AEAFS.js";import{a as X}from"./chunk-VGAXEXH3.js";import{a as Ve}from"./chunk-PHMJ7KPL.js";import{a as Be,h as G,m as j}from"./chunk-YEXMIDOT.js";import{b as we}from"./chunk-E2QKN2KY.js";import{a as ze}from"./chunk-PDQQY7RQ.js";import{a as c}from"./chunk-RWCIDBNQ.js";import{a as se,c as Ne}from"./chunk-EM35R6FY.js";import{b as ie,i as Me}from"./chunk-HM5RIVQC.js";import{a as re}from"./chunk-DJW5LMRG.js";import{a as ae}from"./chunk-DEH76MSI.js";import{a as Ue}from"./chunk-ALWV3RJ2.js";import{p as Le}from"./chunk-2ZFXOJDB.js";import{b as Pe,t as Fe}from"./chunk-QXXXCEV5.js";import{a as w,b as x,c as H,d as W,e as _e,n as L,p as Re,u as te,v as De,y as M,z as xe}from"./chunk-6B5XFA6F.js";import{a as q,d as ee,e as Ie}from"./chunk-PTZYZULI.js";import{f as Ce}from"./chunk-ZTOZWLEE.js";import{a as R,c as ye}from"./chunk-BOVYXYHK.js";import{a as be}from"./chunk-KVM6SHDX.js";import{b as Ee,i as Ae}from"./chunk-EQZWYK27.js";import{a as g}from"./chunk-QGVBCWUY.js";import{a as $}from"./chunk-VTHXE323.js";function Ct(a){return a instanceof Float32Array&&a.length>=16}function It(a){return Array.isArray(a)&&a.length>=16}function ut(a){return Ct(a)||It(a)}var Y=class{constructor(){this.factor=new Z,this.factorAlignment=new Z}},Z=class{constructor(){this.scale=0,this.factor=0,this.minScaleFactor=0}};var J=class extends ke{constructor(e,s){super(e,s,new je(ht,()=>import("./chunk-FTXS2NQI.js"))),this.primitiveType=s.occlusionPass?ie.POINTS:ie.TRIANGLES}initializePipeline(e){let{oitPass:s,hasPolygonOffset:t,draped:i,output:r,depthTestEnabled:n,occlusionPass:o}=e,d=s===ne.NONE,h=s===ne.ColorAlpha,p=r===Be.Highlight,l=n&&!i&&!h&&!o&&!p;return Je({blending:G(r)?d?Xe:$e(s):null,depthTest:n&&!i?{func:Me.LEQUAL}:null,depthWrite:l?Ye:null,drawBuffers:et(s,r),colorWrite:Ze,polygonOffset:t?Pt:null})}},Pt={factor:0,units:-4};var u=class extends pt{constructor(e){super(),this.spherical=e,this.screenCenterOffsetUnitsEnabled=!1,this.occlusionTestEnabled=!0,this.signedDistanceFieldEnabled=!1,this.sampleSignedDistanceFieldTexelCenter=!1,this.vvSize=!1,this.vvColor=!1,this.hasVerticalOffset=!1,this.hasScreenSizePerspective=!1,this.hasRotation=!1,this.debugDrawLabelBorder=!1,this.hasPolygonOffset=!1,this.depthTestEnabled=!0,this.pixelSnappingEnabled=!0,this.draped=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.occlusionPass=!1,this.occludedFragmentFade=!1,this.objectAndLayerIdColorInstanced=!1,this.horizonCullingEnabled=!0,this.isFocused=!0,this.textureCoordinateType=tt.None,this.emissionSource=at.None,this.discardInvisibleFragments=!0,this.hasVvInstancing=!1}};g([O()],u.prototype,"screenCenterOffsetUnitsEnabled",void 0),g([O()],u.prototype,"occlusionTestEnabled",void 0),g([O()],u.prototype,"signedDistanceFieldEnabled",void 0),g([O()],u.prototype,"sampleSignedDistanceFieldTexelCenter",void 0),g([O()],u.prototype,"vvSize",void 0),g([O()],u.prototype,"vvColor",void 0),g([O()],u.prototype,"hasVerticalOffset",void 0),g([O()],u.prototype,"hasScreenSizePerspective",void 0),g([O()],u.prototype,"hasRotation",void 0),g([O()],u.prototype,"debugDrawLabelBorder",void 0),g([O()],u.prototype,"hasPolygonOffset",void 0),g([O()],u.prototype,"depthTestEnabled",void 0),g([O()],u.prototype,"pixelSnappingEnabled",void 0),g([O()],u.prototype,"draped",void 0),g([O()],u.prototype,"terrainDepthTest",void 0),g([O()],u.prototype,"cullAboveTerrain",void 0),g([O()],u.prototype,"occlusionPass",void 0),g([O()],u.prototype,"occludedFragmentFade",void 0),g([O()],u.prototype,"objectAndLayerIdColorInstanced",void 0),g([O()],u.prototype,"horizonCullingEnabled",void 0),g([O()],u.prototype,"isFocused",void 0);var mt=class extends Qe{constructor(e,s){super(e,ge),this.produces=new Map([[N.HUD_MATERIAL,t=>j(t)&&!this.parameters.drawAsLabel],[N.LABEL_MATERIAL,t=>j(t)&&this.parameters.drawAsLabel],[N.OCCLUSION_PIXELS,()=>this.parameters.occlusionTest],[N.DRAPED_MATERIAL,t=>this.parameters.draped&&j(t)]]),this._visible=!0,this._configuration=new u(s)}getConfiguration(e,s){return this._configuration.output=e,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasVerticalOffset=!!this.parameters.verticalOffset,this._configuration.hasScreenSizePerspective=!!this.parameters.screenSizePerspective,this._configuration.screenCenterOffsetUnitsEnabled=this.parameters.centerOffsetUnits==="screen",this._configuration.hasPolygonOffset=this.parameters.polygonOffset,this._configuration.draped=this.parameters.draped,this._configuration.occlusionTestEnabled=this.parameters.occlusionTest,this._configuration.pixelSnappingEnabled=this.parameters.pixelSnappingEnabled,this._configuration.signedDistanceFieldEnabled=this.parameters.textureIsSignedDistanceField,this._configuration.sampleSignedDistanceFieldTexelCenter=this.parameters.sampleSignedDistanceFieldTexelCenter,this._configuration.hasRotation=this.parameters.hasRotation,this._configuration.vvSize=!!this.parameters.vvSize,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.occlusionPass=s.slot===N.OCCLUSION_PIXELS,this._configuration.occludedFragmentFade=this.parameters.occludedFragmentFade,this._configuration.horizonCullingEnabled=this.parameters.horizonCullingEnabled,this._configuration.isFocused=this.parameters.isFocused,this._configuration.depthTestEnabled=this.parameters.depthEnabled||s.slot===N.OCCLUSION_PIXELS,G(e)&&(this._configuration.debugDrawLabelBorder=!!qe.LABELS_SHOW_BORDER),this._configuration.oitPass=s.oitPass,this._configuration.terrainDepthTest=s.terrainDepthTest,this._configuration.cullAboveTerrain=s.cullAboveTerrain,this._configuration}intersect(e,s,t,i,r,n){let{options:{selectionMode:o,hud:d,excludeLabels:h},point:p,camera:l}=t,{parameters:m}=this;if(!o||!d||h&&m.isLabel||!e.visible||!p)return;let{scaleX:f,scaleY:T}=this._getScreenScale(e,l.pixelRatio);re(de,s),e.attributes.has(c.FEATUREATTRIBUTE)&&_t(de);let v=e.attributes.get(c.POSITION),I=e.attributes.get(c.SIZE),P=e.attributes.get(c.NORMAL),A=e.attributes.get(c.ROTATION),C=e.attributes.get(c.CENTEROFFSETANDDISTANCE);ze(v.size>=3);let _=fe(m),D=this.parameters.centerOffsetUnits==="screen";for(let F=0;F<v.data.length/v.size;F++){let k=F*v.size;H(S,v.data[k],v.data[k+1],v.data[k+2]),M(S,S,s),M(S,S,l.viewMatrix);let Q=F*C.size;if(H(y,C.data[Q],C.data[Q+1],C.data[Q+2]),!D&&(S[0]+=y[0],S[1]+=y[1],y[2]!==0)){let V=y[2];te(y,S),_e(S,S,L(y,y,V))}let K=F*P.size;if(H(U,P.data[K],P.data[K+1],P.data[K+2]),gt(U,de,l,ue),this._applyVerticalOffsetTransformationView(S,ue,l,pe),l.applyProjection(S,E),E[0]>-1){D&&(y[0]||y[1])&&(E[0]+=y[0]*l.pixelRatio,y[1]!==0&&(E[1]+=He(y[1],pe.factorAlignment)*l.pixelRatio),l.unapplyProjection(E,S)),E[0]+=this.parameters.screenOffset[0]*l.pixelRatio,E[1]+=this.parameters.screenOffset[1]*l.pixelRatio,E[0]=Math.floor(E[0]),E[1]=Math.floor(E[1]);let V=F*I.size;b[0]=I.data[V],b[1]=I.data[V+1],We(b,pe.factor,b);let At=Lt*l.pixelRatio,Se=0;m.textureIsSignedDistanceField&&(Se=Math.min(m.outlineSize,.5*b[0])*l.pixelRatio/2),b[0]*=f,b[1]*=T;let bt=F*A.size,yt=m.rotation+A.data[bt];if(Ot(p,E[0],E[1],b,At,Se,yt,m,_)){let Te=t.ray;if(M(St,S,Ce(Dt,l.viewMatrix)),E[0]=p[0],E[1]=p[1],l.unprojectFromRenderScreen(E,S)){let z=R();x(z,Te.direction);let ve=1/w(z);L(z,z,ve),n(Re(Te.origin,S)*ve,z,-1,!0,1,St)}}}}}intersectDraped(e,s,t,i,r,n){let o=e.attributes.get(c.POSITION),d=e.attributes.get(c.SIZE),h=e.attributes.get(c.ROTATION),p=this.parameters,l=fe(p),{scaleX:m,scaleY:f}=this._getScreenScale(e,e.screenToWorldRatio),T=Nt*e.screenToWorldRatio;for(let v=0;v<o.data.length/o.size;v++){let I=v*o.size,P=o.data[I],A=o.data[I+1],C=v*d.size;b[0]=d.data[C],b[1]=d.data[C+1];let _=0;p.textureIsSignedDistanceField&&(_=Math.min(p.outlineSize,.5*b[0])*e.screenToWorldRatio/2),b[0]*=m,b[1]*=f;let D=v*h.size,F=p.rotation+h.data[D];Ot(i,P,A,b,T,_,F,p,l)&&r(n.dist,n.normal,-1,!1)}}createBufferWriter(){return new Oe}_updateScaleInfo(e,s,t){let i=this.parameters;i.screenSizePerspective!=null?oe(t,s,i.screenSizePerspective,e.factor):(e.factor.scale=1,e.factor.factor=0,e.factor.minScaleFactor=0),i.screenSizePerspectiveAlignment!=null?oe(t,s,i.screenSizePerspectiveAlignment,e.factorAlignment):(e.factorAlignment.factor=e.factor.factor,e.factorAlignment.scale=e.factor.scale,e.factorAlignment.minScaleFactor=e.factor.minScaleFactor)}applyShaderOffsetsView(e,s,t,i,r,n,o){let d=gt(s,t,r,ue);return this._applyVerticalGroundOffsetView(e,d,r,o),this._applyVerticalOffsetTransformationView(o,d,r,n),this._applyPolygonOffsetView(o,d,i[3],r,o),this._applyCenterOffsetView(o,i,o),o}applyShaderOffsetsNDC(e,s,t,i,r){return this._applyCenterOffsetNDC(e,s,t,i),r!=null&&x(r,i),this._applyPolygonOffsetNDC(i,s,t,i),i}_applyPolygonOffsetView(e,s,t,i,r){let n=i.aboveGround?1:-1,o=Math.sign(t);o===0&&(o=n);let d=n*o;if(this.parameters.shaderPolygonOffset<=0)return x(r,e);let h=Ee(Math.abs(s.cosAngle),.01,1),p=1-Math.sqrt(1-h*h)/h/i.viewport[2];return L(r,e,d>0?p:1/p),r}_applyVerticalGroundOffsetView(e,s,t,i){let r=w(e),n=t.aboveGround?1:-1,o=t.computeRenderPixelSizeAtDist(r)*dt,d=L(S,s.normal,n*o);return W(i,e,d),i}_applyVerticalOffsetTransformationView(e,s,t,i){let r=this.parameters;if(!r.verticalOffset?.screenLength){if(r.screenSizePerspective||r.screenSizePerspectiveAlignment){let h=w(e);this._updateScaleInfo(i,h,s.cosAngle)}else i.factor.scale=1,i.factorAlignment.scale=1;return e}let n=w(e),o=r.screenSizePerspectiveAlignment??r.screenSizePerspective,d=Ge(t,n,r.verticalOffset,s.cosAngle,o);return this._updateScaleInfo(i,n,s.cosAngle),L(s.normal,s.normal,d),W(e,e,s.normal)}_applyCenterOffsetView(e,s,t){let i=this.parameters.centerOffsetUnits!=="screen";return t!==e&&x(t,e),i&&(t[0]+=s[0],t[1]+=s[1],s[2]&&(te(U,t),W(t,t,L(U,U,s[2])))),t}_applyCenterOffsetNDC(e,s,t,i){let r=this.parameters.centerOffsetUnits!=="screen";return i!==e&&x(i,e),r||(i[0]+=s[0]/t.fullWidth*2,i[1]+=s[1]/t.fullHeight*2),i}_applyPolygonOffsetNDC(e,s,t,i){let r=this.parameters.shaderPolygonOffset;if(e!==i&&x(i,e),r){let n=t.aboveGround?1:-1,o=n*Math.sign(s[3]);i[2]-=(o||n)*r}return i}set visible(e){this._visible=e}get visible(){let{color:e,outlineSize:s,outlineColor:t}=this.parameters,i=e[3]>=X||s>=X&&t[3]>=X;return this._visible&&i}createGLMaterial(e){return new me(e)}calculateRelativeScreenBounds(e,s,t=be()){return Ft(this.parameters,e,s,t),t[2]=t[0]+e[0],t[3]=t[1]+e[1],t}_getScreenScale(e,s){let t=e.attributes.get(c.FEATUREATTRIBUTE);if(t==null)return{scaleX:s,scaleY:s};let i=Ie(t.data,xt);return st(he,this.parameters,i),{scaleX:he[0]*s,scaleY:he[1]*s}}},me=class extends it{constructor(e){super($($({},e),e.material.parameters))}beginSlot(e){return this.updateTexture(this._material.parameters.textureId),this._material.setParameters(this.textureBindParameters),this.getTechnique(J,e)}};function Ft(a,e,s,t){t[0]=a.anchorPosition[0]*-e[0]+a.screenOffset[0]*s,t[1]=a.anchorPosition[1]*-e[1]+a.screenOffset[1]*s}function gt(a,e,s,t){return ut(e)&&(e=re(Rt,e)),xe(t.normal,a,e),M(t.normal,t.normal,s.viewInverseTransposeMatrix),t.cosAngle=De(vt,zt),t}function _t(a){let e=a[0],s=a[1],t=a[2],i=a[3],r=a[4],n=a[5],o=a[6],d=a[7],h=a[8],p=1/Math.sqrt(e*e+s*s+t*t),l=1/Math.sqrt(i*i+r*r+n*n),m=1/Math.sqrt(o*o+d*d+h*h);return a[0]=e*p,a[1]=s*p,a[2]=t*p,a[3]=i*l,a[4]=r*l,a[5]=n*l,a[6]=o*m,a[7]=d*m,a[8]=h*m,a}function Ot(a,e,s,t,i,r,n,o,d){let h=e-i-t[0]*d[0],p=h+t[0]+2*i,l=s-i-t[1]*d[1],m=l+t[1]+2*i,f=o.distanceFieldBoundingBox;return o.textureIsSignedDistanceField&&f!=null&&(h+=t[0]*f[0],l+=t[1]*f[1],p-=t[0]*(1-f[2]),m-=t[1]*(1-f[3]),h-=r,p+=r,l-=r,m+=r),Pe(Tt,e,s),Fe(B,a,Tt,Ae(n)),B[0]>h&&B[0]<p&&B[1]>l&&B[1]<m}var pe=new Y,S=R(),U=R(),E=q(),vt=R(),St=R(),B=se(),Tt=se(),de=ae(),Rt=ae(),Dt=Ue(),y=R(),he=R(),xt=q(),ue={normal:vt,cosAngle:0},Lt=1,Nt=2,b=[0,0],zt=ye(0,0,1),ge=class extends rt{constructor(){super(...arguments),this.renderOccluded=Ke.Occlude,this.isDecoration=!1,this.color=ee(1,1,1,1),this.polygonOffset=!1,this.anchorPosition=Ne(.5,.5),this.screenOffset=[0,0],this.shaderPolygonOffset=1e-5,this.textureIsSignedDistanceField=!1,this.sampleSignedDistanceFieldTexelCenter=!1,this.outlineColor=ee(1,1,1,1),this.outlineSize=0,this.distanceFieldBoundingBox=q(),this.rotation=0,this.hasRotation=!1,this.vvSizeEnabled=!1,this.vvSize=null,this.vvColor=null,this.vvOpacity=null,this.vvSymbolAnchor=null,this.vvSymbolRotationMatrix=null,this.hasSlicePlane=!1,this.pixelSnappingEnabled=!0,this.occlusionTest=!0,this.occludedFragmentFade=!1,this.horizonCullingEnabled=!1,this.centerOffsetUnits="world",this.drawAsLabel=!1,this.depthEnabled=!0,this.isFocused=!0,this.focusEffect="none",this.draped=!1,this.isLabel=!1}},Et=we().vec3f(c.POSITION).vec3f(c.NORMAL).vec2f(c.UV0).vec4u8(c.COLOR).vec2f(c.SIZE).f32(c.ROTATION).vec4f(c.CENTEROFFSETANDDISTANCE).vec4f(c.FEATUREATTRIBUTE),wt=Et.clone().vec4u8(c.OBJECTANDLAYERIDCOLOR),Oe=class{constructor(){this.vertexBufferLayout=Ve()?wt:Et}elementCount(e){return 6*e.get(c.POSITION).indices.length}write(e,s,t,i,r,n){nt(t.get(c.POSITION),e,r.position,n,6),lt(t.get(c.NORMAL),s,r.normal,n,6);let o=t.get(c.UV0)?.data,d=0,h=0,p=1,l=1;o&&o.length>=4&&(d=o[0],h=o[1],p=o[2],l=o[3]),p=Math.min(1.99999,p+1),l=Math.min(1.99999,l+1);let m=t.get(c.POSITION).indices.length,f=n,T=r.uv0;for(let A=0;A<m;++A)T.set(f,0,d),T.set(f,1,h),f++,T.set(f,0,p),T.set(f,1,h),f++,T.set(f,0,p),T.set(f,1,l),f++,T.set(f,0,p),T.set(f,1,l),f++,T.set(f,0,d),T.set(f,1,l),f++,T.set(f,0,d),T.set(f,1,h),f++;ct(t.get(c.COLOR),4,r.color,n,6);let{data:v,indices:I}=t.get(c.SIZE);m=I.length;let P=r.size;f=n;for(let A=0;A<m;++A){let C=v[2*I[A]],_=v[2*I[A]+1];for(let D=0;D<6;++D)P.set(f,0,C),P.set(f,1,_),f++}if(ot(t.get(c.ROTATION),r.rotation,n,6),t.get(c.CENTEROFFSETANDDISTANCE)?le(t.get(c.CENTEROFFSETANDDISTANCE),r.centerOffsetAndDistance,n,6):ce(r.centerOffsetAndDistance,n,6*m),t.get(c.FEATUREATTRIBUTE)?le(t.get(c.FEATUREATTRIBUTE),r.featureAttribute,n,6):ce(r.featureAttribute,n,6*m),i!=null){let A=t.get(c.POSITION)?.indices;if(A){let C=A.length,_=r.getField(c.OBJECTANDLAYERIDCOLOR,Le);ft(i,_,C,n,6)}}}};export{Y as a,mt as b};
