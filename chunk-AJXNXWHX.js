import{c as Tt}from"./chunk-WZHDEFTY.js";import"./chunk-KYSTRHK2.js";import"./chunk-FLJOXWPY.js";import{a as pt,b as gt,c as bt,d as vt}from"./chunk-CIUMFIN4.js";import{a as wt,b as _t}from"./chunk-7GJJ7VEI.js";import{b as ft}from"./chunk-UZ6X2SIU.js";import{b as yt}from"./chunk-KGY4BCEM.js";import{a as ut,b as ht,c as fe}from"./chunk-ZA2DRI5X.js";import"./chunk-3LFQVTDE.js";import{a as dt}from"./chunk-26JWDTE3.js";import{a as mt}from"./chunk-PMIZEMLB.js";import"./chunk-CCSZEQ2U.js";import"./chunk-HMOFKUIJ.js";import"./chunk-QGGZ7JI7.js";import"./chunk-EMILT3E5.js";import"./chunk-5KY2RG7F.js";import"./chunk-XQ4DD6H6.js";import"./chunk-E3FPV7ZA.js";import"./chunk-IQA3CVAZ.js";import{c as ct}from"./chunk-2DH3L3DZ.js";import"./chunk-N3W77OHB.js";import"./chunk-QIO7OVOF.js";import"./chunk-J3QLC2LP.js";import"./chunk-VBFF4VHB.js";import"./chunk-Q2IUY7EW.js";import"./chunk-6HINJY73.js";import{a as lt}from"./chunk-FY4QM6AV.js";import{e as nt}from"./chunk-QBDGQCUP.js";import{v as pe}from"./chunk-Z7TBAZRW.js";import{c as st}from"./chunk-BKWQOCBC.js";import"./chunk-YTAJKLRN.js";import{a as et,b as tt}from"./chunk-3ZJ4NMBE.js";import"./chunk-4S7THJAS.js";import{a as at,r as ot}from"./chunk-VN5FPMRB.js";import"./chunk-N7DSOI7B.js";import"./chunk-F4HA2HQL.js";import{b as it}from"./chunk-VDNRZCIE.js";import"./chunk-I2JD5OSI.js";import"./chunk-2MROBW6T.js";import"./chunk-QAHTJVUZ.js";import"./chunk-PSNQ2KG3.js";import{a as p,b as M,c as U,d as $,e as E,f as P,g as F,h as ue,i as q,k as Qe,l as Ze}from"./chunk-U3SOQMWO.js";import"./chunk-ZVSQXQ5X.js";import"./chunk-2IWALBQY.js";import"./chunk-K6RQLPKJ.js";import"./chunk-7V6BRQYE.js";import"./chunk-PORMJXR6.js";import"./chunk-Y7XG5IWW.js";import"./chunk-LSV6EK6V.js";import"./chunk-X5NPIY3C.js";import"./chunk-5252J253.js";import"./chunk-7WCQBAQY.js";import"./chunk-VQSLKKYN.js";import"./chunk-JBAMJB5J.js";import"./chunk-VAOSSSLB.js";import"./chunk-CUV3BSEW.js";import"./chunk-2UHZH5L3.js";import"./chunk-DQINVX66.js";import"./chunk-CSFAHB4Y.js";import"./chunk-T5UBLAP4.js";import"./chunk-DA3NC6W4.js";import"./chunk-6L543SC5.js";import"./chunk-FRN24G7D.js";import{a as he}from"./chunk-FGABE2LC.js";import"./chunk-CU7FHMWW.js";import"./chunk-CZMBPC27.js";import"./chunk-VANM5A4M.js";import"./chunk-VSD74FMI.js";import"./chunk-O2J7LFYY.js";import"./chunk-KPT44MCK.js";import"./chunk-XKFJ6GWH.js";import"./chunk-GSXOR3JU.js";import"./chunk-55OTJIMU.js";import"./chunk-EM2AEAFS.js";import"./chunk-YEPHAEAY.js";import"./chunk-TK4PPGQL.js";import"./chunk-ELCBU4NP.js";import"./chunk-GMZFCQJQ.js";import"./chunk-5WDH2LXO.js";import"./chunk-L7NOU4T2.js";import{a as rt}from"./chunk-VGAXEXH3.js";import"./chunk-GWSX6PRO.js";import"./chunk-G2JMPZCN.js";import"./chunk-IRQF7UTO.js";import"./chunk-3KOZOOEP.js";import"./chunk-OL54OOJH.js";import"./chunk-EG2DTURK.js";import"./chunk-NQ3CCFQA.js";import"./chunk-YVCKQBWT.js";import"./chunk-WOZSH7YY.js";import"./chunk-2PJRHNJW.js";import"./chunk-B2RVSTL3.js";import"./chunk-4XEE5PE3.js";import"./chunk-2CKJLDTO.js";import"./chunk-F6TN7E7K.js";import"./chunk-4LDVFWME.js";import"./chunk-HUUJBVXR.js";import"./chunk-7G56KLCZ.js";import"./chunk-UKAGN54W.js";import{a as Ke}from"./chunk-CTVZOIWY.js";import"./chunk-7KP7SKLW.js";import{d as Ye}from"./chunk-456M7HFK.js";import{a as Xe}from"./chunk-342NGUMP.js";import"./chunk-NIYDRLW4.js";import"./chunk-PHMJ7KPL.js";import"./chunk-ESSDCWGF.js";import"./chunk-WVKBXQWE.js";import"./chunk-42SGGFLN.js";import"./chunk-EDOVNTC7.js";import"./chunk-FSWSNKJD.js";import"./chunk-FGEB67EG.js";import"./chunk-YEXMIDOT.js";import"./chunk-T7PUQGWM.js";import"./chunk-GV3ZFCVD.js";import"./chunk-SOEEM7Z7.js";import"./chunk-MVDZB4AK.js";import"./chunk-44A27HB7.js";import"./chunk-47NSYSFY.js";import"./chunk-QXNVQZT7.js";import"./chunk-QSQIQSC6.js";import"./chunk-AYNBEMCC.js";import"./chunk-LNYBTIG7.js";import"./chunk-VYZHOYXV.js";import"./chunk-ECA5I2I7.js";import"./chunk-XAHD7XBV.js";import{a as qe,b as Je}from"./chunk-Y7XRSFOZ.js";import{b as S}from"./chunk-YQNUGDFH.js";import{a as $e}from"./chunk-QCZ3ZIGQ.js";import"./chunk-7SDNM7YV.js";import"./chunk-4NUW747S.js";import"./chunk-T6WMVIUG.js";import{a as x,g as I,h as z}from"./chunk-ONYJLWAD.js";import"./chunk-UBEQHTGJ.js";import"./chunk-PHODKV66.js";import{c as ze}from"./chunk-JPMGMA4B.js";import{a as We}from"./chunk-LAX5536Z.js";import"./chunk-N3HRYLNW.js";import"./chunk-4DBMALZW.js";import"./chunk-CVWWHM2V.js";import"./chunk-6OQYVEQJ.js";import"./chunk-YOXOWGT6.js";import"./chunk-EFZOSMYP.js";import"./chunk-WI7F4ZKJ.js";import"./chunk-MJ7M24NH.js";import"./chunk-GJH4QFRX.js";import"./chunk-T63F7663.js";import"./chunk-O4V2VBSK.js";import"./chunk-5TKRKB5E.js";import"./chunk-XAGMDNNR.js";import"./chunk-OP2TLIUN.js";import"./chunk-T2THIR6K.js";import"./chunk-LORHDXEB.js";import"./chunk-BBBPJI4H.js";import"./chunk-45BTW5EG.js";import"./chunk-TPFBHGDM.js";import"./chunk-73NLRHJD.js";import"./chunk-PNFEUBDF.js";import"./chunk-6RCCEJDL.js";import"./chunk-PQ2TNDUX.js";import"./chunk-6X6MKRQ3.js";import"./chunk-FQFHMHYU.js";import"./chunk-SZMEI3WL.js";import"./chunk-KKVGD67U.js";import"./chunk-MYOJWRDU.js";import"./chunk-L7UKJKHG.js";import"./chunk-V2IENAEU.js";import"./chunk-QAGQFNF2.js";import"./chunk-SY7JS2VW.js";import"./chunk-WK57SDN6.js";import"./chunk-AG4V3ZUO.js";import"./chunk-YWLMJ26A.js";import"./chunk-QAWNU3UJ.js";import"./chunk-HRQT4R6X.js";import"./chunk-44BHLWQ4.js";import"./chunk-5BPM64SU.js";import"./chunk-PMVHHMQJ.js";import"./chunk-NAFOM5UA.js";import"./chunk-DO7UF2F2.js";import"./chunk-ZTR6OS44.js";import"./chunk-VRTKAD2J.js";import"./chunk-DBLKLHK2.js";import"./chunk-UTE3ASAZ.js";import"./chunk-2AFEAPEX.js";import"./chunk-GNGXUEWV.js";import"./chunk-QBI5NDCA.js";import"./chunk-NOHW2DKR.js";import"./chunk-HVJAAM3A.js";import"./chunk-ACPEJEHK.js";import"./chunk-I7B3LWNP.js";import"./chunk-YP2E5N4E.js";import"./chunk-QLMNLSCT.js";import"./chunk-P55G5ATK.js";import"./chunk-JT3K52KQ.js";import"./chunk-SPLEGG4R.js";import"./chunk-Y4TJDUGP.js";import"./chunk-6PAFOJ4W.js";import"./chunk-74SDGE57.js";import"./chunk-FRXWHX3T.js";import"./chunk-DTDQ5X42.js";import"./chunk-RX2HFR4X.js";import"./chunk-AZW7YPTQ.js";import"./chunk-NJLJX4X6.js";import"./chunk-DZHFTD24.js";import"./chunk-K57Z4J34.js";import"./chunk-VWG3KVOU.js";import"./chunk-JOEUVLAN.js";import"./chunk-JZQDGIDQ.js";import"./chunk-CZ6CGC7I.js";import"./chunk-7B6U3N62.js";import"./chunk-46WDO5LS.js";import"./chunk-G5EYK5KM.js";import"./chunk-YJKJQU3F.js";import"./chunk-OK4K3OQT.js";import"./chunk-BPWNCOXC.js";import"./chunk-VNS4CQ27.js";import"./chunk-AVMO6LCR.js";import"./chunk-TEGPMVWT.js";import"./chunk-CLQRQC3Y.js";import"./chunk-KSNU73LO.js";import"./chunk-FACEVGRE.js";import"./chunk-5XTCPT52.js";import"./chunk-JQAW4OB5.js";import"./chunk-F2BQ2GD6.js";import"./chunk-R3XLNYYB.js";import"./chunk-BMYVPMAK.js";import"./chunk-6F25LG6O.js";import"./chunk-GJ2QRXGN.js";import{c as je}from"./chunk-MSDJIYGD.js";import"./chunk-6QXEFK4U.js";import"./chunk-E2QKN2KY.js";import"./chunk-PDQQY7RQ.js";import{a as L}from"./chunk-RWCIDBNQ.js";import"./chunk-2NH7HOKA.js";import"./chunk-EM35R6FY.js";import{b as ce,l as v}from"./chunk-HM5RIVQC.js";import"./chunk-HKJZ7WI6.js";import"./chunk-CXOFHVIF.js";import{b as Ne}from"./chunk-EO2H4LIH.js";import{a as ke,e as Ge}from"./chunk-DJW5LMRG.js";import{a as me,d as W}from"./chunk-DEH76MSI.js";import{a as de}from"./chunk-ALWV3RJ2.js";import{C as He,b as De,c as N,d as Le,o as Se,p as Fe,q as ne,s as Re,t as Be,u as le}from"./chunk-2ZFXOJDB.js";import"./chunk-QXXXCEV5.js";import{d as Ue,z as Ae}from"./chunk-6B5XFA6F.js";import"./chunk-3JGYBNJA.js";import"./chunk-DA3SDKGO.js";import"./chunk-ZOEPYNM4.js";import"./chunk-57VFBGF3.js";import"./chunk-GWBRHLNH.js";import"./chunk-BJH4F4SM.js";import"./chunk-Z3RBZHAK.js";import{c as Ie}from"./chunk-PTZYZULI.js";import"./chunk-NMLYCCKN.js";import"./chunk-ZC6EBRE4.js";import"./chunk-KALOJIUA.js";import"./chunk-KMMTNF7G.js";import"./chunk-MIS6QMFE.js";import"./chunk-MDZTV2VL.js";import"./chunk-RNC4P66O.js";import"./chunk-7LHOQXZT.js";import"./chunk-BCREO4Q5.js";import"./chunk-U4QEPZJ3.js";import"./chunk-KJUZWSCL.js";import"./chunk-3WO6D7MU.js";import"./chunk-BUZ3SPLE.js";import"./chunk-D3CUKSGS.js";import"./chunk-K75TK42V.js";import"./chunk-OLOKUDVI.js";import{h as Oe,t as Ve}from"./chunk-ZTOZWLEE.js";import"./chunk-RJWOVI3M.js";import"./chunk-RSDQHAJX.js";import{a as G,e as Ee}from"./chunk-BOVYXYHK.js";import"./chunk-KVM6SHDX.js";import"./chunk-HX2VGIR2.js";import"./chunk-ERDKAICI.js";import"./chunk-EQZWYK27.js";import"./chunk-JLPLCY2B.js";import"./chunk-DKGGDYJI.js";import"./chunk-5LA3PVK5.js";import"./chunk-IR6XCBC4.js";import"./chunk-C6JPAW54.js";import"./chunk-WD3OPXCN.js";import"./chunk-FA3WGIU4.js";import"./chunk-WWVPA6PE.js";import"./chunk-ZQIC5NFT.js";import"./chunk-VIEK2X23.js";import"./chunk-XKIFGPJO.js";import"./chunk-PEW2PLAN.js";import"./chunk-Q6Y4JG7Q.js";import"./chunk-7F5DJLJT.js";import"./chunk-CX5IFQZJ.js";import{x as Pe}from"./chunk-NJWTSROP.js";import"./chunk-D3R25AF2.js";import"./chunk-ARRCN5K3.js";import"./chunk-WGAOVKGR.js";import"./chunk-4N4D2YQX.js";import"./chunk-G4DZJMGT.js";import"./chunk-K5T5FD5C.js";import"./chunk-MVHHPJM7.js";import"./chunk-VDO6JJ3Y.js";import"./chunk-WFKZLI6F.js";import"./chunk-X2B63YVS.js";import"./chunk-BAEF3CT6.js";import"./chunk-AUAZP44J.js";import"./chunk-PVDFCTA4.js";import"./chunk-KNVXE32P.js";import"./chunk-76ATOSLU.js";import"./chunk-CCJU4DSH.js";import{a as oe,j as xe}from"./chunk-TG45K3WR.js";import"./chunk-RAI4DTMT.js";import"./chunk-ACP3S2CH.js";import"./chunk-HVAXZ2NA.js";import"./chunk-T7DXJKX7.js";import"./chunk-TYYVNQUR.js";import{a as V}from"./chunk-QGVBCWUY.js";import"./chunk-MYO4NP2N.js";import{e as D}from"./chunk-NFIPKH6V.js";import"./chunk-JPU2PQZC.js";import{l as Ce}from"./chunk-5QEXLALV.js";import"./chunk-P6QFA5MM.js";import"./chunk-DGTD7Y73.js";import"./chunk-LI2SX4T6.js";import"./chunk-BWO7LS2H.js";import{d as Me}from"./chunk-HEVQSRJ2.js";import"./chunk-OVHPPCBL.js";import"./chunk-SNFOAZZQ.js";import"./chunk-AML4XSEF.js";import{b as ae}from"./chunk-4PTIEWMT.js";import"./chunk-TG2UTNEO.js";import{b as k}from"./chunk-YOFFGXOB.js";import{g as ie}from"./chunk-XRGPJ3QY.js";import"./chunk-6MRUJ2UW.js";import"./chunk-2LI2GKBQ.js";import{a as se}from"./chunk-QBWJMFH5.js";import{f as Te}from"./chunk-VTHXE323.js";var J=class extends dt{constructor(e,d,i,o,n,u,l){super(e,0,0,0,d),this.nodesCached=i,this.vboMB=o,this.textureMB=n,this.vboMBCached=u,this.textureMBCached=l}};var Mt={[E.Points]:null,[E.Lines]:null,[E.LineStrip]:null,[E.Triangles]:ce.TRIANGLES,[E.TriangleStrip]:ce.TRIANGLE_STRIP,[E.NotSet]:null},ye={[$.Opaque]:I.Opaque,[$.Mask]:I.Mask,[$.Blend]:I.Blend},Ct={[F.Back]:x.Back,[F.Front]:x.Front,[F.None]:x.None,[F.NotSet]:x.Back},xt={[P.WrapYBit]:{s:v.CLAMP_TO_EDGE,t:v.REPEAT},[P.WrapXBit]:{s:v.REPEAT,t:v.CLAMP_TO_EDGE},[P.WrapXy]:{s:v.REPEAT,t:v.REPEAT},[P.None]:{s:v.CLAMP_TO_EDGE,t:v.CLAMP_TO_EDGE},[P.NotSet]:{s:v.CLAMP_TO_EDGE,t:v.CLAMP_TO_EDGE}},Pt={[p.U8]:1,[p.I8]:1,[p.U16]:2,[p.I16]:2,[p.U32]:4,[p.I32]:4,[p.F32]:4,[p.F64]:8,[p.Utf8String]:1,[p.NotSet]:1};var X=class{constructor(e){this.layerUid=[],this.type=et.TILES3D,this.slicePlaneEnabled=!1,this.isGround=!0,this.layerView=e,this.layerUid.push(e.layer.uid)}intersect(e,d,i,o,n,u){let l=e.results,b=e.options.store===tt.ALL;if(e.options.filteredLayerUids.includes(this.layerView.layer.uid))return;let f=this.layerView.view._stage.renderView.componentObjectCollection,h=new at(u??!1,e.options.normalRequired);this.layerView.objects.forEach(a=>{a.visible&&a.intersectionGeometry&&f.intersect(a,i,o,e.tolerance,null,h,(c,r,g,m)=>{if(r>=0){if(d!=null&&!d(i,o,r))return;let C=w=>{let _=new nt(this.layerView.layer.uid,()=>this._createTiles3DGraphic(this.layerView.layer,{}));w.set(this.type,_,r,g)};if(this.isGround&&(l.ground.dist==null||r<l.ground.dist)&&C(l.ground),e.options.isFiltered)return;if((l.min.dist==null||r<l.min.dist)&&C(l.min),(l.max.dist==null||r>l.max.dist)&&C(l.max),b){let w=st(e.ray);C(w),e.results.all.push(w)}}})})}_createTiles3DGraphic(e,d){return new We({layer:e,sourceLayer:e,attributes:d})}};var y;(function(t){t[t.API=1]="API",t[t.VerboseAPI=2]="VerboseAPI",t[t.Error=3]="Error"})(y||(y={}));var ge=class{constructor(){this.handle=0,this.isVisible=!1,this.components=[],this.texMemoryUsage=0,this.vboMemoryUsage=0,this.cpuMemoryUsage=0,this.textures=[]}get usedMemory(){return this.texMemoryUsage+this.vboMemoryUsage+this.cpuMemoryUsage}get cachedMemory(){return this.usedMemory}};function Y(t){return Math.round(t/1048.576)/1e3}var O=class extends mt(lt){constructor(){super(...arguments),this.type="integrated-mesh-3dtiles",this._visibleGeometryChangedSchedulerHandle=null,this._wasmLayerId=-1,this.ignoresMemoryFactor=!1,this.drapeTargetType=ct.WithoutRasterImage,this._applySSAO=!se("disable-feature:im-ssao"),this._shadeNormals=!!se("enable-feature:im-shading"),this._lyrHandleToObjects=new Map,this._initialCullFace=new Map,this._suspendedHandle=null,this._dbgFlags=new Set}initialize(){if(this._dbgFlags.add(y.Error),this._dbg(y.VerboseAPI,"Tiles3DLayerView3D initialize() called"),!this._canProjectWithoutEngine())throw new k("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});let t=ut(this).then(e=>{this._intersectionHandler=new X(this),this.view.sceneIntersectionHelper.addIntersectionHandler(this._intersectionHandler),this._updatingHandles.add(()=>this.slicePlaneEnabled,i=>this._slicePlaneEnabledChange(i)),this._elevationProvider=new gt({view:this.view,layerElevationSource:this,intersectionHandler:this._intersectionHandler}),this.view.elevationProvider.register("im",this._elevationProvider),this.view.basemapTerrain.overlayManager.registerDrapeTarget(this),this._wasmLayerId=e;let d=this.view.resourceController.memoryController.newCache(`t3d-${this.uid}`,i=>this._onRemoveFromCache(i));this._memCache=d,this.addHandles([oe(()=>this.layer.elevationInfo,i=>this._elevationInfoChanged(i))]),this._suspendedHandle=oe(()=>this.suspended,i=>this._wasm?.setEnabled(this,!i),xe)}).catch(e=>{if(fe(this),this._wasmLayerId=-1,e===Qe)throw new k("tiles3d:addLayer-failure","The 3d tiles layer description was invalid.",{});if(e===Ze)throw new k("tiles3d:addLayer-failure","The 3d tiles layer web assembly module failed to download.",{})});this.addResolvingPromise(t)}destroy(){this._dbg(y.VerboseAPI,"Tiles3DLayerView3D destroy() called"),fe(this),this._suspendedHandle&&(this._suspendedHandle.remove(),this._suspendedHandle=null),this._intersectionHandler&&(this.view.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler),this._intersectionHandler=null),this._elevationProvider&&(this._elevationProvider.objectsChanged(this._obbs),this.view.elevationProvider.unregister(this._elevationProvider),this._elevationProvider=null),this.view.basemapTerrain.overlayManager.unregisterDrapeTarget(this),this._lyrHandleToObjects.forEach(t=>this.freeObject(t)),this._lyrHandleToObjects.clear(),this._initialCullFace.clear(),this._memCache=ae(this._memCache),this._updatingHandles=ae(this._updatingHandles),this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null)}_visibleGeometryChanged(){this._visibleGeometryChangedSchedulerHandle??=Me(()=>{this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle=null})}_slicePlaneEnabledChange(t){this._intersectionHandler&&(this._intersectionHandler.slicePlaneEnabled=t),this.objects.forEach(e=>{let d=this._collection.getMaterial(e);d.commonMaterialParameters.hasSlicePlane=t,d.commonMaterialParameters.cullFace=t?x.None:this._initialCullFace.get(e)})}_elevationInfoChanged(t){this._wasm?.setLayerOffset(this,pe(t))}get _obbs(){return this.objects.map(t=>this._collection.getComponentObb(t))}get _wasm(){return ht(this.view)}get wasmLayerId(){return this._wasmLayerId}get usedMemory(){let t=0;return this._lyrHandleToObjects.forEach(e=>{e.isVisible&&(t+=e.usedMemory)}),t}get unloadedMemory(){return 0}get cachedMemory(){let t=0;return this._lyrHandleToObjects.forEach(e=>{e.isVisible||(t+=e.usedMemory)}),t}get visibleAtCurrentScale(){return Ye(this.layer.effectiveScaleRange,this.view.scale)}get performanceInfo(){let t=0,e=0,d=0,i=0,o=0,n=0;return this._lyrHandleToObjects.forEach(u=>{u.isVisible?(t+=u.texMemoryUsage,e+=u.vboMemoryUsage,o++):(d+=u.texMemoryUsage,i+=u.vboMemoryUsage,n++)}),new J(this.usedMemory,o,n,Y(e),Y(t),Y(i),Y(d))}_canProjectWithoutEngine(){if(this.view.state.viewingMode===$e.Local){let t=this.view.renderSpatialReference?.isWebMercator?3857:this.view.renderSpatialReference?.wkid??-1;if(t!==3857&&t!==32662)return!1}return!0}get _stage(){return this.view._stage}get _collection(){return this._stage.renderView.componentObjectCollection}get elevationOffset(){return pe(this.layer.elevationInfo)}get elevationRange(){let t=this.fullExtent;return t?.zmin&&t?.zmax?new Ke(t.zmin,t.zmax):null}getElevationRange(t){return null}get fullExtent(){return this.layer.fullExtent}get objects(){return Array.from(this._lyrHandleToObjects.values()).reduce((t,e)=>t.concat(e.components),new Array)}isUpdating(){let t=this._wasm;return!(this._wasmLayerId<0||t==null)&&t.isUpdating(this._wasmLayerId)}updatingFlagChanged(){this.notifyChange("updating")}createRenderable(t){return Te(this,null,function*(){let e=t.meshData;if(e.data==null)throw new Error("meshData.data undefined");if(e.desc=JSON.parse(e.desc),e.desc==null)throw new Error("meshData.desc undefined");let d=Ee(e.desc.origin),i=new Array,o=new Map,n=new ge;n.handle=t.handle,this._lyrHandleToObjects.set(t.handle,n);let u=this.view.basemapTerrain.spatialReference,l,b;if(this.view.viewingMode==="global"){let r=de();Ne(Pe,d,r,u),l=ke(me(),r),b=Ge(me(),l)}else l=W,b=W;let f=de();Oe(f,f,d);let h=Ve(G(),f),a=null,c=G();if(e.desc.obb){let r=e.desc.obb.quaternion;a=new qe(e.desc.obb.center,e.desc.obb.halfSize,ze(r[0],r[1],r[2],r[3]))}for(let r=0;r<e.desc.prims.length;r++){let g=e.desc.prims[r];if(this._dbg(y.VerboseAPI,JSON.stringify(g)),Mt[g.ptype]==null||e.data==null){this._dbg(y.VerboseAPI,"[Unsupported Feature] Unsupported primitive mode ("+g.ptype+"). Skipping primitive.");continue}let m=e.desc?.materials&&g.materialId!=null?e.desc.materials[g.materialId]:null,C=m!=null?m.lightingModel:ue.Unlit,{positionView:w,positionAttr:_,normalsView:K,normalsAttr:Q,colorAttr:R,texCoord0Attr:B,indicesView:A}=this.getBufferViews(g,e.data.buffer,l);if(_==null||w==null||A==null)continue;let be=new wt(R!=null,B!=null?he.Default:he.None,K!=null,this._shadeNormals,this._applySSAO),Et=_.data.length/_.size,Z=(s,T)=>!s||s.data.length/s.size===Et||(this._dbg(y.Error,`${T} !== numPos. Skipping primitive.`),!1);if(!Z(B,"numTexcoord")||!Z(R,"numColors")||!Z(Q,"normals"))continue;let we=_t(be);if(a!=null?a=a.clone():(a=Je(_),Ue(c,a.center,d),a.center=c),l!==W)for(let s=0;s<w.count;s++)w.getVec(s,c),Ae(c,c,l),w.setVec(s,c);let ee=we.createBuffer(_.data.length),H=new Map([[L.POSITION,_]]);B!=null&&H.set(L.UV0,B),R!=null&&H.set(L.COLOR,R),Q!=null&&H.set(L.NORMALCOMPRESSED,Q),H.forEach((s,T)=>{s!=null&&ot(T,s,null,null,ee,0)});let Ot=new Uint32Array([0,A.typedBuffer.length]),Vt={vertices:{data:ee.buffer,count:ee.byteLength/we.stride,layoutParameters:be},positionData:{positions:w.typedBuffer,indices:A.typedBuffer},indices:A.typedBuffer,componentOffsets:Ot};n.cpuMemoryUsage+=w.count,n.cpuMemoryUsage+=A.count;let _e=this.view.renderSpatialReference,te=G(),re=[1,1,1];pt(h,_e,re,u)||this._dbg(y.Error,"Unsupported coordinate system for IM overlay"),Xe(h,_e,te,u);let j=this._collection.createObject(new bt(Ie(te[0],te[1],re[0],re[1]),new vt(h,b),a,Vt));m&&this._collection.updateMaterial(j,s=>{s.baseColor=m.baseColorFactor,s.usePBR=C===ue.Pbr,s.hasParametersFromSource=!1,s.baseColorTexture=this._getTexture(m.baseColorTex,e,o),s.usePBR&&(s.mrrFactors=[m.metallicFactor,m.roughnessFactor,0],s.emissiveFactor=m.emissiveFactor??[0,0,0],s.metallicRoughnessTexture=this._getTexture(m.metalTex,e,o),s.emissionTexture=this._getTexture(m.emissiveTex,e,o),s.occlusionTexture=this._getTexture(m.occlusionTex,e,o),s.normalTexture=this._getTexture(m.normalTex,e,o)),s.objectOpacity=0,s.alphaDiscardMode=I.Mask;let T=[];s.baseColorTexture&&T.push(s.baseColorTexture.loadPromise),s.usePBR&&s.metallicRoughnessTexture&&T.push(s.metallicRoughnessTexture.loadPromise),s.usePBR&&s.emissionTexture&&T.push(s.emissionTexture.loadPromise),s.usePBR&&s.occlusionTexture&&T.push(s.occlusionTexture.loadPromise),s.usePBR&&s.normalTexture&&T.push(s.normalTexture.loadPromise);let ve=Promise.all(T);i.push(ve),ve.then(()=>{s.alphaDiscardMode=ye[m.alphaMode],s.objectOpacity=1,n.texMemoryUsage+=s.baseColorTexture?.glTexture?.usedMemory||0,s.usePBR&&(n.texMemoryUsage+=s.metallicRoughnessTexture?.glTexture?.usedMemory||0,n.texMemoryUsage+=s.emissionTexture?.glTexture?.usedMemory||0,n.texMemoryUsage+=s.occlusionTexture?.glTexture?.usedMemory||0,n.texMemoryUsage+=s.normalTexture?.glTexture?.usedMemory||0)}),s.commonMaterialParameters.doubleSided=m.isDoubleSided,s.commonMaterialParameters.cullFace=m.faceCulling?Ct[m.faceCulling]:x.Back,this._initialCullFace.set(j,s.commonMaterialParameters.cullFace),s.commonMaterialParameters.hasSlicePlane=this.slicePlaneEnabled,s.componentParameters.castShadows=Tt.All,s.textureAlphaCutoff=m.alphaCutoff??rt,s.alphaDiscardMode=ye[m.alphaMode],s.isIntegratedMesh=!0,s.polygonOffsetEnabled=!1,s.hasOccludees=!1,s.ellipsoidMode=yt(this.view.spatialReference)}),n.components.push(j),n.vboMemoryUsage+=this._collection.getObjectGPUMemoryUsage(j)}if(yield Promise.all(i),o.forEach(r=>{n.textures.push(r)}),!this._memCache)throw new Error("no memCache");return this._memCache.put(`${n.handle}`,n),{memUsageBytes:n.usedMemory}})}freeRenderable(t){let e=this._lyrHandleToObjects.get(t);e&&(this.freeObject(e),this._lyrHandleToObjects.delete(t))}freeObject(t){this._memCache&&this._memCache.pop(`${t.handle}`),t.components.forEach(e=>{t.textures.forEach(d=>{this._stage.remove(d)}),this._collection.destroyObject(e),this._initialCullFace.delete(e)})}setRenderableVisibility(t,e,d){if(this._memCache){for(let i=0;i<d;++i){let o=t[i],n=e[i];if(!n)continue;let u=this._lyrHandleToObjects.get(o);u&&(this._visibleGeometryChanged(),u.isVisible=n,u.components.forEach(l=>{this._collection.setObjectVisibility(l,n),this._elevationProvider.objectChanged(this._collection.getComponentObb(l))}),this._memCache.pop(`${o}`))}for(let i=0;i<d;++i){let o=t[i],n=e[i];if(n)continue;let u=this._lyrHandleToObjects.get(o);u&&(this._visibleGeometryChanged(),u.isVisible=n,u.components.forEach(l=>{this._collection.setObjectVisibility(l,n),this._elevationProvider.objectChanged(this._collection.getComponentObb(l))}),this._memCache.put(`${o}`,u))}}}_getTexture(t,e,d){let i=null;if(t&&e.desc?.images&&e.data?.buffer){let o=e.desc.images[t?.imageId];if(i=d.get(o),!i&&o){let n=this._stage.renderView.renderingContext.parameters.maxMaxAnisotropy,u=!!o.mipCount||n>1,l=xt[t.wrapMode??P.None],b=o.alpha?4:3,f=new Uint8Array(e.data.buffer,o.data.byteOffset,o.data.byteCount),h=null,a=null,c=null;switch(o.format){case M.Raw:o.pixelFormat===q.R8?(h=f,b=1,a=""):o.pixelFormat===q.Rgb8?(h=f,b=3,a=""):o.pixelFormat===q.Rgba8&&(h=f,b=4,a="");break;case M.Dxt1:h=f,b=3,a=z.DDS_ENCODING;break;case M.Dxt5:h=f,b=4,a=z.DDS_ENCODING;break;case M.Basis:h=f,b=3,a=z.KTX2_ENCODING;break;case M.Png:a="image/png",c=document.createElement("img");break;case M.Jpeg:a="image/jpeg",c=document.createElement("img");break;case M.Etc2:a="image/ktx",c=document.createElement("img");break;case M.Astc:this._dbg(y.Error,"Astc texture not supported");break;case M.Pvrtc:this._dbg(y.Error,"Pvrtc texture not supported")}if(c&&a){let r=new Blob([f],{type:a});c.src=URL.createObjectURL(r),h=c}h&&a!=null&&(i=new it(h,{mipmap:u,maxAnisotropy:n,encoding:a,wrap:l,components:b,noUnpackFlip:!0,width:o.mip0Width,height:o.mip0Height}),this._stage.add(i),d.set(o,i))}}return i?new ft(this.view._stage.renderView.textures,i.id):null}getBufferViews(t,e,d){let i,o,n,u,l,b,f,h=null;for(let a=0;a<t.atrbs.length;a++){let c=t.atrbs[a],r=c.view,g=void 0,m=r.byteOffset+r.byteCount,C=r.byteCount/Pt[r.type],w=[...Array(C).keys()].map(_=>_);try{switch(c.sem){case U.Position:r.ncomp!==3||r.type!==p.F32?this._dbg(y.Error,"[Unsupported Feature] Unsupported view for Position ("+r+")"):(i=new N(e,r.byteOffset,g,m),o=new S(i.typedBuffer,w,3));break;case U.Normal:if(r.ncomp!==3||r.type!==p.F32)this._dbg(y.Error,"[Unsupported Feature] Unsupported view for Normal ("+r+")");else{let _=new N(e,r.byteOffset,g,m),K=je(_.typedBuffer,d);l=new He(K),b=new S(l.typedBuffer,w,2)}break;case U.TexCoord:r.ncomp!==2||r.type!==p.F32?this._dbg(y.Error,"[Unsupported Feature] Unsupported view for Texcoord ("+r+")"):u===void 0&&(u=new S(new De(e,r.byteOffset,g,m).typedBuffer,w,2));break;case U.Color:r.ncomp===4?(r.type===p.F32&&(h=new Le(e,r.byteOffset,g,m)),r.type===p.U8&&(h=new Fe(e,r.byteOffset,g,m)),r.type===p.U16&&(h=new Be(e,r.byteOffset,g,m))):r.ncomp===3&&(r.type===p.F32&&(h=new N(e,r.byteOffset,g,m)),r.type===p.U8&&(h=new Se(e,r.byteOffset,g,m)),r.type===p.U16&&(h=new Re(e,r.byteOffset,g,m))),h==null?this._dbg(y.VerboseAPI,"[Unsupported Feature] Unsupported view for Color ("+r+")"):n=new S(h.typedBuffer,w,r.ncomp);break;case U.FeatureIndex:break;default:this._dbg(y.VerboseAPI,"[Unsupported Feature] Unsupported semantic ("+c.sem+"). Skipping vertex attribute.")}}catch(_){this._dbg(y.VerboseAPI,"Error Creating buffer ("+_+"). Skipping vertex attribute.")}}if(t.index){let a=t.index.view,c=void 0,r=a.byteOffset+a.byteCount;switch(t.index.view.type){case p.U16:f=new ne(e,a.byteOffset,c,r);break;case p.U32:f=new le(e,a.byteOffset,c,r);break;case p.U8:default:this._dbg(y.Error,"[Unsupported Feature] index type not supported ("+a.type+").")}}if(f==null&&i!=null){let a=i.count;if(a<65535){let c=new Uint16Array(a);f=new ne(c)}else{let c=new Uint32Array(a);f=new le(c)}for(let c=0;c<a;c++)f.set(c,c)}return{positionView:i,positionAttr:o,colorAttr:n,texCoord0Attr:u,indicesView:f,normalsView:l,normalsAttr:b}}_onRemoveFromCache(t){this._wasm?.onRenderableEvicted(this,t.handle,t.usedMemory),this.freeRenderable(t.handle)}_dbg(t,e){this._dbgFlags.has(t)&&(t===y.Error?ie.getLogger(this).error(e):ie.getLogger(this).warn(e))}};V([D()],O.prototype,"_visibleGeometryChangedSchedulerHandle",void 0),V([D()],O.prototype,"layer",void 0),V([D({readOnly:!0})],O.prototype,"visibleAtCurrentScale",null),V([D()],O.prototype,"elevationOffset",null),O=V([Ce("esri.views.3d.layers.IntegratedMesh3DTilesLayerView3D")],O);var Hr=O;export{Hr as default};
