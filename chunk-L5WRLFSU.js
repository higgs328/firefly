import{c as T}from"./chunk-MLH7GHZI.js";import{a as te}from"./chunk-ULOK73M2.js";import{a as re}from"./chunk-342NGUMP.js";import{d as X,i as ee}from"./chunk-XIZXEWWA.js";import{a as K}from"./chunk-PUVSV35R.js";import{a as Q}from"./chunk-FCWOKKZM.js";import{q}from"./chunk-DA3SDKGO.js";import{a as Z}from"./chunk-BOVYXYHK.js";import{v as $}from"./chunk-EQZWYK27.js";import{a as v}from"./chunk-7F5DJLJT.js";import{b as z}from"./chunk-X2B63YVS.js";import{a as Y}from"./chunk-AML4XSEF.js";import{g as J}from"./chunk-XRGPJ3QY.js";import{f as g}from"./chunk-VTHXE323.js";var O,b;(function(e){e[e.None=0]="None",e[e.Int16=1]="Int16",e[e.Int32=2]="Int32"})(O||(O={})),function(e){e[e.Replace=0]="Replace",e[e.Outside=1]="Outside",e[e.Inside=2]="Inside",e[e.Finished=3]="Finished"}(b||(b={}));function se(){return U||(U=new Promise(e=>import("./chunk-Y473QWNT.js").then(t=>t.i).then(({default:t})=>{let s=t({locateFile:le,onRuntimeInitialized:()=>e(s)});delete s.then})).catch(e=>{throw e})),U}function le(e){return z(`esri/libs/i3s/${e}`)}var U;var F=class{constructor(t,s,o,n,c,a){this.layout=t,this.interleavedVertexData=s,this.indices=o,this.hasColors=n,this.hasModifications=c,this.positionData=a}},P=class{constructor(t,s,o,n,c,a,u){this.componentOffsets=t,this.featureIds=s,this.anchorIds=o,this.anchors=n,this.transformedGeometry=c,this.globalTrafo=a,this.obb=u}},oe=class extends te{constructor(t){super("SceneLayerWorker","process",{process:s=>[s.geometryBuffer],project:s=>[s.positions.buffer],transformNormals:s=>[s.normals.buffer]},t,{hasInitialize:!0})}setModifications(t,s,o,n){let c={context:t,modifications:he(s,o,n),isGeodetic:n.isGeographic};this.broadcast(c,"setModifications")}setLegacySchema(t,s){let o=JSON.stringify(s);return this.broadcast({context:t,jsonSchema:o},"setLegacySchema")}destroyContext(t){return this.broadcast(t,"destroyContext")}project(t,s){return this.invokeMethod("project",t,s)}transformNormals(t,s){return this.invokeMethod("transformNormals",t,s)}},r=new Y({deallocator:null}),L=Z();function he(e,t,s){r.clear();let o=1/0,n=1/0,c=-1/0,a=-1/0,u=!1;for(let p of t){let E=p.type==="clip"?b.Inside:p.type==="mask"?b.Outside:b.Replace,d=p.geometry,w=h=>h;if(d.spatialReference){if(!q(d.spatialReference,s)){J.getLogger("esri.views.3d.layers.I3SMeshWorkerHandle").warn("Can't project modification polygon into layer spatial reference, ignoring modification");continue}w=h=>(re(h,d.spatialReference,L,s),L)}else d.hasZ||(L[2]=0,w=h=>(L[0]=h[0],L[1]=h[1],L));u=u||E===b.Outside,r.push(E),r.push(d.rings.length);for(let h of d.rings){r.push(h.length);for(let x of h){let l=w(x);r.push(l[0]),r.push(l[1]),r.push(l[2]),o=Math.min(o,l[0]),n=Math.min(n,l[1]),c=Math.max(c,l[0]),a=Math.max(a,l[1])}}}e!=null&&(u?(r.push(b.Inside),r.push(2),r.push(4),r.push(o-1e-4),r.push(n-1e-4),r.push(0),r.push(c+1e-4),r.push(n-1e-4),r.push(0),r.push(c+1e-4),r.push(a+1e-4),r.push(0),r.push(o-1e-4),r.push(a+1e-4),r.push(0),r.push(4),r.push(e[0]),r.push(e[1]),r.push(0),r.push(e[2]),r.push(e[1]),r.push(0),r.push(e[2]),r.push(e[3]),r.push(0),r.push(e[0]),r.push(e[3]),r.push(0)):(r.push(b.Outside),r.push(1),r.push(4),r.push(e[0]),r.push(e[1]),r.push(0),r.push(e[2]),r.push(e[1]),r.push(0),r.push(e[2]),r.push(e[3]),r.push(0),r.push(e[0]),r.push(e[3]),r.push(0))),r.push(b.Finished);let m=new Float64Array(r.length);for(let p=0;p<r.length;++p)m[p]=r.at(p);return m}function Ue(e){return g(this,null,function*(){i=yield S();let t=[e.geometryBuffer];return{result:ne(i,e,t),transferList:t}})}function Be(e){return g(this,null,function*(){i=yield S();let t=[e.geometryBuffer],{geometryBuffer:s}=e,o=s.byteLength,n=i._malloc(o),c=new Uint8Array(i.HEAPU8.buffer,n,o);c.set(new Uint8Array(s));let a=i.dracoDecompressPointCloudData(n,c.byteLength);if(i._free(n),a.error.length>0)throw new Error(`i3s.wasm: ${a.error}`);let u=a.featureIds?.length>0?a.featureIds.slice():null,m=a.positions.slice();return u&&t.push(u.buffer),t.push(m.buffer),{result:{positions:m,featureIds:u},transferList:t}})}function De(e){return g(this,null,function*(){yield S(),de(e);let t={buffer:e.buffer};return{result:t,transferList:[t.buffer]}})}function Ce(e){return g(this,null,function*(){yield S(),me(e)})}function ke(e){return g(this,null,function*(){i=yield S(),i.setLegacySchema(e.context,e.jsonSchema)})}function He(e){return g(this,null,function*(){let{localMatrix:t,origin:s,positions:o,vertexSpace:n}=e,c=v.fromJSON(e.inSpatialReference),a=v.fromJSON(e.outSpatialReference),u,[{projectBuffer:m},{initializeProjection:p}]=yield Promise.all([import("./chunk-4NOETZU4.js"),import("./chunk-P553S7TX.js")]);yield p(c,a);let E=[0,0,0];if(!m(s,c,0,E,a,0))throw new Error("Failed to project");if(n.type==="georeferenced"&&n.origin==null){if(u=new Float64Array(o.length),!m(o,c,0,u,a,0,u.length/3))throw new Error("Failed to project")}else{let l=n.type==="georeferenced"?K.fromJSON(n):Q.fromJSON(n),{projectMeshVertexPositions:y}=yield import("./chunk-522KDBTF.js"),M=y({vertexAttributes:{position:o},transform:t?{localMatrix:t}:void 0,vertexSpace:l,spatialReference:c},a);if(!M)throw new Error("Failed to project");u=M}let d=u.length,[w,h,x]=E;for(let l=0;l<d;l+=3)u[l]-=w,u[l+1]-=h,u[l+2]-=x;return{result:{projected:u,original:o,projectedOrigin:E},transferList:[u.buffer,o.buffer]}})}function Ge(s){return g(this,arguments,function*({normalMatrix:e,normals:t}){let o=new Float32Array(t.length);return X(o,t,e),$(e)&&ee(o,o),{result:{transformed:o,original:t},transferList:[o.buffer,t.buffer]}})}function Ve(e){ie(e)}var pe,i;function me(e){if(!i)return;let t=e.modifications,s=i._malloc(8*t.length),o=new Float64Array(i.HEAPU8.buffer,s,t.length);for(let n=0;n<t.length;++n)o[n]=t[n];i.setModifications(e.context,s,t.length,e.isGeodetic),i._free(s)}function ne(e,t,s){let{context:o,globalTrafo:n,mbs:c,obbData:a,elevationOffset:u,geometryBuffer:m,geometryDescriptor:p,indexToVertexProjector:E,vertexToRenderProjector:d}=t,w=e._malloc(m.byteLength),h=33,x=e._malloc(h*Float64Array.BYTES_PER_ELEMENT),l=new Uint8Array(e.HEAPU8.buffer,w,m.byteLength);l.set(new Uint8Array(m));let y=new Float64Array(e.HEAPU8.buffer,x,h);j(y,[NaN,NaN,NaN]);let M=y.byteOffset+3*y.BYTES_PER_ELEMENT,N=new Float64Array(y.buffer,M);j(N,n),M+=16*y.BYTES_PER_ELEMENT,N=new Float64Array(y.buffer,M),j(N,c),M+=4*y.BYTES_PER_ELEMENT,a&&(N=new Float64Array(y.buffer,M),j(N,a));let B=p,ae={isDraco:!1,isLegacy:!1,color:t.layouts.some(I=>I.some(A=>A.name==="color")),normal:t.needNormals&&t.layouts.some(I=>I.some(A=>A.name==="normalCompressed")),uv0:t.layouts.some(I=>I.some(A=>A.name==="uv0")),uvRegion:t.layouts.some(I=>I.some(A=>A.name==="uvRegion")),featureIndex:B.featureIndex},f=e.process(o,!!t.obbData,w,l.byteLength,B,ae,x,u,E,d,t.normalReferenceFrame);if(e._free(x),e._free(w),f.error.length>0)throw new Error(`i3s.wasm: ${f.error}`);if(f.discarded)return null;let R=f.componentOffsets.length>0?f.componentOffsets.slice():null,_=f.featureIds.length>0?f.featureIds.slice():null,fe=f.anchorIds.length>0?Array.from(f.anchorIds):null,ce=f.anchors.length>0?Array.from(f.anchors):null,D=f.interleavedVertedData.slice().buffer,C=f.indicesType===O.Int16?new Uint16Array(f.indices.buffer,f.indices.byteOffset,f.indices.byteLength/2).slice():new Uint32Array(f.indices.buffer,f.indices.byteOffset,f.indices.byteLength/4).slice(),k=f.positions.slice(),{buffer:H,byteOffset:G,byteLength:V}=f.positionIndices,W=f.positionIndicesType===O.Int16?new Uint16Array(H,G,V/2).slice():new Uint32Array(H,G,V/4).slice(),ue=new F(t.layouts[0],D,C,f.hasColors,f.hasModifications,{data:k,indices:W});return _&&s.push(_.buffer),R&&s.push(R.buffer),s.push(D),s.push(C.buffer),s.push(k.buffer),s.push(W.buffer),new P(R,_,fe,ce,ue,n,f.obb)}function We(e){return e===0?T.Unmodified:e===1?T.PotentiallyModified:e===2?T.Culled:T.Unknown}function de(e){if(!i)return;let{context:t,buffer:s}=e,o=i._malloc(s.byteLength),n=s.byteLength/Float64Array.BYTES_PER_ELEMENT,c=new Float64Array(i.HEAPU8.buffer,o,n),a=new Float64Array(s);c.set(a),i.filterOBBs(t,o,n),a.set(c),i._free(o)}function ie(e){i&&i.destroy(e)===0&&(i=null)}function j(e,t){for(let s=0;s<t.length;++s)e[s]=t[s]}function Je(){return g(this,null,function*(){i||(yield S())})}function S(){return g(this,null,function*(){return i||(i=yield pe??=se()),i})}var Ye={transform:(e,t)=>i&&ne(i,e,t),destroy:ie};export{oe as a,he as b,Ue as c,Be as d,De as e,Ce as f,ke as g,He as h,Ge as i,Ve as j,me as k,We as l,de as m,Je as n,Ye as o};
