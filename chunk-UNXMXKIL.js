import{c as G}from"./chunk-63F5HAQH.js";import{a as k}from"./chunk-TUUOR3MF.js";import{a as L}from"./chunk-4JJPZZZC.js";import{c as N}from"./chunk-6DALCDDU.js";import{b as Q,k as U}from"./chunk-PBAMEKFE.js";import{a as K}from"./chunk-YZJDOXQC.js";import{m as q}from"./chunk-ZQIC5NFT.js";import{a as P}from"./chunk-PEW2PLAN.js";import{a as W}from"./chunk-7F5DJLJT.js";import{b as _,o as M}from"./chunk-AUAZP44J.js";import{A as C}from"./chunk-76ATOSLU.js";import{a as R,i as F}from"./chunk-TG45K3WR.js";import{b as V}from"./chunk-ACP3S2CH.js";import{a as p}from"./chunk-QGVBCWUY.js";import{h as n,j as O,k as J}from"./chunk-MYO4NP2N.js";import{e as u}from"./chunk-NFIPKH6V.js";import{l as w}from"./chunk-5QEXLALV.js";import{c as H}from"./chunk-P6QFA5MM.js";import{a as D}from"./chunk-LI2SX4T6.js";import{p as A}from"./chunk-4PTIEWMT.js";import{b as B}from"./chunk-YOFFGXOB.js";import{g as j}from"./chunk-XRGPJ3QY.js";import{a as I,b as T,f as v}from"./chunk-VTHXE323.js";var fe=d=>{let a=class extends d{constructor(){super(...arguments),this.capabilities=void 0,this.copyright=null,this.fullExtent=null,this.legendEnabled=!0,this.spatialReference=null,this.version=void 0,this._allLayersAndTablesMap=null}readCapabilities(s,r){let e=r.capabilities&&r.capabilities.split(",").map(Y=>Y.toLowerCase().trim());if(!e)return{operations:{supportsExportMap:!1,supportsExportTiles:!1,supportsIdentify:!1,supportsQuery:!1,supportsTileMap:!1},exportMap:null,exportTiles:null};let t=this.type,i=t!=="tile"&&!!r.supportsDynamicLayers,o=e.includes("query"),y=e.includes("map"),h=!!r.exportTilesAllowed,m=e.includes("tilemap"),f=e.includes("data"),b=t!=="tile"&&(!r.tileInfo||i),E=t!=="tile"&&(!r.tileInfo||i),l=t!=="tile",c=t!=="tile"&&i&&r.currentVersion>=11.1,S=r.cimVersion?K.parse(r.cimVersion):null,g=S?.greaterEqual(1,4)??!1,X=S?.greaterEqual(2,0)??!1;return{operations:{supportsExportMap:y,supportsExportTiles:h,supportsIdentify:o,supportsQuery:f,supportsTileMap:m},exportMap:y?{supportsArcadeExpressionForLabeling:g,supportsCIMSymbols:X,supportsDynamicLayers:i,supportsSublayerOrderBy:c,supportsSublayerDefinitionExpression:E,supportsSublayerVisibility:b,supportsSublayersChanges:l}:null,exportTiles:h?{maxExportTilesCount:+r.maxExportTilesCount}:null}}readVersion(s,r){let e=r.currentVersion;return e||(e=r.hasOwnProperty("capabilities")||r.hasOwnProperty("tables")?10:r.hasOwnProperty("supportedImageFormatTypes")?9.31:9.3),e}fetchRelatedService(s){return v(this,null,function*(){let r=this.portalItem;if(!r||!N(r))return null;this._relatedFeatureServicePromise||(this._relatedFeatureServicePromise=r.fetchRelatedItems({relationshipType:"Service2Service",direction:"reverse"},s).then(t=>t.find(i=>i.type==="Feature Service")??null,()=>null));let e=yield this._relatedFeatureServicePromise;return A(s),e?{itemId:e.id,url:e.url}:null})}fetchSublayerInfo(s,r){return v(this,null,function*(){let{source:e}=s;if(this?.portalItem&&this.type==="tile"&&e?.type==="map-layer"&&N(this.portalItem)&&s.originIdOf("url")<n.SERVICE){let o=yield this.fetchRelatedService(r);o&&(s.url=C(o.url,e.mapLayerId.toString()),s.layerItemId=o.itemId)}let{url:t}=s,i;if(e.type==="data-layer")i=(yield M(t,I({responseType:"json",query:T(I({f:"json"},this.customParameters),{token:this.apiKey})},r))).data;else if(t&&s.originIdOf("url")>n.SERVICE)try{let o=yield this._fetchAllLayersAndTablesFromService(t),y=_(t)?.sublayer??e.mapLayerId;i=o.get(y)}catch{}else{let o=s.id;e?.type==="map-layer"&&(o=e.mapLayerId);try{i=(yield this.fetchAllLayersAndTables(r)).get(o)}catch{}}return i})}fetchAllLayersAndTables(s){return v(this,null,function*(){return this._fetchAllLayersAndTablesFromService(this.parsedUrl?.path,s)})}_fetchAllLayersAndTablesFromService(s,r){return v(this,null,function*(){yield this.load(r),this._allLayersAndTablesMap||=new Map;let e=_(s),t=H(this._allLayersAndTablesMap,e?.url.path,()=>M(C(e?.url.path,"/layers"),{responseType:"json",query:T(I({f:"json"},this.customParameters),{token:this.apiKey})}).then(o=>{let y=new Map,{layers:h,tables:m}=o.data,f=[...h??[],...m??[]];for(let b of f)y.set(b.id,b);return{result:y}},o=>({error:o}))),i=yield t;if(A(r),"result"in i)return i.result;throw i.error})}};return p([u({readOnly:!0})],a.prototype,"capabilities",void 0),p([P("service","capabilities",["capabilities","exportTilesAllowed","maxExportTilesCount","supportsDynamicLayers","tileInfo"])],a.prototype,"readCapabilities",null),p([u({json:{read:{source:"copyrightText"}}})],a.prototype,"copyright",void 0),p([u({type:q})],a.prototype,"fullExtent",void 0),p([u(U)],a.prototype,"id",void 0),p([u({type:Boolean,json:{origins:{service:{read:{enabled:!1}}},read:{source:"showLegend"},write:{target:"showLegend"}}})],a.prototype,"legendEnabled",void 0),p([u(Q)],a.prototype,"popupEnabled",void 0),p([u({type:W})],a.prototype,"spatialReference",void 0),p([u({readOnly:!0})],a.prototype,"version",void 0),p([P("service","version",["currentVersion","capabilities","tables","supportedImageFormatTypes"])],a.prototype,"readVersion",null),a=p([w("esri.layers.mixins.ArcGISMapService")],a),a};function Z(d,a){let s=[],r={};return d&&d.forEach(e=>{let t=new L;if(t.read(e,a),r[t.id]=t,e.parentLayerId!=null&&e.parentLayerId!==-1){let i=r[e.parentLayerId];i.sublayers||(i.sublayers=[]),i.sublayers.unshift(t)}else s.unshift(t)}),s}var x=V.ofType(L);function z(d,a){d&&d.forEach(s=>{a(s),s.sublayers&&s.sublayers.length&&z(s.sublayers,a)})}var Pe=d=>{let a=class extends d{constructor(...s){super(...s),this.allSublayers=new k({getCollections:()=>[this.sublayers],getChildrenFunction:r=>r.sublayers}),this.sublayersSourceJSON={[n.SERVICE]:{},[n.PORTAL_ITEM]:{},[n.WEB_SCENE]:{},[n.WEB_MAP]:{},[n.LINK_CHART]:{}},this.subtables=null,this.addHandles([R(()=>this.sublayers,(r,e)=>this._handleSublayersChange(r,e),F),R(()=>this.subtables,(r,e)=>this._handleSublayersChange(r,e),F)])}destroy(){this.allSublayers.destroy()}readSublayers(s,r){if(!r||!s)return;let{sublayersSourceJSON:e}=this,t=O(r.origin);if(t<n.SERVICE||(e[t]={context:r,visibleLayers:s.visibleLayers||e[t].visibleLayers,layers:s.layers||e[t].layers},t>n.SERVICE))return;this._set("serviceSublayers",this.createSublayersForOrigin("service").sublayers);let{sublayers:i,origin:o}=this.createSublayersForOrigin("web-document"),y=D(this);y.setDefaultOrigin(o),this._set("sublayers",new x(i)),y.setDefaultOrigin("user")}findSublayerById(s){return this.allSublayers.find(r=>r.id===s)}createServiceSublayers(){return this.createSublayersForOrigin("service").sublayers}createSublayersForOrigin(s){let r=O(s==="web-document"?"web-map":s),e=n.SERVICE,t=this.sublayersSourceJSON[n.SERVICE].layers,i=this.sublayersSourceJSON[n.SERVICE].context,o=null,y=[n.PORTAL_ITEM,n.WEB_SCENE,n.WEB_MAP].filter(l=>l<=r);for(let l of y){let c=this.sublayersSourceJSON[l];G(c.layers)&&(e=l,t=c.layers,i=c.context,c.visibleLayers&&(o={visibleLayers:c.visibleLayers,context:c.context}))}let h=[n.PORTAL_ITEM,n.WEB_SCENE,n.WEB_MAP].filter(l=>l>e&&l<=r),m=null;for(let l of h){let{layers:c,visibleLayers:S,context:g}=this.sublayersSourceJSON[l];c&&(m={layers:c,context:g}),S&&(o={visibleLayers:S,context:g})}let f=Z(t,i),b=new Map,E=new Set;if(m)for(let l of m.layers)b.set(l.id,l);if(o?.visibleLayers)for(let l of o.visibleLayers)E.add(l);return z(f,l=>{m&&l.read(b.get(l.id),m.context),o&&l.read({defaultVisibility:E.has(l.id)},o.context)}),{origin:J(e),sublayers:new x({items:f})}}read(s,r){super.read(s,r),this.readSublayers(s,r)}_handleSublayersChange(s,r){r&&(r.forEach(e=>{e.parent=null,e.layer=null}),this.removeHandles("sublayers-owner")),s&&(s.forEach(e=>{e.parent=this,e.layer=this}),this.addHandles([s.on("after-add",({item:e})=>{e.parent=this,e.layer=this}),s.on("after-remove",({item:e})=>{e.parent=null,e.layer=null})],"sublayers-owner"),this.type==="tile"&&this.addHandles(s.on("before-changes",e=>{j.getLogger("esri.layers.TileLayer").error(new B("tilelayer:sublayers-non-modifiable","ISublayer can't be added, moved, or removed from the layer's sublayers",{layer:this})),e.preventDefault()}),"sublayers-owner"))}};return p([u({readOnly:!0})],a.prototype,"allSublayers",void 0),p([u({readOnly:!0,type:V.ofType(L)})],a.prototype,"serviceSublayers",void 0),p([u({value:null,type:x,json:{read:!1,write:{allowNull:!0,ignoreOrigin:!0}}})],a.prototype,"sublayers",void 0),p([u({readOnly:!0})],a.prototype,"sublayersSourceJSON",void 0),p([u({type:x,json:{read:{source:"tables"}}})],a.prototype,"subtables",void 0),a=p([w("esri.layers.mixins.SublayersOwner")],a),a};export{fe as a,Pe as b};
