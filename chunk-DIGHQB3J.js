import{a as L}from"./chunk-6OM462YN.js";import{a as f}from"./chunk-6KHHUDVU.js";import{a as G}from"./chunk-RUR3FBR3.js";import{C as B,E as W}from"./chunk-WCHIR27X.js";import{a as D}from"./chunk-BBM5BVWD.js";import{a as V}from"./chunk-NTU4GX2J.js";import{a as O}from"./chunk-7LVUNMSI.js";import{c as j}from"./chunk-PTFN55DA.js";import{a as M}from"./chunk-6LW5LY2X.js";import{a as C,c as g}from"./chunk-QCZ3ZIGQ.js";import{a as T,i as F,j as x}from"./chunk-XR5FT7TQ.js";import{b as A,f as P,q}from"./chunk-DA3SDKGO.js";import{e as k}from"./chunk-IHATPE6U.js";import{a as w}from"./chunk-IR6XCBC4.js";import{d as v}from"./chunk-NJWTSROP.js";import{a as b}from"./chunk-G4DZJMGT.js";import{a as _,b as E,c as S}from"./chunk-TG45K3WR.js";import{b as y}from"./chunk-ACP3S2CH.js";import{a as l}from"./chunk-QGVBCWUY.js";import{e as c}from"./chunk-NFIPKH6V.js";import{l as I}from"./chunk-5QEXLALV.js";import{p as d}from"./chunk-4PTIEWMT.js";import{b as m}from"./chunk-YOFFGXOB.js";import{y as R}from"./chunk-QBWJMFH5.js";import{f as h}from"./chunk-VTHXE323.js";function U(i){return h(this,arguments,function*(e,t={}){let{basemap:a,view:r}=e;yield a.load(t),K(a),yield Q(a,r,t),d(t)})}function z(i){return h(this,arguments,function*(e,t={}){let{basemap:a,view:r}=e;d(t);let s=a.baseLayers.find(u=>u.type==="unknown")?.loadError;if(s!=null)throw s;if(!r||"spatialReferenceLocked"in r&&!r.spatialReferenceLocked||(yield a.load(t),d(t),a.baseLayers.length===0))return;let o=a.baseLayers.at(0);if(!x(o))return;if(a.spatialReference){if(r.spatialReference.equals(a.spatialReference))return;$()}yield o.load(t),d(t);let n=(("supportedSpatialReferences"in o?o.supportedSpatialReferences:null)||["tileInfo"in o?o.tileInfo?.spatialReference:null]).filter(R);n.length!==0&&n.every(u=>!r.spatialReference.equals(u))&&$()})}function $(){throw new m("basemap-compatibility:incompatible-spatial-reference","Basemap spatial reference is not compatible with the view")}function K(e){if(e.baseLayers.length===0&&e.referenceLayers.length===0)return;let t=e.baseLayers.concat(e.referenceLayers).toArray().filter(i=>!T(i)).map(i=>N(i));if(t.length)throw t[0]}function N(e){return new m("basemap-compatibility:unsupported-basemap-layer-type","Unsupported basemap layer type ${operationalLayerType}",{layer:e,operationalLayerType:e.operationalLayerType||"unknown"})}function Q(e,t,i){return h(this,null,function*(){if(e.baseLayers.length===0)return;let a=e.baseLayers.at(0);if(F(a)){try{yield a.load(i)}catch(r){let s="basemap-compatibility:unknown-error",o="Unknown basemap compatibility error",{name:n=s,message:u=o,details:J}=r;throw new m(n,u,J)}X(a,t)}})}function X(e,t){let i=t.state.viewingMode;if(!i)return;let a,r;if(e?.type==="wmts"){let n=W(e,t.spatialReference,i);if(n.tileInfo==null)throw new m("basemapgalleryitem:tiling-scheme-incompatible","Basemap tiling scheme is incompatible with the view");a=n.tileInfo,r=n.fullExtent}else a=e.tileInfo,r=e.fullExtent;if(a==null)return;if(!V(a.spatialReference,i))throw new m(`basemapgalleryitem:spatial-reference-unsupported-${g(i)}`,`Basemap spatial reference is unsupported in ${g(i)} mode`);let s=e?.type==="vector-tile"?a.getCompatibleForVTL(256):null;if(i===C.Global){let n=B(a,r,null,i);if(n&&e?.type==="vector-tile"&&r!=null&&s&&!B(s,r,null,i)&&(n=null),n){let u=a.spatialReference.isWebMercator?"web-mercator":"wgs84";throw new m(`basemapgalleryitem:tiling-scheme-unsupported-${u}-global`,"Basemap tiling scheme is unsupported in global mode",{error:n})}}else if(D.checkUnsupported(a))throw new m("basemapgalleryitem:tiling-scheme-unsupported-local","Basemap tiling scheme is unsupported in local mode");let o=t.basemapTerrain?.tilingScheme;if(o&&!o.compatibleWith(a)&&(e?.type!=="vector-tile"||!s||!o.compatibleWith(s)))throw new m("basemapgalleryitem:tiling-scheme-incompatible","Basemap tiling scheme is incompatible with the view")}var H=y.ofType(L);function Y(e){return e&&e.declaredClass==="esri.portal.Portal"}function Z(e){return e&&!(e instanceof f)&&(!!e.portal||!!e.query)}function ee(e){return e&&"basemaps"in e&&"state"in e&&"refresh"in e}var p=class extends w{constructor(e){super(e),this._loadingProjectionEngine=!1,this.items=new H,this.source=new f,this.view=null}initialize(){let e=()=>this._recreateItems();this.addHandles([_(()=>this.state==="ready"?this.compatibilityFunction:null,()=>this._updateItems()),S(()=>this.source?.basemaps,"change",e,{onListenerAdd:e}),E(()=>this.view,()=>{this.source instanceof f&&(this.source.viewType=this.view?.type)},{once:!0})])}destroy(){let e=this.source.basemaps.find(t=>t===this.activeBasemap);e&&this.source.basemaps.remove(e),this.source?.destroy()}get activeBasemap(){return this.view?.map?.basemap??null}set activeBasemap(e){let t=this.view;if(!t?.map)return;if(!e||!t.ready)return t.map.basemap=e,void this._clearOverride("activeBasemap");let i=e.spatialReference||this.items?.find(a=>this.basemapEquals(e,a.basemap))?.spatialReference;if(i&&"spatialReferenceLocked"in t&&!t.spatialReferenceLocked){let a=t.spatialReference;if(i!=null&&!v(a,i)&&!q(t.spatialReference,i)&&!A())return this._override("activeBasemap",e),this._loadingProjectionEngine=!0,void P().then(()=>{this._get("activeBasemap")===e&&(t.map.basemap=e,t.spatialReference=i,this._clearOverride("activeBasemap"))},()=>{}).then(()=>{this._loadingProjectionEngine=!1});t.map.basemap=e,this._clearOverride("activeBasemap"),i==null||v(t.spatialReference,i)||(t.spatialReference=i)}else t.map.basemap=e,this._clearOverride("activeBasemap")}castActiveBasemap(e){return j(e)}get activeBasemapIndex(){let{state:e,activeBasemap:t}=this;return e!=="ready"?-1:this._findBasemapIndex(t)}get compatibilityFunction(){return this.view?.type==="3d"?U:z}set compatibilityFunction(e){this._overrideIfSome("compatibilityFunction",e)}castSource(e){return Array.isArray(e)||y.isCollection(e)?new G({basemaps:Array.isArray(e)?new y(e):e}):Y(e)?new f({portal:e}):Z(e)?new f(e):ee(e)?e:null}get state(){return this.view?.ready&&this.source?O(this.view)&&!this.view.inGeographicLayout?"unsupported":this._loadingProjectionEngine?"loading":"ready":"disabled"}basemapEquals(e,t){return k(e,t)}refresh(){this._recreateItems()}load(){return this.loadSource()}loadSource(e){return this.addResolvingPromise(w.isLoadable(this.source)?this.source.load(e):null),Promise.resolve(this)}_findBasemapIndex(e){let{items:t}=this,i=t.findIndex(a=>a.basemap===e);return i===-1?t.findIndex(a=>this.basemapEquals(a.basemap,e)):i}_recreateItems(){let e=this.source?.basemaps??[],{view:t,compatibilityFunction:i}=this,a=new Map(this.items.map(s=>[s.basemap,s])),r=e.map(s=>{let o=a.get(s);return o?(a.delete(s),o):new L({basemap:s,compatibilityFunction:i,view:t})});this.items.removeAll(),this.items.addMany(r),a.forEach(s=>s.destroy())}_updateItems(){for(let e of this.items)e.compatibilityFunction=this.compatibilityFunction,e.view=this.view}};l([c()],p.prototype,"_loadingProjectionEngine",void 0),l([c({type:M})],p.prototype,"activeBasemap",null),l([b("activeBasemap")],p.prototype,"castActiveBasemap",null),l([c({readOnly:!0})],p.prototype,"activeBasemapIndex",null),l([c()],p.prototype,"compatibilityFunction",null),l([c({readOnly:!0,type:H})],p.prototype,"items",void 0),l([c()],p.prototype,"source",void 0),l([b("source")],p.prototype,"castSource",null),l([c({readOnly:!0})],p.prototype,"state",null),l([c()],p.prototype,"view",void 0),p=l([I("esri.widgets.BasemapGallery.BasemapGalleryViewModel")],p);var xe=p;export{xe as a};
