import{a as Te,b as $e,c as Y}from"./chunk-ZTME5DRX.js";import{a as Se}from"./chunk-IQYLT45D.js";import{b as Ce}from"./chunk-NOFBQO2U.js";import"./chunk-B5UEI6EC.js";import"./chunk-ROCEAXU5.js";import{d as be}from"./chunk-4QUJ4QFY.js";import"./chunk-IJGCZDYE.js";import{a as xe}from"./chunk-6Y5UZPT2.js";import"./chunk-PREF6ZRE.js";import"./chunk-CR343OBM.js";import{l as Ie}from"./chunk-AFJIRAY7.js";import"./chunk-5UDQHKRH.js";import"./chunk-K4Z2LVRX.js";import"./chunk-PSJXKSSD.js";import"./chunk-UWK3LZKM.js";import"./chunk-ZVQZT2S3.js";import"./chunk-5AFOYCWC.js";import"./chunk-Z3MWEX65.js";import"./chunk-YB6RTOHR.js";import"./chunk-QETPWGTG.js";import"./chunk-3YHPJJNR.js";import"./chunk-B3QGX4VL.js";import{a as we}from"./chunk-E424TX4V.js";import"./chunk-WWB2PP2I.js";import"./chunk-RXMVWABU.js";import"./chunk-GG4LHW7G.js";import"./chunk-HOMCUBFD.js";import"./chunk-WH5YYKLM.js";import"./chunk-RPYYOCCF.js";import"./chunk-FEP4LYOS.js";import"./chunk-HD5Z6MAY.js";import{k as he}from"./chunk-AULXBTED.js";import"./chunk-4SRR6EC6.js";import"./chunk-LMCM3VZM.js";import"./chunk-BR4IP6B4.js";import{r as me}from"./chunk-Y3KWVZKS.js";import"./chunk-ZWHAEUE3.js";import"./chunk-E56W4PK4.js";import"./chunk-2CC7WNFC.js";import"./chunk-G7KCDLNH.js";import"./chunk-KC3MEJHL.js";import"./chunk-JP3UDQL6.js";import"./chunk-3X6CYJC6.js";import{a as H}from"./chunk-WDTJILD4.js";import"./chunk-NIRJWS2D.js";import"./chunk-H3ZWZZ2B.js";import{b as ue}from"./chunk-H4IF7PQO.js";import{a as pe}from"./chunk-QKVTMI24.js";import{a as ve}from"./chunk-GGYZRKBV.js";import{a as de}from"./chunk-37PSR6DC.js";import{a as fe}from"./chunk-P4JHTV62.js";import{a as re}from"./chunk-H25DKJGS.js";import"./chunk-6DALCDDU.js";import"./chunk-CHCKIOZR.js";import"./chunk-TUF2Y2FX.js";import{b as ge,e as ye}from"./chunk-PBAMEKFE.js";import"./chunk-XIZ7IH6M.js";import"./chunk-JD66UCS7.js";import"./chunk-FU7RO3AR.js";import"./chunk-4YRY3D3A.js";import"./chunk-ZZ5UYT7M.js";import"./chunk-U4XVPHQU.js";import"./chunk-GAVFKWSK.js";import"./chunk-DK4DGLAO.js";import"./chunk-ZM24RY22.js";import"./chunk-7Y6S2GNA.js";import"./chunk-VOB6IBIW.js";import"./chunk-63B3IOWG.js";import"./chunk-PE276TWH.js";import"./chunk-BMZ3PE5Y.js";import"./chunk-EHG7JRYJ.js";import"./chunk-FNY6LFKI.js";import"./chunk-5ODXFRPI.js";import"./chunk-E5QCV5LT.js";import"./chunk-QS3EYJPF.js";import"./chunk-HJJZ2AXH.js";import"./chunk-TPNSUEHH.js";import"./chunk-SMVNQSZ4.js";import"./chunk-Z2QGLRDB.js";import"./chunk-7IDFDPA3.js";import"./chunk-VL2YL74P.js";import"./chunk-P2AJD2R2.js";import"./chunk-UMJIJLDA.js";import"./chunk-E5NFS3KN.js";import"./chunk-HQHD6BMN.js";import"./chunk-AIKKGGPG.js";import"./chunk-RDGG4TVD.js";import"./chunk-3IQFPOUU.js";import"./chunk-I4CY6X6S.js";import"./chunk-VQ4QGNRX.js";import"./chunk-4KXJ537H.js";import"./chunk-JIRULGDT.js";import"./chunk-QJGOWIJD.js";import"./chunk-QML26MQC.js";import"./chunk-RNZY2XUD.js";import"./chunk-JXPUHKCT.js";import"./chunk-XR5FT7TQ.js";import"./chunk-4YTM754S.js";import"./chunk-LAX5536Z.js";import"./chunk-N3HRYLNW.js";import"./chunk-4DBMALZW.js";import"./chunk-CVWWHM2V.js";import"./chunk-6OQYVEQJ.js";import"./chunk-YOXOWGT6.js";import"./chunk-EFZOSMYP.js";import"./chunk-WI7F4ZKJ.js";import"./chunk-MJ7M24NH.js";import"./chunk-GJH4QFRX.js";import"./chunk-T63F7663.js";import"./chunk-O4V2VBSK.js";import"./chunk-5TKRKB5E.js";import"./chunk-XAGMDNNR.js";import"./chunk-OP2TLIUN.js";import"./chunk-T2THIR6K.js";import"./chunk-LORHDXEB.js";import"./chunk-BBBPJI4H.js";import"./chunk-45BTW5EG.js";import"./chunk-TPFBHGDM.js";import"./chunk-73NLRHJD.js";import"./chunk-PNFEUBDF.js";import"./chunk-6RCCEJDL.js";import"./chunk-PQ2TNDUX.js";import"./chunk-6X6MKRQ3.js";import"./chunk-FQFHMHYU.js";import"./chunk-SZMEI3WL.js";import"./chunk-KKVGD67U.js";import"./chunk-MYOJWRDU.js";import"./chunk-L7UKJKHG.js";import"./chunk-V2IENAEU.js";import"./chunk-QAGQFNF2.js";import"./chunk-SY7JS2VW.js";import"./chunk-WK57SDN6.js";import"./chunk-AG4V3ZUO.js";import"./chunk-YWLMJ26A.js";import"./chunk-QAWNU3UJ.js";import"./chunk-HRQT4R6X.js";import"./chunk-44BHLWQ4.js";import"./chunk-5BPM64SU.js";import"./chunk-PMVHHMQJ.js";import"./chunk-NAFOM5UA.js";import{a as ce}from"./chunk-DO7UF2F2.js";import"./chunk-ZTR6OS44.js";import"./chunk-VRTKAD2J.js";import"./chunk-DBLKLHK2.js";import"./chunk-UTE3ASAZ.js";import"./chunk-2AFEAPEX.js";import"./chunk-GNGXUEWV.js";import"./chunk-QBI5NDCA.js";import"./chunk-NOHW2DKR.js";import"./chunk-HVJAAM3A.js";import"./chunk-ACPEJEHK.js";import"./chunk-I7B3LWNP.js";import"./chunk-YP2E5N4E.js";import"./chunk-QLMNLSCT.js";import"./chunk-P55G5ATK.js";import"./chunk-JT3K52KQ.js";import"./chunk-SPLEGG4R.js";import"./chunk-Y4TJDUGP.js";import"./chunk-6PAFOJ4W.js";import"./chunk-74SDGE57.js";import"./chunk-FRXWHX3T.js";import"./chunk-DTDQ5X42.js";import"./chunk-RX2HFR4X.js";import"./chunk-AZW7YPTQ.js";import"./chunk-NJLJX4X6.js";import"./chunk-DZHFTD24.js";import"./chunk-K57Z4J34.js";import"./chunk-VWG3KVOU.js";import"./chunk-JOEUVLAN.js";import"./chunk-JZQDGIDQ.js";import"./chunk-CZ6CGC7I.js";import"./chunk-7B6U3N62.js";import"./chunk-46WDO5LS.js";import"./chunk-G5EYK5KM.js";import"./chunk-YJKJQU3F.js";import"./chunk-OK4K3OQT.js";import"./chunk-BPWNCOXC.js";import"./chunk-VNS4CQ27.js";import"./chunk-AVMO6LCR.js";import"./chunk-TEGPMVWT.js";import"./chunk-CLQRQC3Y.js";import"./chunk-KSNU73LO.js";import"./chunk-FACEVGRE.js";import"./chunk-5XTCPT52.js";import"./chunk-TC77DYTW.js";import"./chunk-F2BQ2GD6.js";import"./chunk-R3XLNYYB.js";import"./chunk-BMYVPMAK.js";import"./chunk-6F25LG6O.js";import"./chunk-6KRFVLII.js";import"./chunk-GJ2QRXGN.js";import"./chunk-NX5B6XBR.js";import"./chunk-2JABY6DU.js";import"./chunk-MPRKSQLC.js";import"./chunk-57TARQ4F.js";import"./chunk-6RBQSBA2.js";import{a as le}from"./chunk-3JGYBNJA.js";import"./chunk-DA3SDKGO.js";import"./chunk-ZOEPYNM4.js";import"./chunk-57VFBGF3.js";import"./chunk-GWBRHLNH.js";import"./chunk-BJH4F4SM.js";import"./chunk-Z3RBZHAK.js";import"./chunk-E6C7G5SC.js";import"./chunk-PTZYZULI.js";import"./chunk-NMLYCCKN.js";import"./chunk-ZC6EBRE4.js";import"./chunk-KALOJIUA.js";import"./chunk-KMMTNF7G.js";import{a as Q}from"./chunk-E7AX56GD.js";import"./chunk-IDVLLREH.js";import"./chunk-DWLSVYOY.js";import"./chunk-PQGCNP5H.js";import"./chunk-UASS7NJI.js";import"./chunk-WZRAC35O.js";import"./chunk-KUYAWYSS.js";import"./chunk-MIS6QMFE.js";import"./chunk-MDZTV2VL.js";import"./chunk-RNC4P66O.js";import"./chunk-7LHOQXZT.js";import"./chunk-BCREO4Q5.js";import"./chunk-U4QEPZJ3.js";import"./chunk-KJUZWSCL.js";import"./chunk-3WO6D7MU.js";import"./chunk-BUZ3SPLE.js";import{b as se}from"./chunk-2TX472ZB.js";import{c as oe}from"./chunk-7QNKS2X6.js";import{a as ae}from"./chunk-VCCMJ6BV.js";import{a as Ae}from"./chunk-QK56OQGR.js";import"./chunk-FXCL7YYQ.js";import"./chunk-QKO56XO6.js";import"./chunk-JRGT3GTH.js";import"./chunk-K75TK42V.js";import"./chunk-CELWVZPW.js";import"./chunk-VV5G7VY5.js";import"./chunk-OLOKUDVI.js";import"./chunk-DYTVXYAV.js";import"./chunk-ZTOZWLEE.js";import"./chunk-RJWOVI3M.js";import"./chunk-RSDQHAJX.js";import"./chunk-BOVYXYHK.js";import"./chunk-DZFUQCB6.js";import"./chunk-V2JYXY4D.js";import"./chunk-KVM6SHDX.js";import"./chunk-PIHANKUA.js";import"./chunk-POX73EYJ.js";import"./chunk-NKUXRYJG.js";import"./chunk-HX2VGIR2.js";import"./chunk-ERDKAICI.js";import"./chunk-EQZWYK27.js";import"./chunk-JLPLCY2B.js";import"./chunk-2GJBUR2F.js";import"./chunk-DKGGDYJI.js";import"./chunk-5LA3PVK5.js";import"./chunk-IR6XCBC4.js";import"./chunk-C6JPAW54.js";import"./chunk-WD3OPXCN.js";import"./chunk-FA3WGIU4.js";import"./chunk-WWVPA6PE.js";import"./chunk-YPMM52MU.js";import"./chunk-BBR7CJCO.js";import"./chunk-VU5W7W6Y.js";import{m as ne}from"./chunk-ZQIC5NFT.js";import"./chunk-VIEK2X23.js";import"./chunk-XKIFGPJO.js";import"./chunk-PEW2PLAN.js";import"./chunk-Q6Y4JG7Q.js";import"./chunk-7F5DJLJT.js";import"./chunk-CX5IFQZJ.js";import"./chunk-NJWTSROP.js";import"./chunk-D3R25AF2.js";import"./chunk-ARRCN5K3.js";import"./chunk-LXK2YRMG.js";import"./chunk-O3EGNJTY.js";import"./chunk-GHKL3NOH.js";import"./chunk-WGAOVKGR.js";import"./chunk-4N4D2YQX.js";import"./chunk-G4DZJMGT.js";import"./chunk-WTB3O6DJ.js";import"./chunk-7P44K2YD.js";import"./chunk-32OAXCA4.js";import"./chunk-UST6HCE7.js";import"./chunk-K5T5FD5C.js";import"./chunk-MVHHPJM7.js";import"./chunk-VDO6JJ3Y.js";import"./chunk-WFKZLI6F.js";import"./chunk-X2B63YVS.js";import"./chunk-BAEF3CT6.js";import"./chunk-AUAZP44J.js";import"./chunk-PVDFCTA4.js";import"./chunk-KNVXE32P.js";import"./chunk-76ATOSLU.js";import"./chunk-CCJU4DSH.js";import{a as ie}from"./chunk-TG45K3WR.js";import"./chunk-RAI4DTMT.js";import"./chunk-ACP3S2CH.js";import"./chunk-HVAXZ2NA.js";import"./chunk-T7DXJKX7.js";import"./chunk-TYYVNQUR.js";import{a as v}from"./chunk-QGVBCWUY.js";import"./chunk-MYO4NP2N.js";import{e as w}from"./chunk-NFIPKH6V.js";import"./chunk-JPU2PQZC.js";import{l as X}from"./chunk-5QEXLALV.js";import"./chunk-P6QFA5MM.js";import"./chunk-DGTD7Y73.js";import"./chunk-LI2SX4T6.js";import"./chunk-BWO7LS2H.js";import"./chunk-HEVQSRJ2.js";import"./chunk-OVHPPCBL.js";import"./chunk-SNFOAZZQ.js";import"./chunk-AML4XSEF.js";import{K as te,s as ee}from"./chunk-4PTIEWMT.js";import"./chunk-TG2UTNEO.js";import{b as E}from"./chunk-YOFFGXOB.js";import{g as J}from"./chunk-XRGPJ3QY.js";import"./chunk-6MRUJ2UW.js";import"./chunk-2LI2GKBQ.js";import"./chunk-QBWJMFH5.js";import{a as B,b as z,f as R}from"./chunk-VTHXE323.js";function Pe(e){let i=Re(e);return i?{isMultipart:!0,data:i.boundary?_e(e.data,i,0):null}:{isMultipart:!1,data:null}}function _e(e,i,a=0){let l="--"+i.boundary,t=[];for(let p=0;p<l.length;p++)t.push(l.charCodeAt(p));let o=[],s=`
--`+i.boundary+"--";for(let p=0;p<s.length;p++)o.push(s.charCodeAt(p));let f=[10],h=[13,10],r=[],u=t.length,g=new Uint8Array(e,a),n=g.length-u,d=0,c=0;for(let p=0;p<n;p++){for(c=0;c<u&&g[p+c]===t[c];c++);if(c!==u)continue;let A=!1;if(d){let I=Le(g.subarray(d,p),i);r.push(I),A=!!I.isValidImage}if(p+=u-1,g[p+1]===f[0]?p+=1:g[p+1]===h[0]&&g[p+2]===h[1]&&(p+=2),d=p+1,A)break}let y=o.length;for(let p=g.length-y-10;p<g.length-y;p++){for(c=0;c<y&&g[p+c]===o[c];c++);if(c===y){r.push(Le(g.subarray(d,p),i));break}}return r}function Re(e){let i=e.getHeader?.("Content-Type")?.split(";");if(!i||!(i[0].trim()??"").startsWith("multipart/"))return null;let a={boundary:"",start:"",type:""};for(let l=1;l<i.length;l++){let t=i[l].indexOf("=");if(t>0){let o=i[l].slice(0,t).trim(),s=i[l].slice(t+1).trim();a[o]=s.startsWith('"')?s.slice(1,-1):s}}return a}function Le(e,i){let a=String.fromCharCode.apply(null,e.subarray(0,Math.min(300,e.length))).split(`
`),l=Math.min(a.length,7),t={contentDisposition:"inline"},o=0;for(let s=0;s<l;s++)if(a[s].length<4)o=o+a[s].length+1;else if(a[s].slice(0,7).toLowerCase()==="content"){o=o+a[s].length+1;let f=a[s].indexOf(":");if(f===-1)continue;let h=a[s].slice(0,f).trim(),r=a[s].slice(f+1).trim();switch(h.toLowerCase()){case"content-type":t.contentType=r;break;case"content-description":t.contentDescription=r;break;case"content-transfer-encoding":t.contentTransferEncoding=r;break;case"content-id":t.contentID=r;break;case"content-disposition":t.contentDisposition=r;break;case"content-location":t.contentLocation=r}}else{if(t.contentDisposition.toLowerCase().includes("inline")&&a[s].length>=4&&t.contentType?.toLowerCase().indexOf("image")>-1){let f=!0,h=e.subarray(o,e.length);if(t.contentType.toLowerCase().indexOf("tif")>0){if(t.contentTransferEncoding==="base64"){let r="",u=h;for(let n=0;n<u.length;n+=65535){let d=u.subarray(n,n+65535>u.length-1?u.length-1:n+65535);r+=String.fromCharCode.apply(null,d)}let g=atob(r);h=new Uint8Array(g.length);for(let n=0;n<h.length;n++)h[n]=g.charCodeAt(n)}f=h[0]===73&&h[1]===73||h[0]===77&&h[1]===77}if(f){let r=h.buffer;t.contentTransferEncoding!=="base64"&&(r=new ArrayBuffer(e.length-o),h=new Uint8Array(r),h.set(e.subarray(o,e.length))),t.contentData=r,t.isValidImage=!0}break}if((i.start===""||t.contentID===i.start)&&t.contentType){if(t.contentType.includes("text")||t.contentType.includes("xml")){t.contentData=String.fromCharCode.apply(null,e.subarray(o,e.length));break}t.contentData=e.subarray(o,e.length)}}return t}var je=["nearest neighbor","bilinear","bicubic"],ke=["nearest","linear","cubic"],Oe="response is not a supported multipart/related mediaType with inline tiff,  switching to compatibility mode",Fe="response is not a supported multipart mediaType with inline tiff",Me="response is base64 encoded which may impact layer display performance",Ve="server returns an exception",Z=new Set(["1.0.0","1.1.0","1.1.1","1.1.2","2.0.1"]),G=class extends xe{constructor(){super(...arguments),this.datasetFormat="WCSServer",this.tileType="Raster"}get rasterId(){return`${this.url}-${this.coverageId}-${this.version}`}fetchRawTile(t,o,s){return R(this,arguments,function*(e,i,a,l={}){if(this.isBlockOutside(e,i,a))return null;let{nativePixelSize:f,spatialReference:h}=this.rasterInfo,r=2**e,u=f.x*r,g=f.y*r,{blockWidth:n,blockHeight:d}=this.getBlockWidthHeight(e),{origin:c}=this.rasterInfo.storageInfo.tileInfo,y=this.getTileExtent({x:u,y:g},i,a,c,h,[n,d]),p=this.rasterInfo.extent,A=y.xmax>p.xmax,I=y.ymin<p.ymin,k=A||I,C=y,P=n,j=d;if(k&&(C=y.clone().intersection(p),C!=null&&(A&&(P=Math.floor((C.xmax-C.xmin)/u),C.xmax=C.xmin+u*P),I&&(j=Math.floor((C.ymax-C.ymin)/g),C.ymin=C.ymax-g*j))),C==null||P<=1||j<=1)return null;let T=yield this._getCoverage(C,P,j,r,l);if(!T)return null;let{coverageDescription:F}=this.coverageInfo,{noDataValue:V,multidimensionalInfo:q}=this.rasterInfo,{multidimensionalDefinition:M}=l,W;if(q!=null&&M!=null&&M.length){let $=M[0].variableName;F.version==="2.0"?W=F.rangeType[0].find(b=>b.name===$)?.nilValue:F.version==="1.1"&&(W=F.range.find(b=>b.identifier===$)?.nullValues)}let N=W??V,m=yield this.decodePixelBlock(T,{width:P,height:j,planes:null,pixelType:null,tiffNoDataValue:Array.isArray(N)?N[0]:N,matchAllNoData:!0});if(m==null)return null;if(m&&(m.width!==P||m.height!==j))throw new E("wcsraster-fetch",`the response has unexpected dimension width: ${m.width}, height: {pixelBlock.height}`);return k?me(m,{x:0,y:0},{width:d,height:d}):m})}_open(e){return R(this,null,function*(){let{customFetchParameters:i}=this.ioConfig,a=e?.signal,l=yield $e(this.url,{version:i?.version??this.version,customParameters:i,signal:a});if(this.capabilities=l,!this.version){let n=l.version.slice(0,3);n==="2.0"||n==="1.1"||n==="1.0"?this.version=l.version:(n=l.supportedVersions.find(d=>d==="2.0.1")||l.supportedVersions.find(d=>d.slice(0,3)==="2.0")||l.supportedVersions.find(d=>d.slice(0,3)==="1.1")||l.supportedVersions.find(d=>d.slice(0,3)==="1.0")||"1.0.0",this.version=n)}let{version:t}=this;if(!Z.has(t))throw new E("wcsraster-open",`unsupported WCS version ${t}`);let{gridCoverages:o}=l;if(!o.length)throw new E("wcsraster-open","cannot find rectified grid coverages");this.coverageId??=o[0].id;let{coverageId:s}=this,f=o.find(n=>n.id===s);if(f==null)throw new E("wcsraster-open",`the coverageId ${s} does not exist in capabilities`);let h=yield Y(this.url,{coverageIds:[s],version:t,customParameters:i,signal:a});if(this.coverageInfo=h[0],t.slice(0,3)==="2.0"){let{coverageInfo:n}=this;n.lonLatEnvelope=f.lonLatEnvelope,n.supportedInterpolations=Te(l.supportedInterpolations),this._patchDimensionValues201(s,a)}this.datasetName=this.coverageInfo.title;let{rasterInfo:r}=this.coverageInfo;if(this.createRemoteDatasetStorageInfo(r,512,512),this._set("rasterInfo",r),r.spatialReference==null)throw new E("wcsraster-open",`coverage without spatial reference is not supported: ${s}`);let{pixelType:u,bandCount:g}=yield this._getPixelTypeAndBandCount(a);r.pixelType=u,r.bandCount===1&&g>1&&(r.bandCount=g),this.updateTileInfo()})}_patchDimensionValues201(e,i){return R(this,null,function*(){let{coverageInfo:a}=this,l=a.rasterInfo.multidimensionalInfo?.variables,t=Z.has("1.1.2")?"1.1.2":Z.has("1.1.1")?"1.1.1":Z.has("1.1.0")?"1.1.0":null,{customFetchParameters:o}=this.ioConfig;if(l&&t)try{let s=this.url.includes("/ImageServer/"),f=e.length>8&&e.startsWith("Coverage")&&s?e.slice(8):e,h=yield Y(this.url,{coverageIds:[f??e],version:t,customParameters:o,signal:i}).catch(()=>{if(f)return Y(this.url,{coverageIds:[e],version:t,customParameters:o,signal:i})}),r=h?.[0].rasterInfo.multidimensionalInfo?.variables;if(r)for(let u of l){let g=r.find(({name:n})=>n===u.name);if(g?.dimensions?.length)for(let n=u.dimensions.length-1;n>=0;n--){let d=u.dimensions[n],c=g.dimensions.find(({name:y})=>y===d.name);c?c.values&&c.extent?.join(",")===d.extent?.join(",")&&(u.dimensions[n]=z(B({},d),{values:c.values})):s&&u.dimensions.splice(n,1)}}}catch{}})}_getPixelTypeAndBandCount(e){return R(this,null,function*(){let{pixelSize:i,extent:a,multidimensionalInfo:l}=this.rasterInfo,t=a.center,o=new ne({xmin:t.x-i.x,xmax:t.x+i.x,ymin:t.y-i.y,ymax:t.y+i.y,spatialReference:a.spatialReference}),s=[];if(l!=null){let c=l.variables[0];s=[],c.dimensions.forEach(y=>{s.push(new we({variableName:c.name,dimensionName:y.name,values:y.hasRegularIntervals?y.extent?.[0]:y.values?.[0],isSlice:!0}))})}let{coverageDescription:f}=this.coverageInfo,h={interpolation:"nearest",multidimensionalDefinition:s,signal:e},{version:r}=f,{ioConfig:u}=this,g=r==="2.0"&&u.allowAnyMediaType==null||r==="1.1"&&u.use2GridOffsets==null,n;try{n=yield this._getCoverage(o,2,2,1,h,!0)}catch(c){if(!g)throw c;if(r==="1.1"){if(!c.details?.isResolutionMismatch)throw c;u.use2GridOffsets=!0}}if(!n&&g&&(r==="2.0"&&(u.allowAnyMediaType=!0),n=yield this._getCoverage(o,2,2,1,h),n&&J.getLogger(this).warn("wcsraster:getcoverage",Oe)),!n)throw new E("wcsraster-open","unable to determine pixel type");let d=yield this.decodePixelBlock(n,{width:2,height:2,planes:null,pixelType:null});if(d==null)throw new E("wcsraster-open","unable to determine pixel type");return{pixelType:d.pixelType,bandCount:d.getPlaneCount()??0}})}_getCoverage(e,i,a,l,t,o=!1){return R(this,null,function*(){let{coverageDescription:s}=this.coverageInfo,{version:f}=s,h=f==="2.0"?this._getCoverage201Parameters(e,i,a,l,t,s):f==="1.1"?this._getCoverage110Parameters(e,i,a,t,s):this._getCoverage100Parameters(e,i,a,t),r=f==="2.0"?yield this.request(this._constructWCS201Url(h),{signal:t.signal,responseType:"array-buffer"}):yield this.request(this.url,{query:h,signal:t.signal,responseType:"array-buffer"});if(f==="1.0")return r.data;if(f==="2.0"&&this.ioConfig.allowAnyMediaType!==!1&&he(r.data)==="tiff")return o&&(this.ioConfig.allowAnyMediaType=!0,J.getLogger(this).warn("wcsraster:getcoverage",Oe)),r.data;let u=Pe(r);if(u.isMultipart&&u.data){let c=u.data.find(y=>y.isValidImage);return o&&c?.contentTransferEncoding==="base64"&&J.getLogger(this).warn("wcsraster:getcoverage",Me),c?.contentData}let g=new Uint8Array(r.data,0,Math.min(r.data.byteLength,2e3)),n=String.fromCharCode.apply(null,g).toLowerCase().includes("exception"),d=n&&String.fromCharCode.apply(null,g).includes("A non-zero RESX/RESY or WIDTH/HEIGHT is required but neither was provided");throw n?new E("wcsraster:getcoverage",Ve,{isResolutionMismatch:d}):new E("wcsraster:getcoverage",Fe)})}_getInterpolationIndex(e){return e&&this.coverageInfo.supportedInterpolations?.includes(e)?e==="nearest"?0:e==="bilinear"?1:e==="cubic"?2:0:0}_getCoverage100Parameters(e,i,a,l){let t=`${e.xmin},${e.ymin},${e.xmax},${e.ymax}`,o=e.spatialReference.wkid,s=(this.coverageInfo.supportedFormats||[]).find(c=>c.toLowerCase().includes("tiff"))||"GEOTIFF",{bandIds:f,interpolation:h}=l,r=this._getInterpolationIndex(h),u=f?f.map(c=>this.coverageInfo.bandNames[c]):null,g=je[r],{multidimensionalDefinition:n}=l,d;if(n!=null&&this.rasterInfo.multidimensionalInfo!=null){let y=n.find(p=>p.dimensionName==="StdTime")?.values;y&&y.length>0&&(Array.isArray(y[0])&&(y=y[0]),d=y.map(p=>K(p)).join(","))}return{service:"WCS",request:"GetCoverage",version:this.version,coverage:this.coverageId,format:s,crs:`EPSG:${o}`,bbox:t,width:i,height:a,time:d,interpolation:g,band:u?.join(",")}}_getCoverage110Parameters(e,i,a,l,t){let{multidimensionalDefinition:o,bandIds:s,interpolation:f}=l,h=e.spatialReference.wkid,r=`urn:ogc:def:crs:EPSG::${h}`,u=(this.coverageInfo.supportedFormats||[]).find(b=>b.toLowerCase().includes("tiff"))||"image/tiff",g=this._getInterpolationIndex(f),n=ke[g],d=f==null||this.coverageInfo.supportedInterpolations?.indexOf(f)===0,c=t.domain.spatialDomain,y=c.origin.x<=c.envelope.xmin&&c.origin.y<=c.envelope.ymin,p=e.width/i,A=e.height/a*(y?1:-1),I=y?[e.xmin,e.ymin]:[e.xmin,e.ymax],k=c.useEPSGAxis&&Se(h),C=k?`${I[1]},${I[0]}`:`${I[0]},${I[1]}`,P=this.ioConfig.use2GridOffsets,j=k?P?`${A},${p}`:`${A},0,0,${p}`:P?`${p},${A}`:`${p},0,0,${A}`,T=p/2,F=e.xmin+T,V=e.xmax-T,q=Math.abs(A)/2,M=e.ymin+q,W=e.ymax-q,N=k?`${M},${F},${W},${V},${r}`:`${F},${M},${V},${W},${r}`,m=t.range.find(b=>b.axis.some(O=>O.identifier.toLowerCase().includes("band"))),$,S=m&&n&&s?d?`${m.identifier}[${m.axis[0].identifier}[${s.join(",")}]]`:`${m.identifier}:${n}[${m.axis[0].identifier}[${s.join(",")}]]`:null;if(o!=null&&o.length)for(let b=0;b<o.length;b++){let O=o[b].values,L=o[b].dimensionName?.toLowerCase(),U=o[b].variableName?.toLowerCase(),D=t.range.find(_=>_.identifier.toLowerCase()===U);if(O.length>0){if(Array.isArray(O[0])&&(O=O[0]),L==="stdtime")$=O.map(_=>K(_)).join(",");else if(D){let _=D.axis.find(Ee=>Ee.identifier.toLowerCase()===L);_&&(S=d?D.identifier+"["+_.identifier+"["+O.join(",")+"]]":D.identifier+":"+n+"["+_.identifier+"["+O.join(",")+"]]")}}b===o.length-1&&D&&!S&&(S=d?D.identifier:D.identifier+":"+n)}return{service:"WCS",request:"GetCoverage",version:this.version,identifier:this.coverageId,format:u,crs:`EPSG:${h}`,boundingbox:N,gridCS:"urn:ogc:def:cs:OGC:0.0:Grid2dSquareCS",gridType:"urn:ogc:def:method:WCS:1.1:2dGridIn2dCrs",gridOrigin:C,gridOffsets:j,gridBaseCRS:r,timeSequence:$,rangeSubset:S}}_getCoverage201Parameters(e,i,a,l,t,o){let{multidimensionalDefinition:s,interpolation:f}=t,h=this._getInterpolationIndex(f),r=null,{supportedInterpolations:u}=this.capabilities;if(u?.length)switch(h){case 0:r=u.find(m=>m.toLowerCase().includes("nearest"));break;case 1:r=u.find(m=>m.toLowerCase().includes("linear"));break;case 2:r=u.find(m=>m.toLowerCase().includes("cubic")||m.toLowerCase().includes("quadratic"))}let g=(this.coverageInfo.supportedFormats||[]).find(m=>m.toLowerCase().includes("tiff"))||"image/tiff",{bandNames:n}=this.coverageInfo,{boundedBy:d,domainSet:c,rangeType:y}=o,p=d.isEastFirst?0:1,A=1-p,{axisLabels:I}=d,k=I[p],C=I[A],P=`http://www.opengis.net/def/crs/EPSG/0/${e.spatialReference.wkid}`,j=P,T=[];T.push(`${k}(${e.xmin},${e.xmax})`),T.push(`${C}(${e.ymin},${e.ymax})`);let F=[];if(I.length>2)for(let m=2;m<I.length;m++){let $=c.origin[m];if(I[m].toLowerCase().includes("time")){let S=$.toString();d.uomLabels?.[m].toLowerCase().includes("ole")&&(F.push(I[m]),S=K($,!0)),T.push(I[m]+",http://www.opengis.net("+S+")")}else T.push(I[m]+",http://www.opengis.net("+$+")")}let V=null;if(s!=null&&s.length){let m=[];y.forEach(S=>S.forEach(b=>m.push(b.name)));let $=[];for(let S=0;S<s.length;S++){let b=I.find(L=>L===s[S].dimensionName),O=m.find(L=>L===s[S].variableName);if($.includes(O)||$.push(O),b){let L=s[S].values;if(L.length>0){Array.isArray(L[0])&&(L=L[0]);let U="";U=b.toLowerCase().includes("time")?L.map(_=>K(_)).join(","):L.join(",");let D=T.findIndex(_=>_.indexOf(b+",http://www.opengis.net")===0);D===-1&&T.push(b+",http://www.opengis.net("+U+")"),D===-1||T[D].includes("("+U+")")||T.splice(D,1,b+",http://www.opengis.net("+U+")")}}}$.length&&(V=$.join(","))}else n?.length>=2&&(V=(t.bandIds?t.bandIds.map(m=>n[m]):n).join(","));let q=T.join("&subset="),M=!o.domainSet.hasSameAxisLabelsAsBoundedBy&&this.ioConfig.allowScaleFactor!==!1,W=M?null:`${k}(${i}),${C}(${a})`,N=M?1/l:null;return{service:"WCS",request:"GetCoverage",version:this.version,coverageId:this.coverageId,rangesubset:V,interpolation:r,scaleSize:W,scaleFactor:N,subset:q,format:g,mediaType:this.ioConfig.allowAnyMediaType?null:"multipart/related",outputcrs:P,subsettingcrs:j}}_constructWCS201Url(e){let i=B(B({},this.ioConfig.customFetchParameters),e),a=[];return Object.keys(i).forEach(l=>{let t=i[l];t!=null&&(l==="subset"?typeof t=="string"&&t.split("&subset=").forEach(o=>{o&&a.push(`subset=${encodeURIComponent(o)}`)}):a.push(`${l}=${encodeURIComponent(t)}`))}),`${encodeURI(this.url)}?${a.join("&")}`}};function K(e,i=!1){return(i?new Date(Ie(e)):new Date(e)).toISOString()}v([w({type:String,json:{write:!0}})],G.prototype,"datasetFormat",void 0),v([w({readOnly:!0})],G.prototype,"tileType",void 0),v([w({type:String,json:{write:!0}})],G.prototype,"version",void 0),v([w({type:String,json:{write:!0}})],G.prototype,"coverageId",void 0),v([w({readOnly:!0})],G.prototype,"rasterId",null),G=v([X("esri.layers.support.rasterDatasets.WCSRaster")],G);var De=G;var We=new Set(["milliseconds","seconds","minutes","hours","days","weeks","months","years","decades","centuries"]),x=class extends oe(ae(ve(de(pe(Ce(ue(se(re(le.ClonableMixin(Ae)))))))))){constructor(...e){super(...e),this.coverageId=null,this.version=null,this.isReference=null,this.legendEnabled=!0,this.noData=0,this.operationalLayerType="WCS",this.type="wcs",this.popupEnabled=!0,this.popupTemplate=null,this.fields=null,this._debouncedSaveOperations=te((i,a,l)=>R(this,null,function*(){let{save:t,saveAs:o}=yield import("./chunk-TN6T6RUB.js");switch(i){case H.SAVE:return t(this,a);case H.SAVE_AS:return o(this,l,a)}}))}normalizeCtorArgs(e,i){return typeof e=="string"?B({url:e},i):e}load(e){let i=e!=null?e.signal:null;return this.addResolvingPromise(this.loadFromPortal({supportedTypes:["WCS"]},e).catch(ee).then(()=>this._openRaster(i))),Promise.resolve(this)}get coverageInfo(){return this.raster.coverageInfo}get defaultPopupTemplate(){return this.createPopupTemplate()}get rasterFields(){return[be("Pixel Value")]}createPopupTemplate(e){return fe({fields:this.rasterFields,title:this.title},e)}save(e){return R(this,null,function*(){return this._debouncedSaveOperations(H.SAVE,e)})}saveAs(e,i){return R(this,null,function*(){return this._debouncedSaveOperations(H.SAVE_AS,i,e)})}_openRaster(e){return R(this,null,function*(){let i=new De({url:this.url,version:this.version,coverageId:this.coverageId,ioConfig:z(B({sampling:"closest"},this.ioConfig),{customFetchParameters:this.customParameters})});if(yield i.open({signal:e}),!i.rasterInfo)throw i.destroy(),new E("wcs-layer:load","cannot load resources on "+this.url);let{rasterInfo:a}=i;a.noDataValue==null&&(a.noDataValue=this.noData),this._set("serviceRasterInfo",a),this._set("spatialReference",a.spatialReference),this.title==null&&this.setAtOrigin("title",i.datasetName,"service"),this.coverageId==null&&this.setAtOrigin("coverageId",i.coverageInfo.id,"service"),this.version==null&&i.version&&this.setAtOrigin("version",i.version,"service"),this.setAtOrigin("tileInfo",i.rasterInfo.storageInfo.tileInfo,"service");let{multidimensionalInfo:l}=a;if(l!=null){let t=l.variables[0].dimensions.find(({name:o})=>o==="StdTime");if(t){let o=t.extent?.[0]??t.values[0];Array.isArray(o)&&(o=o[0]);let s=t.extent?.[1]??t.values[t.values.length-1];Array.isArray(s)&&(s=s[1]);let f=We.has(t.intervalUnit?.toLowerCase())?t.intervalUnit?.toLowerCase():null;this.set("timeInfo",{startField:"StdTime",fullTimeExtent:{start:o,end:s},timeZone:null,interval:f?{value:t.interval,unit:f}:null})}}this.raster=i,this._configDefaultSettings(),this.addHandles(ie(()=>this.customParameters,t=>this.raster.ioConfig.customFetchParameters=t))})}};v([w({type:String,nonNullable:!0,json:{name:"wcsInfo.coverageId",write:{isRequired:!0,ignoreOrigin:!0}}})],x.prototype,"coverageId",void 0),v([w()],x.prototype,"coverageInfo",null),v([w({type:["1.0.0","1.1.0","1.1.1","1.1.2","2.0.1"],nonNullable:!0,json:{name:"wcsInfo.version",write:{isRequired:!0,ignoreOrigin:!0}}})],x.prototype,"version",void 0),v([w({type:Boolean,json:{read:!1,write:{enabled:!0,overridePolicy:()=>({enabled:!1})}}})],x.prototype,"isReference",void 0),v([w({json:{read:!0,write:!0}})],x.prototype,"blendMode",void 0),v([w(ye)],x.prototype,"legendEnabled",void 0),v([w({type:["show","hide"]})],x.prototype,"listMode",void 0),v([w()],x.prototype,"noData",void 0),v([w({type:["WCS"]})],x.prototype,"operationalLayerType",void 0),v([w()],x.prototype,"raster",void 0),v([w({readOnly:!0})],x.prototype,"type",void 0),v([w(ge)],x.prototype,"popupEnabled",void 0),v([w({type:ce,json:{name:"popupInfo",write:!0}})],x.prototype,"popupTemplate",void 0),v([w({readOnly:!0})],x.prototype,"defaultPopupTemplate",null),v([w({readOnly:!0,type:[Q]})],x.prototype,"fields",void 0),v([w({readOnly:!0,type:[Q]})],x.prototype,"rasterFields",null),x=v([X("esri.layers.WCSLayer")],x);var jt=x;export{jt as default};
