import{a as fe}from"./chunk-PFQXJNFG.js";import{b as At}from"./chunk-IMRRKL7P.js";import"./chunk-6GAANBZQ.js";import{a as pt}from"./chunk-2TGLTRKB.js";import{a as kt}from"./chunk-JHVSXE55.js";import{a as ye}from"./chunk-XOJOMNES.js";import"./chunk-TTZ4CWZW.js";import"./chunk-EB24NRSQ.js";import"./chunk-4JIR4MZV.js";import"./chunk-ZO3S2OWI.js";import{b as Ce,c as Oe}from"./chunk-IJETEJ35.js";import{a as be}from"./chunk-QC7YKF4H.js";import{a as Rt,d as Et,l as Ht}from"./chunk-RGD6ZU25.js";import{b as _e}from"./chunk-NRFDPN3W.js";import{a as Mt}from"./chunk-XGBN53IG.js";import"./chunk-KVIHP5QH.js";import{c as G}from"./chunk-62UTK67Z.js";import{a as Dt}from"./chunk-63BBKXWS.js";import"./chunk-SLOUGIU5.js";import{a as ve}from"./chunk-2SB3P7OV.js";import"./chunk-RK73WDNW.js";import"./chunk-C24MSACP.js";import"./chunk-Y533SYIC.js";import"./chunk-SCVJO5X3.js";import"./chunk-AIPTYQTX.js";import"./chunk-CJXY7S42.js";import"./chunk-2BJHWKO6.js";import"./chunk-Q5KIWWVU.js";import{a as ge}from"./chunk-3Y3IWJBE.js";import{b as St,c as ct}from"./chunk-IHEDDQC4.js";import"./chunk-W3HCXOXG.js";import"./chunk-AN3DAG6F.js";import"./chunk-K5FFS5P4.js";import"./chunk-3NS6RWJD.js";import"./chunk-6ZTUPVYX.js";import"./chunk-5DVGZXEZ.js";import"./chunk-2I3LIA7G.js";import"./chunk-WQKVID54.js";import"./chunk-DBCWR6HP.js";import{a as Pt}from"./chunk-O3DP7PW7.js";import{a as Vt}from"./chunk-AKI7NWXQ.js";import{b as It,d as me}from"./chunk-QGBXTIEK.js";import{b as nt}from"./chunk-XAJ5ULUR.js";import{a as he}from"./chunk-MIJLPOZZ.js";import"./chunk-QBDGQCUP.js";import"./chunk-4IWNSJVE.js";import"./chunk-5REY7VVO.js";import{f as ce,m as pe,p as Lt}from"./chunk-Z7TBAZRW.js";import"./chunk-ZYYN4NWF.js";import"./chunk-MRKUOXYW.js";import"./chunk-CL7L227X.js";import"./chunk-2GLWK7ZW.js";import{d as wt}from"./chunk-QXSQOLB3.js";import{b as de}from"./chunk-BKWQOCBC.js";import"./chunk-XACQ2RJ5.js";import"./chunk-LCFWGHLF.js";import"./chunk-CX3G2QWN.js";import"./chunk-D6N4VI5S.js";import"./chunk-5YS73I3T.js";import{a as Z,b as it}from"./chunk-3ZJ4NMBE.js";import"./chunk-4S7THJAS.js";import"./chunk-2XTO2IAR.js";import"./chunk-CQVHC5U2.js";import"./chunk-P7MVFIZJ.js";import"./chunk-FSW536RM.js";import"./chunk-VN5FPMRB.js";import"./chunk-N7DSOI7B.js";import"./chunk-F4HA2HQL.js";import"./chunk-DQZHSTUF.js";import"./chunk-CY62WWD7.js";import"./chunk-VDNRZCIE.js";import"./chunk-I2JD5OSI.js";import"./chunk-2MROBW6T.js";import"./chunk-QAHTJVUZ.js";import"./chunk-XE4T4457.js";import"./chunk-BWHHYBB5.js";import"./chunk-XWEUR6F7.js";import"./chunk-PSNQ2KG3.js";import"./chunk-MPI26GZ3.js";import"./chunk-CUV3BSEW.js";import"./chunk-3ZJU5D2H.js";import"./chunk-2UHZH5L3.js";import"./chunk-DQINVX66.js";import"./chunk-CSFAHB4Y.js";import"./chunk-T5UBLAP4.js";import"./chunk-PTXLSCMJ.js";import"./chunk-DA3NC6W4.js";import"./chunk-6L543SC5.js";import"./chunk-FRN24G7D.js";import"./chunk-FGABE2LC.js";import"./chunk-CU7FHMWW.js";import"./chunk-CZMBPC27.js";import"./chunk-VANM5A4M.js";import"./chunk-VSD74FMI.js";import"./chunk-KALTBP5D.js";import"./chunk-O2J7LFYY.js";import"./chunk-BIU7ZFAB.js";import"./chunk-6FZTFPIH.js";import"./chunk-J5AEP4US.js";import"./chunk-YHRLMRSO.js";import"./chunk-KPT44MCK.js";import"./chunk-XKFJ6GWH.js";import"./chunk-SFANISLX.js";import"./chunk-UJ7KVQR6.js";import"./chunk-GSXOR3JU.js";import"./chunk-55OTJIMU.js";import"./chunk-EM2AEAFS.js";import"./chunk-YEPHAEAY.js";import"./chunk-TK4PPGQL.js";import"./chunk-ELCBU4NP.js";import"./chunk-GMZFCQJQ.js";import"./chunk-5WDH2LXO.js";import"./chunk-L7NOU4T2.js";import"./chunk-VGAXEXH3.js";import"./chunk-HMNTGQTR.js";import"./chunk-ZLIWNUFM.js";import"./chunk-GVSOJUIP.js";import"./chunk-GWSX6PRO.js";import"./chunk-G2JMPZCN.js";import"./chunk-IRQF7UTO.js";import"./chunk-3KOZOOEP.js";import"./chunk-YVCKQBWT.js";import"./chunk-WOZSH7YY.js";import"./chunk-2PJRHNJW.js";import"./chunk-B2RVSTL3.js";import"./chunk-4XEE5PE3.js";import"./chunk-2CKJLDTO.js";import"./chunk-F6TN7E7K.js";import"./chunk-4LDVFWME.js";import"./chunk-HUUJBVXR.js";import"./chunk-7G56KLCZ.js";import"./chunk-L56OBJFS.js";import"./chunk-7HMNN4FJ.js";import{a as ae,e as le}from"./chunk-UKAGN54W.js";import"./chunk-342NGUMP.js";import"./chunk-NIYDRLW4.js";import"./chunk-PHMJ7KPL.js";import"./chunk-ESSDCWGF.js";import"./chunk-WVKBXQWE.js";import"./chunk-FSWSNKJD.js";import"./chunk-FGEB67EG.js";import"./chunk-YEXMIDOT.js";import"./chunk-T7PUQGWM.js";import"./chunk-GV3ZFCVD.js";import"./chunk-SOEEM7Z7.js";import"./chunk-MVDZB4AK.js";import"./chunk-44A27HB7.js";import"./chunk-47NSYSFY.js";import"./chunk-QXNVQZT7.js";import"./chunk-QSQIQSC6.js";import{a as ut,b as ue,d as Ot,e as dt}from"./chunk-AYNBEMCC.js";import"./chunk-LNYBTIG7.js";import"./chunk-VYZHOYXV.js";import"./chunk-ECA5I2I7.js";import"./chunk-XAHD7XBV.js";import"./chunk-Y7XRSFOZ.js";import"./chunk-YQNUGDFH.js";import"./chunk-QCZ3ZIGQ.js";import"./chunk-RZU6EEB3.js";import"./chunk-KLXERNY4.js";import"./chunk-7SDNM7YV.js";import{a as se}from"./chunk-4NUW747S.js";import"./chunk-T6WMVIUG.js";import"./chunk-ONYJLWAD.js";import"./chunk-PHODKV66.js";import"./chunk-JPMGMA4B.js";import{i as oe,s as re}from"./chunk-ZM24RY22.js";import"./chunk-LAX5536Z.js";import"./chunk-N3HRYLNW.js";import"./chunk-4DBMALZW.js";import"./chunk-CVWWHM2V.js";import"./chunk-6OQYVEQJ.js";import"./chunk-YOXOWGT6.js";import"./chunk-EFZOSMYP.js";import"./chunk-WI7F4ZKJ.js";import"./chunk-MJ7M24NH.js";import"./chunk-GJH4QFRX.js";import"./chunk-T63F7663.js";import"./chunk-O4V2VBSK.js";import"./chunk-5TKRKB5E.js";import"./chunk-XAGMDNNR.js";import"./chunk-OP2TLIUN.js";import"./chunk-T2THIR6K.js";import"./chunk-LORHDXEB.js";import"./chunk-BBBPJI4H.js";import"./chunk-45BTW5EG.js";import"./chunk-TPFBHGDM.js";import"./chunk-73NLRHJD.js";import"./chunk-PNFEUBDF.js";import"./chunk-6RCCEJDL.js";import"./chunk-PQ2TNDUX.js";import"./chunk-6X6MKRQ3.js";import"./chunk-FQFHMHYU.js";import"./chunk-SZMEI3WL.js";import"./chunk-KKVGD67U.js";import"./chunk-MYOJWRDU.js";import"./chunk-L7UKJKHG.js";import"./chunk-V2IENAEU.js";import"./chunk-QAGQFNF2.js";import"./chunk-SY7JS2VW.js";import"./chunk-WK57SDN6.js";import"./chunk-AG4V3ZUO.js";import"./chunk-YWLMJ26A.js";import"./chunk-QAWNU3UJ.js";import"./chunk-HRQT4R6X.js";import"./chunk-44BHLWQ4.js";import"./chunk-5BPM64SU.js";import"./chunk-PMVHHMQJ.js";import"./chunk-NAFOM5UA.js";import"./chunk-DO7UF2F2.js";import"./chunk-ZTR6OS44.js";import"./chunk-VRTKAD2J.js";import"./chunk-DBLKLHK2.js";import"./chunk-UTE3ASAZ.js";import"./chunk-2AFEAPEX.js";import"./chunk-GNGXUEWV.js";import"./chunk-QBI5NDCA.js";import"./chunk-NOHW2DKR.js";import"./chunk-HVJAAM3A.js";import"./chunk-ACPEJEHK.js";import"./chunk-I7B3LWNP.js";import"./chunk-YP2E5N4E.js";import"./chunk-QLMNLSCT.js";import"./chunk-P55G5ATK.js";import"./chunk-JT3K52KQ.js";import"./chunk-SPLEGG4R.js";import"./chunk-Y4TJDUGP.js";import"./chunk-6PAFOJ4W.js";import"./chunk-74SDGE57.js";import"./chunk-FRXWHX3T.js";import"./chunk-DTDQ5X42.js";import"./chunk-RX2HFR4X.js";import"./chunk-AZW7YPTQ.js";import"./chunk-NJLJX4X6.js";import"./chunk-DZHFTD24.js";import"./chunk-K57Z4J34.js";import"./chunk-VWG3KVOU.js";import"./chunk-JOEUVLAN.js";import"./chunk-JZQDGIDQ.js";import"./chunk-CZ6CGC7I.js";import"./chunk-7B6U3N62.js";import"./chunk-46WDO5LS.js";import"./chunk-G5EYK5KM.js";import"./chunk-YJKJQU3F.js";import"./chunk-OK4K3OQT.js";import"./chunk-BPWNCOXC.js";import"./chunk-VNS4CQ27.js";import"./chunk-AVMO6LCR.js";import"./chunk-TEGPMVWT.js";import"./chunk-CLQRQC3Y.js";import"./chunk-KSNU73LO.js";import"./chunk-FACEVGRE.js";import"./chunk-5XTCPT52.js";import{a as q}from"./chunk-JQAW4OB5.js";import{a as Tt}from"./chunk-TC77DYTW.js";import"./chunk-F2BQ2GD6.js";import"./chunk-R3XLNYYB.js";import{o as ne}from"./chunk-36M5A2TS.js";import"./chunk-U2ZO6WN5.js";import"./chunk-BMYVPMAK.js";import{a as h}from"./chunk-6F25LG6O.js";import{d as tt,f as bt}from"./chunk-XLL67PCY.js";import"./chunk-MCO7DSFO.js";import"./chunk-IIROCMOY.js";import"./chunk-5LG2P6MT.js";import"./chunk-GJ2QRXGN.js";import"./chunk-6QXEFK4U.js";import"./chunk-5L2EJ5RT.js";import"./chunk-S52JRLJC.js";import"./chunk-E2QKN2KY.js";import"./chunk-PDQQY7RQ.js";import"./chunk-W5OI4BJ2.js";import"./chunk-RWCIDBNQ.js";import"./chunk-2NH7HOKA.js";import"./chunk-EM35R6FY.js";import"./chunk-HM5RIVQC.js";import"./chunk-HKJZ7WI6.js";import"./chunk-CXOFHVIF.js";import"./chunk-EO2H4LIH.js";import"./chunk-DJW5LMRG.js";import"./chunk-DMO5HQM3.js";import"./chunk-DEH76MSI.js";import{a as ie}from"./chunk-ALWV3RJ2.js";import"./chunk-2ZFXOJDB.js";import"./chunk-QXXXCEV5.js";import{E as ee,G as Ct,H as B,b as C,d as k,e as U,n as x,u as et}from"./chunk-6B5XFA6F.js";import"./chunk-PUVSV35R.js";import"./chunk-FCWOKKZM.js";import"./chunk-3JGYBNJA.js";import{i as Y}from"./chunk-DA3SDKGO.js";import"./chunk-ZOEPYNM4.js";import"./chunk-57VFBGF3.js";import"./chunk-GWBRHLNH.js";import"./chunk-BJH4F4SM.js";import"./chunk-Z3RBZHAK.js";import"./chunk-SP2CO3KX.js";import"./chunk-PTZYZULI.js";import"./chunk-NMLYCCKN.js";import"./chunk-ZC6EBRE4.js";import"./chunk-KALOJIUA.js";import"./chunk-KMMTNF7G.js";import"./chunk-E7AX56GD.js";import"./chunk-IDVLLREH.js";import"./chunk-DWLSVYOY.js";import"./chunk-PQGCNP5H.js";import"./chunk-UASS7NJI.js";import"./chunk-WZRAC35O.js";import"./chunk-KUYAWYSS.js";import"./chunk-MIS6QMFE.js";import"./chunk-MDZTV2VL.js";import"./chunk-RNC4P66O.js";import"./chunk-7LHOQXZT.js";import"./chunk-BCREO4Q5.js";import"./chunk-U4QEPZJ3.js";import"./chunk-KJUZWSCL.js";import"./chunk-3WO6D7MU.js";import"./chunk-BUZ3SPLE.js";import"./chunk-K75TK42V.js";import{i as te}from"./chunk-OLOKUDVI.js";import"./chunk-ZTOZWLEE.js";import"./chunk-RJWOVI3M.js";import"./chunk-RSDQHAJX.js";import{a as m,b as X,e as M}from"./chunk-BOVYXYHK.js";import{C as Yt,s as Xt,t as yt}from"./chunk-KVM6SHDX.js";import"./chunk-HX2VGIR2.js";import"./chunk-ERDKAICI.js";import"./chunk-EQZWYK27.js";import"./chunk-JLPLCY2B.js";import"./chunk-DKGGDYJI.js";import"./chunk-5LA3PVK5.js";import"./chunk-IR6XCBC4.js";import"./chunk-C6JPAW54.js";import"./chunk-WD3OPXCN.js";import"./chunk-FA3WGIU4.js";import"./chunk-WWVPA6PE.js";import"./chunk-ZQIC5NFT.js";import{c as lt}from"./chunk-VIEK2X23.js";import"./chunk-XKIFGPJO.js";import"./chunk-PEW2PLAN.js";import"./chunk-Q6Y4JG7Q.js";import"./chunk-7F5DJLJT.js";import"./chunk-CX5IFQZJ.js";import"./chunk-NJWTSROP.js";import"./chunk-D3R25AF2.js";import"./chunk-ARRCN5K3.js";import"./chunk-O3EGNJTY.js";import"./chunk-WGAOVKGR.js";import"./chunk-SLAWDKDA.js";import"./chunk-4N4D2YQX.js";import"./chunk-G4DZJMGT.js";import"./chunk-K5T5FD5C.js";import"./chunk-MVHHPJM7.js";import"./chunk-VDO6JJ3Y.js";import"./chunk-WFKZLI6F.js";import"./chunk-X2B63YVS.js";import"./chunk-BAEF3CT6.js";import"./chunk-AUAZP44J.js";import"./chunk-PVDFCTA4.js";import"./chunk-KNVXE32P.js";import"./chunk-76ATOSLU.js";import"./chunk-CCJU4DSH.js";import{a as at,j as w,k as Qt}from"./chunk-TG45K3WR.js";import{f as $t}from"./chunk-RAI4DTMT.js";import{b as Kt}from"./chunk-ACP3S2CH.js";import"./chunk-HVAXZ2NA.js";import{a as st}from"./chunk-T7DXJKX7.js";import"./chunk-TYYVNQUR.js";import{a as o}from"./chunk-QGVBCWUY.js";import{H as I}from"./chunk-MYO4NP2N.js";import{e as r}from"./chunk-NFIPKH6V.js";import"./chunk-JPU2PQZC.js";import{l as O}from"./chunk-5QEXLALV.js";import"./chunk-P6QFA5MM.js";import"./chunk-DGTD7Y73.js";import"./chunk-LI2SX4T6.js";import{d as j}from"./chunk-BWO7LS2H.js";import"./chunk-HEVQSRJ2.js";import"./chunk-OVHPPCBL.js";import"./chunk-SNFOAZZQ.js";import"./chunk-AML4XSEF.js";import{b as L,e as _t,g as Zt,z as Jt}from"./chunk-4PTIEWMT.js";import{a as rt,d as Q}from"./chunk-TG2UTNEO.js";import"./chunk-YOFFGXOB.js";import{g as W}from"./chunk-XRGPJ3QY.js";import"./chunk-6MRUJ2UW.js";import{b as K}from"./chunk-2LI2GKBQ.js";import{j as qt}from"./chunk-QBWJMFH5.js";import{a as H,b as A,f as Wt}from"./chunk-VTHXE323.js";var D=class extends I{constructor(t){super(t),this.elevationAlignedTargetLocation=null,this.inputPoints={isValid:!1,observer:m(),observerSurfaceNormal:null,observerFeatureId:null,target:m(),targetSurfaceNormal:null,targetFeatureId:null,observerAdjusted:m(),targetAdjusted:m()},this.computationResult={start:m(),end:m(),intersection:m(),isValid:!1,isTargetVisible:!1},this.result=null}notifyResultChanged(){this.notifyChange("computationResult")}notifyInputPointsChanged(){this.notifyChange("inputPoints")}};o([r()],D.prototype,"target",void 0),o([r()],D.prototype,"elevationAlignedTargetLocation",void 0),o([r()],D.prototype,"inputPoints",void 0),o([r()],D.prototype,"computationResult",void 0),o([r()],D.prototype,"result",void 0),D=o([O("esri.views.3d.analysis.LineOfSight.LineOfSightComputation")],D);var xt,P=xt=class extends I{constructor(t){super(t)}clone(){return new xt({type:this.type,id:K(this.id),mapPoint:K(this.mapPoint),renderPoint:X(this.renderPoint),normal:K(this.normal),ray:K(this.ray),graphic:this.graphic})}equals(t){return this.type===t.type&&this.id===t.id&&Zt(this.mapPoint,t.mapPoint)&&ee(this.renderPoint,t.renderPoint)&&qt(this.normal,t.normal)&&ue(this.ray,t.ray)&&this.graphic===t.graphic}};o([r()],P.prototype,"type",void 0),o([r({constructOnly:!0})],P.prototype,"id",void 0),o([r({constructOnly:!0})],P.prototype,"mapPoint",void 0),o([r({constructOnly:!0})],P.prototype,"renderPoint",void 0),o([r({constructOnly:!0})],P.prototype,"normal",void 0),o([r({constructOnly:!0})],P.prototype,"graphic",void 0),o([r({constructOnly:!0})],P.prototype,"ray",void 0),P=xt=o([O("esri.views.3d.analysis.LineOfSight.LineOfSightIntersectionResult")],P);var z=class extends I{constructor(t){super(t),this._terrainIntersectionOptionsLayerUids=new Set(["terrain"])}initialize(){this.intersector=de(this.view.state.viewingMode),this.intersector.options.hud=!1,this.intersector.options.store=it.MIN}getScreenPointIntersection(t){let e=te(t,se.get()),i=_e(this.view.state.camera,e,Gt);return this._getRayIntersection(i)}_getRayIntersection(t,e){let{view:i,intersector:n}=this;if(t==null||i.sceneIntersectionHelper==null)return null;n.options.store=it.MIN,i.sceneIntersectionHelper.intersectToolIntersectorRay(t,n,e);let s=n.results.min;if(s.target==null)return null;let l=m();if(!s.getIntersectionPoint(l)||e?.maxDistance!=null&&!s.withinDistance(e.maxDistance))return null;let a=i.renderCoordsHelper.fromRenderCoords(l,new lt({spatialReference:i.spatialReference})),p=X(s.normal);if(he(s))return new P({type:Z.TERRAIN,id:s.target.lij.slice(),mapPoint:a,renderPoint:l,normal:p,ray:Ot(t),graphic:null});let d=nt(s,i);if(d==null)return null;let{layer:c,sourceLayer:u}=d,g=u?.type==="scene"?ne(d,u.objectIdField):d.uid;return new P({type:Z.OBJECT,id:`${c?.uid}/${g}`,mapPoint:a,renderPoint:l,normal:p,ray:Ot(t),graphic:d})}updateFromGroundIntersection(t,e,i){let n=Ee,s=He,l=Ae,a=we;C(s,t),this.view.renderCoordsHelper.worldUpAtPosition(s,l),et(l,l);let p=this.view.basemapTerrain.visibleElevationBounds,d=(e>=0?1:-1)*((p?Math.abs(p.max-p.min):100)+Math.abs(e));x(a,l,d),k(n,s,a),dt(n,s,Gt);let c=this._getRayIntersection(Gt,{include:this._terrainIntersectionOptionsLayerUids,maxDistance:d});if(c!=null){let u=we;return x(u,l,e),k(i,c.renderPoint,u),X(c.normal)}return C(i,t),null}};o([r()],z.prototype,"view",void 0),o([r()],z.prototype,"intersector",void 0),z=o([O("esri.views.3d.analysis.LineOfSight.LineOfSightRayIntersector")],z);var Ee=m(),He=m(),Ae=m(),we=m(),Gt=ut();var f=class extends st.EventedMixin(I){constructor(t){super(t),this.updateOnCameraChange=!0,this._observerGroundOffsetRenderSpace=0,this._effectiveObserverElevationMode="absolute-height",this._observerFeatureId=null,this._updatingHandles=new q,this._frameTask=bt,this._computationHandles=new j,this._externalObserverUpdate=!0}initialize(){let t=this.view.resourceController?.scheduler;this._frameTask=t?t.registerTask(tt.LINE_OF_SIGHT_TOOL):bt,this._intersector=new z({view:this.view}),this.addHandles([this._connectObserver(),this._connectComputations(),this._connectTargets()])}destroy(){this._computationHandles.destroy(),this._computations.removeAll(),this._updatingHandles.destroy()}get updating(){return this._frameTask.updating||this._updatingHandles.updating}get priority(){return this._frameTask.priority}set priority(t){this._frameTask.priority=t}get _computations(){return this.analysisViewData.computations}get _elevationAlignedObserverPositionRenderSpace(){return this.analysisViewData.observerEngineLocation}set _elevationAlignedObserverPositionRenderSpace(t){this.analysisViewData.observerEngineLocation=t}get _screenPixelSize(){return this.view.state.camera.computeScreenPixelSizeAt(this._elevationAlignedObserverPositionRenderSpace)}_computeResult(t){let e=t.computation,{inputPoints:i,computationResult:n}=e,{observerAdjusted:s,targetAdjusted:l}=i,{start:a,end:p}=n;C(a,s),C(p,l),this._canCompute(e)?this._computeIntersection(t):Me(t),e.notifyResultChanged(),this.emit("result-changed",{target:t.computation.target,result:e.result})}_adjustStartEndPositions(t){let{view:e}=this,{inputPoints:i}=t,{observer:n,target:s,observerAdjusted:l,targetAdjusted:a}=i;C(l,n),C(a,s),me(e,this._intersector.intersector,i);let{observerSurfaceNormal:p,targetSurfaceNormal:d}=i,c=this._screenPixelSize,u=mt;p!=null?C(u,p):U(u,a,l);let g=c;et(u,u),x(u,u,Math.min(g,1)),k(l,l,u),d!=null?C(u,d):U(u,l,a);let v=e.state.camera.computeScreenPixelSizeAt(a);et(u,u),x(u,u,Math.min(v,1)),k(a,a,u)}_computeIntersection({computation:t,interpolationInfo:e}){let{view:i}=this,{sceneIntersectionHelper:n,renderCoordsHelper:s}=i;if(n==null)return;let l=this._intersector.intersector,{computationResult:a,inputPoints:p}=t,{observer:d,target:c}=p,{start:u,end:g}=a,v=dt(u,g,ke);l.options.store=it.MIN,n.intersectToolIntersectorRay(v,l);let R=l.results.min,S=a.intersection,J=mt,_=!0;if(R!=null&&R.getIntersectionPoint(S)){C(e.originalIntersection,S),C(e.originalObserver,u),C(e.originalTarget,g),s.fromRenderCoords(S,J,i.spatialReference);let T=1-B(g,c)/B(u,c);_=B(d,S)>=T*B(d,c)}let F=new lt(J,i.spatialReference);{let{result:T,target:E}=t;T!=null?(T.target=E,T.intersectedGraphic=_?null:nt(R,i),T.intersectedLocation=_?null:F,T.visible=_):t.result=new ve({target:E,elevationAlignedTargetLocation:t.elevationAlignedTargetLocation,intersectedGraphic:_?null:nt(R,i),intersectedLocation:_?null:F,visible:_})}a.isValid=p.isValid=!0,a.isTargetVisible=_}_canCompute(t){let e=this.analysisViewData.elevationAlignedObserver,i=this.view.frustum;if(e==null||t.elevationAlignedTargetLocation==null||i==null)return!1;let{observerAdjusted:n,targetAdjusted:s}=t.inputPoints,l=i.intersectsPoint(n),a=i.intersectsPoint(s);return l&&a}_onObserverPositionChange(t,e,i,n,s){if(this._externalObserverUpdate=s,t==null)return this.analysisViewData.elevationAlignedObserver=null,void(this._observerFeatureId=null);if(e==null)return St(this.analysis,t.spatialReference,W.getLogger(this)),void(this.analysisViewData.elevationAlignedObserver=null);let l=Te(e,i),{absoluteZ:a,elevation:p}=Lt(e.x,e.y,e.z,this.view.spatialReference,this.view,l),d=e.clone();d.z=a,this._effectiveObserverElevationMode=l.mode,this.analysisViewData.elevationAlignedObserver=d;let c=m();this.view.renderCoordsHelper.toRenderCoords(d,c),this._elevationAlignedObserverPositionRenderSpace=c,this._observerGroundOffsetRenderSpace=a-p,this._observerFeatureId=It(n),this.priority=tt.LINE_OF_SIGHT_TOOL_INTERACTIVE}_onObserverRenderSpacePositionChangeForComputation(t,e,i,n,s){let{inputPoints:l}=t;switch(C(l.observer,e),l.observerFeatureId=s,l.observerSurfaceNormal=null,n){case"on-the-ground":case"relative-to-ground":{let a=this._intersector.updateFromGroundIntersection(l.observer,i,l.observer);l.observerFeatureId==null&&(l.observerSurfaceNormal=a)}}this._adjustStartEndPositions(t),t.notifyInputPointsChanged(),this.priority=tt.LINE_OF_SIGHT_TOOL_INTERACTIVE}_onTargetPositionChange(t,e,i,n,s,l=!0){let a=t.inputPoints;if(l&&(a.isValid=!1),i==null)return e!=null&&St(this.analysis,e.spatialReference,W.getLogger(this)),t.elevationAlignedTargetLocation=null,void t.notifyInputPointsChanged();let p=Te(i,n),{absoluteZ:d,elevation:c}=Lt(i.x,i.y,i.z,this.view.spatialReference,this.view,p),u=i.clone();switch(u.z=d,t.elevationAlignedTargetLocation=u,this.view.renderCoordsHelper.toRenderCoords(t.elevationAlignedTargetLocation,a.target),a.targetFeatureId=It(s),a.targetSurfaceNormal=null,p.mode){case"on-the-ground":case"relative-to-ground":{let g=this._intersector.updateFromGroundIntersection(a.target,d-c,a.target);a.targetFeatureId==null&&(a.targetSurfaceNormal=g)}}this._adjustStartEndPositions(t),t.notifyInputPointsChanged(),this.priority=tt.LINE_OF_SIGHT_TOOL_INTERACTIVE}_connectComputationToTarget(t){return Q([this._updatingHandles.add(()=>({computation:t,targetPosition:t.target.position,targetElevationInfo:t.target.elevationInfo,targetFeatureInfo:t.target.feature,projectedTargetPosition:Y(t.target.position,this.view.spatialReference)}),({computation:e,targetPosition:i,targetElevationInfo:n,targetFeatureInfo:s,projectedTargetPosition:l})=>{l.pending==null?this._onTargetPositionChange(e,i,l.geometry,n,s):this._updatingHandles.addPromise(l.pending)},w)])}_connectComputationToObserver(t){return this._updatingHandles.add(()=>({computation:t,observer:this.analysisViewData.elevationAlignedObserver}),({computation:e})=>{this._externalObserverUpdate&&(e.inputPoints.isValid=!1,e.notifyInputPointsChanged())},w)}_connectComputationToRenderSpaceObserver(t){return this._updatingHandles.add(()=>({computation:t,observer:this._elevationAlignedObserverPositionRenderSpace,observerGroundOffset:this._observerGroundOffsetRenderSpace,observerElevationMode:this._effectiveObserverElevationMode,observerFeatureId:this._observerFeatureId}),({computation:e,observer:i,observerGroundOffset:n,observerElevationMode:s,observerFeatureId:l})=>{this._onObserverRenderSpacePositionChangeForComputation(e,i,n,s,l)},w)}_connectComputationToCamera(t){return this._updatingHandles.add(()=>({camera:this.view.state.camera,isDirty:this._isCameraDirty}),({isDirty:e})=>{!this.updateOnCameraChange||t.inputPoints.isValid&&!e||t.notifyInputPointsChanged()})}_connectComputationToSlicePlane(t){return this._updatingHandles.add(()=>this.view.slicePlane,()=>{t.inputPoints.isValid=!1,t.notifyInputPointsChanged()})}_connectComputationToElevation(t){let e=(i,n)=>{let s=this.analysis.observer,l=t.target,a=null,p=null,d=null,c=null,u=null,g=null;if(s?.position!=null){let v=Y(s.position,this.view.spatialReference);if(v.pending!=null)return this._updatingHandles.addPromise(v.pending),void v.pending.finally(()=>e(i,n));a=v.geometry,p=s.elevationInfo,d=s.feature}if(l.position!=null){let v=Y(l.position,this.view.spatialReference);if(v.pending!=null)return this._updatingHandles.addPromise(v.pending),void v.pending.finally(()=>e(i,n));c=v.geometry,u=l.elevationInfo,g=l.feature}a==null&&c==null||(fe(i,n,ht,this.view.spatialReference),a!=null&&yt(ht,a)&&this._onObserverPositionChange(s!=null?s.position:null,a,p,d,!1),c!=null&&yt(ht,c)&&this._onTargetPositionChange(t,l.position,c,u,g,!1),a!=null&&c!=null&&Xt(ht,a,c)&&t.notifyInputPointsChanged())};return this.view.elevationProvider.on("elevation-change",({extent:i,spatialReference:n})=>e(i,n))}_connectComputationToTask(t){let e=null,i={computation:t,interpolationInfo:{originalIntersection:m(),originalObserver:m(),originalTarget:m()}};return Q([this._updatingHandles.add(()=>t.inputPoints,()=>{e=_t(e),e=$t(n=>Wt(this,null,function*(){yield Jt(this._frameTask.schedule(()=>this._computeResult(i),n))}))},{initial:!0,equals:()=>!1}),rt(()=>e=_t(e))])}_connectComputation(t){let e=this._computationHandles;e.has(t)||e.add([this._connectComputationToTarget(t),this._connectComputationToObserver(t),this._connectComputationToRenderSpaceObserver(t),this._connectComputationToCamera(t),this._connectComputationToSlicePlane(t),this._connectComputationToElevation(t),this._connectComputationToTask(t)],t)}_disconnectComputation(t){this._computationHandles.remove(t)}_onComputationCollectionChange({added:t,removed:e}){for(let i of e)this._disconnectComputation(i);for(let i of t)this._connectComputation(i)}_onTargetCollectionChange({added:t,removed:e}){for(let i of e)this._removeTarget(i);for(let i of t)this._addTarget(i)}_onCursorTargetChange(t,e){e!=null&&this._removeTarget(e),t!=null&&this._addTarget(t)}_addTarget(t){this._computations.some(e=>e.target===t)||this._computations.add(new D({target:t}))}_removeTarget(t){let e=this._computations.findIndex(i=>i.target===t);this._computations.removeAt(e)}_connectObserver(){return Q([this._updatingHandles.add(()=>({observerPosition:this.analysis.observer!=null?this.analysis.observer.position:null,projectedObserverPosition:Y(this.analysis.observer!=null?this.analysis.observer.position:null,this.view.spatialReference),observerElevationInfo:this.analysis.observer!=null?this.analysis.observer.elevationInfo:null,observerFeatureInfo:this.analysis.observer!=null?this.analysis.observer.feature:null}),({observerPosition:t,projectedObserverPosition:e,observerElevationInfo:i,observerFeatureInfo:n})=>{e.pending==null?this._onObserverPositionChange(t,e.geometry,i,n,!0):this._updatingHandles.addPromise(e.pending)},w)])}_connectComputations(){return this._updatingHandles.addOnCollectionChange(()=>this._computations,t=>this._onComputationCollectionChange(t),{initial:!0,final:!0})}_connectTargets(){return Q([this._updatingHandles.addOnCollectionChange(()=>this.analysis.targets,t=>this._onTargetCollectionChange(t),{initial:!0,final:!0}),this._updatingHandles.add(()=>this.analysisViewData.cursorTarget,(t,e)=>{this._onCursorTargetChange(t,e)})])}get _isCameraDirty(){let t=this.analysisViewData.elevationAlignedObserver,{view:e}=this,{renderCoordsHelper:i}=e;if(t==null||i==null)return!1;let n=mt;i.toRenderCoords(t,n);let s=e.state.camera.computeScreenPixelSizeAt(n);return Math.abs((s-this._screenPixelSize)/this._screenPixelSize)>De}};function Te(t,e){return t.hasZ?e??{mode:"absolute-height",offset:0}:{mode:"on-the-ground",offset:0}}function Me({computation:t,interpolationInfo:e}){let{computationResult:i,inputPoints:n}=t,{start:s,end:l,intersection:a}=i,{originalIntersection:p,originalObserver:d,originalTarget:c}=e;if(C(a,p),n.isValid){let u=mt,g=B(d,p)/B(d,c);Ct(u,s,d),x(u,u,1-g),k(a,a,u),Ct(u,l,c),x(u,u,g),k(a,a,u),i.isValid=!0}else t.result=null,i.isValid=!1,i.isTargetVisible=!1}o([r({constructOnly:!0})],f.prototype,"analysis",void 0),o([r({constructOnly:!0})],f.prototype,"analysisViewData",void 0),o([r({constructOnly:!0})],f.prototype,"view",void 0),o([r()],f.prototype,"updating",null),o([r()],f.prototype,"priority",null),o([r()],f.prototype,"updateOnCameraChange",void 0),o([r()],f.prototype,"_computations",null),o([r()],f.prototype,"_elevationAlignedObserverPositionRenderSpace",null),o([r()],f.prototype,"_observerGroundOffsetRenderSpace",void 0),o([r()],f.prototype,"_effectiveObserverElevationMode",void 0),o([r()],f.prototype,"_observerFeatureId",void 0),o([r()],f.prototype,"_screenPixelSize",null),o([r({readOnly:!0})],f.prototype,"_updatingHandles",void 0),o([r()],f.prototype,"_frameTask",void 0),o([r()],f.prototype,"_isCameraDirty",null),f=o([O("esri.views.3d.analysis.LineOfSight.LineOfSightController")],f);var De=.1,mt=m(),ke=ut(),ht=Yt();var zt=class{constructor(){this.glowWidth=8,this.innerWidth=.75}},Le=new zt;function Ie(t){let e=t.accentColor;return{glowColor:e,innerColor:oe(e),globalAlpha:.75*e.a}}var Ft=class{constructor(){this.size=.5}},Pe=new Ft;function Bt(t){return re(t.accentColor,.75)}var jt=class{constructor(){this.size=.5,this.visibleColor=new h([3,252,111,.75]),this.occludedColor=new h([252,3,69,.75]),this.undefinedColor=new h([127,127,127,.75])}},Ve=new jt,Ut=class{constructor(){this.innerWidth=2,this.outerWidth=8,this.visibleInnerColor=new h([3,252,111,1]),this.visibleOuterColor=new h([3,252,111,.15]),this.occludedInnerColor=new h([252,3,69,1]),this.occludedOuterColor=new h([252,3,69,.1]),this.undefinedInnerColor=new h([255,255,255,1]),this.undefinedOuterColor=new h([127,127,127,.2])}},ot=new Ut;var gt=class extends Rt{constructor(e,i){let n=Et(Bt(e.effectiveTheme)),s=wt(n,Pe.size,32,32),l=new Ht(s);super({view:e,renderObjects:[l],metadata:i,elevationInfo:{mode:"absolute-height",offset:0}}),At(this),this.themeHandle=at(()=>({color:Bt(e.effectiveTheme)}),a=>{n.setParameters(a)})}destroy(){this.themeHandle.remove(),super.destroy()}},vt=class extends Rt{constructor(e,i){let{size:n,visibleColor:s,occludedColor:l,undefinedColor:a}=Ve;super({view:e,renderObjects:[Nt(n,s,G.Custom1),Nt(n,l,G.Custom2),Nt(n,a,G.Custom3)],metadata:i,elevationInfo:{mode:"absolute-height",offset:0}}),At(this)}};function Nt(t,e,i){return new Ht(wt(Et(h.toUnitRGBA(e)),t,32,32),i)}var N;(function(t){t.Ready="ready",t.Creating="creating",t.Created="created"})(N||(N={}));var y=class extends be{constructor(t){super(t),this._creationMode=!1,this.removeIncompleteOnCancel=!1,this.analysisViewData=null,this._latestPointerMovePointerType=null,this._laserlineVisualElement=null,this._grabbedManipulator=null,this._analysisHandles=new j,this._updatingHandles=new q,this._manipulatorHandles=new j,this._targetTrackerManipulator=null}initialize(){this._intersector=new z({view:this.view}),this.addHandles(at(()=>this.state,t=>{t===N.Created&&this.finishToolCreation()},Qt)),this._observerManipulator=this._createObserverManipulator(),this._createLaserLine(),this.addHandles([this._updatingHandles.add(()=>this.analysisViewData?.elevationAlignedObserver,t=>this._onObserverLocationChange(t),w),this._updatingHandles.add(()=>Ie(this.view.effectiveTheme),({glowColor:t,innerColor:e,globalAlpha:i})=>this._updateLaserLineStyle(t,e,i),w),this._updatingHandles.add(()=>this._laserLineRendererDependencies(),t=>this._updateLaserLineRenderer(t)),this._connectComputations(),this._updatingHandles.addWhen(()=>!this._shouldRenderTracker,()=>this._clearCursorTracker(),w),this._updatingHandles.add(()=>({active:this.active,hasGrabbedManipulators:this.hasGrabbedManipulators}),({active:t,hasGrabbedManipulators:e})=>{this._creationMode=!!t&&(this._creationMode||!e)},w)])}destroy(){this._updatingHandles=L(this._updatingHandles),this._manipulatorHandles=L(this._manipulatorHandles),this._analysisHandles=L(this._analysisHandles),this._observerManipulator=null,this._clearCursorTracker(),this._removeLaserLine(),this._intersector=null,this._set("analysis",null)}get state(){return this.active?!this.hasGrabbedManipulators||this._creationMode?N.Creating:N.Created:this.analysis.observer?.position!=null?N.Created:N.Ready}get cursor(){return this.active&&this._showTracker?"crosshair":null}get updating(){return this.analysisViewData!=null&&this.analysisViewData.updating||this._updatingHandles.updating}get _showTracker(){return this.active&&this._latestPointerMovePointerType==="mouse"}get _shouldRenderTracker(){return this._showTracker&&this.analysis.observer?.position!=null&&!this.hasGrabbedManipulators}continue(){this.view.activeTool=this}stop(){this.view.activeTool=null}onEditableChange(){this.analysisViewData.editable=this.internallyEditable}onInputEvent(t){switch(t.type){case"immediate-double-click":this._doubleClickHandler(t);break;case"key-down":this._keyDownHandler(t);break;case"pointer-move":this._pointerMoveHandler(t)}}onInputEventAfter(t){t.type==="immediate-click"&&this._clickHandler(t)}onShow(){}onHide(){}onDeactivate(){this._clearCursorTracker()}_connectComputations(){return this._updatingHandles.addOnCollectionChange(()=>this.analysisViewData.computations,t=>this._onComputationsCollectionChange(t),{initial:!0,final:!0})}_onComputationsCollectionChange({added:t,removed:e}){for(let i of e)this._disconnectComputation(i);for(let i of t)this._connectComputation(i)}_connectComputation(t){if(this.destroyed)return void W.getLogger(this).warn("Attempting to connect an analysis to a destroyed LineOfSight tool. Ignoring.");let e=this._analysisHandles;if(e.has(t))return;let i=this._createTargetManipulator(t.target);this._targetTrackerManipulator==null&&i.metadata.target===this.analysisViewData.cursorTarget&&(this._targetTrackerManipulator=i,this._targetTrackerManipulator.available=!1,this._targetTrackerManipulator.interactive=!1,this._updateLaserLineRenderer()),e.add([this._updatingHandles.add(()=>ze(t),()=>Ge(i,t),w),this._updatingHandles.add(()=>t.elevationAlignedTargetLocation,n=>this._onTargetLocationChange(n,i),w)],t)}_disconnectComputation(t){if(this.destroyed)return void W.getLogger(this).warn("Attempting to disconnect an analysis from a destroyed LineOfSight tool. Ignoring.");this._analysisHandles.remove(t);let e=this._getTargetManipulator(t.target);e!=null&&(this.manipulators.remove(e),this._manipulatorHandles.remove(e),this._targetTrackerManipulator!=null&&this._targetTrackerManipulator===e&&(this._targetTrackerManipulator=null))}_clearCursorTracker(){this.analysisViewData.cursorTarget=L(this.analysisViewData.cursorTarget)}_createTargetManipulator(t){let e={target:t,type:"target"},i=new vt(this.view,e);return this._manipulatorHandles.add([this._createTargetManipulatorDragPipeline(i),i.events.on("grab-changed",n=>this._manipulatorGrabChanged(i,n)),i.events.on("immediate-click",n=>this._manipulatorClick(i,n))],i),this.manipulators.add(i),t.position!=null?i.elevationAlignedLocation=t.position:i.available=!1,i}_getTargetManipulator(t){let e=null;return this.manipulators.forEach(i=>{let n=i.manipulator;e==null&&n.metadata.type==="target"&&n.metadata.target===t&&(e=n)}),e}_createObserverManipulator(){let t=new gt(this.view,{type:"observer",intersection:null});return this._manipulatorHandles.add([this._createObserverManipulatorDragPipeline(t),t.events.on("grab-changed",e=>this._manipulatorGrabChanged(t,e)),t.events.on("immediate-click",e=>this._manipulatorClick(t,e))],t),this.manipulators.add(t),t}_screenToIntersection(){return t=>{let e=this._intersector.getScreenPointIntersection(t.screenEnd);return e==null?null:A(H({},t),{intersection:e})}}_createTargetManipulatorDragPipeline(t){return Mt(t,(e,i,n)=>{i.next(this._screenToIntersection()).next(this._updateTargetDragStep(t)).next(()=>this._updateLaserLineRenderer()),n.next(xe(t.metadata.target)).next(()=>this._updateLaserLineRenderer())})}_createObserverManipulatorDragPipeline(t){return Mt(t,(e,i,n)=>{i.next(this._screenToIntersection()).next(this._updateObserverDragStep()).next(()=>this._updateLaserLineRenderer()),n.next(this._cancelObserverDragStep()).next(()=>this._updateLaserLineRenderer())})}_updateObserverDragStep(){return t=>(t.intersection.mapPoint!=null?(this.analysis.observer==null&&(this.analysis.observer=new Pt),this._updateFromIntersection(this.analysis.observer,t.intersection)):this.analysis.observer=null,t)}_cancelObserverDragStep(){let t=this.analysis.observer?.position!=null?this.analysis.observer.clone():null;return e=>(this.analysis.observer=t,e)}_updateTargetDragStep(t){return e=>{this._updateFromIntersection(t.metadata.target,e.intersection);let i=e.intersection.mapPoint;return i!=null&&(t.elevationAlignedLocation=i),e}}_manipulatorGrabChanged(t,e){switch(e.action){case"start":this._grabbedManipulator=t;break;case"end":this._grabbedManipulator===t&&(this._grabbedManipulator=null)}}_laserLineRendererDependencies(){return{laserlineVisualElement:this._laserlineVisualElement,grabbedManipulator:this._grabbedManipulator,shouldRenderTracker:this._shouldRenderTracker,observerPosition:this.analysis.observer!=null?this.analysis.observer.position:null,visible:this.visible}}_updateLaserLineRenderer(t=this._laserLineRendererDependencies()){let{laserlineVisualElement:e,grabbedManipulator:i,shouldRenderTracker:n,observerPosition:s,visible:l}=t;if(e==null)return;let a=i??(n&&s!=null?this._targetTrackerManipulator:null);a!=null&&l?(e.visible=!0,e.heightManifoldTarget=a.renderLocation,a!==this._observerManipulator?e.lineVerticalPlaneSegment=le(this._observerManipulator.renderLocation,a.renderLocation,Fe):e.lineVerticalPlaneSegment=null):(e.visible=!1,e.heightManifoldTarget=null,e.lineVerticalPlaneSegment=null)}_createLaserLine(){this._removeLaserLine();let{glowWidth:t,innerWidth:e}=Le;this._laserlineVisualElement=new ye({view:this.view,attached:!0,visible:this.visible,style:{glowWidth:t,innerWidth:e},isDecoration:!0})}_removeLaserLine(){this._laserlineVisualElement!=null&&(this._laserlineVisualElement.destroy(),this._laserlineVisualElement=null)}_updateLaserLineStyle(t,e,i){let n=this._laserlineVisualElement;if(n==null)return;let s=n.style;n.style=A(H({},s),{glowColor:h.toUnitRGB(t),innerColor:h.toUnitRGB(e),globalAlpha:i})}_onObserverLocationChange(t){t!=null?(this._observerManipulator.metadata.intersection=null,this._observerManipulator.available=!0,this._observerManipulator.elevationAlignedLocation=t):this._observerManipulator.available=!1}_onTargetLocationChange(t,e){t!=null?(e.elevationAlignedLocation=t,e!==this._targetTrackerManipulator&&(e.available=!0)):e.available=!1}_addPointFromClickEvent(t){let e=this._intersector.getScreenPointIntersection(t);if(e?.mapPoint!=null)if(this.analysis.observer?.position!=null){this._clearCursorTracker();let i=new Vt;this._updateFromIntersection(i,e),this.analysis.targets.add(i)}else{let i=new Pt;this._updateFromIntersection(i,e),this.analysis.observer=i}}_clickHandler(t){this.active&&t.button!==pt.Right&&(this._addPointFromClickEvent(Dt(t)),t.stopPropagation())}_doubleClickHandler(t){this.active&&t.button!==pt.Right&&(this.stop(),t.stopPropagation())}_keyDownHandler(t){this.active&&t.key==="Escape"&&(this.stop(),t.stopPropagation())}_pointerMoveHandler(t){if(this.hasGrabbedManipulators||(this._latestPointerMovePointerType=t.pointerType,this._updateLaserLineRenderer(),!this._showTracker||this.analysis.observer?.position==null))return;let e=Dt(t),i=this._intersector.getScreenPointIntersection(e);i?.mapPoint!=null&&(this.analysisViewData.cursorTarget==null&&(this.analysisViewData.cursorTarget=new Vt),this._updateFromIntersection(this.analysisViewData.cursorTarget,i),this._updateLaserLineRenderer())}_updateFromIntersection(t,e){if(e.mapPoint==null)return t.position=null,t.elevationInfo=null,void(t.feature=null);switch(e.type){case Z.OBJECT:if(e.graphic!=null){let n=e.graphic,s=ce(n);s.mode==="on-the-ground"&&(s.mode="relative-to-ground",s.offset=0),t.elevationInfo=new Tt(s),t.feature=n}else t.elevationInfo=null,t.feature=null;break;case Z.TERRAIN:t.elevationInfo=new Tt({mode:"on-the-ground"}),t.feature=null;break;default:t.elevationInfo=null,t.feature=null}let i=e.mapPoint.clone();i.z=pe(this.view,i,{mode:"absolute-height",offset:0},t.elevationInfo),t.position=i}_manipulatorClick(t,e){if(t.metadata.type==="observer"||t.grabbing||t.dragging||e.button!==pt.Right||this.analysis.targets.length<=1)return;let{target:i}=t.metadata;this.analysis.targets.remove(i),e.stopPropagation()}get testInfo(){}};function xe(t){let e=t.position?.clone();return i=>(t.position=e,i)}function Ge(t,e){let{isValid:i,isTargetVisible:n}=e.computationResult;t.state=i?n?G.Custom1:G.Custom2:G.Custom3}function ze(t){let{isValid:e,isTargetVisible:i}=t.computationResult;return{isValid:e,isTargetVisible:i}}o([r({constructOnly:!0})],y.prototype,"view",void 0),o([r({constructOnly:!0})],y.prototype,"analysis",void 0),o([r()],y.prototype,"_creationMode",void 0),o([r({readOnly:!0})],y.prototype,"state",null),o([r({readOnly:!0})],y.prototype,"cursor",null),o([r()],y.prototype,"removeIncompleteOnCancel",void 0),o([r({readOnly:!0})],y.prototype,"updating",null),o([r({constructOnly:!0})],y.prototype,"analysisViewData",void 0),o([r({readOnly:!0})],y.prototype,"_showTracker",null),o([r()],y.prototype,"_latestPointerMovePointerType",void 0),o([r()],y.prototype,"_shouldRenderTracker",null),o([r()],y.prototype,"_laserlineVisualElement",void 0),o([r()],y.prototype,"_grabbedManipulator",void 0),y=o([O("esri.views.3d.analysis.LineOfSight.LineOfSightTool")],y);var Fe=ae();var ft=class{constructor(e,i,n,s){this.visibleLineVisualElement=e,this.occludedLineVisualElement=i,this.undefinedLineVisualElement=n,this.targetVisualElement=s}destroy(){this.visibleLineVisualElement.destroy(),this.occludedLineVisualElement.destroy(),this.undefinedLineVisualElement.destroy(),this.targetVisualElement.destroy()}};var V=class extends I{constructor(t){super(t),this._lineOfSightVisualElements=new Array,this._computationHandles=new j,this._updatingHandles=new q}initialize(){this.addHandles(this._connectComputations()),this._createObserverVisualization()}destroy(){this._updatingHandles=L(this._updatingHandles),this._computationHandles=L(this._computationHandles),this._observerVisualElement=L(this._observerVisualElement)}get visible(){return this.analysisViewData.visible}get updating(){return this._updatingHandles.updating}get interactiveAndEditable(){return this.analysisViewData.interactive&&this.analysisViewData.editable}get test(){}_createLineOfSightVisualization(){let t=ot,e=this.view,i=this.isDecoration,n={view:e,attached:!0,width:t.outerWidth,innerWidth:t.innerWidth,isDecoration:i},s=h.toUnitRGBA(t.visibleOuterColor),l=h.toUnitRGBA(t.visibleInnerColor),a=h.toUnitRGBA(t.occludedOuterColor),p=h.toUnitRGBA(t.occludedInnerColor),d=h.toUnitRGBA(t.undefinedOuterColor),c=h.toUnitRGBA(t.undefinedInnerColor),u=new ct(A(H({},n),{color:s,innerColor:l})),g=new ct(A(H({},n),{color:a,innerColor:p})),v=new ct(A(H({},n),{color:d,innerColor:c})),R=new kt(A(H({view:e,attached:!0},Se),{size:8,isDecoration:i})),S=new ft(u,g,v,R);return this._lineOfSightVisualElements.push(S),S}_destroyLineOfSightVisualization(t){t.destroy(),this._lineOfSightVisualElements.splice(this._lineOfSightVisualElements.indexOf(t),1)}_updateLineOfSightVisualization(t,e,i){let n=ot,{computationResult:s,inputPoints:l}=t,{start:a,end:p,intersection:d,isValid:c,isTargetVisible:u}=s,{observer:g}=l,v=Ne;v[12]=g[0],v[13]=g[1],v[14]=g[2];let R=U(je,a,g),S=U(Ue,p,g),J=U(Be,d,g),{visibleLineVisualElement:_,occludedLineVisualElement:F,undefinedLineVisualElement:T,targetVisualElement:E}=e,Re=this.analysisViewData.elevationAlignedObserver==null||t.elevationAlignedTargetLocation==null,$=this.visible&&!Re;_.visible=$,F.visible=$,T.visible=$,E.visible=$,E.attached=!i.interactiveAndEditable,$&&(_.geometry=null,F.geometry=null,T.geometry=null,E.geometry=t.elevationAlignedTargetLocation,c?u?(_.geometry=[[M(R),M(S)]],_.transform=v,_.color=h.toUnitRGBA(n.visibleOuterColor),E.color=h.toUnitRGBA(n.visibleInnerColor)):(_.geometry=[[M(R),M(J)]],_.transform=v,_.color=h.toUnitRGBA(n.occludedOuterColor),F.geometry=[[M(J),M(S)]],F.transform=v,E.color=h.toUnitRGBA(n.occludedInnerColor)):(T.geometry=[[M(R),M(S)]],T.transform=v,E.color=h.toUnitRGBA(n.undefinedInnerColor)))}_getLineOfSightVisualizationDependencies(t){let{computationResult:e}=t,{occludedOuterColor:i,visibleOuterColor:n}=ot;return{computationResult:e,occludedOuterColor:i,visibleOuterColor:n,visible:this.visible,interactiveAndEditable:this.interactiveAndEditable}}_connectComputation(t){let e=this._computationHandles;if(e.has(t))return;let i=this._createLineOfSightVisualization();e.add([this._updatingHandles.add(()=>this._getLineOfSightVisualizationDependencies(t),n=>this._updateLineOfSightVisualization(t,i,n),{initial:!0,equals:()=>!1}),rt(()=>this._destroyLineOfSightVisualization(i))],t)}_disconnectComputation(t){this._computationHandles.remove(t)}_connectComputations(){return this._updatingHandles.addOnCollectionChange(()=>this.analysisViewData.computations,t=>this._onComputationsCollectionChange(t),{initial:!0,final:!0})}_onComputationsCollectionChange({added:t,removed:e}){for(let i of e)this._disconnectComputation(i);for(let i of t)this._connectComputation(i)}_createObserverVisualization(){let t=h.toUnitRGBA(ot.visibleInnerColor),e=new kt(A(H({view:this.view,color:t},Se),{isDecoration:this.isDecoration}));this._observerVisualElement=e,this.addHandles(this._updatingHandles.add(()=>({observer:this.analysisViewData.elevationAlignedObserver,interactiveAndEditable:this.interactiveAndEditable,visible:this.visible}),({observer:i,interactiveAndEditable:n,visible:s})=>{i!=null&&!n&&s?(e.geometry=i,this._observerVisualElement.attached=!0):e.attached=!1},w))}};o([r({constructOnly:!0})],V.prototype,"analysis",void 0),o([r({constructOnly:!0})],V.prototype,"analysisViewData",void 0),o([r({constructOnly:!0})],V.prototype,"view",void 0),o([r({readOnly:!0})],V.prototype,"visible",null),o([r({constructOnly:!0})],V.prototype,"isDecoration",void 0),o([r()],V.prototype,"updating",null),o([r()],V.prototype,"interactiveAndEditable",null),o([r()],V.prototype,"test",null),V=o([O("esri.views.3d.analysis.LineOfSight.LineOfSightVisualization")],V);var Se={size:6,pixelSnappingEnabled:!1,primitive:"circle",elevationInfo:{mode:"absolute-height",offset:0},outlineSize:0},je=m(),Ue=m(),Be=m(),Ne=ie();var b=class extends ge(st.EventedMixin(I)){constructor(t){super(t),this.type="line-of-sight-view-3d",this.analysis=null,this.tool=null,this.computations=new Kt,this.elevationAlignedObserver=null,this.observerEngineLocation=m(),this.cursorTarget=null,this.editable=!0}initialize(){let t=this.view,e=this.analysis;this._analysisController=new f({analysis:e,analysisViewData:this,view:t}),this._analysisVisualization=new V({analysis:e,analysisViewData:this,view:t,isDecoration:!this.parent}),this.addHandles([this._analysisController.on("result-changed",i=>{i.target!==this.cursorTarget&&this.emit("result-changed",i)}),Ce(this,y)])}destroy(){Oe(this),this._analysisController=L(this._analysisController),this._analysisVisualization=L(this._analysisVisualization)}get results(){return this.computations.map(t=>t.result)}get priority(){return this._analysisController.priority}set priority(t){this._analysisController.priority=t}get updating(){return this._analysisController!=null&&this._analysisController.updating||this._analysisVisualization!=null&&this._analysisVisualization.updating}getResultForTarget(t){return this.computations.find(e=>e.target===t)?.result}get testInfo(){}};o([r({readOnly:!0})],b.prototype,"type",void 0),o([r({constructOnly:!0,nonNullable:!0})],b.prototype,"analysis",void 0),o([r()],b.prototype,"tool",void 0),o([r({readOnly:!0})],b.prototype,"results",null),o([r()],b.prototype,"priority",null),o([r()],b.prototype,"computations",void 0),o([r()],b.prototype,"elevationAlignedObserver",void 0),o([r()],b.prototype,"observerEngineLocation",void 0),o([r()],b.prototype,"cursorTarget",void 0),o([r()],b.prototype,"updating",null),o([r()],b.prototype,"editable",void 0),o([r()],b.prototype,"_analysisController",void 0),o([r()],b.prototype,"_analysisVisualization",void 0),b=o([O("esri.views.3d.analysis.LineOfSightAnalysisView3D")],b);var $o=b;export{$o as default};
