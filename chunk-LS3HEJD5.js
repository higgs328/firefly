import{a as J,b as pe,c as ge}from"./chunk-22XPHE6T.js";import{a as S}from"./chunk-XLBN5ML4.js";import{a as ue,b as ce,c as M,d as he,e as D}from"./chunk-VGJUP3IY.js";import{a as ne}from"./chunk-BRJ4IROM.js";import{a as N,b as ae}from"./chunk-VP2YX4L2.js";import{a as le}from"./chunk-FPCHE4I2.js";import{a as ie}from"./chunk-456M7HFK.js";import{a as A}from"./chunk-LAX5536Z.js";import{a as oe}from"./chunk-XAGMDNNR.js";import{a as I}from"./chunk-DO7UF2F2.js";import{a as se}from"./chunk-7B6U3N62.js";import{a as re}from"./chunk-BPWNCOXC.js";import{a as te}from"./chunk-AVMO6LCR.js";import{a as O}from"./chunk-DKGGDYJI.js";import{c as C}from"./chunk-VIEK2X23.js";import{a as ee}from"./chunk-7F5DJLJT.js";import{b as U}from"./chunk-UST6HCE7.js";import{f as z}from"./chunk-WFKZLI6F.js";import{b as K}from"./chunk-X2B63YVS.js";import{a as Y,e as G,j as $}from"./chunk-TG45K3WR.js";import{b as X}from"./chunk-ACP3S2CH.js";import{a as q}from"./chunk-T7DXJKX7.js";import{a as l}from"./chunk-QGVBCWUY.js";import{H as j}from"./chunk-MYO4NP2N.js";import{e as n}from"./chunk-NFIPKH6V.js";import{l as Z}from"./chunk-5QEXLALV.js";import{B as x,F as Q,i as P}from"./chunk-4PTIEWMT.js";import{b as m}from"./chunk-YOFFGXOB.js";import{g}from"./chunk-XRGPJ3QY.js";import{e as W}from"./chunk-6MRUJ2UW.js";import{y as L}from"./chunk-QBWJMFH5.js";import{a as F,f as c}from"./chunk-VTHXE323.js";function p(e,t){return e.hasOwnProperty(t)&&e[t]!=null&&e[t]!==""}var we=()=>U("esri/widgets/Search/t9n/Search"),de="highlight",R=X.ofType({key:e=>e.layer?"layer":"locator",base:ne,typeMap:{layer:S,locator:D}}),me=ee.WGS84,be="esri/images/search/search-symbol-32.png",xe=/<[\s\S]*?>/g,_=-1,a=class extends le(q.EventedMixin(j)){constructor(e){super(e),this._gotoController=null,this._searching=null,this._updatingPromise=null,this._createdFeatureLayers=[],this.autoNavigate=!0,this.autoSelect=!0,this.defaultPopupTemplate=null,this.defaultSources=new R,this.defaultSymbols={point:new oe({url:K(be),size:24,width:24,height:24}),polyline:new te({color:[130,130,130,1],width:2}),polygon:new re({color:[235,235,235,.4],outline:{color:[130,130,130,1],width:2}})},this.includeDefaultSources=!0,this.maxInputLength=128,this.maxResults=6,this.maxSuggestions=6,this.messages=null,this.minSuggestCharacters=3,this.popupEnabled=!0,this.popupTemplate=null,this.portal=O.getDefault(),this.resultCount=null,this.resultGraphicEnabled=!0,this.resultGraphic=null,this.results=null,this.selectedSuggestion=null,this.searchAllEnabled=!0,this.selectedResult=null,this.sources=new R,this.suggestionDelay=350,this.suggestionCount=null,this.suggestions=null,this.suggestionsEnabled=!0,this.view=null}initialize(){let e=()=>c(this,null,function*(){let t=yield we();this.messages=t,this.defaultPopupTemplate=new I({title:t.searchResult,content:"{Match_addr}"})});e(),this.addHandles([Y(()=>[this.includeDefaultSources,this.view,this.portal],()=>this._update(),$),z(e)])}destroy(){this._destroyFeatureLayers(),this._abortGoTo(),this.clearGraphics()}get activeSource(){return this.allSources.at(this.activeSourceIndex)??null}get activeSourceIndex(){return this.allSources.length===1||!this.searchAllEnabled?0:_}set activeSourceIndex(e){this._overrideIfSome("activeSourceIndex",e)}get allPlaceholder(){return this.messages?.allPlaceholder}set allPlaceholder(e){this._overrideIfSome("allPlaceholder",e)}get allSources(){let{sources:e,defaultSources:t,includeDefaultSources:s}=this,r=typeof s=="function"?s.call(null,{sources:e,defaultSources:t}):s?t.concat(e):e,o=this._get("allSources")||new R;return o.removeAll(),o.addMany(r.filter(Boolean)),o}get locationEnabled(){return this._get("locationEnabled")||J()}set locationEnabled(e){if(e===void 0)return void this._clearOverride("locationEnabled");let t=J();if(e&&!t){let s=new m("locationEnabled:geolocation-unsupported","Geolocation API is unsupported.",{geolocation:navigator.geolocation});g.getLogger(this).error(s)}this._override("locationEnabled",!!e&&t)}get placeholder(){let{allSources:e,activeSourceIndex:t,allPlaceholder:s}=this;return t===_?s??"":e.at(t)?.placeholder??""}set searchTerm(e){this._set("searchTerm",e||""),this.clearGraphics(),this.selectedSuggestion&&this.selectedSuggestion.text!==e&&this._set("selectedSuggestion",null),e===""&&this._clear()}get searchTerm(){return this._get("searchTerm")||""}get state(){return this._searching?"searching":this.updating?"loading":this.allSources.length===0?"disabled":"ready"}get updating(){return this._updatingPromise!=null}clear(){this.searchTerm=""}clearGraphics(){this._removeHighlight(),this._closePopup();let{view:e,resultGraphic:t}=this;e&&t&&e.graphics.remove(t),this._set("resultGraphic",null)}search(e,t){this.emit("search-start"),this.clearGraphics();let s=this._createSuggestionForSearch(e),r=c(this,null,function*(){try{yield this.when();let o=yield this._getResultsFromSources(s,t);if(t?.signal?.aborted)return null;let i={activeSourceIndex:this.activeSourceIndex,searchTerm:s.text??"",numResults:0,numErrors:0,errors:[],results:[]};this._formatResponse(i,o,s);let u=this._getFirstResult(i.results),h=s.location&&u?u.name:s.text,y=h?.replace(xe,"");return this._set("searchTerm",y),(s.key&&typeof s.sourceIndex=="number"||s.location)&&this._set("selectedSuggestion",s),this._set("results",i.results),this._set("resultCount",i.results.reduce((v,d)=>v+(d.results?.length??0),0)),this.emit("search-complete",i),yield this._selectFirstResult(u),i}finally{this._clearSearching()}});return this._searching=r,r}searchNearby(e){return c(this,null,function*(){if(!this.locationEnabled){let s=new m("searchNearby:geolocation-unsupported","Geolocation API is unsupported.",{geolocation:navigator.geolocation});throw g.getLogger(this).error(s),s}let t=c(this,null,function*(){try{let s=yield pe(),r=yield ge({position:s,view:this.view},e);return yield this.search(r,e)}finally{this._clearSearching()}});return this._searching=t,t})}select(e){return c(this,null,function*(){if(this.clearGraphics(),!e){let f=new m("select:missing-parameter","Cannot select without a searchResult.",{searchResult:e});throw g.getLogger(this).error(f),f}let{view:t}=this,s=p(e,"sourceIndex")?e.sourceIndex:this._getSourceIndexOfResult(e),r=s!=null?this.allSources.at(s):null;if(!r){let f=new m("select:missing-source","Cannot select without a source.",{source:r});throw g.getLogger(this).error(f),f}let o=r instanceof S?this._getLayerSourcePopupTemplate(r):r.popupTemplate,i=r.resultSymbol||this._getDefaultSymbol(e),u=p(r,"resultGraphicEnabled")?r.resultGraphicEnabled:this.resultGraphicEnabled,h=p(r,"autoNavigate")?r.autoNavigate:this.autoNavigate,y=p(r,"popupEnabled")?r.popupEnabled:this.popupEnabled,v=y?o||this.popupTemplate||this.defaultPopupTemplate:null,{feature:d}=e;if(!d){let f=new m("select:missing-feature","Cannot select without a feature.",{feature:d});throw g.getLogger(this).error(f),f}let{attributes:ye,geometry:T,layer:fe,sourceLayer:Se}=d,E=T?N(T):null,_e={layerViewQuery:this._getLayerView(d),elevationQuery:t&&E!=null?ae(E,t):Promise.resolve(E)},V=yield x(_e),w=V.layerViewQuery.value,ve=V.elevationQuery.value;i instanceof se&&(i.text=e.name);let H=t&&h?e.target||e.extent:null;yield H!=null?this._goToSearchResult(H):Promise.resolve();let b=w?d:new A({geometry:T,symbol:i,attributes:ye,layer:fe,sourceLayer:Se,popupTemplate:v}),k=t?.popup,B=k&&y&&b.getEffectivePopupTemplate(k.defaultPopupTemplateEnabled);return B&&(yield t.openPopup({features:[b],location:ve})),w&&ie(w)&&!B&&this._highlightFeature({graphic:b,layerView:w}),!w&&u&&t&&t.graphics.push(b),this._setResultFloor(e),this._set("selectedResult",e),this._set("resultGraphic",b),this.emit("select-result",{result:e,source:r,sourceIndex:s}),e})}suggest(e,t,s){return c(this,null,function*(){let r=e||this.searchTerm;this.emit("suggest-start",{searchTerm:r}),yield this._suggestTimer(t,s);let o=yield this._suggestImmediate(r,s);return this._set("suggestions",o?.results),this._set("suggestionCount",o?.results.reduce((i,u)=>i+(u.results?.length??0),0)??null),this.emit("suggest-complete",o),o})}when(){return c(this,null,function*(){yield G(()=>!this.updating)})}_update(){return c(this,null,function*(){let{portal:e,view:t}=this;if(this.includeDefaultSources){let s=this._updatingPromise=x([e?.load(),t?.when()]);if(this.destroyed||(yield s,s!==this._updatingPromise))return}yield G(()=>this.messages),this.destroyed||this._updateDefaultSources(),this._updatingPromise=null})}_clearSearching(){this._searching=null}_convertHelperServices(){let e=this.portal?.helperServices?.geocode;return e?e.map(t=>{if(t.placefinding===!1)return;let s=W.apiKey&&M(t.url)?{url:he}:null,r=D.fromJSON(F(F({},t),s)),o=r.url;if(M(o)||ce(o)||ue(o)){let i=r.outFields??["Addr_type","Match_addr","StAddr","City"],u=(r.placeholder||this.messages?.placeholder)??"",h=typeof r.defaultZoomScale=="number"?r.defaultZoomScale:2500;r.singleLineFieldName="SingleLine",r.outFields=i,r.placeholder=u,r.defaultZoomScale=h}return r.singleLineFieldName?r:void 0}).filter(L):[]}_destroyFeatureLayers(){this._createdFeatureLayers.forEach(e=>e?.destroy()),this._createdFeatureLayers=[]}_getLayerSources(e,t){let s=this.view?.map;return e.map(r=>{let o=s.findLayerById(r.id);if(!o)return;let i=this._getLayerJSON(r),u=S.fromJSON(i);return u.placeholder=t,this._getLayer(o,i).then(h=>{u.layer=h}),u}).filter(L).toArray()}_getTableSources(e,t){let s=this.view?.map;return e.map(r=>{if(!r.id)return;let o=s.findTableById(r.id);if(!o)return;let i=this._getLayerJSON(r),u=S.fromJSON(i);return u.placeholder=t,this._getLayer(o,i).then(h=>{u.layer=h}),u}).filter(L).toArray()}_convertApplicationProperties(){let e=this.view?.map,t=e?.applicationProperties?.viewing?.search;if(!t)return[];let{enabled:s,hintText:r,layers:o,tables:i}=t;return s?[...this._getLayerSources(o,r),...this._getTableSources(i,r)]:[]}_getSubLayer(e,t){return c(this,null,function*(){if(yield e.load(),!e.allSublayers)throw new Error;let s=e.allSublayers.find(o=>o.id===t.subLayer);if(!s)throw new Error;let r=yield s.createFeatureLayer?.();if(!r)throw new Error;return this._createdFeatureLayers.push(r),r})}_getBuildingSubLayer(e,t){return c(this,null,function*(){yield e.load();let s=e.allSublayers.find(r=>r.id===t.subLayer);if(s?.type!=="building-component")throw new Error;if(yield s.load(),s.associatedLayer==null)throw new Error;return yield s.associatedLayer.load(),s})}_getLayer(e,t){return c(this,null,function*(){if(e.type==="feature"||e.type==="scene"||e.type==="csv"||e.type==="geojson"||e.type==="ogc-feature")return e;if(e.type==="map-image")try{return yield this._getSubLayer(e,t)}catch{let r=new m("search:create-featurelayer","Could not create a FeatureLayer from the MapImageLayer",{layer:e});return g.getLogger(this).error(r),null}return e.type==="building-scene"?this._getBuildingSubLayer(e,t):null})}_getLayerJSON(e){return typeof e.toJSON=="function"?e.toJSON():e}_updateDefaultSources(){let{defaultSources:e,includeDefaultSources:t}=this;this._destroyFeatureLayers(),e.removeAll(),t&&e.addMany([...this._convertApplicationProperties(),...this._convertHelperServices()])}_abortGoTo(){this._gotoController&&this._gotoController.abort(),this._gotoController=null}_clear(){this._abortGoTo(),this._set("resultCount",null),this._set("results",null),this._set("suggestions",null),this._set("suggestionCount",null),this._set("selectedResult",null),this._set("selectedSuggestion",null),this.emit("search-clear")}_closePopup(){let e=this.view?.popup,{resultGraphic:t}=this;if(!e||!t)return;let s="selectedFeature"in e,r=s?e.selectedFeature:null;s&&r&&r===t&&e.close()}_suggestTimer(e,t){let s=e??this.suggestionDelay;return Q(s,null,t?.signal)}_createLocationForSearch(e){return e instanceof A&&e.geometry?N(e.geometry):e instanceof C?e:Array.isArray(e)&&e.length===2?new C({longitude:e[0],latitude:e[1]}):null}_createSuggestionForSearch(e){if(e&&p(e,"key")&&p(e,"text")&&p(e,"sourceIndex"))return e;let t=this._createLocationForSearch(e),s=typeof e=="string"?e:this.searchTerm,{selectedSuggestion:r,selectedResult:o}=this,i=!e&&r&&o,u=i&&r.key===o.key&&r.sourceIndex===o.sourceIndex,h=i&&r.location;return u||h?r:{location:t,text:t?"":s,sourceIndex:null,key:null}}_getFirstResult(e){return P(e,({results:t})=>t?.[0])??null}_selectFirstResult(e){return c(this,null,function*(){return this.autoSelect&&e?this.select(e):null})}_suggestImmediate(e,t){return c(this,null,function*(){yield this.when();let s=yield this._getSuggestionsFromSources(e,t);if(t?.signal?.aborted)return null;let r={activeSourceIndex:this.activeSourceIndex,searchTerm:e??"",numResults:0,numErrors:0,errors:[],results:[]};return this._formatResponse(r,s),r})}_formatSourceResponse(e,t,s){let r=t?.value||[],o=t?.error,i=this.allSources.at(s);if(o){let u={sourceIndex:s,source:i,error:o};e.errors.push(u),g.getLogger(this).error(o),e.numErrors++}else{let u={sourceIndex:s,source:i,results:r};e.results.push(u),e.numResults+=r.length}}_formatResponse(e,t,s){if(t)if(e.activeSourceIndex===_){let r=s&&p(s,"sourceIndex")&&s.sourceIndex!==-1?s.sourceIndex:void 0;t.forEach((o,i)=>{let u=r!==void 0?r:i;this._formatSourceResponse(e,o,u)})}else this._formatSourceResponse(e,t[0],e.activeSourceIndex)}_getResultsFromSources(e,t){return c(this,null,function*(){let{allSources:s}=this,r=!e.location&&p(e,"sourceIndex")?e.sourceIndex:this.activeSourceIndex,o=[];if(!s.length){let i=new m("search:no-sources-defined","At least one source is required.",{allSources:s});throw g.getLogger(this).error(i),i}return r===_?s.forEach((i,u)=>{o.push(this._getResultsFromSource(e,u,t))}):o.push(this._getResultsFromSource(e,r,t)),x(o)})}_getSuggestionsFromSources(e,t){return c(this,null,function*(){let{allSources:s,activeSourceIndex:r}=this,o=[];if(!s.length){let i=new m("suggest:no-sources-defined","At least one source is required.",{allSources:s});throw g.getLogger(this).error(i),i}return r===_?s.forEach((i,u)=>{o.push(this._getSuggestionsFromSource(e,u,t))}):o.push(this._getSuggestionsFromSource(e,r,t)),x(o)})}_getResultsFromSource(e,t,s){return c(this,null,function*(){let r=t!=null?this.allSources.at(t):null;if(!r)return null;let{location:o=null}=e,i=this.view?.spatialReference||me,u=p(r,"maxResults")?r.maxResults:this.maxResults,h=!!(r instanceof S&&p(r,"exactMatch"))&&r.exactMatch,{view:y}=this;return r.getResults?.({view:y,sourceIndex:t,location:o,suggestResult:e,spatialReference:i,exactMatch:h,maxResults:u},s)})}_getSuggestionsFromSource(e,t,s){return c(this,null,function*(){let r=this.allSources.at(t);if(!r)return null;e??="";let o=p(r,"suggestionsEnabled")?r.suggestionsEnabled:this.suggestionsEnabled,i=e?.length,u=p(r,"minSuggestCharacters")?r.minSuggestCharacters:this.minSuggestCharacters;if(o&&e.trim()&&i>=u){let h=this.view?.spatialReference||me,y=p(r,"maxSuggestions")?r.maxSuggestions:this.maxSuggestions,{view:v}=this,d=!!(r instanceof S&&p(r,"exactMatch"))&&r.exactMatch;return r.getSuggestions?.({view:v,sourceIndex:t,suggestTerm:e,spatialReference:h,maxSuggestions:y,exactMatch:d},s)}return null})}_getLayerSourcePopupTemplate(e){let{layer:t}=e;if(t)return p(e,"popupTemplate")?e.popupTemplate:t.popupTemplate}_getSourceIndexOfResult(e){return P(this.results??[],({results:t,sourceIndex:s})=>t?.includes(e)?s:null)??null}_goToSearchResult(e){return c(this,null,function*(){this._abortGoTo();let t=new AbortController;this._gotoController=t;let s={target:{target:e},options:{signal:t.signal}};e||(s.options.animate=!1),yield this.callGoTo(s),this._gotoController=null})}_getDefaultSymbol(e){let{defaultSymbols:t}=this,s=e.feature?.geometry;if(s==null)return null;switch(s.type){case"point":case"multipoint":return t.point;case"polyline":return t.polyline;case"extent":case"polygon":return t.polygon;default:return null}}_removeHighlight(){this.removeHandles(de)}_getLayerView(e){return c(this,null,function*(){let{view:t}=this;if(!e||!t||e.layer?.type==="building-component"||e.layer?.type==="subtype-sublayer")return null;let{layer:s}=e;return s?(yield t.when(),t.whenLayerView(s)):null})}_highlightFeature(e){let{graphic:t,layerView:s}=e,{attributes:r,layer:o}=t,{objectIdField:i}=o,u=(i&&r?.[i])??null,h=s.highlight(u??t);this.addHandles(h,de)}_setResultFloor(e){let{view:t}=this,s=e.feature?.attributes,r=e.feature?.sourceLayer;if(r&&"floorInfo"in r&&r?.floorInfo?.floorField&&s){let o=s[r.floorInfo.floorField];t?.emit("select-result-floor",o)}}};a.ALL_INDEX=_,l([n()],a.prototype,"_searching",void 0),l([n()],a.prototype,"_updatingPromise",void 0),l([n({readOnly:!0,value:null})],a.prototype,"activeSource",null),l([n()],a.prototype,"activeSourceIndex",null),l([n()],a.prototype,"allPlaceholder",null),l([n({readOnly:!0})],a.prototype,"allSources",null),l([n()],a.prototype,"autoNavigate",void 0),l([n()],a.prototype,"autoSelect",void 0),l([n({type:I})],a.prototype,"defaultPopupTemplate",void 0),l([n({readOnly:!0})],a.prototype,"defaultSources",void 0),l([n()],a.prototype,"defaultSymbols",void 0),l([n()],a.prototype,"includeDefaultSources",void 0),l([n()],a.prototype,"locationEnabled",null),l([n()],a.prototype,"maxInputLength",void 0),l([n()],a.prototype,"maxResults",void 0),l([n()],a.prototype,"maxSuggestions",void 0),l([n()],a.prototype,"messages",void 0),l([n()],a.prototype,"minSuggestCharacters",void 0),l([n({readOnly:!0})],a.prototype,"placeholder",null),l([n()],a.prototype,"popupEnabled",void 0),l([n({type:I})],a.prototype,"popupTemplate",void 0),l([n({type:O})],a.prototype,"portal",void 0),l([n()],a.prototype,"resultCount",void 0),l([n()],a.prototype,"resultGraphicEnabled",void 0),l([n({readOnly:!0})],a.prototype,"resultGraphic",void 0),l([n({readOnly:!0})],a.prototype,"results",void 0),l([n({readOnly:!0})],a.prototype,"selectedSuggestion",void 0),l([n()],a.prototype,"searchAllEnabled",void 0),l([n({readOnly:!0})],a.prototype,"selectedResult",void 0),l([n()],a.prototype,"searchTerm",null),l([n({type:R})],a.prototype,"sources",void 0),l([n({readOnly:!0})],a.prototype,"state",null),l([n()],a.prototype,"suggestionDelay",void 0),l([n()],a.prototype,"suggestionCount",void 0),l([n({readOnly:!0})],a.prototype,"suggestions",void 0),l([n()],a.prototype,"suggestionsEnabled",void 0),l([n({readOnly:!0})],a.prototype,"updating",null),l([n()],a.prototype,"view",void 0),l([n()],a.prototype,"clear",null),a=l([Z("esri.widgets.Search.SearchViewModel")],a);var it=a;export{it as a};
