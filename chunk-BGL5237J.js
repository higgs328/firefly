import{a as _}from"./chunk-NOHUHVCW.js";import{b as Y}from"./chunk-HH3C3QEN.js";import{c as Z}from"./chunk-2XTO2IAR.js";import{b as X}from"./chunk-VDNRZCIE.js";import{a as Q}from"./chunk-2MROBW6T.js";import{b as K}from"./chunk-YQNUGDFH.js";import{a as J,g as d}from"./chunk-ONYJLWAD.js";import{a as D}from"./chunk-YZJDOXQC.js";import{d as z}from"./chunk-5LG2P6MT.js";import{F as W,l as C}from"./chunk-GJ2QRXGN.js";import{d as H}from"./chunk-5L2EJ5RT.js";import{a as j}from"./chunk-RWCIDBNQ.js";import{l as q}from"./chunk-HM5RIVQC.js";import{e as k}from"./chunk-BOVYXYHK.js";import{o as L}from"./chunk-AUAZP44J.js";import{c as U}from"./chunk-RAI4DTMT.js";import{s as R}from"./chunk-4PTIEWMT.js";import{b as F}from"./chunk-YOFFGXOB.js";import{g as V}from"./chunk-XRGPJ3QY.js";import{f as g}from"./chunk-VTHXE323.js";var p=()=>V.getLogger("esri.views.3d.layers.graphics.objectResourceUtils"),B=class{constructor(t,a,e){this.resource=t,this.textures=a,this.cachedMemory=e}};function Ce(r,t){return g(this,null,function*(){let a=yield oe(r,t),e=yield ce(a.textureDefinitions??{},t),u=0;for(let o in e)if(e.hasOwnProperty(o)){let s=e[o];u+=s?.image?s.image.width*s.image.height*4:0}return new B(a,e,u+z(a))})}function oe(r,t){return g(this,null,function*(){let a=t?.streamDataRequester;if(a)return ie(r,a,t);let e=yield U(L(r,t));if(e.ok===!0)return e.value.data;R(e.error),ee(e.error)})}function ie(r,t,a){return g(this,null,function*(){let e=yield U(t.request(r,"json",a));if(e.ok===!0)return e.value;R(e.error),ee(e.error.details.url)})}function ee(r){throw new F("",`Request for object resource failed: ${r}`)}function ue(r){let t=r.params,a=t.topology,e=!0;switch(t.vertexAttributes||(p().warn("Geometry must specify vertex attributes"),e=!1),t.topology){case"PerAttributeArray":break;case"Indexed":case null:case void 0:{let o=t.faces;if(o){if(t.vertexAttributes)for(let s in t.vertexAttributes){let i=o[s];i?.values?(i.valueType!=null&&i.valueType!=="UInt32"&&(p().warn(`Unsupported indexed geometry indices type '${i.valueType}', only UInt32 is currently supported`),e=!1),i.valuesPerElement!=null&&i.valuesPerElement!==1&&(p().warn(`Unsupported indexed geometry values per element '${i.valuesPerElement}', only 1 is currently supported`),e=!1)):(p().warn(`Indexed geometry does not specify face indices for '${s}' attribute`),e=!1)}}else p().warn("Indexed geometries must specify faces"),e=!1;break}default:p().warn(`Unsupported topology '${a}'`),e=!1}r.params.material||(p().warn("Geometry requires material"),e=!1);let u=r.params.vertexAttributes;for(let o in u)u[o].values||(p().warn("Geometries with externally defined attributes are not yet supported"),e=!1);return e}function qe(r,t){let a=new Array,e=new Array,u=new Array,o=new _,s=r.resource,i=D.parse(s.version||"1.0","wosr");me.validate(i);let I=s.model.name,w=s.model.geometries,v=s.materialDefinitions??{},b=r.textures,A=0,y=new Map;for(let P=0;P<w.length;P++){let h=w[P];if(!ue(h))continue;let N=pe(h),O=h.params.vertexAttributes,T=[],re=n=>{if(h.params.topology==="PerAttributeArray")return null;let l=h.params.faces;for(let c in l)if(c===n)return l[c].values;return null},$=O[j.POSITION],ae=$.values.length/$.valuesPerElement;for(let n in O){let l=O[n],c=l.values,E=re(n)??H(ae);T.push([n,new K(c,E,l.valuesPerElement,!0)])}let f=N.texture,m=b&&b[f];if(m&&!y.has(f)){let{image:n,parameters:l}=m,c=new X(n,l);e.push(c),y.set(f,c)}let G=y.get(f),se=G?G.id:void 0,M=N.material,x=o.get(M,f);if(x==null){let n=v[M.slice(M.lastIndexOf("/")+1)].params;n.transparency===1&&(n.transparency=0);let l=m&&m.alphaChannelUsage,c=n.transparency>0||l==="transparency"||l==="maskAndTransparency",E=m?te(m.alphaChannelUsage):void 0,S={ambient:k(n.diffuse),diffuse:k(n.diffuse),opacity:1-(n.transparency||0),transparent:c,textureAlphaMode:E,textureAlphaCutoff:.33,textureId:se,doubleSided:!0,cullFace:J.None,colorMixMode:n.externalColorMixMode||"tint",textureAlphaPremultiplied:m?.parameters.preMultiplyAlpha??!1};t?.materialParameters&&Object.assign(S,t.materialParameters),x=new Y(S,t),o.set(M,f,x)}u.push(x);let ne=new Z(x,T);A+=T.find(n=>n[0]===j.POSITION)?.[1]?.indices.length??0,a.push(ne)}return{engineResources:[{name:I,stageResources:{textures:e,materials:u,geometries:a},pivotOffset:s.model.pivotOffset,numberOfVertices:A,lodThreshold:null}],referenceBoundingBox:le(a)}}function le(r){let t=W();return r.forEach(a=>{let e=a.boundingInfo;e!=null&&(C(t,e.bbMin),C(t,e.bbMax))}),t}function ce(r,t){return g(this,null,function*(){let a=new Array;for(let o in r){let s=r[o],i=s.images[0].data;if(!i){p().warn("Externally referenced texture data is not yet supported");continue}let I=s.encoding+";base64,"+i,w="/textureDefinitions/"+o,v=s.channels==="rgba"?s.alphaChannelUsage||"transparency":"none",b={noUnpackFlip:!0,wrap:{s:q.REPEAT,t:q.REPEAT},preMultiplyAlpha:te(v)!==d.Opaque},A=t?.disableTextures?Promise.resolve(null):Q(I,t);a.push(A.then(y=>({refId:w,image:y,parameters:b,alphaChannelUsage:v})))}let e=yield Promise.all(a),u={};for(let o of e)u[o.refId]=o;return u})}function te(r){switch(r){case"mask":return d.Mask;case"maskAndTransparency":return d.MaskBlend;case"none":return d.Opaque;default:return d.Blend}}function pe(r){let t=r.params;return{id:1,material:t.material,texture:t.texture,region:t.texture}}var me=new D(1,2,"wosr");export{Ce as a,qe as b};
