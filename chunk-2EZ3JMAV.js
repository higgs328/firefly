import{b as z}from"./chunk-VEL25CVB.js";import{a as O}from"./chunk-M3OAU7W5.js";import{b as B}from"./chunk-TUF2Y2FX.js";import{a as m}from"./chunk-CELWVZPW.js";import{b as W}from"./chunk-DYTVXYAV.js";import{a as f,e as D,j as _,k as M}from"./chunk-TG45K3WR.js";import{b as E}from"./chunk-ACP3S2CH.js";import{a as S}from"./chunk-T7DXJKX7.js";import{a as o}from"./chunk-QGVBCWUY.js";import{e as a}from"./chunk-NFIPKH6V.js";import{l as R}from"./chunk-5QEXLALV.js";import{j as T}from"./chunk-P6QFA5MM.js";import{F as V,y as I}from"./chunk-4PTIEWMT.js";import{g as A}from"./chunk-XRGPJ3QY.js";import{f as b}from"./chunk-VTHXE323.js";var N=1e4;function y(t){return t!=null&&t.count!==void 0}function w(t){return t!=null&&t.interval!==void 0}function q(t){return t!=null&&t.dates!==void 0}var s=class extends S.EventedAccessor{constructor(t){super(t),this._animationController=null,this._isViewTimeExtentInitialized=!1,this._timerId=null,this.actions=new E,this.fullTimeExtent=null,this.loop=!1,this.mode="time-window",this.stops={count:10},this.timeExtent=null,this.view=null}initialize(){this.addHandles([f(()=>this.effectiveStops,()=>{this.timeExtent==null&&(this.timeExtent=this._getDefaultTimeExtent())},_),f(()=>this.view,(t,e)=>{this._unregisterWidget(e),this._registerWidget(t)},M),f(()=>this.timeExtent,t=>{if(this.view==null)return;let e=this.view.timeExtent;(t!=null&&!t.isAllTime||e!=null&&!e.isAllTime)&&(t!=null&&e!=null&&t.equals(e)||(this.view.timeExtent=t))},_),f(()=>this.view?.timeExtent,t=>{this._isViewTimeExtentInitialized?(t!=null&&!t.isAllTime||this.timeExtent!=null&&!this.timeExtent.isAllTime)&&(t!=null&&this.timeExtent!=null&&t.equals(this.timeExtent)||(this.timeExtent=t)):this._isViewTimeExtentInitialized=!0})])}destroy(){this._timerId!=null&&(clearInterval(this._timerId),this._timerId=null),this._unregisterWidget(this.view),this.view=null,this._animationController!=null&&(this._animationController.abort(),this._animationController=null)}get effectiveStops(){let{fullTimeExtent:t,stops:e}=this;if(q(e)){let{dates:i}=e;if(i==null||i.length===0)return null;let l=i.sort((p,h)=>p.getTime()-h.getTime());if(t==null)return l;let{start:n,end:u}=t;return n==null||u==null?l:l.filter(p=>!(p.getTime()<n.getTime()||p.getTime()>u.getTime()))}if(y(e)){let i=e.timeExtent??t;return this._divideTimeExtentByCount(i,e.count)}if(w(e)){let i=e.timeExtent??t;return this._divideTimeExtentByInterval(i,e.interval)}return[]}set playRate(t){t<=0||t>36e5||(this.state==="playing"&&this._startAnimation(),this._set("playRate",t))}get state(){return this.fullTimeExtent==null?"disabled":this._animationController!=null?"playing":"ready"}get timeExtentValues(){let{mode:t,timeExtent:e}=this;if(e==null||e.isAllTime||e.isEmpty)return null;let{start:i,end:l}=e;switch(t){case"cumulative-from-end":case"instant":return i!=null?[i.getTime()]:null;case"cumulative-from-start":return l!=null?[l.getTime()]:null;case"time-window":return i!=null&&l!=null?[i.getTime(),l.getTime()]:null}}next(){this._step({forward:!0,allowRestart:!1})}play(){this._startAnimation()}previous(){this._step({forward:!1,allowRestart:!1})}stop(){this._stopAnimation()}triggerAction(t){this.emit("trigger-action",{action:t})}updateWebDocument(t){let e=new O({currentTimeExtent:this.timeExtent,fullTimeExtent:this.fullTimeExtent,loop:this.loop,numStops:y(this.stops)?this.stops.count:null,numThumbs:this.mode==="time-window"?2:1,stopDelay:this.playRate,stopInterval:w(this.stops)?this.stops.interval:null,stops:q(this.stops)?this.stops.dates:null});t.widgets?t.widgets.timeSlider=e:t.widgets=new z({timeSlider:e})}valuesToTimeExtent(t){if(t==null)return null;let e=t.sort((n,u)=>n-u).map(n=>new Date(n)),i=e.length>0?e[0]:null,l=e.length>1?e[1]:null;switch(this.mode){case"time-window":return new m({start:i,end:l});case"instant":return new m({start:i,end:i});case"cumulative-from-start":return new m({start:null,end:i});case"cumulative-from-end":return new m({start:i,end:null});default:return m.allTime}}_animate(){return b(this,null,function*(){try{let t=this.view,e=this._animationController?.signal;yield Promise.all([V(this.playRate,null,e),t!=null&&D(()=>t.updating===!1,e)])}catch(t){return I(t)||A.getLogger(this).error(t),void(this._animationController=null)}this._step({forward:!0,allowRestart:!1}),this._animationController!=null&&this._animate()})}_divideTimeExtentByCount(t,e=10){if(!t||!e)return[];let{start:i,end:l}=t;if(i==null||l==null)return[];if(e>N)return this._divideTimeExtentByCount(t);let n=[],u=i.getTime(),p=l.getTime()-u;for(let h=0;h<=e;h++)n.push(new Date(u+h/e*p));return n}_divideTimeExtentByInterval(t,e,i=N){if(!t||!e)return[];let{start:l,end:n}=t;if(l==null||n==null)return[];let u=n.getTime()-l.getTime(),p=e.toMilliseconds();if(p<=0||u/p>i)return this._divideTimeExtentByCount(t);let h=[],{value:g,unit:v}=e,r=l;for(;r.getTime()<=n.getTime();)h.push(new Date(r.getTime())),r=W(r,g,v);return h}_getDefaultTimeExtent(){let{effectiveStops:t,mode:e}=this;if(t==null||!e)return null;switch(e){case"time-window":return t.length>1?new m({start:t[0],end:t[1]}):null;case"cumulative-from-start":return t.length>0?new m({start:null,end:t[0]}):null;case"cumulative-from-end":return t.length>0?new m({start:t[0],end:null}):null;case"instant":return t.length>0?new m({start:t[0],end:t[0]}):null;default:return null}}_registerWidget(t){t!=null&&(t.persistableViewModels.includes(this)||t.persistableViewModels.add(this))}_startAnimation(){this._stopAnimation(),this._animationController=new AbortController,this._step({forward:!0,allowRestart:!0}),this._animate()}_step(t){let{forward:e,allowRestart:i}=t,{effectiveStops:l}=this;if(this.timeExtentValues==null||l==null)return;let n=l.map(r=>r.getTime()),u=this.timeExtentValues.map(r=>{let c=n.indexOf(r);if(c!==-1)return c;let x=n.reduce((d,C)=>Math.abs(C-r)<Math.abs(d-r)?C:d);return n.indexOf(x)}),p=u.map(r=>r+(e?1:-1)),h=p.some(r=>r<0||r>n.length-1),{loop:g,state:v}=this;if(h)if(g||i){let r=Math.min(...u),c=Math.max(...u),x=(e?u.map(d=>d-r):u.map(d=>d+(n.length-1-c))).map(d=>n[d]);this.timeExtent=this.valuesToTimeExtent(x)}else v==="playing"&&this.stop();else{let r=p.map(c=>n[c]);this.timeExtent=this.valuesToTimeExtent(r)}}_stopAnimation(){this._animationController!=null&&(this._animationController.abort(),this._animationController=null)}_unregisterWidget(t){t?.persistableViewModels.remove(this)}};o([a()],s.prototype,"_animationController",void 0),o([a({type:E})],s.prototype,"actions",void 0),o([a({readOnly:!0})],s.prototype,"effectiveStops",null),o([a({type:m})],s.prototype,"fullTimeExtent",void 0),o([a({nonNullable:!0})],s.prototype,"loop",void 0),o([a({nonNullable:!0})],s.prototype,"mode",void 0),o([a({nonNullable:!0,value:1e3})],s.prototype,"playRate",null),o([a({readOnly:!0})],s.prototype,"state",null),o([a({cast:t=>t==null?null:(w(t)&&(t.interval=T(B,t.interval)),(w(t)||y(t))&&(t.timeExtent=T(m,t.timeExtent)),t)})],s.prototype,"stops",void 0),o([a({type:m})],s.prototype,"timeExtent",void 0),o([a({readOnly:!0})],s.prototype,"timeExtentValues",null),o([a()],s.prototype,"view",void 0),o([a()],s.prototype,"next",null),o([a()],s.prototype,"play",null),o([a()],s.prototype,"previous",null),o([a()],s.prototype,"stop",null),o([a()],s.prototype,"updateWebDocument",null),s=o([R("esri.widgets.TimeSlider.TimeSliderViewModel")],s);var et=s;export{et as a};
