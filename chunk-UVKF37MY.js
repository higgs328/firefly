import{a as w}from"./chunk-GRP3SJZF.js";import{a as _}from"./chunk-QAJCY744.js";import{f as V}from"./chunk-WFKZLI6F.js";import{a as l,b as v,j as L}from"./chunk-TG45K3WR.js";import{b as f}from"./chunk-ACP3S2CH.js";import{a as d}from"./chunk-QGVBCWUY.js";import{H as m}from"./chunk-MYO4NP2N.js";import{b as I,e as h}from"./chunk-NFIPKH6V.js";import{l as g}from"./chunk-5QEXLALV.js";var c={state:"state",view:"view",allLayerViews:"all-layer-views",legendProperties:"legend-properties"},b=f.ofType(w),C=new Set(["esri.layers.BuildingSceneLayer","esri.layers.CatalogLayer","esri.layers.CSVLayer","esri.layers.FeatureLayer","esri.layers.GeoJSONLayer","esri.layers.GeoRSSLayer","esri.layers.GroupLayer","esri.layers.HeatmapLayer","esri.layers.ImageryLayer","esri.layers.ImageryTileLayer","esri.layers.MapImageLayer","esri.layers.OGCFeatureLayer","esri.layers.OrientedImageryLayer","esri.layers.ParquetLayer","esri.layers.PointCloudLayer","esri.layers.StreamLayer","esri.layers.SceneLayer","esri.layers.SubtypeGroupLayer","esri.layers.TileLayer","esri.layers.VoxelLayer","esri.layers.WFSLayer","esri.layers.WMSLayer","esri.layers.WMTSLayer","esri.layers.WCSLayer","esri.layers.LinkChartLayer","esri.layers.catalog.CatalogFootprintLayer","esri.layers.catalog.CatalogDynamicGroupLayer","esri.layers.knowledgeGraph.KnowledgeGraphSublayer","esri.layers.KnowledgeGraphLayer"]),E="view.basemapView.baseLayerViews",A="view.groundView.layerViews",H="view.basemapView.referenceLayerViews",S=[E,A,"view.layerViews",H],y=class extends m{constructor(e){super(e),this._layerViewByLayerId={},this._layerInfosByLayerViewId={},this._activeLayerInfosByLayerViewId={},this._activeLayerInfosWithNoParent=new f,this.activeLayerInfos=new b,this.basemapLegendVisible=!1,this.groundLegendVisible=!1,this.hideLayersNotInCurrentView=!1,this.keepCacheOnDestroy=!1,this.respectLayerDefinitionExpression=!1,this.respectLayerVisibility=!0,this.layerInfos=[],this.view=null}initialize(){this.addHandles(l(()=>this.view,()=>this._viewHandles(),L),c.view),this.addHandles(V(()=>this._refresh()))}destroy(){this._destroyViewActiveLayerInfos(),this.view=null}get state(){return this.view?.ready?"ready":"disabled"}_viewHandles(){this.removeHandles(c.state),this.view&&this.addHandles(l(()=>this.state,()=>this._stateHandles(),L),c.state)}_stateHandles(){this._resetAll(),this.state==="ready"&&this._watchPropertiesAndAllLayerViews()}_resetAll(){this.removeHandles([c.allLayerViews,c.legendProperties]),this._destroyViewActiveLayerInfos(),this.activeLayerInfos.removeAll()}_destroyViewActiveLayerInfos(){Object.keys(this._activeLayerInfosByLayerViewId).forEach(this._destroyViewActiveLayerInfo,this)}_destroyViewActiveLayerInfo(e){this.removeHandles(e);let i=this._activeLayerInfosByLayerViewId[e];delete this._activeLayerInfosByLayerViewId[e],i?.parent&&i.parent.children.remove(i)}_watchPropertiesAndAllLayerViews(){let{view:e}=this;if(!e)return;let{allLayerViews:i}=e;i.length&&this._refresh(),this.addHandles(i.on("change",t=>this._allLayerViewsChangeHandle(t)),c.allLayerViews),this.addHandles(l(()=>[this.layerInfos,this.basemapLegendVisible,this.groundLegendVisible],()=>this._propertiesChangeHandle()),c.legendProperties)}_allLayerViewsChangeHandle(e){e.moved.length?this._propertiesChangeHandle():(e.removed.forEach(i=>this._destroyViewActiveLayerInfo(i.uid)),this._refresh())}_propertiesChangeHandle(){this._destroyViewActiveLayerInfos(),this._refresh()}_refresh(){this._layerInfosByLayerViewId={},this.activeLayerInfos.removeAll(),this._generateLayerViews().filter(this._filterLayerViewsByLayerInfos,this).filter(this._isLayerViewSupported,this).forEach(this._generateActiveLayerInfo,this),this._sortActiveLayerInfos(this.activeLayerInfos)}_sortActiveLayerInfos(e){let i=this.view;if(e.length<2||!i)return;let t=[];e.forEach(r=>{if(!r.parent){let s=r.layer.parent,n=s&&"uid"in s&&this._layerViewByLayerId[s.uid],o=n&&this._activeLayerInfosByLayerViewId[n.uid];o&&e.includes(o)&&(t.push(r),r.parent=o,o.children.add(r),this._sortActiveLayerInfos(o.children))}}),e.removeMany(t);let a={};i.allLayerViews.forEach((r,s)=>a[r.layer.uid]=s),e.sort((r,s)=>{let n=a[r.layer.uid]||0;return(a[s.layer.uid]||0)-n})}_generateLayerViews(){let e=[];return S.filter(this._filterLayerViews,this).map(i=>I(this,i)).filter(i=>i!=null).forEach(this._collectLayerViews("layerViews",e)),e}_filterLayerViews(e){let i=!this.basemapLegendVisible&&(e===E||e===H),t=!this.groundLegendVisible&&e===A;return!i&&!t}_collectLayerViews(e,i){let t=a=>(a&&a.forEach(r=>{i.push(r),t(r[e])}),i);return t}_filterLayerViewsByLayerInfos(e){let i=this.layerInfos;return!i||!i.length||i.some(t=>this._hasLayerInfo(t,e))}_hasLayerInfo(e,i){let t=this._isLayerUIDMatching(e.layer,i.layer.uid);return t&&(this._layerInfosByLayerViewId[i.uid]=e),t}_isLayerUIDMatching(e,i){return e&&(e.uid===i||this._hasLayerUID(e.layers,i))}_hasLayerUID(e,i){return e&&e.some(t=>this._isLayerUIDMatching(t,i))}_isLayerViewSupported(e){return!!C.has(e.layer.declaredClass)&&(this._layerViewByLayerId[e.layer.uid]=e,!0)}_generateActiveLayerInfo(e){this._isLayerActive(e)?this._buildActiveLayerInfo(e):(this.removeHandles(e.uid),this.addHandles(l(()=>[e.legendEnabled,e.layer?.legendEnabled],()=>this._layerActiveHandle(e)),e.uid))}_layerActiveHandle(e){this._isLayerActive(e)&&(this.removeHandles(e.uid),this._buildActiveLayerInfo(e))}_isLayerActive(e){return!this.respectLayerVisibility||e.legendEnabled&&e.layer?.legendEnabled}_buildActiveLayerInfo(e){let i=e.layer,t=e.uid,a=this._layerInfosByLayerViewId[t],r=this._activeLayerInfosByLayerViewId[t];if(!r){let n=a?.title!==void 0&&a.layer.uid===i.uid;r=new w({layer:i,layerView:e,title:n?a.title:i.title,view:this.view??void 0,respectLayerDefinitionExpression:this.respectLayerDefinitionExpression,respectLayerVisibility:this.respectLayerVisibility,hideLayersNotInCurrentView:this.hideLayersNotInCurrentView,keepCacheOnDestroy:this.keepCacheOnDestroy,sublayerIds:a?.sublayerIds||[]}),this._activeLayerInfosByLayerViewId[t]=r}let s=i.parent&&"uid"in i.parent?this._layerViewByLayerId[i.parent?.uid]:null;if(r.parent=this._activeLayerInfosByLayerViewId[s?.uid],!this.hasHandles(t)){let n=[l(()=>i.title,o=>this._titleHandle(o,r)),l(()=>[i.opacity,"renderer"in i&&i.renderer,"pointSymbol"in i&&i.pointSymbol,"lineSymbol"in i&&i.lineSymbol,"polygonSymbol"in i&&i.polygonSymbol],()=>this._constructLegendElements(r)),v(()=>this.view?.stationary===!0,()=>this._scaleHandle(r),L),l(()=>e.layer?_(e.layer,e.view):null,()=>this._constructLegendElements(r)),l(()=>e.updating,()=>{e.layer!=null&&_(e.layer,e.view)!=null&&this._constructLegendElements(r)}),l(()=>"effect"in i&&i.effect,()=>this._constructLegendElements(r)),v(()=>this.view?.timeZone,()=>this._constructLegendElements(r),L)];if(this.respectLayerVisibility){let o=l(()=>e.legendEnabled,u=>this._legendEnabledHandle(u,r)),p=l(()=>i.legendEnabled,u=>this._legendEnabledHandle(u,r));n.push(o,p)}if(this.respectLayerDefinitionExpression&&"definitionExpression"in i){let o=l(()=>[i.definitionExpression,this.respectLayerDefinitionExpression],()=>{r.respectLayerDefinitionExpression=this.respectLayerDefinitionExpression,this._constructLegendElements(r)});n.push(o)}this.addHandles(n,t)}r.isScaleDriven||this._constructLegendElements(r),this._addActiveLayerInfo(r)}_titleHandle(e,i){i.title=e,this._constructLegendElements(i)}_legendEnabledHandle(e,i){e?this._addActiveLayerInfo(i):this._removeActiveLayerInfo(i)}_scaleHandle(e){(e.isScaleDriven||e.hideLayersNotInCurrentView)&&this._constructLegendElements(e)}_addActiveLayerInfo(e){let{layerView:i,layer:t}=e;if(this._isLayerActive(i)&&!this.activeLayerInfos.includes(e)){let a=e.parent;if(a)a.children.includes(e)||a.children.push(e),this._sortActiveLayerInfos(a.children);else{let r=this.layerInfos?.some(n=>n.layer.uid===t.uid),s=t.parent;s&&"uid"in s&&this._layerViewByLayerId[s.uid]&&!r?this._activeLayerInfosWithNoParent.add(e):(this.activeLayerInfos.add(e),this._sortActiveLayerInfos(this.activeLayerInfos))}if(this._activeLayerInfosWithNoParent.length){let r=[];this._activeLayerInfosWithNoParent.forEach(s=>{let n=s.layer.parent,o=n&&"uid"in n?this._layerViewByLayerId[n?.uid]:null,p=this._activeLayerInfosByLayerViewId[o?.uid];p&&(r.push(s),s.parent=p)}),r.length&&(this._activeLayerInfosWithNoParent.removeMany(r),r.forEach(s=>this._addActiveLayerInfo(s)))}}}_removeActiveLayerInfo(e){let i=e.parent;i?i.children.remove(e):this.activeLayerInfos.remove(e)}_constructLegendElements(e){let i=e.layer;"featureCollections"in i&&i.featureCollections?e.buildLegendElementsForFeatureCollections(i.featureCollections):"featureReduction"in i&&i.featureReduction&&"renderer"in i.featureReduction&&(i.featureReduction.type==="binning"||i.featureReduction.type==="cluster")&&(!this.view||i.featureReduction.maxScale<=this.view.scale)?e.buildLegendElementsForFeatureReduction(i.featureReduction):"renderer"in i&&i.renderer&&!("sublayers"in i)?e.buildLegendElementsForRenderer(i.renderer):"url"in i&&i.url&&i.type!=="catalog"&&i.type!=="knowledge-graph"?e.buildLegendElementsForTools():e.children.forEach(t=>this._constructLegendElements(t))}};d([h({type:b})],y.prototype,"activeLayerInfos",void 0),d([h()],y.prototype,"basemapLegendVisible",void 0),d([h()],y.prototype,"groundLegendVisible",void 0),d([h()],y.prototype,"hideLayersNotInCurrentView",void 0),d([h()],y.prototype,"keepCacheOnDestroy",void 0),d([h()],y.prototype,"respectLayerDefinitionExpression",void 0),d([h()],y.prototype,"respectLayerVisibility",void 0),d([h()],y.prototype,"layerInfos",void 0),d([h({readOnly:!0})],y.prototype,"state",null),d([h()],y.prototype,"view",void 0),y=d([g("esri.widgets.Legend.LegendViewModel")],y);var K=y;export{K as a};
