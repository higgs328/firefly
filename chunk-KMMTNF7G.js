import{d as p}from"./chunk-ERDKAICI.js";import{a as g}from"./chunk-7F5DJLJT.js";import{b as j}from"./chunk-YOFFGXOB.js";import{g as R}from"./chunk-XRGPJ3QY.js";import{a as P,b as T,f as F}from"./chunk-VTHXE323.js";var O=()=>R.getLogger("esri.support.arcadeOnDemand"),V=["geometry","scale","timeProperties"];function B(t,e){if(e!=null)for(let s of V)e.hasArcadeDependency(s)&&t.add(s);return t}var A;function Z(){return A||(A=F(this,null,function*(){let t=yield import("./chunk-WE5NG2HC.js");return{arcade:t.arcade,arcadeUtils:t,Dictionary:t.Dictionary,Feature:t.arcadeFeature,Voxel:t.Voxel}})),A}var C=(t,e,s)=>u.create(t,e,s,null,["$feature","$view"],[]),H=(t,e,s)=>u.create(t,e,s,null,["$feature","$view"],[]),K=(t,e,s,n)=>u.create(t,e,s,n,["$feature","$view"],[]),u=class t{constructor(e,s,n,d,f,c,i){this._dependencies=new Map,this.services=null,this.script=e,this.evaluate=d;let h=Array.isArray(c)?c:c?.fields;this.fields=h??[],this._syntaxTree=n,this._arcade=s,this._arcadeFeature=f,this._spatialReference=i,this._dependencies.set("geometry",s.scriptTouchesGeometry(this._syntaxTree)),this._dependencies.set("scale",this._arcade.referencesMember(this._syntaxTree,"scale")),this._dependencies.set("timeProperties",this._arcade.scriptUsesViewProperties(this._syntaxTree,["timeProperties"]))}static create(e,s,n,d,f,c){return F(this,null,function*(){let{arcade:i,Feature:h,Dictionary:w}=yield Z(),y=s instanceof g?s:g.fromJSON(s),a;try{a=i.parseScript(e,c)}catch(r){return O().error(new j("arcade-bad-expression","Failed to parse arcade script",{script:e,error:r})),null}let D=f.reduce((r,v)=>T(P({},r),{[v]:null}),{}),m=null;d!=null&&(m=new w(d),m.immutable=!0,D.$config=null);let b=i.scriptUsesGeometryEngine(a),G=b&&i.enableGeometrySupport(),U=i.scriptUsesFeatureSet(a)&&i.enableFeatureSetSupport(),x=i.scriptIsAsync(a),S=x&&i.enableAsyncSupport(),k={vars:D,spatialReference:y,useAsync:!!S};yield Promise.all([G,U,S]);let I=new Set;yield i.loadDependentModules(I,a,null,x,b);let o=new w;o.immutable=!1,o.setField("scale",0);let L=i.compileScript(a,k),M=(r,v)=>{let l=r.$view?.timeZone;if("$view"in r&&r.$view){let E;if(o.setField("scale",typeof r.$view=="object"&&"scale"in r.$view?r.$view.scale:void 0),typeof r.$view=="object"&&"timeProperties"in r.$view&&r.$view.timeProperties!=null){let{currentStart:$,currentEnd:_}=r.$view.timeProperties;E=new w({currentStart:$!=null?l!=null?p.epochToArcadeDate($,l):p.unknownEpochToArcadeDate($):void 0,currentEnd:_!=null?l!=null?p.epochToArcadeDate(_,l):p.unknownEpochToArcadeDate(_):void 0,startIncluded:!0,endIncluded:!0})}o.setField("timeProperties",E),r.$view=o}return m&&(r.$config=m),L({vars:r,spatialReference:y,services:v,timeZone:l})};return new t(e,i,a,M,new h,n,y)})}repurposeFeature(e){return e.geometry&&!e.geometry.spatialReference&&(e.geometry.spatialReference=this._spatialReference),this._arcadeFeature.repurposeFromGraphicLikeObject(e.geometry,e.attributes,{fields:this.fields}),this._arcadeFeature}references(e){return this._dependencies.get(e)??!1}};export{B as a,Z as b,C as c,H as d,K as e};
