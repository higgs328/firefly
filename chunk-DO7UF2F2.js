import{a as z}from"./chunk-ZTR6OS44.js";import{a as D}from"./chunk-VRTKAD2J.js";import{a as G}from"./chunk-DBLKLHK2.js";import{b as j,c as q}from"./chunk-UTE3ASAZ.js";import{a as w}from"./chunk-2AFEAPEX.js";import{a as x}from"./chunk-GNGXUEWV.js";import{a as O}from"./chunk-QBI5NDCA.js";import{a as U}from"./chunk-HVJAAM3A.js";import{a as $}from"./chunk-ACPEJEHK.js";import{a as S}from"./chunk-I7B3LWNP.js";import{a as C,b as _}from"./chunk-YP2E5N4E.js";import{a as k}from"./chunk-RX2HFR4X.js";import{a as A}from"./chunk-AZW7YPTQ.js";import{a as F}from"./chunk-DZHFTD24.js";import{a as W}from"./chunk-K57Z4J34.js";import{a as I}from"./chunk-46WDO5LS.js";import{a as P}from"./chunk-G5EYK5KM.js";import{a as M}from"./chunk-3JGYBNJA.js";import{t as H,x as K,za as V}from"./chunk-KALOJIUA.js";import{a as B}from"./chunk-PEW2PLAN.js";import{a as c}from"./chunk-CX5IFQZJ.js";import{a as L}from"./chunk-G4DZJMGT.js";import{f as J}from"./chunk-CCJU4DSH.js";import{b as m}from"./chunk-ACP3S2CH.js";import{a as n}from"./chunk-QGVBCWUY.js";import{e as p}from"./chunk-NFIPKH6V.js";import{l as v}from"./chunk-5QEXLALV.js";import{q as T}from"./chunk-P6QFA5MM.js";import{I as R}from"./chunk-4PTIEWMT.js";import{g as b}from"./chunk-XRGPJ3QY.js";import{b as N}from"./chunk-2LI2GKBQ.js";import{a as E,f as u}from"./chunk-VTHXE323.js";var h="relationships/",Q="expression/",Y=m.ofType({key:"type",defaultKeyValue:"button",base:G,typeMap:{button:z,toggle:D}}),Z={base:P,key:"type",typeMap:{media:_,custom:k,text:x,attachments:I,fields:F,expression:A,relationship:w,utilityNetworkAssociations:O}},X=new Set(["attachments","fields","media","text","expression","relationship"]),ee=new Set([...X,"utility-network-associations"]),r=class extends M.ClonableMixin(J){constructor(){super(...arguments),this.actions=null,this.content="",this.expressionInfos=null,this.fieldInfos=null,this.layerOptions=null,this.lastEditInfoEnabled=!0,this.outFields=null,this.overwriteActions=!1,this.returnGeometry=!1,this.title=""}castContent(e){return Array.isArray(e)?e.map(t=>T(Z,t)):typeof e=="string"||typeof e=="function"||e instanceof HTMLElement||R(e)?e:(b.getLogger(this).error("content error","unsupported content value",{value:e}),null)}readContent(e,t){let{popupElements:o}=t;return Array.isArray(o)&&o.length>0?this._readPopupInfoElements(t.description,t.mediaInfos,o):this._readPopupInfo(t)}writeWebSceneContent(e,t,o,i){this._writePopupTemplateContent(e,t,i)}writeWebMapContent(e,t,o,i){this._writePopupTemplateContent(e,t,i)}writeFieldInfos(e,t,o,i){let{content:s}=this,l=Array.isArray(s)?s:null;if(e){let a=l?l.filter(d=>d.type==="fields"):[],f=a.length&&a.every(d=>d.fieldInfos?.length);t.fieldInfos=e.filter(Boolean).map(d=>{let y=d.toJSON(i);return f&&(y.visible=!1),y})}if(l)for(let a of l)a.type==="fields"&&this._writeFieldsContent(a,t)}writeLayerOptions(e,t,o,i){t[o]=!e||e.showNoDataRecords===null&&e.returnTopmostRaster===null?null:e.toJSON(i)}writeTitle(e,t){t.title=e||""}collectRequiredFields(e,t){return u(this,null,function*(){let o=this.expressionInfos||[];yield this._collectExpressionInfoFields(e,t,[...o,...this._getContentExpressionInfos(this.content,o)]),H(e,t,[...this.outFields||[],...this._getActionsFields(this.actions),...this._getTitleFields(this.title),...this._getContentFields(this.content)])})}getRequiredFields(e){return u(this,null,function*(){let t=new Set;return yield this.collectRequiredFields(t,e),[...t].sort()})}_writePopupTemplateContent(e,t,o){typeof e!="string"?Array.isArray(e)&&(t.popupElements=e.filter(i=>o?.origin==="web-scene"?X.has(i.type):ee.has(i.type)).map(i=>i?.toJSON(o)),t.popupElements.forEach(i=>{i.type==="attachments"?this._writeAttachmentContent(t):i.type==="media"?this._writeMediaContent(i,t):i.type==="text"?this._writeTextContent(i,t):i.type==="relationship"&&this._writeRelationshipContent(i,t)})):t.description=e}_writeFieldsContent(e,t){if(!Array.isArray(e.fieldInfos)||!e.fieldInfos.length)return;let o=N(e.fieldInfos);Array.isArray(t.fieldInfos)?o.forEach(i=>{let s=t.fieldInfos.find(l=>l.fieldName?.toLowerCase()===i.fieldName?.toLowerCase());s?s.visible=!0:t.fieldInfos.push(i)}):t.fieldInfos=o}_writeAttachmentContent(e){e.showAttachments||(e.showAttachments=!0)}_writeRelationshipContent(e,t){let o=e.orderByFields?.map(s=>this._toFieldOrderJSON(s,e.relationshipId))||[],i=[...t.relatedRecordsInfo?.orderByFields||[],...o];t.relatedRecordsInfo=E({showRelatedRecords:!0},i?.length&&{orderByFields:i})}_writeTextContent(e,t){!t.description&&e.text&&(t.description=e.text)}_writeMediaContent(e,t){if(!Array.isArray(e.mediaInfos)||!e.mediaInfos.length)return;let o=N(e.mediaInfos);Array.isArray(t.mediaInfos)?t.mediaInfos=[...t.mediaInfos,...o]:t.mediaInfos=o}_readPopupInfoElements(e,t,o){let i={description:!1,mediaInfos:!1};return o.map(s=>s.type==="media"?(s.mediaInfos||!t||i.mediaInfos||(s.mediaInfos=t,i.mediaInfos=!0),_.fromJSON(s)):s.type==="text"?(s.text||!e||i.description||(s.text=e,i.description=!0),x.fromJSON(s)):s.type==="attachments"?I.fromJSON(s):s.type==="fields"?F.fromJSON(s):s.type==="expression"?A.fromJSON(s):s.type==="relationship"?w.fromJSON(s):s.type==="utilityNetworkAssociations"?O.fromJSON(s):void 0).filter(Boolean)}_toRelationshipContent(e){let{field:t,order:o}=e;if(!t?.startsWith(h))return null;let i=t.replace(h,"").split("/");if(i.length!==2)return null;let s=parseInt(i[0],10),l=i[1];return!Number.isNaN(s)&&l?w.fromJSON({relationshipId:s,orderByFields:[{field:l,order:o}]}):null}_toFieldOrderJSON(e,t){let{order:o,field:i}=e;return{field:`${h}${t}/${i}`,order:o}}_readPopupInfo({description:e,mediaInfos:t,showAttachments:o,relatedRecordsInfo:i={showRelatedRecords:!1}}){let s=[];e?s.push(new x({text:e})):s.push(new F),Array.isArray(t)&&t.length&&s.push(_.fromJSON({mediaInfos:t})),o&&s.push(I.fromJSON({displayType:"auto"}));let{showRelatedRecords:l,orderByFields:a}=i;return l&&a?.length&&a.forEach(f=>{let d=this._toRelationshipContent(f);d&&s.push(d)}),s.length?s:e}_getContentElementFields(e){let t=e?.type;if(t==="attachments")return[...this._extractFieldNames(e.title),...this._extractFieldNames(e.description)];if(t==="custom")return e.outFields||[];if(t==="fields")return[...this._extractFieldNames(e.title),...this._extractFieldNames(e.description),...this._getFieldInfoFields(e.fieldInfos??this.fieldInfos)];if(t==="media"){let o=e.mediaInfos||[];return[...this._extractFieldNames(e.title),...this._extractFieldNames(e.description),...o.reduce((i,s)=>[...i,...this._getMediaInfoFields(s)],[])]}return t==="text"?this._extractFieldNames(e.text):t==="relationship"||t==="utility-network-associations"?[...this._extractFieldNames(e.title),...this._extractFieldNames(e.description)]:[]}_getMediaInfoFields(e){let{caption:t,title:o,value:i}=e,s=i||{},{fields:l,normalizeField:a,tooltipField:f,sourceURL:d,linkURL:y}=s,g=[...this._extractFieldNames(o),...this._extractFieldNames(t),...this._extractFieldNames(d),...this._extractFieldNames(y),...l??[]];return a&&g.push(a),f&&g.push(f),g}_getContentExpressionInfos(e,t){return Array.isArray(e)?e.reduce((o,i)=>[...o,...i.type==="expression"&&i.expressionInfo?[i.expressionInfo]:[]],t):[]}_getContentFields(e){return typeof e=="string"?this._extractFieldNames(e):Array.isArray(e)?e.reduce((t,o)=>[...t,...this._getContentElementFields(o)],[]):[]}_collectExpressionInfoFields(e,t,o){return u(this,null,function*(){o&&(yield Promise.all(o.map(i=>K(e,t,i.expression))))})}_getFieldInfoFields(e){return e?e.filter(({fieldName:t,visible:o})=>!(o!==void 0&&!o||!t||t.startsWith(h)||t.startsWith(Q))).map(t=>t.fieldName):[]}_getActionsFields(e){return e?e.toArray().reduce((t,o)=>[...t,...this._getActionFields(o)],[]):[]}_getActionFields(e){let{className:t,title:o,type:i}=e,s=i==="button"||i==="toggle"?e.image:"";return[...this._extractFieldNames(o),...this._extractFieldNames(t),...this._extractFieldNames(s)]}_getTitleFields(e){return typeof e=="string"?this._extractFieldNames(e):[]}_extractFieldNames(e){return V(e).filter(t=>!(t.indexOf(h)===0||t.indexOf(Q)===0))}};n([p({type:Y})],r.prototype,"actions",void 0),n([p()],r.prototype,"content",void 0),n([L("content")],r.prototype,"castContent",null),n([B("content",["description","fieldInfos","popupElements","mediaInfos","showAttachments","relatedRecordsInfo"])],r.prototype,"readContent",null),n([c("web-scene","content",{popupElements:{type:m.ofType(q)},showAttachments:{type:Boolean},mediaInfos:{type:m.ofType(C)},description:{type:String},relatedRecordsInfo:{type:S}})],r.prototype,"writeWebSceneContent",null),n([c("content",{popupElements:{type:m.ofType(j)},showAttachments:{type:Boolean},mediaInfos:{type:m.ofType(C)},description:{type:String},relatedRecordsInfo:{type:S}})],r.prototype,"writeWebMapContent",null),n([p({type:[U],json:{write:!0}})],r.prototype,"expressionInfos",void 0),n([p({type:[W]})],r.prototype,"fieldInfos",void 0),n([c("fieldInfos")],r.prototype,"writeFieldInfos",null),n([p({type:$})],r.prototype,"layerOptions",void 0),n([c("layerOptions")],r.prototype,"writeLayerOptions",null),n([p({type:Boolean,json:{read:{source:"showLastEditInfo"},write:{target:"showLastEditInfo"},default:!0}})],r.prototype,"lastEditInfoEnabled",void 0),n([p()],r.prototype,"outFields",void 0),n([p()],r.prototype,"overwriteActions",void 0),n([p()],r.prototype,"returnGeometry",void 0),n([p({json:{type:String}})],r.prototype,"title",void 0),n([c("title")],r.prototype,"writeTitle",null),r=n([v("esri.PopupTemplate")],r);var Je=r;export{Je as a};
