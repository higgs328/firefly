import{a as DC,b as IC,c as LC,e as ey}from"./chunk-FZV4JEHO.js";import{a as qC}from"./chunk-UHGNYJVJ.js";import{a as cx,b as ph,c as iy}from"./chunk-EIGD2MFP.js";import{a as dx,c as px}from"./chunk-PBUAWFYQ.js";import{a as _x,c as gx}from"./chunk-H3EYY6ID.js";import{b as fx}from"./chunk-52JRYXZN.js";import{a as mx,c as ux}from"./chunk-ADLHCVUD.js";import{a as KC}from"./chunk-B2LAQAGY.js";import{b as tx}from"./chunk-MC4LSYPN.js";import{a as ix,c as rx}from"./chunk-KBGWE2RB.js";import{b as sx}from"./chunk-3BVCDULO.js";import{b as ax}from"./chunk-T6EEPTAG.js";import{b as nx}from"./chunk-Q6JMQPRR.js";import{b as ox}from"./chunk-5V3IADMH.js";import{a as lx,c as hx}from"./chunk-USR4LHBL.js";import{b as zC}from"./chunk-7QOKCCWJ.js";import{a as jC,c as WC}from"./chunk-75NLZADO.js";import{b as QC}from"./chunk-EPUMJIVO.js";import{a as $C,c as ZC}from"./chunk-MOHSRPJM.js";import{a as zn,b as Em,c as Om,f as YC}from"./chunk-PCWFJCPP.js";import{a as XC,c as JC}from"./chunk-VPNRGS27.js";import{b as ex}from"./chunk-MX3SN7EF.js";import{a as ch,b as ty,c as Am}from"./chunk-SH5OSQYL.js";import{a as Mm}from"./chunk-2CFID6ZR.js";import{a as NC}from"./chunk-6M2JPF2J.js";import{a as FC,c as VC,d as UC}from"./chunk-CPGQGV4U.js";import{a as HC}from"./chunk-PXRRGUD6.js";import{a as or,b as Gn,c as BC,e as kC}from"./chunk-B257PSMJ.js";import{a as dh,c as GC}from"./chunk-FHQXX7PA.js";import{a as Ws,b as SC,c as RC,d as Rm,f as PC}from"./chunk-VK6UOIFA.js";import{a as hh,b as Pm,c as MC,e as AC}from"./chunk-GZFA3A6Q.js";import{d as Sm}from"./chunk-5Z5OU66Q.js";import{a as Jg,b as EC,d as OC}from"./chunk-HPY2ARKN.js";import{b as Ja}from"./chunk-XFF5TPP3.js";import{a as Xg,b as lh,g as xC}from"./chunk-QQ4YSGRE.js";import{a as TC,c as kn,d as Hc,e as CC,f as nr,g as Ei,h as js}from"./chunk-JOKUMYS3.js";import{a as wC,b as bC,c as Kg}from"./chunk-A6PSIE5S.js";import{a as fC,b as gC,c as oh,d as yC,e as vC}from"./chunk-WZHDEFTY.js";import{a as _C}from"./chunk-KYSTRHK2.js";import{a as Zg,b as Tm,c as Uc,d as Cm,e as oC,f as zs,g as lC,h as _s,i as hC,j as cC,k as dC,l as pC,m as mC,o as ar,p as xm,q as Bn,r as Yg,s as uC}from"./chunk-GEBAN64U.js";import{A as qn,C as JT,D as Fo,H as zg,I as ma,J as br,K as ah,L as nh,M as eC,N as tC,O as jg,P as Wg,Q as Qg,R as $g,S as Tr,T as Vo,a as gt,b as th,c as kT,d as GT,e as ih,f as zT,g as jT,h as ci,i as oi,j as Nc,k as WT,l as QT,m as V,n as bm,p as rh,q as kg,r as sh,s as Hn,t as Gg,u as Fc,v as $T,w as ZT,x as YT,y as KT,z as XT}from"./chunk-WCHIR27X.js";import{a as aC}from"./chunk-KL4QNG4S.js";import{a as sC}from"./chunk-H7J6NXZL.js";import{a as Vc,b as iC,c as rC}from"./chunk-Q7U5SZXR.js";import{b as nC}from"./chunk-7GJJ7VEI.js";import{b as BT}from"./chunk-QGGZPZNN.js";import{a as sT,b as nT,c as UT}from"./chunk-SLYLIYF3.js";import{a as aT,b as lT,d as eh,e as pm,f as hT,h as qg,i as Bg,j as mm,k as cT,l as dT,m as pT,q as mT,r as uT,s as fT,t as _T,u as gT,v as um,w as yT,y as vT}from"./chunk-SSPYZF7P.js";import{a as wm}from"./chunk-XX3XW27Y.js";import{a as LT,b as NT,c as FT,d as VT}from"./chunk-P3OB2JIH.js";import{a as DT,e as IT}from"./chunk-FWBT5WUO.js";import{a as HT}from"./chunk-AODMECLB.js";import{a as qT}from"./chunk-LC2PQWW4.js";import{j as AT}from"./chunk-TACC3F3Z.js";import{b as OT}from"./chunk-EKHW2ZUO.js";import{b as MT,c as Un,d as pa}from"./chunk-MV4MLQFF.js";import{b as vm}from"./chunk-CRE2KNHB.js";import{a as ET}from"./chunk-3LFQVTDE.js";import{a as PT}from"./chunk-E6JHCD7G.js";import{a as bT,b as RT}from"./chunk-OLMT7QZE.js";import{a as TT,b as CT}from"./chunk-C7LGFUNN.js";import{a as fm,b as ST,c as _m,d as gm,e as ym}from"./chunk-FTOXUUBK.js";import{a as wT}from"./chunk-5BGVMDAM.js";import{a as Hg,b as oT}from"./chunk-XI2SE6JJ.js";import{a as Gs}from"./chunk-EXNBPOL5.js";import{h as xT}from"./chunk-5F4AB6OO.js";import{a as rT}from"./chunk-WA746ICL.js";import{a as Lo,c as Lc,d as No,e as Xb,f as Ug,g as dm,h as Jb,i as eT,j as tT,k as iT,l as ti}from"./chunk-BBM5BVWD.js";import{a as Zb}from"./chunk-W2NSYRQ2.js";import{a as fs,b as Vg}from"./chunk-JHKHLDGA.js";import{a as Xa}from"./chunk-ZN6QVIVX.js";import{a as Yb}from"./chunk-TCTLHOSE.js";import{a as Io}from"./chunk-44NA5LTU.js";import{a as Kb}from"./chunk-INL6HB7Y.js";import{b as Vb,d as Ub,e as Hb,f as qb,g as sm,h as kb,i as am,j as Gb,k as Og,l as zb,n as Ig}from"./chunk-IGGGB3TP.js";import{a as Dg,b as nm}from"./chunk-JDU4SWWX.js";import{a as Vn,b as Ya,c as Eg}from"./chunk-HMOFKUIJ.js";import{a as ei,b as ca,c as jb}from"./chunk-C5TDOKQP.js";import{d as Ic}from"./chunk-E3FPV7ZA.js";import{a as Do,b as Dc}from"./chunk-IQA3CVAZ.js";import{a as Fb,c as Bb}from"./chunk-GPMOZK2F.js";import{a as tm,b as Xl,c as Sb,d as Rb,e as Bs,f as Oc,h as Pb,i as ha,j as Ag,l as Mb,m as Ab,n as Eb,s as Ob,u as rm,v as Db,w as Ib,x as Lb,y as Nb}from"./chunk-CHALI33A.js";import{d as Pg}from"./chunk-D4ULQQN7.js";import{a as Mg}from"./chunk-NTU4GX2J.js";import{a as im}from"./chunk-XHCZWFY2.js";import{a as om}from"./chunk-PFQXJNFG.js";import{a as Jl,b as cm}from"./chunk-TTZ4CWZW.js";import{a as Ti,c as $b,d as Lg}from"./chunk-4JIR4MZV.js";import{a as wr}from"./chunk-ZO3S2OWI.js";import{b as lm,d as da,e as hm}from"./chunk-NRFDPN3W.js";import{d as Ng,e as Fg}from"./chunk-63BBKXWS.js";import{a as Ka,b as Wb,c as Qb}from"./chunk-C24MSACP.js";import{a as ks,b as us,c as Ct}from"./chunk-N3W77OHB.js";import{b as wb,n as bb}from"./chunk-6OWZRPJO.js";import{c as Kl}from"./chunk-6ZTUPVYX.js";import{a as em}from"./chunk-5DVGZXEZ.js";import{c as vb}from"./chunk-2I3LIA7G.js";import{c as Xp}from"./chunk-FLXA3YE2.js";import{a as Jp,b as yb,c as la,d as Yl}from"./chunk-OY7XUXBB.js";import{a as Rg}from"./chunk-AXZXNRJJ.js";import{a as Fn}from"./chunk-EBLTZITF.js";import{a as gb}from"./chunk-4TIUXNXO.js";import{a as Tb,b as Cb}from"./chunk-WQKVID54.js";import{i as xb}from"./chunk-DBCWR6HP.js";import{a as ms}from"./chunk-GUIIGAD3.js";import{a as _b}from"./chunk-6BOYEX6F.js";import{b as fb}from"./chunk-DXT3NBO5.js";import{a as ub}from"./chunk-BGL5237J.js";import{a as Ec}from"./chunk-NOHUHVCW.js";import{a as Sg,c as qs}from"./chunk-H2NTHPNN.js";import{v as mb}from"./chunk-Z7TBAZRW.js";import{a as pb}from"./chunk-TUUOR3MF.js";import{a as Mw}from"./chunk-WT37QSNF.js";import{a as qi}from"./chunk-LXYWEX2U.js";import{a as xg,b as Kp,c as hb,d as cb}from"./chunk-5MJEFA5N.js";import{a as Sw,b as Rw,c as kl}from"./chunk-5H7NDIGP.js";import{a as nb,b as Yp}from"./chunk-ZYYN4NWF.js";import{a as Lr}from"./chunk-2GLWK7ZW.js";import{f as lb}from"./chunk-QXSQOLB3.js";import{a as $l,b as Zi,c as Jw}from"./chunk-BKWQOCBC.js";import{a as wi,b as Dw}from"./chunk-CX3G2QWN.js";import{d as Qw,e as $w,f as Zw,h as Ac,k as Yw}from"./chunk-YTAJKLRN.js";import{a as Us,b as ps,g as Kw,h as Tg}from"./chunk-3ZJ4NMBE.js";import{c as Cg,d as Xw,e as Za}from"./chunk-4S7THJAS.js";import{a as ob}from"./chunk-2XTO2IAR.js";import{a as Y}from"./chunk-FSW536RM.js";import{a as Zl,c as tb,d as $p,f as ib,g as rb,h as sb,i as Zp}from"./chunk-VN5FPMRB.js";import{e as qw}from"./chunk-F4HA2HQL.js";import{a as ab}from"./chunk-CY62WWD7.js";import{b as eb}from"./chunk-VDNRZCIE.js";import{a as Ln}from"./chunk-I2JD5OSI.js";import{a as In}from"./chunk-2MROBW6T.js";import{a as Nn,b as ht}from"./chunk-QAHTJVUZ.js";import{a as vr}from"./chunk-XWEUR6F7.js";import{a as wg,b as Vs,c as $i,d as Aw,e as $e}from"./chunk-MPI26GZ3.js";import{b as Pw}from"./chunk-K6RQLPKJ.js";import{b as Gw}from"./chunk-PORMJXR6.js";import{a as Qp}from"./chunk-Y7XG5IWW.js";import{a as zw,b as jw,c as Ww}from"./chunk-5252J253.js";import{a as zt,b as bi}from"./chunk-7WCQBAQY.js";import{f as Ql}from"./chunk-JBAMJB5J.js";import{a as Le,b as Ne}from"./chunk-T5UBLAP4.js";import{a as zl,b as na,d as jl,e as Uw,f as Wl,g as oa,h as jp,k as Hw,l as je,m as qe}from"./chunk-DA3NC6W4.js";import{a as Bw}from"./chunk-FGABE2LC.js";import{a as Ot,b as kw,d as Ft}from"./chunk-CZMBPC27.js";import{a as bg,f as Hs,g as Ew,h as Ow}from"./chunk-VSD74FMI.js";import{a as zp,b as Fw,e as Vw,j as fi}from"./chunk-J5AEP4US.js";import{a as ui}from"./chunk-YHRLMRSO.js";import{b as Wp}from"./chunk-KPT44MCK.js";import{a as aa}from"./chunk-XKFJ6GWH.js";import{a as Qr}from"./chunk-EM2AEAFS.js";import{a as Dn}from"./chunk-L7NOU4T2.js";import{a as Iw,b as Mc,c as Gl,j as Lw,k as Nw}from"./chunk-G2JMPZCN.js";import{a as Nr}from"./chunk-IRQF7UTO.js";import{a as Tt,b as le}from"./chunk-3KOZOOEP.js";import{a as An}from"./chunk-L56OBJFS.js";import{e as yg,g as vg,j as Rc,n as Pc,o as Mn,r as gw}from"./chunk-7HMNN4FJ.js";import{a as Bl}from"./chunk-CTVZOIWY.js";import{a as yw}from"./chunk-ULOK73M2.js";import{a as Oo}from"./chunk-UP67O2XH.js";import{c as ww}from"./chunk-7KP7SKLW.js";import{b as Tw}from"./chunk-456M7HFK.js";import{a as En}from"./chunk-342NGUMP.js";import{a as On}from"./chunk-PHMJ7KPL.js";import{a as kp,c as vw}from"./chunk-42SGGFLN.js";import{b as bw}from"./chunk-EDOVNTC7.js";import{a as j,h as Gp}from"./chunk-YEXMIDOT.js";import{b as mi,d as mw,e as uw,f as Hl,g as fw,i as Rn,l as Pn,o as _w,r as ql}from"./chunk-QSQIQSC6.js";import{a as Wr,c as Fs,f as pw}from"./chunk-AYNBEMCC.js";import{a as Cw,b as xw}from"./chunk-JLWYDAJB.js";import{a as Z1}from"./chunk-B7PAC3NI.js";import{b as Y1}from"./chunk-ECA5I2I7.js";import{c as Ns}from"./chunk-XAHD7XBV.js";import{c as dw}from"./chunk-Y7XRSFOZ.js";import{a as cw}from"./chunk-YQNUGDFH.js";import{a as me,b as Sc,c as Bp}from"./chunk-QCZ3ZIGQ.js";import{a as db}from"./chunk-NIRJWS2D.js";import{a as lw}from"./chunk-EZUSHT3W.js";import{a as hw}from"./chunk-DNO4WN4I.js";import{A as $a,c as Lp,d as rw,e as Qa,h as Eo,i as Vp,j as Up,n as _g,o as ow,r as Hp}from"./chunk-7SDNM7YV.js";import{b as Pt,c as sw,d as aw}from"./chunk-4NUW747S.js";import{a as Np,e as xc,f as nw,h as Fp,i as Ul}from"./chunk-T6WMVIUG.js";import{a as Ip}from"./chunk-7VCEHOOE.js";import{c as oe,d as gg,e as qp}from"./chunk-ONYJLWAD.js";import{e as iw}from"./chunk-PHODKV66.js";import{a as Cc}from"./chunk-JPMGMA4B.js";import{m as Vl}from"./chunk-ZM24RY22.js";import{b as tw}from"./chunk-GNEAU6X4.js";import{j as yn,k as vn,n as Kv,o as fc,p as ig,q as rg,r as Pl}from"./chunk-XR5FT7TQ.js";import{a as ew}from"./chunk-LAX5536Z.js";import{a as J1}from"./chunk-4DBMALZW.js";import{a as X1}from"./chunk-6RCCEJDL.js";import{c as K1}from"./chunk-YWLMJ26A.js";import{a as Op}from"./chunk-JQAW4OB5.js";import{a as Dp}from"./chunk-6F25LG6O.js";import{a as Xt,c as O1,d as ut,e as Dr,f as So}from"./chunk-XLL67PCY.js";import{a as Zt}from"./chunk-MCO7DSFO.js";import{E as w1,F as Ol,M as b1,a as v1,d as El,e as dg}from"./chunk-GJ2QRXGN.js";import{a as Ao,d as B1}from"./chunk-MSDJIYGD.js";import{a as Sp}from"./chunk-6QXEFK4U.js";import{a as xp,d as H1,f as q1}from"./chunk-5L2EJ5RT.js";import{a as Ir}from"./chunk-S52JRLJC.js";import{b as zr}from"./chunk-E2QKN2KY.js";import{a as Wi,e as ug}from"./chunk-PDQQY7RQ.js";import{a as Et}from"./chunk-RWCIDBNQ.js";import{a as ji,b as N1,e as F1,f as Po}from"./chunk-EM35R6FY.js";import{a as Lt,b as ft,c as _t,d as V1,h as Mo,i as Nt,j as bp,k as yr,l as Jt,m as Tc,n as St,o as Cn,p as sa,q as Tp,r as Qi,w as Hi,x as U1,y as Cp}from"./chunk-HM5RIVQC.js";import{c as $1}from"./chunk-XIZXEWWA.js";import{a as Sn}from"./chunk-HKJZ7WI6.js";import{a as j1,b as W1,d as Q1}from"./chunk-CXOFHVIF.js";import{a as Rp,b as k1,c as Pp,d as Nl,e as Mp,h as G1,i as Fl,j as Ap,k as Ep,o as z1}from"./chunk-DJW5LMRG.js";import{a as jr}from"./chunk-DEH76MSI.js";import{a as Rt,c as fg,d as xn}from"./chunk-ALWV3RJ2.js";import{c as L1,p as mg}from"./chunk-2ZFXOJDB.js";import{a as gr,b as hs,d as D1,i as Wa,w as wp}from"./chunk-QXXXCEV5.js";import{A as I1,D as Il,E as Tn,F as Ll,G as bt,H as Ai,J as vi,a as ne,b as q,c as xe,d as K,e as ae,n as k,o as Ro,p as It,q as cs,r as Mi,s as Gr,u as z,v as $,w as Qe,x as Ui,y as At,z as ds}from"./chunk-6B5XFA6F.js";import{a as bn}from"./chunk-3JGYBNJA.js";import{d as wn,e as M1,g as pg,q as A1,t as E1}from"./chunk-DA3SDKGO.js";import{c as bc,f as R1,k as P1}from"./chunk-57VFBGF3.js";import{a as ni,b as S1,c as rr,f as sr}from"./chunk-PTZYZULI.js";import{a as Dl,c as ls,d as T1,e as vp,k as C1,l as wc,m as x1}from"./chunk-NMLYCCKN.js";import{h as y1}from"./chunk-RNC4P66O.js";import{a as Yv}from"./chunk-D3CUKSGS.js";import{d as gp,f as mt,g as a1,h as xo,i as Is}from"./chunk-OLOKUDVI.js";import{B as m1,C as u1,D as f1,E as _1,a as Al,c as vc,d as p1,f as og,g as ns,h as lg,j as os,m as hg,p as ra}from"./chunk-ZTOZWLEE.js";import{c as yp}from"./chunk-RSDQHAJX.js";import{a as _,b as Or,c as xt,d as yc,e as n1,f as o1,h as l1,i as Ls,k as h1,l as c1,m as d1}from"./chunk-BOVYXYHK.js";import{A as _p,C as Os,E as Ds,G as s1,a as kt,c as _c,d as Xv,e as Jv,f as e1,g as t1,h as ta,j as sg,k as ia,l as Co,o as fp,r as ag,u as i1,v as ja,x as ng,y as gc,z as r1}from"./chunk-KVM6SHDX.js";import{b as g1,c as cg}from"./chunk-NKUXRYJG.js";import{b as N,d as To,g as Ae,i as pt,j as Ga,l as as,m as Ml,u as za}from"./chunk-EQZWYK27.js";import{m as kr}from"./chunk-ZQIC5NFT.js";import{c as _r}from"./chunk-VIEK2X23.js";import{d as Zv}from"./chunk-Q6Y4JG7Q.js";import{a as Kt}from"./chunk-7F5DJLJT.js";import{B as Ue,a as tg,aa as $v,ca as uc,d as Rl,i as Qv,n as pp,p as mp,r as up}from"./chunk-NJWTSROP.js";import{a as ir}from"./chunk-ARRCN5K3.js";import{a as fr}from"./chunk-WGAOVKGR.js";import{a as eg}from"./chunk-AXYQJCCX.js";import{a as mc}from"./chunk-5XCFNEYX.js";import{a as Wv}from"./chunk-GQL2MBZT.js";import{a as jv}from"./chunk-MGGSCSBE.js";import{a as ea}from"./chunk-G4DZJMGT.js";import{a as zv,b as X_}from"./chunk-X2B63YVS.js";import{o as dp}from"./chunk-AUAZP44J.js";import{Y as cp}from"./chunk-76ATOSLU.js";import{a as P,b as ka,c as Er,e as pc,i as we,j as Ie,k as ye}from"./chunk-TG45K3WR.js";import{f as Js}from"./chunk-RAI4DTMT.js";import{a as J_,b as Ba}from"./chunk-ACP3S2CH.js";import{a as tr}from"./chunk-T7DXJKX7.js";import{a as c}from"./chunk-QGVBCWUY.js";import{A as Uv,B as Hv,E as qv,H as te,h as K_}from"./chunk-MYO4NP2N.js";import{e as p}from"./chunk-NFIPKH6V.js";import{a as rs}from"./chunk-JPU2PQZC.js";import{l as S}from"./chunk-5QEXLALV.js";import{c as hp,i as Bv,j as kv,q as Gv}from"./chunk-P6QFA5MM.js";import{a as Y_}from"./chunk-LI2SX4T6.js";import{d as Tl}from"./chunk-BWO7LS2H.js";import{a as dc,d as Fv,e as Sl,f as Vv}from"./chunk-HEVQSRJ2.js";import{a as Nv,b as lp}from"./chunk-SNFOAZZQ.js";import{a as Xe}from"./chunk-AML4XSEF.js";import{I as Cl,L as xl,a as Ev,b as G,c as ge,d as Pi,e as Ar,f as ai,h as Z_,l as Dv,o as er,p as Vi,r as bo,s as Iv,u as gn,w as Lv,y as ss}from"./chunk-4PTIEWMT.js";import{a as is,g as Ov}from"./chunk-TG2UTNEO.js";import{b as si}from"./chunk-YOFFGXOB.js";import{g as pe}from"./chunk-XRGPJ3QY.js";import{b as cc}from"./chunk-2LI2GKBQ.js";import{L as Av,a as Yt,d as Rv,j as np,k as Pv,l as Mv,r as op}from"./chunk-QBWJMFH5.js";import{a as lt,b as Bt,f as Re,i as ap}from"./chunk-VTHXE323.js";function ry(t,e){let i=Y_(t),r=Y_(e),s=i.store,a=r.store,n=r.metadata;for(let o in n){let l=n[o],h=s.originOf(o),d=a.originOf(o);if(!l.readOnly&&d!==K_.DEFAULTS)if(h===K_.DEFAULTS)t.set(o,a.get(o));else{let m=s.get(o),u=a.get(o);m&&u&&u instanceof te&&m instanceof te&&m instanceof u.constructor&&ry(m,u)}}}var qc=()=>import("./chunk-3GGIGE25.js"),yx=()=>import("./chunk-VWHWTURM.js"),vx={"base-dynamic":()=>import("./chunk-S6CETE4N.js"),"base-elevation":yx,"base-tile":qc,"bing-maps":qc,"building-scene":()=>import("./chunk-AONHNAJY.js"),catalog:()=>import("./chunk-4Z7J7MXT.js"),"catalog-dynamic-group":()=>import("./chunk-2EBYSZG2.js"),"catalog-footprint":()=>import("./chunk-DNZI5GWA.js"),csv:()=>import("./chunk-REIFNZ62.js"),dimension:()=>import("./chunk-CEKNTSBK.js"),elevation:yx,feature:()=>import("./chunk-LMLDYY2D.js"),geojson:()=>import("./chunk-URBJC4LY.js"),graphics:()=>import("./chunk-MOYF6TPQ.js"),group:()=>import("./chunk-MAYJVGOY.js"),imagery:()=>import("./chunk-DEZV65E5.js"),"integrated-mesh":()=>import("./chunk-PH7IVSPA.js"),"integrated-mesh-3dtiles":()=>import("./chunk-AJXNXWHX.js"),"line-of-sight":()=>import("./chunk-EVTWQF5K.js"),"map-image":()=>import("./chunk-46L5QAKO.js"),media:()=>import("./chunk-H7ZYMA6V.js"),"ogc-feature":()=>import("./chunk-E3HEDETC.js"),"open-street-map":qc,"oriented-imagery":()=>import("./chunk-LMLDYY2D.js"),"point-cloud":()=>import("./chunk-O6ILZJEW.js"),viewshed:()=>import("./chunk-WDRZ6P6Y.js"),voxel:()=>import("./chunk-3W2SKBIF.js"),route:()=>import("./chunk-T3KJMBTX.js"),scene:t=>t.profile==null||t.profile==="mesh-pyramids"?import("./chunk-KR5S2RSE.js"):import("./chunk-YGQDE4AM.js"),stream:()=>import("./chunk-TGMK4NYV.js"),tile:qc,"imagery-tile":()=>import("./chunk-DWPMQ6BJ.js"),"vector-tile":()=>import("./chunk-6M4NMVVK.js"),wcs:()=>import("./chunk-DWPMQ6BJ.js"),"web-tile":qc,wfs:()=>import("./chunk-VEC3SDQ3.js"),wms:()=>import("./chunk-QSUFY42M.js"),wmts:()=>import("./chunk-ARBN56FI.js"),parquet:null,"geo-rss":null,kml:null,"knowledge-graph":null,"link-chart":null,"knowledge-graph-sublayer":null,"map-notes":null,"subtype-group":null,unknown:null,unsupported:null,video:null};function tM(t){let e=t.declaredClass?t.declaredClass.slice(t.declaredClass.lastIndexOf(".")+1):"Unknown",i=e.replaceAll(/([a-z])([A-Z])/g,"$1-$2").toLowerCase();return new si(`${i}:view-not-supported`,`${e} is not supported in 3D`)}var sy={hasLayerViewModule:t=>vx[t.type]!=null,importLayerView:t=>{let e=vx[t.type];if(e==null)throw tM(t);return e(t)}};var wx="analyses-owner-handles",mh,Ho;(function(t){t[t.PENDING=0]="PENDING",t[t.CREATED=1]="CREATED"})(mh||(mh={})),function(t){t[t.ADDED=0]="ADDED",t[t.REMOVED=1]="REMOVED"}(Ho||(Ho={}));var Uo=class extends te{constructor(t){super(t),this._allAnalysisViews=new Ba,this._creatingViewCount=0,this._items=new Map,this._scheduledUpdateHandle=null,this._attachedToViewResolver=bx(),this._analysisModules={"area-measurement":{module:null},dimension:{module:null},"direct-line-measurement":{module:null},"line-of-sight":{module:null},slice:{module:null},viewshed:{module:null}}}destroy(){this._disconnectOwners(),this._attachedToViewResolver.reject(er("AnalysisViewManager was destroyed"))}attach(){this._connectOwners(),this._attachedToViewResolver.resolve()}detach(){this._disconnectOwners(),this._attachedToViewResolver.reject(er()),this._attachedToViewResolver=bx()}get updating(){return!this.view.ready||this._creatingViewCount!==0||this._allAnalysisViews.some(t=>t.updating)}get testInfo(){}whenAnalysisView(t){return Re(this,null,function*(){yield this._attachedToViewResolver.promise;let e=this._items.get(t);if(e==null||e.state.list===Ho.REMOVED)throw new si("AnalysisViewManager:no-analysisview-for-analysis","The analysis has not been added to view.analyses",{analysis:t});return e.createAnalysisViewTask.promise})}_connectOwners(){this.addHandles(this._connectAnalysesCollection(this.view.analyses),wx)}_disconnectOwners(){this.removeHandles(wx),this._update(),this._creatingViewCount=0}_connectAnalysesCollection(t){for(let r of t)this._addAnalysis(r);let e=t.on("after-add",r=>this._addAnalysis(r.item)),i=t.on("after-remove",r=>this._removeAnalysis(r.item));return is(()=>{e.remove(),i.remove();for(let r of t)this._removeAnalysis(r)})}_addAnalysis(t){let e=this._items.get(t);if(e==null){let i={state:{view:mh.PENDING,list:Ho.ADDED},analysis:t,view:null,createAnalysisViewTask:null};this._items.set(t,i),i.createAnalysisViewTask=Js(r=>this._createAnalysisViewPromise(i,r))}else e.state.list=Ho.ADDED}_removeAnalysis(t){let e=this._items.get(t);e!=null?(e.state.list=Ho.REMOVED,this._scheduleUpdate()):pe.getLogger(this).error("Trying to remove analysis which was not added")}_scheduleUpdate(){this._scheduledUpdateHandle==null&&(this._scheduledUpdateHandle=Fv(()=>this._update()))}_update(){this._scheduledUpdateHandle=Pi(this._scheduledUpdateHandle),this._items.forEach(t=>{if(t.state.list===Ho.REMOVED)switch(this._items.delete(t.analysis),t.state.view){case mh.PENDING:t.createAnalysisViewTask=Ar(t.createAnalysisViewTask);break;case mh.CREATED:t.view!=null&&(this._allAnalysisViews.remove(t.view),t.view=G(t.view),t.createAnalysisViewTask=null)}})}_createAnalysisViewPromise(t,e){return Re(this,null,function*(){let i=t.analysis,r=i.type,s=this._analysisModules[r];if(this._creatingViewCount+=1,s.module==null)try{s.module=yield this._loadAnalysisModule(r)}catch(o){throw this._creatingViewCount-=1,o}if(bo(e))throw this._creatingViewCount-=1,er("AnalysisView creation aborted");let a=new s.module.default({analysis:i,view:this.view}),n=!0;gn(e,()=>{n&&(this._creatingViewCount-=1,a.destroy())});try{yield a.when()}catch(o){throw n=!1,a.destroyed||(this._creatingViewCount-=1,a.destroy()),o}if(bo(e))throw er();return n=!1,t.view=a,t.state.view=mh.CREATED,this._allAnalysisViews.add(a),this._creatingViewCount-=1,a})}_loadAnalysisModule(t){switch(t){case"area-measurement":return import("./chunk-G6TVK6NQ.js");case"dimension":return import("./chunk-OBYON27P.js");case"direct-line-measurement":return import("./chunk-XADNCDVZ.js");case"line-of-sight":return import("./chunk-ZNESLRV2.js");case"slice":return import("./chunk-V4OCNNTA.js");case"viewshed":return import("./chunk-6CFARMT7.js")}}};function bx(){let t=xl();return t.promise.catch(()=>{}),t}c([p()],Uo.prototype,"updating",null),c([p({constructOnly:!0})],Uo.prototype,"view",void 0),c([p()],Uo.prototype,"_allAnalysisViews",void 0),c([p()],Uo.prototype,"_creatingViewCount",void 0),Uo=c([S("esri.views.3d.analysis.AnalysisViewManager3D")],Uo);var Tx=Uo;var ua=class extends te{constructor(t){super(t),this.collision=new Bc,this.distance=1/0,this.minimumPoiDistance=4,this.tilt=null}get altitude(){return this.mode===me.Local?null:this._get("altitude")||null}set altitude(t){this.mode!==me.Local?this._set("altitude",t):pe.getLogger(this).warn("Altitude constraint is ignored in local scenes")}get mode(){return this.state.viewingMode}clampAltitude(t){return this.altitude?N(t,this.altitude.min,this.altitude.max):t}clampTilt(t,e){if(!this.tilt)return e;let i=this.tilt(t);return N(e,i.min,i.max)}clampDistance(t){return Math.min(t,this.distance)}createDefaultTilt(){return this.mode===me.Local?this._createDefaultTiltLocal():this._createDefaultTiltGlobal()}createConstantMaxTilt(t){return(e,i=ay)=>(i.min=_i.min,i.max=t,i)}_createDefaultTiltLocal(){let t=this.collision.enabled?Ul([[4e3,_i.max],[1e4,pt(88)],[6e6,pt(88)]]):()=>_i.max;return(e,i=ay)=>(i.min=_i.min,i.max=t(e),i)}_createDefaultTiltGlobal(){let t=this.collision.enabled?Ul([[4e3,_i.max],[5e4,pt(88)],[6e6,pt(88)],[2e7,_i.min]]):Ul([[3e5,_i.max],[3e6,pt(88)],[6e6,pt(88)],[2e7,_i.min]]);return(e,i=ay)=>(i.min=_i.min,i.max=t(e),i)}};function iM(t){return{min:-2e5,max:4*t.radius}}c([p()],ua.prototype,"altitude",null),c([p({readOnly:!0})],ua.prototype,"collision",void 0),c([p()],ua.prototype,"distance",void 0),c([p({readOnly:!0})],ua.prototype,"minimumPoiDistance",void 0),c([p()],ua.prototype,"tilt",void 0),c([p({constructOnly:!0})],ua.prototype,"state",void 0),ua=c([S("esri.views.3d.state.Constraints")],ua);var ny=iM(ir),_i={min:pt(.5),max:pt(179.5)},ay={min:0,max:0},Bc=class extends te{constructor(){super(...arguments),this.enabled=!0,this.elevationMargin=5}};c([p({type:Boolean})],Bc.prototype,"enabled",void 0),c([p({type:Number})],Bc.prototype,"elevationMargin",void 0),Bc=c([S("esri.views.3d.state.Constraints.CollisionConstraint")],Bc);var qo=class extends bn{constructor(){super(...arguments),this.min=ny.min,this.max=ny.max}};c([p({type:Number})],qo.prototype,"min",void 0),c([p({type:Number})],qo.prototype,"max",void 0),qo=c([S("esri.views.3d.constraints.AltitudeConstraint")],qo);var fa=class extends bn{constructor(){super(...arguments),this.mode="auto"}get near(){return this._get("near")}set near(t){this._set("near",t),t>=this._get("far")&&(this.far=t+1e-9),this.mode="manual"}castNear(t){return Math.max(1e-8,t)}get far(){return this._get("far")}set far(t){this._set("far",t),t<=this._get("near")&&(this.near=t-1e-9),this.mode="manual"}castFar(t){return Math.max(1e-8,t)}autoUpdate(t,e){this.mode==="auto"&&(this._get("near")!==t&&this._set("near",t),this._get("far")!==e&&this._set("far",e))}};c([p({type:Number,value:1e-8})],fa.prototype,"near",null),c([ea("near")],fa.prototype,"castNear",null),c([p({type:Number,value:1e-8})],fa.prototype,"far",null),c([ea("far")],fa.prototype,"castFar",null),c([p({type:["auto","manual"]})],fa.prototype,"mode",void 0),fa=c([S("esri.views.3d.constraints.ClipDistanceConstraint")],fa);var oy={min:Ga(_i.min),max:Ga(_i.max)},jn=class extends bn{constructor(t){super(t),this.mode="auto"}get max(){return this._get("max")}set max(t){this._set("max",t),this.mode="manual"}castMax(t){return N(t,oy.min,oy.max)}autoUpdate(t){this.mode==="auto"&&this._get("max")!==t&&this._set("max",t)}};c([p({type:["auto","manual"]})],jn.prototype,"mode",void 0),c([p({type:Number,value:oy.max})],jn.prototype,"max",null),c([ea("max")],jn.prototype,"castMax",null),jn=c([S("esri.views.3d.constraints.TiltConstraint")],jn);var Wn=class extends bn{constructor(t){super(t),this.tilt=new jn,this.altitude=new qo,this.clipDistance=new fa}};c([p({type:jn})],Wn.prototype,"tilt",void 0),c([p({type:qo})],Wn.prototype,"altitude",void 0),c([p({type:fa})],Wn.prototype,"clipDistance",void 0),Wn=c([S("esri.views.3d.constraints.Constraints")],Wn);function ly(t){return Rl(t,j1)||mp(t)?{wkid:tg.GCSMARS2000}:Rl(t,W1)||up(t)?{wkid:tg.GCSMOON2000}:Kt.WGS84}var Bo=class{constructor(e,i,r,s,a,n,o,l,h=.5){this.coverage=e,this.density=i,this.absorption=r,this.cloudSize=s,this.detailSize=a,this.smoothness=n,this.cloudHeight=o,this.raymarchingSteps=l,this.median=h}},Ci={sunny:new Bo([0,.6],[.03,.03],[0,0],[.9,.9],[.8,.8],[.7,.7],[.05,.05],Ws.SIXTEEN),cloudy:new Bo([.3,.65],[.2,.4],[0,0],[.85,.85],[.75,.75],[.3,.4],[1,1],Ws.TWOHUNDRED,.6),rainy:new Bo([.6,.8],[.5,.8],[.1,.5],[.9,.9],[.75,.75],[.5,.5],[1,1],Ws.TWOHUNDRED,.4),snowy:new Bo([.25,.75],[.3,.3],[0,0],[.95,.95],[.7,.7],[.69,.75],[.3,1],Ws.HUNDRED,.65),foggy:new Bo([.8,.8],[.5,.5],[0,0],[.95,.95],[.9,.9],[.55,.55],[.3,.3],Ws.SIXTEEN)};Ci.default=Ci.sunny;var uh=class extends Ne{constructor(e,i){super(e,i,new Le(PC,()=>import("./chunk-FV4RIUOK.js")))}initializePipeline(e){return qe({blending:zl(_t.CONSTANT_COLOR,_t.ONE_MINUS_CONSTANT_COLOR,V1.ADD,e.writeTextureChannels===Dc.RG?[1,1,0,0]:[0,0,1,1]),depthTest:{func:Nt.LEQUAL},colorWrite:je})}};var fh=class extends Ne{constructor(e,i){super(e,i,new Le(AC,()=>import("./chunk-NGJ52IAE.js")))}initializePipeline(e){return qe({blending:e.mode===hh.Full?jl:na(_t.ZERO,_t.ONE,_t.ONE,_t.ZERO),depthTest:{func:Nt.ALWAYS},colorWrite:je})}};var kc=class extends te{constructor(t){super(t),this._needsRender=!0,this._passParameters=new MC,this._configuration=new Pm,this._fbo=new la(t.context.renderContext.rctx,new Ot(Sm)),t.context.techniques.precompile(fh,new Pm);let e=new Pm;e.mode=hh.WeatherMap,t.context.techniques.precompile(fh,e)}get textureAtlas(){if(this._texture&&!this._needsRender)return this._texture;this._configuration.mode=this._texture?hh.WeatherMap:hh.Full;let t=this.context.techniques.get(fh,this._configuration);return t.compiled&&(this._texture=this._render(t)),this._texture}updateWeatherMap(t){wp(this._passParameters.weatherTile,t)||(gr(this._passParameters.weatherTile,t),this._needsRender=!0)}destroy(){this._fbo=ge(this._fbo)}_render(t){if(!this._fbo)return null;let e=this.context.renderContext.rctx,i=e.getViewport();return e.setViewport(0,0,Sm,Sm),e.bindFramebuffer(this._fbo),e.bindTechnique(t,this.context.renderContext.bind,this._passParameters),e.screen.draw(),e.setViewport(i.x,i.y,i.width,i.height),this._needsRender=!1,this._fbo.colorTexture}};c([p({constructOnly:!0})],kc.prototype,"context",void 0),kc=c([S("esri.views.3d.environment.NoiseTextureAtlas")],kc);var lr=class extends te{constructor(t){super(t),this._state=fr(Do.Idle),this._passParameters=new RC,this._weatherTileCount=128,this._faceIndex=0,this._tileIndex=0,this._tilesPerFace=1,this.coverage=Ae(Ci.default.coverage[0],Ci.default.coverage[1],.5),this.density=Ae(Ci.default.density[0],Ci.default.density[1],.5),this.absorption=Ae(Ci.default.absorption[0],Ci.default.absorption[1],.5),this.cloudSize=Ae(Ci.default.cloudSize[0],Ci.default.cloudSize[1],.5),this.detailSize=Ae(Ci.default.detailSize[0],Ci.default.detailSize[1],.5),this.smoothness=Ae(Ci.default.smoothness[0],Ci.default.smoothness[1],.5),this.cloudHeight=Ae(Ci.default.cloudHeight[0],Ci.default.cloudHeight[1],.5),this.raymarchingSteps=Ci.default.raymarchingSteps,this._viewMatrix=Rt(),this._dirty=!0,this.running=!0,this._configuration=new SC}initialize(){let t=Ue(this.view.spatialReference);this._passParameters.cloudRadius=.5*t.radius;let e=()=>this.setDirty();this.addHandles([this.view.resourceController.scheduler.registerTask(ut.CLOUDS_GENERATOR,this),P(()=>this.coverage,e,Ie),P(()=>this.density,e,Ie),P(()=>this.absorption,e,Ie),P(()=>this.cloudSize,e,Ie),P(()=>this.detailSize,e,Ie),P(()=>this.smoothness,e,Ie),P(()=>this.cloudHeight,e,Ie),P(()=>this.raymarchingSteps,e,Ie)]);let i=N1(this._computeWeatherTile()),r=0;this.addHandles(P(()=>{let s=this._computeWeatherTile();return wp(i,s)||(++r,gr(i,s)),r},e))}destroy(){this.destroyCubeMap(),this._passParameters.noiseTexture=G(this._passParameters.noiseTexture)}_precompileTechniques(){this._configuration.steps=this.raymarchingSteps,this._configuration.writeTextureChannels=Dc.RG,this.context.techniques.precompile(uh,this._configuration),this._configuration.writeTextureChannels=Dc.BA,this.context.techniques.precompile(uh,this._configuration)}_acquireTechnique(){switch(this.raymarchingSteps){case Ws.SIXTEEN:this._tilesPerFace=1;break;case Ws.HUNDRED:this._tilesPerFace=4;break;case Ws.COUNT:case Ws.TWOHUNDRED:this._tilesPerFace=8;break;default:this.raymarchingSteps}return this._configuration.writeTextureChannels=1-this.parameters.readChannels,this._configuration.steps=this.raymarchingSteps,this.context.techniques.get(uh,this._configuration)}_computeWeatherTile(){let{camera:t,environment:e}=this.view,{latitude:i,longitude:r}=t.position;if(i==null||r==null)return Po;hs(Qs,(i+90)/180,(r+180)/360);let s=Math.floor(this._weatherTileCount*Math.abs(2*Qs[0]-1));Qs[0]=Math.floor(2*this._weatherTileCount*Qs[0]),Qs[1]=Math.floor(4*(this._weatherTileCount-s)*Qs[1]);let a=0,n=0;if(e?.lighting?.type!=="virtual"&&e?.lighting?.date!=null){let o=new Date(e.lighting.date);o.setUTCHours(e.lighting.date.getUTCHours()+(e.lighting.displayUTCOffset??0)),a=31*o.getUTCMonth()+o.getUTCDate(),n=o.getUTCFullYear()}return Qs[0]=(Qs[0]+a)%(2*this._weatherTileCount),Qs[1]=(Qs[1]+n%100)%(4*this._weatherTileCount),Qs}get state(){return this._state.value}set state(t){this._state.value=t}get usedMemory(){return(this._fbo?.usedMemory??0)+(this._passParameters.noiseTexture?.textureAtlas?.usedMemory??0)}_ensureNoiseTexture(){return this._passParameters.noiseTexture??=new kc({context:this.context}),this._passParameters.noiseTexture}_ensureFrameBufferCube(t){let e=this.context.renderContext.rctx;if(this._fbo==null){let i=new Ot(t);i.target=Tc.TEXTURE_CUBE_MAP,i.wrapMode=Jt.CLAMP_TO_EDGE,this._fbo=new la(e,i),this.parameters.data=this}return e.unbindTexture(this._fbo.colorTexture),this._fbo}get cubeMap(){return this._fbo}get parameters(){return this.context.renderContext.bind.clouds}destroyCubeMap(){this._fbo=ge(this._fbo),this.parameters.data=null}applyPreset(t,e){let i=t.median,r=s=>{let a=Ae(s[0],s[1],i);return e<.5?Ae(s[0],a,2*e):Ae(a,s[1],2*(e-.5))};this.coverage=r(t.coverage),this.density=r(t.density),this.absorption=r(t.absorption),this.cloudSize=r(t.cloudSize),this.detailSize=r(t.detailSize),this.smoothness=r(t.smoothness),this.cloudHeight=r(t.cloudHeight),this.raymarchingSteps=t.raymarchingSteps,this._precompileTechniques()}setDirty(){this._dirty=this.running=!0}runTask(t){if(this.state===Do.Fading)return Xt;this._dirty&&(this._faceIndex=this._tileIndex=0,this.state=Do.Rendering,this._passParameters.absorption=this.absorption,this._passParameters.density=this.density,this._passParameters.cloudSize=this.cloudSize,this._passParameters.detailSize=this.detailSize,this._passParameters.smoothness=this.smoothness,this._passParameters.cloudHeight=this.cloudHeight,this._passParameters.coverage=this.coverage,this._ensureNoiseTexture().updateWeatherMap(this._computeWeatherTile()),this._dirty=!1);let e=this._acquireTechnique();if(!this._ensureNoiseTexture().textureAtlas||!e.compiled)return Xt;let i=rM[this._faceIndex],r=sM[this._faceIndex];u1(this._viewMatrix,aM,i,r),Rp(this._passParameters.viewMatrix,this._viewMatrix);let s=this.context.renderContext.rctx,a=s.getViewport(),n=Rm/this._tilesPerFace,o=this._tileIndex*n;s.setViewport(0,o,Rm,n);let l=this._ensureFrameBufferCube(Rm);s.bindFramebuffer(l),s.bindTechnique(e,this.context.renderContext.bind,this._passParameters);let h=Tc.TEXTURE_CUBE_MAP_POSITIVE_X+this._faceIndex;return l.setColorTextureTarget(h),s.screen.draw(),s.gl.flush(),s.setViewport(a.x,a.y,a.width,a.height),this.requestRender(),++this._tileIndex,this._faceIndex===4&&this._tileIndex===this._tilesPerFace?(this._faceIndex=this._tileIndex=0,this.state=Do.Ready,this.running=!1):this._tileIndex===this._tilesPerFace&&(++this._faceIndex,this._tileIndex=0),t.madeProgress(),Xt}};c([p({constructOnly:!0})],lr.prototype,"context",void 0),c([p({constructOnly:!0})],lr.prototype,"view",void 0),c([p({constructOnly:!0})],lr.prototype,"requestRender",void 0),c([p()],lr.prototype,"coverage",void 0),c([p()],lr.prototype,"density",void 0),c([p()],lr.prototype,"absorption",void 0),c([p()],lr.prototype,"cloudSize",void 0),c([p()],lr.prototype,"detailSize",void 0),c([p()],lr.prototype,"smoothness",void 0),c([p()],lr.prototype,"cloudHeight",void 0),c([p()],lr.prototype,"raymarchingSteps",void 0),c([p()],lr.prototype,"running",void 0),lr=c([S("esri.views.3d.environment.CloudsRenderer")],lr);var rM=[Ns(1,0,0),Ns(-1,0,0),Ns(0,1,0),Ns(0,-1,0),Ns(0,0,1)],sM=[Ns(0,1,0),Ns(0,1,0),Ns(0,0,-1),Ns(0,0,1),Ns(0,1,0)],aM=o1(),Qs=F1();var Dm=class extends Dn{constructor(){super(...arguments),this.time=0,this.radius=1,this.width=500,this.opacity=0}},Gc=class extends Ne{constructor(e,i){super(e,i,new Le(OC,()=>import("./chunk-BS2BEEP4.js")),new Map([[Et.POSITION,0],[Et.INSTANCEFEATUREATTRIBUTE,1]]))}initializePipeline(){return qe({blending:Wl,depthTest:{func:Nt.LEQUAL},colorWrite:je})}};var ko=class extends Nr{constructor(t){super(t),this.consumes={required:[le.TRANSPARENT_ENVIRONMENT]},this.produces=le.TRANSPARENT_ENVIRONMENT,this._rainSpeed=.1,this._snowSpeed=.01,this._numParticles=0,this._passParameters=new Dm,this._configuration=new EC;let{view:e,type:i}=t;this._configuration.type=i==="rainy"?Jg.Rain:Jg.Snow,e._stage.renderView.techniques.precompile(Gc,this._configuration),this._passParameters.time=0,this._passParameters.radius=Ue(e.spatialReference).radius,this.addHandles(P(()=>e.environment.weather,r=>{r.type===i&&this.addHandles(P(()=>r.precipitation,s=>this._adjustParticles(s),ye))},ye)),this.addHandles(P(()=>e._stage?.renderer.renderContext.bind.clouds.fadeFactor??1,r=>{this._passParameters.opacity=r,r===1&&(this.removeHandles("opacity"),this.addHandles(P(()=>e._stage?.renderer.renderContext.bind.clouds.opacity??1,s=>this._passParameters.opacity=s,ye),"opacity"))},we),"opacity")}_adjustParticles(t){let i=t<.5?Ae(0,.35,2*t):Ae(.35,1,2*(t-.5));this._numParticles=Cx*i}destroy(){this._numParticles=0,this._vao=ge(this._vao),this._instanceIdBuffer=ge(this._instanceIdBuffer)}fadeOut(t){this.removeAllHandles(),this.addHandles(P(()=>this.renderContext?.bind.clouds.fadeFactor??1,e=>{this._passParameters.opacity=1-e,e===1&&(this.removeAllHandles(),t())}),"opacity")}updateAnimation(t){let e=(this.type==="rainy"?this._rainSpeed:this._snowSpeed)*lp(t.time)%1e5;return this._passParameters.time!==e&&(this._passParameters.time=e,!0)}render(t){let e=this.renderingContext;this._instanceIdBuffer??=this._createInstanceIndices(e);let i=Math.round(this._numParticles*this._passParameters.opacity),r=t.find(({name:n})=>n===le.TRANSPARENT_ENVIRONMENT);if(i<1)return r;let s=this.techniques.get(Gc,this._configuration);if(!s.compiled)return this.requestRender(oe.UPDATE),r;let a=e.bindTechnique(s,this.bindParameters,this._passParameters);return this._vao??=nM(e,s.locations),e.bindVAO(this._vao),a.assertCompatibleVertexAttributeLocations(this._vao),Ew(e,s.locations,this._instanceIdBuffer,xx,0),e.drawArraysInstanced(ft.TRIANGLES,0,3,i),Ow(e,s.locations,this._instanceIdBuffer,xx),r}_createInstanceIndices(t){let e=[];for(let i=0;i<Cx;i++)e.push(i);return wi.createVertex(t,Qi.STATIC_DRAW,new Float32Array(e))}};function nM(t,e){let i=new Float32Array([-1,0,1,1,0,-1,1,0,1]);return new Lr(t,e,new Map([["geometry",Ir(oM)]]),new Map([["geometry",wi.createVertex(t,Qi.STATIC_DRAW,i)]]))}c([p()],ko.prototype,"consumes",void 0),c([p()],ko.prototype,"produces",void 0),c([p({constructOnly:!0})],ko.prototype,"type",void 0),ko=c([S("esri.views.3d.environment.Precipitation")],ko);var Cx=25e4,oM=zr().vec3f(Et.POSITION),xx=Ir(zr().f32(Et.INSTANCEFEATUREATTRIBUTE),1);var Qn=class extends kl{constructor(t){super(t),this.produces=new Map([]),this._clouds=fr(null),this._incarnation=0,this._precipitation=null}initialize(){this.view._stage.addRenderPlugin(this)}destroy(){this.removeHandles(),this.uninitializeRenderContext(),this.view?._stage?.removeRenderPlugin(this),this._set("view",null)}get updating(){return!!this._clouds.value?.running}get weatherAvailable(){return ne(this.view.state.camera.eye)-Ue(this.view.spatialReference).radius<=Ic}get usedMemory(){return this._clouds.value?.usedMemory??0}_fadeOutPrecipitation(){this._precipitation&&(this._precipitationOutgoing?.destroy(),this._precipitationOutgoing=this._precipitation,this._precipitationOutgoing.fadeOut(()=>{this._precipitationOutgoing=G(this._precipitationOutgoing)}),this._precipitation=null,++this._incarnation)}get weather(){return this.view?.environmentManager?.weatherEnabled?this.view.environment.weather:null}initializeRenderContext(t){this._context=t;let e=this.view,i=()=>this._requestRender();this.addHandles([P(()=>this._precipitation,i,we),P(()=>this._clouds.value?.state,i,we),P(()=>e.state.mode,i,we),P(()=>this._updateClouds(),i,we),P(()=>this._updatePrecipitation(),i,we),P(()=>this.weather,r=>this._initWeather(r))])}uninitializeRenderContext(){this._context=null,this._clouds.value=G(this._clouds.value),this._precipitation=G(this._precipitation),this._precipitationOutgoing=G(this._precipitationOutgoing)}prepareRender(t){let{bind:e,time:i}=t;if(this.view.viewingMode!=="local"&&e.clouds.data){e.clouds.fade(e.camera,i,this.view.qualitySettings.fadeDuration);let r=this._clouds.value;r&&r.state===Do.Idle&&r.coverage===0&&!r.running&&r.destroyCubeMap()}}acquireTechniques(){return[]}render(){}_requestRender(){this._context?.requestRender()}_initWeather(t){let e=this._context;if(!t||!e)return void(this._clouds.value=G(this._clouds.value));if(this._clouds.value)return;let i=this.view;this._clouds.value=new lr({context:e,view:i,requestRender:()=>this._requestRender()})}_updateClouds(){let t=this.view.environment.weather;return t==null||this._clouds.value==null||this._clouds.value.applyPreset(Ci[t.type],lM(t)),++this._incarnation}_updatePrecipitation(){let t=this.view.environment.weather;if(t.type===this._precipitation?.type)return this._incarnation;this._fadeOutPrecipitation();let e=t.type==="rainy"||t.type==="snowy",i=this._context;return e&&i&&(this._precipitation=new ko({view:this.view,type:t.type}),++this._incarnation),this._incarnation}get test(){}hasHighlightOptions(t){return!1}};function lM(t){switch(t.type){case"rainy":case"snowy":case"cloudy":case"sunny":return t.cloudCover;case"foggy":return t.fogStrength}}c([p({constructOnly:!0})],Qn.prototype,"view",void 0),c([p({type:Boolean,readOnly:!0})],Qn.prototype,"updating",null),c([p()],Qn.prototype,"weatherAvailable",null),c([p()],Qn.prototype,"_context",void 0),Qn=c([S("esri.views.3d.environment.EnvironmentRenderer")],Qn);var $r=class extends tr.EventedAccessor{constructor(){super(),this._tmpLightParameters=new ey,this._defaultLightParameters=new ey,this._tmpDate=new Date,this._tmpTz={hours:0,minutes:0,seconds:0},this._viewHandlesKey="viewHandles",this._trackingEnabled=!1,this._mainLight=new Ww,this._ambientLight=new zw,this._moonLight=new jw,this._disableProjectionEngineAutoLoad=!1,this._disableWeather=!1,this._renderer=null,this._referencePositionGeographic=null,this._resetReferencePosition()}destroy(){this.disconnectView()}get _view(){return this._renderer?.view}get updating(){return!!this._renderer?.updating||!this._canProjectCameraPosition}get weatherEnabled(){return this._view?.environment.atmosphereEnabled&&!this._disableWeather&&this._view?.state?.viewingMode===me.Global&&Qv(this._view.spatialReference)}get _weatherAvailable(){return this.weatherEnabled&&this._renderer?.weatherAvailable}get referencePositionGeographic(){return this._referencePositionGeographic}get _canProjectCameraPosition(){let t=this._view?.stateManager?.camera?.position?.spatialReference??Kt.WGS84,e=ly(t);return this._disableProjectionEngineAutoLoad||wn(t,e)}connectView(t){if(this._renderer)return;this._renderer=new Qn({view:t});let e=()=>this._updateRenderParameters(),i=()=>this._cameraHandler();this.addHandles([P(()=>t.environment.lighting,r=>this._updateLightingHandler(r),we),P(()=>t.environment.lighting.type!=="virtual"?t.environment.lighting.date:null,r=>this._lightingDateHandler(r),we),P(()=>t.environment.lighting.directShadowsEnabled,e,we),P(()=>t.qualitySettings.ambientOcclusion,e,we),P(()=>t.qualitySettings.reflections,e,we),P(()=>t.spatialReference,()=>this._resetReferencePosition(!0),we),P(()=>[t.environment.weather.type,this.weatherEnabled],()=>this._updateLighting(null,sm.FadeWithWeather),we),P(()=>t.environment,r=>r.setComputeWeatherAvailable(()=>this._weatherAvailable),ye),P(()=>t.viewingMode,()=>this._resetReferencePosition(!0),ye),P(()=>t.environment.lighting.type!=="virtual"&&t.environment.lighting.cameraTrackingEnabled,r=>this._updateCameraTracking(r),ye),P(()=>t.state.camera,i,ye),ka(()=>this._canProjectCameraPosition,i,we)],this._viewHandlesKey),this._updateRenderParameters(),this._updateLighting(),this._cameraHandler(),this.notifyChange("updating")}disconnectView(){this.removeHandles(this._viewHandlesKey),this._resetReferencePosition(),this._renderer=G(this._renderer)}_updateLightingHandler(t){this._updateCameraTracking(t.type!=="virtual"&&t.cameraTrackingEnabled),this._lightingDateHandler(t.type!=="virtual"?t.date:null),this._updateRenderParameters()}_updateCameraTracking(t){if(this._trackingEnabled=t,t)this._cameraHandler();else{let e=this._view.environment.lighting;e?.type!=="virtual"&&(e.positionTimezoneInfo.autoUpdated=!1)}}_lightingDateHandler(t){let e=this._view.environment.lighting;if(e?.type!=="virtual"){if(t){if(!e.positionTimezoneInfo.autoUpdated&&(this._preupdateTracking(t),this._referencePositionGeographic!=null)){let i=Pg(this._referencePositionGeographic,this._tmpTz);i!=null&&(e.autoUpdate(null,i),this._trackingEnabled&&(e.positionTimezoneInfo.autoUpdated=!0))}this._updateLighting(t)}}else this._updateLighting()}_preupdateTracking(t){!this._trackingEnabled&&this._view.environment.lighting.type!=="virtual"&&this._view.environment.lighting.cameraTrackingEnabled&&this._cameraHandler(t)}_cameraHandler(t=null){let e=this._view;if(!e.ready)return;let i=e.stateManager.camera;if(!i)return;let{position:r}=i,s=r.spatialReference??Kt.WGS84,a=ly(s),n=this._referencePositionGeographic??_();if(!Sn(r,n,a))return this._referencePositionGeographic=null,void this._updateLighting();this._referencePositionGeographic=n,this.notifyChange("referencePositionGeographic"),this._autoUpdateTimezone(n,t)||this._updateLighting(t)}_updateLighting(t,e=sm.Immediate){let i=this._view,{lighting:r}=i.environment,s=r.type==="virtual",a=this._referencePositionGeographic,n=a!=null?this._tmpLightParameters:this._defaultLightParameters;if(a){t??=s?null:r.date;let u=this._weatherAvailable?i.environment.weather.type:"disabled";DC(t,a,i.state.viewingMode,u,i.state.camera,n)}else s&&IC(i.state.camera,i.state.viewingMode,n.direct.directionToLightSource);let o=this._mainLight,l=n.direct;k(o.intensity,l.color,l.intensity*Math.PI),q(o.direction,l.directionToLightSource),o.specularStrength=n.specularStrength,o.environmentStrength=n.environmentStrength;let h=this._ambientLight;k(h.intensity,n.ambient.color,n.ambient.intensity);let d=this._moonLight;Ui(d.intensity,hM,cM,n.globalFactor);let m=(1-.5*n.globalFactor)*(1-.4*n.noonFactor*(1-n.globalFactor));k(d.intensity,d.intensity,m),q(d.direction,l.directionToLightSource),this._view._stage.renderer.updateLighting([o,h,d],n.noonFactor,n.globalFactor,this._weatherAvailable?e:sm.Immediate),this._updateRenderParameters()}_autoUpdateTimezone(t,e=null){if(this._view.environment.lighting.type==="virtual"||!this._view.environment.lighting.cameraTrackingEnabled||t==null)return!1;let i=this._tmpDate;i.setTime((e||this._view.environment.lighting.date).getTime());let r=Pg(t,this._tmpTz);if(r==null)return!1;let s=this._view.environment.lighting.positionTimezoneInfo;if(s.autoUpdated){if(s.hours===r.hours&&s.minutes===r.minutes&&s.seconds===r.seconds)return!1}else s=r;let a=i.getUTCHours()-(r.hours-s.hours),n=i.getUTCMinutes()-(r.minutes-s.minutes),o=i.getUTCSeconds()-(r.seconds-s.seconds);return i.setUTCHours(a),i.setUTCMinutes(n),i.setUTCSeconds(o),!e&&this._view.environment.lighting.autoUpdate(i,r)}_updateRenderParameters(){let t=this._view._stage;if(!t)return;let e=this._referencePositionGeographic==null||LC(this._referencePositionGeographic[2],this._view.state.viewingMode);t.renderer.setParameters({shadowMap:this._view.environment.lighting.directShadowsEnabled&&e,environment:this._view.environment,weatherVisible:this._weatherAvailable,qualitySettings:this._view.qualitySettings})}_resetReferencePosition(t=!1){this._referencePositionGeographic=null,t&&this._cameraHandler()}get test(){}};c([p({type:Boolean,readOnly:!0})],$r.prototype,"updating",null),c([p()],$r.prototype,"_disableProjectionEngineAutoLoad",void 0),c([p()],$r.prototype,"_disableWeather",void 0),c([p()],$r.prototype,"weatherEnabled",null),c([p()],$r.prototype,"_weatherAvailable",null),c([p()],$r.prototype,"referencePositionGeographic",null),c([p()],$r.prototype,"_renderer",void 0),c([p()],$r.prototype,"_referencePositionGeographic",void 0),c([p()],$r.prototype,"_canProjectCameraPosition",null),$r=c([S("esri.views.3d.environment.EnvironmentManager")],$r);var hM=xt(.22,.22,.33),cM=xt(.22,.22,.22);var Sx={key:"type",defaultKeyValue:"sun",base:null,typeMap:{sun:Xa,virtual:Io}};var zc,Go=zc=class extends Mm{constructor(t){super(t),this.lighting=this.castLighting(),this._computeWeatherAvailable=void 0,this.cachedCameraTrackingEnabled=null}static fromWebsceneEnvironment(t){let e=t.cloneConstructProperties();return new zc(Bt(lt({},e),{lighting:e.lighting?e.lighting.type==="virtual"?Io.fromWebsceneLighting(e.lighting):Xa.fromWebsceneLighting(e.lighting):void 0}))}get weatherAvailable(){return this._computeWeatherAvailable?.()??!1}setComputeWeatherAvailable(t){this._computeWeatherAvailable=t}castLighting(t){return this._convertLightingWithDestroy(t)}applyLighting(t){this.lighting=this._convertLightingWithDestroy(t)}_convertLightingWithDestroy(t){let e=this._convertLighting(t);return e!==t&&this.addHandles(Ov(e)),e}_convertLighting(t){return t?t instanceof Xa||t instanceof Io?t:t instanceof Yb?this.lighting&&this.lighting.type!=="virtual"?this.lighting.cloneWithWebsceneLighting(t):new Xa(lt(lt({},t.cloneConstructProperties()),this.lighting?.cloneNonPersistentConstructProperties())):t instanceof Kb?this.lighting&&this.lighting.type==="virtual"?this.lighting.cloneWithWebsceneLighting(t):new Io(lt(lt({},t.cloneConstructProperties()),this.lighting?.cloneNonPersistentConstructProperties())):Gv(Sx,t):new Xa}clone(){return new zc({lighting:this.lighting.clone(),weather:this.weather.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:cc(this.background)})}cloneWithWebsceneEnvironment(t){return new zc(Bt(lt({weather:this.weather.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:cc(this.background)},t.cloneConstructProperties()),{lighting:this._getLighting(t)}))}_getLighting(t){switch(t.lighting.type){case"sun":return this.lighting&&this.lighting.type==="sun"?this.lighting.cloneWithWebsceneLighting(t.lighting):Xa.fromWebsceneLighting(t.lighting);case"virtual":return this.lighting&&this.lighting.type==="virtual"?this.lighting.cloneWithWebsceneLighting(t.lighting):Io.fromWebsceneLighting(t.lighting);default:return t.lighting,Xa.fromWebsceneLighting(t.lighting)}}};c([p({nonNullable:!0})],Go.prototype,"lighting",void 0),c([p()],Go.prototype,"_computeWeatherAvailable",void 0),c([p({readOnly:!0})],Go.prototype,"weatherAvailable",null),c([ea("lighting")],Go.prototype,"castLighting",null),Go=zc=c([S("esri.views.3d.environment.SceneViewEnvironment")],Go);var zo=Go;var Pe;(function(t){t[t.NONE=0]="NONE",t[t.TILT=1]="TILT",t[t.ALTITUDE=2]="ALTITUDE",t[t.DISTANCE=4]="DISTANCE",t[t.COLLISION=8]="COLLISION",t[t.ALL=15]="ALL",t[t.ALL_EXCEPT_COLLISION=7]="ALL_EXCEPT_COLLISION"})(Pe||(Pe={}));var he;(function(t){t[t.NONE=0]="NONE",t[t.ZOOM=1]="ZOOM",t[t.TUMBLE=2]="TUMBLE",t[t.LOOK_AROUND=3]="LOOK_AROUND",t[t.PAN=4]="PAN",t[t.ASCEND=5]="ASCEND"})(he||(he={}));var Fr;(function(t){t[t.TUMBLE=0]="TUMBLE",t[t.LOOK_AROUND=1]="LOOK_AROUND"})(Fr||(Fr={}));var Vt=class{constructor(e=Pe.ALL,i=he.NONE,r=0,s=null,a=null,n=Fr.TUMBLE){this.selection=e,this.interactionType=i,this.interactionFactor=r,this.interactionStartCamera=s,this.interactionDirection=a,this.tiltMode=n}};function $n(t,e){return!!(t&e)}function jo(t,e,i,r,s,a){t!==0&&(i?(a.min=Math.min(a.min,e),a.max=Math.max(a.max,e)):r!=null?(a.min-=Math.max(0,(e-a.min)*(1-r)),a.max+=Math.max(0,(e-a.max)*(1-r))):s&&(a.min-=Math.max(0,e-a.min-s),a.max+=Math.max(0,e-a.max-s)))}var _a=new Vt(Pe.NONE);function Im(t,e,i,r){return e=e||t.viewForward,q(r,e),k(r,r,Math.sign($(e,i))),r}function Rx(t,e,i=_a){let r=Lm(t,e,i);if(r===0)return!1;let s=t.renderCoordsHelper,a=s.getAltitude(e.eye)+r,n=Im(e,i.interactionDirection,mM(t,e,Math.sign(r),gM),_M),o=q(yM,e.viewForward),l=s.intersectInfiniteManifold(Fs(e.eye,n),a,cy);return e.eye=l??s.setAltitude(cy,a,e.eye),e.center=OT(cy,e.eye,o,e.center),!0}function Lm(t,e,i=_a){if(!dM(t,i)||!t.state.constraints.altitude)return 0;let r=uM(t.state.constraints.altitude,fM);pM(t,i,r);let s=t.renderCoordsHelper.getAltitude(e.eye),a=N(s,r.min,r.max)-s;return Math.abs(a)<=1e-6?0:a}function dM(t,e){let i=t.state.constraints.altitude;return!(!t.state.isGlobal||!i)&&(e.interactionType!==he.TUMBLE||!$n(e.selection,Pe.TILT))}function pM(t,e,i){let r=e.interactionType;if(r===he.NONE)return;let{min:s,max:a}=i,{interactionStartCamera:n,interactionFactor:o}=e;if(!n)return;let l=r===he.TUMBLE||r===he.ZOOM,h=Lm(t,n),d=h===0?0:t.renderCoordsHelper.getAltitude(n.eye);i.min=s,i.max=a,jo(h,d,l,o,.05*d,i)}function mM(t,e,i,r){return t.renderCoordsHelper.worldUpAtPosition(e.eye,r),k(r,r,i),r}function uM(t,e){return e.min=t.min,e.max=t.max,e}var fM={min:0,max:0},_M=_(),gM=_(),yM=_(),cy=_();function Vm(t,e,i=_a){if(!t.state.isLocal)return 0;let r=t.state.constraints.distance;if(!t.pointsOfInterest.surfaceOrigin.renderLocation||r===1/0)return 0;Nm.min=0,Nm.max=r,vM(t,i,Nm);let s=dy(t,e),a=Nm.max-s;return a>=-1e-6?0:a}function Px(t,e,i=_a){let r=Vm(t,e,i);if(r===0)return!1;let s=t.pointsOfInterest.surfaceOrigin;if(!s.renderLocation)return!1;let a=dy(t,e)+r,n=q(bM,e.eye),o=Im(e,i.interactionDirection,wM(e,s.renderLocation,xM),CM);if(!Rn(uw(s.renderLocation,a),Fs(e.eye,o),Fm))return!1;e.eye=Fm;let l=ae(TM,e.eye,n);e.center=K(Fm,e.center,l);let h=t.renderCoordsHelper.getAltitude(e.center),d=t.renderCoordsHelper.intersectInfiniteManifold(e.ray,h,Fm);return d!=null&&(e.center=d),!0}function vM(t,e,i){let r=e.interactionType;if(r===he.NONE)return;let{min:s,max:a}=i,{interactionStartCamera:n,interactionFactor:o}=e;if(!n)return;let l=r===he.ZOOM||r===he.PAN,h=Vm(t,n),d=h===0?0:dy(t,n);i.min=s,i.max=a,jo(h,d,l,o,.05*d,i)}function dy(t,e){let i=t.pointsOfInterest.surfaceOrigin;return i.renderLocation?It(e.eye,i.renderLocation):0}function wM(t,e,i){return Ll(i,t.eye,e)}var Nm={min:0,max:0},bM=_(),TM=_(),CM=_(),xM=_(),Fm=_();function gs(t,e,i=hr.EYE){let r=t.state.constraints;if(!r.collision.enabled)return!1;let s=Xl(t,e.eye),a=t.renderCoordsHelper.getAltitude(e.eye),n=s+r.collision.elevationMargin;if(a>=n)return!1;let o=ne(e.eye);if(ae(Um,e.center,e.eye),e.eye=t.renderCoordsHelper.setAltitude(SM,n,e.eye),i===hr.EYE_AND_CENTER)e.center=K(Um,e.eye,Um);else if(i===hr.EYE_AND_CENTER_SCALE){let l=(o-a+n)/o;e.center=k(Um,e.center,l)}return!0}var hr;(function(t){t[t.EYE=0]="EYE",t[t.EYE_AND_CENTER=1]="EYE_AND_CENTER",t[t.EYE_AND_CENTER_SCALE=2]="EYE_AND_CENTER_SCALE"})(hr||(hr={}));var Um=_(),SM=_();function my(t,e,i,r=!0){jc.eyeCenterDistance=0,jc.requiresTwoSteps=!1;let s=Bm(t,e,i,_a,jc);if(s===0)return!1;switch(ra(Hm,-s,e.viewRight),i.tiltMode){case Fr.LOOK_AROUND:At(Zn,e.viewForward,Hm),k(Zn,Zn,jc.eyeCenterDistance),e.center=K(Yn,e.eye,Zn);break;case Fr.TUMBLE:ae(Zn,e.center,e.eye),At(Zn,Zn,Hm),e.eye=ae(Yn,e.center,Zn);break;default:i.tiltMode}return e.up=At(Yn,e.up,Hm),!jc.requiresTwoSteps||!r||my(t,e,i,!1)}function Bm(t,e,i,r=_a,s){if(!t.state.constraints.tilt)return 0;let a=Math.min(e.relativeElevation*qm,e.distance),n=t.state.constraints.tilt(a,NM);return LM(t,i,n),r.interactionType===he.TUMBLE&&$n(r.selection,Pe.ALTITUDE)&&Ax(t,r.interactionStartCamera,n),i.tiltMode===Fr.LOOK_AROUND||r.tiltMode===Fr.LOOK_AROUND?PM(t,e,n,s):RM(t,e,n)}function RM(t,e,i){let r=Bs(t.renderCoordsHelper,e.center,e.eye),s=r-N(r,i.min,i.max);return Wc(s)?s:0}function PM(t,e,i,r){switch(r&&(r.requiresTwoSteps=!1),t.viewingMode){case"global":return AM(t,e,i,r);case"local":return MM(t,e,i,r)}}function MM(t,e,i,r){let s=Bs(t.renderCoordsHelper,e.center,e.eye),a=N(s,i.min,i.max),n=s-a;if(!Wc(n))return 0;if(r){let o=Math.abs(t.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude),l=t.renderCoordsHelper.getAltitude(e.eye)-o,h=Math.max(Math.cos(a),1e-4);Math.abs(h)>1e-4?r.eyeCenterDistance=l/h:r.eyeCenterDistance=e.distance}return n}function AM(t,e,i,r){let s=EM(t,e,FM),a=N(s.tiltAtCenter,i.min,i.max);if(!Wc(s.tiltAtCenter-a))return 0;let n,o;return s.centerIsOnSurface?(n=OM(s),o=DM(s,n)):(n=s.constraints.clampTilt(s.distance,s.tiltAtCenter),r&&n<Math.PI/2&&(r.requiresTwoSteps=!0,n=Math.PI/2-1e-5),o=IM(s,n)),r&&(r.eyeCenterDistance=py(s,n)),o}function EM(t,e,i){let r=t.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,s=r+Ue(t.spatialReference).radius,a=t.renderCoordsHelper.intersectManifold(e.ray,r,Yn);return i.distance=Math.min(e.relativeElevation*qm,e.distance),i.centerIsOnSurface=!1,a!=null?(i.distance=Math.min(e.relativeElevation*qm,It(e.eye,a)),i.tiltAtCenter=Bs(t.renderCoordsHelper,a,e.eye),i.centerIsOnSurface=!0):t.state.isLocal?i.tiltAtCenter=Bs(t.renderCoordsHelper,e.center,e.eye):(Pn(Hl(ql,s),e.ray,Yn),i.distance=Math.min(e.relativeElevation*qm,It(e.eye,Yn)),i.tiltAtCenter=as(-$(e.viewForward,z(Yn,Yn)))),i.radius=s,i.eyeRadius=ne(e.eye),i.constraints=t.state.constraints,i}function Wc(t){return Math.abs(t)>1e-9}function OM(t){let{constraints:e,distance:i,tiltAtCenter:r}=t,s=r,a=e.clampTilt(i,r),n=py(t,a);if(e.clampTilt(n,r)===a)return a;let o=0;for(;o<10&&Wc(a-s);){let l=(s+a)/2,h=py(t,l);Wc(e.clampTilt(h,l)-l)?s=l:a=l,o++}return a}function py(t,e){if(!t.centerIsOnSurface)return t.distance;let i=Math.PI-N(e,0,Math.PI),r=Ml(t.radius/t.eyeRadius*Math.sin(i)),s=Math.PI-i-r,a=Math.sin(s)/Math.sin(i);if(t.eyeRadius<t.radius&&a>1){let n=Math.PI-r,o=Math.PI-i-n;return Math.sin(o)/Math.sin(i)*t.eyeRadius}return a*t.eyeRadius}function DM(t,e){let i=Ml(t.radius/t.eyeRadius*Math.sin(t.tiltAtCenter)),r=Ml(t.radius/t.eyeRadius*Math.sin(e));return t.eyeRadius>t.radius?i-r:r-i}function IM(t,e){return t.tiltAtCenter-Math.PI/2-(e-Math.PI/2)}function LM(t,e,i){if(e.interactionType===he.NONE)return;let{interactionStartCamera:r,interactionFactor:s}=e;if(!r)return;let{min:a,max:n}=i,o=Bm(t,r,_a,e),l=o===0?0:Bs(t.renderCoordsHelper,r.center,r.eye);i.min=a,i.max=n,e.interactionType===he.TUMBLE?($n(e.selection,Pe.ALTITUDE)&&Ax(t,r,i),jo(o,l,!0,s,Mx,i)):jo(o,l,!1,s,Mx,i)}function Ax(t,e,i){let r=t.state.constraints;if(t.state.isLocal||!r.altitude||!e)return;let s=Mi(e.center),a=Math.sqrt(s),n=e.distance,o=Ue(t.spatialReference).radius,l=r.altitude.min+o,h=r.altitude.max+o,d=(l*l-n*n-s)/(-2*a*n),m=(h*h-n*n-s)/(-2*a*n);i.min=Math.max(i.min,Math.min(Math.PI-as(m),i.max)),i.max=Math.min(i.max,Math.PI-as(d))}var Zn=_(),Hm=Rt(),Yn=_(),Mx=pt(5),qm=30,NM={min:0,max:0},FM={constraints:null,radius:0,eyeRadius:0,centerIsOnSurface:!0,distance:0,tiltAtCenter:0},jc={eyeCenterDistance:0,requiresTwoSteps:!1};function Ze(t,e,i=qM,r=e){r!==e&&r.copyFrom(e),r.computeUp(t.state.viewingMode);let s=!1;for(let o=0;o<BM;o++){let l=0;for(let h of HM)if($n(i.selection,h.type)){let d=Math.abs(h.error(t,r,i));h.apply(t,r,i)&&(s=!0,l+=d)}if(l===0)break}let a=$n(i.selection,Pe.COLLISION),n=VM(i.interactionType,t);return a&&gs(t,r,n)&&(s=!0),s&&r.computeUp(t.state.viewingMode),s}function VM(t,e){switch(t){case he.PAN:return hr.EYE_AND_CENTER;case he.ASCEND:return e.state.isGlobal?hr.EYE_AND_CENTER_SCALE:hr.EYE_AND_CENTER;default:return hr.EYE}}function Yi(t){let e=Math.min(1,t/150);return gT(e)}function UM(t,e,i){return Bm(t,e,i)*e.distance}var HM=[{type:Pe.TILT,error:UM,apply:my},{type:Pe.ALTITUDE,error:Lm,apply:Rx},{type:Pe.DISTANCE,error:Vm,apply:Px}],qM=new Vt,BM=5;var Qc=class{get pitch(){return this._pitch}get yaw(){return this._yaw}get distance(){return this._distance}get fov(){return this._fov}get size(){return this._size}constructor(e){this.viewingMode=e,this.center=_(),this._pitch=0,this._yaw=0,this._distance=0,this.direction=Or(Ex),this._fov=55,this._size=1}pixelsPerPanAtZoom(e){return this._size/2/(this._zoomToPanScale*e)}zoomAtPixelsPerPan(e){return this._size/2/(this._zoomToPanScale*e)}pixelsPerRotate(){let e=Math.max(Math.cos(Math.abs(this._pitch)),.5);return this._size/2/e}compareTo(e,i){if(this.viewingMode===me.Global){let a=(ne(this.center)+ne(e.center))/2;i.pan=Fp(this.center,e.center)*a}else i.pan=It(this.center,e.center);let r=Math.abs(e._yaw-this._yaw);r>=Math.PI&&(r=2*Math.PI-r);let s=Math.abs(e._pitch-this._pitch);i.rotate=Math.max(r,s),i.fov=e.fov-this.fov,i.sourceZoom=this._distance,i.targetZoom=e._distance}interpolate(e,i,r){this.viewingMode===me.Global?nw(e.center,i.center,r.pan,this.center):Ui(this.center,e.center,i.center,r.pan),this._distance=isFinite(i.distance)?Ae(e.distance,i.distance+r.zoomOffset,r.zoom):e.distance,this._pitch=Ae(e.pitch,i.pitch,r.rotate);let s=e._yaw,a=i._yaw;Math.abs(a-s)>=Math.PI&&(s+=2*(s<a?1:-1)*Math.PI),this._yaw=Ae(s,a,r.rotate),this._fov=Ae(e.fov,i.fov,r.fov)}copyFrom(e){q(this.center,e.center),this._pitch=e.pitch,this._yaw=e.yaw,this._distance=e.distance,q(this.direction,e.direction),this._size=e.size,this._fov=e.fov,this._zoomToPanScale=Math.atan(.5*this._fov),this.viewingMode=e.viewingMode}copyFromRenderCamera(e){let i=this._lookAtOrientation(e.center,Ox);q(this.center,e.center),ae(Bi,e.center,e.eye),ds(Bi,Bi,i),ds(Xn,e.up,i),this._distance=ne(Bi),this._distance!==0&&(Bi[0]/=this._distance,Bi[1]/=this._distance,Bi[2]/=this._distance),this._pitch=kM(Bi),this._yaw=GM(Bi,Xn),this._size=Math.sqrt(e.width*e.width+e.height*e.height),this._fov=e.fov,this._zoomToPanScale=Math.atan(.5*this._fov)}copyToRenderCamera(e){let i=this._lookAtOrientation(this.center,Ox);Nl(i,i),this._axisAngleVec3(km,this._pitch-Math.PI/2,Ex,Bi),this._axisAngleVec3(Wo,this._yaw,Bi,Bi),this._axisAngleVec3(km,this._pitch-Math.PI/2,Wo,Xn),this._axisAngleVec3(Wo,this._yaw,Xn,Xn),k(Bi,Bi,this._distance),ds(Bi,Bi,i),ds(Xn,Xn,i),e.center=this.center,e.eye=ae(Bi,this.center,Bi),e.up=Xn,e.fov=this._fov}_axisAngleVec3(e,i,r,s){let a=Math.cos(i),n=Math.sin(i);return k(Zr,r,a),Qe(Vr,e,r),k(Vr,Vr,n),k(Kn,e,(1-a)*$(e,r)),K(s,K(s,Zr,Vr),Kn)}_lookAtOrientation(e,i=jr()){return this._upAtLookAt(e,Kn),Qe(Zr,this.direction,Kn),z(Zr,Zr),Zr[0]===0&&Zr[1]===0&&Zr[2]===0&&q(Zr,km),Qe(Vr,Kn,Zr),z(Vr,Vr),i[0]=Zr[0],i[1]=Vr[0],i[2]=Kn[0],i[3]=Zr[1],i[4]=Vr[1],i[5]=Kn[1],i[6]=Zr[2],i[7]=Vr[2],i[8]=Kn[2],i}_upAtLookAt(e,i){return this.viewingMode===me.Local?q(i,Wo):z(i,e)}};function kM(t){return Math.PI-Fp(Wo,t)}function GM(t,e){let i=zM;return Math.abs(e[2])<.5?(q(i,e),t[2]>0&&k(i,i,-1)):q(i,t),Qe(Vr,i,Wo),z(Vr,Vr),Fp(km,Vr,Wo)}var Zr=_(),Vr=_(),Kn=_(),Bi=_(),Xn=_(),zM=_(),Wo=d1,Ex=c1,km=h1,Ox=jr();var Gm=class{get finished(){return this.currentTime>=this._animation.time}get time(){return this._animation.time}constructor(e){this.currentTime=0,this._animation=new vT(()=>new Qc(e)),this._current=new Qc(e)}update(e,i,r){let{source:s,target:a}=this._animation.definition,n=ae(jM,i.center,e.center),o=ne(n);o>=1e-5?(n[0]/=o,n[1]/=o,n[2]/=o):(n[0]=0,n[1]=1,n[0]=0),q(s.direction,n),q(a.direction,n),s.copyFromRenderCamera(e),a.copyFromRenderCamera(i),this._current.copyFrom(s),this._animation.update(s,a,r),this.currentTime=0,e.almostEquals(i)&&(this.currentTime=this._animation.time)}cameraAt(e,i){this._animation.cameraAt(e,this._current),this._current.copyToRenderCamera(i)}step(e,i){this.finished||(this.currentTime=this.currentTime+Nv(e),this.currentTime>=this.time&&(this.currentTime=this.time)),this.cameraAt(this.currentTime/this.time,i)}},jM=_();var et;(function(t){t[t.Ready=0]="Ready",t[t.Rejected=1]="Rejected",t[t.Running=2]="Running",t[t.Stopped=3]="Stopped",t[t.Finished=4]="Finished"})(et||(et={}));var ys=class extends te{constructor(t){super(t),this.state=et.Ready}get running(){return this.state===et.Running}get isInteractive(){return!1}get canStop(){return!1}stopController(){return!!this.canStop&&(this.state=et.Stopped,!0)}finishController(){this.state=et.Finished}get steppingFinished(){return!1}};c([p({constructOnly:!0})],ys.prototype,"view",void 0),c([p({readOnly:!0})],ys.prototype,"running",null),c([p()],ys.prototype,"state",void 0),c([p({readOnly:!0})],ys.prototype,"isInteractive",null),ys=c([S("esri.views.3d.state.controllers.CameraController")],ys);var Jn=class extends ys{constructor(){super(...arguments),this._asyncResult=null}get canStop(){return!0}set asyncResult(t){this._asyncResult&&(this._asyncResult.reject(er()),this._asyncResult=null),this.state===et.Finished||this.state===et.Stopped?(Ev(t),this.state===et.Finished?t.resolve():t.reject(er())):this._asyncResult=t}get asyncResult(){return this._asyncResult}onControllerStart(){this.state=et.Running,this.viewAnimation!=null&&this.viewAnimation.when(()=>this.updateStateFromViewAnimation(),()=>this.updateStateFromViewAnimation())}updateStateFromViewAnimation(){!this.viewAnimation||this.state!==et.Ready&&this.state!==et.Running||(this.viewAnimation.state===Gs.State.FINISHED?this.finish():this.viewAnimation.state===Gs.State.STOPPED&&(this.state=et.Stopped))}onControllerEnd(t){this.viewAnimation==null||this.viewAnimation.done||(this.state===et.Finished?this.viewAnimation.finish():this.state===et.Stopped&&this.viewAnimation.stop()),this._asyncResult&&(this.state===et.Finished?this._asyncResult.resolve():this._asyncResult.reject(er()))}finish(){this.finishController()}};Jn=c([S("esri.views.3d.state.controllers.AnimationController")],Jn);var ga=class extends Jn{get _intersectionHelper(){return this.view.sceneIntersectionHelper}constructor(t){super(t),this.type="point-to-point",this.mode="interaction",this._hasTarget=!1}initialize(){this.animation=new Gm(this.view.state.viewingMode),this.viewAnimation=this.mode==="interaction"?null:new Gs}get isInteractive(){return this.mode==="interaction"}begin(t,e){this._hasTarget=!0;let i=this.animationSettings(e);zm.copyFrom(this.view.state.camera);let r=Zi(this.view.state.viewingMode);this._intersectionHelper.intersectRay(zm.ray,r,Dx)&&(zm.center=Dx),this.animation.update(zm,t,i),this.animation.finished&&this.finish()}finish(){this.animation.currentTime=this.animation.time,super.finish()}get steppingFinished(){return this._hasTarget&&this.animation.finished}stepController(t,e){this._hasTarget&&this.animation.step(t,e)}onControllerEnd(t){this._hasTarget&&(this.animation.cameraAt(this.animation.currentTime/this.animation.time,t),this.animation.currentTime=this.animation.time),super.onControllerEnd(t)}animationSettings(t={}){return Bt(lt({apex:{maximumDistance:this.view.state.constraints.clampAltitude(1/0)/6,ascensionFactor:void 0,descensionFactor:void 0}},t),{easing:typeof t.easing=="string"?yT[t.easing]:t.easing})}};c([p({constructOnly:!0})],ga.prototype,"mode",void 0),c([p({readOnly:!0})],ga.prototype,"isInteractive",null),ga=c([S("esri.views.3d.state.controllers.PointToPointAnimationController")],ga);var zm=new $e,Dx=_();function uy(t){return t!=null&&"type"in t&&t.type==="point-to-point"}function Qo(t=QM){return[t[0],t[1],t[2],t[3]]}function tn(t,e){return WM(t[0],t[1],t[2],e,sw.get())}function WM(t,e,i,r,s=Qo()){return s[0]=t,s[1]=e,s[2]=i,s[3]=r,s}function _h(t,e,i){return Qe(i,t,e),z(i,i),i[3]=Lp(t,e),i}var QM=[0,0,1,0],WV=Cc(),QV=Cc();function $c(t,e,i,r){let s=da(e,i,$M);return Rn(t,s,r)}var $M=Wr();var to;(function(t){t[t.Ellipsoid=0]="Ellipsoid",t[t.Silhouette=1]="Silhouette"})(to||(to={}));var eu=30,wh=[1,3e8],ya=80,tu=8,iu=200,ru=1508e5,su=5,au=50,kx=5,Gx=10,nu=90,Ur={exclude:new Set([Za])};function va(t,e,i){return i[0]=e[0]/(t.fullWidth/t.pixelRatio),i[1]=e[1]/(t.fullHeight/t.pixelRatio),i}function Yc(t){for(;t>Math.PI;)t-=2*Math.PI;for(;t<-Math.PI;)t+=2*Math.PI;return t}function Yr(t,e,i){let r=ra(aw.get(),i[3],i);r==null||f1(r,xn)||(ae(rt,t.eye,e),At(rt,rt,r),t.eye=K(rt,rt,e),ae(rt,t.center,e),At(rt,rt,r),t.center=K(rt,rt,e),t.up=At(rt,t.up,r))}function zx(t,e,i,r){return Hp(t,lm(e,i,Cy),r)}function Kc(t,e,i,r){return Hp(t,da(e,i,Cy),r)}function bh(t,e,i,r){let s=Pt.get(),a=1-i;ae(s,e,t.eye);let n=ne(s),o=n*(1-a);a>=0&&o<r&&(o=r,a=-(o-n)/n),Math.abs(n-o)<1e-6||(k(s,s,a),t.eye=K(rt,t.eye,s),t.center=Ui(rt,t.center,e,a))}function ou(t,e,i){e.getScreenCenter(Ix),$c(t,e,Ix,rt)&&(e.center=rt);let r=e.distance,s=r*i;if(Math.abs(r-s)<1e-6)return;let a=k(Pt.get(),e.viewForward,s);e.eye=ae(rt,e.center,a)}var Ix=mt();function lu(t,e){xe(e,0,0,0);for(let i of t)K(e,e,i);k(e,e,1/t.length)}function Xc(t,e,i,r){return Math.sin(t/ne(e))*(i+r.radius)}function gy(t,e,i,r){return Xc(Math.PI/2,e,i,r)+(t-Math.PI/2)}var li;(function(t){t[t.Vertical=0]="Vertical",t[t.Horizontal=1]="Horizontal"})(li||(li={}));var Lx={Elevation:3e4,Angle:pt(16)},jx=pt(80);function hu(t,e,i,r,s,a){let n=_(),o=mi(),l=!0,h=!0;return t.intersectScreen(i,n,a)?o[3]=ne(n):(h=!1,e.aboveGround&&s!==to.Ellipsoid?o[3]=Math.max(ne(e.center),.9*r.radius):o[3]=ne(e.eye)-e.relativeElevation,s===to.Silhouette?io(o,e,i,n):l=$c(o,e,i,n)),{sphere:o,scenePickPoint:l?n:null,hasGeometryIntersection:h}}function wa(t,e,i,r){let s=t.relativeElevation;if(s>Lx.Elevation&&r==="global")return li.Horizontal;da(t,e,_y);let a=Math.sign(s),n=i.worldUpAtPosition(t.eye,rt);return-a*$(n,_y.direction)<Math.sin(Lx.Angle)*ne(_y.direction)?li.Vertical:li.Horizontal}function cu(t,e,i){ae(fy,i,e),t.eye=ae(rt,t.eye,fy),t.center=ae(rt,t.center,fy)}var fy=_();function io(t,e,i,r){let s=da(e,i,Cy);return s!=null&&(Pn(t,s,jm),Rn(t,s,r)?!(cs(jm,s.origin)<cs(r,s.origin))||(q(r,jm),!1):(ae(gh,e.eye,e.center),z(gh,gh),Vp(gh,-$(z(gh,gh),jm),Nx),Hp(Nx,s,r),!1))}var jm=_(),gh=_(),Nx=Qa();function yy(t,e,i,r,s,a){let n=0;if(Qe(Jm,t,e),ae(Zm,t,e),ne(t)<=s||!r.aboveGround){Qe(i,Zm,r.eye);let o=$(t,e)/(ne(t)*ne(e));if(o<.9999)n=as(o);else{let h=ne(Qe(_(),t,e))/(ne(t)*ne(e));n=Ml(h)}let l=Math.cos(N(qs.normalize(pt(a)),0,jx));n=-n-Math.max(0,ne(e)-s)/(l*s)}else ae(Fx,r.eye,r.center),Qe(i,Zm,Fx),n=-ne(Zm)/s;return z(i,i),k(i,i,ne(Jm)),n}var Fx=_();function Vx(t,e,i,r){let s,a,n=Math.cos(N(qs.normalize(pt(r)),0,jx));return s=e>i?-(e-i)/(n*i):e<-i?Math.PI-(e+i)/(n*i):as(e/i),a=t>i?-(t-i)/(n*i):t<-i?Math.PI-(t+i)/(n*i):as(t/i),(a-s)*i}function ZM(t,e,i,r,s,a,n,o,l,h){let d=Vx(t[2],e[2],a[3],o),m=l?Vx(t[0],e[0],a[3],180):e[0]-t[0],u=Math.sin(n)*m-Math.cos(n)*d,f=Math.cos(n)*m+Math.sin(n)*d;z(rt,s);let g=l?u/Math.sqrt(Math.abs(a[3]**2-$(i,rt)**2)):u/a[3],y=f/Math.sqrt(Math.abs(a[3]**2-$(i,r)**2));hs(h,g,y)}function vy(t,e,i,r,s,a,n,o,l,h){Qe(Jm,t,e),Kp(a.up,a.eye,Wm,Qm,$m),Kp([0,0,1],a.eye,rn,eo,$x),q(i,eo),q(r,rn),z(i,i),k(i,i,ne(Jm)),xg(t,z(Qm,Qm),z($m,$m),z(Wm,Wm),Ux),xg(e,Qm,$m,Wm,Hx),ZM(Ux,Hx,t,rn,eo,n,o,l,h,s)}function YM(t,e,i,r,s,a,n){ra(Km,s,r),ra(Xm,n,a),ns(vh,Km,Xm),ae(e,t,i),At(e,e,vh),K(e,e,i)}function wy(t,e,i,r,s,a){ra(Km,r,i),ra(Xm,a,s),ns(vh,Km,Xm),ae(rt,t.eye,e),At(rt,rt,vh),t.eye=K(rt,rt,e),ae(rt,t.center,e),At(rt,rt,vh),t.center=K(rt,rt,e),ae(rt,t.up,e),At(rt,rt,vh),t.up=K(rt,rt,e)}var $o={Pole:.95,Angle:pt(18),Tilt:45,TiltHysteresisMargin:1e-7},yh=!1;function du(t,e,i,r,s,a){let n=Math.abs(r)>Math.PI-$o.Angle||Math.abs(r)<$o.Angle,o=(Math.abs(t[2])<i*$o.Pole||Math.abs(e)>i)&&a;return n&&o?!yh&&s<$o.Tilt-$o.TiltHysteresisMargin?yh=!0:yh&&s>$o.Tilt+$o.TiltHysteresisMargin&&(yh=!1):yh=!1,yh}function by(t,e,i,r,s,a){if(a)_h(i,r,qx),Yr(e,t,qx);else{let n=yy(i,r,Bx,e,t[3],s);Yr(e,t,tn(Bx,n))}}function Ty(t,e,i,r,s,a,n){let o=n?20:1,l=1e-12,h,d;q(Zo,r),Ym.copyFrom(e);for(let m=0;m<o&&cs(i,Zo)>l&&(h=cs(i,Zo),vy(i,Zo,eo,rn,Zc,Ym,t,s,a,n),wy(Ym,t,rn,Zc[1],eo,Zc[0]),YM(Zo,Zo,t,rn,Zc[1],eo,Zc[0]),d=cs(i,Zo),d<h||m===0);m++)e.copyFrom(Ym)}function Wx(t,e,i,r,s,a,n){du(i,$(e.up,i),t[3],-qs.normalize(pt(s)),a,e.aboveGround)?Ty(t,e,i,r,-qs.normalize(pt(s)),a,n):by(t,e,i,r,a,n)}function KM(t,e,i,r,s,a){let{eye:n}=t;Kp([0,0,1],n,rn,eo,$x);let o=e.translation[0]*i.pan,l=s.mode==="zoom"?0:e.translation[1]*i.pan,h=Math.max(Math.sqrt(Math.abs(1-$(t.center,rn)**2/ne(t.center)**2)),.5),d=(Math.sin(a)*l+Math.cos(a)*o)/h,m=-Math.cos(a)*l+Math.sin(a)*o;switch(os(r.pan.matrix,r.pan.matrix,d,rn),r.pan.enabled=!0,s.mode){case"pan":os(r.pan.matrix,r.pan.matrix,m,eo),r.pan.enabled=!0;break;case"zoom":r.zoom=-e.translation[1]*i.zoom}}function XM(t,e,i,r,s){let{eye:a,viewRight:n}=t,o=Qe(Pt.get(),n,a),l=e.translation[0]*i.pan;switch(l!==0&&(os(r.pan.matrix,r.pan.matrix,-l,o),r.pan.enabled=!0),s.mode){case"pan":{let h=e.translation[1]*i.pan;h!==0&&(os(r.pan.matrix,r.pan.matrix,h,n),r.pan.enabled=!0);break}case"zoom":r.zoom=-e.translation[1]*i.zoom}}function Qx(t,e,i,r,s,a,n,o,l){du(t.center,$(t.up,t.center),ne(t.center),-qs.normalize(pt(a)),n,e.aboveGround)?KM(e,i,r,o,l,-qs.normalize(pt(s))):XM(e,i,r,o,l)}var rn=_(),eo=_(),$x=_(),Wm=_(),Qm=_(),$m=_(),Ux=_(),Hx=_(),Zc=ji(),qx=Qo(),Km=Rt(),Xm=Rt(),vh=Rt(),Zo=_(),rt=_(),Zm=_(),Ym=new $e,Jm=_(),Bx=_(),Cy={origin:_(),direction:_()},_y={origin:_(),direction:_()};var Zx=.6,xy=4,JM=60,Th=class extends ga{constructor(){super(...arguments),this._zoomLocation=_(),this._tmpCamera=new $e,this._tmpViewDir=_(),this._tmpRayDir=Wr(),this._targetOnSphere=_(),this._tmpCenter=_(),this._beginCamera=new $e,this._constraintOptions=new Vt(Pe.ALL_EXCEPT_COLLISION,he.ZOOM,null,this._beginCamera),this._sphere=mi()}initialize(){this._intersector=Zi(this.view.state.viewingMode)}step(t,e){if(!this.running)return;let i=this.view.state;this.animation.finished?this._beginCamera.copyFrom(i.camera):this.animation.cameraAt(1,this._beginCamera);let r=!1,s=!1;this._intersectionHelper.intersectScreen(e,this._zoomLocation,this.view.map.ground.opacity===0?Ur:{})&&(r=t>0,s=!0),this._tmpCamera.copyFrom(i.camera),r?this._intersectionHelper.intersectRay(this._tmpCamera.ray,this._intersector,this._tmpCenter)&&(this._tmpCamera.center=this._tmpCenter):this._intersectionHelper.intersectRay(this._tmpCamera.ray,this._intersector,this._zoomLocation)?this._tmpCamera.center=this._zoomLocation:q(this._zoomLocation,this._tmpCamera.center),this._updateCamera(this._tmpCamera,t,e,s),this.begin(this._tmpCamera)}animationSettings(){return{duration:600,easing:um}}_updateCamera(t,e,i,r){let s=wa(t,i,this.view.renderCoordsHelper,this.view.viewingMode),a=Math.abs(this.view.camera.position.z),n=this._zoomLocation;z(mu,t.eye),k(mu,mu,-1),da(t,i,this._tmpRayDir),z(this._tmpRayDir.direction,this._tmpRayDir.direction);let o=N(Math.min(tu,1/Math.abs($(mu,this._tmpRayDir.direction)))*a,iu,ru);if(s===li.Horizontal){let l=Zx**e;this._sphere[3]=ne(n),ae(this._tmpViewDir,t.center,t.eye);let h=Math.min(ne(this._tmpViewDir),o),d=h*l;if(l<=1&&d<xy&&(d=xy,l=d/h),Math.abs(h-d)<1e-6)return;let m=ne(t.center);if(this._sphere[3]!==m){let u=this._sphere[3]+l*(m-this._sphere[3]);t.center=k(pu,t.center,u/m)}k(this._tmpViewDir,this._tmpViewDir,-l),t.eye=K(pu,t.center,this._tmpViewDir),Ze(this.view,t,this._constraintOptions),cs(n,t.center)>1e-12&&$c(this._sphere,t,i,this._targetOnSphere)&&Wx(this._sphere,t,n,this._targetOnSphere,this.view.camera.heading,this.view.camera.tilt,!0)}else{let l=Zx**Math.abs(e),h=e>0?1:-1;ae(this._tmpViewDir,n,t.eye);let d=ne(this._tmpViewDir),m=this.view._stage.renderView.getMinimalDepthForArea(null,i[0],i[1],this.view.state.camera,JM),u=m??o;u=r&&e>0?Math.min(u,d):u,k(this._tmpRayDir.direction,this._tmpRayDir.direction,u),K(n,this._tmpRayDir.origin,this._tmpRayDir.direction);let f=u*l,g=Math.max(xy,1.01*t.nearFar[0]);if(e>0&&f<g&&(f=g,l=f/u),Math.abs(u-f)<1e-6)return;k(this._tmpRayDir.direction,this._tmpRayDir.direction,h*(1-l)),t.eye=K(pu,t.eye,this._tmpRayDir.direction),t.center=K(pu,t.center,this._tmpRayDir.direction)}gs(this.view,t)}};Th=c([S("esri.views.3d.state.controllers.ZoomStepControllerGlobal")],Th);var pu=_(),mu=_();var eA=.6,tA=4,iA=60,Ch=class extends ga{constructor(){super(...arguments),this._zoomLocation=_(),this._tmpCamera=new $e,this._tmpRayDir=_(),this._tmpCenter=_(),this._beginCamera=new $e,this._constraintOptions=new Vt(Pe.ALL,he.ZOOM,null,this._beginCamera)}step(t,e){if(!this.running)return;let i=this.view.state;this.animation.finished?this._beginCamera.copyFrom(i.camera):this.animation.cameraAt(1,this._beginCamera),this._tmpCamera.copyFrom(i.camera);let r=Zi(this.view.state.viewingMode),s=!1;t>0?(s=this._intersectionHelper.intersectScreenFreePointFallback(e,this._zoomLocation,this.view.map.ground.opacity===0?Ur:{}),this._intersectionHelper.intersectRay(this._tmpCamera.ray,r,this._tmpCenter)&&(this._tmpCamera.center=this._tmpCenter)):this._intersectionHelper.intersectRay(this._tmpCamera.ray,r,this._zoomLocation)?this._tmpCamera.center=this._zoomLocation:q(this._zoomLocation,this._tmpCamera.center);let a=eA**t,n=this.view._stage.renderView.getMinimalDepthForArea(Ja(this.view),e[0],e[1],this.view.state.camera,iA);ae(uu,this._tmpCamera.eye,this._zoomLocation),z(uu,uu);let o=N(Math.min(tu,1/Math.abs($(rA,uu)))*Math.abs(this.view.camera.position.z),iu,ru);if(n=n??o,n){let l=_();ae(l,this._zoomLocation,this._tmpCamera.eye),(n<ne(l)||!s)&&(z(l,l),K(this._zoomLocation,this._tmpCamera.eye,k(l,l,n)))}this._updateCamera(this._tmpCamera,a,this._zoomLocation),this.begin(this._tmpCamera)}animationSettings(){return{duration:600,easing:um}}_updateCamera(t,e,i){ae(this._tmpRayDir,i,t.eye);let r=ne(this._tmpRayDir),s=r*e,a=e<=1,n=Math.max(tA,1.01*t.nearFar[0]);s!==0&&(a&&s<n&&(s=n,e=s/r),Math.abs(r-s)<1e-6||(k(this._tmpRayDir,this._tmpRayDir,e),t.eye=ae(Yx,i,this._tmpRayDir),t.center=Ui(Yx,t.center,i,1-e),Ze(this.view,t,this._constraintOptions)))}};Ch=c([S("esri.views.3d.state.controllers.ZoomStepControllerLocal")],Ch);var Yx=_(),rA=xt(0,0,1),uu=_();var fu=class extends Ti{constructor(e,i){super(!0),this._view=e,this.registerIncoming("double-click",i,r=>this._handleDoubleClick(r))}_handleDoubleClick(e){let i=e.data;if(lT(i,"primary")){let r=this._view.state.isGlobal?new Th({view:this._view,mode:"animation"}):new Ch({view:this._view,mode:"animation"});this._view.state.switchCameraController(r),r.step(Math.log(.5)/Math.log(.6),mt(i.x,i.y)),e.stopPropagation()}}};function Jx(t,e,i){return t===me.Global?new Ry(i):new Sy(e,i)}var Sy=class{constructor(e,i){this._elevationProvider=e,this._referenceEllipsoid=Ue(i),this._unitInMeters=uc(i,this._referenceEllipsoid.metersPerDegree)}compute(e,i,r,s,a){a||(a={near:0,far:0});let n=e[2]*this._unitInMeters,o=n,l=n-s,h=this._elevationProvider?.visibleElevationBounds;h&&(n=l>=0?o-this._unitInMeters*h.min:this._unitInMeters*h.max-o);let d={x:(r=r??new kr({xmin:0,ymin:0,zmin:0,xmax:0,ymax:0,zmax:0})).xmax-r.xmin,y:r.ymax-r.ymin,z:4*Math.max(r.xmax-r.xmin,r.ymax-r.ymin)},m=Math.max(d.x,d.y,d.z);ae(Yo,i,e),xh[0]=Yo[0]>0?r.xmax:r.xmin,xh[1]=Yo[1]>0?r.ymax:r.ymin,xh[2]=Yo[2]>0?m/2:-m/2,ae(xh,xh,e),z(Yo,Yo);let u=1.1*$(xh,Yo)*this._unitInMeters,f=Math.sqrt(n*(n+2*this._referenceEllipsoid.radius)),g=Math.max(r.xmax-r.xmin,r.ymax-r.ymin),y=g*nA*this._unitInMeters,v=g*oA*this._unitInMeters,w=N((n-v)/(y-v),0,1)**3,b=Math.min(Ae(f,u,w),f)*Math.max(Math.log(Math.abs(l)),1);return eS(Math.min(b,Math.max(34064e4,m))/this._unitInMeters,_u,this._unitInMeters,a)}},Ry=class{constructor(e){this._referenceEllipsoid=Ue(e)}compute(e,i,r,s,a){a||(a={near:0,far:0});let n=ne(e),o=n-this._referenceEllipsoid.radius,l=this._referenceEllipsoid.radius+Math.min(0,s),h=Math.abs(o-s),d=Math.max(h,Math.abs(o)),m=Math.sqrt(d*(d+2*l)),u=n+this._referenceEllipsoid.radius,f=1.2*Ae(m,u,ch(d)),g=(Math.log(d)-Kx)/(sA-Kx);return eS(f,N(_u-g*(_u-Xx),Xx,_u),1,a)}};function eS(t,e,i,r){let s=aA/i,a=t/e;return a>s?(r.far=t,r.near=a):(r.near=s,r.far=r.near*e),r}var Kx=7.983,sA=16.994,_u=2e4,Xx=100,aA=2,nA=.001,oA=1e-4,xh=_(),Yo=_();var Jc=class extends te{constructor(t){super(t)}initialize(){this.addHandles(this.view.basemapTerrain.on("elevation-change",t=>this._handleElevationChangeEvent(t)))}_handleElevationChangeEvent(t){if(this.view.state.cameraController)return;let e=this.view.state.camera;t.spatialReference!=null&&tm(this.view,e,t.extent,t.spatialReference)&&this._applyToCurrentCamera()}_applyToCurrentCamera(){this.view.state.updateCamera(t=>gs(this.view,t,hr.EYE_AND_CENTER))}};c([p({constructOnly:!0})],Jc.prototype,"view",void 0),Jc=c([S("esri.views.3d.state.SurfaceCollisionConstraint")],Jc);var Sh=class extends te{constructor(t){super(t),this.nearFarHeuristic=Jx(t.view.state.viewingMode,t.view.basemapTerrain,t.view.renderCoordsHelper.spatialReference)}initialize(){this.addHandles([P(()=>[this.view.constraints?.clipDistance?.near,this.view.constraints?.clipDistance?.far],()=>this._clipDistanceNearFarChanged()),P(()=>this.view.constraints?.clipDistance?.mode,()=>this._updateNearFar()),this.view.state.events.on("before-camera-change",t=>this._updateCameraNearFar(t)),P(()=>this.view.renderDataExtent,()=>this._updateNearFar(),we),P(()=>[this.view.constraints?.altitude?.min,this.view.constraints?.altitude?.max],()=>this._updateAltitude(),we),P(()=>this.view.constraints?.tilt?.max,()=>this._updateTiltMax(),we),P(()=>this.view.constraints?.tilt?.mode,()=>this._updateTilt(),we),P(()=>this.view.state?.camera,()=>this._updateTiltAutoMax(),we),P(()=>[this.view.map?.ground?.navigationConstraint?.type,this.view.state?.constraints?.collision?.enabled],()=>this._updateCollision(),we)]),this.view.state.isLocal&&this.addHandles(P(()=>this.view.renderDataExtent,t=>this._updateLocalSurfaceDistance(t),Ie)),this._updateNearFar(),this.view.state.viewingMode!==me.Local&&this._updateAltitude(),this._updateTilt(),this._updateCollision(),this._set("surfaceCollisionConstraint",new Jc({view:this.view}))}destroy(){this.surfaceCollisionConstraint&&(this.surfaceCollisionConstraint.destroy(),this._set("surfaceCollisionConstraint",null))}_clipDistanceNearFarChanged(){let t=this.view.constraints?.clipDistance;t&&t.mode!=="auto"&&this.view.state.updateCamera(e=>tS(e,t))}_updateNearFar(){this.view.state.updateCamera(t=>this._updateCameraNearFar(t))}_updateCameraNearFar(t){let e=this.view.constraints&&this.view.constraints.clipDistance;(e?e.mode:"auto")==="manual"?tS(t,e):this._updateCameraNearFarAuto(t,e)}_updateCameraNearFarAuto(t,e){this.nearFarHeuristic.compute(t.eye,t.center,this.view.renderDataExtent,Xl(this.view,t.eye),t),e&&e.autoUpdate(t.near,t.far)}_updateCollision(){let t=this.view.map?.ground?.navigationConstraint?.type,e=!t||t==="stay-above",i=this.view.state.constraints.collision;if(e!==i.enabled){i.enabled=e,e&&this._reapplyConstraints(Pe.COLLISION);let r=this.view.constraints&&this.view.constraints.tilt;r&&r.mode!=="auto"||this._updateTiltAuto()}}_updateAltitude(){let t=this.view.constraints&&this.view.constraints.altitude;t&&this.view.state.viewingMode!==me.Local?this.view.state.constraints.altitude={min:t.min,max:t.max}:this.view.state.constraints.altitude=null,this._reapplyConstraints()}_updateTiltMax(){let t=this.view.constraints&&this.view.constraints.tilt;t&&t.mode!=="auto"&&(this._updateTiltManual(t),this._reapplyConstraints())}_updateTilt(){let t=this.view.constraints&&this.view.constraints.tilt;(t?t.mode:"auto")==="manual"?this._updateTiltManual(t):this._updateTiltAuto(),this._reapplyConstraints()}_updateTiltManual(t){let e=this.view.state.constraints;e.tilt=e.createConstantMaxTilt(pt(t.max))}_updateTiltAuto(){let t=this.view.state.constraints;t.tilt=t.createDefaultTilt(),this._updateTiltAutoMax()}_updateTiltAutoMax(){let t=this.view.constraints&&this.view.constraints.tilt;if(!t||t.mode!=="auto")return;let e=this.view.state.constraints;if(e.tilt){let i=e.tilt(this.view.state.camera.distance).max;t.autoUpdate(Ga(i))}}_updateLocalSurfaceDistance(t){if(t==null)return;let e=Math.max(t.width,t.height);if(e<=0)return;t.zmax!=null&&t.zmin!=null&&(e=Math.max(e,t.zmax-t.zmin));let i=this.view.state,r=3*e/Math.atan(i.camera.fov/2);r!==i.constraints.distance&&(i.constraints.distance=r)}_reapplyConstraints(t=Pe.ALL){this.view.state.updateCamera(e=>Ze(this.view,e,new Vt(t,he.NONE,null)))}};function tS(t,e){e&&(t.near=e.near,t.far=e.far)}c([p({constructOnly:!0})],Sh.prototype,"view",void 0),c([p({readOnly:!0})],Sh.prototype,"surfaceCollisionConstraint",void 0),Sh=c([S("esri.views.3d.state.ConstraintsManager")],Sh);var Ko=class extends ys{set desiredCamera(t){this._set("desiredCamera",t.clone())}constructor(t){super(t)}get canStop(){return!0}get constraintEnabled(){return this.view.state.constraints.collision.enabled}onControllerStart(){this.state=et.Running,this.addHandles(this.view.basemapTerrain.on("elevation-change",t=>this._handleElevationChangeEvent(t))),this._applyCorrection()}onControllerEnd(){this.removeAllHandles()}stepController(){}_handleElevationChangeEvent(t){(t.spatialReference==null||tm(this.view,this.desiredCamera,t.extent,t.spatialReference))&&this._applyCorrection()}_applyCorrection(){this.view.state.updateCamera(t=>{t.copyViewFrom(this.desiredCamera),gs(this.view,t,hr.EYE_AND_CENTER)||this.constraintEnabled||(this.state=et.Stopped)})}};c([p({constructOnly:!0})],Ko.prototype,"desiredCamera",null),Ko=c([S("esri.views.3d.state.controllers.SurfaceCollisionCorrectionController")],Ko);var gu=class{constructor(e,i,r){this._target=e,this._options=i,this.view=r,this.state="pending",this._animationController=null,this.promise=new Promise((s,a)=>{this._resolveCallback=s,this._rejectCallback=a;let n=new AbortController;this._options.signal!=null&&gn(this._options.signal,()=>this.abort()),this._abortController=n,this._waitForReady()})}_resolve(e){if(this.state!=="finished")return this.state="finished",this._resolveCallback(e)}_reject(e){if(this.state!=="finished")return this.state="finished",this._rejectCallback(e)}abort(e=!1){this._abortController.abort(),this.state==="wait-for-animation-finish"&&!e&&this._animationController!=null&&this.view.state.cameraController===this._animationController&&this._animationController.running&&this._animationController.stopController(),this._reject(er())}_waitForReady(){return Re(this,null,function*(){if(this.state="wait-for-ready",!this.view.ready)try{yield pc(()=>this.view.ready,this._abortController.signal)}catch(e){return this._reject(e)}this._createViewPoint()})}_createViewPoint(){return Re(this,null,function*(){if(this.state!=="finished"){this.state="wait-for-viewpoint",this._animationController=this._options.animate?this._getAnimationController():null;try{let e=yield UC(this.view,this._target,this._abortController.signal);if(this.state==="finished")return;let i=e?this._getCameraFromViewpoint(e):null;if(i==null)return;if(this._options.animate){if(this._animationController==null)return;this._startAnimation(i,this._animationController)}else this.view.stateManager.setStateCamera(i.camera,{applyConstraints:!i.isFullySpecified,positionAndOrientationOnly:!0,doNotCancelGoToOperation:!0}),this._resolve()}catch(e){this._reject(e)}}})}_getCameraFromViewpoint(e){let i=!!(this._target instanceof Fn&&this._target.camera||this._target instanceof ms),r=e.camera;if(r==null)return null;if(!this.view.stateManager.isCompatible(r)){let a=r.position,n=a&&a.spatialReference,o=n?n.wkid:"none",l=this.view.spatialReference?.wkid;return this._reject(new si("GotoAnimation:incompatible-spatialreference",`Resulting camera has an incompatible spatial reference (camera: ${o}, view: ${l})`,{camera:r})),null}let s=ha(this.view,r);return s==null?(this._reject(new si("GotoAnimation:invalid-camera","Resulting camera is invalid")),null):{viewpoint:e,camera:s,isFullySpecified:i}}_startAnimation(e,i){this.state="wait-for-animation-finish";let r=i.viewAnimation;if(r==null)return void this._reject(new si("GotoAnimation:missing-animation","Unreachable code in view.stateManager"));if(r.update(e.viewpoint,"running"),!i.running||i.viewAnimation==null||i.viewAnimation.target!==e.viewpoint||this.view.state.cameraController!==i)return this.abort();let s;e.isFullySpecified?(s=new Ko({view:this.view,desiredCamera:e.camera}),gs(this.view,e.camera,hr.EYE_AND_CENTER)):Ze(this.view,e.camera),i.begin(e.camera,this._options);let a=()=>{let o=this.view.state.cameraController;s&&(o&&o.running?uy(o)&&o.viewAnimation!=null&&o.viewAnimation.target===e.viewpoint&&(this.view.state.cameraController=s):i.viewAnimation!=null&&i.viewAnimation.target===e.viewpoint&&i.state===et.Finished&&(this.view.state.cameraController=s))},n=o=>{if(this.view.state!=null)switch(i.state){case et.Finished:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this._resolve()}break;case et.Ready:case et.Rejected:case et.Running:case et.Stopped:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this._reject(o)}}};r.when(a,o=>n(o)),i.asyncResult={resolve:()=>n(),reject:o=>n(o)}}_getAnimationController(){let e=null,i=null,r=this.view.state.cameraController;return uy(r)&&(r.updateStateFromViewAnimation(),r.running&&(e=r,i=e.viewAnimation)),e==null&&(e=new ga({view:this.view,mode:"animation"}),i=e.viewAnimation,this.view.state.switchCameraController(e),e.state===et.Rejected)?(i?.stop(),this._reject(new si("GotoAnimation:goto-cannot-interrupt","Cannot start an animation while interacting")),null):e}};var jt=class extends te{constructor(t){super(t),this.ready=!1,this._windowDevicePixelRatio=1,this._devicePixelRatioOverride=null,this._idleTimeout=iS,this.test={viewStateManager:this,contentCameraResetState:new Map,setDevicePixelRatio:e=>this._devicePixelRatioOverride=e,renderState:null,get maximumPixelRatio(){return this.viewStateManager.view.qualitySettings.maximumPixelRatio},get updatingIgnoreRenderState(){return this.renderState!=null},get idleTimeoutEnabled(){return this.viewStateManager._idleTimeout>0},set idleTimeoutEnabled(e){this.viewStateManager._idleTimeout=e?iS:0}},this._propertiesPool=new wr({frustum:im},this),this._cameraSetByUser=!1,this._gotoOperation=null,this._cameraChangeTime=0,this._tmpCanvasSize=new Ay}initialize(){this._cameraChangeTime=performance.now(),this.addHandles([Er(()=>this.view.state.events,"before-camera-change",t=>t&&this._updateElevation(t)),P(()=>this.view.state?.camera,(t,e)=>this._cameraChangedHandler(t,e),we)]),ka(()=>this.view.state?.camera,t=>this._updateElevation(t),{once:!0,sync:!0}),this.addHandles([Sl({prepare:()=>this._prepareFrame()}),P(()=>this.view.state.cameraController,()=>{this._cameraSetByUser=!0,this.removeHandles(vu)}),Er(()=>this.view.state.events,"camera-projection-changed",()=>this.notifyChange("scale"))])}destroy(){this.exit(),this._propertiesPool=G(this._propertiesPool)}get camera(){let t=this._get("camera");if(!this.ready)return t;let e=Ag(this.view,this.view.state.camera,Py);return e&&t&&e.equals(t)?t:e.clone()}set camera(t){this._updatePropertyBeforeReady("camera",t)||(this.view.elevationProvider?.enableCache(!0),this.setStateCamera(ha(this.view,t),{applyConstraints:!1})||pe.getLogger(this).error("#camera=","Invalid camera",t),this.view.elevationProvider?.enableCache(!1))}get contentCamera(){let t=this._get("contentCamera");if(!this.ready)return t;let e=Ag(this.view,this.view.state.contentCamera,Py);return e&&t&&e.equals(t)?t:e.clone()}set contentCamera(t){if(this._updatePropertyBeforeReady("contentCamera",t))return;let e=ha(this.view,t);e!=null?(this._updateElevation(e),this.view.state.contentCamera=e):this.view.state.contentCamera=null}installContentCameraReset(t){if(this.removeHandles(My),this.test.contentCameraResetState.clear(),!this.view.state.fixedContentCamera)return!1;let e=this.zoom,i=this.view.state.camera.distance**2,r=n1(this.view.state.camera.center),s=t.sticky?this.contentCamera.clone():null;return this.addHandles([P(()=>this.contentCamera,()=>{t.sticky||(this.removeHandles(My),this.test.contentCameraResetState.clear())}),P(()=>this.zoom,a=>{a!==void 0&&e!==void 0&&(this.test.contentCameraResetState.set("view.zoom",Math.abs(a-e)/2),Math.abs(a-e)>2?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=s))}),P(()=>this.view.state.camera,a=>{let n=cs(r,a.center);this.test.contentCameraResetState.set("camera.center",n/i),n>i?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=s)})],My),!0}get center(){return this.ready?this.view.pointsOfInterest.centerOnContent.location:this._get("center")}set center(t){this._updatePropertyBeforeReady("center",t)||(t?this.isCompatible(t)?this.setStateCamera(this._centerToCamera(t),{applyConstraints:!0})?this.view.pointsOfInterest.centerOnContent.runTask():pe.getLogger(this).error("#center=","Invalid center",t):pe.getLogger(this).error("#center=","Center has an incompatible spatial reference (center: "+(t.spatialReference?t.spatialReference.wkid:"none")+", view: "+this.view.spatialReference?.wkid+")",t):pe.getLogger(this).error("#center=","Center may not be null or undefined"))}get visibleArea(){if(!this.ready){let t=this._get("extent");return t?y1.fromExtent(t):null}return Ib(this.view,this.view.pointsOfInterest.focus.renderLocation)}get extent(){if(!this.ready)return this._get("extent");let t=this.view,e=Db(t,t.state.camera,t.pointsOfInterest.centerOnContent.renderLocation);return e??this._get("extent")}set extent(t){this._updatePropertyBeforeReady("extent",t)||(t?this.isCompatible(t)?this.setStateCamera(this._extentToCamera(t),{applyConstraints:!0})||pe.getLogger(this).error("#extent=","Invalid extent",t):pe.getLogger(this).error("#extent=","Extent has an incompatible spatial reference (extent: "+(t.spatialReference?t.spatialReference.wkid:"none")+", view: "+this.view.spatialReference?.wkid+")",t):pe.getLogger(this).error("#extent=","Extent may not be null or undefined"))}get frustum(){let t=this._propertiesPool.get("frustum");return t.renderCoordsHelper=this.view.renderCoordsHelper,t.update(this.view.state.camera),t}get constraintsManager(){return this._constraintsManager}get _initialViewpoint(){let t=this.view.map;return t&&"initialViewProperties"in t?t.initialViewProperties?.viewpoint:void 0}get hasInitialView(){return!!this._initialViewpoint}get scale(){if(!this.ready)return this._get("scale");let t=this.view.basemapTerrain.tilingScheme,e=this.view.pointsOfInterest.cameraOnSurface.scale;return t&&e?Ab(this.view,e,this.view.state.contentCamera,t):this._get("scale")}set scale(t){this._updatePropertyBeforeReady("scale",t)||this.setStateCamera(this._scaleToCamera(t),{applyConstraints:!0})||pe.getLogger(this).error("#scale=","Invalid scale",t)}get padding(){if(!this.ready)return this._get("padding");let t=this.view.state.camera,e=t.padding,i=t.pixelRatio,r=this._get("padding"),s=Math.round(e[$i.TOP]/i),a=Math.round(e[$i.RIGHT]/i),n=Math.round(e[$i.BOTTOM]/i),o=Math.round(e[$i.LEFT]/i);return r!=null&&r.top===s&&r.right===a&&r.bottom===n&&r.left===o?r:{top:s,right:a,bottom:n,left:o}}set padding(t){this._updatePropertyBeforeReady("padding",t)||(this._paddingToArray(t,this.view.state.camera.pixelRatio,yu),this.view.state.updateCamera(e=>e.padding=yu))}_paddingToArray(t,e,i){t?ls(i,t.top||0,t.right||0,t.bottom||0,t.left||0):ls(i,0,0,0,0);for(let r=0;r<4;r++)i[r]=Math.round(i[r]*e)}get screenCenter(){let t=this.padding;return gp((this.view.width-(t.left+t.right))/2+t.left,(this.view.height-(t.top+t.bottom))/2+t.top)}get viewpoint(){return this.ready?VC(this.view,this.camera):this._get("viewpoint")}set viewpoint(t){if(!this._updatePropertyBeforeReady("viewpoint",t))if(t)if(this.isCompatible(t))this.setStateCamera(this._viewpointToCamera(t),{applyConstraints:!t.camera})||pe.getLogger(this).error("#viewpoint=","Invalid viewpoint",t);else{let e=t.camera!=null?t.camera.position:t.targetGeometry,i=e!=null&&e.spatialReference;pe.getLogger(this).error("#viewpoint=","Viewpoint has an incompatible spatial reference (viewpoint: "+(i?i.wkid:"none")+", view: "+this.view.spatialReference?.wkid+")",t)}else pe.getLogger(this).error("#viewpoint=","Viewpoint may not be null or undefined")}get zoom(){return this.ready?Lb(this.view,this.scale):this._get("zoom")}set zoom(t){this._updatePropertyBeforeReady("zoom",t)||t===void 0||this.setStateCamera(this._zoomToCamera(t),{applyConstraints:!0})||pe.getLogger(this).error("#zoom=","Invalid zoom",t)}_computeCanvasSize(){if(this._devicePixelRatioOverride)return this.view.state.contentPixelRatio=this._devicePixelRatioOverride,this._tmpCanvasSize.width=Math.round(this.view.surface.clientWidth*this._devicePixelRatioOverride),this._tmpCanvasSize.height=Math.round(this.view.surface.clientHeight*this._devicePixelRatioOverride),this._tmpCanvasSize.pixelRatio=this._devicePixelRatioOverride,this._tmpCanvasSize;let t=Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio),e=(this._usePhysicalPixelRendering?this._windowDevicePixelRatio:t)*this.view.resolutionScale;this._tmpCanvasSize.width=Math.round(this.view.surface.clientWidth*e),this._tmpCanvasSize.height=Math.round(this.view.surface.clientHeight*e);let i=this.view._stage.renderView.renderingContext?.parameters.maxTextureSize;return i&&Yl(this._tmpCanvasSize,i),this._tmpCanvasSize.pixelRatio=this._tmpCanvasSize.width>0?this._tmpCanvasSize.width/this.view.surface.clientWidth*.5+this._tmpCanvasSize.height/this.view.surface.clientHeight*.5:e,this.view.state&&(this.view.state.contentPixelRatio=Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio)),this._tmpCanvasSize}get _rasterPixelRatio(){return this._devicePixelRatioOverride!=null?this._devicePixelRatioOverride:this._usePhysicalPixelRenderingAny?this._windowDevicePixelRatio:Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio)}get _usePhysicalPixelRendering(){return this.view?._stage?.renderer.isFeatureEnabled(fs.PhysicalPixelRendering)??!1}get _usePhysicalPixelRenderingAny(){let t=this.view?._stage?.renderer;return t&&(t.isFeatureEnabled(fs.PhysicalPixelRendering,Zt.IDLE)||t.isFeatureEnabled(fs.PhysicalPixelRendering,Zt.INTERACTING)||t.isFeatureEnabled(fs.PhysicalPixelRendering,Zt.ANIMATING))}preinit(t){return!(this._isOverridden("center")&&!wn(this.center.spatialReference,t))&&!(this._isOverridden("camera")&&!wn(this.camera.position.spatialReference,t))&&!(this._isOverridden("extent")&&!wn(this.extent.spatialReference,t))&&!!(!this._isOverridden("viewpoint")||wn(this.viewpoint.targetGeometry?.spatialReference,t)&&wn(this.viewpoint.camera?.position?.spatialReference,t))}init(){this._constraintsManager=new Sh({view:this.view}),this._prepareFrame();let t=this._getInitialProperties();this._cameraSetByUser=!1,this._set("ready",!0);for(let e of t)this.set(e.name,e.value);if(!this._cameraSetByUser){let e=this._initialViewpoint||this.view.initialExtent;e&&this.isCompatible(e)?this._setInitialView(e):this.view.state.viewingMode===me.Local&&this.addHandles(ka(()=>this.view.basemapTerrain.ready,()=>{this.removeHandles(vu),this._setInitialView(this.view.dataExtent)},{once:!0,initial:!0}),vu)}}exit(){this._cancelGoToOperation(),this.ready&&(this._override("padding",this.padding),this._set("ready",!1),this._clearOverride("hasInitialView"),this._cameraSetByUser=!1,this.removeHandles(vu),this._constraintsManager=G(this._constraintsManager))}goTo(t,e){return Re(this,null,function*(){return e=lt({animate:!0},e),this._gotoOperation!=null&&this._gotoOperation.abort(e.animate),this._gotoOperation=new gu(t,e,this.view),this.view.resourceController.scheduler.stopFrame(),this._gotoOperation.promise})}debugSetCameraOnContent(){this.setStateCamera(Sb(this.view),{applyConstraints:!1})}step(t){let e=this.view.state,i=e?.cameraController;i&&(e.updateCamera(r=>i.stepController(t,r)),i.steppingFinished&&i.finishController())}_cancelGoToOperation(){this._gotoOperation!=null&&(this._gotoOperation.abort(),this._gotoOperation=null)}_getInitialProperties(){let t=new Set,e=[];for(let{propertyName:i,overrides:r}of hA){let s=t.has(i),a=this._isOverridden(i);!s&&a&&e.push({name:i,value:this._get(i)}),this._clearOverride(i),(s||a)&&r.forEach(n=>t.add(n))}return e}_setInitialView(t){if(t==null||this._cameraSetByUser)return;if(t instanceof ms)return void this.setStateCamera(ha(this.view,t),{applyConstraints:!1});if(t instanceof Fn){if(t.targetGeometry instanceof kr){let s=rm(this.view,t.targetGeometry,0,.5,Oc.LOCKED);return void(s!=null&&this.setStateCamera(ha(this.view,s),{applyConstraints:!0}))}let i={applyConstraints:!t.camera},r=this._viewpointToCamera(t);return void this.setStateCamera(r,i)}let e=rm(this.view,t,0,.5,Oc.LOCKED);e!=null&&this.setStateCamera(ha(this.view,e),{applyConstraints:!0})}_updatePropertyBeforeReady(t,e){return!this.ready&&(this._override(t,e),e&&lA.has(t)&&this._override("hasInitialView",!0),!0)}isCompatible(t){return t!=null&&(t instanceof Fn?t.camera?this.isCompatible(t.camera):this.isCompatible(t.targetGeometry):t instanceof ms?this.isCompatible(t.position):t.spatialReference&&!M1(t.spatialReference,this.view.spatialReference))}_getPreservingHeadingTilt(t=cA){return this._cameraSetByUser?(t.heading=this.camera.heading,t.tilt=this.camera.tilt):(t.heading=0,t.tilt=.5),t}_centerPointAtDistanceToCamera(t,e,i=ro){let{heading:r,tilt:s}=this._getPreservingHeadingTilt(),a=Ob(this.view,r,s,t,e,Oc.ADJUST);return a==null?null:(i.copyFrom(this.view.state.camera),i.eye=a.eye,i.center=a.center,i.up=a.up,i)}_centerToCamera(t){let e;if(t.hasZ)e=this.view.state.camera.distance;else{let{centerOnContent:i}=this.view.pointsOfInterest;i.runTask(),e=i.distance}return this._centerPointAtDistanceToCamera(t,e)}_extentToCamera(t){let{heading:e,tilt:i}=this._getPreservingHeadingTilt(),r=rm(this.view,t,e,i,Oc.ADJUST,Py);return r?ha(this.view,r):null}_scaleToCamera(t){if(t==null)return null;let e=this.view,i=e.pointsOfInterest.centerOnContent;i.runTask();let r=i.renderLocation,s=e.pointsOfInterest.cameraOnSurface.renderLocation,a=Eb(e,t,e.state.contentCamera,r,s);return this._centerPointAtDistanceToCamera(r,a)}_zoomToCamera(t){return this._scaleToCamera(Nb(this.view,t))}_viewpointToCamera(t){return ha(this.view,FC(this.view,t))}setStateCamera(t,e){return!(t==null||!this.view.state.stopActiveCameraController())&&(this._cameraSetByUser=!0,e.doNotCancelGoToOperation||this._cancelGoToOperation(),this.view.state.updateCamera(i=>{e.positionAndOrientationOnly?(i.eye=t.eye,i.center=t.center,i.up=t.up,i.fov=t.fov):i.copyFrom(t),e.applyConstraints&&Ze(this.view,i)}),e.applyConstraints||(this.view.state.cameraController=new Ko({view:this.view,desiredCamera:t})),!0)}_prepareFrame(){let{surface:t,canvas:e}=this.view;if(!t||!e)return;this._windowDevicePixelRatio=window.devicePixelRatio;let i=this._computeCanvasSize();if(i.width!==0&&i.height!==0&&(e.width===i.width&&e.height===i.height||(e.width=i.width,e.height=i.height),this.view.state)){let r=this.view.state.camera;r.fullWidth===i.width&&r.fullHeight===i.height&&r.pixelRatio===i.pixelRatio||(ro.copyFrom(r),ro.pixelRatio!==i.pixelRatio&&(this._paddingToArray(this.padding,i.pixelRatio,yu),ro.padding=yu),ro.fullWidth=i.width,ro.fullHeight=i.height,ro.pixelRatio=i.pixelRatio,this.view.state.camera=ro),this._updateViewState()}}_updateElevation(t){let e=this.view.basemapTerrain?.spatialReference,i=this.view.renderCoordsHelper?.getAltitude(t.eye)??0,r=e?Xl(this.view,t.eye):0;t.relativeElevation=i-r}_updateViewState(){this.test.renderState!=null?this.view.state.mode=this.test.renderState:this.view.animation?this.view.state.mode=Zt.ANIMATING:this.view.interacting?this.view.state.mode=Zt.INTERACTING:(this.view.state.mode===Zt.ANIMATING&&(this._cameraChangeTime=0),performance.now()-this._cameraChangeTime<this._idleTimeout?this.view.state.mode=Zt.INTERACTING:this.view.state.mode=Zt.IDLE),this.view.state.rasterPixelRatio=this._rasterPixelRatio}_cameraChangedHandler(t,e){t&&e&&t.almostEquals(e)||(this._cameraChangeTime=performance.now(),this._updateViewState())}};c([p({type:ms,dependsOn:["view.state.camera","ready"]})],jt.prototype,"camera",null),c([p({type:ms,dependsOn:["view.state.contentCamera","ready"]})],jt.prototype,"contentCamera",null),c([p({type:_r})],jt.prototype,"center",null),c([p()],jt.prototype,"visibleArea",null),c([p({type:kr})],jt.prototype,"extent",null),c([p({readOnly:!0})],jt.prototype,"frustum",null),c([p()],jt.prototype,"_constraintsManager",void 0),c([p({readOnly:!0})],jt.prototype,"constraintsManager",null),c([p()],jt.prototype,"_initialViewpoint",null),c([p({readOnly:!0})],jt.prototype,"hasInitialView",null),c([p({readOnly:!0,type:Boolean})],jt.prototype,"ready",void 0),c([p({type:Number})],jt.prototype,"scale",null),c([p()],jt.prototype,"padding",null),c([p({readOnly:!0})],jt.prototype,"screenCenter",null),c([p({constructOnly:!0})],jt.prototype,"view",void 0),c([p({type:Fn})],jt.prototype,"viewpoint",null),c([p({type:Number})],jt.prototype,"zoom",null),c([p({readOnly:!0})],jt.prototype,"_rasterPixelRatio",null),c([p({readOnly:!0})],jt.prototype,"_usePhysicalPixelRendering",null),c([p({readOnly:!0})],jt.prototype,"_usePhysicalPixelRenderingAny",null),c([p()],jt.prototype,"_windowDevicePixelRatio",void 0),c([p()],jt.prototype,"_devicePixelRatioOverride",void 0),jt=c([S("esri.views.3d.state.ViewStateManager")],jt);var Ay=class{constructor(){this.width=0,this.height=0,this.pixelRatio=1}},lA=new Set(["camera","viewpoint","extent","scale","center","zoom"]),hA=[{propertyName:"camera",overrides:["viewpoint"]},{propertyName:"viewpoint",overrides:["extent"]},{propertyName:"extent",overrides:["center","scale"]},{propertyName:"center",overrides:[]},{propertyName:"scale",overrides:["zoom"]},{propertyName:"zoom",overrides:[]},{propertyName:"padding",overrides:[]}],cA={heading:0,tilt:0},Py=new ms,ro=new $e,yu=ni(),vu="pending-initial-view",My="content-camera-reset",iS=300,Ey=100;var ki=class extends ys{constructor(){super(...arguments),this.startCamera=new $e,this.currentCamera=new $e,this._lastInteraction=0}get isInteractive(){return performance.now()-this._lastInteraction<Ey}stepController(t,e){e.copyViewFrom(this.currentCamera),this.currentCamera.copyFrom(e)}onControllerStart(t){this.state=et.Running,this.startCamera.copyFrom(t),this.currentCamera.copyFrom(t)}onControllerEnd(t){t.copyViewFrom(this.currentCamera)}commitCamera(){this._lastInteraction=performance.now(),setTimeout(()=>this.notifyChange("isInteractive"),Ey),this.view.state.updateCamera(t=>this.stepController(0,t)),this.steppingFinished&&this.finishController()}};c([p({readOnly:!0})],ki.prototype,"isInteractive",null),c([p()],ki.prototype,"_lastInteraction",void 0),ki=c([S("esri.views.3d.state.controllers.InteractiveController")],ki);var Ki;(function(t){t[t.CENTER=0]="CENTER",t[t.EYE=1]="EYE"})(Ki||(Ki={}));var Xo=class extends ki{get _intersectionHelper(){return this.view.sceneIntersectionHelper}constructor(t){super(t),this.pivot=Ki.CENTER,this._rotScale=0,this._lastPoint=ji(),this._tmpWorldUp=_(),this._tmpViewDir=_(),this._tmpRotCurPoint=ji(),this._tmpTransf=Rt(),this._tmpAxis=_(),this._tmpPivotPoint=_(),this._pivotPos=_(),this._constraintOptions=new Vt(Pe.ALL,he.TUMBLE,0,this.startCamera)}initialize(){this._rotScale=this.pivot===Ki.CENTER?3:1.5}begin(t){if(this.running){switch(this.pivot){case Ki.EYE:q(this._pivotPos,this.startCamera.eye),this._constraintOptions.interactionType=he.LOOK_AROUND,this._constraintOptions.tiltMode=Fr.LOOK_AROUND,this._constraintOptions.selection=Pe.NONE;break;case Ki.CENTER:{let e=this._intersectionHelper.intersectRayFreePointFallback(this.startCamera.ray,this._pivotPos,this.view.map.ground.opacity===0?Ur:{});e||q(this._pivotPos,this.startCamera.center),this._constrainPivotPoint(t,e),this.startCamera.center=this._pivotPos,this._constraintOptions.interactionType=he.TUMBLE,this._constraintOptions.tiltMode=Fr.TUMBLE,this._constraintOptions.selection=Pe.ALL&~Pe.DISTANCE;break}}va(this.startCamera,t,this._lastPoint)}}_constrainPivotPoint(t,e){let i=this.startCamera,r=_();ae(r,this._pivotPos,i.eye);let s=ne(r),a=Math.abs(this.view.camera.position.z);this.view.renderCoordsHelper.worldUpAtPosition(i.eye,rS);let n=Math.max(Math.min(kx,1/Math.abs($(rS,i.viewForward)))*a,Gx);e&&(n=Math.min(s,n));let o=mt(i.width/i.pixelRatio*.5,i.height/i.pixelRatio*.5),l=wa(this.startCamera,o,this.view.renderCoordsHelper,this.view.viewingMode),h=this.view._stage.renderView.getMinimalDepthForArea(Ja(this.view),i.fullWidth/i.pixelRatio*.5,i.fullHeight/i.pixelRatio*.5,i,2.5*nu,nu),d=this.view._stage.renderView.getMinimalDepthForArea(Ja(this.view),t[0],t[1],i,nu);h==null&&d==null||(h=h??d??0,d=d==null||l===li.Horizontal?h:d,n=h>d?d:h,n=e?Math.min(n,s):n),z(r,r),q(this._pivotPos,K(this._tmpPivotPoint,i.eye,k(this._tmpPivotPoint,r,n)))}update(t){if(this.running){switch(this.pivot){case Ki.EYE:this.currentCamera.center=this._applyRotation(this.currentCamera,t,this.currentCamera.center,this._pivotPos);break;case Ki.CENTER:this.currentCamera.center=this._pivotPos,this.currentCamera.eye=this._applyRotation(this.currentCamera,t,this.currentCamera.eye,this._pivotPos)}Ze(this.view,this.currentCamera,this._constraintOptions),this.commitCamera()}}end(){this.running&&this.finishController()}_applyRotation(t,e,i,r){this.view.renderCoordsHelper.worldUpAtPosition(r,this._tmpWorldUp),va(t,e,this._tmpRotCurPoint);let s=(this._lastPoint[1]-this._tmpRotCurPoint[1])*this._rotScale,a=(this._tmpRotCurPoint[0]-this._lastPoint[0])*this._rotScale;ae(this._tmpViewDir,i,r);let n=ne(this._tmpViewDir),o=as($(this._tmpViewDir,this._tmpWorldUp)/n);if(this.pivot===Ki.EYE){s*=-.5;let l=.5*Math.PI-o,h=.5*Math.PI*.99;s=l-Math.max(-h,Math.min(h,l+s))}return s=N(s+o,_i.min,_i.max)-o,Qe(this._tmpAxis,t.up,this._tmpViewDir),this.pivot===Ki.CENTER&&(a=-a),ra(this._tmpTransf,a,this._tmpWorldUp),os(this._tmpTransf,this._tmpTransf,s,this._tmpAxis),At(this._tmpViewDir,this._tmpViewDir,this._tmpTransf),t.up=At(Oy,t.up,this._tmpTransf),K(Oy,r,this._tmpViewDir),gr(this._lastPoint,this._tmpRotCurPoint),Oy}};c([p()],Xo.prototype,"pivot",void 0),Xo=c([S("esri.views.3d.state.controllers.RotateController")],Xo);var Oy=_(),rS=_();var Rh=class extends Ti{constructor(e,i,r,s){super(!0),this._view=e,this.pointerActions=i,this._pivot=r,this.registerIncoming("drag",s,a=>this._handleDrag(a))}_handleDrag(e){let i=e.data;if(i.pointers.size>1||!eh(e.data,this.pointerActions))return;let r=mt(i.center.x,i.center.y);switch(i.action){case"start":this._cameraController&&(this._cameraController.end(),this._cameraController=null),this._cameraController=new Xo({view:this._view,pivot:this._pivot}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(r);break;case"update":this._cameraController&&this._cameraController.update(r);break;case"end":this._cameraController&&(this._cameraController.end(),this._cameraController=null)}e.stopPropagation()}};var wu="esri-fov-overlay",bu={base:wu,outer:`${wu}-outer`,reset:`${wu}-reset`,text:`${wu}-text`},ba=class extends Wv{constructor(t){super(t),this.onReset=()=>{},this._messagesCommon=null,this._messagesUnits=null,this.fov=null}render(){return mc("div",{class:bu.outer},mc("div",{class:bu.base},mc("p",{class:bu.text},this._overlay),mc("p",{class:bu.reset,onclick:this.onReset,title:this._messagesCommon.reset},this._reset)))}get _overlay(){let{fov:t,_messagesUnits:e}=this;if(!e||t==null)return"";let i=bb(Ga(t),"degrees","arithmetic","arithmetic",0),r=dA/(2*Math.tan(t/2));return`${i} | ${wb(e,r,"millimeters",0,"abbr")} |`}get _reset(){return this._messagesUnits&&this.fov!=null?"\u21BA":""}};c([p()],ba.prototype,"onReset",void 0),c([p(),eg("esri/t9n/common")],ba.prototype,"_messagesCommon",void 0),c([p(),eg("esri/core/t9n/Units")],ba.prototype,"_messagesUnits",void 0),c([p()],ba.prototype,"fov",void 0),c([p()],ba.prototype,"_overlay",null),c([p()],ba.prototype,"_reset",null),ba=c([S("esri.widgets.FovOverlay")],ba);var dA=Math.sqrt(1872);var so=class extends ki{constructor(t){super(t),this.onStop=null,this._timeOutId=void 0,this._onReset=()=>{this._startSize=this._lastDrag=null,this._setFov(pA),this.updateTimeout()},this._center=_(),this._viewForward=_(),this._constraints=new Vt(Pe.ALL,he.ZOOM)}begin(t){fA(t)?this._showOverlay().fov=t.fov:(this._lastDrag=t[1],this._startSize=null,this._ensureStartSize(this.view.state.camera))}updateTimeout(){clearTimeout(this._timeOutId),this._timeOutId=setTimeout(this.onStop,1500)}update(t){if(this._lastDrag==null)return this._lastDrag=t[1],this._startSize=null,void this._ensureStartSize(this.view.state.camera);let e=-(this._lastDrag-t[1])/2;this._lastDrag=t[1],this.step(e)}step(t){if(!this.running)return void(this._startSize=this._lastDrag=null);let e=this.view.state,i=this.currentCamera.copyFrom(e.camera),r=Ga(i.fov)+t,s=pt(N(r,mA,uA));s!==i.fov?this._setFov(s):this._showOverlay().fov=i.fov}finish(){this.running&&(this._startSize=this._lastDrag=null,this.finishController())}destroy(){this.hideOverlay()}onControllerEnd(t){super.onControllerEnd(t),this._startSize=this._lastDrag=null,this.hideOverlay()}_showOverlay(){return this._overlay||(this._overlay=new HT({id:"esri.FovOverlay",node:new ba({onReset:this._onReset})}),this.view.ui.add(this._overlay)),this._overlay.widget}hideOverlay(){this._overlay&&(this.view.ui.remove(this._overlay),this._overlay=G(this._overlay))}_setFov(t){let e=this.view.state,i=this.currentCamera.copyFrom(e.camera),r=this._ensureStartSize(i)/Math.tan(t/2),s=K(Dy,this._center,k(Dy,this._viewForward,-r));i.eye=s,i.fov=t,this._constraints.interactionStartCamera=e.camera,this._constraints.interactionFactor=Yi(this.currentCamera.height-e.camera.height),Ze(this.view,this.currentCamera,this._constraints),this.begin(i),this.commitCamera()}_ensureStartSize(t){if(this._startSize==null){q(this._viewForward,t.viewForward);let e=this.view._stage.renderView.getMinimalDepthForArea(null,t.fullWidth/t.pixelRatio*.5,t.fullHeight/t.pixelRatio*.5,t,ya),i=It(t.eye,this.view.pointsOfInterest.centerOnContent.renderLocation),r=e??i;K(this._center,t.eye,k(Dy,this._viewForward,r)),this._startSize=r*Math.tan(t.fov/2)}return this._startSize}};c([p()],so.prototype,"onStop",void 0),so=c([S("esri.views.3d.state.controllers.FovController")],so);var pA=pt(new ms().fov),mA=10,uA=150,Dy=_();function fA(t){return!Array.isArray(t)}var Cu=class extends ki{constructor(){super(...arguments),this._pickPoint=_(),this._tmpP0=ji(),this._panAxisAngle=Qo(),this._tmpRayDir=_(),this._tmpRayDirPick=_(),this._targetOnSphere=_(),this._navMode=li.Horizontal,this._tmpRay={origin:_(),direction:_()},this.dragBeginPoint=mt(),this._normalizedAnchorPoint=ji(),this._constraintOptions=new Vt(Pe.ALL_EXCEPT_COLLISION,he.ZOOM,0,this.startCamera),this._sphere=mi(),this._hasPickPoint=!1}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(t){if(!this.running)return;gr(this.dragBeginPoint,t),va(this.startCamera,t,this._normalizedAnchorPoint);let e=Ue(this.view.spatialReference),i=hu(this._intersectionHelper,this.startCamera,t,e,to.Ellipsoid,this.view.map.ground.opacity===0?Ur:{});if(this._navMode=wa(this.startCamera,t,this.view.renderCoordsHelper,this.view.viewingMode),this._navMode===li.Horizontal)this._hasPickPoint=!!i.scenePickPoint,this._pickPoint=i.scenePickPoint??this._pickPoint,this._sphere=i.sphere;else{let r;da(this.startCamera,t,this._tmpRay),z(this._tmpRay.direction,this._tmpRay.direction),i.scenePickPoint!=null&&(ae(this._tmpRayDirPick,this.startCamera.eye,i.scenePickPoint),r=ne(this._tmpRayDirPick));let s=Math.abs(this.view.camera.position.z);this.view.renderCoordsHelper.worldUpAtPosition(this.startCamera.eye,sS);let a=N(Math.min(eu,1/Math.abs($(sS,this._tmpRay.direction)))*s,wh[0],wh[1]),n=this.view._stage.renderView.getMinimalDepthForArea(null,t[0],t[1],this.view.state.camera,ya);a=n??a,a=r!=null?Math.min(a,r):a,this._hasPickPoint=!0,k(this._tmpRay.direction,this._tmpRay.direction,a),K(this._pickPoint,this._tmpRay.origin,this._tmpRay.direction)}}update(t){if(this.running){if(this.currentCamera.eye=this.startCamera.eye,this.currentCamera.center=this.startCamera.center,this.currentCamera.up=this.startCamera.up,this._navMode===li.Horizontal){ae(this._tmpRayDir,this.currentCamera.center,this.currentCamera.eye);let e=ne(this._tmpRayDir);va(this.currentCamera,t,this._tmpP0);let i=12*(this._normalizedAnchorPoint[1]-this._tmpP0[1]),r=e*2**i,s=this.view.state.constraints.minimumPoiDistance;if(i<0&&r<s&&(r=s),Math.abs(e-r)<1e-6)return;if(this._hasPickPoint&&r<e){let a=1-(1-r/e)*(1-this._sphere[3]/ne(this.currentCamera.center));this.currentCamera.center=k(Tu,this.currentCamera.center,a)}k(this._tmpRayDir,this._tmpRayDir,-r/e),this.currentCamera.eye=K(Tu,this.currentCamera.center,this._tmpRayDir),this._constraintOptions.interactionFactor=Yi(Wa(this.dragBeginPoint,t)),Ze(this.view,this.currentCamera,this._constraintOptions),this._hasPickPoint&&(io(this._sphere,this.currentCamera,this.dragBeginPoint,this._targetOnSphere),_h(this._pickPoint,this._targetOnSphere,this._panAxisAngle),Yr(this.currentCamera,this._sphere,this._panAxisAngle))}else{let e=ne(this._tmpRay.direction);va(this.currentCamera,t,this._tmpP0);let i=12*(this._normalizedAnchorPoint[1]-this._tmpP0[1]),r=e*2**i,s=this.view.state.constraints.minimumPoiDistance;if(i<0&&r<s&&(r=s),Math.abs(e-r)<1e-6)return;k(this._tmpRayDir,this._tmpRay.direction,1-r/e),this.currentCamera.eye=K(Tu,this.currentCamera.eye,this._tmpRayDir),this.currentCamera.center=K(Tu,this.currentCamera.center,this._tmpRayDir)}gs(this.view,this.currentCamera),this.commitCamera()}}finish(){this.running&&this.finishController()}};Cu=c([S("esri.views.3d.state.controllers.ZoomControllerGlobal")],Cu);var Tu=_(),sS=_();var xu=class extends ki{constructor(){super(...arguments),this._tmpP=_(),this._tmpDir=_(),this._tmpN=_(),this._tmpP0=ji(),this._tmpPoi=_(),this._tmpRayDir=_(),this.dragBeginPoint=mt(),this._normalizedAnchorPoint=ji(),this._constraintOptions=new Vt(Pe.ALL,he.ZOOM,0,this.startCamera,_()),this._plane=Qa()}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(t){if(!this.running)return;gr(this.dragBeginPoint,t),va(this.startCamera,t,this._normalizedAnchorPoint);let e=this._intersectionHelper.intersectScreenFreePointFallback(t,this._tmpP,this.view.map.ground.opacity===0?Ur:{});ae(this._tmpDir,this._tmpP,this.startCamera.eye);let i=ne(this._tmpDir);z(this._tmpDir,this._tmpDir);let r=Math.abs(this.view.camera.position.z),s=N(Math.min(eu,1/Math.abs($(_A,this._tmpDir)))*r,wh[0],wh[1]),a=this.view._stage.renderView.getMinimalDepthForArea(Ja(this.view),t[0],t[1],this.view.state.camera,ya);s=a??s,s=e?Math.min(s,i):s,k(this._tmpDir,this._tmpDir,s),K(this._tmpP,this.startCamera.eye,this._tmpDir),ae(this._tmpN,this.startCamera.eye,this.startCamera.center),z(this._tmpN,this._tmpN),this._tmpN[1]<0&&Gr(this._tmpN,this._tmpN),Up(this._tmpP,this._tmpN,this._plane)}update(t){if(!this.running)return;zx(this._plane,this.currentCamera,this.dragBeginPoint,this._tmpPoi)||q(this._tmpPoi,this.currentCamera.center),va(this.currentCamera,t,this._tmpP0);let e=4*(this._tmpP0[1]-this._normalizedAnchorPoint[1]);gr(this._normalizedAnchorPoint,this._tmpP0),ae(this._tmpRayDir,this._tmpPoi,this.currentCamera.eye);let i=ne(this._tmpRayDir),r=i*(1-e);this._constraintOptions.interactionDirection&&(q(this._constraintOptions.interactionDirection,this._tmpRayDir),k(this._constraintOptions.interactionDirection,this._constraintOptions.interactionDirection,Math.sign(e)/i));let s=this.view.state.constraints.minimumPoiDistance;e>=0&&r<s&&(r=s,e=-(r-i)/i),Math.abs(i-r)<1e-6||(k(this._tmpRayDir,this._tmpRayDir,e),this.currentCamera.eye=K(Jo,this.currentCamera.eye,this._tmpRayDir),Ui(Jo,this.currentCamera.center,this._tmpPoi,e),this._tmpPoi[2]>this.startCamera.center[2]?Jo[2]=Math.max(this.startCamera.center[2],Jo[2]):Jo[2]=Math.min(this.startCamera.center[2],Jo[2]),this.currentCamera.center=Jo,this._constraintOptions.interactionFactor=Yi(Wa(this.dragBeginPoint,t)),Ze(this.view,this.currentCamera,this._constraintOptions),this.commitCamera())}finish(){this.running&&this.finishController()}};xu=c([S("esri.views.3d.state.controllers.ZoomControllerLocal")],xu);var Jo=_(),_A=xt(0,0,1);var Su=class extends Ti{constructor(e,i,r){super(!0),this._view=e,this.pointerActions=i,this._fovModifier=r,this.registerIncoming("drag",[r],s=>this._handleZoom(s)),this.registerIncoming("drag",s=>this._handleZoom(s))}_handleZoom(e){let i=e.data;if(i.pointers.size>1||!eh(e.data,this.pointerActions))return;let r=mt(i.center.x,i.center.y);switch(i.action){case"start":{this._cameraController?.finish();let s=this._view,a=e.modifiers.has(this._fovModifier);this._cameraController=a?new so({view:s,onStop:()=>this._stopController()}):s.state.isGlobal?new Cu({view:s}):new xu({view:s}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(r);break}case"update":this._cameraController?.update(r);break;case"end":this._cameraController instanceof so?this._cameraController.updateTimeout():this._stopController()}e.stopPropagation()}_stopController(){this._cameraController?.finish(),this._cameraController=null}};var an=class extends ki{constructor(t){super(t),this._filteredSurfaceElevation=0,this._transformation={translation:[0,0,0],heading:0,tilt:0,zoom:0},this._keysButtonState=[0,0,0,0,0,0,0,0,0,0,0,0],this._tmpCamera=new $e,this._headingStart=0,this._constraintOptions=new Vt(Pe.ALL,he.NONE,0,new $e,null,Fr.LOOK_AROUND)}handleEventGamepad(t){let e=qg(t,this.view.navigation.gamepad,this._transformation);(t.action==="end"||mm(e))&&this.finishController()}activateDirection(t){this._keysButtonState[t]=1,Bg(this._keysButtonState,this._transformation)}directionActive(t){return this._keysButtonState[t]===1}countActiveDirections(){return this._keysButtonState.reduce((t,e)=>e>0?t+1:t,0)}deactivateDirection(t){this._keysButtonState[t]=0;let e=Bg(this._keysButtonState,this._transformation);mm(e)&&this.finishController()}onControllerStart(t){this._filteredSurfaceElevation=this.view.pointsOfInterest.cameraOnSurface.location.z,this._headingStart=this.view.camera.heading,super.onControllerStart(t)}_updateFilteredSurfaceElevation(t){let e=this.view.pointsOfInterest.cameraOnSurface.location.z,i=1;this._filteredSurfaceElevation+=i*(e-this._filteredSurfaceElevation)*t}stepController(t,e){this._updateStartHeading(),this._updateFilteredSurfaceElevation(t),this.currentCamera.copyViewFrom(e),this._updateCameraCenter(),this._constraintOptions.interactionStartCamera?.copyFrom(this.currentCamera),this._calculateControlTransformation(t,this.currentCamera,el),this._applyDisabledMovementTypes(el),this._applyPan(el.pan),this._applyRotate(el.rotate),this._applyZoom(el.zoom),this._applyAscend(el.ascend),this._constraintOptions.interactionType=he.NONE,this._constraintOptions.selection=Pe.COLLISION,Ze(this.view,this.currentCamera,this._constraintOptions),super.stepController(t,e)}_updateStartHeading(){this._transformation.heading!==0&&(this._headingStart=this.view.camera.heading)}_applyRotate(t){if(!t.enabled)return;let e=this.currentCamera;ae(Cr,e.center,e.eye),At(Cr,Cr,t.matrix),e.center=K(Cr,Cr,e.eye),e.up=At(Cr,e.up,t.matrix),this._constraintOptions.interactionType=he.LOOK_AROUND,this._constraintOptions.selection=Pe.ALL_EXCEPT_COLLISION,Ze(this.view,e,this._constraintOptions)}_applyPan(t,e=this.currentCamera){t.enabled&&(e.eye=At(Cr,e.eye,t.matrix),e.center=At(Cr,e.center,t.matrix),this.view.state.isGlobal&&(e.up=At(Cr,e.up,t.matrix)),this._constraintOptions.interactionType=he.PAN,this._constraintOptions.selection=Pe.ALL,Ze(this.view,e,this._constraintOptions))}_applyZoom(t){if(!t)return;let e=this.currentCamera.viewForward;this.currentCamera.eye=K(Cr,this.currentCamera.eye,k(Pt.get(),e,t)),q(ed,e),Gr(ed,ed),this._constraintOptions.interactionDirection=ed,this._constraintOptions.interactionType=he.ZOOM,this._constraintOptions.selection=Pe.ALL_EXCEPT_COLLISION,Ze(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null}_applyAscend(t){if(!t)return;let e=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,Pt.get());if(this._constraintOptions.interactionDirection=q(ed,e),this.view.state.isGlobal){let i=ne(this.currentCamera.eye),r=(i+t)/i;this.currentCamera.eye=k(Cr,this.currentCamera.eye,r),this.currentCamera.center=k(Cr,this.currentCamera.center,r)}else{let i=k(Pt.get(),e,t);this.currentCamera.eye=K(Cr,this.currentCamera.eye,i),this.currentCamera.center=K(Cr,this.currentCamera.center,i)}this._updateCameraCenter(),this._constraintOptions.interactionType=he.ASCEND,this._constraintOptions.selection=Pe.COLLISION,Ze(this.view,this.currentCamera,this._constraintOptions)&&this._updateCameraCenter(),this._constraintOptions.selection=Pe.ALL_EXCEPT_COLLISION,Ze(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null}_calculateControlTransformation(t,e,i){CA(i);let r=this._computeVelocities(t);this.view.state.isLocal?this._calculateControlTransformationLocal(r,e,i):this._calculateControlTransformationGlobal(r,e,i)}_updateCameraCenter(){let t=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,e=this.view.renderCoordsHelper,i=this.currentCamera.ray;this.currentCamera.center=e.intersectManifoldClosestSilhouette(i,t,Cr)}_calculateControlTransformationLocal(t,e,i){let{viewRight:r,viewForward:s}=e,a=this._transformation,n=this.view.navigation.gamepad,o=xe(Pt.get(),s[0],s[1],0);z(o,o);let l=a.translation[0]*t.pan;if(l!==0){let g=k(Pt.get(),r,l);lg(i.pan.matrix,i.pan.matrix,g),i.pan.enabled=!0}switch(n.mode){case"pan":{let g=-a.translation[1]*t.pan;if(g!==0){let y=k(Pt.get(),o,g);lg(i.pan.matrix,i.pan.matrix,y),i.pan.enabled=!0}i.zoom=a.zoom*t.zoom;break}case"zoom":i.zoom=(-a.translation[1]+a.zoom)*t.zoom;break;default:n.mode}let h=a.translation[2]*t.ascend;i.ascend=h;let d=-a.heading*t.rotate;d!==0&&(os(i.rotate.matrix,i.rotate.matrix,d,this.view.renderCoordsHelper.worldUpAtPosition(e.eye,Pt.get())),i.rotate.enabled=!0);let m=a.tilt*t.rotate,u=Bs(this.view.renderCoordsHelper,e.center,e.eye),f=N(u+m,_i.min,_i.max)-u;f&&(os(i.rotate.matrix,i.rotate.matrix,f,r),i.rotate.enabled=!0)}_calculateControlTransformationGlobal(t,e,i){let{eye:r,viewRight:s}=e,a=this._transformation,n=this.view.navigation.gamepad,o=Qe(Pt.get(),s,r);z(o,o),Gr(o,o),Qx(this.startCamera,e,a,t,this.view.camera.heading,this._headingStart,this.view.camera.tilt,i,n),this._tmpCamera.copyFrom(this.currentCamera),this._applyPan(el.pan,this._tmpCamera);let l=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,h=a.translation[2]*t.ascend;i.ascend=h;let d=-a.heading*t.rotate;d!==0&&(os(i.rotate.matrix,i.rotate.matrix,d,this._tmpCamera.eye),i.rotate.enabled=!0);let m=a.tilt*t.rotate,u=this._clampTiltDeltaGlobalToValidRange(m,e.ray,l);u!==0&&(os(i.rotate.matrix,i.rotate.matrix,u,this._tmpCamera.viewRight),i.rotate.enabled=!0),i.zoom+=a.zoom*t.zoom}_clampTiltDeltaGlobalToValidRange(t,e,i){let r=Ue(this.view.spatialReference),s=Xc(_i.min,e.origin,i,r),a=0,n=0,o=Pt.get();if(this.view.renderCoordsHelper.intersectManifold(e,i,o)){let l=Bs(this.view.renderCoordsHelper,o,e.origin);a=Xc(l,e.origin,i,r),n=Xc(_i.max,e.origin,i,r)}else{Pn(Hl(ql,i+r.radius),e,o);let l=Math.PI+Lp(e.direction,o);a=gy(l,e.origin,i,r),n=gy(_i.max,e.origin,i,r)}return N(a+t,s,n)-a}_getPointAbsoluteSurfaceElevation(t,e,i){let{renderCoordsHelper:r}=this.view,s=r.getAltitude(t),a=e+Math.abs(s-e);return r.setAltitude(i,a,t),a}_clampedDistanceToSurface(t,e){let{renderCoordsHelper:i}=this.view,{camera:r}=this.view.state,{direction:s}=Pb(this.view,e,0,nS,TA),a=i.intersectManifoldClosestSilhouette(Fs(e,s),t,Pt.get()),n=It(e,a),o=i.intersectManifoldClosestSilhouette(Fs(e,Ll(Pt.get(),e,r.center)),t,Pt.get()),l=It(e,o);return Math.min(n,l)}_computeHeadingRotateRadius(t){let{renderCoordsHelper:e,state:i}=this.view,{camera:r,isGlobal:s}=i,a=e.intersectManifoldClosestSilhouette(r.ray,this._filteredSurfaceElevation,Pt.get());if(s){let n=ae(Pt.get(),t,a),o=ne(n);k(n,n,1/o);let l=z(Pt.get(),t),h=as($(l,n));return o*Math.sin(Math.min(yA,h))}{let n=q(Pt.get(),t);return e.setAltitude(n,this._filteredSurfaceElevation),It(a,n)}}_minimumAscendVelocity(){return this.view.state.constraints.collision.enabled?0:vA}_computeVelocities(t){let e=this._filteredSurfaceElevation,i=e+Ue(this.view.spatialReference).radius,{camera:r,isGlobal:s}=this.view.state,a=Pt.get(),n=this._getPointAbsoluteSurfaceElevation(r.eye,e,a),o=this._clampedDistanceToSurface(e,a),l=r.width/2,h=aS*r.width,d=aS*r.width,m=o*Math.tan(.5*r.fovX)/l,u=m/i,f=m/this._computeHeadingRotateRadius(a),g=n-e;return{pan:(s?u:m)*h*t,ascend:Math.max(this._minimumAscendVelocity()*t,2**(h*t/l)*g-g),zoom:2**(h*t/l)*o-o,rotate:N(f*d,wA,bA)*t}}_applyDisabledMovementTypes(t){this.disableMovements==null||this.disableMovements.mode!==void 0&&this.view.state.viewingMode!==this.disableMovements.mode||(t.zoom=this.disableMovements.zoom?0:t.zoom,t.ascend=this.disableMovements.ascend?0:t.ascend,t.pan.enabled=!this.disableMovements.pan,this.disableMovements.pan&&vc(t.pan.matrix),t.rotate.enabled=!this.disableMovements.rotate,this.disableMovements.rotate&&vc(t.rotate.matrix))}static activatesFor(t,e){let i=qg(e,t.navigation.gamepad,gA);return!(e.action==="end"||mm(i))}};c([p({constructOnly:!0})],an.prototype,"gamepadDevice",void 0),c([p({constructOnly:!0})],an.prototype,"disableMovements",void 0),an=c([S("esri.views.3d.state.controllers.GamepadKeyboardController")],an);var gA={translation:[0,0,0],heading:0,tilt:0,zoom:0},nS=80,yA=pt(nS),aS=.75,vA=5,wA=pt(30),bA=pt(80),el={zoom:0,ascend:0,pan:{enabled:!1,matrix:Rt()},rotate:{enabled:!1,matrix:Rt()}},Cr=_(),ed=_(),TA=Rb();function CA(t){t.zoom=0,t.ascend=0,t.pan.enabled=!1,vc(t.pan.matrix),t.rotate.enabled=!1,vc(t.rotate.matrix)}var Ru=class extends Ti{constructor(e){super(!0),this._view=e,this._watchHandles=new Tl,this._handle=this.registerIncoming("gamepad",i=>this._handleEventGamepad(i)),this._handle.pause()}onInstall(e){super.onInstall(e),this._watchHandles.add([P(()=>this._view.navigation.gamepad.enabled,i=>{i?this._handle.resume():(this._handle.pause(),this._cameraControllerGamepad&&(this._cameraControllerGamepad.finishController(),this._cameraControllerGamepad=null))},Ie),P(()=>this._view.navigation.gamepad.device,i=>{this._cameraControllerGamepad&&i&&this._cameraControllerGamepad.gamepadDevice!==i&&(this._cameraControllerGamepad.finishController(),this._cameraControllerGamepad=null)})])}onUninstall(){this._watchHandles.removeAll(),super.onUninstall()}_handleEventGamepad(e){let i=this._view.navigation.gamepad.device;if(i&&e.data.device!==i)return;let r=this._cameraControllerGamepad?.running;if(r||an.activatesFor(this._view,e.data)){if(!r){let s=new an({view:this._view,gamepadDevice:e.data.device});this._view.state.switchCameraController(s),s.state!==et.Rejected&&(this._cameraControllerGamepad=s)}this._cameraControllerGamepad&&this._cameraControllerGamepad.running&&this._cameraControllerGamepad.gamepadDevice===e.data.device&&this._cameraControllerGamepad.handleEventGamepad(e.data)}}};var Hr;(function(t){t[t.LEFT=0]="LEFT",t[t.RIGHT=1]="RIGHT",t[t.FORWARD=2]="FORWARD",t[t.BACKWARD=3]="BACKWARD",t[t.UP=4]="UP",t[t.DOWN=5]="DOWN",t[t.HEADINGLEFT=6]="HEADINGLEFT",t[t.HEADINGRIGHT=7]="HEADINGRIGHT",t[t.TILTUP=8]="TILTUP",t[t.TILTDOWN=9]="TILTDOWN",t[t.ZOOMIN=10]="ZOOMIN",t[t.ZOOMOUT=11]="ZOOMOUT"})(Hr||(Hr={}));var Pu=class extends Ti{constructor(e,i){super(!0),this._view=e,this._keyToDirection=new Map,this._keyToAction=new Map,this._disableMovements={pan:!0,zoom:!1,ascend:!0,rotate:!1,mode:me.Local},this._stickyKeyTimeoutHandle=void 0,this._stickyKeyDuration=200,this._addKeysMapping(i),this.registerIncoming("key-down",null,r=>this._handleKeyDown(r)),this.registerIncoming("key-up",null,r=>this._handleKeyUp(r)),this.registerIncoming("blur",null,()=>this._handleStop()),this._visibilityHandle=cT(r=>r?null:this._handleStop())}onUninstall(){this._visibilityHandle?.remove(),this._handleStop()}setStickyKeyDuration(e){this._stickyKeyDuration=e}_addKeysMapping(e){this._addKeyMapping(e.pan.left,Hr.LEFT),this._addKeyMapping(e.pan.right,Hr.RIGHT),this._addKeyMapping(e.pan.forward,Hr.FORWARD),this._addKeyMapping(e.pan.backward,Hr.BACKWARD),this._addKeyMapping(e.pan.up,Hr.UP),this._addKeyMapping(e.pan.down,Hr.DOWN),this._addKeyMapping(e.lookAround.headingLeft,Hr.HEADINGLEFT),this._addKeyMapping(e.lookAround.headingRight,Hr.HEADINGRIGHT),this._addKeyMapping(e.lookAround.tiltUp,Hr.TILTUP),this._addKeyMapping(e.lookAround.tiltDown,Hr.TILTDOWN),this._addKeyMapping(e.zoom.zoomIn,Hr.ZOOMIN),this._addKeyMapping(e.zoom.zoomOut,Hr.ZOOMOUT),this._addKeyAction(e.reset.heading,()=>this._resetHeading()),this._addKeyAction(e.reset.tilt,()=>this._resetTilt())}_addKeyMapping(e,i){for(let r of this._eachKey(e))this._keyToDirection.set(r,i)}*_eachKey(e){typeof e=="string"?yield e:yield*ap(e)}_addKeyAction(e,i){for(let r of this._eachKey(e))this._keyToAction.set(r,i)}_handleKeyDown(e){if(e.data.native.ctrlKey||e.data.native.metaKey)return;let i=this._keyToAction.get(e.data.key);if(i!=null)return e.stopPropagation(),void i();let r=this._keyToDirection.get(e.data.key);if(r!=null&&(this._cameraControllerKeyboard&&this._cameraControllerKeyboard.running||(this._cameraControllerKeyboard=new an({view:this._view,disableMovements:this._disableMovements}),this._view.state.switchCameraController(this._cameraControllerKeyboard)),this._cameraControllerKeyboard.running)){if(e.stopPropagation(),this._cameraControllerKeyboard.directionActive(r)||(this._cameraControllerKeyboard.activateDirection(r),this._cameraControllerKeyboard.countActiveDirections()>1||!this._isPanning(r)))return;this._stickyKeyDuration>0&&(this._stickyKeyTimeoutHandle=setTimeout(()=>{this._stickyKeyTimeoutHandle=void 0,this._stickyDirection!=null&&this._stickyDirection!==void 0&&(this._cameraControllerKeyboard?.deactivateDirection(this._stickyDirection),this._stickyDirection=void 0)},this._stickyKeyDuration))}}_handleStop(){this._cameraControllerKeyboard?.running&&(this._cameraControllerKeyboard.finishController(),this._cameraControllerKeyboard=null)}_handleKeyUp(e){if(e.data.native.ctrlKey||e.data.native.metaKey||!this._cameraControllerKeyboard?.running)return;let i=this._keyToDirection.get(e.data.key);if(i==null)return;e.stopPropagation();let r=this._stickyKeyTimeoutHandle===void 0;this._stickyKeyTimeoutHandle===void 0||this._cameraControllerKeyboard?.countActiveDirections()!==1?(this._cameraControllerKeyboard?.deactivateDirection(i),r&&(this._stickyDirection=void 0)):this._stickyDirection=i}_isPanning(e){return e<=3}_resetHeading(){this._view.goTo({heading:0}).catch(()=>{})}_resetTilt(){this._view.goTo({tilt:0}).catch(()=>{})}};var Mu=class extends Ti{constructor(e,i){super(!0),this._view=e,this.registerIncoming("mouse-wheel",[i],r=>this._handleFov(r)),this.registerIncoming("mouse-wheel",r=>this._handleZoom(r))}_handleZoom(e){if(!this._mouseWheelZoomEnabled)return;let i=e.data;this._zoomController?.running||(this._stopFovController(),this._zoomController=this._view.state.isGlobal?new Th({view:this._view,mode:"interaction"}):new Ch({view:this._view,mode:"interaction"}),this._view.state.switchCameraController(this._zoomController)),this._zoomController.step(-i.deltaY/60,mt(i.x,i.y)),e.preventDefault(),e.stopPropagation()}_handleFov(e){this._mouseWheelZoomEnabled&&(this._fovController?.running||(this._zoomController?.finish(),this._fovController?.hideOverlay(),this._fovController=new so({view:this._view,onStop:()=>this._stopFovController()}),this._view.state.switchCameraController(this._fovController),this._fovController.state!==et.Rejected)?(this._fovController.updateTimeout(),this._fovController.step(e.data.deltaY/20),e.preventDefault(),e.stopPropagation()):this._stopFovController())}get _mouseWheelZoomEnabled(){return this._view.navigation.actionMap.mouseWheel==="zoom"}_stopFovController(){this._fovController?.finish(),this._fovController=null}};var ao=class{constructor(e){this._gain=e}reset(e){this._value=e}set gain(e){this._gain=e}get value(){return this._value===void 0?0:this._value}update(e){this._value===void 0?this._value=e:this._value=this._gain*e+(1-this._gain)*this._value}};var vs=class extends Jn{constructor(){super(...arguments),this._beginCamera=new $e,this._elapsedTimeSec=0,this.constraintOptions=new Vt(Pe.ALL,he.PAN,0,this._beginCamera)}initialize(){this.constraintOptions.interactionType=this.interactionType,this.viewAnimation=new Gs}get steppingFinished(){return this.momentum.isFinished(this._elapsedTimeSec)}onControllerStart(t){this._beginCamera.copyFrom(t),super.onControllerStart(t)}stepController(t,e){e.copyViewFrom(this._beginCamera),this._elapsedTimeSec+=t,this.momentumStep(this._elapsedTimeSec,e),Ze(this.view,e,this.constraintOptions)}};vs=c([S("esri.views.3d.state.controllers.momentum.MomentumController")],vs);var tl=class extends vs{constructor(t){super(t),this.interactionType=he.PAN,this._tmpPan=_()}momentumStep(t,e){let i=this.momentum.value(t);k(this._tmpPan,this.momentum.direction,i),e.eye=ae(oS,e.eye,this._tmpPan),e.center=ae(oS,e.center,this._tmpPan),this.constraintOptions.interactionDirection=this._tmpPan}};c([p({constructOnly:!0})],tl.prototype,"momentum",void 0),tl=c([S("esri.views.3d.state.controllers.momentum.PanPlanarMomentumController")],tl);var oS=_();var xA=_(),Au=_(),td=class extends vs{constructor(t){super(t),this.interactionType=he.PAN}momentumStep(t,e){let i=this.momentum.value1(t),r=this.momentum.value2(t);q(Au,e.eye),z(Au,Au),Qe(this.momentum.axis2,Au,this.momentum.axis1),wy(e,xA,this.momentum.axis1,i,this.momentum.axis2,r)}};c([p({constructOnly:!0})],td.prototype,"momentum",void 0),td=c([S("esri.views.3d.state.controllers.momentum.PanSphericalMomentumController")],td);var nn=class extends vs{set center(t){this._set("center",Or(t))}set axis(t){this._set("axis",Or(t))}constructor(t){super(t),this.interactionType=he.TUMBLE}momentumStep(t,e){let i=this.momentum.value(t);Yr(e,this.center,tn(this.axis,i))}};c([p({constructOnly:!0})],nn.prototype,"momentum",void 0),c([p({constructOnly:!0})],nn.prototype,"center",null),c([p({constructOnly:!0})],nn.prototype,"axis",null),nn=c([S("esri.views.3d.state.controllers.momentum.RotationMomentumController")],nn);var no=class extends vs{set zoomCenter(t){this._set("zoomCenter",Or(t))}constructor(t){super(t),this.interactionType=he.ZOOM,this.constraintOptions.interactionDirection=_()}momentumStep(t,e){let{interactionDirection:i}=this.constraintOptions;if(!i)return;q(i,e.eye);let r=this.momentum.valueDelta(0,t);bh(e,this.zoomCenter,r,this.view.state.constraints.minimumPoiDistance),Ll(i,e.eye,i)}};c([p({constructOnly:!0})],no.prototype,"momentum",void 0),c([p({constructOnly:!0})],no.prototype,"zoomCenter",null),no=c([S("esri.views.3d.state.controllers.momentum.ZoomPlanarMomentumController")],no);var oo=class extends vs{set screenCenter(t){this._set("screenCenter",mt(t[0],t[1]))}set sceneCenter(t){this._set("sceneCenter",Or(t))}constructor(t){super(t),this.interactionType=he.ZOOM,this.radius=0,this._tmpSceneCenter=_(),this._tmpZoomAxisAngle=Qo(),this._sphere=mi()}initialize(){this._sphere[3]=this.radius}momentumStep(t,e){let i=this.momentum.valueDelta(0,t);ou(this._sphere,e,i),this.constraintOptions.interactionType=he.ZOOM,Ze(this.view,e,this.constraintOptions),io(this._sphere,e,this.screenCenter,this._tmpSceneCenter),_h(this.sceneCenter,this._tmpSceneCenter,this._tmpZoomAxisAngle),Yr(e,this._sphere,this._tmpZoomAxisAngle),this.constraintOptions.interactionType=he.PAN}};c([p({constructOnly:!0})],oo.prototype,"momentum",void 0),c([p({constructOnly:!0})],oo.prototype,"screenCenter",null),c([p({constructOnly:!0})],oo.prototype,"sceneCenter",null),c([p({constructOnly:!0})],oo.prototype,"radius",void 0),oo=c([S("esri.views.3d.state.controllers.momentum.ZoomSphericalMomentumController")],oo);var id=class{constructor(e){this._gain=e}update(e){this.filteredValue!==void 0?this.filteredValue=(1-this._gain)*this.filteredValue+this._gain*e:this.filteredValue=e}reset(){this.filteredValue=void 0}get hasFilteredValue(){return this.filteredValue!==void 0}};var lS=1e-5,Iy=class extends ST{constructor(e,i,r,s,a,n=0,o){super(e,i,r),this._angularVelocity1=s,this.axis1=a,this.angularVelocity2=n,this.axis2=o}value1(e){return super.valueFromInitialVelocity(this._angularVelocity1,e)}value2(e){return super.valueFromInitialVelocity(this.angularVelocity2,e)}},Eu=class{constructor(e=300,i=12,r=.84){this._minimumInitialVelocity=e,this._stopVelocity=i,this._friction=r,this.enabled=!0,this._tmpAxis1=_(),this._tmpAxis2=_(),this._tmpAngles=ji(),this._time=new fm(.3),this._screen=[new fm(.4),new fm(.4)],this._angle1=new id(.6),this._angle2=new id(.6),this._axis1=_(),this._axis2=_(),this._lastScene=_()}addMomentumDirectRotation(e,i,r,s,a,n){if(this.enabled){if(this._time.hasLastValue()){if(this._time.computeDelta(r)<.01)return;let o=yy(this._lastScene,i,this._tmpAxis2,s,a,n);this._angle2.update(0),Mi(this._tmpAxis2)<lS?o=0:z(this._axis1,this._tmpAxis2),this._angle1.update(o),q(this._lastScene,i)}this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._time.update(r)}}addMomentumPreserveHeading(e,i,r,s,a,n,o){if(this.enabled){if(this._time.hasLastValue()){if(this._time.computeDelta(r)<.01)return;vy(this._lastScene,i,this._tmpAxis2,this._tmpAxis1,this._tmpAngles,s,a,n,o,!1),Mi(this._tmpAxis2)<lS?(this._angle1.update(0),this._angle2.update(0)):(this._angle1.update(this._tmpAngles[1]),this._angle2.update(this._tmpAngles[0]),z(this._axis1,this._tmpAxis1),z(this._axis2,this._tmpAxis2)),q(this._lastScene,i)}this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._time.update(r)}}reset(){this._screen[0].reset(),this._screen[1].reset(),this._angle1.reset(),this._angle2.reset(),this._time.reset()}evaluateMomentum(){if(!this.enabled||!this._screen[0].hasFilteredDelta())return null;let e=this._screen[0].filteredDelta,i=this._screen[1].filteredDelta,r=e==null||i==null?null:Math.sqrt(e*e+i*i),s=this._time.filteredDelta,a=r==null||s==null?0:r/s;return Math.abs(a)<this._minimumInitialVelocity?null:this.createMomentum(a,this._stopVelocity,this._friction)}createMomentum(e,i,r){let s=this._time.filteredDelta,a=this._angle1.filteredValue,n=this._angle2.filteredValue,o=s==null||n==null?0:n/s;return new Iy(e,i,r,s==null||a==null?0:a/s,this._axis1,o,this._axis2)}};var Ou=class extends ki{constructor(){super(...arguments),this._smoothRotation=new ao(.05),this._rotationAxis=_(),this._beginAngle=0,this._beginHeading=0,this._panningPlane=Qa(),this._beginRadius=0,this._smoothScaling=new ao(.05),this._zoomCenterScreen=mt(),this._zoomMomentumEstimator=new ym,this._rotationMomentumEstimator=new gm,this._panSphericalMomentumEstimator=new Eu,this._panPlanarMomentumEstimator=new _m,this._adjustedSphere=mi(),this._tmp3d=_(),this._tmpScreenPointArray=mt(),this._beginScreenPoint=mt(),this._beginScenePoint=_(),this._screenPickPoint=mt(),this._scenePickPoint=_(),this._navMode=li.Horizontal,this._sphere=mi(),this._pointerCount=0,this._tmpInteractionDirection=_(),this._beginCamera=new $e,this._constraintOptions=new Vt(Pe.ALL,he.NONE,0,this._beginCamera)}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(t){if(!this.running)return;this._zoomMomentumEstimator.enabled=this._rotationMomentumEstimator.enabled=this._panPlanarMomentumEstimator.enabled=this._panSphericalMomentumEstimator.enabled=this.view.navigation.momentumEnabled,this._beginHeading=-qs.normalize(pt(this.view.camera.heading)),this._beginRadius=t.radius,this._pointerCount=t.pointers.size,this._beginAngle=t.angle,this._smoothRotation.reset(),Is(t.center,this._screenPickPoint),gr(this._beginScreenPoint,this._screenPickPoint);let e=Ue(this.view.spatialReference),i=hu(this._intersectionHelper,this.startCamera,this._screenPickPoint,e,to.Silhouette,this.view.map.ground.opacity===0?Ur:{});i.scenePickPoint!=null&&(this._scenePickPoint=i.scenePickPoint,this._sphere=i.sphere,q(this._beginScenePoint,this._scenePickPoint),this._navMode=wa(this.startCamera,this._screenPickPoint,this.view.renderCoordsHelper,this.view.viewingMode),this._navMode===li.Vertical&&this._preparePlanarPanMode(t,i.hasGeometryIntersection),this._beginCamera.copyFrom(this.startCamera))}update(t){if(!this.running)return;this.currentCamera.copyFrom(this.startCamera);let e=t.pointers.size>1;this._navMode===li.Horizontal?(e&&this._zoomSpherical(t),this._panningSpherical(t),e&&this._rotateSpherical(t)):(e&&this._zoomPlanar(t),this._panningPlanar(t),e&&this._rotatePlanar(t)),this.commitCamera()}end(t){t.pointers.size===this._pointerCount&&this.update(t),this.finishController();let e=this._zoomMomentumEstimator.evaluateMomentum();if(e)return this._navMode===li.Horizontal?new oo({view:this.view,momentum:e,screenCenter:this._zoomCenterScreen,sceneCenter:this._beginScenePoint,radius:this._sphere[3]}):new no({view:this.view,momentum:e,zoomCenter:this._beginScenePoint});let i=this._rotationMomentumEstimator.evaluateMomentum();if(i)return new nn({view:this.view,momentum:i,center:this._sphere,axis:this._rotationAxis});if(this._navMode===li.Horizontal){let r=this._panSphericalMomentumEstimator.evaluateMomentum();if(r)return new td({view:this.view,momentum:r})}else{let r=this._panPlanarMomentumEstimator.evaluateMomentum();if(r)return new tl({view:this.view,momentum:r})}return null}_preparePlanarPanMode(t,e){let i=Gr(this._tmp3d,this.startCamera.viewForward);Up(this._scenePickPoint,i,this._panningPlane);let r=mt(this._screenPickPoint[0],0),s=_(),a=ne(this.startCamera.eye);this._adjustedSphere[3]=a<this._sphere[3]?a-100:this._sphere[3],io(this._adjustedSphere,this.startCamera,r,s);let n=xo();this.startCamera.projectToRenderScreen(s,n);let o=_(),l=_(),h=_();ae(o,this._scenePickPoint,this.currentCamera.eye);let d=ne(o);z(o,o);let m=su*Math.max(Math.abs(this.view.camera.position.z),au),u=this.view._stage.renderView.getMinimalDepthForArea(null,this._screenPickPoint[0],this._screenPickPoint[1],this.view.state.camera,ya),f=u??m;f=e?Math.min(f,d):f,q(h,K(l,this.currentCamera.eye,k(l,o,f))),this._panningPlane[3]=-$(this._panningPlane,h),this.startCamera.center=K(l,this.startCamera.eye,k(l,this.startCamera.viewForward,f));let g=Is(t.center,this._tmpScreenPointArray);Kc(this._panningPlane,this.startCamera,g,this._beginScenePoint)}_zoomSpherical(t){let e=this._beginRadius/t.radius,i=.001875*Math.min(Math.max(t.radius,40),120);this._smoothScaling.gain=i,this._smoothScaling.update(e),ou(this._sphere,this.currentCamera,this._smoothScaling.value),Is(t.center,this._zoomCenterScreen),this._zoomMomentumEstimator.add(this._smoothScaling.value,.001*t.timestamp),this._constraintOptions.interactionType=he.ZOOM,this._constraintOptions.interactionFactor=Yi(t.radius-this._beginRadius),Ze(this.view,this.currentCamera,this._constraintOptions)}_panningSpherical(t){let e=Is(t.center,this._tmpScreenPointArray);io(this._sphere,this.currentCamera,e,this._tmp3d),du(this._beginScenePoint,$(this.currentCamera.up,this._beginScenePoint),this._sphere[3],this._beginHeading,this.view.camera.tilt,this.startCamera.aboveGround)?(Ty(this._sphere,this.currentCamera,this._beginScenePoint,this._tmp3d,this._beginHeading,this.view.camera.tilt,!1),this._panSphericalMomentumEstimator.addMomentumPreserveHeading(e,this._tmp3d,.001*t.timestamp,this.startCamera,this._sphere,this._beginHeading,this.view.camera.tilt)):(by(this._sphere,this.currentCamera,this._beginScenePoint,this._tmp3d,this.view.camera.tilt,!1),this._panSphericalMomentumEstimator.addMomentumDirectRotation(e,this._tmp3d,.001*t.timestamp,this.startCamera,this._sphere[3],this.view.camera.tilt)),this._constraintOptions.interactionType=he.PAN,this._constraintOptions.interactionFactor=Yi(Wa(this._screenPickPoint,e)),Ze(this.view,this.currentCamera,this._constraintOptions)}_rotateSpherical(t){z(this._rotationAxis,this._scenePickPoint),this.currentCamera.aboveGround||Gr(this._rotationAxis,this._rotationAxis);let e=this._smoothRotation.value,i=e+Yc(t.angle-e),r=.00125*Math.min(Math.max(t.radius,40),120);this._smoothRotation.gain=r,this._smoothRotation.update(i);let s=this._smoothRotation.value-this._beginAngle;this._rotationMomentumEstimator.add(s,.001*t.timestamp),Yr(this.currentCamera,this._sphere,tn(this._rotationAxis,s)),this._constraintOptions.interactionType=he.TUMBLE,this._constraintOptions.interactionFactor=Yi(t.radius*i),Ze(this.view,this.currentCamera,this._constraintOptions)}_panningPlanar(t){let e=Is(t.center,this._tmpScreenPointArray);Kc(this._panningPlane,this.currentCamera,e,this._tmp3d)&&(cu(this.currentCamera,this._beginScenePoint,this._tmp3d),this._panPlanarMomentumEstimator.add(e,this._tmp3d,.001*t.timestamp),this._constraintOptions.interactionType=he.PAN,this._constraintOptions.interactionFactor=Yi(Wa(this._beginScreenPoint,e)),this._constraintOptions.interactionDirection=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,this._tmpInteractionDirection),Ze(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null)}_zoomPlanar(t){let e=this._beginRadius/t.radius,i=.001875*Math.min(Math.max(t.radius,40),120);this._smoothScaling.gain=i,this._smoothScaling.update(e),this._zoomMomentumEstimator.add(this._smoothScaling.value,.001*t.timestamp),bh(this.currentCamera,this._beginScenePoint,this._smoothScaling.value,this.view.state.constraints.minimumPoiDistance),this._constraintOptions.interactionType=he.ZOOM,this._constraintOptions.interactionFactor=Yi(t.radius-this._beginRadius),Ze(this.view,this.currentCamera,this._constraintOptions)}_rotatePlanar(t){q(this._rotationAxis,this._beginScenePoint),this.currentCamera.aboveGround||Gr(this._rotationAxis,this._rotationAxis);let e=this._smoothRotation.value,i=t.angle-e;i=Yc(i);let r=e+i,s=.00125*Math.min(Math.max(t.radius,40),120);this._smoothRotation.gain=s,this._smoothRotation.update(r);let a=this._smoothRotation.value-this._beginAngle;this._rotationMomentumEstimator.add(a,.001*t.timestamp),Yr(this.currentCamera,this._sphere,tn(this._rotationAxis,a)),this._constraintOptions.interactionType=he.TUMBLE,this._constraintOptions.interactionFactor=Yi(t.radius*a),Ze(this.view,this.currentCamera,this._constraintOptions)}};Ou=c([S("esri.views.3d.state.controllers.PinchAndPanControllerGlobal")],Ou);var hS=xt(0,0,1),Du=class extends ki{constructor(){super(...arguments),this._rotationValueSmooth=new ao(.05),this._scalingValueSmooth=new ao(.05),this._planeHorizontal=Qa(),this._planeVertical=Qa(),this._rotationMomentumEstimator=new gm,this._panMomentumEstimator=new _m(300,12,.9),this._zoomMomentumEstimator=new ym,this._beginRadius=0,this._beginCenter=_(),this._beginAngle=0,this._tmpPoints=[],this._navMode=li.Horizontal,this._beginCenterScreen=mt(),this._tmpCentroid3d=_(),this._tmpCentroid2d=mt(),this._tmp2d=mt(),this._pointerCount=0,this._beginCamera=new $e,this._constraintOptions=new Vt(Pe.ALL,he.NONE,0,this._beginCamera)}begin(t){if(!this.running)return;let e=this.view.navigation.momentumEnabled;this._zoomMomentumEstimator.enabled=e,this._rotationMomentumEstimator.enabled=e,this._panMomentumEstimator.enabled=e,this._beginRadius=t.radius,this._pointerCount=t.pointers.size,this._beginAngle=t.angle,this._rotationValueSmooth.reset(),this._scalingValueSmooth.reset(),Is(t.center,this._beginCenterScreen),Vp(hS,0,this._planeHorizontal);let i=_(),r=this._intersectionHelper.intersectScreenFreePointFallback(this._beginCenterScreen,i,this.view.map.ground.opacity===0?Ur:{}),s=_();Gr(s,this.startCamera.viewForward);let a=_();q(a,hS);let n=$(s,a);this._navMode=wa(this.startCamera,this._beginCenterScreen,this.view.renderCoordsHelper,this.view.viewingMode);let o=Math.min(su,1/Math.abs($(a,this.startCamera.viewForward)))*Math.max(Math.abs(this.view.camera.position.z),au);_g(this._planeHorizontal,this._planeHorizontal,i),this.startCamera.aboveGround||ow(this._planeHorizontal,this._planeHorizontal);let l=_(),h=_(),d=_();ae(l,i,this.currentCamera.eye);let m=ne(l);if(z(l,l),this._navMode===li.Vertical){k(a,a,n),ae(this._planeVertical,s,a),z(this._planeVertical,this._planeVertical),_g(this._planeVertical,this._planeVertical,i);let u=this.view._stage.renderView.getMinimalDepthForArea(Ja(this.view),this._beginCenterScreen[0],this._beginCenterScreen[1],this.view.state.camera,ya),f=u??o;f=r?Math.min(f,m):f,q(d,K(h,this.currentCamera.eye,k(h,l,f))),this._planeVertical[3]=-$(this._planeVertical,d),this._computePlanePoints(t.pointers,this._planeVertical,this.startCamera,this._tmpPoints),lu(this._tmpPoints,this._beginCenter)}else{let u=r?m:o;q(d,K(h,this.currentCamera.eye,k(h,l,u))),this._planeHorizontal[3]=-$(this._planeHorizontal,d),this._computePlanePoints(t.pointers,this._planeHorizontal,this.startCamera,this._tmpPoints),lu(this._tmpPoints,this._beginCenter)}this._beginCamera.copyFrom(this.startCamera)}update(t){if(!this.running)return;this.currentCamera.copyFrom(this.startCamera);let e=t.pointers.size>1,i=this._navMode===li.Horizontal?this._planeHorizontal:this._planeVertical,r=this._beginCenter;if(e){let s=this._beginRadius/t.radius,a=.001875*Math.min(Math.max(t.radius,40),120);this._scalingValueSmooth.gain=a,this._scalingValueSmooth.update(s),bh(this.currentCamera,r,this._scalingValueSmooth.value,this.view.state.constraints.minimumPoiDistance),this._zoomMomentumEstimator.add(this._scalingValueSmooth.value,.001*t.timestamp),this._constraintOptions.interactionType=he.ZOOM,this._constraintOptions.interactionFactor=Yi(Math.abs(t.radius-this._beginRadius)),Ze(this.view,this.currentCamera,this._constraintOptions)}if(this._computePlanePoints(t.pointers,i,this.currentCamera,this._tmpPoints),lu(this._tmpPoints,this._tmpCentroid3d),Is(t.center,this._tmpCentroid2d),cu(this.currentCamera,r,this._tmpCentroid3d),this._panMomentumEstimator.add(this._tmpCentroid2d,this._tmpCentroid3d,.001*t.timestamp),this._constraintOptions.interactionType=he.PAN,this._constraintOptions.interactionFactor=Yi(Wa(this._beginCenterScreen,this._tmpCentroid2d)),Ze(this.view,this.currentCamera,this._constraintOptions),e){let s=r,a=this._rotationValueSmooth.value,n=a+Yc(t.angle-a),o=.00125*Math.min(Math.max(t.radius,40),120);this._rotationValueSmooth.gain=o,this._rotationValueSmooth.update(n);let l=this._rotationValueSmooth.value-this._beginAngle;this._rotationMomentumEstimator.add(l,.001*t.timestamp);let h=this._planeHorizontal;Yr(this.currentCamera,s,tn(h,l)),this._constraintOptions.interactionType=he.TUMBLE,this._constraintOptions.interactionFactor=Yi(Math.abs(t.radius*l)),Ze(this.view,this.currentCamera,this._constraintOptions)}this.commitCamera()}end(t){t.pointers.size===this._pointerCount&&this.update(t),this.finishController();let e=this._zoomMomentumEstimator.evaluateMomentum();if(e)return new no({view:this.view,momentum:e,zoomCenter:this._beginCenter});let i=this._rotationMomentumEstimator.evaluateMomentum();if(i)return new nn({view:this.view,momentum:i,center:this._beginCenter,axis:this._planeHorizontal});let r=this._panMomentumEstimator.evaluateMomentum();return r?new tl({view:this.view,momentum:r}):null}_computePlanePoints(t,e,i,r){r.length=t.size;let s=this._tmp2d,a=0;return t.forEach(n=>{s[0]=n.x,s[1]=n.y,r[a]===void 0&&(r[a]=_()),Kc(e,i,s,r[a]),a+=1}),r}get _intersectionHelper(){return this.view.sceneIntersectionHelper}};Du=c([S("esri.views.3d.state.controllers.PinchAndPanControllerLocal")],Du);var rd=class extends Ti{constructor(e,i,r){super(!0),this._view=e,this.pointerActions=i,this._lastEndTimestamp=0,this._lastTimestamp=0,this.registerIncoming("drag",r,s=>this._handleDrag(s))}_handleDrag(e){if(e.data.pointerType==="mouse"&&!eh(e.data,this.pointerActions))return;let i=e.timestamp-this._lastEndTimestamp,r=40,s=this._momentum&&this._momentum.running&&i<r;switch(e.data.action){case"start":case"update":if(s)break;this._controller&&this._controller.running?e.data.timestamp-this._lastTimestamp>2&&(this._controller.update(e.data),this._lastTimestamp=e.timestamp):this._startController(e);break;case"end":case"removed":this._endController(e,!0);break;case"added":this._endController(e,!1),this._startController(e)}e.stopPropagation()}_endController(e,i){if(this._controller?.running){this._lastEndTimestamp=e.timestamp;let r=this._controller.end(e.data);i&&r&&(this._momentum=r,this._view.state.switchCameraController(this._momentum))}this._controller=null}_startController(e){this._controller=this._createController(),this._view.state.switchCameraController(this._controller),this._controller.begin(e.data),this._lastTimestamp=e.timestamp}_createController(){return this._view.state.isGlobal?new Ou({view:this._view}):new Du({view:this._view})}};var Iu=class extends Ti{constructor(e,i){super(!0),this.view=e,this.registerIncoming("pointer-down",i,()=>this.view.state.stopActiveCameraController())}};var Lu=class extends Ti{constructor(e,i=!1){super(!0),this._view=e,this._invert=i,this.registerIncoming("vertical-two-finger-drag",r=>this._handleTwoFinger(r))}_handleTwoFinger(e){let i=this._invert?-1:1,r=mt(0,e.data.delta*i);switch(e.data.action){case"begin":this._cameraController?.end(),this._cameraController=new Xo({view:this._view,pivot:Ki.CENTER}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(r);break;case"update":this._cameraController?.update(r);break;case"end":this._cameraController?.end(),this._cameraController=null}}};var Nu=class extends Ti{constructor(e=20,i=40){super(!1),this._threshold=e,this._maxDelta=i,this._state="ready",this._emittedArtificalEnd2=!1,this._vertical=this.registerOutgoing("vertical-two-finger-drag"),this._artificalDrag=this.registerOutgoing("drag"),this._dragEventSeparator=new hT({start:(r,s)=>this._observeStart(r,s),update:(r,s,a)=>this._observeUpdate(r,s,a),end:(r,s)=>this._observeEnd(s)}),this.registerIncoming("drag",r=>this._dragEventSeparator.handle(r))}get failed(){return this._state==="failed"}_observeStart(e,i){e===1&&this._emittedArtificalEnd2&&(this._emittedArtificalEnd2=!1,this._artificalDrag.emit({action:"start",button:i.data.button,buttons:i.data.buttons,pointerType:i.data.pointerType,timestamp:i.data.timestamp,pointers:i.data.pointers,pointer:i.data.pointer,angle:i.data.angle,radius:i.data.radius,center:i.data.center}),i.stopPropagation()),this._state=e===2?"ready":"failed"}_observeUpdate(e,i,r){if(this._state!=="failed"&&e===2)return this._state==="active"?(this._vertical.emit({delta:i.data.center.y-this._thresholdReachedCenter.y,action:"update"}),void i.stopPropagation()):void(this._checkMovementWithinLimits(i.data,r.data)?this._checkVerticalThresholdReached(i.data,r.data)&&(this._state="active",this._emittedArtificalEnd2=!0,this._thresholdReachedCenter=i.data.center,this._artificalDrag.emit({action:"end",button:i.data.button,buttons:i.data.buttons,pointerType:i.data.pointerType,timestamp:i.data.timestamp,pointers:i.data.pointers,pointer:i.data.pointer,angle:i.data.angle,radius:i.data.radius,center:i.data.center}),this._vertical.emit({delta:i.data.center.y-this._thresholdReachedCenter.y,action:"begin"}),i.stopPropagation()):this._state="failed")}_observeEnd(e){this._state==="active"&&(this._vertical.emit({delta:e.data.center.y-this._thresholdReachedCenter.y,action:"end"}),this._state="ready",e.stopPropagation())}_checkMovementWithinLimits(e,i){let r=-1/0,s=1/0,a=-1/0,n=1/0;for(let{x:y,y:v}of i.pointers.values())r=Math.max(r,y),s=Math.min(s,y),a=Math.max(a,v),n=Math.min(n,v);let o=-1/0,l=1/0,h=-1/0,d=1/0;for(let{x:y,y:v}of e.pointers.values())o=Math.max(o,y),l=Math.min(l,y),h=Math.max(h,v),d=Math.min(d,v);let m=r-s,u=a-n,f=o-l,g=h-d;return Math.abs(e.center.x-i.center.x)<this._threshold&&Math.abs(f-m)<=this._maxDelta&&Math.abs(g-u)<=this._maxDelta}_checkVerticalThresholdReached(e,i){let r=Math.abs(e.center.y-i.center.y);return e.pointers.forEach((s,a)=>{let n=i.pointers.get(a);r=Math.min(r,Math.abs(s.y-n.y))}),r>=this._threshold}};var Ta=class extends te{constructor(){super(...arguments),this.mode="default",this._updateMode=({mode:t,dragPrimary:e,dragSecondary:i,dragTertiary:r})=>{t==="pro"&&(i="zoom",r=e==="pan"?"rotate":"pan");let s={dragPrimary:e,dragSecondary:i,dragTertiary:r};this._modeDragPan&&(this._modeDragPan.pointerActions=pm("pan",s)),this._modeDragRotate&&(this._modeDragRotate.pointerActions=pm("rotate",s)),this._modeDragZoom&&(this._modeDragZoom.pointerActions=pm("zoom",s))}}destroy(){this.disconnect()}get primaryDragAction(){return this.view.navigation.actionMap.dragPrimary}set primaryDragAction(t){let{actionMap:e}=this.view.navigation;e.dragPrimary=t,e.dragSecondary=t==="pan"?"rotate":"pan"}get updating(){return!!this._inputManager?.updating}get latestPointerType(){return this._inputManager?.latestPointerType}get latestPointerLocation(){return this._inputManager?.latestPointerLocation}get multiTouchActive(){return this._inputManager?.multiTouchActive??!1}disconnect(){this.removeAllHandles(),this.view.viewEvents.disconnect(),this._modeDragPan=null,this._modeDragRotate=null,this._modeDragZoom=null,this._modeKeyboardNavigation=null,this._inputManager=G(this._inputManager),this._source=G(this._source)}connect(){let t=this.view;this._source=new dT(this.view.surface,t.input);let e=[new uT,new fT,new _T,new mT(this.view.navigation),new Nu],i=new $b({eventSource:this._source,recognizers:e});this._inputManager=i,i.installHandlers("prevent-context-menu",[new pT],Lg.INTERNAL);let r={fov:"Shift",pan:{left:"ArrowLeft",right:"ArrowRight",forward:"ArrowUp",backward:"ArrowDown",up:["u","U"],down:["j","J"]},lookAround:{headingLeft:["a","A"],headingRight:["d","D"],tiltUp:["w","W"],tiltDown:["s","S"],modifier:"b"},zoom:{zoomIn:["+","="],zoomOut:["-","_"]},reset:{heading:["n","N"],tilt:["p","P"]}};this._modeDragPan=new rd(t,["primary"]),this._modeDragRotate=new Rh(t,["secondary"],Ki.CENTER),this._modeDragZoom=new Su(t,["tertiary"],r.fov),this._modeKeyboardNavigation=new Pu(t,r),i.installHandlers("navigation",[new Iu(t),new fu(t),new Ru(t),new Mu(t,r.fov),new Rh(t,["primary"],Ki.EYE,[r.lookAround.modifier]),new Rh(t,["secondary"],Ki.CENTER,[r.lookAround.modifier]),new rd(t,["tertiary"],[r.lookAround.modifier]),this._modeDragRotate,this._modeDragZoom,this._modeDragPan,this._modeKeyboardNavigation,new Lu(t)],Lg.INTERNAL),this.view.viewEvents.connect(i),this.addHandles([P(()=>this.view.navigation?.browserTouchPanEnabled,s=>{this._source.browserTouchPanningEnabled=!s},Ie),P(()=>{let{actionMap:s}=this.view.navigation,{dragPrimary:a,dragSecondary:n,dragTertiary:o}=s;return{mode:this.mode,dragPrimary:a,dragSecondary:n,dragTertiary:o}},this._updateMode,ye)])}isModifierKeyDown(t){return this._inputManager?.isModifierKeyDown(t)??!1}get test(){}};c([p()],Ta.prototype,"view",void 0),c([p({type:["default","pro"]})],Ta.prototype,"mode",void 0),c([p({readOnly:!0})],Ta.prototype,"updating",null),c([p()],Ta.prototype,"latestPointerType",null),c([p()],Ta.prototype,"latestPointerLocation",null),c([p()],Ta.prototype,"multiTouchActive",null),c([p()],Ta.prototype,"_inputManager",void 0),Ta=c([S("esri.views.3d.input.SceneInputManager")],Ta);var cS=Ta;var Kr,Ph,Ly=!1,Ny=!1,Fy=!1,Vy=!1,sd=null;function dS(t,e){if(!Ny||!Ph)return;mS();let i=Ph,r=0;for(let s=0;s<t.accBinsNumX;s++)for(let a=0;a<t.accBinsNumY;a++){let n=t.accBins[s][t.accBinsNumY-1-a];r+=n.length;let o=s*t.accBinsSizeX,l=(s+1)*t.accBinsSizeX,h=a*t.accBinsSizeY,d=(a+1)*t.accBinsSizeY;i.fillText(n.length.toFixed(),o+5,h+15),uS(o,l,h,d,"blue")}i.fillText("total totalShownLabels: "+r,70,40),i.fillText("total visible labels: "+e.size,70,50),i.fillText("total numTests: "+t.accNumTests,70,30)}function pS(t){Fy=ui.DECONFLICTOR_SHOW_VISIBLE,Vy=ui.DECONFLICTOR_SHOW_INVISIBLE,Ly=Fy||Vy,Ny=ui.DECONFLICTOR_SHOW_GRID,sd=null,Ly||Ny?sd=()=>RA(t):Kr&&(Kr.parentElement.removeChild(Kr),Kr=null)}function mS(){sd&&(sd(),sd=null)}function RA(t){Kr==null&&(Kr=document.createElement("canvas"),Kr.setAttribute("id","debugCanvas2d"),t.surface.parentElement.style.position="relative",t.surface.parentElement.appendChild(Kr));let{state:e}=t,{camera:i,pixelRatio:r}=e,{width:s,height:a}=i,n=s*r,o=a*r;Kr.setAttribute("width",`${n}px`),Kr.setAttribute("height",`${o}px`),Kr.setAttribute("style",`position:absolute;left:0px;top:0px;display:block;pointer-events:none;width:${s}px;height:${a}px`),Ph=Kr.getContext("2d"),Ph.clearRect(0,0,s,a),Ph.font="12px Arial"}function uS(t,e,i,r,s){mS();let a=Kr.height,n=Ph;n.beginPath(),n.lineWidth=1,n.strokeStyle=s,n.moveTo(t,a-i),n.lineTo(e,a-i),n.stroke(),n.lineTo(e,a-r),n.stroke(),n.lineTo(e,a-i),n.stroke(),n.lineTo(t,a-i),n.stroke(),n.lineTo(t,a-i),n.stroke(),n.closePath()}function fS(t,e){Ly&&(e&&Fy||!e&&Vy)&&uS(t.aabr[0],t.aabr[2],t.aabr[1],t.aabr[3],e?"green":"red")}var Ca=_(),Fu=_(),Mh=ni(),ad=ni(),Uy=_(),_S=Rt(),PA=mi(),Hy=Wr(),MA=_(),AA=kt(),qy=class{constructor(){this.aabr=kt(),this.distance=0,this.distanceToTerrain=0,this.culled=!1,this.visible=!1}},Vu=class{constructor(e,i){this.graphics3DGraphic=e,this.slicePlaneEnabled=i,this.info={}}},xr;(function(t){t[t.Idle=0]="Idle",t[t.Process=1]="Process",t[t.Sort=2]="Sort",t[t.Deconflict=3]="Deconflict",t[t.NumStates=4]="NumStates"})(xr||(xr={}));var By=class{constructor(){this.camera=new $e,this.slicePlane=Mc(),this.slicePlaneEnabled=!1}copyFrom(e){this.camera.copyFrom(e.camera),Gl(e.slicePlane,this.slicePlane),this.slicePlaneEnabled=e.slicePlaneEnabled}},on=class extends te{get dirty(){return this._dirty}get state(){return this._state}constructor(t){super(t),this._dirty=!1,this._viewState=new By,this._state=xr.Idle,this._active=new Map,this._visible=new Map,this._iterators=new Gy,this._accBinsNumX=15,this._accBinsNumY=20,this._accBinsSizeX=0,this._accBinsSizeY=0,this._accBins=null,this.accNumTests=0,this._updatingHandles=new Op}destroy(){this._updatingHandles.destroy(),this._active.clear(),this._visible.clear(),this._iterators=null}setDirty(){!this._dirty&&this._active.size>0&&(this._dirty=!0,this.notifyChange("updating"))}get updating(){return this._state!==xr.Idle||this._dirty||this._updatingHandles.updating}get updatingProgress(){if(!this.updating)return 1;let t=this._state/xr.NumStates;return this._dirty?.5*t:t}get running(){return this.view.ready&&this.view.state!=null&&this.updating}runTask(t){switch(this._state){case xr.Idle:this._startUpdate(),t.madeProgress();case xr.Process:if(this._state=xr.Process,!this._processActiveGraphics(t))return;case xr.Sort:if(this._state=xr.Sort,!this._sortVisibleGraphics(t))return;case xr.Deconflict:if(this._state=xr.Deconflict,!this._deconflictVisibleGraphics(t))return;default:dS(this,this._visible),this._state=xr.Idle,this.notifyChange("updating")}}modifyGraphics(t,e){e?t.forEach(i=>this.addToActiveGraphics(i)):t.forEach(i=>this.removeFromActiveGraphics(i)),this.setDirty()}layerSupportsDeconfliction(t){if(t==null||t.type!=="object3d")return!1;let e=t.stageObject;return(e?.geometries.length??0)!==1?!1:e?.geometries[0]?.material instanceof Yp}_startUpdate(){pS(this.view),this._dirty=!1,this._viewState.copyFrom(this.viewState);let{fullWidth:t,fullHeight:e}=this._viewState.camera;this._initBins(t,e),this._resetIterators()}addToActiveGraphics(t){t.info[this.visibilityGroup]=new qy,this._active.set(t.graphics3DGraphic.graphic.uid,t),this.setDirty()}removeFromActiveGraphics(t){this._visible.delete(t.graphics3DGraphic.graphic.uid),EA(t,this.visibilityGroup),delete t.info[this.visibilityGroup],this._active.delete(t.graphics3DGraphic.graphic.uid),this.setDirty()}_createTerrainIntersector(){let t=Zi(this.view.state.viewingMode);t.options.store=ps.MIN;let e=this.view.basemapTerrain,i=this.view.state.camera;return p1(_S,this._viewState.camera.viewInverseTransposeMatrix),r=>{At(Fu,r,_S),t.reset(i.eye,Fu,i),e.intersect(t,null,i.eye,Fu);let s=t.results.ground.dist;return s!=null?s*It(Fu,i.eye):0}}_processActiveGraphics(t){let e=this._ensureActiveGraphicsIterator(),i=this._viewState.camera.inverseProjectionMatrix,r=this.view.viewingMode==="global"&&this.view.map.ground.opacity===1&&this._viewState.camera.relativeElevation>0,s=Yt("enable-feature:non-occluded-hud")&&this.view.map.ground.opacity>0?this._createTerrainIntersector():null,a=r?PA:null,n=0;for(a!=null&&(At(a,Ls,this._viewState.camera.viewMatrix),a[3]=Ue(this.view.spatialReference).radius,n=_w(a,Ls));!t.done;){t.madeProgress();let o=e.next();if(o.done===!0)return this._resetActiveGraphicsIterator(),!0;let l=o.value,h=l?.info[this.visibilityGroup];h&&(this._collectGraphics3DGraphics(l,i,a,n,s),h.culled?(this._setGraphicVisibility(l,!1),this._visible.delete(l.graphics3DGraphic.graphic.uid)):this._visible.set(l.graphics3DGraphic.graphic.uid,l))}return!1}_sortVisibleGraphics(t){let e=this._ensureSortGraphicsIterator();for(;!t.done;){let i=e.next();if(t.madeProgress(),i.done===!0)return this._resetSortGraphicsIterator(),!0}return!1}_deconflictVisibleGraphics(t){let e=this._ensureVisibleGraphicsIterator(),i=this.visibilityGroup===pa.LABEL;for(;!t.done;){t.madeProgress();let r=e.next();if(r.done===!0)return this._resetVisibleGraphicsIterator(),!0;let s=r.value,a=s.info[this.visibilityGroup];if(!a||a.culled){this._setGraphicVisibility(s,!1);continue}let n=s.graphics3DGraphic,o=!i||n.isVisible();a.visible=o&&!this._isConflicted(s),a.visible&&this._addToBins(s),this._setGraphicVisibility(s,a.visible),fS(a,a.visible)}return!1}_resetIterators(){this._iterators.active=null,this._iterators.visible=null,this._iterators.sort=null}_ensureActiveGraphicsIterator(){return this._iterators.active||(this._iterators.active=gS(this._active)),this._iterators.active}_resetActiveGraphicsIterator(){this._iterators.active=null}_ensureVisibleGraphicsIterator(){return this._iterators.visible||(this._iterators.visible=gS(this._visible)),this._iterators.visible}_resetVisibleGraphicsIterator(){this._iterators.visible=null}_ensureSortGraphicsIterator(){return this._iterators.sort||(this._iterators.sort=OA(this._visible,this._iterators.sortArray,this.visibilityGroup)),this._iterators.sort}_resetSortGraphicsIterator(){this._iterators.sort=null}_collectGraphics3DGraphics(t,e,i,r,s){let a=t.graphics3DGraphic;if(a.destroyed)return;let n=t.info[this.visibilityGroup];if(!a.isVisible(pa.GRAPHIC,Un.DECONFLICTION))return void(n.culled=!0);let o=this.getGraphicsLayers(a);Os(n.aabr);let l=null;for(let h of o){if(!this.layerSupportsDeconfliction(h))continue;let d=h.stageObject.geometries[0].material;if(l==null){if(l=LA,this._getProjectionInfo(h,e,l),l.isOutsideScreen||this._isCulledBySlice(t,Ca)||i!=null&&IA(l,i,r))return void(n.culled=!0);l.distanceToTerrain=s?.(l.positionView)??0}this._expandBoundingRect(n,h,d,l)}l==null?n.culled=!0:(n.distance=l.distance,n.distanceToTerrain=l.distanceToTerrain,n.culled=!1)}_getProjectionInfo(t,e,i){let r=this._viewState.camera,s=t.stageObject,a=s.geometries[0],n=a.material,o=s.boundingVolumeWorldSpace.bounds;At(Ca,o,r.viewMatrix);let l=a.attributes,h=l.get(Et.NORMAL).data,d=l.get(Et.CENTEROFFSETANDDISTANCE).data;n.applyShaderOffsetsView(Ca,h,s.transformation,d,r,i.scaleInfo,Ca),ls(Mh,Ca[0],Ca[1],Ca[2],1),wc(ad,Mh,r.projectionMatrix),k(i.positionNDC,ad,1/ad[3]),n.applyShaderOffsetsNDC(i.positionNDC,d,r,i.positionNDC,Uy),i.distanceWithoutPolygonOffset=r.depthNDCToWorld(Uy[2]),i.distance=Uy[2]===i.positionNDC[2]?i.distanceWithoutPolygonOffset:r.depthNDCToWorld(i.positionNDC[2]),ls(ad,i.positionNDC[0],i.positionNDC[1],i.positionNDC[2],1),wc(Mh,ad,e),vp(Mh,Mh,1/Mh[3]),xe(i.positionView,Ca[0],Ca[1],Ca[2])}_isCulledBySlice(t,e){return t.slicePlaneEnabled&&this._viewState.slicePlaneEnabled&&Lw(this._viewState.slicePlane,e)}_expandBoundingRect(t,e,i,{positionNDC:r,scaleInfo:s}){let{fullWidth:a,fullHeight:n,pixelRatio:o}=this._viewState.camera,l=e.getScreenSize(DA);Vw(l,s.factor,l),l[0]*=o,l[1]*=o;let h=_p(i.calculateRelativeScreenBounds(l,s.factorAlignment.scale*o,AA),Ae(0,a,.5+.5*r[0]),Ae(0,n,.5+.5*r[1])),d=this.marginFactor;if(d!==0){let m=d*Math.min(ia(h),Co(h));h[0]-=m,h[1]-=m,h[2]+=m,h[3]+=m}ta(t.aabr,h,t.aabr)}_isConflicted(t){let e=t.graphics3DGraphic.graphic.uid,i=t.info[this.visibilityGroup],r=!0;for(let s=Math.floor(i.aabr[0]/this._accBinsSizeX);s<=Math.floor(i.aabr[2]/this._accBinsSizeX);s++)if(!(s<0||s>=this._accBinsNumX))for(let a=Math.floor(i.aabr[1]/this._accBinsSizeY);a<=Math.floor(i.aabr[3]/this._accBinsSizeY);a++){if(a<0||a>=this._accBinsNumY)continue;r=!1;let n=this._accBins[s][a];for(let o=0;o<n.length;o++){let l=n.data[o],h=l.info[this.visibilityGroup];if(h&&h.visible&&l.graphics3DGraphic.graphic.uid!==e&&(this.accNumTests++,ja(h.aabr,i.aabr)))return!0}}return r}_initBins(t,e){if(this._accBins==null){this._accBins=[];for(let i=0;i<this._accBinsNumX;i++){this._accBins.push([]);let r=this._accBins[this._accBins.length-1];for(let s=0;s<this._accBinsNumY;s++)r.push(new Xe)}}else for(let i=0;i<this._accBinsNumX;i++)for(let r=0;r<this._accBinsNumY;r++)this._accBins[i][r].clear();this._accBinsSizeX=t/this._accBinsNumX,this._accBinsSizeY=e/this._accBinsNumY,this.accNumTests=0}_addToBins(t){let e=t.info[this.visibilityGroup],i=Math.floor(e.aabr[0]/this._accBinsSizeX),r=Math.floor(e.aabr[2]/this._accBinsSizeX),s=Math.floor(e.aabr[1]/this._accBinsSizeY),a=Math.floor(e.aabr[3]/this._accBinsSizeY);for(let n=i;n<=r;n++)if(!(n<0||n>=this._accBinsNumX))for(let o=s;o<=a;o++)o<0||o>=this._accBinsNumY||this._accBins[n][o].push(t)}_setGraphicVisibility(t,e){let i=t.graphics3DGraphic;i.destroyed||(i.setVisibilityFlag(this.visibilityGroup,Un.DECONFLICTION,e),this.visibilityGroup===pa.LABEL&&this.view.labeler.setLabelGraphicVisibility(i,e))}};function EA(t,e){let i=t.graphics3DGraphic;i.destroyed||i.setVisibilityFlag(e,Un.DECONFLICTION,!0)}function*gS(t){if(Map.prototype.entries){let e=t.entries();for(let i=e.next();!i.done;i=e.next())yield i.value[1]}else yield*ap(t.values())}function*OA(t,e,i){e.clear(),t.forEach((s,a)=>{let n=e.pushNew();n.id=a,n.visible=s.graphics3DGraphic.getVisibilityFlag(i,Un.DECONFLICTION);let o=s.info?.[i];n.prio=s.graphics3DGraphic.deconflictionPriority,n.distance=o?o.distance:Number.MAX_VALUE,n.behindTerrain=!!o&&o.distanceToTerrain!==0&&o.distance>o.distanceToTerrain}),yield;let r=e.iterableSort((s,a)=>s.behindTerrain!==a.behindTerrain?+s.behindTerrain-+a.behindTerrain:s.prio!==a.prio?a.prio-s.prio:s.distance!==a.distance?s.distance-a.distance:s.visible!==a.visible?+a.visible-+s.visible:s.id-a.id);for(let s=r.next();!s.done;s=r.next())yield;e.forAll(s=>{let a=t.get(s.id);a&&(t.delete(s.id),t.set(s.id,a))}),e.clear()}c([p({constructOnly:!0})],on.prototype,"view",void 0),c([p({type:Boolean,readOnly:!0})],on.prototype,"updating",null),c([p({readOnly:!0})],on.prototype,"_updatingHandles",void 0),on=c([S("esri.views.3d.layers.graphics.Deconflictor")],on);var ky=class{constructor(){this.id=0,this.visible=!1,this.behindTerrain=!1,this.prio=0,this.distance=0}},Gy=class{constructor(e=null,i=null,r=null){this.active=e,this.visible=i,this.sort=r,this.sortArray=new Xe({allocator:s=>s||new ky})}},DA=ji(),zy=class{constructor(){this.positionView=_(),this.positionNDC=_(),this.distance=0,this.distanceToTerrain=0,this.distanceWithoutPolygonOffset=0,this.scaleInfo=new nb}get isOutsideScreen(){let e=this.positionNDC;return e[0]<-1||e[1]<-1||e[2]<-1||e[0]>=1||e[1]>=1||e[2]>=1}};function IA(t,e,i){return q(Hy.direction,t.positionView),xe(Hy.origin,0,0,0),!!Rn(e,Hy,MA)&&t.distanceWithoutPolygonOffset>i}var LA=new zy;var NA=2e3,nd=class extends on{constructor(t){super(t),this.visibilityGroup=pa.LABEL,this.marginFactor=.05,this._lastDeconfliction=0}initialize(){this._updatingHandles.add(()=>(this.view?.map?.ground?.opacity??0)===0,()=>this.setDirty())}get viewState(){return this.parent.viewState}runTask(t){if(this.parent.running)return Xt;let e=performance.now();if(t.state!==Zt.IDLE&&e-this._lastDeconfliction<NA)return Xt;super.runTask(t),this.state===xr.Idle&&(this._lastDeconfliction=e)}enabledChanged(t,e){this.modifyGraphics(e,t.labelsEnabled)}getGraphicsLayers(t){return t.labelLayers}};c([p({constructOnly:!0})],nd.prototype,"parent",void 0),nd=c([S("esri.views.3d.layers.graphics.LabelDeconflictor")],nd);var Uu=class extends on{constructor(){super(...arguments),this._contexts=new Map,this.visibilityGroup=pa.GRAPHIC,this._marginFactor=-.1,this.test={overrideMarginFactor:t=>{this._marginFactor=t,this.setDirty()}}}get labels(){return this._labels}get viewState(){return this._viewState}initialize(){this._updatingHandles.add(()=>this.view?.state?.camera,()=>{this._updateViewState(),this.setDirty()}),this._updatingHandles.add(()=>this.view?.map?.ground?.opacity===1,()=>this.setDirty()),this._updatingHandles.add(()=>this.view?.slicePlane,()=>{this._updateSlicePlane(),this._slicePlaneChanged()},Ie),this._frameTask=this.view.resourceController.scheduler.registerTask(ut.GRAPHICS_DECONFLICTOR,this),this._labels=new nd({view:this.view,parent:this})}destroy(){this._labels=G(this._labels),this._frameTask=Pi(this._frameTask)}get marginFactor(){return this._marginFactor}setDirty(){this._contexts.size>0&&(super.setDirty(),this._labels.setDirty())}runTask(t){super.runTask(t),this.running||this._labels.setDirty()}_updateViewState(){this.view?.state&&(this._viewState.camera.copyFrom(this.view.state.camera),this._updateSlicePlane())}_updateSlicePlane(){let t=this.view?this.view.slicePlane:null;t!=null&&Nw(t,this._viewState.camera.viewMatrix,this._viewState.slicePlane),this._viewState.slicePlaneEnabled=t!=null}_slicePlaneChanged(){for(let t of this._contexts.keys())if(t.symbolCreationContext.slicePlaneEnabled)return void this.setDirty()}addGraphicsOwner(t){let e=this._getGraphicsContext(t);return{addGraphic:i=>this._addGraphic(t,e,i),removeGraphic:i=>this._removeGraphic(e,i),labelingInfoChange:()=>this._labels.enabledChanged(t,e),featureReductionChange:()=>this.enabledChanged(t,e),slicePlaneEnabledChange:()=>this._slicePlaneEnabledChanged(t,e),clear:()=>e.forEach(i=>this._removeGraphic(e,i.graphics3DGraphic)),remove:()=>this._removeGraphicsOwner(t),setDirty:()=>this.setDirty()}}_removeGraphicsOwner(t){let e=this._contexts.get(t);e&&(e.forEach(i=>this._removeGraphic(e,i.graphics3DGraphic)),this._contexts.delete(t),this.setDirty())}_addGraphic(t,e,i){let r=i.graphic.uid,s=new Vu(i,t.symbolCreationContext.slicePlaneEnabled);e.set(r,s),jy(t)&&this.addToActiveGraphics(s),t.labelsEnabled&&this._labels.addToActiveGraphics(s);let a=!this._graphicSupportsDeconfliction(i)||!jy(t);i.setVisibilityFlag(pa.GRAPHIC,Un.DECONFLICTION,a)}_removeGraphic(t,e){let i=e.graphic.uid,r=t.get(i);r&&(this.removeFromActiveGraphics(r),this._labels.removeFromActiveGraphics(r),t.delete(i),this.setDirty())}enabledChanged(t,e){let i=jy(t);i||FA(t),this.modifyGraphics(e,i)}_slicePlaneEnabledChanged(t,e){let i=t.symbolCreationContext.slicePlaneEnabled;e.forEach(r=>r.slicePlaneEnabled=i),this.setDirty()}getGraphicsLayers(t){return t.layers}_graphicSupportsDeconfliction(t){if(t.isDraped)return!1;let e=t.layers;if(!e?.length)return!1;for(let i of e)if(this.layerSupportsDeconfliction(i))return!0;return!1}_getGraphicsContext(t){let e=this._contexts.get(t);if(e)return e;let i=new Map;return this._contexts.set(t,i),this.setDirty(),i}};function jy(t){let e=t.layer;return!(!e?.featureReduction||e.featureReduction.type!=="selection")}function FA(t){let e=t.graphics3DGraphics;e&&e.forEach(i=>i.setVisibilityFlag(pa.GRAPHIC,Un.DECONFLICTION,!0))}Uu=c([S("esri.views.3d.layers.graphics.GraphicsDeconflictor")],Uu);function yS(t,e,i,r,s,a,n=1){let o=bc(e,s);if(o==null)return!1;if(o===R1){if(t===r&&i===a)return!0;let h=i+n;for(let d=i,m=a;d<h;++d,++m)q(r[m],t[d]);return!0}let l=i+n;for(let h=i,d=a;h<l;++h,++d)o(t[h],0,r[d],0);return!0}var ku=class{constructor(e,i){this._renderCoordsHelper=e,this.opaqueGround=i,this._cache=new Map,this._cameraForward=_(),this._cameraEye=_(),this._cameraFovY=55*Math.PI/180,this._frustumBoundingSphereCenter=_(),this._frustumBoundingSphereRadius=0,this._frustum=new im(e),this._renderSR=e.spatialReference;let r=Q1(this._renderSR);this._renderSREllipsoidRadius=Ue(r).radius}setup(e){this._aboveGround=e.aboveGround,this._frustum.update(e),z(this._cameraForward,e.viewForward),q(this._cameraEye,e.eye),this._cameraFovY=e.fovY,this._updateFrustumBoundingSphere()}done(){this._cache.clear()}compute(e){if(this._cache.has(e.id))return this._cache.get(e.id);let i=this._isVisibleInFrustum(e);return this._cache.set(e.id,i),i}_isVisibleInFrustum(e){return this._renderCoordsHelper.viewingMode===me.Local?this._isTileVisibleInFrustumLocal(e):this._isTileVisibleInFrustumGlobal(e)}_updateFrustumBoundingSphere(){let e=this._frustum,i=e.origin,r=zA;z(r,e.direction);let s=e.points,a=jA;bt(a,s[4],i);let n=.5*$(a,a)/$(r,a),o=this._frustumBoundingSphereCenter;Ro(o,i,r,n);let l=1+n;this._frustumBoundingSphereRadius=l}_isTileVisibleInFrustumLocal(e){let i=e.spatialReference,r=e.extent,s=this._renderSR;if(di[0]=r[0],di[1]=r[1],di[2]=0,di[3]=r[2],di[4]=r[3],di[5]=0,!P1(di,i,0,di,s,0))return!1;xe(cr[0],di[0],di[1],0),xe(cr[1],di[3],di[1],0),xe(cr[2],di[3],di[4],0),xe(cr[3],di[0],di[4],0),xe(Hu,.5*(di[0]+di[3]),.5*(di[1]+di[4]),.5*(di[2]+di[5]));let a=xS,n=.5*Ai(cr[0],cr[2]),o=this._frustum,l=this._frustumBoundingSphereRadius,h=this._frustumBoundingSphereCenter,d=QA;bt(d,h,Hu);let m=$(a,d),u=WA;if(Ro(u,Hu,a,m),Ai(u,h)>n+l)return!1;let f=this._cameraForward,g=$(f,xS),y=this._cameraFovY,v=this._cameraEye;if(Math.abs(g)<Math.abs(Math.cos(.5*y))){let T=!0,M=xe(vE,f[0],f[1],0),E=$(v,M);for(let O=0;O<4;++O){let Z=cr[O];if($(Z,M)-E>0){T=!1;break}}if(T)return!1}{let T=cr[0],M=cr[2];if(T[0]<=v[0]&&v[0]<=M[0]&&T[1]<=v[1]&&v[1]<=M[1])return!0}let w=HA,b=this.opaqueGround&&this._aboveGround,R=this.opaqueGround&&!this._aboveGround,C=Math.min(R?qu:1/0,m+l),x=Math.max(b?-430:-1/0,m-l);for(let T=0;T<4;++T)Ro(w[T],cr[T],a,C),Ro(w[T+4],cr[T],a,x);if(wS(o.planes,w,8))return!1;if(Wy(o.planes,w,8))return!0;for(let T=0;T<4;++T){let M=w[T],E=w[T+4];if(Zy(o.planes,M,E))return!0;let O=w[(T+1)%4];if(Zy(o.planes,M,O))return!0;let Z=w[4+(T+1)%4];if(Zy(o.planes,E,Z))return!0}if(xa[0][3]=+cr[0][0],xa[1][3]=-cr[2][0],xa[2][3]=+cr[0][1],xa[3][3]=-cr[2][1],xa[4][3]=+x,xa[5][3]=-C,Wy(xa,o.points)||Wy(xa,o.points))return!0;for(let T=0;T<4;++T){let M=v,E=o.points[T+4];if(SS(xa,M,E))return!0;let O=o.points[4+(T+1)%4];if(SS(xa,E,O))return!0}return!1}_isTileVisibleInFrustumGlobal(e){if(e.level<ld)return!0;let i=e.spatialReference,r=e.extent,s=this.opaqueGround&&this._aboveGround,a=this.opaqueGround&&!this._aboveGround,n=cr,o=.5*(r[0]+r[2]);if(xe(n[0],r[0],r[1],0),xe(n[1],r[2],r[1],0),xe(n[2],r[2],r[3],0),xe(n[3],r[0],r[3],0),xe(n[4],o,r[1],0),xe(n[5],o,r[3],0),!yS(n,i,0,n,this._renderSR,0,6))return!1;let l=n[0][2]>0,h=n[3][2]<0,d=l||h,m=this._renderSREllipsoidRadius;if(d){let Te=qA;lo(Te,Bu,n[0]);let F=BA;if(lo(F,Bu,n[1]),l){let D=bS,L=n[4],Q=TS;lo(Q,L,Bu),lo(D,Q,L);let ce=n[0];Qe(ce,Te,D),od(ce,m);let de=n[1];Qe(de,F,D),od(de,m)}else if(h){let D=bS,L=n[5],Q=TS;lo(Q,L,Bu),lo(D,L,Q);let ce=n[3];Qe(ce,D,Te),od(ce,m);let de=n[2];Qe(de,D,F),od(de,m)}}let u=Hu,f=bt(KA,n[3],n[0]);z(f,f);let g=K(XA,n[0],n[3]);k(g,g,.5);let y=-$(g,f),v=K(JA,n[0],n[1]);k(v,v,.5);let w=K(eE,n[2],n[3]);k(w,w,.5);let b=bt(tE,w,v);z(b,b);let R=-(y+$(f,v))/$(f,b);Ro(u,v,b,R),od(u,m);let C=this._frustumBoundingSphereRadius,x=this._frustumBoundingSphereCenter,T=this._frustum,M=T.planes,E=kA;z(E,u);let O=$(n[0],E)/vi(n[0]),Z=T.origin,H=T.points,B=!1;if(s){{B=!0;let F=z(CS,Z);for(let D=0;D<4;++D){let L=H[4+D],Q=bt(_(),L,Z);z(Q,Q);let ce=Qe(_(),F,Q);z(ce,ce);let de=Qe(_(),Q,ce);if(z(de,de),$(Z,de)>m){B=!1;break}}}if(B&&$(Z,E)<m*O-qu)return!1;let Te=z(CS,T.origin);if($(Te,E)<0)return!1;{let F=z(gE,T.direction);if($(F,E)>yE)return!1}}let X=Math.sqrt(1-O*O);if(X>.9)return!0;let I=!1,A=$(E,x),re=vi(x);if(re<=C&&!M.some(Te=>$a(Te,Qy)>0)){if(!s)return!0;I=!0}let U=A/re;if(!I&&A<=0&&-A>C)return!1;let W=C/re;if(Math.sqrt(1-U*U)*Math.sqrt(1-W*W)-W*U>X)return!1;if(!B&&(n.some(Te=>T.intersectsPoint(Te))||T.intersectsPoint(u)))return!0;let ve=$A;bt(ve,x,Qy);let ue=$(ve,E),Ee=GA;k(Ee,E,ue);let Be=Ai(Ee,x),Ye=i.isWGS84,Oe=e.lij,tt=Ye&&Oe[2]===2**Oe[0]-1,Ht=Ye&&Oe[2]===0,qt=Ht?dE:tt?hE:oE,ke=Ht?pE:tt?cE:lE;if(!I){let Te=n,F=mE,D=iE,L=rE,Q=Qy;for(let ce of qt){let de=Te[ce];if(vS(D,Te[(ce+1)%4],de),vS(L,Q,de),lo(F,L,D),UA(F,H,1))return!1}}let Me=null;if(!s&&ue<1.01*C){let Te=2.5*C;if(Be>O*Te+C)return!1;let F=YA,D=Te/O;for(let L=0;L<4;++L)k(F[L],n[L],D/m);xe(F[4],0,0,0),Me=F}else{let Te=(a?m+qu:ue+C)/O,F=s?m-qu:(ue-C)/O,D=ZA;for(let L=0;L<4;++L){let Q=n[L];k(D[L],Q,F/m),k(D[L+4],Q,Te/m)}Me=D}if(wS(M,Me,Me.length))return!1;let ct=T.lines,De=sE,ze=aE;for(let Te of ct){z(ze,Te.direction);for(let F of ke){let D=Me[F];if(z(De,D),$y(ze,De,Me,H))return!1;let L=(F+1)%4;if(s){let Q=Me[L];if(bt(De,Q,D),z(De,De),$y(ze,De,Me,H))return!1}if(a){let Q=Me[4+F],ce=Me[4+L];if(bt(De,ce,Q),z(De,De),$y(ze,De,Me,H))return!1}}}return!0}};function lo(t,e,i){return Qe(t,e,i),z(t,t),t}function vS(t,e,i){return bt(t,e,i),z(t,t),t}function od(t,e){return k(t,t,e/vi(t)),t}var RS=[Mn.LEFT,Mn.RIGHT,Mn.BOTTOM,Mn.TOP,Mn.FAR];function VA(t,e,i){for(let r=0;r<i;++r)if($a(t,e[r])<=0)return!1;return!0}function wS(t,e,i){for(let r of RS)if(VA(t[r],e,i))return!0;return!1}function Wy(t,e,i=e.length){for(let r=0;r<i;++r){let s=e[r],a=!0;for(let n of t)if($a(n,s)>0){a=!1;break}if(a)return!0}return!1}var ld=2,PS=4;function UA(t,e,i){for(let r of e)if($(r,t)<i)return!1;return!0}var HA=[_(),_(),_(),_(),_(),_(),_(),_()],di=[0,0,0,0,0,0],cr=[_(),_(),_(),_(),_(),_()],Hu=_(),bS=_(),qA=_(),BA=_(),TS=_(),kA=_(),GA=_(),zA=_(),jA=_(),WA=_(),QA=_(),Qy=yc(0,0,0),$A=_(),ZA=[_(),_(),_(),_(),_(),_(),_(),_()],YA=[_(),_(),_(),_(),_()],KA=_(),XA=_(),JA=_(),eE=_(),tE=_(),iE=_(),rE=_(),sE=_(),aE=_(),nE=_(),oE=[0,1,2,3],lE=[0,1,2,3],hE=[0,1,3],cE=[0,1,3],dE=[1,2,3],pE=[1,2,3],mE=_();function uE(t,e,i){let r=1/0,s=-1/0;for(let a of i){let n=$(e,a);r=Math.min(r,n),s=Math.max(s,n)}t[0]=r,t[1]=s}function fE(t,e,i,r){let s=1/0,a=-1/0;for(let n of r){let o=$(i,n);if(s=Math.min(s,o),a=Math.max(a,o),s<=e&&a>=t)return!1}return!0}var _E=[0,0];function $y(t,e,i,r){if(i.length===0||r.length===0)return!0;let s=nE;lo(s,t,e);let a=r[0]<i[0],n=a?i:r,o=_E;return uE(o,s,a?r:i),fE(o[0],o[1],s,n)}var qu=430,CS=_(),gE=_(),yE=Math.cos(.25*Math.PI),xS=xt(0,0,1),vE=_();function Zy(t,e,i){let r={t0:0,t1:1};for(let s of RS)if(!MS(t[s],e,i,r))return!1;return r.t0<r.t1}function SS(t,e,i){let r={t0:0,t1:1};for(let s of t)if(!MS(s,e,i,r))return!1;return r.t0<r.t1}function MS(t,e,i,r){let{t0:s,t1:a}=r,n=$a(t,e),o=$a(t,i);if(n>=0&&o>=0)return!1;if(n<0&&o>=0){let l=-n/(o-n);if(l<s)return!1;l<a&&(a=l)}else if(n>=0&&o<0){let l=n/(n-o);if(l>a)return!1;l>s&&(s=l)}return r.t0=s,r.t1=a,!0}var xa=[Eo(-1,0,0,1),Eo(1,0,0,-1),Eo(0,-1,0,1),Eo(0,1,0,-1),Eo(0,0,-1,1),Eo(0,0,1,-1)],Bu=yc(0,0,1);var hd=class{constructor(e,i,r){this._renderCoordsHelper=e,this._tilingScheme=i,this._camera=new $e,this._surfaceElevation=0,this._focusOnMap=[0,0],this._visibility=new ku(e,r)}set opaqueGround(e){this._visibility.opaqueGround=e}setup(e,i,r){this._camera.copyFrom(e),this._surfaceElevation=r,this._focusOnMap[0]=i.x,this._focusOnMap[1]=i.y,this._visibility.setup(this._camera)}done(){this._visibility.done()}update(e){let{measures:i,extent:r,level:s}=e;i.visible=this._visibility.compute(e),i.distance=r1(r,this._focusOnMap),i.mergeable=!0,i.lodLevel=ld,i.splitPriority=Math.max(0,ld-s),i.visible&&(this._isGlobal?this._updateSplitAndLodGlobal(e):this._updateSplitAndLodLocal(e))}_updateSplitAndLodGlobal(e){let i=e.level,r=this._renderCoordsHelper,{eye:s,fov:a}=this._camera,n=r.referenceEllipsoid.radius,o=vi(s)-n;if(2*Math.atan(n/o)<a&&o>0)return void(e.measures.lodLevel=Math.max(i,ld));let l=AS,{extent:h}=e,{_surfaceElevation:d}=this;xe(l[0],h[0],h[1],d),xe(l[1],h[2],h[1],d),xe(l[2],h[2],h[3],d),xe(l[3],h[0],h[3],d);let m=xe(ES,.5*(h[0]+h[2]),.5*(h[1]+h[3]),d),u=this._tilingScheme.spatialReference;for(let v=0;v<4;++v)r.toRenderCoords(l[v],u,l[v]);r.toRenderCoords(m,u,m);let f=z(Yy.direction,m),g=$(s,f),y=k(OS,f,g);this._updateSplitAndLod(e,l,m,y)}_updateSplitAndLodLocal(e){let i=AS,{extent:r}=e,{_surfaceElevation:s}=this;xe(i[0],r[0],r[1],s),xe(i[1],r[2],r[1],s),xe(i[2],r[2],r[3],s),xe(i[3],r[0],r[3],s);let a=this._tilingScheme.spatialReference;for(let m=0;m<4;++m)this._renderCoordsHelper.toRenderCoords(i[m],a,i[m]);let n=xe(ES,.5*(i[0][0]+i[2][0]),.5*(i[0][1]+i[2][1]),.25*(i[0][2]+i[1][2]+i[2][2]+i[3][2])),o=xe(wE,n[0],n[1],0),{eye:l,far:h}=this._camera,d=xe(OS,o[0],o[1],l[2]);xe(Yy.origin,o[0],o[1],l[2]-2*h),q(Yy.direction,IS),this._updateSplitAndLod(e,i,n,d)}_updateSplitAndLod(e,i,r,s){let a=Math.max(Ai(i[0],i[2]),Ai(i[1],i[3]),Ai(i[0],r)+Ai(r,i[2]),Ai(i[1],r)+Ai(r,i[3])),{eye:n,near:o,fov:l,viewForward:h,width:d,height:m,pixelRatio:u,frustum:f}=this._camera,g=$(n,h),y=$(r,h)-g,v=Ai(r,n),w=y,b=y,R=v,C=v,x=(U,W)=>W<o?1:Math.sqrt(U*U-W*W)/W,T=x(v,y);for(let U of i){let W=$(U,h)-g;w=Math.min(w,W),b=Math.max(b,W);let ve=Ai(U,n);C=Math.max(C,ve),R=Math.min(R,ve);let ue=x(ve,W);T=Math.min(T,ue)}if(b<o)return void(e.measures.lodLevel=0);let M=Math.cos(.5*l),E=Ai(n,s);T>M&&E>TE*a&&(b=DS*C,w=DS*R);let O=.5*Math.sqrt(d*d+m*m)/u,Z=2*Math.tan(.5*l),H=U=>Math.max(o,U)*bE/O*Z,B=e.level,X=a*2**B*Math.max(1,Z),I=H(w),A=Math.ceil(Math.log2(Math.max(1,X/I)));if(e.measures.lodLevel=Math.max(A,e.measures.lodLevel),e.measures.splitPriority+=e.measures.lodLevel-B,B<A){let U=+Pc(f,i[0])+ +Pc(f,i[1])+ +Pc(f,i[2])+ +Pc(f,i[3]);e.measures.splitPriority+=U}let re=H(b)/I;re>2.5&&(e.measures.splitPriority+=re)}get _isGlobal(){return this._renderCoordsHelper.viewingMode===me.Global}},AS=[_(),_(),_(),_()],ES=_(),wE=_(),OS=_(),IS=yc(0,0,1),Yy=pw(Ls,IS),bE=312,TE=.5,DS=2;var CE=60,xi=class extends te{constructor(t){super(t),this.tiles=new Ba,this.tileSize=512,this._idToTile=new Map,this._clients=new Set,this._dirty=fr(!1),this._pendingTiles=fr(null),this._newTiles=new Xe,this._tests=!1,this._measurements=new hd(t.renderCoordsHelper,t.tilingSchemeOwner.tilingScheme,this._opaqueGround)}initialize(){let t=()=>this._setDirty(),e=()=>this._reset();this.addHandles([P(()=>this.tileSize,e,ye),P(()=>this.cameraOnSurface?.location,t,ye),P(()=>this.viewState?.contentCamera,t,ye),P(()=>this.focus?.location,t,ye),P(()=>this.terrain?.baseOpacity??1,t),P(()=>this.tilingScheme,i=>{this._reset(),this._measurements=new hd(this.renderCoordsHelper,i,this._opaqueGround)},we),P(()=>this._opaqueGround,i=>this._measurements.opaqueGround=i,we)]),this._frameWorker=this.scheduler?.registerTask(ut.FEATURE_TILE_TREE,this)}destroy(){this._frameWorker=Pi(this._frameWorker)}get tilingScheme(){let t=this.tilingSchemeOwner.tilingScheme;return t?t.clone():null}set filterExtent(t){if(t!=null&&!t.spatialReference.equals(this.viewState.spatialReference))return void pe.getLogger(this).error("#extent","extent spatial reference needs to be in the same spatial reference as the view");let e=this._get("filterExtent");if(e===t||e!=null&&t&&e.equals(t))return;let i=t!=null?t.clone():null;this._set("filterExtent",i),this._setDirty()}get _filterExtentRect(){if(this.filterExtent==null)return null;let t=kt();return vm(this.filterExtent,t,this.tilingScheme.spatialReference),t}get _rootTileIds(){let{tilingScheme:t}=this;return this._filterExtentRect&&t?t.rootTilesInExtent(this._filterExtentRect):[[0,0,0]]}set suspended(t){t!==this._get("suspended")&&(this._set("suspended",t),this._setDirty())}get updating(){return this._dirty.value||!!this._pendingTiles.value}addClient(){let t=Hv();return this._clients.add(t),this._clients.size===1&&this._setDirty(),is(()=>this._removeClient(t))}_removeClient(t){this._clients.delete(t),this._hasClients||this._clear()}get _hasClients(){return this._clients.size>0}get _opaqueGround(){return(this.terrain?.baseOpacity??1)===1}_setDirty(){this._hasClients&&!this.suspended&&(this._frameWorker?this._dirty.value=!0:this.runTask(Dr))}_clear(){this.tiles.removeAll(),this._idToTile.clear(),this._reset(),this._dirty.value=!1}get running(){return this.updating}_reset(){this._newTiles.clear(),this._pendingTiles.value=null,this._setDirty()}_getRootTiles(){let t=this.tilingScheme;return this._rootTileIds.map(e=>new Zg(e[0],e[1],e[2],t))}runTask(t){t=this._tests?Dr:t,this._dirty.value=!1,this._pendingTiles.value||(this._startUpdate(t),this._frameWorker!=null&&(this._frameWorker.priority=ut.FEATURE_TILE_TREE_ACTIVE)),this._splitPendingTiles(t),this._pendingTiles.value||this._frameWorker==null||(this._frameWorker.priority=ut.FEATURE_TILE_TREE)}_startUpdate(t){if(this.suspended)return;if(!this.tilingScheme)return void this._clear();let{_measurements:e,_filterExtentRect:i,_newTiles:r}=this;e.setup(this.viewState.contentCamera,this.focus.location,this.cameraOnSurface.location.z??0),this._pendingTiles.value=this._getRootTiles().filter(s=>{if(e.update(s),s.measures.visible&&(!i||ja(s.extent,i))){if(s.measures.splitPriority>0)return!0;r.push(s)}return!1}).sort(LS),this._newTiles.clear(),t.madeProgress()}_splitPendingTiles(t){let e=this._pendingTiles.value;if(!e)return;let{tilingScheme:i,_filterExtentRect:r,_newTiles:s,_measurements:a}=this;for(;e.length>0&&this._tileBudgetExceeded<1;){let n=e.pop();if(t.madeProgress(),n.measures.splitPriority>0){i.ensureMaxLod(n.level+1);let o=n.createChildren();for(let l of o)a.update(l),!l.measures.visible||r&&!ja(l.extent,r)||(l.measures.splitPriority>0?e.push(l):s.push(l));e.sort(LS),this._tileBudgetExceeded>=1&&(this._mergeNewTiles(),this._tileBudgetExceeded>=1&&this._mergeNewTiles(!0))}else s.push(n);if(t.done)return}s.pushArray(e),this._pendingTiles.value=null,this._updateTiles(),s.clear(),a.done()}get _tileBudgetExceeded(){return Math.max(0,(this._newTiles.length+(this._pendingTiles.value?.length??0))/CE-1)}_mergeNewTiles(t=!1){let{_newTiles:e,_measurements:i}=this,r=new Map(e.map(a=>[a.id,a])),s=!1;return r.forEach(a=>{let{lij:n,measures:o}=a;if(!o.mergeable||n[1]%2!=0||n[2]%2!=0||n[0]<=1||a.lodLevelDelta>=PS)return;let l=o.lodLevel,h=l,d=!0,m=r.get(Tm(n[0],n[1]+1,n[2])),u=Math.abs((m?.measures.lodLevel??0)-l),f=u===0||t&&m?.measures.mergeable&&u<=1;if(!m||!f)return;h+=m.measures.lodLevel,d&&=u===0;let g=r.get(Tm(n[0],n[1],n[2]+1));if(u=Math.abs((g?.measures.lodLevel??0)-l),f=u===0||t&&g?.measures.mergeable&&u<=1,!g||!f)return;h+=g.measures.lodLevel,d&&=u===0;let y=r.get(Tm(n[0],n[1]+1,n[2]+1));if(u=Math.abs((y?.measures.lodLevel??0)-l),f=u===0||t&&y?.measures.mergeable&&u<=1,!y||!f)return;h+=y.measures.lodLevel,d&&=u===0,e.removeUnordered(a),e.removeUnordered(m),e.removeUnordered(g),e.removeUnordered(y);let v=new Zg(n[0]-1,n[1]/2,n[2]/2,this.tilingScheme);i.update(v),v.measures.visible=!0,v.measures.lodLevel=h/4,v.measures.mergeable=d,e.push(v),s=!0}),s}_updateTiles(){for(;this._mergeNewTiles(););for(;this._tileBudgetExceeded&&this._mergeNewTiles(!0););for(let r of this.tiles.items)r.used=!1;let t=!1,e=this._newTiles.filter(r=>{let s=this._idToTile.get(r.id);return s?(t||=s.measures.lodLevel!==r.measures.lodLevel,s.measures=lt({},r.measures),s.used=!0):this._idToTile.set(r.id,r),!s}),i=this.tiles.items.filter(r=>!r.used&&(this._idToTile.delete(r.id),!0));this.tiles.removeMany(i),this.tiles.addMany(e),this._sortTiles(),!t||i.length||e.length||this.tiles.emit("change")}_sortTiles(){this.viewState.fixedContentCamera||this.tiles.sort((t,e)=>t.measures.distance-e.measures.distance),this.tiles.forEach((t,e)=>t.loadPriority=e)}};function LS(t,e){return t.lodLevelDelta-e.lodLevelDelta||t.measures.splitPriority-e.measures.splitPriority||e.measures.distance-t.measures.distance}c([p({constructOnly:!0})],xi.prototype,"scheduler",void 0),c([p({constructOnly:!0})],xi.prototype,"renderCoordsHelper",void 0),c([p({constructOnly:!0})],xi.prototype,"tilingSchemeOwner",void 0),c([p({constructOnly:!0})],xi.prototype,"cameraOnSurface",void 0),c([p({constructOnly:!0})],xi.prototype,"focus",void 0),c([p({constructOnly:!0})],xi.prototype,"viewState",void 0),c([p({constructOnly:!0})],xi.prototype,"terrain",void 0),c([p()],xi.prototype,"tiles",void 0),c([p()],xi.prototype,"tileSize",void 0),c([p({readOnly:!0})],xi.prototype,"tilingScheme",null),c([p()],xi.prototype,"filterExtent",null),c([p({readOnly:!0})],xi.prototype,"_filterExtentRect",null),c([p({readOnly:!0})],xi.prototype,"_rootTileIds",null),c([p({value:!1})],xi.prototype,"suspended",null),c([p({readOnly:!0})],xi.prototype,"updating",null),xi=c([S("esri.views.3d.layers.support.FeatureTileTree3D")],xi);var Ut=class extends te{constructor(t){super(t),this._propertiesPool=new wr({camera:$e},this),this._lastSeenCameraProjectionValues=new $e,this.mode=Zt.ANIMATING,this._cssCamera=new $e,this._camera=new $e,this.rasterPixelRatio=1,this.contentPixelRatio=1,this.constraints=new ua({state:this}),this.events=new tr,this._cameraChanged=!1,this._updateQueue=new Array,this._processingUpdates=!1}reset(){this.cameraController=null,this._propertiesPool.destroy(),this._propertiesPool=new wr({camera:$e},this)}destroy(){this.cameraController=null,this._propertiesPool?.destroy(),this._propertiesPool=null}createInitialCamera(){if(this.viewingMode===me.Global){let t=Ue(this.spatialReference).radius;this.camera=new $e({eye:xt(4*t,0,0),center:xt(t,0,0),up:xt(0,0,1)})}else this.camera=new $e({eye:xt(0,0,100),center:xt(0,0,0),up:xt(0,1,0)})}get animation(){return this.cameraController instanceof Jn&&this.cameraController.viewAnimation!=null?this.cameraController.viewAnimation:null}get cssCamera(){let t=this._cssCamera.copyFrom(this.camera),{height:e,width:i,pixelRatio:r}=this.camera;return t.pixelRatio=1,t.height=Math.round(e/r),t.width=Math.round(i/r),t}get camera(){return this._camera}set camera(t){t!==ws&&ws.copyFrom(t),ws.computeUp(this.viewingMode),this.events.emit("before-camera-change",ws);let e=this._camera;if(xE(this._lastSeenCameraProjectionValues,ws)&&(this._lastSeenCameraProjectionValues.copyFrom(ws),this.events.emit("camera-projection-changed",this._lastSeenCameraProjectionValues)),!e.equals(ws)&&(this._camera=this._propertiesPool.get("camera").copyFrom(ws),this._cameraChanged=!e.almostEquals(ws),this._cameraChanged)){let i=qv(()=>{this._cameraChanged=!1,i.remove()})}}get pixelRatio(){return this.camera.pixelRatio}get alignPixelEnabled(){return this.pixelRatio===this.rasterPixelRatio&&this.mode===Zt.IDLE}get updating(){return this.mode!==Zt.IDLE}get contentCamera(){return this._contentCamera??this.camera}set contentCamera(t){this._contentCamera=t!=null?t.clone():null}get fixedContentCamera(){return this._contentCamera!=null}get isGlobal(){return this.viewingMode===me.Global}get isLocal(){return this.viewingMode===me.Local}get viewingMode(){return Sc(this.view.viewingMode)}get spatialReference(){return this.view.spatialReference}get highlights(){let t=this.view.highlights.items.slice(0,Yw);for(let e=0;e<t.length;){let i=t[e],r=t.findIndex(s=>s.name===i.name);r>=0&&e>r?t.splice(e,1):++e}return t}get highlightOrderMap(){let t=new Map;return this.highlights.forEach((e,i)=>t.set(e.name,i)),t}get navigating(){return!!this.cameraController?.isInteractive}get stationary(){return!this._cameraChanged&&!this.navigating}get cameraController(){return this._get("cameraController")}set cameraController(t){this.stopActiveCameraController()?(this.cameraController?.destroy(),t&&(this.removeHandles(NS),this.addHandles(ka(()=>t.state===et.Finished||t.state===et.Stopped,()=>{this._set("cameraController",null),this.updateCamera(e=>t.onControllerEnd(e))},{sync:!0,once:!0}),NS),t.onControllerStart(this.camera)),this._set("cameraController",t)):t&&(t.state=et.Rejected)}switchCameraController(t){this.cameraController=t}stopActiveCameraController(){return!this.cameraController||this.cameraController.stopController()}updateCamera(t){this._updateQueue.push(t),this._processUpdateQueue()}_processUpdateQueue(){if(this._updateQueue.length===0||this._processingUpdates)return;this._processingUpdates=!0;let t=this._updateQueue.shift();ws.copyFrom(this._get("camera")),t(ws),this.camera=ws,this._processingUpdates=!1,this._processUpdateQueue()}};c([p({constructOnly:!0})],Ut.prototype,"view",void 0),c([p()],Ut.prototype,"mode",void 0),c([p({readOnly:!0,type:Gs})],Ut.prototype,"animation",null),c([p({type:$e})],Ut.prototype,"cssCamera",null),c([p()],Ut.prototype,"_cssCamera",void 0),c([p({type:$e})],Ut.prototype,"camera",null),c([p()],Ut.prototype,"_camera",void 0),c([p({readOnly:!0})],Ut.prototype,"pixelRatio",null),c([p()],Ut.prototype,"rasterPixelRatio",void 0),c([p()],Ut.prototype,"contentPixelRatio",void 0),c([p({readOnly:!0})],Ut.prototype,"alignPixelEnabled",null),c([p({readOnly:!0})],Ut.prototype,"updating",null),c([p({})],Ut.prototype,"_contentCamera",void 0),c([p({type:$e})],Ut.prototype,"contentCamera",null),c([p({readOnly:!0})],Ut.prototype,"fixedContentCamera",null),c([p({readOnly:!0})],Ut.prototype,"events",void 0),c([p({readOnly:!0})],Ut.prototype,"isGlobal",null),c([p({readOnly:!0})],Ut.prototype,"isLocal",null),c([p({readOnly:!0})],Ut.prototype,"viewingMode",null),c([p({readOnly:!0})],Ut.prototype,"highlights",null),c([p({readOnly:!0})],Ut.prototype,"highlightOrderMap",null),c([p({readOnly:!0})],Ut.prototype,"navigating",null),c([p({readOnly:!0})],Ut.prototype,"stationary",null),c([p()],Ut.prototype,"_cameraChanged",void 0),c([p()],Ut.prototype,"cameraController",null),Ut=c([S("esri.views.3d.state.ViewState")],Ut);var FS=Ut;function xE(t,e){return t.fov!==e.fov||t.fullViewport[0]!==e.fullViewport[0]||t.fullViewport[1]!==e.fullViewport[1]||t.fullViewport[2]!==e.fullViewport[2]||t.fullViewport[3]!==e.fullViewport[3]||t.padding[$i.TOP]!==e.padding[$i.TOP]||t.padding[$i.RIGHT]!==e.padding[$i.RIGHT]||t.padding[$i.BOTTOM]!==e.padding[$i.BOTTOM]||t.padding[$i.LEFT]!==e.padding[$i.LEFT]}var ws=new $e,NS="ViewStateHandles";var ju=class{constructor(e,i,r){this.viewingMode=e,this._forEachLayer=i,this._view=r,this._externalIntersectionHandlers=new Xe,this._tolerance=$l,this._tmpRay=Wr(),this._tmpRegion=kt(),this._validateHUDIntersector=Zi(this.viewingMode),this._validateHUDIntersector.options.hud=!1}intersectScreen(e,i,r){return this.intersectRay(this._getPickRay(e,this._tmpRay),VS(this.viewingMode),i,r)}intersectScreenFreePointFallback(e,i,r){return this.intersectRayFreePointFallback(this._getPickRay(e,this._tmpRay),i,r)}intersectRayFreePointFallback(e,i,r){return this.intersectRay(e,VS(this.viewingMode),i,r)||this._intersectRayFreePointLocal(e,i)}intersectRay(e,i,r,s){return i.options.selectionMode=!1,i.options.store=ps.MIN,this.computeIntersection(e,i,s),!!i.results.min&&i.results.min.getIntersectionPoint(r)}getCenterRayWithSubpixelOffset(e,i,r=.5,s=.5){return e.getRenderCenter(zu,r,s),zu[0]+=.0466,zu[1]-=.0123,hm(e,zu,i)}intersectIntersectorScreen(e,i,r){this.computeIntersection(this._getPickRay(e,this._tmpRay),i,r)}intersectToolIntersectorScreen(e,i,r){let s=this._getPickRay(e,this._tmpRay);this.intersectToolIntersectorRay(s,i,r)}intersectToolIntersectorRay(e,i,r){i.options.selectionMode=!0,this.computeIntersection(e,i,r);let s=i.results.min;this._view.basemapTerrain&&this._view.basemapTerrain.opaque||Kw(s)&&s.intersector!==Us.TERRAIN||(i.options.selectionMode=!1,this.computeIntersection(e,i,r))}setTolerance(e=$l){this._tolerance=e}addIntersectionHandler(e){this._externalIntersectionHandlers.push(e),this._externalIntersectionHandlers.sort((i,r)=>i.type===Us.TERRAIN?1:r.type===Us.TERRAIN?-1:0)}removeIntersectionHandler(e){this._externalIntersectionHandlers.removeUnordered(e)!=null&&this._externalIntersectionHandlers.sort((i,r)=>i.type===Us.TERRAIN?1:r.type===Us.TERRAIN?-1:0)}_getPickRay(e,i){let r=this._view.state.camera;return lm(r,e,i)}_intersectRayFreePointLocal(e,i){return this.viewingMode!==me.Local||e==null||K(i,e.origin,z(Pt.get(),e.direction)),!1}intersectElevationFromScreen(e,i,r=0,s=null){return this._intersectElevation(this._getPickRay(e,this._tmpRay),i,r,s)}_intersectElevation(e,i,r=0,s=null){if(e==null)return null;let a=this._view,{renderCoordsHelper:n}=a,o=$v(a.spatialReference),l=i!=null?i.mode:"absolute-height",h=mb(i)/o,d=(l!=="on-the-ground"?h+r:0)*o/n.unitInMeters,{camera:m}=a.state;if(l==="absolute-height"){let C=n?.getAltitude(m.eye),x=$(z(cd,e.direction),n.worldUpAtPosition(m.eye,RE));if(C<d&&x<0||C>=d&&x>0)return null;if(n.intersectInfiniteManifold(e,d,cd)){let T=Kg(a,cd);return T.z??=0,T.z-=h,T}return null}let u=Pt.get();m.projectToRenderScreen(e.origin,u);let f=new Wu(null,this._forEachLayer),{slicePlane:g}=a,y=g!=null?Tg(g):null,v=Zi(this.viewingMode);v.options.store=ps.MIN,v.options.verticalOffset=d,v.options.normalRequired=!1;let w=e.origin,b=K(Pt.get(),w,e.direction);v.reset(w,b,m),v.point=u;let R=s?"type"in s&&s.type==="graphics"?C=>C.layerUid!==s.uid:C=>C.graphicUid!==s.uid:null;switch(l){case"relative-to-scene":{let C=x=>(!R||R(x))&&!!x.lastValidElevationBB;v.intersect(f.layers,u,this._tolerance,null,C),this._externalIntersectionHandlers.forAll(x=>{if(x.type===Us.I3S||x.type===Us.TERRAIN||x.type===Us.TILES3D){let T=x.slicePlaneEnabled?y:null;x.intersect(v,T,v.rayBegin,v.rayEnd,u)}});break}case"on-the-ground":case"relative-to-ground":this._externalIntersectionHandlers.forAll(C=>{if(C.isGround){let x=C.slicePlaneEnabled?y:null;C.intersect(v,x,v.rayBegin,v.rayEnd,u)}})}if(v.results.min.getIntersectionPoint(cd)){let C=Kg(a,cd);return C.z=r,C}return null}computeIntersection(e,i,r,s){if(e==null)return;let a=this._view.state.camera,n=Pt.get();a.projectToRenderScreen(e.origin,n);let o=new Wu(r,this._forEachLayer);i.options.selectOpaqueTerrainOnly=!r||!("include"in r||"exclude"in r);let l=e.origin,h=K(Pt.get(),e.origin,e.direction);i.reset(l,h,a),i.intersect(o.layers,n,this._tolerance);let d=this._view.slicePlane,m=d!=null?Tg(d):null;i.intersect(o.sliceableLayers,n,this._tolerance,m);let u=r&&(r.requiresGroundFeedback||r.enableDraped);this._externalIntersectionHandlers.forAll(y=>{let v=y.layerUid,w=Array.isArray(v),b=w?v:[v];w&&(i.options.filteredLayerUids=[]);let R=!1;for(let C of b)o.filterLayerUid(C)?R=!0:w&&i.options.filteredLayerUids.push(C);if(i.options.isFiltered=!R,y.isGround&&u||!i.options.isFiltered){let C=y.slicePlaneEnabled?m:null;y.intersect(i,C,l,h,n,s)}});let f=Pt.get(),g=this._view.basemapTerrain;if(r&&r.enableDraped&&g.spatialReference!=null&&i.results.ground.getIntersectionPoint(f)){let y=g.overlayManager.renderer,v=this._view.renderCoordsHelper.spatialReference,w=Pt.get();this._view.renderCoordsHelper.fromRenderCoords(f,w,g.spatialReference),w[2]=this._view.elevationProvider?.getElevation(f[0],f[1],f[2],v,"ground")??0,y.intersect(i,w,i.results.ground,b=>o.filterRenderGeometry(b))}i.sortResults(),this._processHUDResults(i)}_processHUDResults(e){let i=e.results.hud;_c(this._tmpRegion,s1);let r=this._view.state.camera,s=[],a=this._tmpRegion,n=w=>{let b=new Ky(w),R=b.result.target.object.geometries.every(C=>C.material instanceof Yp&&C.material.parameters.occlusionTest);s.push({item:b,occlusionTest:R}),R&&(r.projectToRenderScreen(w.target.center,b.screenPoint),b.screenPoint[0]=Math.floor(b.screenPoint[0]),b.screenPoint[1]=Math.floor(b.screenPoint[1]),t1(a,b.screenPoint))};e.sortResults(i.all),i.min.dist!=null&&n(i.min);for(let w of i.all)i.min.target.object!==w.target.object&&i.max.target.object!==w.target.object&&n(w);if(i.max.dist!=null&&i.max.target.object!==i.min.target.object&&n(i.max),!s.length)return;a[0]===a[2]&&(a[2]+=1),a[1]===a[3]&&(a[3]+=1);let o=r.fullWidth,l=r.fullHeight,h=Math.max(0,a[0]-dd),d=Math.max(0,a[1]-dd),m=Math.min(ia(a)+2*dd,o-h),u=Math.min(Co(a)+2*dd,l-d),f=m>0&&u>0?new Uint8Array(m*u*4):null;f&&this._view._stage.renderer.readHUDVisibility(h,d,m,u,f);let g=!0,y=e.results.max.dist==null,v=0;for(let{item:w,occlusionTest:b}of s){let R=!b;if(b&&f)for(let C of SE){let x=4*(Math.min(w.screenPoint[0]+C[0],o)-a[0]+(Math.min(w.screenPoint[1]+C[1],l)-a[1])*m);if(x>=0&&x<f.length&&f[x]){R=!0;break}}R&&(g&&(e.results.min.copy(w.result),g=!1),y&&e.results.max.copy(w.result),e.options.store===ps.ALL&&e.results.all.splice(v++,0,w.result))}}},dd=1,SE=(()=>{let t=[],e=dd;for(let i=-1;i<=e;i++)for(let r=-1;r<=e;r++)t.push([r+e,i+e]);return t})(),Ky=class{constructor(e){this.result=e,this.screenPoint=xo()}},Gu;function VS(t){return Gu&&Gu.viewingMode===t||(Gu=Zi(t)),Gu}var Wu=class{constructor(e,i){this.layers=new Array,this.sliceableLayers=new Array,this.include=e?.include,this.exclude=e?.exclude,i(r=>{r.pickable&&this.filterLayerUid(r.apiLayerUid)&&(r.sliceable?this.sliceableLayers:this.layers).push(r)})}filterLayerUid(e){let{include:i,exclude:r}=this;return e==null?i==null&&r==null:(i==null||i.has(e))&&(r==null||!r.has(e))}filterRenderGeometry(e){return this.filterLayerUid(e.layerUid)}};function Xy(t){return typeof t=="object"&&"intersect"in t}var cd=_(),RE=_(),zu=xo();var Ah=class extends tr.EventedMixin(te){get spatialReference(){return this.view?.basemapTerrain?.spatialReference}constructor(t){super(t),this._im=new Array,this._ground=new Array,this._scene=new Array,this.lastElevationQuery=null,this._cacheEnabled=!1}destroy(){this._cachedQuery=G(this._cachedQuery)}enableCache(t){t||(this.lastElevationQuery=null),this._cacheEnabled=t}getElevation(t,e,i,r,s){if(this._cacheEnabled&&this.lastElevationQuery!=null){let n=this.lastElevationQuery;if(t===n.x&&e===n.y&&i===n.z&&Rl(r,n.spatialReference)&&s===n.queryContext)return n.result}let a=null;return a=Qu(a,this._im,t,e,i,r,s),a==null&&(a=Qu(a,this._ground,t,e,i,r,s)),s==="scene"&&(a=Qu(a,this._scene,t,e,i,r,s)),this._cacheEnabled&&(this.lastElevationQuery={x:t,y:e,z:i,spatialReference:r,queryContext:s,result:a}),a}getSphereElevationBounds(t,e,i){let r=new Bl;function s(a){for(let n of a)if(n.getSphereElevationBounds){let o=n.getSphereElevationBounds(t,e,i);o!=null&&r.expandElevationRangeValues(o.elevationRangeMin,o.elevationRangeMax)}}return s(this._ground),s(this._im),i==="scene"&&s(this._scene),r}getRootElevationBounds(){let t=new Bl;for(let e of[this._im,this._ground,this._scene])e.forEach(i=>{if(i.getRootElevationBounds){let r=i.getRootElevationBounds();r!=null&&t.expandElevationRangeValues(r.elevationRangeMin,r.elevationRangeMax)}});return t}queryElevation(t,e,i,r,s,a=null,n=0){return Re(this,null,function*(){let o=this._getElevationQuery(r);try{let l=yield o.queryElevation(t,e,a,n);return s==="scene"?Qu(l,this._scene,t,e,i,r,s):l}catch(l){return Iv(l),this.getElevation(t,e,i,r,s)}})}register(t,e){this.addHandles(e.on("elevation-change",i=>this.emit("elevation-change",i)),e),this._providersFromContext(t).push(e)}unregister(t){this.removeHandles(t);for(let e of[this._im,this._ground,this._scene]){let i=e.indexOf(t);i>-1&&e.splice(i,1)}}_providersFromContext(t){switch(t){case"ground":return this._ground;case"im":return this._im;case"scene":return this._scene}}_getElevationQuery(t=this.view.spatialReference){let e=this._cachedQuery;if(e!=null&&Rl(t,e.spatialReference))return e;e?.destroy({completeTasks:!0});let{wkid:i,wkt:r,wkt2:s,latestWkid:a}=t,n=new MT(this.view.resourceController.scheduler,new Kt({wkid:i,wkt:r,wkt2:s,latestWkid:a}),()=>this.view.map?.ground,{maximumAutoTileRequests:4});return this._cachedQuery=n,n}};function Qu(t,e,i,r,s,a,n){for(let o of e){let l=o.getElevation(i,r,s,a,n);l!=null&&(t=t!=null?Math.max(l,t):l)}return t}c([p({constructOnly:!0})],Ah.prototype,"view",void 0),c([p()],Ah.prototype,"spatialReference",null),Ah=c([S("esri.views.3d.support.CombinedElevationProvider")],Ah);var Eh=(()=>{class t{static isValidProfile(i){return i in t.profiles}static getDefaultProfile(){return Yt("esri-iPhone")?"low":"medium"}static apply(i,r){let s=t.profiles[i];r.graphics3D.maxTotalNumberOfFeatures=s.graphics3D.maxTotalNumberOfFeatures,r.graphics3D.maxNumberOfDrawCalls=s.graphics3D.maxNumberOfDrawCalls,r.graphics3D.maxTotalNumberOfVertices=s.graphics3D.maxTotalNumberOfVertices,r.graphics3D.polygonLodFactor=s.graphics3D.polygonLodFactor,r.graphics3D.polylineLodFactor=s.graphics3D.polylineLodFactor,r.graphics3D.snapshotAvailable=s.graphics3D.snapshotAvailable,r.graphics3D.skipHighSymbolLods=s.graphics3D.skipHighSymbolLods,r.graphics3D.uncompressedTextureDownsamplingEnabled=s.graphics3D.uncompressedTextureDownsamplingEnabled;let a=r.sceneService.object,n=s.sceneService.object;a.lodFactor=n.lodFactor,r.sceneService.point.lodFactor=s.sceneService.point.lodFactor,r.sceneService.integratedMesh.lodFactor=s.sceneService.integratedMesh.lodFactor,r.sceneService.pointCloud.lodFactor=s.sceneService.pointCloud.lodFactor,r.sceneService.uncompressedTextureDownsamplingEnabled=s.sceneService.uncompressedTextureDownsamplingEnabled,r.tiledSurface.lodBias=s.tiledSurface.lodBias,r.tiledSurface.angledSplitBias=s.tiledSurface.angledSplitBias,r.tiledSurface.vtlContentZoom=s.tiledSurface.vtlContentZoom,r.tiledSurface.elevationLevelDelta=s.tiledSurface.elevationLevelDelta,r.tiledSurface.reduceTileLevelDifferences=s.tiledSurface.reduceTileLevelDifferences,r.heatmap.pixelRatio=s.heatmap.pixelRatio,r.heatmap.maxTotalNumberOfFeatures=s.heatmap.maxTotalNumberOfFeatures,r.fadeDuration=s.fadeDuration,r.antialiasingEnabled=s.antialiasingEnabled,r.physicallyBasedRenderingEnabled=s.physicalBasedRenderingEnabled,r.highQualityTransparency=s.highQualityTransparency,r.highResolutionAtmosphere=s.highResolutionAtmosphere,r.reflections=s.reflections,r.ambientOcclusion=s.ambientOcclusion,r.memoryLimit=s.memoryLimit,r.additionalCacheMemory=s.additionalCacheMemory,r.frameRate=s.frameRate,r.maximumPixelRatio=s.maximumPixelRatio}}return t.test={reset(){let e=US();for(let i of Object.keys(e))t.profiles[i]=e[i]}},t})(),pd={IPhone12Pro:120,GalaxyS20:200,FullHD:240,SurfacePro7:300,FullHDRetina:430};function US(){let t=!!Yt("esri-mobile"),e=!!Yt("ios"),i=400;return{low:{graphics3D:{maxTotalNumberOfFeatures:25e3,maxNumberOfDrawCalls:8e3,maxTotalNumberOfVertices:255e4,polygonLodFactor:.5,polylineLodFactor:1,snapshotAvailable:!1,skipHighSymbolLods:!0,uncompressedTextureDownsamplingEnabled:!0},heatmap:{pixelRatio:.125,maxTotalNumberOfFeatures:5e4},sceneService:{object:{lodFactor:.2},point:{lodFactor:1},integratedMesh:{lodFactor:.6},pointCloud:{lodFactor:.5},uncompressedTextureDownsamplingEnabled:!0},tiledSurface:{lodBias:-1,angledSplitBias:.5,vtlContentZoom:.75,elevationLevelDelta:3,reduceTileLevelDifferences:!0},fadeDuration:0,antialiasingEnabled:!1,physicalBasedRenderingEnabled:!1,highQualityTransparency:!1,highResolutionAtmosphere:!1,reflections:!1,ambientOcclusion:!1,memoryLimit:200+pd.IPhone12Pro,additionalCacheMemory:0,frameRate:0,maximumPixelRatio:1},medium:{graphics3D:{maxTotalNumberOfFeatures:1e5,maxNumberOfDrawCalls:17e3,maxTotalNumberOfVertices:625e4,polygonLodFactor:t?.8:1,polylineLodFactor:t?1.2:1.5,snapshotAvailable:!e,skipHighSymbolLods:!1,uncompressedTextureDownsamplingEnabled:t},heatmap:{pixelRatio:.25,maxTotalNumberOfFeatures:13e4},sceneService:{object:{lodFactor:1},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1},uncompressedTextureDownsamplingEnabled:t},tiledSurface:{lodBias:0,angledSplitBias:1,vtlContentZoom:1.5,elevationLevelDelta:3,reduceTileLevelDifferences:!Yt("disable-feature:reduce-map-tile-levels")},fadeDuration:i,antialiasingEnabled:!1,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,highResolutionAtmosphere:!1,reflections:!1,ambientOcclusion:!1,memoryLimit:t?600+pd.GalaxyS20:750+pd.FullHD,additionalCacheMemory:t?-100:150,frameRate:0,maximumPixelRatio:1},high:{graphics3D:{maxTotalNumberOfFeatures:1e5,maxNumberOfDrawCalls:17e3,maxTotalNumberOfVertices:125e5,polygonLodFactor:t?1.2:2,polylineLodFactor:t?1.2:2,snapshotAvailable:!e,skipHighSymbolLods:!1,uncompressedTextureDownsamplingEnabled:!1},heatmap:{pixelRatio:.5,maxTotalNumberOfFeatures:23e4},sceneService:{object:{lodFactor:1},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1},uncompressedTextureDownsamplingEnabled:!1},tiledSurface:{lodBias:0,angledSplitBias:1,vtlContentZoom:1.5,elevationLevelDelta:2,reduceTileLevelDifferences:!Yt("disable-feature:reduce-map-tile-levels")},fadeDuration:i,antialiasingEnabled:!0,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,highResolutionAtmosphere:!0,reflections:!0,ambientOcclusion:!0,memoryLimit:t?900+pd.SurfacePro7:1500+pd.FullHDRetina,additionalCacheMemory:t?-150:0,frameRate:0,maximumPixelRatio:t?1:1/0}}}(function(t){t.profiles=US()})(Eh);var _e;(function(t){t[t.ELEVATION=0]="ELEVATION",t[t.MAP=1]="MAP"})(_e||(_e={}));var ho=[_e.ELEVATION,_e.MAP];function HS(t,e){return Re(this,null,function*(){let{results:i,ground:r}=yield PT(t,e),s=(!r.layer||!fc(r.layer.type))&&r.mapPoint,a=[],n=AE(t),o=s?PE(t,n):ME,l=0,h=0,d=()=>{let u=o.layerViews[h];s&&u&&"fetchPopupFeaturesAtLocation"in u&&a.push({mapPoint:r.mapPoint,layerView:u}),++h},m=null;for(;l<i.length||h<o.layerViews.length;){let u=i[l];if(u&&u.type!=="graphic")++l;else if(u?.layer?.type!=="scene"||u?.layer?.parent!==t?.map?.basemap)if(u){let f=u.layer?.uid,g=o.layerUids.has(f)&&u.distance===r.distance,y=n.get(u.layer?.uid);if(m??=u.mapPoint,h<o.layerViews.length&&(g||(u.distance??0)>r.distance)&&o.layerViews[h]!==y){d();continue}a.push({graphic:u.graphic,layerView:y}),++l}else d();else++l}return m??=r.mapPoint,{hits:a,location:m}})}function PE(t,e){let i=new Set,r=[];for(let a=t.basemapTerrain.numLayers(_e.MAP)-1;a>=0;a--){let n=t.basemapTerrain.layerViewByIndex(a,_e.MAP);i.add(n.layer.uid),r.push(n)}let s=t.basemapTerrain.overlayManager.renderer.layers;for(let{uid:a}of s){let n=e.get(a);n&&(i.add(a),r.push(n))}return r.reverse(),{layerUids:i,layerViews:r}}var ME={layerUids:new Set,layerViews:[]};function AE(t){let e=new Map;for(let i of t.allLayerViews){let r=i.layer.uid;e.set(r,i)}return e}var Xr=class extends te{constructor(){super(...arguments),this.minTotalNumberOfFeatures=2e3,this.maxTotalNumberOfFeatures=5e4,this.maxNumberOfDrawCalls=17e3,this.maxTotalNumberOfVertices=17e5,this.snapshotAvailable=!0,this.polygonLodFactor=1,this.polylineLodFactor=1,this.skipHighSymbolLods=!1,this.uncompressedTextureDownsamplingEnabled=!1}};c([p()],Xr.prototype,"minTotalNumberOfFeatures",void 0),c([p()],Xr.prototype,"maxTotalNumberOfFeatures",void 0),c([p()],Xr.prototype,"maxNumberOfDrawCalls",void 0),c([p()],Xr.prototype,"maxTotalNumberOfVertices",void 0),c([p()],Xr.prototype,"snapshotAvailable",void 0),c([p()],Xr.prototype,"polygonLodFactor",void 0),c([p()],Xr.prototype,"polylineLodFactor",void 0),c([p()],Xr.prototype,"skipHighSymbolLods",void 0),c([p()],Xr.prototype,"uncompressedTextureDownsamplingEnabled",void 0),Xr=c([S("esri.views.3d.support.QualitySettings.Graphics3DSettings")],Xr);var $s=class extends te{constructor(){super(...arguments),this.lodFactor=1}};c([p()],$s.prototype,"lodFactor",void 0),$s=c([S("esri.views.3d.support.QualitySettings.LoDFactorSettings")],$s);var ln=class extends te{constructor(){super(...arguments),this.object=new $s,this.point=new $s,this.integratedMesh=new $s,this.pointCloud=new $s,this.uncompressedTextureDownsamplingEnabled=!1}};c([p({type:$s})],ln.prototype,"object",void 0),c([p({type:$s})],ln.prototype,"point",void 0),c([p({type:$s})],ln.prototype,"integratedMesh",void 0),c([p({type:$s})],ln.prototype,"pointCloud",void 0),c([p()],ln.prototype,"uncompressedTextureDownsamplingEnabled",void 0),ln=c([S("esri.views.3d.support.QualitySettings.SceneServiceSettings")],ln);var hn=class extends te{constructor(){super(...arguments),this.lodBias=0,this.angledSplitBias=1,this.vtlContentZoom=1,this.elevationLevelDelta=3,this.reduceTileLevelDifferences=!0}};c([p()],hn.prototype,"lodBias",void 0),c([p()],hn.prototype,"angledSplitBias",void 0),c([p()],hn.prototype,"vtlContentZoom",void 0),c([p()],hn.prototype,"elevationLevelDelta",void 0),c([p()],hn.prototype,"reduceTileLevelDifferences",void 0),hn=c([S("esri.views.3d.support.QualitySettings.TiledSurfaceSettings")],hn);var Oh=class extends te{constructor(){super(...arguments),this.pixelRatio=1,this.maxTotalNumberOfFeatures=5e4}};c([p()],Oh.prototype,"pixelRatio",void 0),c([p()],Oh.prototype,"maxTotalNumberOfFeatures",void 0),Oh=c([S("esri.views.3d.support.QualitySettings.HeatmapSettings")],Oh);var Gi=class extends te{constructor(){super(...arguments),this.graphics3D=new Xr,this.sceneService=new ln,this.tiledSurface=new hn,this.heatmap=new Oh,this.fadeDuration=400,this.antialiasingEnabled=!0,this.physicallyBasedRenderingEnabled=!1,this.highQualityTransparency=!0,this.highResolutionAtmosphere=!1,this.reflections=!1,this.ambientOcclusion=!1,this.memoryLimit=750,this.additionalCacheMemory=0,this.frameRate=void 0,this.maximumPixelRatio=1/0}};c([p({type:Xr})],Gi.prototype,"graphics3D",void 0),c([p({type:ln})],Gi.prototype,"sceneService",void 0),c([p({type:hn})],Gi.prototype,"tiledSurface",void 0),c([p({type:Oh})],Gi.prototype,"heatmap",void 0),c([p()],Gi.prototype,"fadeDuration",void 0),c([p()],Gi.prototype,"antialiasingEnabled",void 0),c([p()],Gi.prototype,"physicallyBasedRenderingEnabled",void 0),c([p()],Gi.prototype,"highQualityTransparency",void 0),c([p()],Gi.prototype,"highResolutionAtmosphere",void 0),c([p()],Gi.prototype,"reflections",void 0),c([p()],Gi.prototype,"ambientOcclusion",void 0),c([p()],Gi.prototype,"memoryLimit",void 0),c([p()],Gi.prototype,"additionalCacheMemory",void 0),c([p()],Gi.prototype,"frameRate",void 0),c([p()],Gi.prototype,"maximumPixelRatio",void 0),Gi=c([S("esri.views.3d.support.QualitySettings")],Gi);var Jy=Gi;var $u=class{constructor(e){this.client=e,this._cancelled=!1,this.size=0,this.duration=0}},e0=class{constructor(e){this.typeWorkerQuota=e,this.tasks=new Array,this.numWorkers=0,this.statistics=new t0}},t0=class{constructor(){this.requests=0,this.size=0,this.duration=0,this.speed=0}},Zu=class{constructor(e,i,r,s){this._workerFunc=e,this._callbackFunc=i,this._maxTotalNumWorkers=r,this._totalNumWorkers=0,this._clients=s.map(a=>new e0(a))}destroy(){this._clients.length=0}hasQuota(e){let i=this._clients[e];return!!i&&(this._totalNumWorkers<this._maxTotalNumWorkers||i.numWorkers+i.tasks.length<i.typeWorkerQuota)}push(e){let i=this._clients[e.client];i&&(this._totalNumWorkers<this._maxTotalNumWorkers?(i.numWorkers++,this._totalNumWorkers++,this._workerFunc(e,(r,s)=>this._taskCallback(r,s))):i.tasks.push(e))}cancel(e){this._taskFinished(e),e._cancelled=!0}_taskFinished(e){let i=this._clients[e.client];this._totalNumWorkers--,i&&(i.numWorkers--,i.statistics.requests++,i.statistics.size+=e.size||0,i.statistics.duration+=e.duration||0,i.statistics.speed=i.statistics.duration>0?i.statistics.size/i.statistics.duration:0,Wi(i.numWorkers>=0)),this._next()}_next(){for(let e of this._clients)if(e&&e.numWorkers<e.typeWorkerQuota&&this._processQueue(e))return;for(let e of this._clients)if(e&&this._processQueue(e))return}_processQueue(e){for(;e.tasks.length>0;)if(this._workerFunc(e.tasks.shift(),(i,r)=>this._taskCallback(i,r)))return e.numWorkers++,this._totalNumWorkers++,!0;return!1}_taskCallback(e,i){e._cancelled||(this._callbackFunc(e,i),this._taskFinished(e))}getStatsForType(e){let i=this._clients[e];return i?{quota:i.typeWorkerQuota,workers:i.numWorkers,queueSize:i.tasks.length,requestStats:i.statistics}:null}get test(){}};var Yu=class{constructor(e,i){this.element=e,this.type="image+type",this.isOpaque=i==="image/jpeg"}};var md=class extends te{constructor(){super(...arguments),this._tasks=new Map,this._onLoadQueue=new Array,this._doneQueue=new Array,this.updating=!1}setup(t,e,i){this._loadQueue=new Zu((r,s)=>this._startLoading(r,s),(r,s)=>this._doneLoadingCB(r,s),t,e),i&&(this._frameTask=i.registerTask(ut.STREAM_DATA_LOADER,this))}destroy(){this._frameTask=Pi(this._frameTask),this._tasks.forEach(t=>Ar(t.abortController)),this._loadQueue=G(this._loadQueue),this._onLoadQueue=null,this._doneQueue=null,this._tasks=null}hasDownloadSlots(t){return this._loadQueue.hasQuota(t)}request(t,e,i,r={}){let s=xl();s.__signal=r!=null?r.signal:null;let a=this._createOrUpdateTask(t,e,i,r,s);return gn(r,()=>this._cancelRequest(a,s)),s.promise}_createTask(t,e,i,r,s,a){let n=new i0(t,e,i,r,s);return this._updateTask(n,a),this._tasks.set(s,n),this._tasks.size===1&&this._set("updating",!0),this._loadQueue.push(n),n}_cancelRequest(t,e){op(t.resolvers,e),e.reject(er()),t.resolvers.length===0&&(t.status===bs.DOWNLOADING&&(t.status=bs.CANCELLED,this._loadQueue.cancel(t),t.abortController?.abort(),t.request=null,t.abortController=null),t.status=bs.CANCELLED,this._tasks.delete(t.key),this._tasks.size===0&&this._set("updating",!1))}_updateTask(t,e){t.resolvers.push(e)}_createOrUpdateTask(t,e,i,r,s){let a=DE(r?.uid||t,e,i),n=this._tasks.get(a);return n?(this._updateTask(n,s),n):this._createTask(t,r,e,i,a,s)}_doneLoadingCB(t,e){this._loadQueue&&(Wi(t.status===bs.DOWNLOADING),t.status=bs.DOWNLOADED,this._frameTask?this._doneQueue.push({task:t,err:e}):this._doneLoading(t,e))}get running(){return this._doneQueue.length>0||this._onLoadQueue.length>0}runTask(t){for(;!t.done&&this._onLoadQueue.length>0;){let e=this._onLoadQueue.shift();Vi(e.task.abortController),e.task.abortController=null,e.callback(e.task),t.madeProgress()}for(;!t.done&&this._doneQueue.length>0;){let e=this._doneQueue.shift();e.task.status!==bs.DOWNLOADED&&(e.err=e.err||er()),this._doneLoading(e.task,e.err),t.madeProgress()}}_doneLoading(t,e){if(e&&!ss(e)&&t.numRetries>0)return--t.numRetries,void this._loadQueue.push(t);let i=ih(t.result)||t.result instanceof HTMLImageElement?0:t.resolvers.length;for(let r of t.resolvers)if(e)ss(e)?r.reject(e):r.reject(new si("stream-data-loader:request-error",`Failed to request resource at '${t.url}'. ${e}`,{url:t.url,error:e}));else{--i;let s=i>0?cc(t.result):t.result;r.resolve(s)}this._tasks.delete(t.key),this._tasks.size===0&&this._set("updating",!1)}_startLoading(t,e){if(t.status===bs.CANCELLED)return!1;let i,r;switch(t.startTime=performance.now(),t.status=bs.DOWNLOADING,t.docType){case"binary":r="array-buffer",i=0;break;case"image":r="image";break;case"image+type":r="array-buffer";break;default:r="json"}t.abortController=new AbortController;let s=t.abortController.signal;t.request=dp(t.url,Bt(lt({},t.options),{responseType:r,timeout:i,signal:s}));let a=o=>{t.duration=performance.now()-t.startTime,t.size=o instanceof ArrayBuffer?o.byteLength:t.size||0,t.result=o,this._frameTask?this._onLoadQueue.push({callback:e,task:t}):(t.abortController=null,e(t))},n=o=>{t.status===bs.DOWNLOADING&&e(t,o)};return t.docType!=="image+type"?(t.request.then(o=>a(o.data),n),!0):(t.request.then(o=>{let l=o.data,h=OE(l);if(r="image",t.size=l.byteLength,h==="unknown")return t.request=dp(t.url,{responseType:r,timeout:i,signal:s}),void t.request.then(u=>a(u.data),n);let d=new Blob([l],{type:h}),m=window.URL.createObjectURL(d);t.request=dp(m,{responseType:r,timeout:i,signal:s}),t.request.then(u=>a(new Yu(u.data,h)),n).finally(()=>window.URL.revokeObjectURL(m))},n),!0)}get test(){}};c([p({readOnly:!0})],md.prototype,"updating",void 0),md=c([S("esri.views.3d.support.StreamDataLoader")],md);var EE={numRetries:0};function OE(t){if(t.byteLength<2)return"unknown";let e=new Uint8Array(t,0,t.byteLength);return e[0]===137&&e[1]===80?"image/png":e[0]===71&&e[1]===73?"image/gif":e[0]===66&&e[1]===77?"image/bmp":e[0]===255&&e[1]===216?"image/jpeg":"unknown"}var i0=class extends $u{constructor(e,i,r,s,a){super(s),this.url=e,this.options=i,this.docType=r,this.key=a,this.result=null,this.status=bs.QUEUED,this.request=null,this.abortController=null,this.resolvers=new Array,this.startTime=0,this.numRetries=EE.numRetries}};function DE(t,e,i){return`${t}:${e}:${i}`}var bs;(function(t){t[t.QUEUED=1]="QUEUED",t[t.DOWNLOADING=2]="DOWNLOADING",t[t.DOWNLOADED=3]="DOWNLOADED",t[t.CANCELLED=4]="CANCELLED"})(bs||(bs={}));var Ku=class extends te{constructor(){super(...arguments),this.updating=!1}};function qS(t){return new Sa({view:t})}c([p({readOnly:!0})],Ku.prototype,"updating",void 0),Ku=c([S("esri.views.3d.support.ResourceController.ResourceControllerMain")],Ku);var Sa=class extends Ku{constructor(){super(...arguments),this._immediateTask=So,this._normalTask=So,this._updatingObjects=fr([]),this._frameTask=null}get immediate(){return this._immediateTask}get normal(){return this._normalTask}initialize(){this._scheduler=O1(),this._memoryController=sC(this.view),this._streamDataLoader=new md,this._streamDataLoader.setup(rC,iC,this._scheduler),this.addHandles([P(()=>this.view.state?.mode,t=>{t!=null&&(this._scheduler.state=t)},we),P(()=>this.view.stationary,()=>this._stationaryChangedHandler())]),this._frameTask=Sl({update:t=>this._frame(t)}),this._immediateTask=this._scheduler.registerTask(ut.RESOURCE_CONTROLLER_IMMEDIATE),this._normalTask=this._scheduler.registerTask(ut.RESOURCE_CONTROLLER)}destroy(){this._immediateTask.remove(),this._normalTask.remove(),this._frameTask=Pi(this._frameTask),this._streamDataLoader=G(this._streamDataLoader),this._memoryController=G(this._memoryController),this._scheduler=G(this._scheduler),this.view=null}get updating(){return!!(this._memoryController?.updating||this._streamDataLoader?.updating||this._immediateTask?.updating)||this._updatingObjects?.value.some(t=>t.updating)}get scheduler(){return this._scheduler}get memoryController(){return this._memoryController}createStreamDataRequester(t){let e=this._streamDataLoader;return{request:(i,r,s)=>e.request(i,r,t,s),get busy(){return!e.hasDownloadSlots(t)}}}addUpdatingObject(t){let e=this._updatingObjects;return e.value=[...e.value,t],is(()=>{e.value=e.value.filter(i=>i!==t)})}_frame(t){this.view.suspended||this.view.stateManager&&(this.view.stateManager.step(lp(t.deltaTime)),!this._scheduler)||(this._memoryController.update(),this._scheduler.frame(t))}_stationaryChangedHandler(){this.memoryController.resetStableQuality()}get test(){}};c([p()],Sa.prototype,"view",void 0),c([p()],Sa.prototype,"_scheduler",void 0),c([p()],Sa.prototype,"_memoryController",void 0),c([p()],Sa.prototype,"_streamDataLoader",void 0),c([p()],Sa.prototype,"_immediateTask",void 0),c([p()],Sa.prototype,"_normalTask",void 0),c([p({readOnly:!0})],Sa.prototype,"updating",null),Sa=c([S("esri.views.3d.support.ResourceController")],Sa);var Xu=class{constructor(e){this._gltfLoading=new Map,this._wosrLoading=new Map,this._gltfMemCache=e("gltf-resources",()=>{}),this._wosrMemCache=e("wosr-resources",()=>{})}destroy(){this._gltfLoading.forEach(e=>e.abortController.abort()),this._wosrLoading.forEach(e=>e.abortController.abort()),this._gltfMemCache.destroy(),this._wosrMemCache.destroy()}loadGLTF(e,i,r){let s=r?`gltfPBR:${e}`:`gltf:${e}`,a=this._gltfMemCache.get(s);return a!=null?Promise.resolve(a):BS(this._gltfLoading,this._gltfMemCache,s,n=>Re(this,null,function*(){let{loadGLTF:o}=yield import("./chunk-WARLT76F.js");return o(new hw(n.streamDataRequester),e,n,r)}),i)}loadWOSR(e,i){let r=`wosr:${e}:${i.disableTextures}`,s=this._wosrMemCache.get(r);return s!=null?Promise.resolve(s):BS(this._wosrLoading,this._wosrMemCache,r,a=>ub(e,a),i)}};function BS(t,e,i,r,s){return Re(this,null,function*(){Vi(s);let a=gn(s,()=>IE(t,i)),n=t.get(i);if(n)n.refCount++;else{let o=new AbortController;n={refCount:1,abortController:o,promise:r(Bt(lt({},s),{signal:o.signal}))},t.set(i,n)}try{let o=yield n.promise;return e.put(i,o),t.delete(i),Vi(s),o}finally{Pi(a)}})}function IE(t,e){let i=t.get(e);i!=null&&--i.refCount>0||(t.delete(e),i?.abortController.abort())}var co=class extends te{constructor(t,e){super({}),this._stage=t,this._textureRequests=new Map,this._frameTask=e?.registerTask(ut.TEXTURE_UNLOAD)??So}normalizeCtorArgs(){return{}}destroy(){super.destroy(),this._frameTask?.remove(),this._textureRequests?.forEach(t=>this._releaseTextureRequest(t)),this._textureRequests?.clear()}get updating(){return this._frameTask.updating}fromData(t,e){let i=this.makeUid(t),r=this._textureRequests.get(i);if(!r){let s=new fd;s.texture=e(),this._stage&&(s.texture.load(this._stage.renderView.renderingContext),this._stage.add(s.texture)),this._textureRequests.set(i,s),r=s}return r.referenceCount++,new ud(i,r.texture,()=>this._release(i))}_release(t){let e=this._textureRequests.get(t);e?(e.referenceCount<1&&console.warn("TextureCollection: reference count is < 1 for "+t),e.referenceCount--,e.referenceCount<1&&this._frameTask.schedule(()=>this._releaseNow(t))):console.warn(`TextureCollection: texture doesn't exist: '${t}'`)}get test(){}_releaseNow(t){if(!this._textureRequests)return;let e=this._textureRequests.get(t);!e||e.referenceCount>0||(e.texture?.unload(),this._releaseTextureRequest(e),this._textureRequests.delete(t))}_releaseTextureRequest(t){t.texture?this._stage?.remove(t.texture):t.abortController&&(t.abortController.abort(),t.abortController=null)}makeUid(t,e=null){return e!=null?`${t}.${e}px`:t}};c([p()],co.prototype,"_frameTask",void 0),c([p()],co.prototype,"updating",null),co=c([S("esri.views.3d.support.TextureCollection")],co);var ud=class{constructor(e,i,r){this.uid=e,this.texture=i,this.release=r}},fd=class{constructor(){this.referenceCount=0}};var Ju=class extends co{constructor(e,i,r){super(i,r),this._streamDataRequester=e}fromUrl(e,i,r){return Re(this,null,function*(){Vi(r);let s=r?.signal,a=this.makeUid(e,i),n=this._textureRequests.get(a);if(!n){let o=new AbortController,l=this._streamDataRequester.request(e,"image",{uid:a,signal:o.signal});n=new fd,n.abortController=o;let h=n;this._textureRequests.set(a,n),n.textureAsync=l.then(d=>Re(this,null,function*(){let m=this._createTexture(e,d,i);return h.texture=m,h.abortController=null,yield m.load(this._stage.renderView.renderingContext),this._stage.add(m),new ud(a,m,()=>this._release(a))}),d=>{throw h.abortController=null,d})}n.referenceCount++;try{return yield Lv(n.textureAsync,s)}catch(o){throw this._release(a),o}})}_createTexture(e,i,r){let s={width:i.width,height:i.height,wrap:{s:Jt.CLAMP_TO_EDGE,t:Jt.CLAMP_TO_EDGE},preMultiplyAlpha:!0,reloadable:!0};if(cp(e)){if(r||i.width===0&&i.height===0){let a=i.width?i.height/i.width:1;r=r||64,a>1?(i.width=Math.round(r/a),i.height=r):(i.width=r,i.height=Math.round(r*a))}this._stage.renderView?.renderingContext.driverTest.svgPremultipliesAlpha.result&&(s.preMultiplyAlpha=!1)}return new eb(i,s)}};var tf=class{constructor(e){this.streamDataRequester=null,this._graphicsOwners=[],this._screenSizePerspectiveHandles=null,this.cimSymbolRasterizer=null,this._viewState=e.viewState,this._view=e.view,this._pointsOfInterest=e.pointsOfInterest,this.streamDataRequester=e.resourceController.createStreamDataRequester(Vc.SYMBOLOGY),this.objectResourceCache=new Xu((r,s)=>e.resourceController.memoryController.newCache(r,s)),this.textures=new Ju(this.streamDataRequester,e.view._stage,e.resourceController.scheduler);let i=Ue(this._view.spatialReference).radius;this.screenSizePerspectiveSettings=zp(e.viewingMode,i),this.screenSizePerspectiveSettingsLabels=Fw(e.viewingMode,i)}destroy(){this.textures.destroy(),this.streamDataRequester=null}addGraphicsOwner(e){if(!e)return is();this._graphicsOwners.push(e);let i=P(()=>e.layer?.screenSizePerspectiveEnabled,()=>this._updateScreenSizePerspectiveEnabled());return this._updateScreenSizePerspectiveEnabled(),is(()=>{i.remove(),op(this._graphicsOwners,e),this._updateScreenSizePerspectiveEnabled()})}_updateScreenSizePerspectiveEnabled(){let e=this._graphicsOwners.some(i=>i.layer?.screenSizePerspectiveEnabled===!0);if(e&&!this._screenSizePerspectiveHandles){this._screenSizePerspectiveHandles=new Tl;let i=()=>this._updateScreenSizePerspectiveSettings();this._screenSizePerspectiveHandles.add([P(()=>this._pointsOfInterest.centerOnSurfaceInfrequent.distance,i,we),this._viewState.events.on("camera-projection-changed",i)]),this._updateScreenSizePerspectiveSettings()}else e||(this._screenSizePerspectiveHandles=G(this._screenSizePerspectiveHandles))}_updateScreenSizePerspectiveSettings(){let e=this._pointsOfInterest;ef.distance=e.centerOnSurfaceInfrequent.distance,ef.fovY=this._viewState.camera.fovY,this.screenSizePerspectiveSettings.update(ef),this.screenSizePerspectiveSettingsLabels.update(ef),this._view._stage.renderView.requestRender()}get test(){}},ef={distance:0,fovY:0};var r0=class{constructor(e){this.destination=e}hide(){this.graphic!=null&&(this.destination.remove(this.graphic),this.graphic=null)}},Ra=class extends r0{constructor(e,i,r=""){super(e),this._symbol=new J1({symbolLayers:new Ba([new K1({material:{color:i},outline:{color:[255,255,255],size:1},resource:{primitive:"circle"}}),new X1({text:r,halo:{color:"white",size:1/.75},material:{color:i},size:12})])})}show(e,i){if(!i)return;this.hide();let r=new _r({x:e[0],y:e[1],z:e[2],spatialReference:i});this.graphic=new ew({geometry:r,symbol:this._symbol}),this.destination.add(this.graphic)}};var Zs=class extends te{constructor(t){super(t)}};c([p({constructOnly:!0})],Zs.prototype,"renderCoordsHelper",void 0),c([p({constructOnly:!0})],Zs.prototype,"surface",void 0),c([p({constructOnly:!0})],Zs.prototype,"state",void 0),Zs=c([S("esri.views.3d.support.pointsOfInterest.PointOfInterest")],Zs);var LE=Array,Ts=class extends Zs{constructor(t){super(t),this._dirty=!1,this._propertiesPool=new wr({location:_r,renderLocation:LE},this),this._estimatedSurfaceAltitude=0,this._pendingElevationQueryController=null,this.renderLocation=_(),this._tmpPoint=new _r}initialize(){if(this.scheduler&&this.addHandles(this.scheduler.registerTask(this.task,this)),this.runTask(),this.map){let t=()=>this._setDirty();this.addHandles(Er(()=>this.map?.ground?.layers,"change",t,{onListenerAdd:t,onListenerRemove:t}))}this._updateRenderLocation()}destroy(){this._cancelPendingRequest(),this._propertiesPool=G(this._propertiesPool)}get _camera(){return this.state.contentCamera}get location(){let t=this._propertiesPool.get("location");return t.spatialReference=this.state.spatialReference,this.renderCoordsHelper.fromRenderCoords(this.renderLocation,t),t}get scale(){let t=this._camera,e=It(t.eye,this.renderLocation),i={renderCoordsHelper:this.renderCoordsHelper,state:{camera:t}};return Mb(i,e)}get updating(){return this._dirty||this._pendingElevationQueryController!=null}updateRenderLocation(){this._setDirty(),this._updateRenderLocation()}_setDirty(){this._dirty||(this._dirty=!0,this.notifyChange("updating"))}_cancelPendingRequest(){let t=this._pendingElevationQueryController;t&&(this._pendingElevationQueryController=null,t.abort(),this.notifyChange("updating"))}get running(){return!this._pendingElevationQueryController&&this._dirty}runTask(){if(this._cancelPendingRequest(),this._dirty=!1,this.notifyChange("updating"),!this.map?.ground)return this._updateSurfaceAltitude(0),Xt;let t=this.state.spatialReference;this._tmpPoint.spatialReference=t,this.renderCoordsHelper.fromRenderCoords(this._camera.eye,this._tmpPoint);let e=(this._tmpPoint.z??0)>NE&&this.renderCoordsHelper.viewingMode===me.Global&&(t.isWGS84||t.isWebMercator),i=new AbortController;return this.map.ground.queryElevation(this._tmpPoint,{signal:i.signal,cache:this.cache,minDemResolution:e?FE:0}).then(r=>this._updateSurfaceAltitude(r.geometry.z??0)).catch(r=>{ss(r)||this._updateSurfaceAltitude(0)}).catch(()=>{}).then(()=>{this._pendingElevationQueryController===i&&(this._pendingElevationQueryController=null,this.notifyChange("updating")),i=null}),this._pendingElevationQueryController=i,Xt}_updateSurfaceAltitude(t){this._estimatedSurfaceAltitude!==t&&(this._estimatedSurfaceAltitude=t,this._updateRenderLocation())}_updateRenderLocation(){this.renderCoordsHelper.setAltitude(s0,this._estimatedSurfaceAltitude,this._camera.eye),Il(this._get("renderLocation"),s0)||(this._set("renderLocation",q(this._propertiesPool.get("renderLocation"),s0)),this.notifyChange("renderLocation"))}};c([p({constructOnly:!0})],Ts.prototype,"scheduler",void 0),c([p({constructOnly:!0})],Ts.prototype,"cache",void 0),c([p({constructOnly:!0})],Ts.prototype,"task",void 0),c([p()],Ts.prototype,"location",null),c([p({constructOnly:!0})],Ts.prototype,"map",void 0),c([p()],Ts.prototype,"renderLocation",void 0),c([p()],Ts.prototype,"scale",null),c([p()],Ts.prototype,"updating",null),Ts=c([S("esri.views.3d.support.pointsOfInterest.CameraOnSurface")],Ts);var s0=_(),NE=1e5,FE=1e6;var VE=Array,Jr=class extends Zs{constructor(t){super(t),this._propertiesPool=new wr({location:_r,renderLocation:VE},this),this._currentSurfaceAltitude=0,this._latestSurfaceAltitude=0,this.distance=0,this.renderLocation=_(),this.updating=!1}initialize(){this._frameWorker=this.scheduler.registerTask(this.task,this),this.runTask()}destroy(){this._frameWorker=Pi(this._frameWorker),this._propertiesPool=G(this._propertiesPool)}get _camera(){return this.state.contentCamera}get location(){let t=this._propertiesPool.get("location");return t.spatialReference=this.state.spatialReference,this.renderCoordsHelper.fromRenderCoords(this.renderLocation,t),t}updateRenderLocation(){this.updating=!0,this._updateRenderLocation()}get estimatedSurfaceAltitude(){return this._latestSurfaceAltitude}get running(){return this.updating}runTask(){return this._latestSurfaceAltitude=this.estimateSurfaceAltitudeAtCenter(),this._updateRenderLocation(),this.updating=!1,Xt}_updateRenderLocation(){let t=HE,e=this._calculateSurfaceIntersection(this._currentSurfaceAltitude,t),i=this._currentSurfaceAltitude!==this._latestSurfaceAltitude;!e&&i&&(e=this._calculateSurfaceIntersection(this._latestSurfaceAltitude,t),e&&(this._currentSurfaceAltitude=this._latestSurfaceAltitude));let r=qE;e&&this._latestSurfaceAltitudeChangesDistanceSignificantly(t,r)&&(q(t,r),this._currentSurfaceAltitude=this._latestSurfaceAltitude),e?this.distance=It(this._camera.eye,t):(k(t,this._camera.viewForward,this._get("distance")),K(t,t,this._camera.eye)),Il(this._get("renderLocation"),t)||this._set("renderLocation",q(this._propertiesPool.get("renderLocation"),t))}_calculateSurfaceIntersection(t,e){let i=this._camera;if(!this.renderCoordsHelper.intersectInfiniteManifold(i.ray,t,e))return!1;if(this.state.isGlobal){let r=Ue(this.renderCoordsHelper.spatialReference).radius,s=r+t,a=Mi(i.eye),n=a<s*s,o=It(i.eye,e);if(n&&o>r/4){let l=s-Math.sqrt(a);return k(e,i.viewForward,l),K(e,e,i.eye),!0}}else{let r=this.surface?.ready?this.surface.extent:null;r!=null&&om(r,this.surface?.spatialReference,_d,this.renderCoordsHelper.spatialReference)&&(e[0]=N(e[0],_d[0],_d[2]),e[1]=N(e[1],_d[1],_d[3]))}return!0}_latestSurfaceAltitudeChangesDistanceSignificantly(t,e){if(this._latestSurfaceAltitude===this._currentSurfaceAltitude||t==null)return!1;if(this._calculateSurfaceIntersection(this._latestSurfaceAltitude,e)){if(ui.TESTS_DISABLE_OPTIMIZATIONS)return!0;let i=this._camera.eye,r=It(i,t),s=It(i,e);if(Math.abs(s-r)/r>UE)return!0}return!1}};c([p({constructOnly:!0})],Jr.prototype,"scheduler",void 0),c([p({constructOnly:!0})],Jr.prototype,"task",void 0),c([p()],Jr.prototype,"distance",void 0),c([p({constructOnly:!0})],Jr.prototype,"estimateSurfaceAltitudeAtCenter",void 0),c([p({readOnly:!0})],Jr.prototype,"location",null),c([p({readOnly:!0})],Jr.prototype,"renderLocation",void 0),c([p()],Jr.prototype,"updating",void 0),Jr=c([S("esri.views.3d.support.pointsOfInterest.CenterOnSurface")],Jr);var UE=.05,HE=_(),qE=_(),_d=kt();var rf=class{constructor(e){this._handles=new Tl,this.events=new tr,this._contentLayerViews=e.contentLayerViews,this._handles.add(this._contentLayerViews.on("change",i=>this._layerViewsChanged(i))),this._layerViewsChanged({added:this._contentLayerViews.toArray(),removed:[],moved:[],target:this._contentLayerViews})}destroy(){this._handles=G(this._handles),this._contentLayerViews.destroy()}_layerViewsChanged(e){e.added.forEach(i=>{i.declaredClass==="esri.views.3d.layers.SceneLayerView3D"&&this._handles.add(i.on("visible-geometry-changed",()=>this._contentChanged()),i.uid)}),e.removed.forEach(i=>this._handles.remove(i.uid))}_contentChanged(){this.events.emit("request-update",BE)}},BE={};var kE=Array,Cs=class extends Zs{constructor(t){super(t),this._propertiesPool=new wr({location:_r,renderLocation:kE},this),this._dirty=!0,this.renderLocation=this._propertiesPool.get("renderLocation")}initialize(){this.addHandles([P(()=>this.centerOnSurface.renderLocation,()=>this.updateRenderLocation()),P(()=>this.state.contentCamera,()=>this.updateRenderLocation())]),this.scheduler&&this.addHandles(this.scheduler.registerTask(ut.POINT_OF_INTEREST_FREQUENT,this))}destroy(){this._propertiesPool=G(this._propertiesPool)}get updating(){return this._dirty||this.centerOnSurface.updating}get location(){let t=this._propertiesPool.get("location");return t.spatialReference=this.state.spatialReference,this.renderCoordsHelper.fromRenderCoords(this.renderLocation,t),t}get worldUnitsPerContentPixel(){let{camera:t,contentPixelRatio:e}=this.state;return t.computeRenderPixelSizeAt(this.renderLocation)*(t.pixelRatio/e)}get running(){return this._dirty}runTask(){let t=this._get("renderLocation"),e=this.centerOnSurface.renderLocation,i=this.renderCoordsHelper,r=this.state.contentCamera;this._dirty=!1,i.worldUpAtPosition(e,kS);let s=Math.max(0,(Math.acos($(kS,r.viewForward))-.5*Math.PI)*(r.aboveGround?1:-1));if(Number.isNaN(s)){if(!t||!Tn(t,e)){let l=this._propertiesPool.get("renderLocation");q(l,e),this._set("renderLocation",l)}return Xt}let a=1-N(s/(.5*Math.PI),0,1),n=a*a*a;this._calculateScreenHorizontalEdgeOnSurface(GS);let o=this._propertiesPool.get("renderLocation");return Ui(o,e,GS,n),t&&Tn(t,o)||this._set("renderLocation",o),Xt}_calculateScreenHorizontalEdgeOnSurface(t){let e=this.state.contentCamera,i=e.getRenderCenter(xo());if(i[1]=e.aboveGround?e.padding[$i.BOTTOM]:e.fullHeight-e.padding[$i.TOP],this.estimateSurfaceIntersectionAtRenderPoint(i,t))return t;let r=this.renderCoordsHelper.getAltitude(this.centerOnSurface.renderLocation);if(e.unprojectFromRenderScreen(i,gd)){ae(gd,gd,e.eye);let s=z(gd,gd);if(this.renderCoordsHelper.intersectInfiniteManifold(Fs(e.eye,s),r,t))return t}return this.renderCoordsHelper.setAltitude(t,r,e.eye)}updateRenderLocation(){this._dirty=!0}};c([p()],Cs.prototype,"_dirty",void 0),c([p({constructOnly:!0})],Cs.prototype,"scheduler",void 0),c([p({constructOnly:!0})],Cs.prototype,"centerOnSurface",void 0),c([p({constructOnly:!0})],Cs.prototype,"estimateSurfaceIntersectionAtRenderPoint",void 0),c([p()],Cs.prototype,"updating",null),c([p()],Cs.prototype,"location",null),c([p()],Cs.prototype,"renderLocation",void 0),c([p()],Cs.prototype,"worldUnitsPerContentPixel",null),Cs=c([S("esri.views.3d.support.pointsOfInterest.Focus")],Cs);var kS=_(),gd=_(),GS=_();var Pa=class extends te{get surface(){return this.view.map?.ground}get surfaceView(){return this.view.basemapTerrain}get renderLocation(){if(!this.location)return null;let t=_();return this.view.renderCoordsHelper.toRenderCoords(this.location,t),t}constructor(t){super(t),this.location=null,this._updateController=null}initialize(){this.view.state.isLocal&&(this.addHandles([P(()=>[this.surfaceView?.spatialReference,this.surfaceView?.extent],()=>this._update()),Er(()=>this.surface?.layers,"change",()=>this._update())]),this._update())}_update(){if(this._updateController&&(this._updateController.abort(),this._updateController=null),this.surfaceView?.extent==null||this.surfaceView.spatialReference==null)return void this._set("location",null);let t=fp(this.surfaceView.extent),e=new _r({x:t[0],y:t[1],z:0,spatialReference:this.surfaceView.spatialReference});this.surface&&this.surface.layers.length>0?(this._set("location",null),this._updateController=new AbortController,this.surface.queryElevation(e,{noDataValue:0,signal:this._updateController.signal,cache:this.cache}).then(i=>{this._updateController=null,this._set("location",i.geometry)}).catch(i=>{})):this._set("location",e)}};c([p({constructOnly:!0})],Pa.prototype,"view",void 0),c([p({constructOnly:!0})],Pa.prototype,"cache",void 0),c([p()],Pa.prototype,"surface",null),c([p()],Pa.prototype,"surfaceView",null),c([p({readOnly:!0})],Pa.prototype,"location",void 0),c([p({readOnly:!0})],Pa.prototype,"renderLocation",null),Pa=c([S("esri.views.3d.support.pointsOfInterest.StableSurfaceCenter")],Pa);var Ma=class extends te{constructor(t){super(t),this._tileGeometryUpdateExtent=Os(),this._tileGeometryUpdateSpatialReference=null,this.events=new tr,this.updating=!1}initialize(){this.addHandles([this.surface.on("elevation-change",t=>this._tileGeometryChanged(t)),this.scheduler.registerTask(ut.SURFACE_GEOMETRY_UPDATES,this)])}get running(){return this.updating}runTask(){return this.updating?(this._tileGeometryUpdateSpatialReference&&this._centerIntersectsExtent(this._tileGeometryUpdateExtent,this._tileGeometryUpdateSpatialReference)&&this.events.emit("request-update",GE),Os(this._tileGeometryUpdateExtent),this._set("updating",!1),Xt):Xt}_tileGeometryChanged(t){this._tileGeometryUpdateSpatialReference=t.spatialReference,ta(this._tileGeometryUpdateExtent,t.extent,this._tileGeometryUpdateExtent),this._set("updating",!0)}_furthestCenterOnSurface(){let t=this.centerOnSurfaces[0];for(let e=1;e<this.centerOnSurfaces.length;e++){let i=this.centerOnSurfaces[e];i.distance>t.distance&&(t=i)}return t}_centerIntersectsExtent(t,e){let i=this.state.contentCamera.eye,r=zE,s=this._furthestCenterOnSurface();return this.renderCoordsHelper.fromRenderCoords(i,il,e),this.renderCoordsHelper.fromRenderCoords(s.renderLocation,rl,e),il[0]<rl[0]?(r[0]=il[0],r[2]=rl[0]):(r[0]=rl[0],r[2]=il[0]),il[1]<rl[1]?(r[1]=il[1],r[3]=rl[1]):(r[1]=rl[1],r[3]=il[1]),ja(r,t)}};c([p({constructOnly:!0})],Ma.prototype,"state",void 0),c([p({constructOnly:!0})],Ma.prototype,"centerOnSurfaces",void 0),c([p({constructOnly:!0})],Ma.prototype,"renderCoordsHelper",void 0),c([p({constructOnly:!0})],Ma.prototype,"scheduler",void 0),c([p({constructOnly:!0})],Ma.prototype,"surface",void 0),c([p({readOnly:!0})],Ma.prototype,"updating",void 0),Ma=c([S("esri.views.3d.support.pointsOfInterest.SurfaceGeometryUpdates")],Ma);var GE={},il=_(),rl=_(),zE=Os();var dr=class extends te{constructor(t){super(t),this.renderPointOfView=_(),this._pois=new Array,this._debugCenters=null,this._tmpRay=Wr(),this._centerRayDirty=!0,this._surfaceAltitudeAtCenter=0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenter=0,this._contentAltitudeAtCenterDirty=!0,this._propertiesPool=new wr({renderPointOfView:jE},this)}initialize(){let{state:t,basemapTerrain:e,renderCoordsHelper:i,map:r}=this.view;this._surfaceIntersector=Zi(t.viewingMode),this._surfaceIntersector.options.invisibleTerrain=!1,this._surfaceIntersector.options.store=ps.MIN,this._contentIntersector=Zi(t.viewingMode);let s=()=>this._estimateSurfaceAltitudeAtCenter(),a=this.view.resourceController.scheduler,n=this.view.basemapTerrain?.elevationQueryCache,o={state:t,scheduler:a,surface:e,renderCoordsHelper:i};this._set("centerOnSurfaceInfrequent",new Jr(Bt(lt({},o),{task:ut.POINT_OF_INTEREST_INFREQUENT,estimateSurfaceAltitudeAtCenter:s}))),this._set("centerOnSurfaceFrequent",new Jr(Bt(lt({},o),{task:ut.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:s}))),this._set("centerOnContent",new Jr(Bt(lt({},o),{task:ut.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:()=>this._estimateContentAltitudeAtCenter()}))),this._set("cameraOnSurface",new Ts(Bt(lt({},o),{cache:n,task:ut.POINT_OF_INTEREST_INFREQUENT,map:r}))),this._set("surfaceGeometryUpdates",new Ma(Bt(lt({},o),{centerOnSurfaces:[this.centerOnSurfaceFrequent,this.centerOnContent,this.centerOnSurfaceInfrequent]}))),this._set("contentGeometryUpdates",new rf({contentLayerViews:this.view.allLayerViews,renderCoordsHelper:i})),this._set("surfaceOrigin",new Pa({cache:n,view:this.view})),this._set("focus",new Cs({state:t,scheduler:a,surface:e,renderCoordsHelper:i,centerOnSurface:this.centerOnSurfaceFrequent,estimateSurfaceIntersectionAtRenderPoint:(l,h)=>this._estimateSurfaceIntersectionAtRenderPoint(l,this.view.state.contentCamera,h)})),this._pois.push(this.centerOnContent,this.centerOnSurfaceFrequent,this.centerOnSurfaceInfrequent,this.cameraOnSurface,this.focus),this.addHandles([P(()=>t.contentCamera,l=>this._cameraChanged(l),we),P(()=>e.extent,()=>this._updateCenterPointsOfInterest()),P(()=>this.view.map?.ground?.navigationConstraint?.type,l=>{this._surfaceIntersector.options.backfacesTerrain=l==="none"},Ie),ka(()=>!e.updating,()=>this._updateCenterPointsOfInterest(),we),Er(()=>this.surfaceGeometryUpdates.events,"request-update",()=>this._updateCenterPointsOfInterest()),Er(()=>this.contentGeometryUpdates.events,"request-update",()=>this._updateCenterOnContent()),P(()=>ui.SHOW_POI,l=>this._setDebug(l),Ie)]),this._cameraChanged(this.view.state.contentCamera);for(let l of this._pois)l.runTask()}destroy(){this._setDebug(!1),this._propertiesPool.destroy();for(let t of this._pois)t.destroy();this.surfaceOrigin.destroy()}get updating(){return!(!this.surfaceGeometryUpdates?.updating&&!this._pois.some(t=>t.updating))}get _centerRay(){return this._centerRayDirty&&(this._centerRayCached=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(this.view.state.contentCamera,this._tmpRay),this._centerRayDirty=!1),this._centerRayCached}_estimateContentAltitudeAtCenter(){if(!this._contentAltitudeAtCenterDirty)return this._contentAltitudeAtCenter;this._contentAltitudeAtCenterDirty=!1;let t=this._centerRay;return t==null||(this.view.sceneIntersectionHelper.intersectRay(t,this._contentIntersector,Dh,QE)?this._contentAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(Dh):this._contentAltitudeAtCenter=this._estimateSurfaceAltitudeAtCenter()),this._contentAltitudeAtCenter}_estimateSurfaceAltitudeAtCenter(){if(!this.view.basemapTerrain)return 0;if(!this._surfaceAltitudeAtCenterDirty)return this._surfaceAltitudeAtCenter;this._surfaceAltitudeAtCenterDirty=!1;let t=this._centerRay;if(t==null)return this._surfaceAltitudeAtCenter;let e=t.origin,i=K(Dh,t.origin,t.direction);return this._surfaceIntersector.resetWithRay(t,this.view.state.contentCamera),this.view.basemapTerrain.intersect(this._surfaceIntersector,null,e,i),this._surfaceIntersector.results.min.getIntersectionPoint(Dh)&&(this._surfaceAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(Dh)),this._surfaceAltitudeAtCenter}_estimateSurfaceIntersectionAtRenderPoint(t,e,i){let r=hm(e,t,WE);if(r==null)return null;let s=r.origin,a=K(Dh,r.origin,r.direction);return this._surfaceIntersector.resetWithRay(r,e),this.view.basemapTerrain.intersect(this._surfaceIntersector,null,s,a),this._surfaceIntersector.results.min.getIntersectionPoint(i)?i:null}_cameraChanged(t){this._updateCenterPointsOfInterest();let e=t.eye;Il(this.renderPointOfView,e)||this._set("renderPointOfView",q(this._propertiesPool.get("renderPointOfView"),e))}_updateCenterPointsOfInterest(){this._centerRayDirty=!0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenterDirty=!0;for(let t of this._pois)t.updateRenderLocation()}_updateCenterOnContent(){this._contentAltitudeAtCenterDirty=!0,this.centerOnContent.updateRenderLocation()}_setDebug(t){if(!t)return this._debugCenters?.forEach(e=>e.hide()),void this.removeHandles("debug");if(!this._debugCenters){this._debugCenters=new Map;let e=this.view.graphics;this._debugCenters.set(this.centerOnContent,new Ra(e,"red","CenterOnContent")),this._debugCenters.set(this.centerOnSurfaceFrequent,new Ra(e,"red","CenterOnSurface")),this._debugCenters.set(this.centerOnSurfaceInfrequent,new Ra(e,"red","CenterOnSurface")),this._debugCenters.set(this.cameraOnSurface,new Ra(e,"blue","CameraOnSurface")),this._debugCenters.set(this.focus,new Ra(e,"green","Focus"))}for(let e of this._pois)this.addHandles(P(()=>e.renderLocation,i=>this._debugCenters?.get(e)?.show(i,e.renderCoordsHelper.spatialReference),Ie),"debug")}get test(){}};c([p()],dr.prototype,"centerOnContent",void 0),c([p()],dr.prototype,"centerOnSurfaceFrequent",void 0),c([p()],dr.prototype,"centerOnSurfaceInfrequent",void 0),c([p()],dr.prototype,"cameraOnSurface",void 0),c([p()],dr.prototype,"focus",void 0),c([p()],dr.prototype,"renderPointOfView",void 0),c([p()],dr.prototype,"surfaceOrigin",void 0),c([p()],dr.prototype,"contentGeometryUpdates",void 0),c([p()],dr.prototype,"surfaceGeometryUpdates",void 0),c([p({constructOnly:!0})],dr.prototype,"view",void 0),c([p()],dr.prototype,"updating",null),dr=c([S("esri.views.3d.support.pointsOfInterest.PointsOfInterest")],dr);var jE=Array,Dh=_(),WE=Wr(),QE={exclude:new Set([Za])};var $E=()=>pe.getLogger("esri/core/MemCachePool"),xs=class{constructor(e,i){this._cache=e(i,(r,s,a)=>{switch(s){case cg.ALL:return r.forEach(n=>n.dispose()),0;case cg.SOME:{let n=r.shift();return n?(a-=Math.round(n.cachedMemory),n.dispose()):a>0&&($E().warn("Encountered empty MemCachePool with non-zero memory."),a=0),a}}})}hitrate(){return this._cache.hitRate}destroy(){this._cache.destroy()}clear(){this._cache.clear()}getSize(e){return this._cache.getSize(e)}pop(e){let i=this._cache.peek(e);if(!i)return;let r=i.pop();return i.length>0?r&&(i.cachedMemory=this._cache.getSize(e)-Math.round(r.cachedMemory),this._cache.updateSize(e,i)):this._cache.pop(e),r}put(e,i,r=g1){let s=this._cache.peek(e);if(s)s.push(i),s.cachedMemory=this._cache.getSize(e)+Math.round(i.cachedMemory),this._cache.updateSize(e,s);else{let a=new a0(i);this._cache.put(e,a,r)}}},a0=class extends Array{constructor(e){super(),this.item=e,this.cachedMemory=e.cachedMemory,this.push(e)}};var Aa=class{constructor(e=0,i=0){this.min=e,this.max=i,this.level=0,this.hasNoDataValues=!1}copyFrom(e){this.min=e.min,this.max=e.max,this.level=e.level,this.hasNoDataValues=e.hasNoDataValues}};var sf=class{constructor(e,i,r){this.type="elevation",this.level=e[0],this.i=e[1],this.j=e[2],this.extent=i,this.samplerData=new _b(r,i)}computeMinMaxValue(e,i,r,s){s.min=1/0,s.max=-1/0,s.hasNoDataValues=!1;let a=e-this.level;if(a<=0)return s;let n=2**a;if(!(Math.floor(i/n)===this.i&&Math.floor(r/n)===this.j))return s;let o=1/0,l=-1/0,h=this.samplerData.data.width,d=this.samplerData.data.values,m=.5*Ug,u=(h-1)/n,f=(r-this.j*n)*u,g=(i-this.i*n)*u;if(u<1){let y=Math.floor(f),v=Math.floor(g),w=y+v*h,b=d[w],R=d[w+1],C=d[w+h],x=d[w+h+1];if(b+R+C+x<m){let T=f-y,M=g-v,E=xc(b,R,C,x,T,M),O=xc(b,R,C,x,T+u,M),Z=xc(b,R,C,x,T,M+u),H=xc(b,R,C,x,T+u,M+u);return s.min=Math.min(E,O,Z,H),s.max=Math.max(E,O,Z,H),s}f=y,g=v,u=1}else f=Math.floor(f),g=Math.floor(g),u=Math.ceil(u);for(let y=f;y<=f+u;y++)for(let v=g;v<=g+u;v++){let w=d[y+v*h];w<m?(o=Math.min(o,w),l=Math.max(l,w)):s.hasNoDataValues=!0}return s.min=o,s.max=l,s}},ZE=.5*Ug;function Mt(t,e,i){if(i==null)return null;for(let r of i){if(!r)continue;let s=r.safeWidth,a=N(r.dy*(r.y1-e),0,s),n=N(r.dx*(t-r.x0),0,s),o=Math.floor(a),l=Math.floor(n),h=r.data.width,d=o*h+l,m=r.data.values,u=m[d],f=m[d+1],g=d+h,y=m[g],v=m[g+1];if(u+y+f+v<ZE){a-=o,n-=l;let w=u+(f-u)*n;return w+(y+(v-y)*n-w)*a}}return null}var Ss=class extends te{constructor(t){super(t)}initialize(){this.addHandles([this.layerViews.on("change",()=>this.notifyChange("stencilEnabledExtents"))])}destroy(){}get layerViewsExtent(){return this._computeLayerViewsExtent()}get tiledLayersExtent(){return this._computeTiledLayersExtent()}get stencilEnabledExtents(){return this._computeStencilEnabledExtents()}_computeStencilEnabledExtents(){let t=[];return this.layerViews.forEach(e=>{let i=e.layer;if("operationalLayerType"in i&&Kv(i.operationalLayerType)&&this.viewSpatialReference!=null){let r=jS(i.fullExtent,this.viewSpatialReference);r!=null&&t.push(Jv(r))}}),t}};function zS(t,e){return t===me.Global?new n0(e):new o0(e)}c([p({readOnly:!0})],Ss.prototype,"layerViewsExtent",null),c([p({readOnly:!0})],Ss.prototype,"tiledLayersExtent",null),c([p({readOnly:!0})],Ss.prototype,"stencilEnabledExtents",null),c([p()],Ss.prototype,"viewSpatialReference",void 0),c([p()],Ss.prototype,"tilingScheme",void 0),c([p()],Ss.prototype,"defaultTiledLayersExtent",void 0),c([p({constructOnly:!0})],Ss.prototype,"layers",void 0),c([p({constructOnly:!0})],Ss.prototype,"layerViews",void 0),Ss=c([S("esri.views.3d.terrain.ExtentHelper")],Ss);var n0=class extends Ss{_computeLayerViewsExtent(){return this._globalExtent}_computeTiledLayersExtent(){return this._globalExtent}get _globalExtent(){return this.viewSpatialReference.isWebMercator?Jb:eT}};n0=c([S("esri.views.3d.terrain.ExtentHelper.ExtentHelperGlobal")],n0);var o0=class extends Ss{_computeLayerViewsExtent(){let t=Os(),e=this.viewSpatialReference;this.layerViews.forEach(s=>{let a=s.layer;if(s.isResolved()&&(a.type!=="graphics"||!a.internal)){let n=jS("fullExtentInLocalViewSpatialReference"in s&&s.fullExtentInLocalViewSpatialReference||s.layer.fullExtent,e);ta(t,n,t)}});let i=sg(t)?t:null,r=this._get("layerViewsExtent");return Ds(i,r)?r:i}_computeTiledLayersExtent(){let t=this.tilingScheme;if(!t)return null;let e=this.viewSpatialReference,i=Os();this.layers.forEach(a=>{if(a.loaded&&yn(a)){let n=Fo(a,e,me.Local);if(n==null)return;let{tileInfo:o,fullExtent:l}=n,h="tilemapCache"in a?a.tilemapCache?.effectiveMaxLOD:void 0;o!=null&&l!=null&&(bm(a)||t.compatibleWith(o,h)&&l.spatialReference.equals(t.spatialReference))&&ta(i,l,i)}}),ta(i,this.defaultTiledLayersExtent,i);let r=sg(i)?i:null,s=this._get("tiledLayersExtent");return Ds(r,s)?s:r}};function jS(t,e){return t==null||t.spatialReference.equals(e)?t:E1(t,t.spatialReference,e)}o0=c([S("esri.views.3d.terrain.ExtentHelper.ExtentHelperLocal")],o0);function af(){let t=globalThis.require?.modules;if(t){let e=Object.keys(t);for(let i of e)i.includes(".glsl")&&delete t[i]}}var yd=class{constructor(e,i){this.screen=e,this.olid=i}};var WS=1.3,YE=[[-.1,-2,3.9,2],[-.1,-3.9,3.9,.1],[-2,-3.9,2,.1],[-3.9,-3.9,.1,.1],[-3.9,-2,.1,2],[-3.9,-.1,.1,3.9],[-2,-.1,2,3.9],[-.1,-.1,3.9,3.9]],po,pr=class extends te{constructor(t){super(t),this._renderSR=null,this._overlaySREqualsRenderSR=!0,this._drapeSources=new Set,this._drapeTargets=new Set,this._placementDirty=!1,this._contentUpdated=!1,this._drawTexturesDirty=!1,this._drawTexturesAnimateDirty=!1,this._latestOriginId=0,this._maxResolution=Yt("esri-mobile")?2048:4096}initialize(){let t=this.view;this.renderer=new zb({parent:this}),t._stage.renderer.plugins.add(this.renderer);let e=()=>this.requestRender();this._groundIntersector=Zi(this.view.state.viewingMode),this._groundIntersector.options.backfacesTerrain=!0,this._groundIntersector.options.invisibleTerrain=!0,this._groundIntersector.options.hud=!1,this.addHandles([P(()=>this.renderer.hasHighlights,e),this.renderer.events.on("has-water",()=>t._stage?.renderer.updateHasFlags()),this.renderer.events.on("content-changed",e),P(()=>t.state.camera.pixelRatio,e),P(()=>t.state.alignPixelEnabled,e),this.renderer.events.on("textures-disposed",()=>this.surface.requestRender()),P(()=>[t.pointsOfInterest?.renderPointOfView,t.pointsOfInterest?.centerOnSurfaceFrequent?.location],()=>this.setPlacementDirty()),P(()=>[t.state?.pixelRatio,t.state?.contentPixelRatio],()=>this.setPlacementDirty(),we),this.surface.on("elevation-change",()=>this.setPlacementDirty()),t.on("resize",()=>this.setPlacementDirty()),t.resourceController.scheduler.registerTask(ut.OVERLAY,this),t._stage.renderView.events.on("force-camera-for-screenshot",i=>{this._updateOverlays(Dr,i.camera,oe.BACKGROUND),this.renderer.hasOverlays&&this._drawOverlays(oe.BACKGROUND,i)})]),t._stage.renderer.overlay=this}destroy(){this.view?._stage&&(this.view._stage.renderer.plugins.remove(this.renderer),this.view._stage.renderer.overlay=null),po&&(po.hide(),po=null),this.renderer=G(this.renderer)}get spatialReference(){return this._spatialReference}set spatialReference(t){this._spatialReference=t,this.renderer.longitudeCyclical=null;let e=this.view.renderSpatialReference;t!=null&&e!=null?(this._renderSR=e,this._overlaySREqualsRenderSR=t.equals(this._renderSR),this._isSpherical&&(this.renderer.longitudeCyclical=t.isWebMercator?new Sg(-20037508342787e-6,20037508342787e-6):new Sg(-180,180))):this.renderer.disposeOverlays()}get running(){return this._placementDirty&&(this._drapeSources.size>0||this.view.graphics.length>0||ui.OVERLAY_DRAW_DEBUG_TEXTURE)&&!!this._spatialReference&&!this.suspended&&this.surface.ready}get _isSpherical(){return this.view.state.isGlobal}get worldToPCSRatio(){return this._spatialReference!=null&&this._spatialReference.isGeographic&&!this.view.state.isLocal?Ue(this._spatialReference).metersPerDegree:1}get _overlayStretch(){return WS/this.view.resolutionScale}get _longitudeCyclical(){return this.renderer.longitudeCyclical}get suspended(){return this.surface.suspended}get updating(){return this.running||this.renderer.updating||this._contentUpdated}get rendersOccludedDraped(){return this.renderer.rendersOccludedDraped}render(){if(this._contentUpdated=!1,this.renderer.processSyncDrapeSources(),this.renderer.hasOverlays)return this._precompileShaders()?this._drawOverlays(oe.UPDATE):null}get hasOverlays(){return this.renderer.hasOverlays}registerDrapeSource(t,e,i){this._drapeSources.add(t),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources);let r=this.renderer.createDrapeSourceRenderer(t,e,i);return this._updateDrapeSourceExtent(t),this._setContentDirty(),this.notifyChange("running"),r}registerGeometryDrapeSource(t){return this.registerDrapeSource(t,uC)}_updateDrapeSourceExtent(t){this.renderer.overlays.length===2&&t.setDrapingExtent!=null&&this._spatialReference!=null&&t.setDrapingExtent(this.renderer.overlays,this._spatialReference)}unregisterDrapeSource(t){this._drapeSources.has(t)&&(this._drapeSources.delete(t),this.renderer.removeDrapeSourceRenderer(t),this.renderer.ensureDrapeSources(this._drapeSources),this._setContentDirty(),this.notifyChange("running"))}registerDrapeTarget(t){this._drapeTargets.add(t),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources)}unregisterDrapeTarget(t){this._drapeTargets.delete(t),this.renderer.ensureDrapeTargets(this._drapeTargets)}_setContentDirty(){this.setPlacementDirty(),this.requestRender()}setPlacementDirty(){this._placementDirty=!0}runTask(t){return this._updateOverlays(t,this.view.state.contentCamera,oe.UPDATE)}_updateOverlays(t,e,i){if(!this._spatialReference)return Xt;let r=this._computeOverlayResolution(e);this._computeOverlayExtents(e,r,Ea),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources,Ea.stretch);let s=this._updateOverlay(ks.INNER,Ea.inner,r,1*Ea.pixelRatioAdjustment,Ea.mapUnitsPerPixel),a=ia(Ea.inner)/ia(Ea.outer),n=this._updateOverlay(ks.OUTER,Ea.outer,r,a*Ea.pixelRatioAdjustment,Ea.mapUnitsPerPixel);s!==Oa.EXTENT&&n!==Oa.EXTENT||(this._drapeSources.forEach(o=>this._updateDrapeSourceExtent(o)),this.updateOverlayParameters(i)),s===Oa.NONE&&n===Oa.NONE||this.requestRender(),this._placementDirty=!1,t.madeProgress()}_computeOverlayResolution(t){let e=this.view.state.contentPixelRatio*this.view.resolutionScale,i=t.fullWidth/t.pixelRatio*e,r=t.fullHeight/t.pixelRatio*e,s=Math.ceil(1.5*Math.max(i,r));return Math.min(Ln(s),this._maxResolution)}_updateOverlay(t,e,i,r,s){if(this.renderer.overlays.length===0)return Oa.NONE;let a=this.renderer.overlays[t],n=a.mapUnitsPerPixel;if(a.mapUnitsPerPixel=s,a.pixelRatio=r,KE(e,a.extent)&&i===a.resolution)return n===s?Oa.NONE:Oa.RERENDER_ONLY;_c(a.extent,e),a.resolution=i;let o=fp(a.extent);return a.renderLocalOrigin=Fb(o[0],o[1],0,"OV_"+this._latestOriginId++),Oa.EXTENT}updateOverlayParameters(t){this.surface.allTiles.forAll(e=>this.updateTileOverlayParameters(e)),this.surface.requestRender(t)}updateTileOverlayParameters(t){if(!t.renderData)return;let e=t.renderData.overlay;if(this.renderer.overlays.length===0)this._clearTileOverlayData(ks.INNER,e),this._clearTileOverlayData(ks.OUTER,e);else{let[i,r]=this.renderer.overlays,s=t.extent;this._rectInsideRect(i.extent,s)||this._rectanglesOverlap(s,i.extent)||this._rectanglesOverlap(s,r.extent)?(this._setTileOverlayData(s,ks.INNER,e),this._setTileOverlayData(s,ks.OUTER,e)):(this._clearTileOverlayData(ks.INNER,e),this._clearTileOverlayData(ks.OUTER,e))}}overlayPixelSizeInMapUnits(t,e){if(this.renderer.overlays.length===0)return e();let i=this.renderer.overlays[ks.INNER],r=this.renderer.overlays[ks.OUTER],s=this._pointIsInExtent(t,i.extent)?i:r;return(s.extent[2]-s.extent[0])/s.resolution}_setTileOverlayData(t,e,i){if(this.renderer.overlays.length===0)return;let r=this.renderer.overlays[e].extent,s=ia(r),a=Co(r),n=t[0];if(this._longitudeCyclical){n=this._longitudeCyclical.minimalMonotonic(r[0],n);let o=this._longitudeCyclical.minimalMonotonic(r[0],t[2]);n>o&&(n=o-(t[2]-t[0]))}i.setScale(e,ia(t)/s,Co(t)/a),i.setOffset(e,(n-r[0])/s,(t[1]-r[1])/a)}_clearTileOverlayData(t,e){e.setScale(t,-1,-1),e.setOffset(t,-1,-1)}reloadShaders(){af(),this.requestRender(),this.runTask(Dr)}requestRender(t=oe.UPDATE){this.renderer.hasOverlays?(t===oe.UPDATE?(this._contentUpdated=!0,this._drawTexturesDirty=!0):this._drawTexturesAnimateDirty=!0,this.view._stage.renderView.requestRender(t)):this.setPlacementDirty()}_intersectGroundFromView(t,e,i,r,s){let a=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(t,eO,e,i);if(a==null)return!1;let n=a.origin,o=K(nf,a.origin,a.direction);this._groundIntersector.reset(n,o,t),this._groundIntersector.intersect([]),this.view.basemapTerrain.intersect(this._groundIntersector,null,n,o);let l=this._groundIntersector.results.min;return l.getIntersectionPoint(s)&&l.withinDistance(r)}_findHorizonBasedPointOfInterest(t,e){let i=.5,r=.55,s=this.view.renderCoordsHelper.getAltitude(t.eye),a=this.view.pointsOfInterest.centerOnSurfaceFrequent,n=1e-5,o=N(a.estimatedSurfaceAltitude,t.aboveGround?-1/0:s+n,t.aboveGround?s-n:1/0),l=t.aboveGround;if(this.view.viewingMode==="global"){let h=nf;Pn(Hl(ql,Ue(this.view.spatialReference).radius+o),Fs(t.eye,t.viewForward),h),ae(h,h,t.eye);let d=qs.normalize(rw(t.viewForward,h,t.viewRight))/t.fovY+.5,m=d<=0||d>=1?.5:r;i=l?m*d:d+m*(1-d)}else{let h=.5*Math.PI-Math.acos(-t.viewForward[2]),d=Math.tan(h),m=rr(0,d,1,0),u=wc(m,m,t.projectionMatrix)[1],f=N(.5+.5*u,0,1);i=f===1||f===0?.5:l?f*r:1-(1-f)*r}return this._intersectGroundFromView(t,.5,i,a.distance,e)}_computeOverlayExtents(t,e,i){let r=this.view.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,s=_();this._findHorizonBasedPointOfInterest(t,s)||q(s,r),ui.OVERLAY_SHOW_CENTER?(po==null&&(po=new Ra(this.view.graphics,"red")),po.show(s,this._renderSR)):po?.hide();let a=Math.max(.1,It(t.eye,s)),n=Bs(this.view.renderCoordsHelper,r,t.eye);this._overlaySREqualsRenderSR||En(s,this._renderSR,s,this._spatialReference);let o=this.surface.extent,l=!this._isSpherical&&this._spatialReference?.isGeographic,h=l&&this._spatialReference?1/Ue(this._spatialReference).metersPerDegree:1,d=this.view.state.contentPixelRatio,m=t.perScreenPixelRatio/d*a*h;i.mapUnitsPerPixel=m/this.worldToPCSRatio,i.stretch=this._overlayStretch;let u=e*m/2*i.stretch,f=!1,g=l?90:1/0;this._isSpherical&&o&&this._spatialReference&&(this._spatialReference.isWebMercator?(u/=Math.cos(Zv(s[1])),g=o[3]):(f=!0,u/=Ue(this._spatialReference).metersPerDegree,g=90),u>=g&&(u=g,s[1]=0,this._spatialReference.isWebMercator&&(s[0]=0)));let y=1;f&&(y=1/Math.max(.2,Math.cos(Math.abs(pt(s[1])))),u*y>180&&(y=180/u),i.mapUnitsPerPixel*=y);let v=Math.log(2)/12;u=Math.exp(Math.round(Math.log(u)/v)*v);let w=u*y,b=32,R=.5*e/(b*w),C=.5*e/(b*u);s[0]=Math.round(s[0]*R)/R,s[1]=Math.round(s[1]*C)/C;let x=i.inner;x[0]=s[0]-w,x[1]=s[1]-u,x[2]=s[0]+w,x[3]=s[1]+u,this._isSpherical&&this._shiftExtentToFitBounds(x,1/0,g);let T=i.outer;if(6*w>ia(o))_c(T,o);else if(Math.PI/2-Math.abs(n-Math.PI/2)<=.25*Math.PI)T[0]=x[0]-w,T[1]=x[1]-u,T[2]=x[2]+w,T[3]=x[3]+u;else{En(t.eye,this._renderSR,nf,this._spatialReference),D1(sl,s,nf);let E=-Math.atan2(sl[1],sl[0])+.125*Math.PI;E<0&&(E+=2*Math.PI);let O=Math.floor(E/(.25*Math.PI));vp(sl,YE[O],2*u),sl[0]*=y,sl[2]*=y,T1(T,x,sl)}if(this._isSpherical)T[0]=this._longitudeCyclical.clamp(T[0]),T[2]=this._longitudeCyclical.clamp(T[2]),T[1]=Math.max(T[1],-g),T[3]=Math.min(T[3],g);else{let E=gc(x,o,XE),O=gc(T,o,JE);ng(E,O)&&(T[2]=T[0],T[3]=T[1])}let M=Math.abs(x[2]-x[0])/e;i.mapUnitsPerPixel=Math.max(i.mapUnitsPerPixel,M),i.pixelRatioAdjustment=i.mapUnitsPerPixel/M}_precompileShaders(){return!!this.renderer.hasOverlays&&(this.renderer.precompileShaders(this.view.state),!0)}_drawOverlays(t,e=this.view.state){if(!this._drawTexturesDirty&&!this._drawTexturesAnimateDirty)return this.renderer;let i=this._drawTexturesDirty;this._drawTexturesDirty=this._drawTexturesAnimateDirty=!1;let r=this.renderer.computeValidity();return this.renderer.releaseRenderTargets(),this.renderer.drawOverlays(e),r!==this.renderer.computeValidity()&&this.updateOverlayParameters(oe.UPDATE),i?(this.surface.requestRender(t),t===oe.UPDATE&&this.surface.requestUpdate()):this.surface.requestRender(oe.BACKGROUND),this.renderer}_rectanglesOverlap(t,e){return t!=null&&(this._longitudeCyclical?(this._longitudeCyclical.contains(e[0],e[2],t[0])||this._longitudeCyclical.contains(e[0],e[2],t[2])||this._longitudeCyclical.contains(t[0],t[2],e[0]))&&!(t[1]>e[3]||t[3]<e[1]):ja(t,e))}_rectInsideRect(t,e){return e!=null&&(this._longitudeCyclical?this._longitudeCyclical.contains(t[0],t[2],e[0])&&this._longitudeCyclical.contains(t[0],t[2],e[2])&&e[1]>t[1]&&e[3]<t[3]:ng(t,e))}_pointIsInExtent(t,e){if(this._longitudeCyclical)return this._longitudeCyclical.contains(e[0],e[2],t.x)&&t.y>=e[1]&&t.y<=e[3];let i=t.x,r=t.y;return i>e[0]&&i<e[2]&&r>e[1]&&r<e[3]}_shiftExtentToFitBounds(t,e,i){let r=0,s=0;t[0]<-e?r=t[0]+e:t[2]>e&&(r=e-t[2]),t[1]<-i?s=t[1]+i:t[3]>i&&(s=i-t[3]),_p(t,r,s)}get test(){}};function KE(t,e){let r=ui.TESTS_DISABLE_OPTIMIZATIONS?0:1e-5*Math.max(t[2]-t[0],t[3]-t[1],e[2]-e[0],e[3]-e[1]);return Math.abs(e[0]-t[0])<=r&&Math.abs(e[1]-t[1])<=r&&Math.abs(e[2]-t[2])<=r&&Math.abs(e[3]-t[3])<=r}c([p()],pr.prototype,"_spatialReference",void 0),c([p({readOnly:!0})],pr.prototype,"running",null),c([p()],pr.prototype,"_placementDirty",void 0),c([p()],pr.prototype,"_contentUpdated",void 0),c([p()],pr.prototype,"_isSpherical",null),c([p()],pr.prototype,"worldToPCSRatio",null),c([p()],pr.prototype,"renderer",void 0),c([p({constructOnly:!0})],pr.prototype,"view",void 0),c([p({constructOnly:!0})],pr.prototype,"surface",void 0),c([p()],pr.prototype,"suspended",null),c([p()],pr.prototype,"updating",null),c([p({type:Boolean})],pr.prototype,"rendersOccludedDraped",null),pr=c([S("esri.views.3d.terrain.OverlayManager")],pr);var l0=class{constructor(){this.inner=kt(),this.outer=kt(),this.mapUnitsPerPixel=0,this.pixelRatioAdjustment=1,this.stretch=WS}},sl=ni(),nf=_(),Ea=new l0,XE=kt(),JE=kt(),eO=Wr(),Oa;(function(t){t[t.NONE=0]="NONE",t[t.EXTENT=1]="EXTENT",t[t.RERENDER_ONLY=2]="RERENDER_ONLY"})(Oa||(Oa={}));var of=class{constructor(){this.indices=null,this.indexCount=0,this.edgeIndicesStartIndex=0,this.poleIndicesStartIndex=0,this.vertexAttributes=null,this.edgeVerticesStartIndex=0,this.poleVerticesStartIndex=0,this.maxEdgeVertexCount=0,this.boundingBox=Ol(),this.numVerticesPerSide=0,this.minu=0,this.minv=0,this.maxu=1,this.maxv=1,this.outerEdgesOffsetAndLength=[0,0,0,0,0,0,0,0]}release(){this.vertexAttributes=ai(this.vertexAttributes),this.indices=null}reset(){this.indices=null,this.vertexAttributes=null,Ol(this.boundingBox),this.numVerticesPerSide=0}getEdgeFirstVertexIndex(e){return this.outerEdgesOffsetAndLength[2*e]}getEdgeCount(e){return this.outerEdgesOffsetAndLength[2*e+1]}getEdgeVertexIndex(e,i){return this.getEdgeAttributeIndex(e,i)}getEdgeVertexPosition(e,i,r,s){this._getEdgeVertexRaw(this.getEdgeAttributeIndex(e,s),i),K(i,i,r)}getEdgeNormal(e,i,r){let{typedBuffer:s,typedBufferStride:a}=this.vertexAttributes.normalCompressed;B1(i,s,this.getEdgeAttributeIndex(e,r),a)}setEdgeNormalFromValues(e,i,r,s,a){this._setNormal(this.getEdgeAttributeIndex(e,i),r,s,a)}setEdgeVertexFromValuesRawPositionUV(e,i,r,s,a,n,o){let l=this.getEdgeAttributeIndex(e,i);this.vertexAttributes.position.setValues(l,r,s,a),this._setUV(l,n,o)}setEdgeVertexFromValuesRawPositionUVNormal(e,i,r,s,a,n,o,l,h,d){let m=this.getEdgeAttributeIndex(e,i);this.vertexAttributes.position.setValues(m,r,s,a),this._setUV(m,n,o),this._setNormal(m,l,h,d)}_getEdgeVertexRaw(e,i){this.vertexAttributes.position.getVec(e,i)}_setNormal(e,i,r,s){let{typedBuffer:a,typedBufferStride:n}=this.vertexAttributes.normalCompressed;Ao(a,e,i,r,s,n)}_setUV(e,i,r){Rs(this.vertexAttributes.uv0,e,i,r)}getEdgeAttributeIndex(e,i){return V(0<=i&&i<this.getEdgeCount(e)),this.getEdgeFirstVertexIndex(e)+i}},QS=16384;function Rs(t,e,i,r){t.setValues(e,i*QS,r*QS)}var lf=class{constructor(){this.sinLonLUT=new Array(No+1),this.cosLonLUT=new Array(No+1),this.sinLatLUT=new Array(No+1),this.cosLatLUT=new Array(No+1)}update(e,i,r){let s=i[0],a=i[2];for(let n=0;n<=e;n++){let o=n/e,l=s*(1-o)+a*o;this.sinLonLUT[n]=Math.sin(l),this.cosLonLUT[n]=Math.cos(l);let h=r(o);this.sinLatLUT[n]=Math.sin(h),this.cosLatLUT[n]=Math.cos(h)}}};var hf=class{constructor(){this.numVerticesPerSide=0,this.samplerData=null,this.samplerDataVersion=0,this.clippingArea=null,this.wireframe=!1,this.cornerPeerNeighbors=[null,null,null,null],this.cornerNeighborCornerTiles=[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],this.cornerNeighborCornerTileSamplerVersions=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],this.edgeResolutions=[-1,-1,-1,-1],this.edgePeerNeighbors=[null,null,null,null],this.edgePeerNeighborSamplerVersions=[-1,-1,-1,-1]}};var vd=class t{constructor(e){this._getFadeDuration=e,this._fadeStart=0,this._delayedTime=0}clear(){this._current=G(this._current),this._next=G(this._next),this._waiting=G(this._waiting),this._delayed=G(this._delayed)}get current(){if(this._current==null)return null;if(!this._isFadingEnabled){let i=this._delayed||this._waiting||this._next||this._current;i!==this._current&&(this._current=null,this.clear(),this._current=i)}let e=t.test.fadeMoment;if(this._delayed!=null&&(e=e||performance.now(),e>=this._delayedTime&&(this._push(this._delayed,Da.Immediate),this._delayed=null)),this._next!=null){e=e||performance.now();let i=this._fadeDuration,r=this._current!=null&&this._next.texture===this._current.texture,s=this._next.type!==Ct.FADING,a=e-this._fadeStart>=i;(r||s||a)&&(G(this._current),this._current=this._next,this._next=this._waiting,this._waiting=null,this._fadeStart=this._alignFadeStart(e))}return this._current}get next(){return this._next}get fadeFactor(){if(this._next==null)return 1;let e=t.test.fadeMoment||performance.now(),i=Math.max(0,e-this._fadeStart),r=this._fadeDuration;return i>r?0:1-i/r}get isFading(){return this._next!=null||this._delayed!=null}push(e,i=Da.Immediate){this._delayed=G(this._delayed),this._push(e,i)}_push(e,i){if(this._isFadingEnabled||this.clear(),this._current==null)return void(this._current=e);let r=t.test.fadeMoment||performance.now();return i!==Da.Immediate?(this._delayed=e,void(this._delayedTime=r+i)):this._next==null?(this._next=e,void(this._fadeStart=this._alignFadeStart(r))):void(e!=null&&(G(this._waiting),this._waiting=e))}get _fadeDuration(){let e=this._getFadeDuration();return this._waiting?.5*e:e}_alignFadeStart(e){let i=this._getFadeDuration();return e+i-e%i}get _isFadingEnabled(){return this._getFadeDuration()>0}},Da;vd.test={fadeMoment:0},function(t){t[t.Immediate=0]="Immediate",t[t.Delayed=5e3]="Delayed"}(Da||(Da={}));var mo=class{constructor(e,i,r,s,a,n){this.texture=e,this.type=i,this.offsetAndScale=r,e.retain(),this.opacities=xt(s,a,n)}destroy(){this.texture.release()}};var cf=class{constructor(){this._scales=rr(-1,-1,-1,-1),this._offsets=rr(-1,-1,-1,-1)}clear(){this._scales[0]=this._scales[1]=this._scales[2]=this._scales[3]=-1,this._offsets[0]=this._offsets[1]=this._offsets[2]=this._offsets[3]=-1}setScale(e,i,r){this._scales[2*e]=i,this._scales[2*e+1]=r}setOffset(e,i,r){this._offsets[2*e]=i,this._offsets[2*e+1]=r}get scales(){return this._scales}get offsets(){return this._offsets}};var df=class extends Ne{constructor(e,i){super(e,i,new Le(kC,()=>import("./chunk-2V7FENHL.js")),h0),this.type="TerrainTechnique",this.useStencil=!1}initializePipeline(e){return this._stencilPipelineState=this._createPipeline(e,!0),this._createPipeline(e,!1)}_createPipeline(e,i){let{renderOccluded:r,output:s}=e,a=e.backfaceCullingEnabled&&!r;return qe({blending:r?Wl:null,culling:a?jp:null,depthTest:r?null:{func:Nt.LESS},depthWrite:r?null:Hw,colorWrite:je,stencilTest:i?qw(qp.IntegratedMeshMaskExcluded):null,drawBuffers:s===j.Depth?{buffers:[U1.NONE]}:null})}getPipeline(){return this.useStencil?this._stencilPipelineState:super.getPipeline()}},h0=new Map([[Et.POSITION,0],[Et.UV0,1],[Et.NORMALCOMPRESSED,2]]);var pf=class{constructor(){this.geometry=new of,this.intersectionData=null,this.geometryState=null,this._vao=null,this._texture=null,this._textureOpacity=1,this._textureRef=new vd(()=>this._tile.surface.fadeDuration),this.overlay=new cf,this._localOrigin=null,this._geometryStateChangedSinceLastUpdate=!0,this._hasGeometry=!1,this._modifiedFlags=0}get tile(){return this._tile}get localOrigin(){return this._localOrigin}init(e,i){this.clear(),this._tile=e,this.geometry.reset(),this.intersectionData=null,this.geometryState=new hf,this._localOrigin=i,this.overlay.clear()}clear(){this.releaseGeometry(),this.releaseTexture(),this._textureRef.clear(),this._tile=null,this.intersectionData=null,this.geometryState=null}updateGeometryIfNeeded(e){if((!this._vao||this._geometryStateChangedSinceLastUpdate||this.wireframeChanged||this.clippingAreaChanged||this.samplerDataChanged||this.numVerticesPerSideChanged||this.dirtyCorners||this.dirtyEdgeResolutions||this.dirtyEdges)&&(this._updateGeometry(e),this._geometryStateChangedSinceLastUpdate=!1),oi&&this.tile.intersectsClippingArea)for(let i=0;i<4;++i)V(this.geometry.getEdgeCount(i)===this.geometryState.edgeResolutions[i]+1)}_calculateEdgeResolution(e,i){let r=this.tile,s=this.geometryState.numVerticesPerSide-1;if(!r.surface.isGlobal){let l=r.surface.extent;if(l!=null&&(e===0&&r.extent[3]>l[3]||e===1&&r.extent[2]>l[2]||e===2&&r.extent[1]<l[1]||e===3&&r.extent[0]<l[0]))return s}let a=r.level,n=Tr[e];if(!i)return V(r.surface?.rootTiles==null||r.surface.updatingRootTiles||!r.shouldHaveNeighbor(n)),s;if(i.loaded){let l=i,h=l.renderData.geometryState,d=a-l.level;if(V(d>=0),d===0){let f=h.numVerticesPerSide-1;return Math.max(f,s)}let m=2**d,u=h.edgeResolutions[(e+2)%4]/m;return Math.max(1,u)}V(!i.leaf);let o=s;return i.forAllSubtreeOnSide(nh(n),l=>l===r||(l.loaded?(o=Math.max(o,2**(l.level-a)),!0):(V(!l.leaf),!1))),o}updateNeighborData(){let e=this.tile;if(!e.intersectsClippingArea)return;let i=e.renderData.geometryState,r=n=>(n.loaded||n.level===e.level)&&n?.intersectsClippingArea,s=i.edgePeerNeighbors,a=i.edgePeerNeighborSamplerVersions;for(let n=0;n<4;++n){let o=e.findNeighborTile(Tr[n],r),l=uo(e,o),h=l?.renderData?.geometryState.samplerDataVersion??-1,d=s[n],m=l!==uo(e,d),u=a[n]!==h;oi&&o&&(V(e.level>=o.level),V(e.level-o.level<=ti)),s[n]=o,(m||u)&&(a[n]=h,this._markEdgeDirty(n));let f=i.edgeResolutions[n],g=this._calculateEdgeResolution(n,o);V(To(g)),V(g>=1),i.edgeResolutions[n]=g,f!==g&&this._markEdgeResolutionDirty(n)}for(let n=0;n<4;++n){let o=e.findNeighborTile(Vo[n],r);i.cornerPeerNeighbors[n]=o;let l=uo(e,s[n]),h=uo(e,s[(n+1)%4]),d=uo(e,o);Ys[n]=d,Ys[(n+1)%4]=h,Ys[(n+2)%4]=e,Ys[(n+3)%4]=l,V(Ys.some(g=>g?.loaded||g===e));let m=Ys.reduce((g,y)=>Math.min(g,y?.level??1/0),1/0);Ys.forEach((g,y)=>{g&&g?.level>m&&(Ys[y]=null)}),V(Ys.some(g=>g?.loaded||g===e));let u=i.cornerNeighborCornerTiles,f=i.cornerNeighborCornerTileSamplerVersions;for(let g=0;g<4;++g){let y=Ys[g],v=y?.renderData.geometryState.samplerDataVersion??-1,w=4*n+g,b=u[w]!==y,R=!b&&f[w]!==v;(b||R)&&(u[w]=y,f[w]=v,this._markCornerDirty(n))}oi&&V(mf.some(g=>u[4*n+g]?.loaded||u[4*n+g]===e))}oi&&V(this.geometryState.edgeResolutions.every(n=>n>0));for(let n=0;n<4;++n)Ys[n]=null}_updateGeometry(e){if(!this.tile.intersectsClippingArea)return;oi&&V(!this.tile.intersectsClippingArea||this.geometryState.edgeResolutions.every(f=>f>0)),this.intersectionData=null;let{tile:i,_vao:r,geometry:s,geometryState:a}=this,n=!r||this.wireframeChanged||this.samplerDataChanged||this.clippingAreaChanged||this.numVerticesPerSideChanged,o=this.dirtyEdgeResolutions!==0,l=a.edgeResolutions.reduce((f,g)=>f+g+1,0),h=n||o&&l>(s?.maxEdgeVertexCount??0),d=!h&&o,m=!d&&(this.dirtyEdges!==0||o),u=!m&&this.dirtyCorners!==0;h?(this.releaseGeometry(),this._createGeometry(e)):d?i.updateEdgeElevationsAndResolutions():m||u?i.updateEdgeElevations():u?i.updateCornerElevations():console.warn("Update for no reason?"),this._modifiedFlags=0}get hasGeometry(){return this._hasGeometry}releaseGeometry(){return this._hasGeometry=!1,this.intersectionData=null,!!this._vao&&(this._vao=ge(this._vao),this.geometry.release(),!0)}ensureTexture(e,i,r,s){let a=i?St.RGBA:St.RGB;return this._texture!=null&&(r===Ct.FADING&&this._tile.surface.fadeDuration>0&&this._isTextureVisible(this._texture)||this._texture.descriptor.width!==e||this._texture.descriptor.pixelFormat!==a)&&this.releaseTexture(),this._texture==null&&(this._texture=s(),this.tile.setMemoryDirty()),this._texture}releaseTexture(){this._texture!=null&&(this._texture.release(),this._texture=null,this.tile.setMemoryDirty())}reuseTexture(e,i){return!(!e||!this._texture)&&(e.setTextureReference(new mo(this._texture,Ct.FADING,i,this._textureOpacity,0,1)),!0)}get numVerticesPerSideChanged(){return!!(this._modifiedFlags&iO)}get samplerDataChanged(){return!!(this._modifiedFlags&rO)}get clippingAreaChanged(){return!!(this._modifiedFlags&sO)}get wireframeChanged(){return!!(this._modifiedFlags&aO)}get dirtyEdges(){return this._modifiedFlags>>c0&15}get dirtyCorners(){return this._modifiedFlags>>d0&15}get dirtyEdgeResolutions(){return this._modifiedFlags>>p0&15}_markCornerDirty(e){let i=1<<e<<d0;this._modifiedFlags|=i}_markEdgeDirty(e){let i=1<<e<<c0;this._modifiedFlags|=i,this._markCornerDirty((e+0)%4),this._markCornerDirty((e+3)%4)}_markEdgeResolutionDirty(e){let i=1<<e<<p0;this._modifiedFlags|=i,this._markEdgeDirty(e)}_markAllEdgesAndCornersDirty(){this._modifiedFlags|=15<<d0|15<<c0|15<<p0}updateGeometryState(){let e=this._elevationInfo,i=this.tile,r=e.samplerData?i.getElevationVerticesPerSide(e.maxTileLevel):i.minimumVerticesPerSide,s=Math.max(r,5),a=i.clippingArea;i.intersectsClippingArea&&!i.withinClippingArea||(a=null);let n=this.geometryState,o=!1;n.numVerticesPerSide!==s&&(this._modifiedFlags|=1,n.numVerticesPerSide=s,n.samplerDataVersion++,o=!0),e.changed&&(this._modifiedFlags|=2,n.samplerData=e.samplerData,n.samplerDataVersion++,o=!0),np(n.clippingArea,a)||(this._modifiedFlags=4,n.clippingArea=a,o=!0);let l=i.surface.wireframe;return n.wireframe!==l&&(this._modifiedFlags=8,n.wireframe=l,o=!0),this._geometryStateChangedSinceLastUpdate||=o,o&&this._markAllEdgesAndCornersDirty(),this._hasGeometry=!0,this._geometryStateChangedSinceLastUpdate}_createGeometry(e){this.tile.createGeometry();let i=this.geometry.vertexAttributes,r=this.geometry.indices,s=e.gl;this._vao=new Lr(e,h0,new Map([["geometry",Ir(i.layout)]]),new Map([["geometry",wi.createVertex(e,s.STATIC_DRAW,i.buffer)]]),wi.createIndex(e,s.STATIC_DRAW,r)),this._hasGeometry=!0}get vao(){return this._vao}setTextureReference(e,i=Da.Immediate){e?.texture===this._texture?this._textureOpacity=e.opacities[0]:this.releaseTexture(),this._textureRef.push(e,i)}get textureReference(){return this._textureRef.current}get nextTextureReference(){return this._textureRef.next}get textureFadeFactor(){return this._textureRef.fadeFactor}get textureIsFading(){return this._textureRef.isFading}_isTextureVisible(e){return this._textureRef.current?.texture===e||this._textureRef.next?.texture===e&&this._textureRef.fadeFactor<1}get _elevationInfo(){let e=this.geometryState.samplerData,i=this.tile.layerInfo[_e.ELEVATION],r=i.length,s=new Array(r),a=0,n=0,o=!1;for(let d=0;d<r;d++){let m=i[d],u=m.upsampleInfo?.tile;if(u){let f=u.layerInfo[_e.ELEVATION][d].data,g=f&&f.samplerData;e&&e[a]===g||(o=!0),s[a++]=g,n=Math.max(n,u.lij[0])}else if(m.data){let f=this.tile.surface.layerViewByIndex(d,_e.ELEVATION);if(zs(this.tile,f)){let g=m.data;e&&e[a]===g.samplerData||(o=!0),s[a++]=g.samplerData,n=this.tile.level}}}e!=null&&e.length!==a&&(o=!0);let l=a>0,h=l?s:null;return l&&(s.length=a),{changed:o,samplerData:h,maxTileLevel:n}}get estimatedGeometryMemoryUsage(){let e=this.intersectionData?.estimatedMemoryUsage??0;return(this.geometry.indices?.byteLength??0)+(this.geometry.vertexAttributes?.byteLength??0)+e}get texture(){return this._texture}get test(){}checkGeometryWaterproofness(){if(!oi)return;let e=this.tile;if(!e.loaded||!e.intersectsClippingArea||e.level===0)return void V(e?.loaded);let i=e.surface.extent;if(i!=null&&!e.intersectsExtent(i))return;let r=Tr.map((o,l)=>i!=null&&(l<2?-1:1)*(e.extent[3-l]-i[3-l])<0),s=e.level;V(this.dirtyCorners===0),V(this.dirtyEdges===0),V(this.dirtyEdgeResolutions===0),V(!this.numVerticesPerSideChanged),V(!this.samplerDataChanged),V(!this.clippingAreaChanged),V(!this.wireframeChanged);let a=Vo.map(o=>e.findNeighborCornerTileExact(o,l=>!l.intersectsClippingArea||l.loaded||l.level===e.level)??null).map(o=>o?.intersectsClippingArea?o:null),n=this.geometryState;for(let o=0;o<4;++o){let l=n.cornerPeerNeighbors[o],h=a[o];V(h===l,`Tile[${e.lij}].corner[${o}] out of date: cur=[${l?.lij}] exp=[${h?.lij}]`)}Tr.forEach((o,l)=>{if(r[l])return;let h=e.findNeighborTile(o,Ee=>(Ee.level===s||Ee?.loaded)&&Ee?.intersectsClippingArea);if(!h){let Ee=!e.surface.updatingRootTiles&&e.surface.rootTiles!=null&&e.surface.rootTiles.length>0&&e.shouldHaveNeighbor(o);return void V(!Ee)}V(h.loaded||h.level===e.level),V(h===this.geometryState.edgePeerNeighbors[l]);let d=s-h.level;if(!h.loaded)return V(!h.leaf),void V(d===0);let m=h.renderData;V(e.isEdgeNeighbor(h,o)),V(d>=0);let u=2**d;if(d<0)return void V(!1);let f=e.renderData,g=f.geometry,y=f.localOrigin,v=g.getEdgeCount(l),w=g.numVerticesPerSide-1,b=m.geometry;if(!b)return void V(!1);let R=m.localOrigin,C=this.geometryState.edgePeerNeighbors[l];if(C?.loaded){let Ee=C.renderData;V(f.geometryState.edgePeerNeighborSamplerVersions[l]===Ee.geometryState.samplerDataVersion),V(this.geometryState.edgePeerNeighborSamplerVersions[l]===Ee.geometryState.samplerDataVersion)}let x=(l+2)%4,T=b.getEdgeCount(x),M=v-1,E=T-1;V(M*u===E,`Tile[${e.lij}]:e${l},res=${M} edgeRes mismatch with Neighbor[${h.lij}]:e${x},res=${E} (expected:${M*u})`);let O=e.extent,Z=o===gt.NORTH||o===gt.SOUTH,H=T-1,B=H>>d,X=v-1;if(B<1)return void V(X===1);V(B===X),V(To(B));let I=b.numVerticesPerSide-1;V(d>0||B===Math.max(I,w));let A=e.getNeighborEdgeStartVertexIndex(l,h);V(0<=A&&A<u);let re=A*B;V(0<=re&&re<=H-B);let U=0,W=re;g.getEdgeVertexPosition(l,Ia,y,0),g.getEdgeVertexPosition(l,La,y,v-1);let ve=It(Ia,La),ue=Math.max(tO,1e-4*ve);for(let Ee=0;Ee<=B;++Ee){g.getEdgeVertexPosition(l,Ia,y,U),b.getEdgeVertexPosition(x,La,R,W);let Be=Ee/B,Ye=Z?O[0]+Be*(O[2]-O[0]):o===gt.WEST?O[0]:O[2],Oe=Z?o===gt.SOUTH?O[1]:O[3]:O[1]+Be*(O[3]-O[1]),tt=e.surface.extent;if(tt==null||i1(tt,Ye,Oe)){let Ht=Ai(Ia,La),qt=vi(Ia)-ir.radius,ke=vi(La)-ir.radius,Me=Ht<ue;if(!Me){console.warn(`Tile edge vertex position mismatch: between [${e.lij}].edge${l}[${U}/${v}] and [${h.lij}].edge${x}[${W}/${T}]`),tt!=null&&console.warn("  surface extent= ",tt," x,y=",Ye,",",Oe);let ze=_();ae(ze,f.localOrigin,m.localOrigin),vi(ze)>0&&console.warn(`   localOrigins: ${f.localOrigin} vs ${m.localOrigin} d=${vi(ze)} [${ze}]`),(()=>{let D=Or(Ia),L=Or(La);e.updateEdgeElevations(),h.updateEdgeElevations(),g.getEdgeVertexPosition(l,Ia,y,U),b.getEdgeVertexPosition(x,La,R,W);let Q=_();bt(Q,Ia,D),vi(Q)>0&&console.warn(`  XXX Tile[${e.lij}] edge out of date: ${D} vs ${Ia} d=${vi(Q)} [${Q}]`),bt(Q,La,L),vi(Q)>0&&console.warn(`  XXX Neighbor[${h.lij}] edge out of date: ${L} vs ${La} d=${vi(Q)} [${Q}]`)})();let Te=g.getEdgeCount(l),F=b.getEdgeCount(T);V(Me,`Mismatch in tile [${e.lij}].edge[${l}][${U}/${Te}] vs neighbor [${h.lij}].edge[${x}][${W}/${F}] ${ma(Ia)} vs ${ma(La)}  dist=${Ht} h(t|n|d)=${qt}|${ke}|${ke-qt}`)}g.getEdgeNormal(l,Ih,U),b.getEdgeNormal(x,Lh,W),z($S,Ih),z(ZS,Lh);let ct=$($S,ZS),De=1-ct<.01||!1||e===h;if(!De){let ze=_();bt(ze,Ih,Lh);let Te=()=>`Mismatch in tile edge normal ${zg(e.lij)} (${U}/${v-1}) edge ${l} vs neighbor ${zg(h.lij)}  (${W}/${T-1}) nedge ${x} :${ma(Ih)} vs ${ma(Lh)}  dot = ${ct} : ${ma(ze)}`;console.warn("Mismatch in tile edge normal: ",Te());{e.updateEdgeElevations(),h.updateEdgeElevations();let F=_(),D=_();g.getEdgeNormal(l,F,U),b.getEdgeNormal(x,D,W),Tn(Ih,F)||console.warn("Missing update in tile normal: ",ma(Ih)," => ",ma(F)),Tn(Lh,D)||console.warn("Missing update in neighbor normal: ",ma(Lh)," => ",ma(D))}V(De,Te())}}U+=1,W+=1}})}},Ia=_(),La=_(),Ih=_(),Lh=_(),$S=_(),ZS=_(),tO=1,Ys=[null,null,null,null];function uo(t,e){return e?.loaded||e===t?e:null}var iO=1,rO=2,sO=4,aO=8,c0=4,d0=8,p0=12,mf=[0,1,2,3];var al=class{get updating(){return!!this._tileRequested}init(e,i,r,s){this.tile=e,this._layerIdx=i,this._layerClass=r,this._suspended=s,this._tileLayerInfo=e.getLayerInfo(i,r),this._tileRequested=null;let a=this._findAncestorWithData();this._setUpsampleTile(a)}startLoading(){return this._requestNext()}dispose(){this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null),this.tile=null,this._tileLayerInfo=null}setSuspension(e){e!==this._suspended&&(this._suspended=e,e?this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null):this._tileLayerInfo.data||this.update())}update(){let e=this._findAncestorWithData();return this._setUpsampleTile(e),this._requestNext()}dataArrived(e,i){this._setUpsampleTile(e,i),this._tileRequested=null,e===this.tile?this.tile.updateRenderData(this._layerClass,Ct.FADING,i):this._requestNext()}dataMissing(){this._tileRequested=null,this._tileLayerInfo.data=null,this._requestNext()}_agentDone(){this.tile.agentDone(this._layerIdx,this._layerClass),this.dispose()}_requestNext(){if(this._suspended)return!0;let e=this._findNextDownload();if(this._tileRequested){if(e===this._tileRequested)return!0;this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null}return e!=null?e.requestLayerData(this._layerIdx,this._layerClass,this)&&(this._tileRequested=e):this._agentDone(),!!this._tileRequested}_findNextDownload(){let e=this._layerIdx,i=this._layerClass,r=this.tile.surface.layerViewByIndex(e,i),{minLevel:s,maxLevel:a}=r.dataLevelRange,n=this._desiredMinLevelDelta,o=this._progressiveLevelModulo+n,l=this._scaleRangeEnabled?zs:()=>!0,h=this.tile,d=h.level,m,u=this._tileLayerInfo.upsampleInfo,f=u?.tile?.level??-1,g=u!=null&&f-d>=n,y=lC(r),v=r.type==="vector-tile-3d"?r.schemaHelper:null;for(;h&&l(h,r)&&h.level>=s;){let w=h.level,b=d-w,R=h.layerInfo[i][e];if(R.data&&b>=n){(!g||w>f)&&this._setUpsampleTile(h),R.dataInvalidated&&(m=h);break}let C=v?.getLevelRowColumn(h.lij)??h.lij;if(y?.getAvailability(C[0],C[1],C[2])!=="unavailable"&&w<=a&&!R.data&&!R.dataMissing&&((!m||h.level===s||w%dm==0||d-m.level<n)&&(m=h),b>=o))break;h=h.parent}if(m!=null&&d-m.level<n)if(u)m=null;else{let w=this._findAncestorWithData();w!=null&&(this._setUpsampleTile(w),m=w.layerInfo[i][e].dataInvalidated?w:null)}return m}_findAncestorWithData(){let e=this.tile.elevationLevel,i=this._desiredMinLevelDelta,r;for(let s=this.tile;s;s=s.parent)if(s.hasLayerData(this._layerIdx,this._layerClass)){if(e-s.level>=i)return s;r=s}return r}_setUpsampleTile(e,i){this._tileLayerInfo.setUpsampleInfo(this.tile,e),this.tile.updateRenderData(this._layerClass,Ct.FADING,i)}get test(){}},m0=class extends al{constructor(){super(...arguments),this.type="none"}get _desiredMinLevelDelta(){throw YS}get _progressiveLevelModulo(){throw YS}dispose(){}},YS=new Error("Abstract method called on TileAgent"),Sr=new m0;var uf=class extends al{constructor(){super(...arguments),this.type="elevation",this._scaleRangeEnabled=!1}get _desiredMinLevelDelta(){return this.tile.elevationLevelDelta-(this.tile.elevationLevel-this.tile.level)}get _progressiveLevelModulo(){return 0}};function KS(t){return t.type==="elevation"}var ff=class extends al{constructor(){super(),this.type="map",this._scaleRangeEnabled=!0}get _desiredMinLevelDelta(){return 0}get _progressiveLevelModulo(){return dm}};function XS(t){return t.type==="map"}var Si;(function(t){t[t.INSIDE=0]="INSIDE",t[t.INTERSECTS=1]="INTERSECTS",t[t.OUTSIDE=2]="OUTSIDE"})(Si||(Si={}));var nl=class{constructor(){this.waitingAgents=new Xe,this.pendingUpdates=0}static acquire(e){let i=u0.acquire();return i._init(e),i}release(){this.dispose(),_f.delete(this),u0.release(this)}dispose(){this.loadingAgent=ge(this.loadingAgent),this.abortRequest(),this._unsetUpsampleInfo(),this.pendingUpdates=0,this._data=qn(this._data)}static prune(){u0.prune(0)}_init(e){this.waitingAgents.clear(),this._data=qn(this._data),this.dataMissing=!1,this.dataInvalidated=!1,this._unsetUpsampleInfo(),this.abortRequest(),this.loadingAgent=null,this.pendingUpdates=0,this._pool=e,this.elevationBounds=null}invalidateSourceData(){this.dataInvalidated=!0,this.dataMissing=!1,this._unsetUpsampleInfo()}abortRequest(){this.requestAbort=Ar(this.requestAbort),this.requestPromise=null}_unsetUpsampleInfo(){this.upsampleInfo&&(this.upsampleInfo.tile?.unrefMapData(),this._pool.release(this.upsampleInfo),this.upsampleInfo=null)}setUpsampleInfo(e,i){if(e!==i&&i!=null){if(this.upsampleInfo==null)this.upsampleInfo=this._pool.acquire();else{if(this.upsampleInfo.tile===i)return;this.upsampleInfo.tile?.unrefMapData()}i.refMapData(),pC(e,i,this.upsampleInfo)}else this._unsetUpsampleInfo()}get data(){return this._data}set data(e){qn(this._data),this._data=e}},u0=new rs(nl,null,()=>{}),_f=new Map;function JS(){_f.size>0&&(console.log(`${_f.size} live TilePerLayerInfo allocations:`),_f.forEach(t=>console.log(t,`
`)))}var se;(function(t){t[t.NONE=0]="NONE",t[t.SPLIT=1]="SPLIT",t[t.ELEVATION=2]="ELEVATION",t[t.MERGE=4]="MERGE",t[t.GEOMETRY=8]="GEOMETRY",t[t.TEXTURE_NOFADING=16]="TEXTURE_NOFADING",t[t.TEXTURE_FADING=32]="TEXTURE_FADING"})(se||(se={}));var nO=.1,fo=class{constructor(){this._lij=[0,0,0],this._children=[null,null,null,null],this._pendingUpdates=0,this.renderData=null,this._dirty=!0,this._previouslyRendered=!1,this.extent=kt(),this._elevationBoundsMin=NaN,this._elevationBoundsMax=0,this.layerInfo=[[],[]],this.extentInRadians=kt(),this.centerAtSeaLevel=_(),this._center=[_(),mi(),_()],this.up=l1(),this._withinClippingArea=!0,this._intersectsClippingArea=!0,this._maxTesselation=0,this._usedMemory=0,this._rasterTileMemory=0,this._vectorTileMemory=0,this._mapDataRefCount=0,this.screenDepth=0,this.renderOrder=0,this._edgeLen=0,this._edgeLen2=0,this._curvatureHeight=0,this.extentMidX=0,this.extentMidY=0,this.distanceToPOI=-1,this._lastPOI=_(),this.maxLevelDeltaNeighborCount=0,this.unmergableChildCount=0}get lij(){return this._lij}get elevationLevelDelta(){return this._surface.getElevationLevelDelta(this.level)}static prune(){g0.prune(0),y0.prune(0),nl.prune()}get _cached(){return!this.leaf&&this._mapDataRefCount<=0}get withinClippingArea(){return this._withinClippingArea}get intersectsClippingArea(){return this._intersectsClippingArea}get clippingArea(){return this._clippingArea}get parent(){return this._parent}get children(){return this._children}get surface(){return this._surface}get elevationBoundsMin(){return this._elevationBoundsMin}get elevationBoundsMax(){return this._elevationBoundsMax}get level(){return this._lij[0]}get key(){return`${this._lij[0]}/${this._lij[1]}/${this._lij[2]}`}get edgeLen(){return this._edgeLen}get radius(){return this._center[Wt.MIDDLE][3]}get visible(){return this._dirty&&this.computeVisibility(),this._visible}get frustumVisibility(){return this._dirty&&this.computeVisibility(),this._frustumVisibility}computeVisibility(){this._dirty=!1;let e=this.parent,i=e?.frustumVisibility??Si.INTERSECTS;this._frustumVisibility=i===Si.INSIDE?Si.INSIDE:i===Si.OUTSIDE?Si.OUTSIDE:this._calculateFrustumVisibility(this.surface.frustum);let r=this._frustumVisibility!==Si.OUTSIDE&&this._intersectsClippingArea;r!==this._visible&&(this._visible=r,this._surface.emit("tiles-visibility-changed"),this._surface.renderer.setDirty(),this.updateAgentSuspension())}get _loadable(){return this.visible||this._surface.view.state.fixedContentCamera}get rendered(){let e=!!this.renderData;return e!==this._previouslyRendered&&(this._surface.emit("tiles-visibility-changed"),this._previouslyRendered=e,this._surface.renderer.setDirty()),e}init(e,i,r,s,a){this._lij[0]=e,this._lij[1]=i,this._lij[2]=r,this.ellipsoid=Ue(a.tilingScheme.spatialReference),a.tilingScheme.getExtent(e,i,r,this.extent),a.tilingScheme.convertExtentToRadians(this.extent,this.extentInRadians),this.extentMidX=.5*(this.extent[0]+this.extent[2]),this.extentMidY=.5*(this.extent[1]+this.extent[3]),this._withinClippingArea=!0,this._intersectsClippingArea=!0,this._clippingArea=null,this._mapDataRefCount=0,a.upsampleMapCache.pop(this.key),this._edgeLen=0,this._edgeLen2=0,this._center[Wt.MIDDLE][3]=0,this.elevationLevel=e,s&&!Number.isNaN(s.elevationBoundsMin)?(this._elevationBoundsMin=s.elevationBoundsMin,this._elevationBoundsMax=s.elevationBoundsMax):(this._elevationBoundsMin=0,this._elevationBoundsMax=0),this._pendingUpdates=0,this.renderData=null,this.screenDepth=0,this._visible=!1,this._previouslyRendered=!1,this._parent=s,this.clearChildren(),this._surface=a,this.updateVisibility(),this.maxLevelDeltaNeighborCount=0,this.unmergableChildCount=0;for(let n of ho){let o=a.numLayers(n),l=this.layerInfo[n];for(let h of l)h.release();l.length=o;for(let h=0;h<o;h++)l[h]=nl.acquire(this._surface.upsampleInfoPool),n===_e.ELEVATION&&this.findElevationBoundsForLayer(h,-1)}this.computeElevationBounds(),this._maxTesselation=Math.min(a.tilingScheme.pixelSize,No)}dispose(){this._surface!=null&&(ci(!this.renderData,"tile.renderData was not unloaded"),this._surface.upsampleMapCache.pop(this.key),this.layerInfo.forEach(e=>{e.forEach(i=>i.release()),e.length=0}),this._surface=this._parent=null,this.clearChildren(),this.setMemoryDirty())}refMapData(){++this._mapDataRefCount,this._cached||this._surface.upsampleMapCache.pop(this.key)}unrefMapData(){--this._mapDataRefCount,this._cached&&this.cachedMemory>0&&this._surface.upsampleMapCache.put(this.key,this)}setMemoryDirty(){this._usedMemory=0}get usedMemory(){return this._ensureUsedMemory()+(this._cached?0:this._mapTileMemory)}get cachedMemory(){return this._ensureUsedMemory(),this._surface==null?this.usedMemory:this._cached?this._mapTileMemory:0}get _mapTileMemory(){return this._rasterTileMemory+this._vectorTileMemory}get _cpuImageMemorySize(){let i=this._surface.tilingScheme.pixelSize;return i*i*4}_ensureUsedMemory(){if(this._usedMemory>0)return this._vectorTileMemory=this.layerInfo[_e.MAP].reduce((e,{data:i})=>e+(th(i)?i.usedMemoryPerReference:0),0),this._usedMemory;this._usedMemory=this._baseUsedMemory,this._rasterTileMemory=0,this._vectorTileMemory=0;for(let{data:e}of this.layerInfo[_e.MAP])th(e)?this._vectorTileMemory+=e.usedMemoryPerReference:this._rasterTileMemory+=this.getTerrainDataMemory(e);for(let e of this.layerInfo[_e.ELEVATION])this._usedMemory+=e.data?this._cpuImageMemorySize:0;return this.renderData&&(this._usedMemory+=this.renderData.estimatedGeometryMemoryUsage,this._rasterTileMemory+=this.renderData.texture?.cachedMemory??0),this._cached&&this._surface.upsampleMapCache.updateSize(this.key,this),this._usedMemory}getUsedMemoryForLayer(e,i){let r=this.layerInfo[e][i];return r?.data?e===_e.MAP?this._cached?0:this.getTerrainDataMemory(r.data):e===_e.ELEVATION?this._cpuImageMemorySize:0:0}getTerrainDataMemory(e){return GT(e)?e.texture.usedMemory:kT(e)?e.memoryUsage:th(e)?e.usedMemoryPerReference:ih(e)||e instanceof HTMLImageElement?this._cpuImageMemorySize:0}updateScreenDepth(e){let i=this._center[Wt.MIDDLE],r=e,s=i[0],a=i[1],n=i[2],o=r[2]*s+r[6]*a+r[10]*n+r[14];this.screenDepth=o<0?0:o/(r[3]*s+r[7]*a+r[11]*n+r[15])}shouldSplit(e,i,r){if(!this.visible)return se.NONE;if(e.frustum&&(!this._intersectsClippingArea||this._calculateFrustumVisibility(e.frustum)===Si.OUTSIDE))return se.NONE;let s=this.level;ae(yf,this._center[Wt.MIDDLE],i);let a=Mi(yf),n=yf,o=this._center[Wt.MIDDLE];ae(f0,this._center[Wt.TOP],i);let l=Mi(f0);l<a&&(a=l,n=f0,o=this._center[Wt.TOP]),ae(_0,this._center[Wt.BOTTOM],i);let h=Mi(_0);if(h<a&&(a=h,n=_0,o=this._center[Wt.BOTTOM]),this._edgeLen2>a&&s<e.maxLod)return se.SPLIT;let d=Math.sqrt(a),m=e.fovX*d*2,u=this._edgeLen/m,f=()=>{if(s<e.maxLod)return this.elevationLevel=s,se.NONE;let M=s+Math.ceil(-Math.log2(e.relativeWidthLimit/u));return M!==this.elevationLevel?(this.elevationLevel=M,se.ELEVATION):se.NONE},g=r!=null?r-s:1/0;if(g<=.5)return f();let y=$(this.up,yf),v=this._elevationBoundsMax-this._elevationBoundsMin,w=v/this.edgeLen;if(e.aboveGround&&y>0&&w<.001&&y/d-Math.sin(this._curvatureHeight/(this.edgeLen*Math.SQRT1_2)*Math.PI)-w>0)return se.NONE;let b=r!=null?3-Math.min(g,2):1;if(u*b<e.relativeWidthLimit||s>=e.maxLod)return f();if(s<7)return se.SPLIT;k(Oi,this.up,y),ae(Oi,Oi,n);let R=Mi(Oi);if(R<=this.radius*this.radius)return se.SPLIT;k(Oi,Oi,this.radius/Math.sqrt(R)),K(Oi,Oi,o),ae(Oi,i,Oi);let C=Math.min(1,(Math.abs($(Oi,this.up))+.5*v+this._curvatureHeight)/ne(Oi)),x=nO/e.angledSplitBias,T=e.fovY*d*2;return C*(this._edgeLen/T*b)<x*e.relativeHeightLimit?se.NONE:se.SPLIT}createChildren(){let e=this._children,i=this.lij[0]+1,r=2*this.lij[1],s=2*this.lij[2];return e[0]=this.surface.createTile(i,r,s,this),e[1]=this.surface.createTile(i,r,s+1,this),e[2]=this.surface.createTile(i,r+1,s,this),e[3]=this.surface.createTile(i,r+1,s+1,this),e}clearChildren(){this._children[0]=this._children[1]=this._children[2]=this._children[3]=null}get loaded(){return this.renderData?.hasGeometry??!1}load(){this.refMapData();for(let e of ho)this._createOrUpdateAgents(0,e);this.surface.renderer.loadTile(this)}unload(){this.renderData&&this.unrefMapData(),this.surface.renderer.unloadTile(this);for(let e of ho){let i=this.layerInfo[e];for(let r of i)r.loadingAgent&&r.loadingAgent!==Sr&&(gf(r.loadingAgent),r.loadingAgent=null),r.pendingUpdates=0}this.resetPendingUpdate(se.GEOMETRY),this.resetPendingUpdate(se.TEXTURE_NOFADING),this.resetPendingUpdate(se.TEXTURE_FADING)}unloadMapData(){let e=this.layerInfo[_e.MAP];for(let i of e)i.loadingAgent&&i.loadingAgent!==Sr&&(gf(i.loadingAgent),i.loadingAgent=null),i.pendingUpdates=0,i.invalidateSourceData();this.renderData&&this.renderData.releaseTexture(),this.setMemoryDirty()}updateClippingStatus(e){if(Ds(e,this._clippingArea))return!1;let i=this._intersectsClippingArea,r=this._withinClippingArea;e!=null?(this._intersectsClippingArea=this.intersectsExtent(e),this._withinClippingArea=this._isWithinExtent(e)):(this._intersectsClippingArea=!0,this._withinClippingArea=!0),this._clippingArea=e,this.updateVisibility();let s=r&&this._withinClippingArea,a=!(r||i||this._withinClippingArea||this._intersectsClippingArea);return!this.renderData||s||a||this.setPendingUpdate(se.GEOMETRY),!0}updateVisibility(){this._dirty=!0,this._surface.setTileTreeDirty()}getLayerInfo(e,i){return this.layerInfo[i][e]}hasLayerData(e,i){let r=this.layerInfo[i][e];return!(!r?.data||r.dataInvalidated)}get updating(){if(this.hasPendingUpdates)return!0;for(let e of ho){let i=this.layerInfo[e];for(let r of i)if(r.loadingAgent&&r.loadingAgent!==Sr&&r.loadingAgent.updating)return!0}return!1}_isSuspended(e){return!!this.hasPendingUpdate(se.SPLIT)||e!==_e.ELEVATION&&!this._loadable}get hasPendingUpdates(){return this._pendingUpdates!==0}hasPendingUpdate(e){return(this._pendingUpdates&e)===e}setPendingUpdate(e){let i=this._pendingUpdates;return this._pendingUpdates|=e,e===se.SPLIT||e===se.MERGE?this._surface.setTileTreeDirty():this._surface.requestUpdate(),i!==this._pendingUpdates}resetPendingUpdate(e){return!!this.hasPendingUpdate(e)&&(this._pendingUpdates&=~e,!0)}requestLayerData(e,i,r){let s=this.layerInfo[i][e];if(s.waitingAgents.has(r))return console.warn("agent already requested this piece of map data (tile %s, agent tile %s, layer: %d/%d)",this._lij.toString(),r.tile.lij.toString(),i,e),!0;if(s.waitingAgents.push(r),s.data&&!s.dataInvalidated){console.warn("agent requested existing data (tile %s, agent tile %s, layer: %d/%d)",this._lij.toString(),r.tile.lij.toString(),i,e);let o=th(s.data);return r.dataArrived(this,o),!0}if(s.requestPromise)return!0;Ar(s.requestAbort),s.requestAbort=new AbortController;let a=this._surface.requestTileData(this,e,i,s.requestAbort);if(!a)return s.requestAbort=null,!1;let n=()=>{s.requestPromise===a&&(s.requestPromise=null,s.requestAbort=null)};return s.requestPromise=a,a.then(n,n),!0}get leaf(){return this._children[0]==null}hasLij(e){return this._lij[0]===e[0]&&this._lij[1]===e[1]&&this._lij[2]===e[2]}findByLij(e){if(this.hasLij(e))return this;let i=this._children;return i[0]?i[0].findByLij(e)||i[1].findByLij(e)||i[2].findByLij(e)||i[3].findByLij(e):null}distanceToSquared(e){return Mi(ae(Oi,this._center[Wt.MIDDLE],e))}containsPoint(e){let i=this.extent;return e[0]>=i[0]&&e[1]>=i[1]&&e[0]<=i[2]&&e[1]<=i[3]}containsPointXY(e,i){let r=this.extent;return e>=r[0]&&i>=r[1]&&e<=r[2]&&i<=r[3]}unrequestLayerData(e,i,r){let s=this.layerInfo[i][e],a=s.waitingAgents,n=a.removeUnordered(r)!=null;ci(n,"agent has not requested this piece of map data"),a.length<1&&(s.abortRequest(),this.setMemoryDirty())}dataArrived(e,i,r){let s=th(r),a=this.layerInfo[i][e];a.data=r,a.dataInvalidated=!1,a.waitingAgents.forAll(n=>n.dataArrived(this,s)),a.waitingAgents.clear(),this.setMemoryDirty()}dataMissing(e,i){let r=this.layerInfo[i][e];r.dataMissing=!0,r.waitingAgents.forAll(s=>s.dataMissing()),r.waitingAgents.clear(),this.setMemoryDirty()}updateRenderData(e,i,r){switch(r&&this.forEachLoadedNeighbor(s=>s.updateRenderData(e,i)),e){case _e.MAP:return this._updateTexture(i);case _e.ELEVATION:return this._updateGeometry()}}_updateTexture(e){this.renderData&&(this.resetPendingUpdate(e===Ct.FADING?se.TEXTURE_NOFADING:se.TEXTURE_FADING),this.setPendingUpdate(e===Ct.FADING?se.TEXTURE_FADING:se.TEXTURE_NOFADING))}_updateGeometry(){this.setPendingUpdate(se.GEOMETRY);for(let e of this.layerInfo[_e.ELEVATION])e.pendingUpdates|=se.GEOMETRY}invalidateLayerData(e,i){this.layerInfo[i][e].invalidateSourceData(),this.restartAgents(i)}computeElevationBounds(){let e=this._elevationBoundsMin,i=this._elevationBoundsMax,r=1/0,s=-1/0,a=this.layerInfo[_e.ELEVATION],n=!0;for(let o of a)o.elevationBounds!=null&&(r=Math.min(r,o.elevationBounds.min),s=Math.max(s,o.elevationBounds.max),o.elevationBounds.hasNoDataValues||(n=!1));n&&(r=Math.min(r,0),s=Math.max(s,0)),e===r&&i===s||(this._elevationBoundsMin=r,this._elevationBoundsMax=s,this.updateRadiusAndCenter(),this._surface.setTileTreeDirty())}_updateCenter(){let e=this._elevationBoundsMin,i=this._elevationBoundsMax,r=.5*(e+i),s=this._center;k(Oi,this.up,r),K(s[Wt.MIDDLE],this.centerAtSeaLevel,Oi),k(Oi,this.up,e),K(s[Wt.TOP],this.centerAtSeaLevel,Oi),k(Oi,this.up,i),K(s[Wt.BOTTOM],this.centerAtSeaLevel,Oi)}findElevationBoundsForLayer(e,i){let r=this.layerInfo[_e.ELEVATION][e],s=this.elevationLevelDelta,a=Math.max(this.elevationLevel-s,0),n=r.elevationBounds;if(n!=null&&n.level>=i&&n.level<=a)return;let o=this._surface.layerViewByIndex(e,_e.ELEVATION);if(!zs(this,o))return;let l=lO,h=!1,d=r.data;if(d&&d.level<=a){let m=r.data;l.min=m.samplerData.data.minValue,l.max=m.samplerData.data.maxValue,l.hasNoDataValues=m.samplerData.data.hasNoDataValues,l.level=this.level,h=!0}else{let m,u,f=0;for(let g=this._parent;g&&(!u||f<s)&&(f=this.elevationLevel-g.level,m=u||m,u=g.layerInfo[_e.ELEVATION][e].data,!(!u&&m&&g.level<=a));g=g.parent);u=u||m,u&&(u.computeMinMaxValue(this._lij[0],this._lij[1],this._lij[2],l),l.min!==1/0&&(l.level=u.level,h=!0))}h&&(r.elevationBounds==null&&(r.elevationBounds=new Aa),r.elevationBounds.copyFrom(l))}modifyLayers(e,i,r){let s=this.layerInfo[r];for(let o of s)o.loadingAgent&&o.loadingAgent!==Sr&&(gf(o.loadingAgent),o.loadingAgent=null),o.waitingAgents.clear();for(let o=0;o<s.length;++o)e[o]===void 0&&s[o].release();let a=new Array(...s),n=i.length;s.length=n;for(let o=0;o<n;o++){let l=i[o];s[o]=l>-1?a[l]:nl.acquire(this._surface.upsampleInfoPool)}this.setMemoryDirty()}restartAgents(e){this.renderData&&(this._createOrUpdateAgents(0,e),this.updateRenderData(e,Ct.FADING))}updateAgents(e){if(this.renderData){let i=this.layerInfo[e];for(let r of i)r.loadingAgent===Sr&&(r.loadingAgent=null);this._createOrUpdateAgents(0,e)}}updateAgentSuspension(){for(let e of ho){let i=this._isSuspended(e);for(let r of this.layerInfo[e])r.loadingAgent&&r.loadingAgent!==Sr&&(r.loadingAgent.setSuspension(i),r.loadingAgent===Sr&&this.updateRenderData(e,Ct.FADING))}}removeLayerAgent(e,i){let r=this.layerInfo[i][e];r.loadingAgent&&r.loadingAgent!==Sr&&r.loadingAgent.dispose(),r.loadingAgent=null}agentDone(e,i){let r=this.layerInfo[i][e];r.loadingAgent=Sr,r.data||r.upsampleInfo!=null||this._createOrUpdateAgents(e+1,i)}_hasBlendableAncestor(e){return e.blendMode!=="normal"||vn(e.parent)&&this._hasBlendableAncestor(e.parent)}_hasBlendModes(e,i,r){for(let s=e;s<i;++s){let a=this._surface.layerViewByIndex(s,r);if(Hn(a)&&a?.layer?.blendMode!=="normal"||vn(a?.layer?.parent)&&this._hasBlendableAncestor(a?.layer?.parent))return!0}return!1}_createOrUpdateAgents(e,i){let r=this.layerInfo[i];if(r.length===0)return;let s=this._isSuspended(i);for(let a=e;a<r.length;++a){let n=r[a],o=this._surface.layerViewByIndex(a,i),l=!1;if(n.loadingAgent?zs(this,o)?(n.loadingAgent!==Sr&&n.loadingAgent.setSuspension(s),n.loadingAgent!==Sr&&(l=n.loadingAgent.update())):n.dispose():zs(this,o)&&(n.loadingAgent=oO(this,a,i,s),l=n.loadingAgent.startLoading(),l?n.loadingAgent===Sr&&this.setPendingUpdate(se.GEOMETRY):(gf(n.loadingAgent),n.loadingAgent=Sr)),n.loadingAgent===Sr&&this.updateRenderData(i,Ct.FADING),!this._hasBlendModes(e,r.length,i)&&l&&o.isOpaque)return}}_isWithinExtent(e){let i=this.extent;return i[0]>=e[0]&&e[2]>=i[2]&&i[1]>=e[1]&&e[3]>=i[3]}intersectsExtent(e){let i=this.extent;return i[2]>=e[0]&&e[2]>=i[0]&&i[3]>=e[1]&&e[3]>=i[1]}getElevationVerticesPerSide(e){let i=this.elevationLevel-this.level,r=Math.max(this.level-e,this.elevationLevelDelta-i),s=N(1+(this._maxTesselation>>r),2,this._maxTesselation+1),a=this.minimumVerticesPerSide;return Math.max(s,a)}_findLIJ(e,i){if(!e)return null;let r=this.surface.rootTiles;if(r!=null){for(let s of r)if(hO(s,e)){let a=s,n=e[0]-a.level-1;for(;n>=0&&!a.leaf&&!i(a);){let o=e[1]>>n&1,l=e[2]>>n&1;a=a.children[2*o+l],n--}return i(a)?a:null}}return null}findNeighborTile(e,i){let r=this._lij,s=this._getNeighborLIJ(r,e);return s?wd(r,s)?i(this)?this:null:this._findLIJ(s,i):null}findCorner(e,i){let r=e===gt.NORTH_EAST?1:e===gt.NORTH_WEST?0:e===gt.SOUTH_WEST?2:3,s=this;for(;s.children[0]&&(!i||!i(s));)s=s.children[r];return s}findNeighborCornerTileExact(e,i){return this.findNeighborTile(e,r=>i(r)||r.level===this.level)?.findCorner(ah(e),i)||null}forAllSubtreeOnSide(e,i){let r=e===gt.NORTH?[0,1]:e===gt.NORTH_EAST?[1]:e===gt.EAST?[1,3]:e===gt.SOUTH_EAST?[3]:e===gt.SOUTH?[2,3]:e===gt.SOUTH_WEST?[2]:e===gt.WEST?[0,2]:[0],s=a=>{let n=a.children;!i(a)&&n[0]&&r.forEach(o=>s(n[o]))};s(this)}getNeighborEdgeStartVertexIndex(e,i){if(!i)return 0;let r=this.level-i.level;if(V(!oi||r>=0),r===0)return 0;let s=2**r,a=!(1&~e),n=a?0:1,o=i.lij[n+1]*s,l=this._lij[n+1],h=l-o,d=a?s-1-h:h;return oi&&(V(o<=l&&l<o+s),V(0<=d&&d<s)),d}forEachLoadedNeighbor(e){let i=this.level,r=s=>s.level===i||s.loaded;Tr.forEach(s=>{let a=this.findNeighborTile(s,r);a!=null&&a!==this&&a.forAllSubtreeOnSide(nh(s),n=>!!n.loaded&&(e(n,s),!0))}),Vo.forEach(s=>{let a=this.findNeighborTile(s,r)?.findCorner(ah(s),n=>n.loaded);V(!a||vf(this,a,s)),a?.loaded&&e(a,s)})}_getNeighborLIJ(e,i){let r=$g(i)?-1:Qg(i)?1:0,s=jg(i)?-1:Wg(i)?1:0,a=[e[0],e[1]+r,e[2]+s];return a[1]<0?null:this.surface.isGlobal?this._wrapLIJ(a):a[2]<0?null:a}_wrapLIJ(e){return!e||e[1]<0||e[1]>=2**e[0]?null:this.surface.wrapEastWest(e)}isEdgeNeighbor(e,i){if(e==null)return!1;if(this.level===0&&e.level===0&&(this._eastEnd&&e._westEnd&&i===gt.EAST||this._westEnd&&e._eastEnd&&i===gt.WEST))return!0;let r=Math.max(1e-6*(this.extent[2]-this.extent[0]),1);switch(i){case gt.NORTH:return br(this.extent[3],e.extent[1],r);case gt.SOUTH:return br(this.extent[1],e.extent[3],r);case gt.EAST:return br(this.extent[2],e.extent[0],r)||br(this.extent[2],-e.extent[0],r);case gt.WEST:return br(this.extent[0],e.extent[2],r)||br(this.extent[0],-e.extent[2],r)}}get _eastEnd(){return this._lij[2]===this.surface.lijEastEnd(this.level)-1}get _westEnd(){return this._lij[2]===0}checkGeometryWaterproofness(){Nc&&(V(this.loaded),this.renderData?.checkGeometryWaterproofness())}shouldHaveNeighbor(e){let i=this.extent,r=this.surface.rootTilesExtent,s=.25*(i[2]-i[0]);if($g(e)&&i[3]+s>=r[3]||Qg(e)&&i[1]-s<=r[1])return!1;let a=this.surface.isGlobal;return!(!a&&jg(e)&&i[0]-s<=r[0])&&!(!a&&Wg(e)&&i[2]+s>=r[2])}updateDistanceToPOI(e){let i=this._lastPOI;if(this.distanceToPOI>=0&&i[0]===e[0]&&i[1]===e[1]&&i[2]===e[2])return;q(this._lastPOI,e);let r=this._center[Wt.MIDDLE],s=e[0]-r[0],a=e[1]-r[1],n=e[2]-r[2];this.distanceToPOI=s*s+a*a+n*n}};function oO(t,e,i,r){let s=i===_e.ELEVATION?y0.acquire():g0.acquire();return s.init(t,e,i,r),s}function gf(t){t.dispose(),KS(t)?y0.release(t):XS(t)&&g0.release(t)}var g0=new rs(ff),y0=new rs(uf),lO=new Aa,Wt;function hO(t,e){let i=t.lij,r=e[0]-i[0];return!(r<0)&&e[1]>>r===i[1]&&e[2]>>r===i[2]}function wd(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]}function vf(t,e,i){return t!=null&&e!=null&&e!==t&&(t.level>=e.level?eR(t,e,i):eR(e,t,ah(i)))}function eR(t,e,i){V(t.level>=e.level);let r=eC(i),s=tC(i),a=t.extent,n=e.extent,o=[r?a[0]:a[2],s?a[3]:a[1]],l=[r?n[2]:n[0],s?n[1]:n[3]],h=1e-5*(a[2]-a[0]),d=br(o[0],l[0],h)||t.surface.isGlobal&&br(o[0],-l[0],h),m=br(o[1],l[1],h);if(d&&m)return!0;if(t.level===e.level)return V(!1),!1;if(!d&&!m)return V(!1),!1;let u=d?tR(n[1],n[3],a[1],a[3],h):tR(n[0],n[2],a[0],a[2],h);return V(u),u}function tR(t,e,i,r,s){return t-s<=i&&i<=r&&r<=e+s}(function(t){t[t.TOP=0]="TOP",t[t.MIDDLE=1]="MIDDLE",t[t.BOTTOM=2]="BOTTOM"})(Wt||(Wt={}));var yf=_(),f0=_(),_0=_(),Oi=_();var cO=65536;function iR(t,e){let{tile:i,geometry:r,geometryState:s}=t,{extentInRadians:a,surface:n}=i,{isWebMercator:o,renderer:l}=n,{numVerticesPerSide:h,wireframe:d}=s,m=h-1,u=(h-2)**2,f=o&&(e===us.HAS_SOUTH_POLE||e===us.HAS_BOTH_POLES),g=o&&(e===us.HAS_NORTH_POLE||e===us.HAS_BOTH_POLES),y=((f?1:0)+(g?1:0))*wf*h,v=xR(s),w=u+y+4*v,b=l.tileGeometryCache.acquire(w);r.numVerticesPerSide=h,r.vertexAttributes=b,r.maxEdgeVertexCount=v;let{boundingBox:R}=r;Ol(R);let C=T0(t);Di.update(m,a,C),pO(t),r.poleVerticesStartIndex=u;let x=dO(t,f,g);r.edgeVerticesStartIndex=u+y,x0(t),b0(t),_R(r,x,d),t.intersectionData=null}function dO(t,e,i){let{tile:r,localOrigin:s,geometry:a}=t,{extent:n,ellipsoid:o}=r,{boundingBox:l,numVerticesPerSide:h,vertexAttributes:d,poleVerticesStartIndex:m}=a,u=h-1,f=s[0],g=s[1],y=s[2],v=o.radius,w=n[1],b=n[3],R=[],C=m,x=(T,M)=>{let E=M*h;Ps(-f,-g,T*v-y,l),R.push(new w0(T===1,E,T===1?0:2,C,wf));let O=lR(T===-1?w:b,v),Z=T*Math.PI/2-O,H=.99*(T===1?1:-1),B=v+0,{position:X,uv0:I}=d,{typedBuffer:A,typedBufferStride:re}=d.normalCompressed;for(let U=1;U<=wf;++U){let W=O+Z*(U/wf),ve=Math.cos(W),ue=Math.sin(W);for(let Ee=0;Ee<=u;Ee++){let Be=Ee/u,Ye=Di.sinLonLUT[Ee],Oe=Di.cosLonLUT[Ee]*ve,tt=Ye*ve,Ht=ue,qt=Oe*B-f,ke=tt*B-g,Me=Ht*B-y;Ps(qt,ke,Me,l),X.setValues(C,qt,ke,Me),Rs(I,C,Be,H),Ao(A,C,Oe,tt,Ht,re),++C}}};return e&&x(-1,0),i&&x(1,u),R}function pO(t){let{tile:e}=t;if(!e.intersectsClippingArea)return;let{geometry:i,geometryState:r,localOrigin:s}=t,{numVerticesPerSide:a,samplerData:n}=r,o=a-2,l=a-1,{vertexAttributes:h,boundingBox:d}=i,m=h.position,u=h.uv0,{typedBuffer:f,typedBufferStride:g}=h.normalCompressed,{extent:y}=e,v=y[0],w=y[2],b=y[1],R=y[3],C=e.ellipsoid.radius,x=s[0],T=s[1],M=s[2],E=m.typedBuffer,O=m.typedBufferStride,Z=1/l,H=0;if(1<=o){let B=Z,X=b*(1-B)+R*B,I=Di.sinLatLUT[1],A=Di.cosLatLUT[1];for(let re=1;re<=o;re++){let U=re*Z,W=v*(1-U)+w*U,ve=Di.sinLonLUT[re],ue=Di.cosLonLUT[re],Ee=C+Mt(W,X,n),Be=Ee*ue*A-x,Ye=Ee*ve*A-T,Oe=Ee*I-M;Ps(Be,Ye,Oe,d);let tt=(re-1)*O;E[tt]=Be,E[tt+1]=Ye,E[tt+2]=Oe,Rs(u,re-1,U,B)}}for(let B=1;B<=o;B++){let X=B*Z,I=b*(1-X)+R*X,A=Di.sinLatLUT[B],re=Di.cosLatLUT[B],U=B+1,W=U*Z,ve=b*(1-W)+R*W,ue=Di.sinLatLUT[U],Ee=Di.cosLatLUT[U],Be=Di.sinLonLUT[0],Ye=Di.cosLonLUT[0],Oe=C+Mt(v,I,n),tt=Ye*re*Oe-x,Ht=Be*re*Oe-T,qt=A*Oe-M,ke=H*O,Me=E[ke],ct=E[ke+1],De=E[ke+2];for(let ze=1;ze<=o;ze++){let Te=ze*Z,F=v*(1-Te)+w*Te,D=Di.sinLonLUT[ze],L=Di.cosLonLUT[ze],Q=0,ce=0,de=0;if(ze<o){let dt=(H+1)*O;Q=E[dt],ce=E[dt+1],de=E[dt+2]}else{let dt=Di.sinLonLUT[l],Qt=Di.cosLonLUT[l],ii=C+Mt(w,I,n);Q=Qt*re*ii-x,ce=dt*re*ii-T,de=A*ii-M}let Ge=tt,fe=Ht,J=qt;tt=Me,Ht=ct,qt=De,Me=Q,ct=ce,De=de;let ee=Q-Ge,Ce=ce-fe,Fe=de-J,vt=0,wt=0,it=0;if(B>1){let dt=(H-o)*O;vt=E[dt],wt=E[dt+1],it=E[dt+2]}else{let dt=Di.sinLatLUT[0],Qt=Di.cosLatLUT[0],ii=C+Mt(F,b,n);vt=L*Qt*ii-x,wt=D*Qt*ii-T,it=dt*ii-M}let st=C+Mt(F,ve,n),yt=L*Ee*st-x,We=D*Ee*st-T,Ke=ue*st-M;if(B<o){let dt=H+o,Qt=dt*O;E[Qt]=yt,E[Qt+1]=We,E[Qt+2]=Ke,Ps(yt,We,Ke,d),Rs(u,dt,Te,W)}let be=vt-yt,Je=wt-We,Ve=it-Ke,at=L*re,nt=D*re,Dt=A;Dt*Dt<.999&&(at=Fe*Je-Ce*Ve,nt=ee*Ve-Fe*be,Dt=Ce*be-ee*Je);let ot=1/Math.sqrt(at*at+nt*nt+Dt*Dt);Ao(f,H,at*ot,nt*ot,Dt*ot,g),++H}}}function rR(t){t.tile.intersectsClippingArea&&(b0(t),Vh(t),t.intersectionData=null)}function sR(t){t.tile.intersectsClippingArea&&(vR(t),b0(t),Vh(t),TR(t),t.intersectionData=null)}function aR(t){t.tile.intersectsClippingArea&&(oR(t),nR(t,!0),Vh(t),t.intersectionData=null)}function b0(t){t.tile.intersectsClippingArea&&(oR(t),nR(t))}function nR(t,e=!1){let{geometry:i,geometryState:r,tile:s,localOrigin:a}=t,{level:n,extent:o,extentInRadians:l,ellipsoid:h}=s,d=h.radius,m=l[0],u=l[2],f=l[1],g=l[3],{samplerData:y}=r,v=o[0],w=o[2],b=o[1],R=o[3],C=T0(t),{boundingBox:x,vertexAttributes:T}=i,M=a[0],E=a[1],O=a[2],Z=T.position,H=Z.typedBuffer,B=Z.typedBufferStride,X=T.uv0;for(let I=0;I<4;++I){let A=I===1||I===3,re=r.edgeResolutions[I];V(To(re));let U=re+1,W=uo(s,r.edgePeerNeighbors[I]);if(CR(s,W,I)){wR(t,I,W);continue}let ve=W!=null;V(!ve||W.level===s.level),V(!ve||_s(s,W)<=0);let ue=W?.renderData,Ee=ue?.geometryState;if(oi){let ee=s.surface;if(!W&&ee&&!ee.updatingRootTiles){let Ce=Tr[I],Fe=s.findNeighborTile(Ce,vt=>vt.loaded||vt.leaf||vt.level===s.level);Fe?Fe.intersectsClippingArea&&(V(!Fe.loaded),V(!Fe.leaf),V(Fe.level===n)):V(ee?.rootTiles==null||!s.shouldHaveNeighbor(Ce))}}let Be=I===1?o[2]:o[0],Ye=W?.extent,Oe=Ye&&A?I===1?Ye[0]:Ye[2]:Be,tt=I===0?o[3]:o[1],Ht=I===1?1:0,qt=I===0?1:0,ke=I===1?u:m,Me=I===0?g:f,ct=Math.sin(ke),De=Math.cos(ke),ze=Math.sin(Me),Te=Math.cos(Me),F=Ee?.samplerData,D=ve?(ee,Ce,Fe)=>.5*(Mt(ee,Ce,y)+Mt(Fe,Ce,F)):(ee,Ce,Fe)=>Mt(ee,Ce,y),L=i.outerEdgesOffsetAndLength[2*I+0],Q=e&&U>3?U-3:1,ce=y!=null&&y.some(ee=>ee!=null),de=F!=null&&F.some(ee=>ee!=null),Ge=ce||de,fe=1/re,J=L;V(!Ye||br(Ye[2]-Ye[0],o[2]-o[0])),(()=>{let ee=I===1?-1:I===3?1:0,Ce=I===0?-1:I===2?1:0,Fe=(o[2]-o[0])*fe,vt=ee*Fe,wt=Ce*Fe,it=A?ee*((u-m)*fe):0,st=A?0:Ce*fe,yt=qt,We=A?ke+it:ke,Ke=A?Math.sin(We):ct,be=A?Math.cos(We):De,Je=A?ke-it:ke,Ve=A?Math.sin(Je):ct,at=A?Math.cos(Je):De,nt=A?Me:C(yt+st),Dt=A?ze:Math.sin(nt),ot=A?Te:Math.cos(nt),dt=A?Me:C(yt-st),Qt=A?ze:Math.sin(dt),ii=A?Te:Math.cos(dt),zi=0,Br=0,Ri=0;{let He=0*fe,hi=A?Be:v*(1-He)+w*He,yi=A?Oe:hi,pi=A?b*(1-He)+R*He:tt,ri=A?ke:m*(1-He)+u*He,ul=A?ct:Math.sin(ri),fl=A?De:Math.cos(ri),Ua=A?C(He):Me,vo=A?Math.sin(Ua):ze,Ha=A?Math.cos(Ua):Te,qa=d+D(hi,pi,yi);zi=fl*Ha*qa,Br=ul*Ha*qa,Ri=vo*qa}let Fi=0,gi=0,$t=0;{let He=1*fe,hi=A?Be:v*(1-He)+w*He,yi=A?Oe:hi,pi=A?b*(1-He)+R*He:tt,ri=A?ke:m*(1-He)+u*He,ul=A?ct:Math.sin(ri),fl=A?De:Math.cos(ri),Ua=A?C(He):Me,vo=A?Math.sin(Ua):ze,Ha=A?Math.cos(Ua):Te,qa=d+D(hi,pi,yi);Fi=fl*Ha*qa,gi=ul*Ha*qa,$t=vo*qa}for(let He=1;He<U-1;He+=Q){let hi=0,yi=0,pi=0;{let Mr=(He+1)*fe,Xs=A?Be:v*(1-Mr)+w*Mr,fn=A?Oe:Xs,Ji=A?b*(1-Mr)+R*Mr:tt,_n=A?ke:m*(1-Mr)+u*Mr,wl=A?ct:Math.sin(_n),rp=A?De:Math.cos(_n),oc=A?C(Mr):Me,sp=A?Math.sin(oc):ze,lc=A?Math.cos(oc):Te,bl=d+D(Xs,Ji,fn);hi=rp*lc*bl,yi=wl*lc*bl,pi=sp*bl}let ri=hi,ul=yi,fl=pi,Ua=Fi,vo=gi,Ha=$t;Fi=ri,gi=ul,$t=fl;{let Mr=J+He,Xs=Mr*B,fn=Ua-M,Ji=vo-E,_n=Ha-O;H[Xs]=fn,H[Xs+1]=Ji,H[Xs+2]=_n,Ps(fn,Ji,_n,x);let wl=He*fe;Rs(X,Mr,A?Ht:wl,A?wl:qt)}let qa=zi,JP=Br,eM=Ri;zi=Ua,Br=vo,Ri=Ha;let ac=Ua,nc=vo,_l=Ha,ip=1/Math.sqrt(ac*ac+nc*nc+_l*_l),gv=_l*ip,gl=0,yl=0,vl=0;if(Ge&&gv*gv<.999){let Mr=0,Xs=0,fn=0;{let Ji=I===0?-1:1;Mr=Ji*(ri-qa),Xs=Ji*(ul-JP),fn=Ji*(fl-eM)}{let Ji=He*fe,_n=A?Be:v*(1-Ji)+w*Ji,wl=A?Oe:_n,rp=A?b*(1-Ji)+R*Ji:tt,oc=A?ke:m*(1-Ji)+u*Ji,sp=A?ct:Math.sin(oc),lc=A?De:Math.cos(oc),bl=A?C(Ji):Me,yv=A?Math.sin(bl):ze,vv=A?Math.cos(bl):Te,z_=ac,j_=nc,W_=_l;if(ve){let wo=d+Mt(wl-vt,rp-wt,F),hc=A?vv:ii;z_=(A?at:lc)*hc*wo,j_=(A?Ve:sp)*hc*wo,W_=(A?yv:Qt)*wo}{let wo=d+Mt(_n+vt,rp+wt,y),hc=A?vv:ot,wv=(A?be:lc)*hc*wo,bv=(A?Ke:sp)*hc*wo,Tv=(A?yv:Dt)*wo;ve||(z_=2*ac-wv,j_=2*nc-bv,W_=2*_l-Tv);let Q_=I===3?-1:1,Cv=Q_*(z_-wv),xv=Q_*(j_-bv),Sv=Q_*(W_-Tv);gl=fn*xv-Xs*Sv,yl=Mr*Sv-fn*Cv,vl=Xs*Cv-Mr*xv;let $_=1/Math.sqrt(gl*gl+yl*yl+vl*vl);gl*=$_,yl*=$_,vl*=$_}}}else gl=ac*ip,yl=nc*ip,vl=_l*ip;i.setEdgeNormalFromValues(I,He,gl,yl,vl)}})()}}function oR(t){bR(t)}function lR(t,e){return Math.PI/2-2*Math.atan(Math.exp(-t/e))}function mO(t,e,i,r){return lR(t*(1-r)+e*r,i)}function uO(t,e,i){return t*(1-i)+e*i}function T0(t){let{tile:e}=t;if(e.surface.isWebMercator){let r=e.extent,s=e.ellipsoid.radius;return a=>mO(r[1],r[3],s,a)}let i=e.extentInRadians;return r=>uO(i[1],i[3],r)}function hR(t,e){let{tile:i,geometryState:r,geometry:s}=t,{extent:a,surface:n}=i,{wireframe:o}=r,l=a[0],h=a[1],d=a[2]-l,m=a[3]-h,{numVerticesPerSide:u,clippingArea:f}=r,g=f!=null?Math.max(0,(f[0]-l)/d):0,y=f!=null?Math.max(0,(f[1]-h)/m):0,v=f!=null?Math.min(1,(f[2]-l)/d):1,w=f!=null?Math.min(1,(f[3]-h)/m):1,b=(u-2)**2,R=xR(r),C=b+4*R,x=n.renderer.tileGeometryCache.acquire(C),{boundingBox:T}=s;Ol(T),s.numVerticesPerSide=u,s.vertexAttributes=x,s.maxEdgeVertexCount=R,s.minu=g,s.minv=y,s.maxu=v,s.maxv=w,fO(t),s.edgeVerticesStartIndex=b,x0(t),C0(t),_R(s,[],o),t.intersectionData=null}function fO(t){let e=t.tile;if(!e.intersectsClippingArea)return;let{geometry:i,geometryState:r,localOrigin:s}=t,{samplerData:a,clippingArea:n,numVerticesPerSide:o}=r,{surface:l,extent:h,ellipsoid:d}=e,{isWebMercatorOnPlateCarree:m}=l,u=n??S0,f=h[0],g=h[1],y=h[2],v=h[3],w=Math.max(f,u[0]),b=Math.min(y,u[2]),R=Math.max(g,u[1]),C=Math.min(v,u[3]),x=d.radius,T=e.horizontalScale,M=o-1,E=o-2,{minu:O,minv:Z,maxu:H,maxv:B,boundingBox:X,vertexAttributes:I}=i,A=I.position,re=I.uv0,{typedBuffer:U,typedBufferStride:W}=I.normalCompressed,ve=s[0],ue=s[1],Ee=s[2],Be=A.typedBuffer,Ye=A.typedBufferStride,Oe=0,tt=N(g,R,C),Ht=m?(Math.PI/2-2*Math.atan(Math.exp(-tt/x)))*x:tt*T,qt=1/M,ke=N(g*(1-qt)+v*qt,R,C),Me=Ht,ct=m?(Math.PI/2-2*Math.atan(Math.exp(-ke/x)))*x:ke*T;for(let De=1;De<=E;De++){let ze=De/M,Te=N(g*(1-ze)+v*ze,R,C),F=N(ze,Z,B),D=ct,L=(De-1)/M,Q=N(g*(1-L)+v*L,R,C),ce=Me,de=(De+1)/M,Ge=N(g*(1-de)+v*de,R,C),fe=m?(Math.PI/2-2*Math.atan(Math.exp(-Ge/x)))*x:Ge*T,J=N(de,Z,B);Me=ct,ct=fe;let ee=N(f,w,b),Ce=ee*T,Fe=Mt(ee,Te,a),vt=1/M,wt=N(vt,O,H),it=N(f*(1-wt)+y*wt,w,b),st=wt,yt=it,We=it*T,Ke=Mt(it,Te,a);if(De===1){let be=We-ve,Je=Me-ue,Ve=Ke-Ee,at=0*Ye;Be[at]=be,Be[at+1]=Je,Be[at+2]=Ve,Ps(be,Je,Ve,X);let nt=N(vt,O,H);Rs(re,Oe,nt,F)}for(let be=1;be<=E;be++){let Je=We,Ve=Ke,at=(be+1)/M,nt=N(at,O,H),Dt=N(f*(1-at)+y*at,w,b),ot=yt;yt=Dt;{let gi=Oe+1,$t=gi*Ye;if(De===1||be===E){let He=Dt*T,hi=Mt(Dt,Te,a);if(De===1&&be<E){let yi=He-ve,pi=D-ue,ri=hi-Ee;Be[$t]=yi,Be[$t+1]=pi,Be[$t+2]=ri,Ps(yi,pi,ri,X),Rs(re,gi,nt,F)}We=He,Ke=hi}else We=Be[$t]+ve,Ke=Be[$t+2]+Ee}let dt=We,Qt=Ke,ii=Ce,zi=Fe;Ce=Je,Fe=Ve;let Br=(Oe-E)*Ye,Ri=De===1?Mt(ot,Q,a):Be[Br+2]+Ee,Fi=Mt(ot,Ge,a);if(De<E){let gi=Oe+E,$t=gi*Ye,He=Je-ve,hi=fe-ue,yi=Fi-Ee;Be[$t]=He,Be[$t+1]=hi,Be[$t+2]=yi,Ps(He,hi,yi,X);let pi=st;st=nt,Rs(re,gi,pi,J)}{let gi=dt-ii,$t=ce-fe,He=$t*(Qt-zi),hi=gi*(Ri-Fi),yi=-$t*gi,pi=He*He+hi*hi+yi*yi;if(pi===0)Ao(U,Oe,0,0,1,W);else{let ri=1/Math.sqrt(pi);Ao(U,Oe,He*ri,hi*ri,yi*ri,W)}}++Oe}}}function cR(t,e){t.tile.intersectsClippingArea&&(uR(t),mR(t,!0),Vh(t),t.intersectionData=null)}function dR(t,e){t.tile.intersectsClippingArea&&(vR(t),C0(t),Vh(t),TR(t),t.intersectionData=null)}function pR(t,e){t.tile.intersectsClippingArea&&(C0(t),Vh(t),t.intersectionData=null)}function C0(t,e){t.tile.intersectsClippingArea&&(uR(t),mR(t,!1))}function mR(t,e){let{geometry:i,geometryState:r,localOrigin:s}=t,a=t.tile,{surface:n,extent:o}=a,{clippingArea:l,samplerData:h}=r,d=l??S0,m=o[0],u=o[2],f=o[1],g=o[3],y=[g>d[3],u>d[2],f<d[1],m<d[0]],v=a.horizontalScale,w=fR(n.isWebMercatorOnPlateCarree,a.ellipsoid.radius,v),{minu:b,minv:R,maxu:C,maxv:x,boundingBox:T}=i,M=Math.max(m,d[0]),E=Math.min(u,d[2]),O=Math.max(f,d[1]),Z=Math.min(g,d[3]),H=s[0],B=s[1],X=s[2];for(let I=0;I<4;++I){let A=I===1||I===3,re=r.edgeResolutions[I];V(To(re));let U=re+1,W=y[I],ve=uo(a,r.edgePeerNeighbors[I]);if(!W&&CR(a,ve,I)){wR(t,I,ve);continue}let ue=ve!=null&&!W,Ee=ve?.renderData,Be=Ee?.geometryState;if(oi&&(V(!ue||ve.level===a.level),V(!ue||_s(a,ve)<=0),a&&!ve&&!n.updatingRootTiles)){let fe=Tr[I],J=a.findNeighborTile(fe,ee=>ee.loaded||ee.leaf||ee.level===a.level);n.updatingRootTiles||(J?J.intersectsClippingArea&&(V(!J.loaded),V(!J.leaf),V(J.level===a.level)):V(n?.rootTiles==null||!a.shouldHaveNeighbor(fe)))}let Ye=N(I===1?u:m,M,E),Oe=N(I===0?g:f,O,Z),tt=Be?.samplerData,Ht=e&&U>3?U-3:1,qt=N(I===1?1:0,b,C),ke=N(I===0?1:0,R,x),Me=ue?(fe,J)=>.5*(Mt(fe,J,tt)+Mt(fe,J,h)):(fe,J)=>Mt(fe,J,h),ct=(u-m)/re,De=A?I===1?ct:-ct:0,ze=A?0:I===0?ct:-ct,Te=-De,F=-ze,D=0,L=0,Q=0;{let fe=0/re,J=A?Ye:N(m*(1-fe)+u*fe,M,E),ee=A?N(f*(1-fe)+g*fe,O,Z):Oe,Ce=Me(J,ee);D=J*v,L=w(ee),Q=Ce}let ce=0,de=0,Ge=0;{let fe=1/re,J=A?Ye:N(m*(1-fe)+u*fe,M,E),ee=A?N(f*(1-fe)+g*fe,O,Z):Oe,Ce=Me(J,ee);ce=J*v,de=w(ee),Ge=Ce}for(let fe=1;fe<U-1;fe+=Ht){let J=fe/re,ee=ce,Ce=de,Fe=Ge;{let Ve=A?qt:N(J,b,C),at=A?N(J,R,x):ke,nt=ee-H,Dt=Ce-B,ot=Fe-X;Ps(ee,Dt,ot,T),i.setEdgeVertexFromValuesRawPositionUV(I,fe,nt,Dt,ot,Ve,at)}{let Ve=(fe+1)/re,at=A?Ye:N(m*(1-Ve)+u*Ve,M,E),nt=A?N(f*(1-Ve)+g*Ve,O,Z):Oe,Dt=Me(at,nt);ce=at*v,de=w(nt),Ge=Dt}let vt=ce,wt=Ge,it=D,st=L,yt=Q;D=ee,L=Ce,Q=Fe;let We=0,Ke=0,be=0;if(A){let Ve=de-Ce,at=wt-Fe,nt=st-Ce,Dt=yt-Fe,ot=N(f*(1-J)+g*J,O,Z),dt=Ye+Te,Qt=dt*v-ee,ii=Mt(dt,ot,h)-Fe,zi=I===3?-1:1;if(We=zi*(-nt+Ve)*ii,Ke=zi*Qt*(-Dt+at),be=-zi*Qt*(-nt+Ve),ue){let Br=Ye+De,Ri=Br*v-ee;We=(-nt+Ve)*(ii-(Mt(Br,ot,tt)-Fe)),Ke=(Qt-Ri)*(-Dt+at),be=-(Qt-Ri)*(-nt+Ve)}}else{let Ve=vt-ee,at=wt-Fe,nt=it-ee,Dt=yt-Fe,ot=N(m*(1-J)+u*J,M,E),dt=Oe+F,Qt=Mt(ot,dt,h)-Fe,ii=w(dt)-Ce,zi=I===2?-1:1;if(We=zi*ii*(-Dt+at),Ke=zi*(-nt+Ve)*Qt,be=-zi*ii*(-nt+Ve),ue){let Br=ot,Ri=Oe+ze,Fi=w(Ri)-Ce;We=(-ii+Fi)*(-Dt+at),Ke=(-nt+Ve)*(-Qt+(Mt(Br,Ri,tt)-Fe)),be=-(-ii+Fi)*(-nt+Ve)}}let Je=1/Math.sqrt(We*We+Ke*Ke+be*be);i.setEdgeNormalFromValues(I,fe,We*Je,Ke*Je,be*Je)}}}function uR(t,e){bR(t)}function _O(t,e){return(Math.PI/2-2*Math.atan(Math.exp(-t/e)))*e}function gO(t,e){return t*e}function fR(t,e,i){return t?r=>_O(r,e):r=>gO(r,i)}function _R(t,e,i){let{numVerticesPerSide:r,vertexAttributes:s,maxEdgeVertexCount:a}=t,n=r-1,o=s.count,l=2*(r-3)*(r-3),h=4*(n+a-3),d=mf.reduce((y,v)=>y+(n+t.getEdgeCount(v)-3),0),m=e.reduce((y,v)=>y+n*(2*(v.latitudeResolution-1)+1),0),u=3*(i?2:1),f=(l+h+m)*u,g=o>=cO?new Uint32Array(f):new Uint16Array(f);for(let y=0;y<f;++y)g[y]=0;t.indices=g,t.indexCount=(l+d+m)*u,t.poleIndicesStartIndex=l*u,t.edgeIndicesStartIndex=(l+m)*u,i?(wO(t),bO(t,e),yR(t)):(yO(t),vO(t,e),gR(t))}function yO(t){let{numVerticesPerSide:e,indices:i,vertexAttributes:r}=t,{position:s}=r,{typedBuffer:a,typedBufferStride:n}=s,o=e-2,l=e-3,h=0,d=e-3,m=0;for(let u=0;u<l;++u){let f=u*o;for(let g=h;g<d;++g){let y=f+g,v=y+1,w=v+o,b=w-1;SR(y,v,w,b,n,a)?(i[m]=y,i[m+1]=v,i[m+2]=w,i[m+3]=w,i[m+4]=b,i[m+5]=y):(i[m]=y,i[m+1]=v,i[m+2]=b,i[m+3]=b,i[m+4]=v,i[m+5]=w),m+=6}}}function vO(t,e){let{numVerticesPerSide:i,indices:r,poleIndicesStartIndex:s}=t,a=i-1,n=s;for(let o of e){let l=o.isNorth?1:2,h=o.isNorth?2:1,d=o.isNorth?3:4,m=o.isNorth?4:3,u=t.getEdgeVertexIndex(o.connectedOuterEdgeOffset,0),f=1;for(let g=0;g<o.latitudeResolution;++g){let y=g===0?o.rowOffset:u+i;for(let v=0;v<a;v++){let w=y+v;r[n]=u,r[n+l]=u+1,r[n+h]=w,g<o.latitudeResolution-1?(r[n+d]=u+1,r[n+m]=w+1,r[n+5]=w,n+=6):n+=3,u+=f}u=y,f=1}}}function gR(t){let{indices:e,numVerticesPerSide:i,edgeIndicesStartIndex:r}=t,s=i-1,a=s-2,n=r;for(let o=0;o<4;++o){let l=R0[o],h=0,d=0,m=t.getEdgeCount(o),u=l.count;V(u===s-1);let f=o===1||o===2,g=f?1:2,y=f?2:1,v=t.getEdgeFirstVertexIndex(o),w=1,b=l.vertex0Index,R=l.stride;for(;h<m-1||d<u-1;){let C=b+d*R,x=v+h*w,T=h<m-1,M=d<u-1,E=T&&(!M||(T?0+s*(h+.5)/(m-1):0)<=(M?1+a*(d+.5)/(u-1):0));E?++h:++d;let O=E?x+w:C+R;e[n]=C,e[n+g]=x,e[n+y]=O,n+=3}}t.indexCount=n}function wO(t){let{indices:e,numVerticesPerSide:i,vertexAttributes:r}=t,{position:s}=r,{typedBuffer:a,typedBufferStride:n}=s,o=i-2,l=0;for(let h=0;h<i-3;++h){let d=h*o;for(let m=0;m<i-3;++m){let u=h*o+m,f=u+1,g=f+o,y=g-1,v=d+m,w=v+1,b=w+o;SR(v,w,b,b-1,n,a)?(Fh(e,l,u,f,g),l+=6,Fh(e,l,g,y,u)):(Fh(e,l,u,f,y),l+=6,Fh(e,l,y,g,f)),l+=6}}}function bO(t,e){let{indices:i,numVerticesPerSide:r,poleIndicesStartIndex:s}=t,a=r-1,n=s;for(let o of e){let l=o.connectedOuterEdgeOffset,h=t.getEdgeVertexIndex(l,0),d=1;for(let m=0;m<o.latitudeResolution;++m){let u=m===0?o.rowOffset:h+r;for(let f=0;f<a;f++)Fh(i,n,h,h+1,u+f),n+=6,m<o.latitudeResolution-1&&(Fh(i,n,h+1,u+f+1,u+f),n+=6),h+=d;h=u,d=1}}}function yR(t){let{indices:e,numVerticesPerSide:i,edgeIndicesStartIndex:r}=t,s=i-1,a=s-2,n=r;for(let o=0;o<4;++o){let l=R0[o],h=0,d=0,m=t.getEdgeCount(o),u=l.count;V(u===s-1);let f=o===1||o===2,g=f?1:3,y=f?3:1,v=t.getEdgeFirstVertexIndex(o),w=1,b=l.vertex0Index,R=l.stride;for(;h<m-1||d<u-1;){let C=b+d*R,x=v+h*w,T=h<m-1,M=d<u-1,E=T&&(!M||(T?0+s*(h+.5)/(m-1):0)<=(M?1+a*(d+.5)/(u-1):0));E?++h:++d;let O=E?x+w:C+R;e[n]=C,e[n+g]=x,e[n+g+1]=x,e[n+y]=O,e[n+y+1]=O,e[n+5]=C,n+=6}}t.indexCount=n}function x0(t){let{geometry:e,geometryState:i}=t,{edgeResolutions:r}=i,{numVerticesPerSide:s,edgeVerticesStartIndex:a}=e,n=s-2,o=a;for(let l=0;l<4;++l){{let h=l===0||l===2,d=(l===0?n-1:0)*n+(l===1?n-1:0),m=(h?0:1)*n+(h?1:0),u=R0[l];u.vertex0Index=d,u.stride=m,u.count=n}{let h=r[l]+1;e.outerEdgesOffsetAndLength[2*l+0]=o,e.outerEdgesOffsetAndLength[2*l+1]=h,o+=h}}}function vR(t){x0(t),t.geometryState.wireframe?yR(t.geometry):gR(t.geometry)}function wR(t,e,i){let{geometryState:r,geometry:s,tile:a,localOrigin:n}=t,o=e===1||e===3,l=r.edgeResolutions[e];V(To(l));let h=l+1,{boundingBox:d,minu:m,minv:u,maxu:f,maxv:g,vertexAttributes:y}=s,v=N(e===1?1:0,m,f),w=N(e===0?1:0,u,g),b=i.renderData,R=b.geometryState,C=b.geometry,x=(e+2)%4,T=C.getEdgeCount(x),M=a.getNeighborEdgeStartVertexIndex(e,i)*l,E=l*2**(a.level-i.level);V(R.edgeResolutions[x]===E),V(T-1===E);let O=b.localOrigin[0]-n[0],Z=b.localOrigin[1]-n[1],H=b.localOrigin[2]-n[2],B=s.getEdgeFirstVertexIndex(e),X=y.position,I=X.typedBuffer,A=X.typedBufferStride,re=y.normalCompressed,U=re.typedBuffer,W=re.typedBufferStride,ve=y.uv0,ue=C.vertexAttributes,Ee=C.getEdgeFirstVertexIndex(x),Be=ue.position.typedBuffer,Ye=ue.position.typedBufferStride,Oe=ue.normalCompressed.typedBuffer,tt=ue.normalCompressed.typedBufferStride;for(let Ht=1;Ht<h-1;++Ht){let qt=B+Ht,ke=Ee+(M+Ht),Me=qt*A,ct=ke*Ye,De=Be[ct]+O,ze=Be[ct+1]+Z,Te=Be[ct+2]+H;I[Me]=De,I[Me+1]=ze,I[Me+2]=Te,Ps(De,ze,Te,d);let F=qt*W,D=ke*tt;U[F]=Oe[D],U[F+1]=Oe[D+1];let L=Ht/l,Q=o?v:N(L,m,f),ce=o?N(L,u,g):w;Rs(ve,qt,Q,ce)}}function bR(t){let{geometry:e,geometryState:i,localOrigin:r}=t,{clippingArea:s,samplerData:a}=i,{minu:n,minv:o,maxu:l,maxv:h,boundingBox:d,vertexAttributes:m}=e,u=t.tile,{surface:f,ellipsoid:g,extent:y,extentInRadians:v,horizontalScale:w}=u,b=f.view?.viewingMode==="local",R=g.radius,C=0,x=0,T=0,M=(F,D,L)=>{let Q=v[D===0?1:3],ce=v[F===0?0:2],de=Math.cos(Q),Ge=Math.sin(Q),fe=Math.sin(ce),J=Math.cos(ce),ee=R+L;C=J*de*ee,x=fe*de*ee,T=Ge*ee},E=b?(()=>{let F=s,D=F!=null&&(y[3]>F[3]||y[2]>F[2]||y[1]<F[1]||y[0]<F[0]),L=fR(f.isWebMercatorOnPlateCarree,R,w);return(Q,ce,de)=>{let Ge=Q===0?y[0]:y[2],fe=ce===0?y[1]:y[3],J=D?N(Ge,F[0],F[2]):Ge,ee=D?N(fe,F[1],F[3]):fe,Ce=de;C=J*w,x=L(ee),T=Ce}})():M,O=0,Z=0,H=0,B=0,X=0,I=0,A=0,re=0,U=0,W=b&&f.isWebMercatorOnPlateCarree,ve=(F,D,L,Q,ce)=>{let de=0,Ge=0,fe=0;if(b){let J=D*w,ee=W?(Math.PI/2-2*Math.atan(Math.exp(-L/R)))*R:L*w;de=J-C,Ge=ee-x,fe=Q-T}else{let J=T0(F),ee=F.tile,Ce=ee.extent,Fe=ee.extentInRadians,vt=(D-Ce[0])/(Ce[2]-Ce[0]),wt=(L-Ce[1])/(Ce[3]-Ce[1]),it=Fe[0]*(1-vt)+Fe[2]*vt,st=J(wt),yt=Math.cos(st),We=Math.sin(st),Ke=Math.sin(it),be=Math.cos(it),Je=R+Q;de=be*yt*Je-C,Ge=Ke*yt*Je-x,fe=We*Je-T}switch(ce){case 0:A+=de,re+=Ge,U+=fe;break;case 1:B-=de,X-=Ge,I-=fe;break;case 2:A-=de,re-=Ge,U-=fe;break;case 3:B+=de,X+=Ge,I+=fe}},ue=s??S0,Ee=y[0],Be=y[2],Ye=y[1],Oe=y[3],tt=[Oe>ue[3],Be>ue[2],Ye<ue[1],Ee<ue[0]],Ht=Math.max(Ee,ue[0]),qt=Math.min(Be,ue[2]),ke=Math.max(Ye,ue[1]),Me=Math.min(Oe,ue[3]),ct=F=>Math.max(ue[0],Math.min(ue[2],F)),De=F=>Math.max(ue[1],Math.min(ue[3],F)),ze=F=>{let D=i.cornerNeighborCornerTiles;O=0,Z=0,H=1,B=0,X=0,I=0,A=0,re=0,U=0;let L=1/0;for(let J=0;J<4;++J){let ee=D[4*F+J];L=Math.min(L,ee?.level??1/0)}for(let J=0;J<4;++J){let ee=D[4*F+J];bd[J]=ee?.level===L?ee:null}let Q=1,ce=0;for(let J=0;J<4;++J){let ee=bd[J];ee&&(Q=Math.max(Q,ee?.renderData.geometryState.numVerticesPerSide),ce=ee.extent[2]-ee.extent[0])}let de=ce,Ge=Q;V(Ge>1);let fe=de/Ge;for(let J=0;J<4;++J){let ee=bd[(J+3)%4],Ce=bd[J%4];if(!ee&&!Ce)continue;let Fe=J===0?1:J===1?2:J===2?3:0,vt=J===0?2:J===1?3:J===2?0:1;if(ee&&Ce){let wt=v0[J][0]*fe,it=v0[J][1]*fe,st=ee.extent,yt=ct(st[Fe===0||Fe===1?2:0]+wt),We=De(st[Fe===0||Fe===3?3:1]+it),Ke=Ce.extent,be=ct(Ke[vt===0||vt===1?2:0]+wt),Je=De(Ke[vt===0||vt===3?3:1]+it),Ve=ee.renderData,at=Ce.renderData,nt=Mt(yt,We,Ve.geometryState.samplerData),Dt=Mt(be,Je,at.geometryState.samplerData);ve(Ve,yt,We,.5*(nt+Dt),J)}else{let wt=ee??Ce,it=ee?Fe:vt,st=wt.extent,yt=v0[J],We=ct(st[it===0||it===1?2:0]+yt[0]*fe),Ke=De(st[it===0||it===3?3:1]+yt[1]*fe),be=wt.renderData,Je=Mt(We,Ke,be.geometryState.samplerData);ve(be,We,Ke,Je,J)}}if(!b){let J=Math.sqrt(C*C+x*x+T*T);O=C/J,Z=x/J,H=T/J}if(b||H*H<.999){let J=Math.sqrt(B*B+X*X+I*I);B/=J,X/=J,I/=J;let ee=Math.sqrt(A*A+re*re+U*U);A/=ee,re/=ee,U/=ee,O=I*re-X*U,Z=B*U-I*A,H=X*A-B*re;let Ce=1/Math.sqrt(O*O+Z*Z+H*H);O*=Ce,Z*=Ce,H*=Ce}},Te=i.cornerNeighborCornerTiles;for(let F=0;F<4;++F){let D=F,L=(F+1)%4,Q=F===0||F===1?1:0,ce=F===0||F===3?1:0,de=N(Q,n,l),Ge=N(ce,o,h),fe=e.getEdgeFirstVertexIndex(D),J=e.getEdgeCount(D),ee=F===0||F===3?J-1:0,Ce=e.getEdgeFirstVertexIndex(L),Fe=e.getEdgeCount(L),vt=F===0||F===1?Fe-1:0,wt=-1;for(let yt=0;yt<4;++yt){let We=Te[4*F+yt],Ke=Te[4*F+wt];We&&(wt===-1||_s(Ke,We)>0)&&(wt=yt)}let it=wt,st=Te[4*F+it];if(st!==u){let yt=u.level-st.level,We=2**yt,Ke=[st.lij[0]+yt,st.lij[1]*We,st.lij[2]*We],be=[Ke[1]+We===u.lij[1],F===0&&(it===1||it===0&&st!==Te[4*F+3])||F===1&&(it===0||it===1&&st!==Te[4*F+2]),Ke[1]===u.lij[1]+1,F===2&&(it===3||it===2&&st!==Te[4*F+1])||F===3&&(it===2||it===3&&st!==Te[4*F+0])],Je=be.reduce((ot,dt)=>ot+(dt?1:0),0);V(Je===1||Je===2);let Ve=-1,at=-1,nt=st.renderData;if(Je===1){let ot=be.findIndex(Qt=>Qt);V(0<=ot&&ot<=3),Ve=(ot+2)%4;let dt=i.edgeResolutions[ot];at=u.getNeighborEdgeStartVertexIndex(ot,st)*dt+dt*(ot===0&&F===0||ot===1&&F===0||ot===2&&F===1||ot===3&&F===3?1:0)}else{V(be[1]||be[3]),Ve=be[1]?3:1;let ot=nt.geometryState.edgeResolutions[Ve];at=F===0||F===3?0:ot}let Dt=nt.geometry;{let ot=fe+ee,dt=Ce+vt,Qt=Dt.getEdgeFirstVertexIndex(Ve)+at,ii=Dt.vertexAttributes,zi=nt.localOrigin;{let Ri=ii.position,Fi=Ri.typedBuffer,gi=Qt*Ri.typedBufferStride,$t=Fi[gi]+zi[0]-r[0],He=Fi[gi+1]+zi[1]-r[1],hi=Fi[gi+2]+zi[2]-r[2];Ps($t,He,hi,d);let yi=m.position,pi=yi.typedBuffer;{let ri=ot*yi.typedBufferStride;pi[ri]=$t,pi[ri+1]=He,pi[ri+2]=hi}{let ri=dt*yi.typedBufferStride;pi[ri]=$t,pi[ri+1]=He,pi[ri+2]=hi}}let Br=m.uv0;Rs(Br,ot,de,Ge),Rs(Br,dt,de,Ge);{let Ri=ii.normalCompressed.typedBuffer,Fi=Qt*ii.normalCompressed.typedBufferStride,gi=m.normalCompressed,$t=gi.typedBuffer;{let He=ot*gi.typedBufferStride;$t[He]=Ri[Fi],$t[He+1]=Ri[Fi+1]}{let He=dt*gi.typedBufferStride;$t[He]=Ri[Fi],$t[He+1]=Ri[Fi+1]}}}}else{let yt=tt[D],We=tt[L],Ke;if(yt||We){let at=N(Ee*(1-Q)+Be*Q,Ht,qt),nt=N(Ye*(1-ce)+Oe*ce,ke,Me);Ke=Mt(at,nt,a)}else Ke=TO(Te,F);E(Q,ce,Ke),ze(F);let be=C-r[0],Je=x-r[1],Ve=T-r[2];Ps(be,Je,Ve,d),e.setEdgeVertexFromValuesRawPositionUVNormal(D,ee,be,Je,Ve,de,Ge,O,Z,H),e.setEdgeVertexFromValuesRawPositionUVNormal(L,vt,be,Je,Ve,de,Ge,O,Z,H)}}for(let F=0;F<4;++F)bd[F]=null}function TO(t,e){let i=4*e,r=mf.reduce((o,l)=>Math.min(o,t[i+l]?.level??1/0),1/0);oi&&(V(!t[i+0]||!t[i+2]||vf(t[i+0],t[i+2],gt.SOUTH_WEST)),V(!t[i+1]||!t[i+3]||vf(t[i+1],t[i+3],gt.NORTH_WEST)));let s=0,a=0;for(let o=0;o<4;++o){let l=t[i+o];if(l&&l.level===r){let h=o===0||o===1,d=o===0||o===3,m=l.extent,u=m[h?0:2],f=m[d?1:3],g=l.renderData?.geometryState?.samplerData;a+=Mt(u,f,g),s++}}let n=s?a/s:0;return V(n!=null),n}function Vh(t){let{vao:e,geometry:i}=t,{vertexAttributes:r,edgeVerticesStartIndex:s}=i,a=r.position.typedBuffer;e.vertexBuffers.get("geometry").setSubData(a,s,s,a.length)}function TR(t){let{vao:e,geometry:i}=t,{indices:r,indexCount:s,edgeIndicesStartIndex:a}=i;e.indexBuffer.setSubData(r,a,a,s)}var w0=class{constructor(e,i,r,s,a){this.isNorth=e,this.connectedRowOffset=i,this.connectedOuterEdgeOffset=r,this.rowOffset=s,this.latitudeResolution=a}},v0=[[0,1],[1,0],[0,-1],[-1,0]],Di=new lf,S0=Xv(-1/0,-1/0,1/0,1/0),bd=[null,null,null,null];function CR(t,e,i){if(!e)return!1;let r=_s(t,e);return r>0||r===0&&i>=2}var Nh=class{constructor(){this.vertex0Index=0,this.stride=1,this.count=0}getVertexIndex(e){return V(0<=e&&e<this.count),this.vertex0Index+this.stride*e}},R0=[new Nh,new Nh,new Nh,new Nh];function Ps(t,e,i,r){t<r[0]?r[0]=t:t>r[3]&&(r[3]=t),e<r[1]?r[1]=e:e>r[4]&&(r[4]=e),i<r[2]?r[2]=i:i>r[5]&&(r[5]=i)}function xR(t){let{edgeResolutions:e,numVerticesPerSide:i}=t,r=1+Math.max(...e);return Math.max(i,r)}function SR(t,e,i,r,s,a){let n=t*s,o=a[n],l=a[n+1],h=a[n+2],d=e*s,m=a[d],u=a[d+1],f=a[d+2],g=i*s,y=a[g],v=a[g+1],w=a[g+2],b=r*s,R=a[b],C=a[b+1],x=a[b+2];return(m-R)*(m-R)+(u-C)*(u-C)+(f-x)*(f-x)>(o-y)*(o-y)+(l-v)*(l-v)+(h-w)*(h-w)}function Fh(t,e,i,r,s){t[e]=i,t[e+1]=r,t[e+2]=r,t[e+3]=s,t[e+4]=s,t[e+5]=i}var wf=6;var Tf=class extends fo{constructor(e,i,r,s,a){super(),this._horizontalScaleFactor=1,this._extentInRenderSR=kt(),this._baseUsedMemory=900,this._subtreeGeometryElevationBoundMin=0,this._subtreeGeometryElevationBoundMax=0,this.init(e,i,r,s,a)}init(e,i,r,s,a){super.init(e,i,r,s,a);let n=a.view.renderSpatialReference,o=a.spatialReference,l=n!=null&&pp(n)&&o!=null&&o.isGeographic?this.ellipsoid.radius*Math.PI/180:1;this._horizontalScaleFactor=l;let{isWebMercatorOnPlateCarree:h}=a,d=this._extentInRenderSR,m=this.extent;if(h){let u=xt(m[0],m[1],0);En(u,Kt.WebMercator,u,Kt.PlateCarree);let f=xt(m[2],m[3],0);En(f,Kt.WebMercator,f,Kt.PlateCarree),d[0]=u[0],d[1]=u[1],d[2]=f[0],d[3]=f[1]}else for(let u=0;u<4;++u)d[u]=m[u]*l;this.centerAtSeaLevel[0]=.5*(d[0]+d[2]),this.centerAtSeaLevel[1]=.5*(d[1]+d[3]),this.centerAtSeaLevel[2]=0,this._edgeLen=Math.max(d[2]-d[0],d[3]-d[1]),this._edgeLen2=this._edgeLen*this._edgeLen,this.updateRadiusAndCenter()}updateRadiusAndCenter(){this._updateCenter();let e=this._extentInRenderSR,i=.5*(e[2]-e[0]),r=.5*(e[3]-e[1]),s=Math.sqrt(i*i+r*r),a=.5*(this.elevationBoundsMax-this.elevationBoundsMin),n=Math.max(s,a);this._center[Wt.MIDDLE][3]=n}_calculateFrustumVisibility(e){let i=this._aabb(),r=i[0],s=i[1],a=i[2],n=i[3],o=i[4],l=i[5],h=!0;for(let d=0;d<6;d++){let m=e[d],u=m[0],f=m[1],g=m[2],y=m[3];if(u*(u>0?r:n)+f*(f>0?s:o)+g*(g>0?a:l)+y>=0)return Si.OUTSIDE;h=h&&u*(u<0?r:n)+f*(f<0?s:o)+g*(g<0?a:l)+y<=0}return h?Si.INSIDE:Si.INTERSECTS}_aabb(){let e=this._extentInRenderSR;return b1(e[0],e[1],Math.min(this.elevationBoundsMin,this._subtreeGeometryElevationBoundMin),e[2],e[3],Math.max(this.elevationBoundsMax,this._subtreeGeometryElevationBoundMax))}intersectsRay(e,i,r,s){return bf[0]=1/i[0],bf[1]=1/i[1],bf[2]=1/i[2],Zp(this._aabb(),e,bf,r,s)}createGeometry(){hR(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds(),this.setMemoryDirty()}_updateSubtreeGeometryElevationsBounds(){let e=this._subtreeGeometryElevationBoundMin,i=this._subtreeGeometryElevationBoundMax,r=this.renderData,s=e,a=i;if(r){let n=r.geometry.boundingBox;s=n[2],a=n[5]}else if(!this.leaf){s=1/0,a=-1/0;for(let n of this.children){let o=n;s=Math.min(s,o._subtreeGeometryElevationBoundMin),a=Math.max(a,o._subtreeGeometryElevationBoundMax)}}(s!==this._subtreeGeometryElevationBoundMin||a!==this._subtreeGeometryElevationBoundMax)&&(this._subtreeGeometryElevationBoundMin=s,this._subtreeGeometryElevationBoundMax=a,this.parent?._updateSubtreeGeometryElevationsBounds())}get minimumVerticesPerSide(){return this.level<9?3:2}updateCornerElevations(){cR(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds()}updateEdgeElevations(){pR(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds()}updateEdgeElevationsAndResolutions(){dR(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds()}get horizontalScale(){return this._horizontalScaleFactor}},bf=_();var P0=class{constructor(){this.extent=ni(),this.minLevel=0,this.maxLevel=0,this.callback=null}},Td=class extends te{constructor(){super(...arguments),this._queries=new Xe({initialSize:10}),this._queriesInvPtr=0,this._queryQueue=new Xe({initialSize:30}),this._queryPool=new rs(P0)}queryVisibleLevelRange(t,e,i,r){let s=this._queryPool.acquire();Dl(s.extent,t),s.minLevel=e??-Number.MAX_VALUE,s.maxLevel=i??Number.MAX_VALUE,s.callback=r,this._queryQueue.push(s),this.notifyChange("updating")}get updating(){return this._queryQueue.length!==0}prepare(){for(;this._queries.length<this._queries.data.length&&this._queryQueue.length>0;){let t=this._queryQueue.pop();this._queries.push(t)}this._queriesInvPtr=this._queries.length}process(){for(let t=0;t<this._queries.length;t++){let e=this._queries.data[t];this._queryPool.release(e),e.callback(t>=this._queriesInvPtr),e.callback=null}this._queries.clear(),this.notifyChange("updating")}queriesForTile(t){let e=t.level,i=0;for(;i<this._queriesInvPtr;){let r=this._queries.data[i],s=r.extent;e>=r.minLevel&&e<=r.maxLevel&&s[0]<=t.extent[2]&&s[2]>=t.extent[0]&&s[1]<=t.extent[3]&&s[3]>=t.extent[1]?(this._queries.swapElements(i,this._queriesInvPtr-1),this._queriesInvPtr--):i++}}};c([p()],Td.prototype,"updating",null),Td=c([S("esri.views.3d.terrain.ScaleRangeQueries")],Td);function RR(t,e,i,r){let s=Math.cos(i);t[0]=Math.cos(e)*s*r,t[1]=Math.sin(e)*s*r,t[2]=Math.sin(i)*r}var Cf=class extends fo{constructor(e,i,r,s,a){super(),this._convexHull=new Array(24),this._boundingSphere=mi(),this._baseUsedMemory=1816,this.init(e,i,r,s,a)}init(e,i,r,s,a){super.init(e,i,r,s,a);let n=this.ellipsoid.radius,o=this.extentInRadians[0],l=this.extentInRadians[1],h=this.extentInRadians[2],d=this.extentInRadians[3],m=Ae(l,d,.5),u=Ae(o,h,.5),f=e===0?0:Math.min(Math.abs(l),Math.abs(d));this._edgeLen=(h-o)*Math.cos(f)*n,this._edgeLen2=this._edgeLen*this._edgeLen,this._curvatureHeight=n-Math.sqrt(n*n-this._edgeLen2/4),RR(this.centerAtSeaLevel,u,m,this.ellipsoid.radius),z(this.up,this.centerAtSeaLevel),this.updateRadiusAndCenter()}updateRadiusAndCenter(){this._updateBoundingVolumes();let e=this._center;if(this.lij[0]===0)xe(e[Wt.MIDDLE],0,0,0),xe(e[Wt.TOP],0,0,0),xe(e[Wt.BOTTOM],0,0,0),e[Wt.MIDDLE][3]=this.ellipsoid.radius+this.elevationBoundsMax;else{this._updateCenter();let i=e[Wt.MIDDLE],r=this.convexHull,s=0;for(let a=0;a<8;++a)s=Math.max(s,CO(i,r,3*a));e[Wt.MIDDLE][3]=Math.sqrt(s)}}_calculateFrustumVisibility(e){if(!Rc(e,this._boundingSphere))return Si.OUTSIDE;if(this.lij[0]<10)return Si.INTERSECTS;let i=this.convexHull,r=this.surface.view.state.camera.near,s=!0;for(let a=0;a<gw;a++){let n=a===Mn.NEAR,o=e[a],l=o[0],h=o[1],d=o[2],m=o[3]-(n?r:0),u=!1;for(let f=0;f<8;++f){let g=3*f;if(l*i[g]+h*i[g+1]+d*i[g+2]+m<0){if(u=!0,!s)break}else s=!1}if(!u)return Si.OUTSIDE}return s?Si.INSIDE:Si.INTERSECTS}computeElevationBounds(){super.computeElevationBounds(),this._updateBoundingVolumes()}createGeometry(){iR(this.renderData,this._getPatchType()),this._updateBoundingVolumes(),this.setMemoryDirty()}_updateBoundingVolumes(){this._updateConvexHull(),this._updateBoundingSphere(),oi&&this._checkBVs()}_updateBoundingSphere(){let e=this._boundingSphere,i=e,r=this.elevationBoundsMin,s=this.elevationBoundsMax,a=this.ellipsoid.radius,n=s;if(this.level===0)xe(i,0,0,0),e[3]=a+n;else{let o=this.extentInRadians,l=.5*(o[0]+o[2]),h=o[1],d=o[3];ol(AR,l,h,a),ol(ER,l,d,a),K(i,AR,ER),k(i,i,(a+.5*(r+s))/vi(i));let m=this.convexHull,u=0,f=(y,v)=>{let w=y[0]-m[3*v],b=y[1]-m[3*v+1],R=y[2]-m[3*v+2];return Math.sqrt(w*w+b*b+R*R)};for(let y=0;y<8;++y){let v=f(i,y);u=Math.max(u,v)}let g=u;e[3]=g+2}}_updateConvexHull(){let e=this.extentInRadians,i=this.ellipsoid.radius;if(this.level===0)return;let r=this.elevationBoundsMin,s=this.elevationBoundsMax,a=this._getPatchType(),n=this.surface.isWebMercator,o=n&&a===us.HAS_NORTH_POLE,l=n&&a===us.HAS_SOUTH_POLE,h=l||o,d=Math.PI/2,m=e[0],u=e[2],f=l?-d:e[1],g=o?d:e[3],y=.5*(m+u),v=r,w=i+(h?Math.min(0,v-1):v),b=(U,W,ve)=>ol(U,W,ve,w),R=_(),C=_(),x=_(),T=_();b(R,m,f),b(C,m,g),b(x,u,g),b(T,u,f);let M=(U,W)=>{for(let ve=0;ve<3;++ve)this._convexHull[3*W+ve]=U[ve]};M(R,0),M(C,1),M(x,2),M(T,3);let E=s,O=i+(h?Math.max(0,E+1):E),Z=_(),H=_(),B=_();ol(H,y,g,w),ol(B,y,f,w),K(Z,H,B),z(Z,Z);let X=_(),I=_(),A=(U,W)=>{bt(I,U,W),z(I,I);let ve=-$(U,X)/$(I,X);V(ve>=0),k(I,I,ve),K(U,U,I)};if(2**this.lij[0]>2*this.lij[1]){let U=B,W=_();Qe(W,MR,U),z(W,W),Qe(X,U,W),z(X,X),V(br($(X,U)/vi(U),0)),A(R,C),A(T,x),M(R,0),M(T,3)}else if(2**this.lij[0]!==2*this.lij[1]){let U=H,W=_();Qe(W,MR,U),z(W,W),Qe(X,W,U),z(X,X),A(C,R),A(x,T),M(C,1),M(x,2)}let re=(U,W)=>{let ve=O/$(W,Z);for(let ue=0;ue<3;++ue)this._convexHull[3*U+ue]=W[ue]*ve};re(4,R),re(5,C),re(6,x),re(7,T)}_getPatchType(){let e=this.lij[1],i=e===0,r=e===(1<<this.level)-1;return i?r?us.HAS_BOTH_POLES:us.HAS_NORTH_POLE:r?us.HAS_SOUTH_POLE:us.REGULAR}intersectsRay(e,i,r,s){let a=this._boundingSphere,n=a[3]+r,o=i[0]*i[0]+i[1]*i[1]+i[2]*i[2],l=a[0]-e[0],h=a[1]-e[1],d=a[2]-e[2],m=(l*i[0]+h*i[1]+d*i[2])/o,u=i[0]*m-l,f=i[1]*m-h,g=i[2]*m-d;return u*u+f*f+g*g<n*n}get minimumVerticesPerSide(){return this.level<PR.length?PR[this.level]+1:2}updateCornerElevations(){aR(this.renderData),this._updateBoundingVolumes()}updateEdgeElevations(){rR(this.renderData),this._updateBoundingVolumes()}updateEdgeElevationsAndResolutions(){sR(this.renderData),this._updateBoundingVolumes()}_checkBVs(){if(!oi||this.level<=2)return;let e=this._boundingSphere,i=e[3],r=e,s=_(),a=this.ellipsoid.radius,n=this.elevationBoundsMin,o=this.elevationBoundsMax,l=a+n,h=1,d=0,m=this._center[Wt.MIDDLE][3],u=this.convexHull,f=(D,L)=>{for(let Q=0;Q<3;++Q)D[Q]=u[3*L+Q]};{let D=_(),L=_(),Q=_(),ce=_(),de=_(),Ge=(fe,J,ee,Ce)=>{f(L,fe),f(Q,J),f(ce,ee),bt(L,L,Q),bt(ce,ce,Q),Qe(D,L,ce),z(D,D);let Fe=$(D,Q);f(de,Ce);let vt=$(D,de),wt=Math.abs(vt-Fe);V(br(wt,0),`Non coplanar ${fe},${J},${ee},${Ce} diff = ${wt}`)};Ge(0,1,2,3),Ge(4,5,6,7),Ge(0,1,4,5),Ge(1,2,5,6),Ge(2,3,6,7),Ge(3,0,7,4)}let g=v1(24),y=(D,L,Q)=>{let ce=4*D;for(let de=0;de<3;++de)g[ce+de]=L[de];g[ce+3]=Q},v=_(),w=_(),b=_(),R=_(),C=(D,L,Q,ce)=>{f(v,L),f(w,Q),f(b,ce),bt(v,v,w),z(v,v),bt(b,b,w),z(b,b),Qe(R,v,b),z(R,R);let de=$(R,w);y(D,R,de)};C(0,0,1,2),C(1,1,0,4),C(2,1,5,2),C(3,3,2,6),C(4,4,0,3),C(5,4,6,5);let x=(D,L,Q,ce)=>{let de=4*D;return g[de]*L+g[de+1]*Q+g[de+2]*ce-g[de+3]},T=(D,L,Q,ce)=>x(D,L,Q,ce)>=-1,M=(D,L)=>T(D,L[0],L[1],L[2]),E=2**this.lij[0]>2*this.lij[1],O=(D,L,Q)=>Math.sqrt(OR(D,L,Q,r[0],r[1],r[2]))<i,Z=D=>O(D[0],D[1],D[2]),H=(D,L)=>O(D[L],D[L+1],D[L+2]),B=this.extentInRadians,X=.5*(B[0]+B[2]),I=B[1],A=B[3],re=_(),U=_();ol(re,X,A,l),ol(U,X,I,l);let W=E?"Upper":"Lower",ve=!0;for(let D=0;D<6;++D){for(let L=0;L<8;++L){let Q=3*L,ce=T(D,u[Q],u[Q+1],u[Q+2]);ve&&=ce,V(ce,`Tile[${this.lij}] Convex hull point ${L} outside of plane ${D}`)}V(M(D,U),`Tile[${this.lij}] (${W}) bottom mid outside of plane ${D}`),V(M(D,re),`Tile[${this.lij}] (${W}) top mid outside of plane ${D}`)}V(ve,"Not all convex hull points are inside  convex hull polyhedron"),V(Z(U),`Tile[${this.lij}] (${W}) bottom mid outside of bounding sphere`),V(Z(re),`Tile[${this.lij}] (${W}) top mid outside of bounding sphere`);for(let D=0;D<8;++D){let L=H(u,3*D);V(L,`Tile[${this.lij}] Convex hull point ${D} outside of bounding sphere`)}for(let D=0;D<6;++D)for(let L=0;L<8;++L){let Q=3*L;T(D,u[Q],u[Q+1],u[Q+2])||console.error(`Tile[${this.lij}] Convex hull point ${L} outside of plane ${D}`)}let{extentInRadians:ue}=this,Ee=Math.max(ue[2]-ue[0],ue[3]-ue[1]),Be=Math.round(Ee*a),{renderData:Ye}=this;if(!Ye)return;let{geometry:Oe,geometryState:tt,localOrigin:Ht}=Ye,qt=Oe.vertexAttributes?.position;if(!qt)return;let ke=_(),Me=Oe.numVerticesPerSide-2,{indices:ct,indexCount:De,edgeVerticesStartIndex:ze,poleVerticesStartIndex:Te}=Oe;if(!ct)return;let F=new Set;for(let D=0;D<De;++D){let L=ct[D];if(F.has(L))continue;F.add(L);let Q=L<Te,ce=L>=ze,de=!1,Ge=-1;if(ce){let be=ze;for(let Je=0;Je<4;++Je){let Ve=tt.edgeResolutions[Je];if(L===be||L===be+Ve-1){de=!0;break}if(be+=Ve,L<be){Ge=Je;break}}}let fe=ce?tt.edgePeerNeighbors[Ge]:null,J=ce&&fe&&_s(this,fe)>0;qt.getVec(L,s),K(ke,s,Ht);let ee=vi(ke)-a,Ce=0,Fe=!1,vt=n-ee,wt=ee-o,it=vt>h,st=wt>h,yt=it||st,We=()=>{let be=Q?"internal":ce&&!de?"edge":de?"corner":"pole";return`Tile[${this.lij}].vertex[${L}]:${be}`+(it?"(below)":st?"(above)":"")+(J?"(Neighbor)":"")},Ke=Ai(ke,r);if(Ke>=i+d){let be=Ke-i;yt||(console.error(`${We()} is out of the bounding sphere by ${be.toFixed(0)} / ${i.toFixed(0)}[tol=${d}] h=${ee.toFixed(0)} / [${n.toFixed(0)}..${o.toFixed(0)}] (${(be/i).toFixed(0)})`),Fe=!0)}for(let be=0;be<6;++be)if(!T(be,ke[0],ke[1],ke[2])){let Je=x(be,ke[0],ke[1],ke[2]),Ve=L%Me,at=(L-Ve)/Me;be===0&&vt||be===5&&wt||(console.error(`${We()} (${Ve},${at})|${Me}] is out of the bounding trapezoid plane ${be} h=${Math.round(ee)} / [${Math.round(n)}..${Math.round(o)}] dist=${Math.round(Je)} radii = ${Math.round(i)}/${Math.round(m)}} : maxL = ${Be}`),++Ce)}if(Fe||Ce>0)break}}get convexHull(){return this._convexHull}},PR=[128,64,64,32,16,8,8,4];function CO(t,e,i){return OR(t[0],t[1],t[2],e[i],e[i+1],e[i+2])}function OR(t,e,i,r,s,a){let n=r-t,o=s-e,l=a-i;return n*n+o*o+l*l}var ol=(t,e,i,r)=>{let s=Math.cos(e),a=Math.sin(e),n=Math.cos(i),o=Math.sin(i);t[0]=r*n*s,t[1]=r*n*a,t[2]=r*o},MR=[0,0,1],AR=_(),ER=_();var Ms=class extends te{constructor(){super(...arguments),this.fovX=0,this.fovY=0,this.relativeWidthLimit=0,this.relativeHeightLimit=0,this.maxLod=0,this.angledSplitBias=0,this.aboveGround=!0}};c([p()],Ms.prototype,"fovX",void 0),c([p()],Ms.prototype,"fovY",void 0),c([p()],Ms.prototype,"relativeWidthLimit",void 0),c([p()],Ms.prototype,"relativeHeightLimit",void 0),c([p()],Ms.prototype,"maxLod",void 0),c([p()],Ms.prototype,"angledSplitBias",void 0),c([p()],Ms.prototype,"aboveGround",void 0),c([p()],Ms.prototype,"frustum",void 0),Ms=c([S("esri.views.3d.terrain.SplitLimits")],Ms);var DR=zr().vec3f(Et.POSITION).vec2i16(Et.UV0).vec2i16(Et.NORMALCOMPRESSED,{glNormalized:!0});var xf=class{constructor(e){this._storage=new xs((i,r)=>e.newCache(i,r),"TileGeometry")}acquire(e){let r=Math.ceil(e/4)*4,s=this._storage,a=xO(r),n=s.pop(a);if(n)return n;let o=DR.createBuffer(r);return o.release=()=>s.put(a,o),o}clear(){this._storage.clear()}destroy(){this._storage.destroy()}};function xO(t){return t.toString()}var Sf=class extends TC{constructor(){super(...arguments),this.opacity=1,this.baseOpacity=1,this.texture=null,this.fboTexture=null,this.backgroundColor=Ls}},Cd=class extends Ne{constructor(e,i){super(e,i,new Le(GC,()=>import("./chunk-Y6PXLNIN.js")))}};function IR(t,e){let i=t.transforms.tileUnitsToPixels,r=yp(e),s=Math.cos(r),a=Math.sin(r),n=Math.ceil(512*(Math.abs(a)+Math.abs(s)));Pp(Na),Fl(Na,Na,[n/2,n/2]),Ap(Na,Na,r),Fl(Na,Na,[-256,-256]),Ep(Na,Na,[1/8,1/8,1]),t.transforms.tileUnitsToPixels=Na;let o=[],l=new FT(4096,o,()=>new DT),h=new NT(o,l,(d,m,u)=>new LT(d,m,u,t.styleRepository,t.key.level,e),(d,m)=>{IT(d,m,!1)},()=>0,d=>{let m=t.styleRepository.getStyleLayerByUID(d).getLayoutProperty("visibility");return!m||m.getValue()!==xw.NONE});o.push(t),l.add(t),h.setScreenSize(n,n),h.continue(1/0),l.removeTile(t),t.transforms.tileUnitsToPixels=i}var Na=gb();var SO=.125,Rf=class{constructor(){this._renderParams={reshuffleManager:new bT,context:null,drawPhase:1,state:new M0,stationary:!0,pixelRatio:1,displayLevel:-1,requiredLevel:-1,globalOpacity:1,renderPass:"background",styleLayer:null,styleLayerUID:-1,painter:null,glyphMosaic:null,spriteMosaic:null,profiler:null,renderingOptions:null,requestRender:null,allowDelayedRender:!1,deltaTime:-1,timeline:null,time:0,hasClipping:!1,blendMode:null,dataUploadCounter:0,effects:null,inFadeTransition:!1,requireFBO:!1,highlightGradient:null,stencilSymbols:!0,is3D:!0,backgroundColor:null},this._backgroundTile=new VT(new Z1(0,0,0,0),0,0,0,512,512,4096,4096),this._heading=0,this._declutteredForHeading=new WeakMap}dispose(){this._renderParams=null}renderBackground(e,i,r,s,a,n,o,l,h,d){let m=this._backgroundTile;this._updateRenderParameters(e,i,m,r,a,n,o,l,h,d),this._renderParams.stencilSymbols=!1,r.drawBackground(this._renderParams,m,s)}renderContent(e,i,r,s,a,n,o,l,h,d,m,u){this._declutter(r),s.forAll(({sourceLayerInfo:{data:y}})=>this._declutter(y));let f=s.length>0;f&&this._stencilSymbols(e,i,r,s,a,n,o,l,h,d,m,u);let g=1;r.stencilRef=f?g:0,e.setStencilFunction(Nt.EQUAL,r.stencilRef,255),this._render(e,i,r,a,n,o,l,h,d,m,u),s.forAll(({sourceLod:y,offset:v,sourceLayerInfo:{data:w}})=>{w.stencilRef=++g,this._renderSymbols(e,y,w,a,n,o,l,v,d,m,u)})}_stencilSymbols(e,i,r,s,a,n,o,l,h,d,m,u){let f=1;r.stencilRef=f,e.setDepthTestEnabled(!1),e.setDepthWriteEnabled(!1),e.setStencilTestEnabled(!0),e.setBlendingEnabled(!1),e.setColorMask(!1,!1,!1,!1),e.setStencilOp(bp.KEEP,bp.KEEP,bp.REPLACE),e.setStencilWriteMask(255),e.setStencilFunction(Nt.ALWAYS,r.stencilRef,255),this._stencilTileSymbols(e,i,r,a,n,o,l,h,d,m,u),s.forAll(({sourceLod:g,offset:y,sourceLayerInfo:{data:v}})=>{v.stencilRef=++f,e.setStencilFunction(Nt.ALWAYS,v.stencilRef,255),this._stencilTileSymbols(e,g,v,a,n,o,l,y,d,m,u)}),e.setStencilWriteMask(0),e.setBlendingEnabled(!0),e.setDepthTestEnabled(!0),e.setColorMask(!0,!0,!0,!0)}_renderSymbols(e,i,r,s,a,n,o,l,h,d,m){e.setStencilFunction(Nt.EQUAL,r.stencilRef,255),this._render(e,i,r,s,a,n,o,l,h,d,m,Cw.SYMBOL)}_render(e,i,r,s,a,n,o,l,h,d,m,u){this._updateRenderParameters(e,i,r,s,n,o,l,h,d,m),this._renderParams.stencilSymbols=!1,s.drawTile(this._renderParams,r,a,u)}_stencilTileSymbols(e,i,r,s,a,n,o,l,h,d,m){this._updateRenderParameters(e,i,r,s,n,o,l,h,d,m),this._renderParams.stencilSymbols=!0,r.triangleCount=0,s.drawSymbols(this._renderParams,r,a)}_updateRenderParameters(e,i,r,s,a,n,o,l,h,d){"type"in r&&r.type==="vector-tile"&&!r.stage&&r.attachWithContext(e);let m=i[0]-a.getLevelShift(i[0]),u=this._renderParams;u.context=e,u.painter=s,u.glyphMosaic=s.glyphMosaic,u.spriteMosaic=s.spriteMosaic,u.pixelRatio=h*d,u.displayLevel=m,u.requiredLevel=m;let f=a.getScale(i[0]),[g,y]=a.getOffset(i,n*f),v=SO*n*f/l,w=r.transforms.displayViewScreenMat3;w[0]=v,w[4]=-v,w[6]=-1-g-o[0]*n*2,w[7]=1+y+(1-o[1])*n*2-2;let b=u.state,R=l/d;b.size[0]=R,b.size[1]=R,b.pixelRatio=d,b.rotation=(360-this._heading)%360;let C=2/R;k1(b.displayViewMat3,C,0,0,0,-C,0,-1,1,1);let x=Pp(b.displayMat3),T=yp(this._heading);Fl(x,x,[R/2,R/2]),Ap(x,x,T),Fl(x,x,[-R/2,-R/2]),G1(x,b.displayViewMat3,x)}updateHeading(e){this._heading=e}_declutter(e){this._declutteredForHeading.get(e)!==this._heading&&(IR(e,(360-this._heading)%360),this._declutteredForHeading.set(e,this._heading))}},M0=class{constructor(){this.size=[0,0],this.pixelRatio=1,this.rotation=0,this.displayMat3=jr(),this.displayViewMat3=jr(),this.transform=null,this.inverseTransform=null,this.viewMat2d=null,this.viewMat3=null,this.id=0,this.extent=null,this.center=null,this.scale=1,this.resolution=0,this.worldScreenWidth=0,this.spatialReference=null,this.viewpoint=null,this.getScreenTransform=null,this.toMap=null,this.toScreen=null,this.clone=null,this.copy=null,this.toJSON=null}};var xd=class extends Nn{constructor(){super(...arguments),this.blendMode=kn.Normal}};c([ht({count:kn.COUNT})],xd.prototype,"blendMode",void 0);var cn=class extends xd{constructor(){super(...arguments),this.output=Ei.Composite,this.baseOpacityMode=nr.NotRequired,this.premultipliedSource=js.Off}};c([ht({count:Ei.COUNT})],cn.prototype,"output",void 0),c([ht({count:nr.COUNT})],cn.prototype,"baseOpacityMode",void 0),c([ht({count:js.COUNT})],cn.prototype,"premultipliedSource",void 0);var Sd=class extends cn{constructor(){super(...arguments),this.background=dh.BelowLayer}};c([ht({count:dh.COUNT})],Sd.prototype,"background",void 0);var Rd=class extends Ne{constructor(e,i){super(e,i,new Le(xC,()=>import("./chunk-TUPRETT3.js")))}};var _o=class extends cn{constructor(){super(...arguments),this.colorizerType=Xg.Stretch,this.stretchType=lh.Noop,this.applyColormap=!0,this.requireBilinearWithNN=!1}};c([ht({count:Xg.COUNT})],_o.prototype,"colorizerType",void 0),c([ht({count:lh.COUNT})],_o.prototype,"stretchType",void 0),c([ht()],_o.prototype,"applyColormap",void 0),c([ht()],_o.prototype,"requireBilinearWithNN",void 0);var Pd=class{constructor(e){this._rctx=e,this._fbos=new Map}get(e){return this._getPool(e)}dispose(){this._fbos.forEach(e=>e.dispose()),this._fbos.clear()}_getPool(e){let i=this._fbos.get(e);if(i)return i;let r=new la(this._rctx,new Ot(e),new Jp(Tp.DEPTH24_STENCIL8,e));return this._fbos.set(e,r),r}};var RO=()=>pe.getLogger("esri.views.3d.terrain"),Pf=class{constructor(e,i){this._rctx=e,this._techniques=i,this._fbos=[],this._vectorTileHelper=new Rf,this._bindParameters=new am(null),this._blendLayersTechniqueConfig=new Sd,this._current=0,this._lastUsedIds=new Array,this._lastCreatedBufferId=0,this._onHoldIds=new Array,this._vaoQuad=ar(this._rctx,Bn.Pos2Tex)}dispose(){this._fbos.forEach(ge),this._fbos=null,this._vtFBO=ge(this._vtFBO),this._vaoQuad=ge(this._vaoQuad),this._vectorTileHelper=ge(this._vectorTileHelper)}updateHeading(e){this._vectorTileHelper?.updateHeading(e)}_acquireBlendLayersTechnique(e,i,r,s=js.Off,a=dh.BelowLayer){return this._blendLayersTechniqueConfig.output=i,this._blendLayersTechniqueConfig.blendMode=e,this._blendLayersTechniqueConfig.baseOpacityMode=r,this._blendLayersTechniqueConfig.premultipliedSource=s,this._blendLayersTechniqueConfig.background=a,this._techniques.precompile(Cd,this._blendLayersTechniqueConfig),this._techniques.get(Cd,this._blendLayersTechniqueConfig)}drawBackground(e,i){let r=this._acquireBlendLayersTechnique(kn.Normal,i?Ei.ColorComposite:Ei.GridComposite,nr.NotRequired,js.Off,dh.Only),s=this._rctx.bindTechnique(r,this._bindParameters,e);this._render(s)}_render(e){this._rctx.bindVAO(this._vaoQuad),e.assertCompatibleVertexAttributeLocations(this._vaoQuad),this._rctx.drawArrays(ft.TRIANGLE_STRIP,0,Hs(this._vaoQuad,"geometry"))}drawGroup(e,i,r,s,a=js.On){i===Ei.Composite&&(e.fboTexture=this._fbos[this.getLastOnHoldId()].get(r).colorTexture),e.texture=this.currentFBO(r).colorTexture,this.closeGroup(r);let n=e.baseOpacity<1?nr.Required:nr.NotRequired,o=this._acquireBlendLayersTechnique(s,i,n,a),l=this._rctx.bindTechnique(o,this._bindParameters,e);this._render(l)}drawImageData(e,i,r,s,a=js.Off){if(e.texture==null)return;let n=e.baseOpacity<1?nr.Required:nr.NotRequired;e.fboTexture=i===Ei.GroupBackgroundComposite||s===kn.Normal&&n===nr.NotRequired&&a===js.Off?null:this.switch(r).colorTexture;let o=this._acquireBlendLayersTechnique(s,i,n,a),l=this._rctx.bindTechnique(o,this._bindParameters,e);this._render(l)}drawRasterData(e,i,r,s,a){let n=a.sourceLayerInfo.data;if(!n.source||(a.tile.surface.layerViewByIndex(a.layerIndex,_e.MAP).ensureSymbolizerParameters(n),!n.bind(this._rctx)))return;let o=e.baseOpacity<1?nr.Required:nr.NotRequired;e.fboTexture=s===kn.Normal&&o===nr.NotRequired?null:this.switch(r).colorTexture;let l=this._acquireRasterColorizerTechnique(n,i,s,o);n.opacity=e.opacity;let h=n.getUniforms();h.scale=a.scale,h.offset=a.offset,h.backgroundColor=e.backgroundColor,h.fboTexture=e.fboTexture,h.baseOpacity=e.baseOpacity;let d=this._rctx.bindTechnique(l,this._bindParameters,h);this._render(d)}_acquireRasterColorizerTechnique(e,i,r,s){let a=e.symbolizerParameters,n=["stretch","lut","hillshade"].indexOf(a.type);return this._rasterColorizerConfig==null&&(this._rasterColorizerConfig=new _o,this._rctx.gl.getExtension("WEBGL_color_buffer_float"),this._rctx.gl.getExtension("OES_texture_float")),this._rasterColorizerConfig.output=i,this._rasterColorizerConfig.blendMode=r,this._rasterColorizerConfig.baseOpacityMode=s,this._rasterColorizerConfig.colorizerType=n,this._rasterColorizerConfig.applyColormap=!!a.colormap,this._rasterColorizerConfig.requireBilinearWithNN=e.isBilinearWithStretchColorRamp,this._rasterColorizerConfig.stretchType=e.hasStretchTypeNone()?lh.Noop:lh.PerBand,this._techniques.precompile(Rd,this._rasterColorizerConfig),this._techniques.get(Rd,this._rasterColorizerConfig)}drawVectorData(e,i,r,s,a,n,o,l){let h=this._rctx,d=a.sourceLayerInfo.data,m=a.tile.surface.layerViewByIndex(a.layerIndex,_e.MAP),u=e.baseOpacity<1?nr.Required:nr.NotRequired,f=u===nr.Required||e.opacity<1||s!==kn.Normal||i!==Ei.Composite,g=f?js.On:js.Off,y=this._acquireBlendLayersTechnique(s,i,u,g);h.setPipelineState(y.getPipeline());let v=null,w=null;f?(w=this.currentFBO(r),this._vtFBO==null&&(this._vtFBO=new Pd(this._rctx)),v=this._vtFBO.get(r),h.bindFramebuffer(v),this._clearCurrentFBO()):l&&h.clear(Lt.DEPTH);try{this._vectorTileHelper.renderBackground(h,a.sourceLod,m.painter,m.layer.styleRepository,m.schemaHelper,Math.round(1/a.scale),a.offset,o,n,m.contentZoom),d&&this._vectorTileHelper.renderContent(h,a.sourceLod,d,a.vtlNeighborInfos,m.painter,m.layer.styleRepository,m.schemaHelper,Math.round(1/a.scale),a.offset,o,n,m.contentZoom)}catch(b){RO().warnOnce("A render call containing vector tiles did not resolve correctly.",b)}return!v||(h.bindFramebuffer(w),e.texture=v.colorTexture,e.offset=Po,e.scale=1,this.drawImageData(e,i,r,s,g),l)}copyFBOToTexture(e){let i=this._rctx,r=i.bindTexture(e.texture,Ft.TEXTURE_UNIT_FOR_UPDATES),s=e.descriptor;i.gl.copyTexImage2D(Tc.TEXTURE_2D,0,s.pixelFormat,0,0,s.width,s.height,0),e.generateMipmap(),i.bindTexture(r,Ft.TEXTURE_UNIT_FOR_UPDATES)}_clearCurrentFBO(){this._rctx.setStencilWriteMask(255),this._rctx.setClearColor(0,0,0,0),this._rctx.setClearDepth(1),this._rctx.setClearStencil(0),this._rctx.clear(Lt.COLOR|Lt.DEPTH|Lt.STENCIL)}_initFBO(e,i,r){this._rctx.bindFramebuffer(e),r&&(this._rctx.setViewport(0,0,i,i),this._clearCurrentFBO())}ensureBuffer(e){this._lastUsedIds.length=0,this._lastUsedIds.push(1),this._lastCreatedBufferId=1,this._onHoldIds.length=0,this.bind(e)}bind(e,i=0,r=!0){if(this._current=i,i>=this._fbos.length)for(let s=this._fbos.length;s<=i;s++)this._fbos.push(new Pd(this._rctx));this._initFBO(this._fbos[i].get(e),e,r)}_bindNextFreeBuffer(e){this._lastUsedIds.length>0?this.bind(e,this._lastUsedIds.pop()):(this._lastCreatedBufferId++,this.bind(e,this._lastCreatedBufferId))}openGroup(e){this._onHoldIds.push(this._current),this._bindNextFreeBuffer(e)}switch(e){let i=this.currentFBO(e),r=this._current;return this._bindNextFreeBuffer(e),this._lastUsedIds.push(r),i}getLastOnHoldId(){return this._onHoldIds[this._onHoldIds.length-1]}closeGroup(e){let i=this._current;this._bindNextFreeBuffer(e),this._lastUsedIds.push(i),this._lastUsedIds.push(this._onHoldIds.pop())}unbind(){this._rctx.bindFramebuffer(null)}currentFBO(e){return this._fbos[this._current].get(e)}};var Mf=class{constructor(){this.sourceLod=[0,0,0],this.offset=[0,0],this.scale=1,this.layerIndex=0,this.isVTLBackground=!1,this.vtlNeighborInfos=new Xe({allocator:e=>e||new A0})}},A0=class{constructor(){this.sourceLayerInfo=null,this.sourceLod=[0,0,0],this.offset=[-1,0]}};var Md=class{constructor(e,i){this._texture=e,this._cache=i,this.type="tile-texture",this._refCount=1}retain(){++this._refCount}release(){--this._refCount,this._refCount===0&&(this._cache?(this._texture.isCompressing&&this._texture.abortCompression(),this._cache.put(this._generateCacheKey(),this)):this.dispose())}dispose(){this._texture.dispose()}get texture(){return this._texture}generateMipmap(){this._texture.generateMipmap()}_generateCacheKey(){return`${this._texture.descriptor.width} ${this._texture.descriptor.pixelFormat}`+(kw(this._texture)?"compressed":"")}get descriptor(){return this._texture.descriptor}get cachedMemory(){return this._texture.usedMemory}};function E0(t){return t instanceof HTMLImageElement||t instanceof HTMLCanvasElement}var Af=class extends yw{constructor(e){super("TextureCompressionWorker","compress",{compress:i=>[i.data]},e)}isCompressible(e){return E0(e)}};var D0=class{constructor(e,i,r,s,a,n){this.start=e,this.end=i,this.blendMode=r,this.opacity=s,this.output=a,this.baseOpacity=n}},pn=class extends te{constructor(t){super(t),this._passParameters=new Sf,this._backgroundTexture=null,this._backgroundColor=null,this._backgroundDirty=!1}initialize(){this._maxAnisotropy=this.rctx.parameters.maxMaxAnisotropy,this._compositor=new Pf(this.rctx,this.techniques),this._ensureBackgroundTexture(this.tileSize),this.texturesBeingCompressed=0}dispose(){this._compositor=ge(this._compositor),this._backgroundTexture=ai(this._backgroundTexture)}get backgroundIsGrid(){return this._backgroundColor==null}get backgroundColor(){return this._backgroundColor}updateHeading(t){this._compositor?.updateHeading(t)}updateTileTexture(t,e){if(!t.renderData)return;let i=t.surface,r=i.baseOpacity,s=0,a=0,n=this.tileSize,o=!1,l=!1,h=i.view.state.contentPixelRatio,d=!1;Ef.clear(),Uh.length=0;let m=t.layerInfo[_e.MAP],u=0,f=null;for(;u<m.length;u++){let v=i.layerViewByIndex(u,_e.MAP),w=v.layer,b=!zs(t,v),R=w.opacity,C=v.fullOpacity;if(l=l||Pl(w),Hn(v)){let M=v.layer.blendMode!=="normal";if(vn(w.parent)){let E=w.parent.uid;E!=null&&E!==""&&(M=LR(w.parent)||M)}M&&(d=M,o=!1)}if((b||R===0)&&!d){m[u].pendingUpdates&=~(se.TEXTURE_NOFADING&se.TEXTURE_FADING);continue}++a;let x=rh(v),T=O0(t,u,x);if(T){if(m[u].pendingUpdates&=~(se.TEXTURE_NOFADING&se.TEXTURE_FADING),vn(w.parent)){let M=w.parent.uid;M!=null&&M!==""&&NR(w.parent,u)}x?n=Math.max(n,this.tileSize*h):r===1&&C===1&&(v.isOpaque||this._dataToTexture(T)&&T.sourceLayerInfo.data.descriptor.isOpaque)&&(o=!0),++s,f===null&&(f=u)}}let g=n/this.tileSize,y=this._ensureBackgroundTexture(this.tileSize);s!==0&&f!==null?s===1&&!d&&this._useLayerTexture(t,f)||this._composeLayers(t,e,u-1,l,n,g,!o||d,Ef,d):MO(t,a,y,e!==Ct.FADING)}_ensureBackgroundTexture(t){return this._backgroundTexture==null&&(this._backgroundTexture=this._buildTexture(t,!1),this._backgroundDirty=!0),this._backgroundDirty&&(this._compositor.bind(t),this._passParameters.offset=Po,this._passParameters.scale=1,this._passParameters.opacity=1,this.backgroundColor&&(this._passParameters.backgroundColor=this.backgroundColor),this._compositor.drawBackground(this._passParameters,this.backgroundColor!=null),this._compositor.copyFBOToTexture(this._backgroundTexture),this._compositor.unbind(),this._backgroundDirty=!1),this._backgroundTexture}_useLayerTexture(t,e){let i=t.surface.layerViewByIndex(e,_e.MAP),r=Pl(i.layer),s=r?t.surface.baseOpacity:1,a=r?1:t.surface.baseOpacity,n=i.fullOpacity,o=O0(t,e,!1);return!!this._dataToTexture(o)&&(t.renderData.setTextureReference(new mo(o.sourceLayerInfo.data,Ct.FADING,rr(o.offset[0],o.offset[1],o.scale,o.scale),s,a,n)),!0)}_composeLayers(t,e,i,r,s,a,n,o,l){this._compositor.ensureBuffer(s);let h=t.surface.baseOpacity,d=!1,m=yr.LINEAR_MIPMAP_LINEAR,u=!1,f=0;for(let w=i;w>=0;w--){let b=t.surface.layerViewByIndex(w,_e.MAP),R=b.layer,C=rh(b),x=O0(t,w,C),T=R.opacity,M=!zs(t,b);if(!x||(T===0||M)&&!l)continue;let E=!Pl(R)&&!d;E&&(d=!0);let O=!1;o.forEach(X=>{X.start===w&&(X.output=r?Ei.Composite:n&&E?this.backgroundIsGrid?Ei.GridComposite:Ei.ColorComposite:Ei.Composite,X.baseOpacity=E?h:1,Uh.push(X),this._compositor.openGroup(s),O=!0)});let Z=f===0,H=O?Ei.GroupBackgroundComposite:n&&Z?this.backgroundIsGrid?Ei.GridComposite:Ei.ColorComposite:Ei.Composite,B=Hc[Hn(b)?b.layer.blendMode:"normal"];for(this._passParameters.baseOpacity=E&&!O&&h<1?h:1,this._passParameters.opacity=T,ZT(x)?u=this._compositor.drawVectorData(this._passParameters,H,s,B,x,a,this.tileSize,u):$T(x)?(this._compositor.drawRasterData(this._passParameters,H,s,B,x),PO(x)&&(m=yr.NEAREST)):this._dataToTexture(x)&&(this._passParameters.texture=x.sourceLayerInfo.data.texture,this._passParameters.offset=x.offset,this._passParameters.scale=x.scale,this._compositor.drawImageData(this._passParameters,H,s,B));Uh.length>0&&Uh[Uh.length-1].end===w;){let X=Uh.pop();this._passParameters.baseOpacity=X.baseOpacity,this._passParameters.opacity=X.opacity,this._passParameters.offset=Po,this._passParameters.scale=1,this._compositor.drawGroup(this._passParameters,X.output,s,Hc[X.blendMode])}f++}let g=t.renderData,y=l||d&&h<1,v=g.ensureTexture(s,y,e,()=>this._buildTexture(s,y,m));this._compositor.copyFBOToTexture(v),this._compositor.unbind(),g.setTextureReference(new mo(v,e,FR,d?1:h,0,1))}_dataToTexture(t){if(KT(t)){let e=t.sourceLayerInfo,i=t.scale===1;e.data=this._buildTexture(e.data,!0,i),t.tile.setMemoryDirty()}return YT(t)}setBackground(t){this._backgroundColor!==t&&(this._backgroundColor=t,this._backgroundDirty=!0)}_buildTexture(t,e,i=yr.LINEAR_MIPMAP_LINEAR){if(t==null)return null;let r=new Ot;r.wrapMode=Jt.CLAMP_TO_EDGE,r.samplingMode=typeof i=="boolean"?yr.LINEAR_MIPMAP_LINEAR:i,r.maxAnisotropy=this._maxAnisotropy,r.preMultiplyAlpha=!0,r.flipped=!0,r.hasMipmap=!0,e||(r.pixelFormat=St.RGB);let s=this.rctx,a=typeof i=="boolean"&&i,n;if(typeof t=="number")r.width=r.height=t,n=this._buildTileTexture(r,t);else if(ih(t))r.isOpaque=t.isOpaque,r.isOpaque&&(r.pixelFormat=St.RGB),n=this._buildTileTexture(r,t.element.width,a,t.element);else try{r.width=t.width,r.height=t.height,n=this._buildTileTexture(r,t.width,a,t)}catch{n=new Md(xm(s)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}let o=s.bindTexture(n.texture,Ft.TEXTURE_UNIT_FOR_UPDATES);return n.generateMipmap(),s.bindTexture(o,Ft.TEXTURE_UNIT_FOR_UPDATES),n}_buildTileTexture(t,e,i=!1,r){let s=`${e} ${t.pixelFormat}`,a=this.cache.pop(s)??this.cache.pop(s+"compressed");if(i&&=E0(r),a)return a.retain(),i&&a.texture.enableCompression(!0),a.texture.setData(r),a;t.shouldCompress=i;let n=new Ft(this.rctx,t,r);return n.isCompressing&&(this.texturesBeingCompressed++,this.addHandles([P(()=>n.isCompressing,o=>{o?this.texturesBeingCompressed++:this.texturesBeingCompressed--},we)])),new Md(n,this.cache)}get test(){}};function O0(t,e,i){Xi.layerIndex=e,Xi.vtlNeighborInfos.clear();let r=t.layerInfo[_e.MAP][e];if(hs(Xi.offset,0,0),Xi.tile=t,Xi.scale=1,Xi.sourceLod=t.lij,Xi.sourceLayerInfo=r,Xi.isVTLBackground=i,r.data)return i&&t.forEachLoadedNeighbor((n,o)=>{if(n.level!==t.level)return;let l=n.layerInfo[_e.MAP][e];if(!XT(l)||r.data===l.data)return;let h=Xi.vtlNeighborInfos.pushNew();h.offset=dn[o],h.sourceLod=n.lij,h.sourceLayerInfo=l}),Xi;let s=r.upsampleInfo,a=s?.tile?.layerInfo[_e.MAP][e];return a&&s.tile?(Xi.tile=s.tile,gr(Xi.offset,s.offset),Xi.scale=s.scale,Xi.sourceLod=s.tile.lij,Xi.sourceLayerInfo=a,Xi):i?Xi:null}function PO(t){let e=t.sourceLayerInfo.data;return!!e.source&&e.interpolation==="nearest"}function LR(t){let e=t.blendMode!=="normal";return vn(t.parent)&&(e=LR(t.parent)||e),e}function NR(t,e){vn(t.parent)&&NR(t.parent,e);let i=t.uid;if(i!=null&&i!==""){let r=Ef.get(i);r?r.start=e:Ef.set(i,new D0(e,e,t.blendMode,t.opacity,Ei.Composite,1))}}function MO(t,e,i,r){let s=t.renderData,a=!r&&s.textureReference!=null&&(t.surface.view.layerViewManager.updating||e>0)?Da.Delayed:Da.Immediate;s.setTextureReference(new mo(i,Ct.FADING,FR,t.surface.baseOpacity,0,1),a)}c([p({constructOnly:!0})],pn.prototype,"rctx",void 0),c([p({constructOnly:!0})],pn.prototype,"techniques",void 0),c([p({constructOnly:!0})],pn.prototype,"cache",void 0),c([p()],pn.prototype,"tileSize",void 0),c([p()],pn.prototype,"texturesBeingCompressed",void 0),pn=c([S("esri.views.3d.terrain.TileRenderer")],pn);var Ef=new Map,Uh=new Array,Xi=new Mf,FR=rr(0,0,1,1),dn=new Array;dn[gt.NORTH]=[0,-1],dn[gt.NORTH_EAST]=[-1,-1],dn[gt.EAST]=[-1,0],dn[gt.SOUTH_EAST]=[-1,1],dn[gt.SOUTH]=[0,1],dn[gt.SOUTH_WEST]=[1,1],dn[gt.WEST]=[1,0],dn[gt.NORTH_WEST]=[1,-1];var HR=200,I0=40,AO=.8,EO=10,L0=1e-6;function OO(t,e,i){let r=e,s=i,a=0,n=1/0;for(let o=0;o<3;++o){{let l=t[o];if(r[o]<l){if(s[o]<=L0)return!1;let h=(l-r[o])/s[o];a=Math.max(a,h)}else if(s[o]<=-1e-6){let h=(l-r[o])/s[o];n=Math.min(n,h)}if(a>n)return!1}{let l=t[o+3];if(r[o]>l){if(s[o]>=-1e-6)return!1;let h=(l-r[o])/s[o];a=Math.max(a,h)}else if(s[o]>=L0){let h=(l-r[o])/s[o];n=Math.min(n,h)}if(a>n)return!1}}return!0}var Of=class{constructor(e,i,r,s,a){this.aabb=e,this.axis=i,this.d=r,this.midStartIndex=s,this.rightStartIndex=a}},qR=(()=>{class t{constructor(i,r,s,a){this.globalTriangleVertexIndices=i,this.firstTriangleIndex=r,this.positions=a,this._rayDirection=_(),this._callback=UR,this._intersectionOptions=VR,this.bspNodeTree=new Array;let n=s-r,o=new(n<FO?Uint8Array:n<VO?Uint16Array:Uint32Array)(n);this.triangleIndexMap=o;for(let l=0;l<n;++l)o[l]=l;{let l=NO(i,r,s,a.data,a.stride),h=N(Math.log2(n/I0),2,EO),d=(m,u,f)=>{let g=IO(o,l,m,u),y=u-m;if(y<=I0){let x=new Of(g,void 0,0,m,u);return this.bspNodeTree.push(x),x}let{axis:v,midValue:w}=LO(g),b=DO(o,l,m,u,v,w),R=(x,T)=>{if(f>h)return;let M=T-x;return M<I0||M>=AO*y?void 0:d(x,T,f+1)},C=new Of(g,v,w,b.next,b.mid);return this.bspNodeTree.push(C),C.leftNode=R(m,b.next),C.rightNode=R(b.mid,u),C};d(0,n,0)}}intersectRayTriangleRange(i,r){if(i>=r)return;let s=this.positions;$p(this._rayFrom,this._rayDirection,i,r,this.globalTriangleVertexIndices,s.data,s.stride,this._intersectionOptions.normalRequired,this._callback,this.triangleIndexMap,this.firstTriangleIndex),t.numFacesTested+=r-i}intersectRay(i,r,s,a){t.numFacesTested=0;let n=i,o=r,l=o[0]-n[0],h=o[1]-n[1],d=o[2]-n[2];if(l*l+h*h+d*d<L0)return;this._rayFrom=n;let m=this._rayDirection;m[0]=l,m[1]=h,m[2]=d;let u=this.triangleIndexMap.length;this._callback=a,this._intersectionOptions=s,this.intersectRayBSP(this.bspNodeTree[0],0,u),this._callback=UR,this._intersectionOptions=VR}intersectRayBSP(i,r,s){let a=this._rayFrom,n=this._rayDirection;if(!OO(i.aabb,a,n))return;let o=i.axis,l=i.d;if(a[o]<l||n[o]<0){let h=r,d=i.midStartIndex;if(h<d){let m=i.leftNode;m!==void 0?this.intersectRayBSP(m,h,d):this.intersectRayTriangleRange(h,d)}}if(this.intersectRayTriangleRange(i.midStartIndex,i.rightStartIndex),a[o]>l||n[o]>0){let h=i.rightStartIndex,d=s;if(h<d){let m=i.rightNode;m!==void 0?this.intersectRayBSP(m,h,d):this.intersectRayTriangleRange(h,d)}}}get estimatedMemoryUsage(){return this.triangleIndexMap.byteLength}}return t.numFacesTested=0,t})(),Hh=[1/0,1/0,1/0],qh=[-1/0,-1/0,-1/0];function DO(t,e,i,r,s,a){let n=i,o=r;for(;n<o;){let h=t[n];e[6*h+s+3]<=a?++n:(--o,t[n]=t[o],t[o]=h)}let l=n;for(o=r;l<o;){let h=t[o-1];e[6*h+s]>=a?--o:(t[o-1]=t[l],t[l]=h,++l)}return{next:n,mid:l}}function IO(t,e,i,r){if(r<=i)return dg(NaN,NaN,NaN,NaN,NaN,NaN);{let s=6*t[i];for(let a=0;a<3;++a)Hh[a]=e[s+0+a],qh[a]=e[s+3+a]}for(let s=i+1;s<r;++s){let a=6*t[s];for(let n=0;n<3;++n)Hh[n]=Math.min(Hh[n],e[a+0+n]),qh[n]=Math.max(qh[n],e[a+3+n])}return dg(Hh[0],Hh[1],Hh[2],qh[0],qh[1],qh[2])}function LO(t){let e=t[3]-t[0],i=t[4]-t[1],r=t[5]-t[2],s=e>i?e>r?0:i>r?1:2:i>r?1:r>e?2:0;return{axis:s,midValue:(t[s]+t[s+3])/2}}function NO(t,e,i,r,s){let a=i-e,n=new Float32Array(6*a);for(let o=0;o<a;++o){let l=3*(o+e),h=t[l]*s,d=t[l+1]*s,m=t[l+2]*s;for(let u=0;u<3;++u){let f=r[h+u],g=r[d+u],y=r[m+u];n[6*o+u]=Math.min(f,g,y),n[6*o+3+u]=Math.max(f,g,y)}}return n}var FO=255,VO=65535,VR=new Zl,UR=()=>{};var Ii=class extends ab{constructor(e){super(),this.spherical=e,this.overlayMode=Eg.Disabled,this.tileBlendInput=Gn.LayerOnly,this.transparencyMode=or.Opaque,this.pbrMode=Ql.Simplified,this.doublePrecisionRequiresObfuscation=!1,this.receiveShadows=!1,this.backfaceCullingEnabled=!1,this.textureFadingEnabled=!1,this.renderOccluded=!1,this.screenSpaceReflections=!1,this.cloudReflections=!1,this.tileBorders=!1,this.visualizeNormals=!1,this.screenSizePerspective=!1,this.receiveAmbientOcclusion=!1,this.normalType=bw.Compressed,this.textureCoordinateType=Bw.Compressed,this.highStepCount=!1,this.useCustomDTRExponentForWater=!1,this.useFillLights=!1,this.hasColorTexture=!0,this.canHaveOverlay=!0}};c([ht({count:Eg.COUNT})],Ii.prototype,"overlayMode",void 0),c([ht({count:Gn.COUNT})],Ii.prototype,"tileBlendInput",void 0),c([ht({count:or.COUNT})],Ii.prototype,"transparencyMode",void 0),c([ht({count:Ql.COUNT})],Ii.prototype,"pbrMode",void 0),c([ht()],Ii.prototype,"doublePrecisionRequiresObfuscation",void 0),c([ht()],Ii.prototype,"receiveShadows",void 0),c([ht()],Ii.prototype,"backfaceCullingEnabled",void 0),c([ht()],Ii.prototype,"textureFadingEnabled",void 0),c([ht()],Ii.prototype,"renderOccluded",void 0),c([ht()],Ii.prototype,"screenSpaceReflections",void 0),c([ht()],Ii.prototype,"cloudReflections",void 0),c([ht()],Ii.prototype,"tileBorders",void 0),c([ht()],Ii.prototype,"visualizeNormals",void 0),c([ht()],Ii.prototype,"screenSizePerspective",void 0),c([ht()],Ii.prototype,"receiveAmbientOcclusion",void 0);var N0=7,UO=10,F0=El(),qr=class extends kl{get _isGlobal(){return this._stage.viewingMode===me.Global}get _techniques(){return this._context.techniques}get _rctx(){return this._context.renderContext.rctx}constructor(t,e,i,r,s){super({}),this._overlayRenderer=t,this._stage=e,this._allTiles=i,this._ellipsoidRadius=r,this.type=Us.TERRAIN,this.isGround=!0,this._passParameters=new BC,this._drawParameters=new Mw,this._renderDataPool=new rs(pf),this._visiblePatchesByOrigin=new Map,this._allPatchesByOrigin=new Map,this._patchesByOriginDirty=!0,this._patchSortingDirty=!0,this._tileIterator=new Cm,this._castShadows=!1,this._inViewshed=!1,this._emptyTex=null,this._tileRenderer=null,this._stencilEnabledLayerExtents=new Array,this._numTilesRendered=0,this._numTilesCulled=0,this._numOriginsRendered=0,this.renderOccludedFlags=fi.Occlude,this.produces=new Map([[Y.OPAQUE_TERRAIN,()=>this._produces()&&this.transparency===or.Opaque],[Y.TRANSPARENT_TERRAIN,()=>this._produces()&&(this.transparency===or.Transparent||this.transparency===or.InvisibleWithDraped)],[Y.OCCLUDED_TERRAIN,()=>this._produces()]]),this._tileSize=256,this._configuration=new Ii(e.viewingMode===me.Global),this._tileTextureCache=new xs((a,n)=>s.newCache(a,n),"TileTexture"),this.tileGeometryCache=new xf(s)}normalizeCtorArgs(){return{}}initialize(){this._stage.addRenderPlugin(this),this.addHandles(P(()=>this._overlayRenderer.rendersOccludedDraped,t=>{this.renderOccludedFlags=t?Ig:fi.Occlude,this.setNeedsRender()},we))}destroy(){this._stage.removeRenderPlugin(this),this._tileTextureCache.destroy(),this.tileGeometryCache.destroy()}_produces(){return this.visible&&!!this._rootTiles&&!this.renderingDisabled}consumes(){return this._overlayRenderer.hasWater?Rw:Sw}set renderingDisabled(t){this._set("renderingDisabled",!!t),this.setDirty()}set visible(t){this._set("visible",!!t),this.setDirty()}updateHeading(t){this._tileRenderer?.updateHeading(t)}set transparency(t){this._configuration.transparencyMode!==t&&(this._configuration.transparencyMode=t,this.setNeedsRender())}get transparency(){return this._configuration.transparencyMode}get tileRenderer(){return this._tileRenderer}get texturesBeingCompressed(){return this._tileRenderer?this._tileRenderer?.texturesBeingCompressed:null}get renderPatchBorders(){return this._configuration.tileBorders}set renderPatchBorders(t){this._configuration.tileBorders!==t&&(this._configuration.tileBorders=t,this.setNeedsRender(),this.notifyChange("renderPatchBorders"))}get visualizeNormals(){return this._configuration.visualizeNormals}set visualizeNormals(t){this._configuration.visualizeNormals!==t&&(this._configuration.visualizeNormals=t,this.setNeedsRender(),this.notifyChange("visualizeNormals"))}get cullBackFaces(){return this._configuration.backfaceCullingEnabled}set cullBackFaces(t){this._configuration.backfaceCullingEnabled!==t&&(this._configuration.backfaceCullingEnabled=t,this.notifyChange("cullBackFaces"),this.setNeedsRender())}set renderOrder(t){this._set("renderOrder",t),this._setSortingDirty()}get layerUid(){return Za}get slicePlaneEnabled(){return this._configuration.hasSlicePlane}set slicePlaneEnabled(t){this._configuration.hasSlicePlane!==t&&(this._configuration.hasSlicePlane=t,this.setNeedsRender())}set textureFadingEnabled(t){this._configuration.textureFadingEnabled!==t&&(this._configuration.textureFadingEnabled=t,this.setNeedsRender())}set pbrMode(t){this._configuration.pbrMode!==t&&(this._configuration.pbrMode=t,this.setNeedsRender())}setDebugScreenSizePerspective(t){this._configuration.screenSizePerspective!==t&&(this._configuration.screenSizePerspective=t,this.setNeedsRender())}setRootTiles(t){this._rootTiles=t,this.setDirty()}setStencilEnabledLayerExtents(t){this._stencilEnabledLayerExtents=t,this._setSortingDirty()}set tileSize(t){this._tileSize=t,this._tileRenderer!=null&&(this._tileRenderer.tileSize=t),this.setDirty()}get tileSize(){return this._tileSize}_ensureRenderData(t){t.renderData||(t.renderData=this._renderDataPool.acquire(),t.renderData.init(t,this._getLocalOriginOfTile(t)))}loadTile(t){this._ensureRenderData(t),this.updateTileGeometryState(t),this.reuseTextureFromParent(t)||this.updateTileTexture(t,se.TEXTURE_FADING)}reuseTextureFromParent(t){let e=t.parent;if(!e)return!1;let i=rr(1&t.lij[2]?.5:0,1&t.lij[1]?0:.5,.5,.5);return e.renderData?.reuseTexture(t.renderData,i)??!1}updateTileTexture(t,e){this._tileRenderer!=null&&(this._tileRenderer.updateTileTexture(t,e===se.TEXTURE_FADING?Ct.FADING:Ct.UNFADED),this.setNeedsRender(),t.resetPendingUpdate(e))}updateTileGeometryState(t){for(let i of t.layerInfo[_e.ELEVATION])i.pendingUpdates&=~se.GEOMETRY;t.resetPendingUpdate(se.GEOMETRY);let e=t.renderData.updateGeometryState();return e&&this.setDirty(),e}updateGeometryIfNeeded(t){t.loaded&&t.renderData.updateGeometryIfNeeded(this._rctx)}unloadTile(t){let e=t.renderData;e&&(e.releaseGeometry(),this._renderDataPool.release(e),e.clear(),t.renderData=null,t.setMemoryDirty(),this.setDirty())}_getLocalOriginOfTile(t){let e=UO-N0,i=Math.max(0,Math.floor((t.level-e)/N0)*N0);if(this._isGlobal&&i===0)return Ls;for(;t.parent&&t.level>i;)t=t.parent;return t.centerAtSeaLevel}getStats(){return{numTilesRendered:this._numTilesRendered,numTilesCulled:this._numTilesCulled,numOriginsRendered:this._numOriginsRendered}}set wireframe(t){this._get("wireframe")!==t&&(this._set("wireframe",t),this.setNeedsRender())}setDirty(t=oe.UPDATE){this._patchesByOriginDirty=!0,this._context.requestRender(t)}_setSortingDirty(t=oe.UPDATE){this._patchSortingDirty=!0,this._context.requestRender(t)}setNeedsRender(t=oe.UPDATE){this._context.requestRender(t)}initializeRenderContext(t){this._context=t,this._tileRenderer=new pn({rctx:this._rctx,tileSize:this._tileSize,techniques:this._techniques,cache:this._tileTextureCache}),this.updateTileBackground(),this._emptyTex=xm(this._rctx)}uninitializeRenderContext(){this._emptyTex=ge(this._emptyTex),this._tileRenderer=ge(this._tileRenderer)}intersect(t,e,i,r){if(!this._rootTiles||t.options.selectOpaqueTerrainOnly&&t.options.selectionMode&&this.transparency!==or.Opaque)return;let s=HO,a=qO;ae(s,r,i),xe(a,1/s[0],1/s[1],1/s[2]);let n=t.results.min,o=t.results.max,l=t.results.ground,h=t.options.store===ps.MIN,d=!!t.results.ground.target,m=Xw(t.verticalOffset),u=t.tolerance,f,g=h&&n.dist!=null?n.dist:1/0,y=t.options,v=y.normalRequired||!y.backfacesTerrain,w=new Zl(!1,v),b=C=>{let x=C.renderData;if(!x?.vao)return;let T=x.geometry;w1(F0,T.boundingBox);let M=x.localOrigin;m!=null&&(m.localOrigin=M,m.applyToAabb(F0));let E=F0;if(Bh[0]=i[0]-M[0],Bh[1]=i[1]-M[1],Bh[2]=i[2]-M[2],!Zp(E,Bh,a,u,g))return;let O=(W,ve,ue)=>{W.set(this.type,C,ve,ue,xn),g=h&&n.dist!=null?n.dist:1/0},Z=(W,ve,ue)=>{if((!v||ue!=null)&&W>=0&&(y.backfacesTerrain||$(ue,s)<0)&&(y.invisibleTerrain||!y.selectionMode||e==null||e(i,r,W))){if((l.dist==null||W<l.dist)&&O(l,W,ue),y.isFiltered)return;y.store===ps.ALL&&(f==null?(f=Jw(t.ray),O(f,W,ue),t.results.all.push(f)):W<f.dist&&O(f,W,ue)),(n.dist==null||W<n.dist)&&O(n,W,ue),y.store!==ps.MIN&&(o.dist==null||W>o.dist)&&O(o,W,ue)}},H=BO;ae(H,r,M);let{indices:B,indexCount:X}=T,I=T.vertexAttributes,A=I.getField(Et.POSITION,L1),re=new cw(A.typedBuffer,3,I.stride/4),U=X/3;if(!m&&U>HR){let W=C.renderData;W.intersectionData==null&&(W.intersectionData=new qR(B,0,U,re)),W.intersectionData.intersectRay(Bh,H,w,Z)}else tb(Bh,H,0,U,B,re,m,w,Z)},R=this._rootTiles;R!=null&&(()=>{let C=this._tileIterator;C.reset(R);let x=t.options.invisibleTerrain;for(let T=C.next();T;T=C.next())!(T.visible||x&&T.intersectsClippingArea)||m==null&&!T.intersectsRay(i,s,u,g)||d&&this._useStencilForTile(T)?C.skipSubtree():b(T)})()}processScaleRangeQueries(t,e){if(!e.done)for(this._updatePatchGroups();t.updating&&!e.done;){t.prepare();for(let i of this._visiblePatchesByOrigin.values())for(let r of i)r.renderData?.textureReference!=null&&t.queriesForTile(r);t.process(),e.madeProgress()}}acquireTechniques(t){let e=!!Yt("enable-feature:terrain-shadows")&&t.bind.shadowMap.enabled;e!==this._castShadows&&(this._castShadows=e,this._patchesByOriginDirty=!0);let i=t.bind.viewshedEnabled;if(this._inViewshed!==i&&(this._inViewshed=i,this._patchesByOriginDirty=!0),t.bind.slot===Y.OCCLUDED_TERRAIN){if(!(t.renderOccludedMask&Ig))return null}else{let r=this.transparency===or.Opaque?Y.OPAQUE_TERRAIN:Y.TRANSPARENT_TERRAIN;if(t.bind.slot!==r)return null}if(this.transparency===or.Invisible)return null;switch(this._configuration.screenSpaceReflections=this._configuration.cloudReflections=this._configuration.receiveShadows=this._configuration.receiveAmbientOcclusion=!1,this._configuration.overlayMode=this._overlayRenderer.mode,t.output){case j.Color:case j.ColorEmission:return this._configuration.screenSpaceReflections=t.bind.ssr.lastFrameColor!=null,this._configuration.cloudReflections=t.bind.clouds.data!=null,this._configuration.receiveShadows=t.bind.shadowMap.ready,this._configuration.receiveAmbientOcclusion=t.bind.ssao!=null,this._acquireTechnique(t.output,t.bind.slot===Y.OCCLUDED_TERRAIN);case j.Shadow:case j.ShadowExcludeHighlight:return this._castShadows?this._acquireTechnique(j.Shadow,!1):null;case j.ViewshedShadow:return this._inViewshed?this._acquireTechnique(j.ViewshedShadow,!1):null;case j.Depth:case j.Normal:return this._acquireTechnique(t.output,!1);case j.ObjectAndLayerIdColor:return this._acquireTechnique(j.ObjectAndLayerIdColor,!1);case j.Highlight:return this._overlayRenderer.hasHighlights?this._acquireTechnique(j.Highlight,!1):null}return null}render(t,e){switch(this._updatePatchGroups(),e.useStencil=!1,t.output){case j.Color:case j.ColorEmission:{let i=t.bind.slot===Y.OCCLUDED_TERRAIN?Vn.Occluded:Vn.Color;this._renderMaterialPass(t,e,i);break}case j.Depth:case j.Normal:this._renderAuxiliaryPass(t,e,Vn.Color,this._visiblePatchesByOrigin);break;case j.Highlight:{let i=t.bind.highlight?.name;i&&this._overlayRenderer.hasHighlights&&this._overlayRenderer.renders(Vn.Highlight)&&this._overlayRenderer.hasHighlightOptions(i)&&this._renderAuxiliaryPass(t,e,Vn.Highlight,this._visiblePatchesByOrigin);break}case j.Shadow:case j.ShadowExcludeHighlight:case j.ViewshedShadow:this._renderAuxiliaryPass(t,e,null,this._allPatchesByOrigin);break;case j.ObjectAndLayerIdColor:this._renderAuxiliaryPass(t,e,Vn.ObjectAndLayerIdColor,this._visiblePatchesByOrigin)}}updateTileBackground(t){if(this._tileRenderer==null)return;let e=this._tileRenderer,i;if(t!=null){let r=Dp.toUnitRGBA(t);i=xt(r[0]||0,r[1]||0,r[2]||0)}e.setBackground(i),this._allTiles.forAll(r=>e.updateTileTexture(r,Ct.FADING)),this._configuration.tileBlendInput=e.backgroundIsGrid?Gn.GridComposite:e.backgroundColor!=null?Gn.ColorComposite:Gn.LayerOnly,this.setNeedsRender()}_updatePatchGroups(){if(this._patchesByOriginDirty&&(this._rebuildPatchGroups(),this._patchesByOriginDirty=!1,this._patchSortingDirty=!0),this._patchSortingDirty&&this.renderOrder!==Uc.NONE){let t=Array.from(this._visiblePatchesByOrigin.values()),e=this._stencilEnabledLayerExtents;for(let i of t)hC(this.renderOrder,i,e);t.sort((i,r)=>cC(i[0],r[0],this.renderOrder)),this._visiblePatchesByOrigin=new Map(t.map(i=>[i[0].renderData.localOrigin,i])),this._patchSortingDirty=!1}}_rebuildPatchGroups(){let t=this._rootTiles;if(t!=null){t[0]?.surface.checkAllTilesWaterproofness(),this._visiblePatchesByOrigin.clear(),this._allPatchesByOrigin.clear();for(let e of t)this._rebuildPatchGroupsForRootTile(e)}}_rebuildPatchGroupsForRootTile(t){let e=this._tileIterator;for(e.resetOne(t);!e.done;){let i=e.next(),r=i.renderData;if(!r){this._numTilesCulled++;continue}let s=r.localOrigin;if(this._castShadows||this._inViewshed){let n=this._allPatchesByOrigin.get(s);n||(n=[],this._allPatchesByOrigin.set(s,n)),n.push(i)}if(!i.visible){this._numTilesCulled++,e.skipSubtree();continue}let a=this._visiblePatchesByOrigin.get(s);a||(a=[],this._visiblePatchesByOrigin.set(s,a)),a.push(i),e.skipSubtree()}}_useStencilForTile(t){for(let e of this._stencilEnabledLayerExtents)if(t.intersectsExtent(e))return!0;return!1}_renderAuxiliaryPass(t,e,i,r){let s=t.rctx;this._passParameters.overlayContent=i,s.bindTechnique(e,t.bind,this._passParameters);let a=this._stencilEnabledLayerExtents.length>0;r.forEach(n=>{this._drawParameters.origin=n[0].renderData.localOrigin,e.program.bindDraw(t.bind,this._passParameters,this._drawParameters);for(let o=0;o<n.length;o++)this._renderPatch(t,e,n[o],ft.TRIANGLES,a,i)}),t.rctx.bindVAO(null)}_renderMaterialPass(t,e,i){let{rctx:r}=t;this._passParameters.overlayContent=i,r.bindTechnique(e,t.bind,this._passParameters),this._numTilesRendered=0,this._numTilesCulled=0,this._numOriginsRendered=0;let s=t.bind.camera,a=e.program;if(this._configuration.screenSizePerspective&&this.pointsOfInterest){let m=zp(this._stage.viewingMode,this._ellipsoidRadius),u=this.pointsOfInterest.centerOnSurfaceFrequent.distance;m.update({distance:u,fovY:s.fovY})}let n=this._stencilEnabledLayerExtents.length>0,o=i===Vn.Occluded;o&&(a.bindTexture("tex",this._emptyTex),a.setUniform3fv("textureOpacities",Ls),a.setUniform4fv("texOffsetAndScale",sr));let l=this._tileRenderer?.backgroundColor!=null?this._tileRenderer.backgroundColor:Ls;this._configuration.tileBlendInput===Gn.ColorComposite&&a.setUniform3fv("backgroundColor",l);let h=this.wireframe?ft.LINES:ft.TRIANGLES;this._configuration.textureFadingEnabled&&a.bindTexture("texNext",this._emptyTex);let d=this._visiblePatchesByOrigin;for(let m of d.values()){let u=m[0].renderData.localOrigin;this._drawParameters.origin=u,e.program.bindDraw(t.bind,this._passParameters,this._drawParameters),this._numOriginsRendered++;for(let f of m){let g=f.renderData,y=g.textureReference;if(y!=null){if(!o){a.setUniform4fv("texOffsetAndScale",y.offsetAndScale),a.bindTexture("tex",y.texture.texture);let v=g.textureFadeFactor,w=v<1?g.nextTextureReference:null;this._configuration.textureFadingEnabled&&w!=null&&v<1?(a.setUniform1f("fadeFactor",v),a.setUniform4fv("nextTexOffsetAndScale",w.offsetAndScale),a.setUniform3fv("nextTexOpacities",w.opacities),a.bindTexture("texNext",w.texture.texture)):a.setUniform1f("fadeFactor",1),g.textureIsFading&&this.setNeedsRender(),a.setUniform3fv("textureOpacities",y.opacities)}this._renderPatch(t,e,f,h,n,i),f.renderOrder=this._numTilesRendered,this._numTilesRendered++}}}t.rctx.bindVAO(null)}_renderPatch(t,e,i,r,s,a){let n=i.renderData,o=n.vao,l=o?.indexBuffer;if(!o||l==null)return void(oi&&console.error("Rendered tile with no indices: ",i.lij," : ",n));let h=e.program;a==null||this._overlayRenderer.isEmpty||this._bindOverlayPatchData(h,n.overlay),s&&(e.useStencil=this._useStencilForTile(i),t.rctx.setPipelineState(e.getPipeline()));let d=n.geometry.indexCount;t.rctx.bindVAO(o),h.assertCompatibleVertexAttributeLocations(o),t.rctx.drawElements(r,d,l.indexType,0)}_bindOverlayPatchData(t,e){t.setUniform4fv("overlayTexOffset",e.offsets),t.setUniform4fv("overlayTexScale",e.scales)}_acquireTechnique(t,e){return this._configuration.output=t,this._configuration.renderOccluded=e,this._techniques.get(df,this._configuration)}get test(){}hasHighlightOptions(t){return this._overlayRenderer.hasHighlightOptions(t)}};c([p({readOnly:!0})],qr.prototype,"_isGlobal",null),c([p()],qr.prototype,"renderOccludedFlags",void 0),c([p({value:!1})],qr.prototype,"renderingDisabled",null),c([p({value:!0})],qr.prototype,"visible",null),c([p()],qr.prototype,"texturesBeingCompressed",null),c([p()],qr.prototype,"renderPatchBorders",null),c([p()],qr.prototype,"visualizeNormals",null),c([p()],qr.prototype,"cullBackFaces",null),c([p({value:Uc.FRONT_TO_BACK})],qr.prototype,"renderOrder",null),c([p()],qr.prototype,"wireframe",null),qr=c([S("esri.views.3d.terrain.TerrainRenderer")],qr);var HO=_(),qO=_(),Bh=_(),BO=_();var Df=class{constructor(){this.numNodes=0,this.numLeaves=0,this.numVisible=0,this.numRendered=0,this.numSplit=0,this.numMerged=0,this.numRenderedPerLevel=new Array,this.numLoadedPerLevel=new Array}};var Ks=class extends te{constructor(t){super(t)}initialize(){this.addHandles([this.layers.on("change",()=>this._update()),P(()=>this.extentHelper.layerViewsExtent,()=>this._setAdHocTilingScheme())]),this._update(),this.tilingSchemeLocked||this._setAdHocTilingScheme()}destroy(){this._waitTask=null,this.layers.destroy()}_update(){if(this._waitTask=null,this.tilingSchemeLocked)return;let t;if(this.layers.some(e=>!(!yn(e)||e.isRejected())&&!(e.isFulfilled()&&!kO(e,this.viewSpatialReference,this.viewingMode))&&(t=e,!(e?.type==="vector-tile"||bm(e)))),t)if(t.isResolved()){let e=Fo(t,this.viewSpatialReference,this.viewingMode);if(e!=null){let i=new Lo(e.tileInfo);this._lockTilingScheme(i)}}else this._updateWhen(t)}_updateWhen(t){let e=t.when().catch(()=>{}).then(()=>{e!==this._waitTask||this.destroyed||this._update()});this._waitTask=e}_lockTilingScheme(t){if(this.viewingMode===me.Global){let e=t.levels.length-1,i=t.spatialReference;i.isWebMercator?t=Lo.makeWebMercatorAuxiliarySphere(e):jT(i)&&(t=Lo.makeGCSWithTileSize(t.spatialReference,t.pixelSize,e))}this.tilingSchemeLocked=!0,this.tilingScheme=t,this.extentHelper.tilingScheme=this.tilingScheme,this._updateTiledLayerExtent(),this.removeAllHandles(),this.addHandles(P(()=>this.extentHelper.tiledLayersExtent,()=>this._updateTiledLayerExtent()))}_updateTiledLayerExtent(){this._set("extent",this.extentHelper.tiledLayersExtent)}_setAdHocTilingScheme(){if(this.viewingMode===me.Global){let t=this.extentHelper.viewSpatialReference;t.isWebMercator?this.tilingScheme=Lo.WebMercatorAuxiliarySphere:zT(t)&&(this.tilingScheme=Lo.makeGCSWithTileSize(t,256)),this._set("extent",this.extentHelper.layerViewsExtent)}else{let t=this.extentHelper.layerViewsExtent;t==null||Ds(t,this.extent)||(this.tilingScheme=Lo.fromExtent(t,this.extentHelper.viewSpatialReference),this._set("extent",t))}}get test(){}};function kO(t,e,i){return Fo(t,e,i)!=null}c([p()],Ks.prototype,"tilingScheme",void 0),c([p({readOnly:!0})],Ks.prototype,"extent",void 0),c([p({value:!1})],Ks.prototype,"tilingSchemeLocked",void 0),c([p({constructOnly:!0})],Ks.prototype,"viewSpatialReference",void 0),c([p({constructOnly:!0})],Ks.prototype,"layers",void 0),c([p({constructOnly:!0})],Ks.prototype,"extentHelper",void 0),c([p({constructOnly:!0})],Ks.prototype,"viewingMode",void 0),Ks=c([S("esri.views.3d.terrain.TilingSchemeLogic")],Ks);var If=class{constructor(){this._offset=ji(),this.scale=0}get offset(){return this._offset}init(e,i,r,s){this.tile=e,this._offset[0]=i,this._offset[1]=r,this.scale=s}dispose(){this.tile=null,this._offset[0]=0,this._offset[1]=0,this.scale=0}};var Nf,Se=Nf=class extends tr.EventedMixin(te){get allTiles(){return this._allTiles}constructor(t){super(t),this._scaleRangeQueries=new Td,this._iteratorPool=new rs(Cm,e=>e.remove=()=>this._iteratorPool.release(e)),this._postorderIterator=new oC,this._hasPendingUpdates=!1,this._pendingUpdates=0,this._asyncWorkItems=0,this._allTilesDirty=!0,this._allTilesSorted=!0,this._usedMemory=null,this._performanceInfo=new Df,this._viewChanged=!1,this.heading=0,this._inFrameTask=!1,this._viewChangeUpdateDirty=!1,this._eyePosRenderSR=_(),this._eyePosSurfaceSR=_(),this._splitLimits=new Ms,this._frustum=yg(),this._layerViews=[new Array,new Array],this._layerIndexByUid=[new Map,new Map],this._basemapLayerViewHandles=new Map,this._watchUpdatingTracking=new Op,this._frameTask=So,this._allTiles=new Xe,this._upsampleInfoPool=new rs(If),this._shouldEmitChangeEvent=!1,this._destroying=!1,this._rootTilesExtent=kt(),this.updatingProgress=.5,this._maxNumUpdating=1,this.maxTextureScale=1.2,this._spatialReference=Kt.WebMercator,this._elevationProjectorCache=new Map,this.visibleElevationBounds=new Aa(1/0,-1/0),this.rootTileElevationBounds=new Aa(1/0,-1/0),this._projectorCache=new Map,this._radiusModifier=Math.cos(Math.PI/16/16),this._tilingSchemeSpatialReference=null,this._updatingRootTiles=!1,this._pendingTilesForElevationUpdateEvent=new Set,this._pendingTilesToUpdate=new Set,this.totalGeometryUpdates=0,this.totalTileUpdates=0,this._oneBatchPerFrameTask=!0,this._layerViewsDirty=!1,this.unloadedMemory=0,this.ignoresMemoryFactor=!1,this._isWebMercator=!1,this._isWebMercatorOnPlateCarree=!1,this.overlayManager=new pr(Bt(lt({},t),{surface:this})),this._isGlobal=!t.view?.state?.isLocal,this._isGeographic=this._spatialReference?.isGeographic??!1,this._tileConstructor=this._isGlobal?Cf:Tf,this._ellipsoid=Ue(t.view.spatialReference)}initialize(){let t=this.view,e=t.resourceController,i=e.memoryController;this._tileCache=new xs((l,h)=>i.newCache(l,h),"terrain-tile"),this._upsampleMapCache=i.newCache("terrain-upsample",l=>l.unloadMapData()),this._elevationQueryCache=new qC(i.newCache("elevation-query"));let r=this.overlayManager;this._renderer=new qr(r.renderer,t._stage,this._allTiles,this._ellipsoid.radius,i),this.addHandles([P(()=>r.renderer.isEmpty,()=>this._evaluateTransparency()),P(()=>this.renderer.visible,l=>this.suspended=!l),P(()=>this.heading,l=>{this._renderer.updateHeading(l),this._updateTileTextures(Ct.FADING)}),P(()=>({heading:t.camera?.heading,state:t.state?.mode}),({heading:l,state:h})=>{if(l==null)return;if(this.isGlobal&&this.isGeographic||this.isWebMercatorOnPlateCarree)return void(this.heading=90*Math.round(l/90)%360);let d=Math.round(l)%360,m=Math.abs(d-this.heading);(h===Zt.IDLE||Math.min(m,360-m)>=30)&&(this.heading=d)})],"overlayManager"),this.addHandles([P(()=>this.baseOpacity,()=>{this._handleLayerViewChanges(),this._updateTileTextures(this._evaluateTransparency()?Ct.UNFADED:Ct.IMMEDIATE)},ye),P(()=>this.hasCompositeBlendMode,()=>this._updateTileTextures(this._evaluateTransparency()?Ct.UNFADED:Ct.IMMEDIATE),ye),P(()=>this.backgroundColor,(l,h)=>{l?.equals(h)||(this._handleLayerViewChanges(),this._renderer.updateTileBackground(l))},we),P(()=>this.snapLevel,()=>this._viewChanged=!0,we),P(()=>this.view.pointsOfInterest,l=>{this._renderer.pointsOfInterest=l,this._watchUpdatingTracking.removeAll(),l&&this._watchUpdatingTracking.add(()=>l.focus.renderLocation,()=>this._allTilesSorted=!1)}),P(()=>ui.TERRAIN_TILE_TREE_SHOW_TILES,l=>{l&&!this._treeDebugger?import("./chunk-SNPKC3F5.js").then(({TerrainTileTree3DDebugger:h})=>{!this._treeDebugger&&ui.TERRAIN_TILE_TREE_SHOW_TILES&&(this._treeDebugger=new h({view:t}))}):l||(this._treeDebugger=G(this._treeDebugger))},Ie)]),this.addHandles([P(()=>this._renderer.tileRenderer?.texturesBeingCompressed,(l,h)=>{h&&l<h&&(this.setMemoryDirty(),this._allTiles.forAll(d=>d.setMemoryDirty()))})]),this.addHandles([P(()=>this._renderer.texturesBeingCompressed,(l,h)=>{l===0&&l!==h&&this.requestRender()})]);let{spatialReference:s}=t;this._extentHelper=zS(this.viewingMode,{layers:t.map.allLayers,layerViews:t.allLayerViews,viewSpatialReference:s});let a=new pb({getCollections:()=>t.defaultsFromMap?.mapCollections?.map(({layers:l})=>l),getChildrenFunction:l=>l&&"layers"in l?l.layers:null}),n=new Ks({layers:a,extentHelper:this._extentHelper,viewingMode:this.viewingMode,viewSpatialReference:s});this._set("tilingSchemeLogic",n),this._updateTilingScheme(),this._elevationDataRequester=e.createStreamDataRequester(Vc.ELEVATION),this._mapDataRequester=e.createStreamDataRequester(Vc.BASEMAP);let o=e.scheduler;this._frameTask=o.registerTask(ut.TERRAIN_SURFACE,this),this.addHandles([P(()=>this._extentHelper.stencilEnabledExtents,l=>this._renderer.setStencilEnabledLayerExtents(l),Ie),P(()=>this.tilingSchemeLogic.tilingScheme,()=>this._updateTilingScheme(),we),P(()=>this.extent,()=>this._updateRootTiles(),Ie),t.on("resize",()=>this._viewChangeUpdate()),P(()=>{let l=t.state;return[this._lodBias,this.lodSnappingEnabled,t.quality,l.camera,l.contentCamera,l.fixedContentCamera]},()=>this._viewChangeUpdate(),ye),P(()=>t.qualitySettings?.fadeDuration,l=>this._renderer.textureFadingEnabled=l>0,Ie),P(()=>t.qualitySettings?.physicallyBasedRenderingEnabled,l=>this._renderer.pbrMode=l?Ql.Simplified:Ql.Disabled,Ie),P(()=>t.qualitySettings?.tiledSurface.elevationLevelDelta,()=>this._updateAllTileGeometries()),P(()=>this._userClippingExtent,()=>this._updateClippingExtent(),we)]),this.addHandles(t.allLayerViews.on("after-changes",()=>this._layerViewsDirty=!0)),this._layerViewsDirty=!0,this._handleLayerViewChanges(),this._renderer.updateTileBackground(this.backgroundColor)}destroy(){this._destroying=!0,this._frameTask.remove(),this._watchUpdatingTracking.destroy(),this._removeAllTiles(),this._set("tilingSchemeLogic",G(this.tilingSchemeLogic)),this._basemapLayerViewHandles.forEach((t,e)=>this._unregisterTiledLayerView(e)),this._elevationDataRequester=null,this._mapDataRequester=null,this._set("overlayManager",G(this.overlayManager)),this._tileCache=G(this._tileCache),fo.prune(),this._treeDebugger=G(this._treeDebugger),this._renderer=G(this._renderer),this._iteratorPool=G(this._iteratorPool),this._upsampleMapCache=G(this._upsampleMapCache),this._elevationQueryCache=G(this._elevationQueryCache),this._set("view",null),this._extentHelper=G(this._extentHelper),this._upsampleInfoPool=G(this._upsampleInfoPool),JS()}get renderer(){return this._renderer}get frustum(){return this._frustum}get snapLevel(){if(this.lodSnappingEnabled){let{view:t,tilingScheme:e}=this,i=t.scale;if(e&&i){let r=e.levelAtScale(i)+t.qualitySettings.tiledSurface.lodBias,s=e.getMaxLod();return r<=0?null:Math.min(r,s||1/0)}}return null}get lodSnappingEnabled(){return this.view.qualitySettings.tiledSurface.reduceTileLevelDifferences}get upsampleInfoPool(){return this._upsampleInfoPool}get upsampleMapCache(){return this._upsampleMapCache}get elevationQueryCache(){return this._elevationQueryCache}get hasStencilEnabledExtents(){return this._extentHelper.stencilEnabledExtents.length>0}get _userClippingExtent(){let{spatialReference:t}=this,{clippingArea:e}=this.view;if(e==null||t==null)return null;let i=kt(),r=vm(e,i,t)?i:null,s=this._get("extent");return Ds(r,s)?s:r}get rootTilesExtent(){return this._rootTilesExtent}get extent(){let t=gc(this.groundExtent,this._userClippingExtent,kt()),e=this._get("extent");return Ds(t,e)?e:t}get groundExtent(){return this._tilingSchemeExtent!=null?this._tilingSchemeExtent:this._rootTilesExtent}get _tilingSchemeExtent(){return this.tilingSchemeLogic?.extent}get updating(){return this._hasPendingUpdates||(this._maxNumUpdating=1),!!((this.running||this._watchUpdatingTracking?.updating||this._asyncWorkItems>0)&&this.ready&&!this.suspended||this.overlayManager?.updating||this.renderer.texturesBeingCompressed)}get running(){return(this._hasPendingUpdates||this._viewChanged||this._allTilesDirty||!this._allTilesSorted||this._layerViewsDirty||this._scaleRangeQueries.updating||this._frameTask.updating)&&this.ready&&!this.suspended}get updatingProgressValue(){return this._maxNumUpdating=Math.max(this._pendingUpdates,this._maxNumUpdating),1-this._pendingUpdates/this._maxNumUpdating}get baseOpacity(){return this.view?.map?.ground?.opacity??1}set baseOpacity(t){this.view.map.ground.opacity=t}get viewingMode(){return this.view.state.viewingMode}get ready(){return this._rootTiles!=null}set renderOrder(t){this._renderer.renderOrder=t,this._set("renderOrder",t)}get rootTiles(){return this._rootTiles}get spatialReference(){return this.tilingScheme?.spatialReference??null}get backgroundColor(){return this.view?.map?.ground?.surfaceColor}set backgroundColor(t){this.view.map.ground.surfaceColor=t}set slicePlaneEnabled(t){this._renderer.slicePlaneEnabled=t,this._set("slicePlaneEnabled",t),this._evaluateTransparency()}get tilingSchemeLocked(){return this.tilingSchemeLogic?.tilingSchemeLocked??!1}get wireframe(){return this._renderer?.wireframe}set wireframe(t){t!==this._renderer.wireframe&&(this._renderer.wireframe=t,this._updateAllTileGeometries())}get opaque(){return this._renderer.transparency===or.Opaque}set suspended(t){this._set("suspended",t),this._viewChangeUpdate()}get fadeDuration(){return this.view.qualitySettings.fadeDuration??0}intersect(t,e,i,r){this._renderer.intersect(t,e,i,r)}getElevationLevelDelta(t){return t<4?3:this.view.qualitySettings.tiledSurface.elevationLevelDelta}getElevation(t,e,i,r){let s=this._rootTiles;if(!s?.length||s[0].layerInfo[_e.ELEVATION].length===0)return null;let a=this._elevationProjectorCache.get(r);if(a===void 0&&(a=bc(r,this._spatialReference)??null,this._elevationProjectorCache.set(r,a)),a==null)return pe.getLogger(this).error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;let n=xe(Ad,t,e,i);return a(n,0,n,0),BR(s,n[0],n[1])}getElevations(t,e,i){let r=this._rootTiles,s=r?r[0].layerInfo[_e.ELEVATION].length:0;if(r?.length&&s!==0)for(let a=0;a<e;++a){let n=3*a;i(a,BR(r,t[n],t[n+1]))}else for(let a=0;a<e;++a)i(a,null)}getScale(t){if(!this.tilingScheme)return null;if(!Sn(t,Ad,this.spatialReference))return pe.getLogger(this).error("TerrainSurface.getScale(): could not project given point to tiling scheme coordinate system"),null;let e=this._rootTiles;if(e!=null){for(let i of e)if(i?.containsPoint(Ad)){let r=i;for(;r.children[0]&&!r.rendered;){let s=r.children[0].extent,a=0;Ad[0]>s[2]&&(a+=1),Ad[1]<s[1]&&(a+=2),r=r.children[a]}return this._getLodBiasCorrectedScale(r.level)}}return 1/0}_ensureProjector(t){let e=this._projectorCache.get(t);if(e)return e;let i=bc(t,this._tilingSchemeSpatialReference)??null;return this._projectorCache.set(t,i),i}getSphereElevationBounds(t,e){let i=this._ensureProjector(e);if(i==null)return pe.getLogger(this).error("TerrainSurface.getSphereElevationBounds(): could not project given point to tiling scheme coordinate system"),null;mw(t,kh);let r=kh;i(r,0,r,0);let s=new Bl,a=this._rootTiles;if(a!=null){let n=[];for(let l of a)n.push(l);let o=0;for(;o<n.length;){let l=n[o];if(++o,!ag(l.extent,kh))continue;let h=l.children;if(h[0]==null||l.rendered)s.expandElevationRangeValues(l.elevationBoundsMin,l.elevationBoundsMax);else for(let d of h)n.push(d)}}return s}getRootElevationBounds(){return new Bl(this.rootTileElevationBounds.min,this.rootTileElevationBounds.max)}getLowerBoundRadius(){let t=(this._ellipsoid.radius+this.visibleElevationBounds.min)*this._radiusModifier;return Math.min(t,this._ellipsoid.radius)}getSphereScale(t,e){if(!this.tilingScheme)return null;if(!Sn(t,kh,this.spatialReference))return pe.getLogger(this).error("TerrainSurface.getSphereScale(): could not project given point to tiling scheme coordinate system"),null;kh[3]=e;let i=null,r=a=>{if(a&&ag(a.extent,kh)){let n=a.children;if(n[0]&&!a.rendered)for(let o of n)r(o);else{let o=this._getLodBiasCorrectedScale(a.level);i=i==null?o:Math.min(i,o)}}},s=this._rootTiles;if(s!=null)for(let a of s)r(a);return i}queryVisibleScaleRange(t,e,i,r){let s=e?this.tilingScheme.levelAtScale(e):0,a=i?this.tilingScheme.levelAtScale(i):1/0,n=this._lodBias;this._scaleRangeQueries.queryVisibleLevelRange(t,s+n,a+n,r)}_evaluateTransparency(){let t=this.baseOpacity,e=this.overlayManager.renderer.isEmpty,i=this._renderer.transparency,r=this._allSurfaceLayersTransparent()?e?or.Invisible:or.InvisibleWithDraped:t>=1&&!this.hasCompositeBlendMode&&!this._renderer.slicePlaneEnabled?or.Opaque:or.Transparent;return this._renderer.transparency=r,i!==r}_updateTilingScheme(){let t=this.tilingSchemeLogic.tilingScheme;if(t===this.tilingScheme)return;ci(!!t,"tiling scheme cannot be reset to undefined"),this._isGlobal=!this.view?.state?.isLocal,this.tilingScheme&&this._removeAllTiles();let e=t?.spatialReference??Kt.WebMercator;this._spatialReference=e,this._isWebMercator=!!e?.isWebMercator,this._isWebMercatorOnPlateCarree=this._isWebMercator&&pp(this.view?.renderSpatialReference),this._isGeographic=e?.isGeographic??!1,this._set("tilingScheme",t),this._tilingSchemeSpatialReference=this.tilingScheme?.spatialReference,this._projectorCache.clear(),this._updateClippingExtent(),t&&(this._updateTiledLayers(),this._renderer.tileSize=t.pixelSize,this.overlayManager.spatialReference=t.spatialReference,this._updateRootTiles())}_acquireTile(t,e,i,r){let s=this._tileCache.pop(Nf._tileMemcacheKey);return s?(s.init(t,e,i,r,this),s):new this._tileConstructor(t,e,i,r,this)}get updatingRootTiles(){return this._updatingRootTiles}_updateRootTiles(){let{extent:t,tilingScheme:e}=this;if(!e)return;let i=GO,r=e.rootTilesInExtent(t,i,5*Lc);if(this._rootTiles!=null){if(r.length>Lc)return void pe.getLogger(this).warn(tT);let s=this._rootTiles.map(n=>n.lij),a=Mv(s,r,wd);if(this._updatingRootTiles=!0,a.removed.length>0||a.added.length>0){let n=this._rootTiles.filter(o=>!(a.removed.findIndex(l=>wd(l,o.lij))>-1)||(this._purgeTile(o),!1));a.added.forEach(o=>n.push(this._newRootTile(o))),this._setRootTiles(n)}}else this._updatingRootTiles=!0,r.length>Lc&&(pe.getLogger(this).warn(iT),r=e.rootTilesInExtent(t,i,Lc)),this._setRootTiles(r.map(s=>this._newRootTile(s)));Ds(i,this._rootTilesExtent)||(this._rootTilesExtent=kt(i)),this.renderer.visible=!0,this._viewChangeUpdate(),this.overlayManager.setPlacementDirty(),this.notifyChange("ready"),this._updateAllTileGeometries(),this._updatingRootTiles=!1,this.checkAllTilesWaterproofness()}_updateAllTileGeometries(){let t=this._allTiles.filter(e=>e.loaded&&e.intersectsClippingArea);t.sort(_s),t.forEach(e=>this._renderer.updateTileGeometryState(e)),t.forEach(e=>e.renderData.updateNeighborData()),this._updateTilesGeometries(t),this._pendingTilesToUpdate.clear()}_updateTilesGeometries(t){if(t.length===0)return;t.sort(_s);let e=this.renderer;t.forEach(i=>e.updateGeometryIfNeeded(i)),t.forEach(i=>this._pendingTilesForElevationUpdateEvent.add(i))}_shouldSplit(t){return t.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.snapLevel)===se.SPLIT}_newRootTile(t){let e=this._acquireTile(0,t[1],t[2],null);return this._shouldSplit(e)&&e.setPendingUpdate(se.SPLIT),this._loadTile(e),this._markTileToUpdate(e),this._updateRootTileElevationBounds(),e}_setRootTiles(t){if(this._rootTiles=t,this._allTiles.clear(),t!=null){let e=this._iteratorPool.acquire();for(e.reset(t);!e.done;)this._allTiles.push(e.next());e.remove()}this._renderer.setRootTiles(this._rootTiles),this._updateTilesVisibility(t)}_runViewChangeUpdateIfDirty(){this._viewChangeUpdateDirty&&(this._viewChangeUpdateDirty=!1,this._viewChangeUpdate())}_viewChangeUpdate(){this.view&&!this.suspended&&this.tilingScheme&&this.renderer.visible&&(this._inFrameTask?this._viewChangeUpdateDirty=!0:(this._viewChangeUpdateDirty=!1,this._updateViewDependentParameters(),this._updateTilesVisibility(this._rootTiles)))}_updateClippingStatus(t){t.updateClippingStatus(this.extent)&&t.resetPendingUpdate(se.GEOMETRY)&&this._updateTileGeometryState(t)}_updateTilesVisibility(t){if(t==null)return;let e=mC(t),i=this.visibleElevationBounds,r=e?i.min:1/0,s=e?i.max:-1/0,a=this.extent,n=this.view.state.contentCamera.viewProjectionMatrix;this.setTileTreeDirty();let o=this._iteratorPool.acquire();for(o.reset(t);!o.done;){let l=o.next();l.updateClippingStatus(a)&&l.resetPendingUpdate(se.GEOMETRY)&&this._updateTileGeometryState(l),l.computeVisibility(),l.updateScreenDepth(n),l.renderData&&(r=Math.min(l.elevationBoundsMin,r),s=Math.max(l.elevationBoundsMax,s))}o.remove(),this._viewChanged=!0,this._allTilesDirty=!0,this._updatePendingTileGeometries(),isFinite(r)&&isFinite(s)&&(i.min!==r||i.max!==s)&&(this.visibleElevationBounds=new Aa(r,s))}_updateRootTileElevationBounds(){let t=1/0,e=-1/0,i=this._rootTiles;i?.forEach(({elevationBoundsMin:s,elevationBoundsMax:a})=>{t=Math.min(t,s),e=Math.max(e,a)});let r=this.rootTileElevationBounds;r.min===t&&r.max===e||(this.rootTileElevationBounds=new Aa(t,e))}_updateViewDependentParameters(){let{camera:t,contentCamera:e}=this.view.state,i=Math.tan(.5*e.fovX),r=Math.tan(.5*e.fovY),s=this.tilingScheme.pixelSize,a=2**-this._lodBias*t.pixelRatio;this._splitLimits.aboveGround=t.aboveGround,this._splitLimits.fovX=i,this._splitLimits.fovY=r,this._splitLimits.relativeWidthLimit=s/t.width*this.maxTextureScale*a,this._splitLimits.relativeHeightLimit=s/t.height*this.maxTextureScale*a,this._splitLimits.maxLod=this.tilingScheme.getMaxLod(),this._splitLimits.angledSplitBias=this.view.qualitySettings.tiledSurface.angledSplitBias,this.view.state.fixedContentCamera?this._splitLimits.frustum=vg(this._splitLimits.frustum??yg(),e.frustum):this._splitLimits.frustum=null,vg(this._frustum,t.frustum),q(this._eyePosRenderSR,e.eye),En(t.eye,this.view.renderSpatialReference,this._eyePosSurfaceSR,this.spatialReference)}_updateTileGeometryState(t){t.updateVisibility(),this._renderer.updateTileGeometryState(t)&&this._markTileToUpdate(t),this.setMemoryDirty()}_markAllTileNeighborsForUpdate(t){t.forEachLoadedNeighbor(e=>{this._layerViews[_e.MAP].some(rh)&&e.setPendingUpdate(se.TEXTURE_FADING),this._pendingTilesToUpdate.add(e)})}_updateTileTexture(t,e){let i=t.resetPendingUpdate(se.TEXTURE_FADING)?se.TEXTURE_FADING:!!t.resetPendingUpdate(se.TEXTURE_NOFADING)&&se.TEXTURE_NOFADING;i&&(this._renderer.updateTileTexture(t,i),this._usedMemory=null,e.madeProgress())}_emitElevationUpdateEventForTiles(){if(!this._shouldEmitChangeEvent)return;let t=V0.extent;Os(t),this._pendingTilesForElevationUpdateEvent.forEach(e=>ta(t,e.extent,t)),this._pendingTilesForElevationUpdateEvent.clear(),V0.spatialReference=this.spatialReference,this.emit("elevation-change",V0),this._shouldEmitChangeEvent=!1}runTask(t){this._handleLayerViewChanges(t),this._frameTask.processQueue(t),this.renderer.processScaleRangeQueries(this._scaleRangeQueries,t),this._inFrameTask=!0,this._pendingUpdates=0,this._hasPendingUpdates=!1,this._updateAllTilesStatus(t),this._sortTiles(t);let e=!this.view.state.fixedContentCamera;if(this._mergeAndSplit(t,e),this._updateElevation(t),this._updateTextures(t),e||this._mergeAndSplit(t,!0),this._inFrameTask=!1,this._runViewChangeUpdateIfDirty(),this._updatePendingTileGeometries(),this._emitElevationUpdateEventForTiles(),t.done&&t.hasProgressed&&this.requestUpdate(),this.notifyChange("updatingProgressValue"),oi&&this._checkTileInvariant(),!t.hasProgressed)return Xt}_checkTileInvariant(){let t=new Map;this._allTiles.forAll(e=>t.set(e,new Set)),this._allTiles.forAll(e=>{if(ci(e.rendered===e.leaf,` rendered ${e.rendered} != ${e.leaf} leaf`),!e.leaf){let i=s=>s.unmergableChildCount===0&&s.maxLevelDeltaNeighborCount===0,r=e.children.reduce((s,a)=>s+(i(a)?0:1),0);if(ci(e.unmergableChildCount===r,` Tile[${e.lij.toString()}] unmergeable child count mismatch: actual ${e.unmergableChildCount} vs ${r}`),e.hasPendingUpdate(se.MERGE)){ci(!e.hasPendingUpdate(se.SPLIT),"Tile can be both split and merge at the same time");for(let s of e.children)ci(s.leaf||s.hasPendingUpdate(se.MERGE),"Child of tile to merge must also merge")}}for(let i=0;i<4;++i){if(e.rendered){let n=e.renderData?.geometryState.edgePeerNeighbors[i];if(n!=null){{let o=e.level-n.level<=ti;o||(console.log(`tile level delta [${e.lij.toString()}] vs [${n.lij.toString()}] > ${ti}  (edge[${i}])`),ci(o,`tile level delta [${e.level}] vs [${n.level}] > ${ti}`))}ci(e.level-n.level<=ti,`Max tile lod delta exceeded: [${e.lij.toString()}] vs [${n.lij.toString()}]`)}}let r=e.level-ti,s=n=>n.leaf||n.level===e.level,a=e.findNeighborTile(Tr[i],s);if(a!=null){if(e.leaf&&e.level>=ti){let n=a;for(;e.level-n.level<ti;)n=n.parent;let o=[r,e.lij[1]>>ti,e.lij[2]>>ti];if(!wd(o,n.lij)){let l=t.get(n);ci(!l.has(e),"Cannot already have neighbor"),l.add(e)}}ci(a.rendered||a.level===e.level,"Non-same-level-neighbor of rendered must be rendered"),ci(e.level-a.level<=ti,`Tile level delta [${e.level}] vs [${a.level}] > ${ti}`)}}}),this._allTiles.forAll(e=>{let i=e.maxLevelDeltaNeighborCount,r=t.get(e);ci(i===r.size,`Tile[${e.lij.toString()}] merge-blocker mismatch: actual ${i} vs ${r.size}`)})}_updateAllTilesStatus(t){if(!this._viewChanged||!this._rootTiles||t.done)return;this._viewChanged=!1;let e=new H0(this._allTiles.length);e.pushAll(this._rootTiles);let i=this.snapLevel,r=this._splitLimits,s=this._eyePosRenderSR;this._allTiles.forAll(n=>{n.maxLevelDeltaNeighborCount=0,n.unmergableChildCount=0});let a=this.view.state.contentCamera.viewProjectionMatrix;for(;!e.empty;){let n=e.pop(),o=n.parent,l=o!=null&&o.hasPendingUpdate(se.MERGE),h=l?se.MERGE:n.shouldSplit(r,s,i),d=h===se.SPLIT;n.leaf?U0(n,d):e.pushAll(n.children),l?(n.resetPendingUpdate(se.SPLIT),n.leaf||n.setPendingUpdate(se.MERGE),this._updateClippingStatus(n),n.updateVisibility(),n.updateScreenDepth(a)):d?(n.resetPendingUpdate(se.MERGE),n.leaf&&n.setPendingUpdate(se.SPLIT)):(n.resetPendingUpdate(se.SPLIT)&&n.updateAgentSuspension(),h===se.ELEVATION&&n.updateAgents(_e.ELEVATION),n.leaf||(n.setPendingUpdate(se.MERGE),n.resetPendingUpdate(se.SPLIT)))}this.requestUpdate(),(this._shortBatches||!this._oneBatchPerFrameTask)&&this._updatePendingTileGeometries(),t.madeProgress()}_sortTiles(t){t.done||this._allTilesSorted||(dC(this._allTiles,this.view.pointsOfInterest.focus.renderLocation),this._allTilesSorted=!0,this._treeDebugger&&this._treeDebugger.update(),t.madeProgress())}_markTileToUpdate(t){V(t.loaded),t.intersectsClippingArea&&(this._pendingTilesToUpdate.add(t),this._markAllTileNeighborsForUpdate(t))}_updatePendingTileGeometries(){let t=this._pendingTilesToUpdate,e=Array.from(t.keys()).filter(s=>s.loaded&&s.intersectsClippingArea);if(e.length===0)return void t.clear();let i=(s,a)=>{!a?.loaded||!a.intersectsClippingArea||a.level<s.level||t.has(a)||(t.add(a),e.push(a),a.renderData.updateNeighborData())};e.sort(_s);let r=e.length;for(let s=0;s<r;++s){let a=e[s];V(a.loaded),V(a.intersectsClippingArea);let n=a.renderData;n.updateNeighborData();let o=n.dirtyEdgeResolutions,l=n.geometryState,h=d=>{let m=Vo[d];i(a,l.cornerPeerNeighbors[d]?.findCorner(ah(m),u=>u.loaded))};for(let d=0;d<4;++d)if(o&1<<d){let m=n.geometryState.edgePeerNeighbors[d];m&&m?.level>=a.level&&m.forAllSubtreeOnSide(nh(Tr[d]),u=>!(!u.loaded||!u.intersectsClippingArea)&&(V(t.has(u)||_s(a,u)<0),i(a,u),!0)),h((d+1)%4),h(d)}}t.clear(),this._updateTilesGeometries(e),this._shouldEmitChangeEvent=!0,oi&&Nc&&this.checkAllTilesWaterproofness()}_mergeAndSplit(t,e){if(this.suspended||t.done||!this._allTilesDirty)return;this._allTilesDirty=!1,this.requestUpdate();let i=!1,r=this.view.state.fixedContentCamera,s=!1;for(;!t.done;){s=!0;let a=!1,n=!this._allTiles.some(o=>{if(!i&&!r&&!o.visible)return t.done;let l=o;if(o.hasPendingUpdate(se.MERGE)){if(!e||o.unmergableChildCount>0)return t.done;for(o.resetPendingUpdate(se.MERGE);l.parent!=null&&l.parent.unmergableChildCount===0&&l.parent.resetPendingUpdate(se.MERGE);)l=l.parent;this._mergeTile(l),a=!0,t.madeProgress()}else if(o.resetPendingUpdate(se.SPLIT)){let h=!0,d=o.level;if(d>=ti){let m=u=>u.leaf||d-u.level<ti;for(let u=0;u<4;++u){let f=o.findNeighborTile(Tr[u],m);f!=null&&d-f.level===ti&&(h=!1,oi&&(V(f.leaf),V(f.hasPendingUpdate(se.SPLIT))))}}h?(this._splitTile(o),t.madeProgress(),a=!0):o.setPendingUpdate(se.SPLIT)}return t.done});if(a&&(this._allTilesSorted=!1,this._allTilesDirty=!0,!this._oneBatchPerFrameTask&&this._updatePendingTileGeometries()),n){if(!i){i=!0;continue}if(!a)break}else this._allTilesDirty=!0}s?t.madeProgress():this._allTilesDirty=!0,!this._oneBatchPerFrameTask&&this._updatePendingTileGeometries(),this._sortTiles(t)}_updateElevation(t){t.done||(this._allTiles.some(e=>(e.resetPendingUpdate(se.GEOMETRY)&&(this._updateTileGeometryState(e),this._shortBatches&&this._updatePendingTileGeometries(),t.madeProgress()),t.done)),!this._oneBatchPerFrameTask&&this._updatePendingTileGeometries())}_updateTextures(t){t.done||this._allTiles.some(e=>(this._updateTileTexture(e,t),t.done))}_updateClippingExtent(){this.spatialReference&&(this.overlayManager?.updateOverlayParameters(oe.UPDATE),this.overlayManager.setPlacementDirty(),this._updateRootTiles())}get _lodBias(){let t=this.view.quality;return this.view.qualitySettings.tiledSurface.lodBias-(1-t)*Xb}_getLodBiasCorrectedScale(t){let e=this.tilingScheme.levels,i=N(t-this._lodBias,0,e.length-1),r=i-Math.floor(i);return e[Math.floor(i)].scale*(1-r)+e[Math.ceil(i)].scale*r}_removeAllTiles(){this._rootTiles!=null&&(this._rootTiles.forEach(t=>this._purgeTile(t)),this._setRootTiles(null),this.notifyChange("ready")),this._allTiles.clear(),this.renderer.visible=!1}_purgeSubtree(t){let e=t.children;e[0]&&(this._purgeTile(e[0]),this._purgeTile(e[1]),this._purgeTile(e[2]),this._purgeTile(e[3]),t.clearChildren())}_purgeTile(t){t.leaf?kR(t):this._purgeSubtree(t),this._allTiles.removeUnordered(t),this._unloadTile(t),t.dispose(),this._tileCache.put(Nf._tileMemcacheKey,t)}_unloadTile(t){this._pendingTilesToUpdate.delete(t),this._pendingTilesForElevationUpdateEvent.delete(t),t.unload()}_splitTile(t){ci(t.leaf,"Tile that is already split should not be split again!"),ci(t.rendered,"Tile marked to split is not rendered"),kR(t);let e=t.createChildren();this._allTiles.pushArray(e),t.updateAgentSuspension(),ci(t.rendered,"parent should be rendered"),e.forEach(i=>this._loadTile(i)),e.forEach(i=>this._pendingTilesToUpdate.add(i)),this._unloadTile(t),this._markAllTileNeighborsForUpdate(t),this._emitTileScaleChange(t,t.level+1),this._allTilesDirty=!0,this._shortBatches&&this._updatePendingTileGeometries(),e.forEach(i=>U0(i,i.hasPendingUpdate(se.SPLIT))),++this._performanceInfo.numSplit}_emitTileScaleChange(t,e=t.level){Lf.spatialReference=this.spatialReference,Lf.extent=t.extent,Lf.scale=this._getLodBiasCorrectedScale(e),this.emit("scale-change",Lf)}createTile(t,e,i,r){ci(!!r,"createTile sanity check");let s=this._acquireTile(t,e,i,r);return s.updateClippingStatus(this.extent),s.updateScreenDepth(this.view.state.contentCamera.viewProjectionMatrix),this._shouldSplit(s)&&s.setPendingUpdate(se.SPLIT),s}get _shortBatches(){return this.view.state.mode!==Zt.IDLE}_mergeTile(t){ci(!t.hasPendingUpdate(se.SPLIT),"_mergeTile sanity check"),ci(!t.leaf,"Cannot merge a leaf"),t.leaf||(this._purgeSubtree(t),ci(!t.renderData,"Merging tile with existing render data?"),this._loadTile(t),this._markTileToUpdate(t),this._emitTileScaleChange(t),this._shortBatches&&this._updatePendingTileGeometries(),U0(t,!1),this._allTilesDirty=!0,++this._performanceInfo.numMerged)}_loadTile(t){t.load(),this.requestUpdate(),this._allTilesDirty=!0,this.overlayManager?.hasOverlays&&this.overlayManager.updateTileOverlayParameters(t)}_handleLayerViewChanges(t=Dr){if(!this._layerViewsDirty)return;this._layerViewsDirty=!1;let e=!1,i=new Set,r=-1;for(let s=this.view.allLayerViews.length-1;s>=0;s--){let a=this.view.allLayerViews.items[s];if(i.add(a.uid),Fc(a)||sh(a))if(this._basemapLayerViewHandles.has(a.uid)&&!sh(a)){let n=this._layerClassFromLayerView(a),o=this._getLayerIdxByUID(n,a.uid);o!=null&&((o<r||r==null)&&(e=!0),r=o)}else this._registerTiledLayerView(a),a.layer.loaded&&(e=!0)}this._basemapLayerViewHandles.forEach((s,a)=>{i.has(a)||(this._unregisterTiledLayerView(a),e=!0)}),e&&this._updateTiledLayers(),this.hasCompositeBlendMode=this._hasCompositeBlendMode(),this._evaluateTransparency(),t.madeProgress()}_allSurfaceLayersTransparent(){let t=this.view.map?.ground?.opacity===0;for(let e of this.view.allLayerViews.items)if(Gg(e)&&!Pl(e.layer)&&e.fullOpacity!==0)return t=!1,t;return t}_hasCompositeBlendMode(){for(let t of this.view.allLayerViews.items)if((Hn(t)||sh(t))&&CC(Hc[t.layer.blendMode]))return!0;return!1}_layerClassFromLayerView(t){return kg(t)?_e.ELEVATION:_e.MAP}_registerTiledLayerView(t){let e=[];if((Hn(t)||sh(t))&&e.push(P(()=>t.layer.blendMode,()=>{this.hasCompositeBlendMode=this._hasCompositeBlendMode(),this._updateTileTextures(Ct.UNFADED)})),!sh(t)){let i=this._layerClassFromLayerView(t);e.push(P(()=>t.suspended,()=>this._updateTiledLayers())),e.push(P(()=>t.fullOpacity,()=>this._updateTileTextures(Ct.UNFADED))),e.push(P(()=>"effectiveScaleRange"in t.layer?t.layer.effectiveScaleRange:null,()=>this._restartAllAgents(i))),e.push(t.on("data-changed",()=>{let r=this._getLayerIdxByUID(i,t.uid);r!=null&&this._invalidateLayerData(r,i)}))}this._unregisterTiledLayerView(t.uid),this._basemapLayerViewHandles.set(t.uid,e)}_unregisterTiledLayerView(t){let e=this._basemapLayerViewHandles.get(t);if(e){for(let i of e)i.remove();this._basemapLayerViewHandles.delete(t)}}_updateTiledLayers(){if(!this.tilingScheme||this.view.suspended)return;let t=this.view.allLayerViews,e=[[],[]],i=null;t.forEach(r=>{if(!r.layer||r.suspended||!Fc(r)||!r.fullExtent)return;let s=this._layerClassFromLayerView(r);if(s===_e.MAP){let a=r.displayLevelRange.maxLevel;a!==1/0&&(i===null||a>i)&&(i=a)}e[s].push(r)});for(let r of ho){let s=this._layerViews[r],a=e[r];a.reverse();let n=a.length,o=s.length!==n,l=new Array(n),h=new Array(s.length);this._layerIndexByUid[r].clear();for(let d=0;d<n;d++){let m=a[d].uid;this._layerIndexByUid[r].set(m,d);let u=s.indexOf(a[d]);l[d]=u,d!==u&&(o=!0),u>-1&&(h[u]=d)}if(o){let d=this._postorderIterator;for(d.reset(this._rootTiles);!d.done;)d.next().modifyLayers(h,l,r);this._layerViews[r]=a,this._restartAllAgents(r),this._updateTilesVisibility(this._rootTiles)}}this.tilingScheme.ensureMaxLod(i)&&(this._viewChangeUpdate(),this.notifyChange("tilingScheme"))}_restartAllAgents(t){let e=this._postorderIterator;for(e.reset(this._rootTiles);!e.done;){let i=e.next();i.restartAgents(t),t===_e.ELEVATION&&i.computeElevationBounds()}this._updateRootTileElevationBounds()}layerViewByIndex(t,e){return this._layerViews[e][t]}numLayers(t){return this._layerViews[t].length}_updateTileTextures(t){this._allTiles.forAll(e=>{e.updateAgents(_e.MAP),t===Ct.IMMEDIATE?this.renderer.updateTileTexture(e,se.TEXTURE_NOFADING):e.updateRenderData(_e.MAP,t)}),this._evaluateTransparency()}_invalidateLayerData(t,e){this._allTiles.forAll(i=>i.removeLayerAgent(t,e)),this._allTiles.forAll(i=>i.invalidateLayerData(t,e))}setTileTreeDirty(){this._allTilesDirty=!0}requestRender(t=oe.UPDATE){this.renderer.setNeedsRender(t)}requestUpdate(){++this._pendingUpdates==1&&(this._hasPendingUpdates=!0)}requestTileData(t,e,i,r){let s=this.layerViewByIndex(e,i),a=s.layer;return!a.tilemapCache||rh(s)?this._requestTileData(t,i,s,r):(++this._asyncWorkItems,a.tilemapCache.fetchAvailability(t.level,t.lij[1],t.lij[2],Bt(lt({},r),{timeout:6e3})).then(()=>--this._asyncWorkItems).catch(n=>{throw--this._asyncWorkItems,Vi(r),ss(n)||this._dataMissing(t,i,s),n}).then(()=>this._frameTask.schedule(()=>this._requestTileData(t,i,s,r),r.signal)))}_requestTileData(t,e,i,r){if(this._destroying)return Promise.resolve();let s=e===_e.ELEVATION;return r.requester??=s?this._elevationDataRequester:this._mapDataRequester,s?kg(i)?this._requestElevationTileData(t,i,r):Promise.reject():Gg(i)?this._requestMapTileData(t,i,r):Promise.reject()}_requestElevationTileData(t,e,i){++this._asyncWorkItems;let r=a=>{!bo(i)&&a&&(this.setMemoryDirty(),this.requestUpdate(),this._elevationDataArrived(t,e,a))},s=a=>{ss(a)||(pe.getLogger(this).error(`Tile ${t.lij.toString()} layer ${_e.ELEVATION}/${e.uid} error ${a}`),this._dataMissing(t,_e.ELEVATION,e),this.requestUpdate())};return e.fetchTile(t.lij,i).then(a=>this._frameTask.schedule(()=>r(a)),s).finally(()=>--this._asyncWorkItems)}_elevationDataArrived(t,e,i){let r=this._layerIndexByUid[_e.ELEVATION].get(e.uid);if(r==null)return void pe.getLogger(this).warn("TerrainSurface: received data from unknown layer %d %s",_e.ELEVATION,t.lij.toString());let s=new sf(t.lij,t.extent,i);t.dataArrived(r,_e.ELEVATION,s);let a=[t],n=t.level,o=this._iteratorPool.acquire();for(o.reset(a);!o.done;){let l=o.next();l.findElevationBoundsForLayer(r,n),l.computeElevationBounds()}n===0&&this._updateRootTileElevationBounds(),o.remove(),this._updateTilesVisibility(a)}_requestMapTileData(t,e,i){++this._asyncWorkItems;let r=(o,l)=>{qn(l),bo(i)||(console.error(`Tile ${t.lij.toString()} layer ${_e.MAP}/${e.uid} error ${o}`),this._dataMissing(t,_e.MAP,e),this.requestUpdate())},s=o=>l=>r(l,o),a=o=>this._frameTask.schedule(()=>{this.requestUpdate(),bo(i)?qn(o):this._mapTileDataArrived(t,e,o)},i.signal,s(o)).catch(s(o)),n=(o,l=null)=>this._frameTask.schedule(()=>r(o,l));return e.fetchTile(t.lij,i).then(a,n).finally(()=>--this._asyncWorkItems)}_mapTileDataArrived(t,e,i){let r=this._getLayerIdxByUID(_e.MAP,e.uid);if(r==null)return qn(i),void pe.getLogger(this).warn("TerrainSurface: received data from unknown layer");t.dataArrived(r,_e.MAP,i)}_getLayerIdxByUID(t,e){return this._layerIndexByUid[t].get(e)}_dataMissing(t,e,i){let r=this._getLayerIdxByUID(e,i.uid);r!=null?t.dataMissing(r,e):pe.getLogger(this).warn("TerrainSurface: received data from unknown layer")}get performanceInfo(){let t=this._performanceInfo;return t.numNodes=this._allTiles.length,t.numLeaves=t.numVisible=t.numRendered=t.numLoadedPerLevel.length=t.numRenderedPerLevel.length=0,this._allTiles.forAll(e=>{e.leaf&&t.numLeaves++;let i=e.level;e.renderData&&(t.numLoadedPerLevel[i]=(t.numLoadedPerLevel[i]||0)+1),e.visible&&(t.numVisible++,e.rendered&&(t.numRenderedPerLevel[i]=(t.numRenderedPerLevel[i]||0)+1,t.numRendered++))}),t}setMemoryDirty(){this._usedMemory=null}get usedMemory(){return this.tilingScheme?(this._usedMemory==null&&(this._usedMemory=this._recalculateUsedMemory()),this._usedMemory??0):0}_recalculateUsedMemory(){return this.tilingScheme?Math.round(this._allTiles.reduce((t,e)=>t+e.usedMemory,0)):null}getUsedMemoryForLayerView(t){let e=0,i=this._layerClassFromLayerView(t),r=this._getLayerIdxByUID(i,t.uid);return r!=null&&this._allTiles.forAll(s=>e+=s.getUsedMemoryForLayer(i,r)),e}get renderPatchBorders(){return this._renderer.renderPatchBorders}set renderPatchBorders(t){this._renderer.renderPatchBorders=t}get visualizeNormals(){return this._renderer.visualizeNormals}set visualizeNormals(t){this._renderer.visualizeNormals=t}get renderingDisabled(){return this._renderer.renderingDisabled}set renderingDisabled(t){this._renderer.renderingDisabled=t}get test(){}checkAllTilesWaterproofness(){if(!Nc)return;let t=this._rootTiles;if(t==null)return;let e=a=>a?.renderData?.geometry?.indices?.length>0,i=(a,n)=>{e(a)&&console.error("Tile[",a.lij,"] has geometry although parent[",n.lij,"] has geom")},r=a=>{if(a.intersectsClippingArea)if(a.renderData&&!a.renderData.geometryState&&console.error("Tile[",a.lij,"] has renderData but not geometryState"),a.renderData&&!a.renderData.geometry&&console.error("Tile[",a.lij,"] has renderData but not geometryInfo"),!a.renderData?.geometry||(a.renderData.geometry.indices?.length??0)>0||console.error("Tile[",a.lij,"] has renderData but no indices - geometryInfo: ",a.renderData.geometry),e(a)){a.checkGeometryWaterproofness();for(let n of a.children)i(n,a)}else if(a.leaf)console.error("Tile[",a.lij,"] has no geometry and no children, from root to leaf");else for(let n of a.children)r(n)},s=a=>{let n=a.parent?.visible??!0,o=a.visible;a.computeVisibility();let l=a.visible;if(o!==l&&n&&console.error(" Tile[",a.lij,"] has out of date visibility: ",o," instead of ",l),!a.leaf)for(let h of a.children)s(h)};for(let a of t)r(a),s(a)}get isGlobal(){return this._isGlobal}get isGeographic(){return this._isGeographic}get isWebMercator(){return this._isWebMercator}get isWebMercatorOnPlateCarree(){return this._isWebMercatorOnPlateCarree}isEastEndWrap(t){return this._isGlobal&&t[2]===this.lijEastEnd(t[0])-1}isWestEndWrap(t){return this._isGlobal&&t[2]===0}lijEastEnd(t){return 1<<t+(this._isGeographic?1:0)}wrapEastWest(t){let e=this.lijEastEnd(t[0]),i=t[2];if(0<=i&&i<e)return t;if(!this._isGlobal)return null;let r=(i+(i<0?e:0))%e;return[t[0],t[1],r]}enableInternalChecks(t){QT(t)}enableWaterproofnessChecks(t){WT(t)}};Se._tileMemcacheKey="TerrainTileMemcache",c([p()],Se.prototype,"_renderer",void 0),c([p({constructOnly:!0})],Se.prototype,"_scaleRangeQueries",void 0),c([p({constructOnly:!0})],Se.prototype,"view",void 0),c([p({constructOnly:!0})],Se.prototype,"overlayManager",void 0),c([p()],Se.prototype,"_hasPendingUpdates",void 0),c([p()],Se.prototype,"_asyncWorkItems",void 0),c([p()],Se.prototype,"_allTilesDirty",void 0),c([p()],Se.prototype,"_allTilesSorted",void 0),c([p()],Se.prototype,"_viewChanged",void 0),c([p({type:Number})],Se.prototype,"heading",void 0),c([p()],Se.prototype,"_splitLimits",void 0),c([p({readOnly:!0})],Se.prototype,"_watchUpdatingTracking",void 0),c([p()],Se.prototype,"_frameTask",void 0),c([p({readOnly:!0})],Se.prototype,"snapLevel",null),c([p({readOnly:!0})],Se.prototype,"lodSnappingEnabled",null),c([p()],Se.prototype,"_userClippingExtent",null),c([p()],Se.prototype,"_rootTilesExtent",void 0),c([p({readOnly:!0})],Se.prototype,"extent",null),c([p({readOnly:!0})],Se.prototype,"groundExtent",null),c([p({readOnly:!0})],Se.prototype,"_tilingSchemeExtent",null),c([p({readOnly:!0})],Se.prototype,"updating",null),c([p({readOnly:!0})],Se.prototype,"running",null),c([p(BT)],Se.prototype,"updatingProgress",void 0),c([p({readOnly:!0})],Se.prototype,"updatingProgressValue",null),c([p()],Se.prototype,"_maxNumUpdating",void 0),c([p()],Se.prototype,"baseOpacity",null),c([p()],Se.prototype,"hasCompositeBlendMode",void 0),c([p({readOnly:!0})],Se.prototype,"viewingMode",null),c([p()],Se.prototype,"maxTextureScale",void 0),c([p({readOnly:!0})],Se.prototype,"ready",null),c([p({value:Uc.FRONT_TO_BACK})],Se.prototype,"renderOrder",null),c([p({readOnly:!0})],Se.prototype,"rootTiles",null),c([p()],Se.prototype,"_rootTiles",void 0),c([p({readOnly:!0})],Se.prototype,"spatialReference",null),c([p({type:Dp})],Se.prototype,"backgroundColor",null),c([p({value:!1})],Se.prototype,"slicePlaneEnabled",null),c([p({readOnly:!0})],Se.prototype,"tilingScheme",void 0),c([p({readOnly:!0})],Se.prototype,"tilingSchemeLocked",null),c([p({readOnly:!0})],Se.prototype,"tilingSchemeLogic",void 0),c([p()],Se.prototype,"wireframe",null),c([p({value:!1})],Se.prototype,"suspended",null),c([p()],Se.prototype,"fadeDuration",null),c([p()],Se.prototype,"visibleElevationBounds",void 0),c([p()],Se.prototype,"rootTileElevationBounds",void 0),c([p()],Se.prototype,"_layerViewsDirty",void 0),c([p()],Se.prototype,"renderPatchBorders",null),c([p()],Se.prototype,"visualizeNormals",null),c([p()],Se.prototype,"renderingDisabled",null),Se=Nf=c([S("esri.views.3d.terrain.TerrainSurface")],Se);var GR=Se,Ad=_(),kh=mi(),GO=kt();new Xe;var V0=new ET("ground"),Lf={spatialReference:null,extent:null,scale:0};function BR(t,e,i){for(let r of t){if(!r.containsPointXY(e,i))continue;let s=r;for(;s&&!s.renderData;){let n=(e>s.extentMidX?1:0)+(i<s.extentMidY?2:0);s=s.children[n]}let a=s?.renderData?.geometryState.samplerData??null;return Mt(e,i,a)}return null}var H0=class{constructor(e){this.capacity=e,this._head=0,this._tail=0,this._data=new Array(e)}push(e){let i=this._tail;if(!(i<this.capacity))throw new Error("Queue full");this._data[i]=e,this._tail=i+1}pushAll(e){let i=e.length;if(i===0)return;let r=this._tail;if(!(r+i<=this.capacity))throw new Error("Queue full");for(let s=0;s<i;++s)this._data[r+s]=e[s];this._tail=r+i}pop(){let e=this._head;if(e<this._tail){let i=this._data[e];return this._head=e+1,i}}get empty(){return this._head>=this._tail}get full(){return this._tail>=this._data.length}};function U0(t,e){!t.leaf||t.level<ti||B0(t,i=>{e&&zR(i);let r=q0(i);if(i.maxLevelDeltaNeighborCount++,r){let s=i.parent;for(;s;){let a=q0(s);if(s.unmergableChildCount++,!a)break;s=s.parent}}})}function zR(t){if(t.hasPendingUpdate(se.SPLIT))return;let e=t.parent;for(;e?.resetPendingUpdate(se.MERGE);)e=e.parent;t.resetPendingUpdate(se.MERGE),t.leaf&&t.setPendingUpdate(se.SPLIT),t.level<ti||B0(t,i=>{zR(i)})}function kR(t){t.level<ti||B0(t,e=>{if(e.maxLevelDeltaNeighborCount--,e.maxLevelDeltaNeighborCount===0&&e.unmergableChildCount===0){let i=e.parent;for(;i&&(i.unmergableChildCount--,q0(i));)i=i.parent}})}function q0(t){return t.maxLevelDeltaNeighborCount===0&&t.unmergableChildCount===0}function B0(t,e){if(t.level<ti)return;let i=t.level-ti,r=t.lij[1]>>ti,s=t.lij[2]>>ti,a=n=>n.leaf||n.level===i;for(let n=0;n<4;++n){let o=t.findNeighborTile(Tr[n],a);if(!o||o.level!==i)continue;let l=o.lij;l[1]===r&&l[2]===s||e(o)}}var k0=class{constructor(e,i,r,s){this.operation=e,this.geometry=i,this.states=r,this.sync=s}},Ed=class extends te{constructor(t){super(t),this._residentGeomRecords=new Map,this._dirtyGeomRecords=new Map,this._dirtyRecordCount=0}get dirty(){return this._dirtyRecordCount>0}commitLayer(t,e){let i=this._dirtyGeomRecords.get(t);if(!i)return;let r=0;i.forEach((s,a)=>{let n=this._ensureGeomRecord(t,a);r+=s.size,s.forEach(({geometry:o,operation:l,states:h},d)=>{let m=!1;if(l===ei.UPDATE){let u=n.get(d);if(u){if(h&ca.TRANSFORMATION){let f=this.model.getObject(a);this.model.updateRenderGeometryTransformation(f,o,u)&&(m=!0)}m||e.updates.push({renderGeometry:u,updateType:h})}else Wi(!1,"ModelDirtySet.commitLayer: invalid update")}if(l===ei.REMOVE||m){let u=n.get(d);u?(e.removes.push(u),n.delete(d)):l===ei.REMOVE&&Wi(!1,"ModelDirtySet.commitLayer: invalid remove")}if(l===ei.ADD||m){let u=this.model.getObject(a);if(u!=null){let f=this.model.getRenderGeometry(u,o);e.adds.push(f),n.set(d,f)}}}),n.size===0&&this._residentGeomRecords.get(t).delete(a)}),this._residentGeomRecords.get(t).size===0&&this._residentGeomRecords.delete(t),this._dirtyGeomRecords.delete(t),this._dirtyRecordCount-=r}commitSyncUpdates(t,e){let i=this._dirtyGeomRecords.get(t);i&&i.forEach((r,s)=>{let a=this._ensureGeomRecord(t,s);r.forEach(({geometry:n,operation:o,states:l,sync:h},d)=>{let m=!1;if(o===ei.UPDATE&&h){let u=a.get(d);if(u){if(l&ca.TRANSFORMATION){let f=this.model.getObject(s);this.model.updateRenderGeometryTransformation(f,n,u)&&(m=!0)}m||e.updates.push({renderGeometry:u,updateType:l})}else Wi(!1,"ModelDirtySet.commitSyncUpdates: invalid update")}})})}getResidentRenderGeometries(t,e){let i=this._residentGeomRecords.get(t);i&&i.forEach(r=>r.forEach(s=>e.push(s)))}_objectStateChanged(t,e){for(let i of e.geometries)this._updateOrCreateDirtyRecord(e,i,null,ei.UPDATE,t)}visibilityChanged(t){this._objectStateChanged(ca.VISIBILITY,t)}highlightChanged(t){this._objectStateChanged(ca.HIGHLIGHT,t)}occlusionChanged(t){this._objectStateChanged(ca.OCCLUDEE,t)}attributesChanged({object:t,geometry:e,sync:i}){this._updateOrCreateDirtyRecord(t,e,null,ei.UPDATE,ca.GEOMETRY,i)}layerAdded(t){t.objects.forAll(e=>this._layerObjectAdded(t,e))}layerRemoved(t){t.objects.forAll(e=>this._layerObjectRemoved(t,e))}layerObjectAdded(t){this._layerObjectAdded(t.layer,t.object)}_layerObjectAdded(t,e){let i=t.id;for(let r of e.geometries)this._geometryAdded(e,r,i)}layerObjectRemoved(t){this._layerObjectRemoved(t.layer,t.object)}layerObjectsAdded(t){for(let e of t.objects)this._layerObjectAdded(t.layer,e)}layerObjectsRemoved(t){for(let e of t.objects)this._layerObjectRemoved(t.layer,e)}_layerObjectRemoved(t,e){let i=t.id;for(let r of e.geometries)this._geometryRemoved(e,r,i)}transformationChanged(t){let e=this._getParentLayerId(t),i=t.id;this._ensureGeomRecord(e,i).forEach(r=>{this._updateOrCreateDirtyRecord(t,r.geometry,e,ei.UPDATE,ca.TRANSFORMATION)})}shaderTransformationChanged(t){let e=this._getParentLayerId(t),i=t.id;this._ensureGeomRecord(e,i).forEach(r=>{r.objectShaderTransformationChanged(t.shaderTransformation)})}geometryAdded(t){this._geometryAdded(t.object,t.geometry)}_geometryAdded(t,e,i=null){this._updateOrCreateDirtyRecord(t,e,i,ei.ADD)}geometryRemoved(t){this._geometryRemoved(t.object,t.geometry)}_geometryRemoved(t,e,i=null){this._updateOrCreateDirtyRecord(t,e,i,ei.REMOVE)}_updateOrCreateDirtyRecord(t,e,i,r,s=ca.NONE,a=!1){i=i??this._getParentLayerId(t);let n=t.id,o=e.id,l=this._ensureDirtyRecord(i,n),h=l.get(o);if(h){let d=h.operation;d===ei.REMOVE&&r===ei.ADD&&h.states!==ca.NONE?h.operation=ei.UPDATE:d===ei.REMOVE&&r===ei.ADD||d===ei.ADD&&r===ei.REMOVE?(l.delete(o),this._dirtyRecordCount--):d!==ei.UPDATE||r!==ei.REMOVE&&r!==ei.UPDATE?(Wi((d===ei.REMOVE||d===ei.ADD)&&r===ei.UPDATE,"ModelDirtySet.objectGeometryAdded: inconsistent state"),h.states|=s):(h.operation=r,h.states|=s),h.sync=h.sync||a}else l.set(o,new k0(r,e,s,a)),this._dirtyRecordCount++}_ensureGeomRecord(t,e){let i=this._residentGeomRecords.get(t);i||(i=new Map,this._residentGeomRecords.set(t,i));let r=i.get(e);return r||(r=new Map,i.set(e,r)),r}_ensureDirtyRecord(t,e){let i=this._dirtyGeomRecords.get(t);i||(i=new Map,this._dirtyGeomRecords.set(t,i));let r=i.get(e);return r||(r=new Map,i.set(e,r)),r}_getParentLayerId(t){return t.parentLayer?t.parentLayer.id:Uv}formatDebugInfo(){let t=["ADD","UPD",void 0,"REM"],e="";return this._dirtyGeomRecords.forEach((i,r)=>{i.forEach((s,a)=>{e.length>0&&(e+=`
`),e+=r+"."+a;let n=[];s.forEach(o=>{let l=o.operation;n[l]||(n[l]=[]),n[l].push(o.geometry.id)});for(let o=0;o<n.length;o++)if(n[o]){e+=" "+t[o-1]+": ";for(let l=0;l<n[o].length;l++)e+=n[o][l]+", "}})}),e}get test(){}};c([p()],Ed.prototype,"_dirtyRecordCount",void 0),c([p({constructOnly:!0})],Ed.prototype,"model",void 0),Ed=c([S("esri.views.3d.webgl-engine.lib.ModelDirtySet")],Ed);var jR=Ed;var Od=class extends te{constructor(){super(...arguments),this.dirtySet=new jR({model:this}),this._content=new Map,this._originFactory=new Bb(null)}getObject(t){return this._content.get(t)}add(t){let e=t.id;Wi(!this._content.has(e),"Model/Stage already contains object to be added"),this._content.set(e,t),Kl(t)&&this.dirtySet.layerAdded(t)}remove(t){return!!this._content.has(t.id)&&(this._content.delete(t.id),Kl(t)&&this.dirtySet.layerRemoved(t),!0)}addMany(t){for(let e of t)e&&(Wi(!this._content.has(e.id),"Model/Stage already contains object to be added"),this._content.set(e.id,e))}removeMany(t){for(let e of t)e&&(Wi(this._content.has(e.id),"Model/Stage doesn't contain object to be removed"),this._content.delete(e.id))}has(t){return this._content.has(t.id)}forEachOfType(t,e){this._content.forEach(i=>{i.type===t&&e(i)})}getRenderGeometry(t,e){let i=new jb(e,{castShadow:t.castShadow,objectShaderTransformation:t.shaderTransformation});i.transformation=t.getCombinedStaticTransformation(e,WR);let{localOrigin:r}=e;return i.localOrigin=r??this._originFactory.getOrigin(i.boundingSphere),i}updateRenderGeometryTransformation(t,e,i){if(t==null)return!1;i.transformation=t.getCombinedStaticTransformation(e,WR);let r=this._originFactory.getOrigin(i.boundingSphere);return i.localOrigin!==r}getStats(){let t={},e=Array.from(this._content.values());for(let i=0;i<Wp.COUNT;++i)t[i]=e.filter(r=>r.type===i).length;return{contentTypes:t,dirtySet:this.dirtySet.formatDebugInfo()}}get test(){}};c([p({constructOnly:!0})],Od.prototype,"dirtySet",void 0),Od=c([S("esri.views.3d.webgl-engine.parts.Model")],Od);var WR=Rt();var Ff=class extends Am{constructor(){super(...arguments),this.innerFadeDistance=0,this.altitudeFade=0,this.backgroundColor=_()}},Gh=class extends Ne{constructor(e,i){super(e,i,new Le(zC,()=>import("./chunk-SRBYHTUG.js")))}initializePipeline(e){return qe({blending:e.reduced?jl:zl(_t.SRC_ALPHA,_t.ONE_MINUS_SRC_ALPHA),depthTest:{func:e.reduced?Nt.ALWAYS:Nt.LEQUAL},colorWrite:je})}};var Dd=class extends Nn{constructor(){super(...arguments),this.reduced=!1}};c([ht()],Dd.prototype,"reduced",void 0);var mr=class extends Nr{constructor(){super(...arguments),this.produces="disabled",this.consumes={required:[le.OPAQUE_ENVIRONMENT]}}_enable(){this.produces=le.OPAQUE_ENVIRONMENT,this.requestRender(oe.UPDATE)}_disable(){this.produces="disabled",this.requestRender(oe.UPDATE)}};c([p()],mr.prototype,"produces",void 0),c([p()],mr.prototype,"consumes",void 0),mr=c([S("esri.views.3d.webgl-engine.effects.OpaqueEnvironment")],mr);var Id=class extends Ne{constructor(e,i){super(e,i,new Le(WC,()=>import("./chunk-UAX7EH42.js")))}initializePipeline(){return qe({blending:zl(_t.SRC_ALPHA,_t.ONE_MINUS_SRC_ALPHA),depthTest:{func:Nt.ALWAYS},colorWrite:je})}};var Vf=class extends mr{constructor(){super(...arguments),this.requireGeometryDepth=!0,this._compositingPassParameters=new jC,this._vao=null,this._passParameters=new Ff,this._configuration=new Dd}initialize(){this.techniques.precompile(Gh,this._configuration),this.techniques.precompile(Id),this._configuration.reduced=!0,this.techniques.precompile(Gh,this._configuration),this._configuration.reduced=!1,this.addHandles([P(()=>this.view.environment.background,t=>{let e=t instanceof NC?Vl(t.color):sr;xe(this._passParameters.backgroundColor,e[0]*e[3],e[1]*e[3],e[2]*e[3])},ye),P(()=>this.view._stage?.renderer?.fullResolutionAtmosphere,t=>this._configuration.reduced=!t,ye),P(()=>this.view.environment.atmosphereEnabled,t=>t?this._enable():this._disable(),ye)])}destroy(){this._vao=ge(this._vao)}render(t){let e=t.find(({name:g})=>g===le.OPAQUE_ENVIRONMENT);if(!this.bindParameters.mainDepth)return e;let i=this.renderingContext;this._vao??=ar(i,Bn.Pos2Tex);let r=e.getAttachment(i.gl.DEPTH_STENCIL_ATTACHMENT);this._update();let s=this.techniques.get(Gh,this._configuration);if(!s.compiled)return this.requestRender(oe.UPDATE),e;if(!this._configuration.reduced)return e.detachDepth(),i.bindFramebuffer(e.fbo),i.bindTechnique(s,this.bindParameters,this._passParameters),i.bindVAO(this._vao),i.drawArrays(ft.TRIANGLE_STRIP,0,4),e.attachDepth(r),e;let a=this.techniques.get(Id);if(!a.compiled)return this.requestRender(oe.UPDATE),e;let n=i.getViewport(),o=this.bindParameters.camera,l=ne(o.eye)-ir.radius,h,d=ir.atmosphereHeight;if(l<d){let g=Math.min(1,Math.max(0,l/d));h=Ae(.2,.3,g)}else{let g=Math.min(1,Math.max(0,(l-d)/(15*d)));h=Ae(.3,.6,g)}let m=Ln(Math.round(h*o.fullViewport[2])),u=Ln(Math.round(h*o.fullViewport[3]));i.setViewport(0,0,m,u);let f=this.fboCache.acquire(m,u,"chapman",zt.RGBA);return i.bindFramebuffer(f.fbo),i.clearFramebuffer([0,0,0,1],!0,!0),i.bindTechnique(s,this.bindParameters,this._passParameters),i.bindVAO(this._vao),i.drawArrays(ft.TRIANGLE_STRIP,0,4),i.setViewport(n.x,n.y,n.width,n.height),this._compositingPassParameters.color=f.getTexture(),e.detachDepth(),i.bindFramebuffer(e.fbo),i.bindTechnique(a,this.bindParameters,this._compositingPassParameters),i.screen.draw(),e.attachDepth(r),f.release(),e}_update(){let t=this.bindParameters.camera,e=Mi(t.eye),i=Math.sqrt(e),r=e-this._passParameters.radii[1]**2,s=N((i-this._passParameters.radii[0])/ir.atmosphereHeight,0,1);ls(this._passParameters.heightParameters,i,e,r,s);let a=this.view.basemapTerrain?.getLowerBoundRadius()??0;hs(this._passParameters.radii,a,a+ir.atmosphereHeight),this._passParameters.innerFadeDistance=2*Math.sqrt((2*a-ty)*ty),this._passParameters.altitudeFade=ch(i-a)}};Vf=c([S("esri.views.3d.environment.ChapmanAtmosphere")],Vf);var Ld=class extends Ne{constructor(e,i){super(e,i,new Le(QC,()=>import("./chunk-ENQXZ5GD.js")))}initializePipeline(){return qe({blending:na(_t.ONE,_t.ZERO,_t.SRC_ALPHA,_t.ONE),depthTest:{func:Nt.LEQUAL},colorWrite:je})}};var Uf=class extends mr{constructor(t){super(t),this._planetRadius=Ue(t.view.spatialReference).radius}initialize(){this.techniques.precompile(Ld),this.addHandles([P(()=>this.view.environment.weather!=null&&this.view.environment.atmosphereEnabled,t=>t?this._enable():this._disable(),Ie)])}destroy(){this._vao=ge(this._vao)}render(t){let e=t.find(({name:n})=>n===le.OPAQUE_ENVIRONMENT),i=this.bindParameters.clouds;if(!i.data)return e;let r=this.techniques.get(Ld);if(!r.compiled)return this.requestRender(oe.UPDATE),e;let s=this.renderingContext;this._vao??=ar(s);let a=s.bindTechnique(r,this.bindParameters);return s.bindVAO(this._vao),a.assertCompatibleVertexAttributeLocations(this._vao),s.drawArrays(ft.TRIANGLE_STRIP,0,4),i.isFading&&this.requestRender(oe.UPDATE),e}};Uf=c([S("esri.views.3d.environment.CloudsComposition")],Uf);var Nd=class extends Ne{constructor(e,i){super(e,i,new Le(ZC,()=>import("./chunk-UBXNSB2Z.js")))}initializePipeline(){return qe({blending:na(_t.SRC_ALPHA,_t.ZERO,_t.ONE_MINUS_SRC_ALPHA,_t.ONE),colorWrite:je})}};var ll=class extends mr{constructor(){super(...arguments),this.consumes={required:[le.TRANSPARENT_ENVIRONMENT]}}_enable(){this.produces=le.TRANSPARENT_ENVIRONMENT,this.requestRender(oe.UPDATE)}};c([p()],ll.prototype,"consumes",void 0),ll=c([S("esri.views.3d.webgl-engine.effects.TransparentEnvironment")],ll);var zO=.95,jO=1,Hf=class extends ll{constructor(t){super(t),this.requireGeometryDepth=!0,this._newParameters=new Fd,this._oldParameters=new Fd,this._fadedParameters=new Fd,this._parameters=this._newParameters,this._passParameters=new $C;let e=Ue(t.view.spatialReference);this._planetRadius=e.radius,this._atmosphereRadius=e.radius+e.atmosphereHeight,t.view._stage.renderView.techniques.precompile(Nd)}toogle(){this.view.environment.atmosphereEnabled&&this.view.environment.weather?this._enable():this._disable()}initialize(){this.addHandles([P(()=>this.view.environment.atmosphereEnabled,()=>this.toogle(),ye),P(()=>this.view.environment.weather,()=>this.toogle(),ye),P(()=>this._updateFogParameters(),()=>{},ye)]),this.addHandles(P(()=>this._fadeFactor,t=>this._fade(t),ye))}get _fadeFactor(){return this.view._stage?.renderer.renderContext.bind.clouds.fadeFactor??1}_fade(t){let{_newParameters:e,_oldParameters:i}=this;t>=1?(this._parameters=e,this._oldParameters.copyFrom(this._newParameters)):t<=0?this._parameters=i:(this._fadedParameters.lerp(i,e,t),this._parameters=this._fadedParameters)}_updateFogParameters(){let t=this.view.environment.weather,e=t.type==="foggy"||t.type==="snowy"||t.type==="rainy";this._newParameters.strength=t.type==="foggy"?Ae(3e-5,.005,t.fogStrength**3):t.type==="snowy"||t.type==="rainy"?Ae(4e-6,2e-4,(t.precipitation??0)**3):0,this._newParameters.amount=e?1:0,t.type!=="foggy"&&t.type!=="snowy"||q(this._newParameters.color,QO),t.type==="rainy"&&q(this._newParameters.color,WO),this._fadeFactor>=1&&this._oldParameters.copyFrom(this._newParameters),this.requestRender(oe.UPDATE)}render(t){let e=t.find(({name:a})=>a===le.TRANSPARENT_ENVIRONMENT);if(this._parameters.amount===0||(this._update(),this._passParameters.amount<=0))return e;let i=this.techniques.get(Nd);if(!i.compiled)return this.requestRender(oe.UPDATE),e;let r=this.renderingContext,s=e.getAttachment(r.gl.DEPTH_STENCIL_ATTACHMENT);return e.attachDepth(null),r.bindFramebuffer(e.fbo),r.bindTechnique(i,this.bindParameters,this._passParameters),r.screen.draw(),e.attachDepth(s),e}_update(){let t=this.bindParameters.camera;z(QR,t.eye);let e=Math.max(0,$(QR,this.bindParameters.lighting.mainLight.direction)),i=this._parameters.color;k($R,i,.1),Ui(this._passParameters.color,$R,i,e);let r=ne(t.eye);this._passParameters.atmosphereC=r**2-this._atmosphereRadius**2,this._passParameters.amount=(1-za(zO*Ic,jO*Ic,Math.abs(r-this._planetRadius)))*this._parameters.amount,this._passParameters.strength=this._parameters.strength}};Hf=c([S("esri.views.3d.environment.Fog")],Hf);var Fd=class{constructor(){this.color=_(),this.strength=0,this.amount=0}copyFrom(e){this.amount=e.amount,this.strength=e.strength,q(this.color,e.color)}lerp(e,i,r){this.amount=Ae(e.amount,i.amount,r),this.strength=Ae(e.strength,i.strength,r),Ui(this.color,e.color,i.color,r)}},QR=_(),$R=_(),WO=xt(.5,.5,.5),QO=xt(1.5,1.5,1.5);var Fa=class extends Ne{constructor(e,i){super(e,i,new Le(YC,()=>import("./chunk-C6PDTWZA.js")))}initializePipeline(e){let i=e.geometry===zn.Cylinder;return qe({blending:oa,culling:i?jp:void 0,depthTest:{func:Nt.LEQUAL},colorWrite:je})}};var ZR=new Uint8ClampedArray([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,10,0,0,0,10,0,0,0,10,0,0,0,10,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,13,0,0,0,13,0,0,0,13,0,0,0,13,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,15,0,0,0,15,0,0,0,15,0,0,0,15,0,0,0,15,16,0,0,16,16,0,0,16,16,0,0,16,16,0,0,16,15,0,0,17,15,0,0,17,15,0,0,17,15,0,0,17,14,0,0,18,14,0,0,18,14,0,0,18,13,0,0,19,13,0,0,19,13,0,0,19,13,0,0,19,13,0,0,20,13,0,0,20,13,0,0,20,13,0,0,20,12,0,0,21,12,0,0,21,12,0,0,21,12,0,0,21,12,0,0,22,12,0,0,22,12,0,0,22,12,0,0,22,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,24,11,0,0,24,11,0,0,24,11,0,0,24,10,0,0,25,10,0,0,25,10,0,0,25,10,0,0,26,10,0,0,26,10,0,0,26,10,0,0,26,9,0,0,27,9,0,0,27,9,0,0,27,18,0,0,28,18,0,0,28,18,0,0,28,18,0,0,28,18,0,0,29,18,0,0,29,18,0,0,29,17,0,0,30,17,0,0,30,17,0,0,30,17,0,0,30,16,0,0,31,16,0,0,31,16,0,0,31,16,0,0,32,16,0,0,32,16,0,0,32,15,0,0,33,15,0,0,33,15,0,0,33,15,0,0,34,15,8,0,34,15,8,0,34,15,8,0,34,15,7,0,35,15,7,0,35,15,7,0,35,21,7,0,36,21,7,0,36,21,7,0,36,21,7,0,37,21,7,0,37,21,7,0,37,20,7,0,38,20,7,0,38,20,7,0,38,20,7,0,39,20,7,0,39,20,7,0,39,20,7,0,39,19,6,0,40,19,6,0,40,19,6,0,40,19,6,0,41,19,6,0,41,19,6,0,41,18,6,0,42,18,6,0,42,18,6,0,42,24,6,0,43,24,6,0,43,24,6,0,43,23,6,0,44,23,6,0,44,23,6,0,44,23,6,0,45,23,6,0,45,23,6,0,45,22,6,0,46,22,6,0,46,22,6,0,46,22,5,0,47,22,5,0,47,22,5,0,47,21,5,0,48,21,5,0,48,21,5,0,48,21,5,0,49,21,5,0,49,26,5,0,49,25,5,0,50,25,5,0,50,25,5,0,50,25,5,0,51,25,5,0,51,25,5,0,51,25,5,0,52,25,5,0,52,25,5,0,52,24,5,0,53,24,5,0,53,24,5,0,53,24,9,0,54,28,9,0,54,28,9,0,54,28,9,0,55,28,9,0,55,27,9,0,56,27,9,0,56,27,9,0,56,27,9,4,57,27,9,4,57,27,9,4,57,26,9,4,58,26,9,4,58,26,9,4,58,26,9,4,59,26,9,4,59,26,9,4,59,26,8,4,60,30,8,4,60,30,8,4,60,29,8,4,61,29,8,4,61,29,8,4,62,29,8,4,62,29,8,4,62,28,8,4,63,28,8,4,63,28,8,4,63,28,12,4,64,28,12,4,64,28,12,4,64,27,12,4,65,27,12,8,65,27,12,8,65,31,12,8,66,31,12,8,66,30,11,8,67,30,11,8,67,30,11,8,67,30,11,8,68,30,11,8,68,30,11,8,68,30,15,7,69,30,15,7,69,30,15,7,69,33,15,11,70,33,15,11,70,32,14,11,71,32,14,11,71,32,14,11,71,32,18,14,72,32,18,14,72,32,18,14,72,31,17,14,73,35,17,14,73,34,17,17,74,34,21,17,74,34,21,17,74,34,20,17,75,34,20,20,75,34,20,20,75,34,23,20,76,34,23,20,76,36,23,23,77,36,23,23,77,36,23,23,77,36,23,23,78,36,26,26,78,36,26,26,78,36,26,26,79,36,26,29,79,38,26,29,80,38,29,29,80,38,29,29,80,38,28,31,81,38,28,31,81,38,31,31,81,37,31,34,82,37,31,34,82,37,31,37,83,40,34,37,83,40,34,37,83,39,33,39,84,39,33,39,84,39,36,42,84,39,36,42,85,39,36,42,85,39,36,42,85,39,39,44,86,39,39,44,86,41,38,47,87,41,41,47,87,41,41,50,87,41,41,49,88,41,41,52,88,40,43,52,89,43,43,52,89,43,43,54,89,42,45,54,90,42,45,57,90,42,45,57,90,42,45,59,91,42,48,59,91,44,47,61,92,44,47,61,92,44,50,61,92,44,49,63,93,44,49,63,93,44,52,66,93,43,52,65,94,46,54,68,94,46,54,70,95,46,54,70,95,46,54,70,95,45,56,72,96,45,56,72,96,45,58,74,97,47,58,76,97,47,58,76,97,47,60,78,98,47,60,78,98,47,60,81,98,49,62,80,99,49,62,82,99,48,61,84,100,48,64,84,100,48,64,84,100,50,63,86,101,50,66,86,101,50,66,88,101,50,65,90,102,52,67,89,103,51,69,91,104,51,68,92,105,52,69,93,107,52,71,94,108,54,70,96,109,53,71,96,111,52,73,98,112,54,72,98,114,53,73,100,115,54,72,100,117,54,73,102,118,55,74,104,120,55,76,105,121,56,77,106,123,56,76,107,124,57,79,107,126,58,78,110,128,57,79,111,129,56,80,113,131,58,79,112,132,57,82,114,134,58,81,116,136,60,82,117,137,59,83,117,139,60,83,119,141,59,84,120,142,60,85,122,144,59,86,122,146,60,86,126,148,62,87,127,149,61,88,127,151,62,88,128,153,63,89,130,155,62,90,131,156,63,90,132,158,64,91,134,160,65,91,135,162,64,92,136,163,63,93,138,165,66,95,139,167,65,95,140,169,66,95,142,171,67,96,142,172,66,97,144,174,67,99,145,176,67,97,148,178,67,99,147,180,68,100,149,181,68,100,150,183,69,101,152,185,70,102,153,187,71,103,155,188,70,103,156,190,70,104,157,192,71,105,158,194,71,106,160,195,72,106,161,197,72,108,161,199,73,108,163,200,73,109,164,202,74,109,165,204,74,110,167,206,75,111,168,207,74,112,170,209,75,112,170,210,76,113,171,212,76,114,173,214,77,115,174,215,78,115,175,217,78,116,175,218,78,117,177,220,78,118,178,221,79,118,180,223,80,120,180,224,81,120,181,226,81,120,182,227,82,121,184,229,82,122,185,230,84,123,186,232,83,123,187,233,84,124,189,234,84,125,188,235,85,126,189,237,86,126,190,238,86,127,191,239,87,127,192,240,87,129,193,242,88,129,194,243,89,130,195,244,90,131,196,245,90,132,197,246,91,132,197,247,92,133,198,248,92,134,199,249,93,135,200,250,94,136,201,251,95,137,202,252,96,138,203,253,97,140,204,254,98,141,205,254,99,142,206,255,101,143,207,255,102,144,208,255,103,146,209,255,104,147,209,255,106,148,210,255,107,149,211,255,108,151,212,255,110,152,213,255,111,153,213,255,112,154,214,255,114,156,215,255,115,157,215,255,117,158,216,255,118,160,217,255,120,161,217,255,121,162,218,255,123,164,218,255,124,165,219,255,125,166,219,255,127,167,220,255,129,169,220,255,130,170,221,255,132,171,221,255,133,173,222,255,134,174,222,255,136,175,223,255,139,178,224,255,142,180,224,255,144,182,225,255,147,185,226,255,150,187,226,255,153,189,227,255,155,191,228,255,158,194,228,255,160,196,229,255,163,198,229,255,165,200,230,255,168,202,231,255,170,203,231,255,172,205,232,255,174,207,232,255,176,209,233,255,178,210,234,255,180,212,234,255,182,214,235,255,184,215,236,255,186,217,237,255,188,219,238,255,190,220,238,255,192,221,239,255,193,222,240,255,194,224,240,255,196,225,241,255,197,226,241,255,198,226,242,255,199,227,242,255,200,228,242,255,201,228,243,255,202,229,243,255,203,230,243,255,204,230,244,255,205,231,244,255,207,232,244,255,208,233,245,255,209,233,245,255,211,234,246,255,213,235,246,255,217,238,247,255,222,240,248,255,226,242,249,255,231,245,250,255,236,247,251,255,241,249,252,255,245,251,253,255,249,252,254,255,255,255,255,255]);var qf=class extends mr{constructor(){super(...arguments),this._configuration=new Em,this._passParameters=new Om,this._vao=null,this._vaoCount=0}initialize(){this._configuration.geometry=zn.Cylinder,this.addHandles([P(()=>this.view.environment.atmosphereEnabled,t=>t?this._enable():this._disable(),Ie)])}destroy(){this._passParameters.texture=ge(this._passParameters.texture),this._vao=ge(this._vao)}precompile(){this.techniques.precompile(Fa,this._configuration)}render(t){let e=t.find(({name:a})=>a===le.OPAQUE_ENVIRONMENT),i=this.techniques.get(Fa,this._configuration);if(!i.compiled)return this.requestRender(oe.UPDATE),e;let r=this.renderingContext;if(this._vao||(this._vao=$O(r),this._vaoCount=Hs(this._vao,"geometry")),!this._passParameters.texture){let a=new Ot;a.wrapMode=Jt.CLAMP_TO_EDGE,a.flipped=!0,a.width=1,a.height=512,this._passParameters.texture=new Ft(r,a,ZR)}let s=r.bindTechnique(i,this.bindParameters,this._passParameters);return ZO(YR,this.bindParameters.camera.viewMatrix),s.setUniformMatrix4fv("view",YR),r.bindVAO(this._vao),s.assertCompatibleVertexAttributeLocations(this._vao),r.drawArrays(ft.TRIANGLES,0,this._vaoCount),e}};function $O(t){let e=lb(1,2,!1),{data:i,indices:r}=e[0][1],s=KR.createBuffer(r.length),a=s.position;for(let n=0;n<r.length;++n){let o=3*r[n%3==0?n+2:n%3==2?n-2:n];a.set(n,0,i[o]),a.set(n,1,i[o+1]),a.set(n,2,i[o+2])}return new Lr(t,aa,new Map([["geometry",Ir(KR)]]),new Map([["geometry",wi.createVertex(t,Qi.STATIC_DRAW,s.buffer)]]))}function ZO(t,e){Al(t,e),t[12]=0,t[13]=0,t[14]=0,t[15]=1}qf=c([S("esri.views.3d.environment.LocalAtmosphere")],qf);var YR=Rt(),KR=zr().vec3f(Et.POSITION);var XR=new Uint8ClampedArray([0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,6,0,0,0,6,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,10,0,0,0,10,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,13,0,0,0,13,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,15,0,0,0,15,0,0,0,16,0,0,0,16,0,0,0,16,0,0,0,17,0,0,0,17,0,0,0,18,0,0,0,18,0,0,0,19,0,0,0,19,0,0,0,19,0,0,0,20,0,0,0,20,0,0,0,21,0,0,0,21,0,0,0,22,0,0,0,22,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,24,11,0,0,24,11,0,0,24,10,0,0,25,10,0,0,25,10,0,0,26,10,0,0,26,9,0,0,27,9,0,0,27,9,0,0,28,9,0,0,28,9,0,0,29,9,0,0,29,8,0,0,30,8,0,0,30,8,0,0,31,8,0,0,31,8,0,0,32,8,0,0,32,8,0,0,32,8,0,0,32,8,0,0,33,8,0,0,33,8,0,0,34,7,0,0,35,7,0,0,35,7,0,0,36,7,0,0,36,7,7,0,37,7,7,0,37,7,7,0,38,7,7,0,38,13,7,0,39,13,7,0,39,13,6,0,40,13,6,0,40,12,6,0,41,12,6,0,41,12,6,0,41,12,6,0,42,12,6,0,42,12,6,0,43,12,6,0,43,12,6,0,44,12,6,0,44,11,6,0,45,11,6,6,45,11,6,6,46,11,5,5,47,11,5,5,47,11,5,5,48,11,5,5,48,10,5,5,49,10,5,5,49,10,5,5,50,15,5,5,51,15,5,5,51,15,5,5,51,15,5,5,51,15,5,5,52,15,5,5,52,14,5,5,53,14,5,5,54,14,5,5,54,14,5,5,55,14,5,5,55,14,5,5,56,13,4,4,57,13,4,4,57,13,4,4,58,13,4,4,58,13,4,4,59,13,4,4,59,17,4,4,60,17,4,4,60,17,4,4,60,17,4,4,61,17,4,4,61,16,4,4,62,16,4,4,63,16,4,4,63,16,8,4,64,16,8,4,64,16,8,4,65,15,8,4,66,15,8,4,66,15,8,4,67,19,8,4,68,19,8,4,68,18,7,4,69,18,7,4,69,18,7,4,69,18,7,4,70,18,7,4,70,18,7,4,71,18,7,4,71,18,7,4,72,17,7,3,73,17,7,3,73,21,7,3,74,21,7,3,74,20,7,3,75,20,7,3,76,20,7,3,76,20,7,3,77,20,7,3,77,20,7,3,78,20,7,3,78,20,7,7,78,19,6,6,79,19,10,6,80,19,10,6,80,22,9,6,81,22,9,6,81,22,9,6,82,22,9,6,83,22,9,6,83,21,9,6,84,21,9,6,84,21,9,6,85,21,9,6,86,21,9,6,86,23,9,6,87,23,9,6,87,23,9,6,87,23,9,6,88,23,9,6,88,23,9,6,89,23,8,6,90,23,8,6,90,22,8,6,91,22,8,6,91,25,8,6,92,25,8,5,93,25,8,5,93,24,8,5,94,24,8,5,94,24,11,5,95,24,11,5,96,24,11,5,96,26,11,5,97,26,11,5,97,26,11,5,97,26,10,5,98,26,10,5,98,26,10,5,99,25,10,5,100,25,10,5,100,25,10,5,101,25,10,5,101,25,10,5,102,27,10,5,103,27,10,5,103,27,10,5,104,27,10,5,104,27,12,5,105,26,12,5,106,26,12,5,106,29,12,5,106,29,12,5,106,29,12,7,107,28,12,7,108,28,12,7,108,28,12,7,109,28,12,7,109,30,12,7,110,30,11,7,111,30,11,7,111,30,11,7,112,30,11,7,112,29,11,7,113,29,11,7,114,29,11,7,114,31,11,7,115,31,11,7,115,31,11,7,115,31,11,7,116,31,11,7,116,33,13,7,117,33,13,9,117,32,13,9,118,32,13,9,118,32,13,9,119,34,15,8,120,34,15,8,120,34,15,8,121,36,15,8,121,36,15,8,122,36,15,8,122,35,15,8,123,37,14,8,124,37,14,8,124,37,14,8,124,37,14,8,124,39,14,8,125,39,16,8,125,38,16,8,126,38,16,8,127,38,16,8,127,40,16,10,128,40,16,10,128,40,16,10,129,42,18,10,129,41,18,10,130,41,18,10,130,43,18,10,131,43,18,10,131,42,17,10,132,42,17,12,132,42,17,12,133,44,17,12,133,44,17,12,133,46,17,11,134,46,17,11,134,45,19,11,135,45,19,11,135,47,19,11,136,47,19,11,136,47,19,11,137,47,19,11,137,48,20,11,138,48,20,11,138,50,20,13,139,50,20,13,139,49,20,13,140,49,22,13,140,51,22,13,141,51,22,13,141,50,22,13,142,52,22,13,142,52,21,12,143,53,21,12,143,53,21,12,143,53,21,12,143,53,21,14,144,53,23,14,144,55,23,14,145,55,23,14,145,56,23,14,146,56,23,14,146,57,24,14,147,57,24,14,147,59,24,16,148,59,24,16,148,58,24,15,149,58,26,15,149,58,26,15,149,60,26,15,150,60,26,15,150,61,25,15,151,61,25,15,151,62,25,17,152,62,25,17,152,64,25,17,152,64,27,17,152,63,27,17,153,63,27,17,153,65,27,17,153,66,28,17,154,66,28,17,154,67,28,16,155,67,28,16,155,67,30,16,155,69,29,18,156,69,29,18,156,68,29,18,157,70,29,18,157,70,29,18,157,71,31,18,158,71,31,18,158,72,30,19,159,72,30,19,159,74,30,19,159,73,30,19,160,73,32,19,160,74,32,19,161,74,32,21,161,76,32,21,161,78,33,21,161,78,33,21,161,79,35,20,162,78,34,20,163,79,34,22,164,81,36,22,164,82,36,22,165,81,35,22,166,82,37,21,167,84,37,21,167,85,36,21,168,86,38,23,169,88,38,23,169,88,38,23,170,88,39,23,170,89,39,24,171,91,40,24,171,92,40,24,172,93,40,24,173,94,41,25,173,95,41,25,174,96,42,25,175,98,42,25,175,99,43,26,176,99,43,26,177,101,45,26,177,102,44,26,178,103,46,27,179,104,46,27,179,105,46,27,179,106,45,28,180,108,47,28,180,108,46,28,181,109,48,28,182,111,48,29,182,111,49,29,183,114,49,29,184,114,50,30,184,114,50,30,185,116,51,30,185,117,51,30,186,119,52,31,187,119,53,31,187,121,53,31,188,122,54,33,188,123,54,32,189,124,55,32,189,125,55,32,189,126,56,34,190,128,56,34,190,128,57,33,191,130,57,33,191,131,58,35,192,131,58,35,192,133,59,34,193,134,60,35,194,135,60,35,194,136,61,37,195,139,61,37,195,139,62,36,196,141,62,36,196,141,63,38,197,142,63,38,197,143,64,39,198,144,64,39,198,146,66,39,198,146,67,39,198,147,67,38,199,147,68,40,199,149,68,40,200,150,69,40,200,152,70,41,201,154,71,41,201,154,71,42,202,155,72,42,202,156,73,41,203,157,73,43,203,158,74,42,204,160,75,44,204,161,76,44,204,162,77,44,205,164,77,45,205,165,78,45,206,166,79,45,206,168,80,46,207,169,81,46,207,170,83,47,207,171,83,47,207,172,83,47,207,174,85,48,208,175,85,48,208,177,85,48,209,178,87,49,209,180,87,49,210,181,87,49,210,182,89,50,210,182,89,50,211,185,91,50,211,186,91,51,212,186,93,51,212,189,94,52,212,190,95,51,213,192,96,51,213,193,96,53,213,194,97,52,214,195,98,54,214,197,98,55,215,198,100,55,215,199,101,55,215,200,102,55,216,202,103,55,216,203,104,55,216,204,105,57,216,205,106,57,216,207,107,58,216,208,108,58,217,209,109,59,217,210,110,60,217,211,111,60,218,212,112,61,218,213,113,61,218,214,114,62,219,217,115,63,219,217,116,64,219,218,118,64,220,219,119,65,220,220,121,66,220,222,121,67,221,222,122,67,221,222,123,68,221,223,124,69,222,224,125,70,222,225,127,71,222,226,128,72,223,228,129,73,223,228,130,74,223,229,132,75,223,230,135,79,224,231,138,81,224,233,141,84,224,233,144,87,225,235,147,91,225,236,150,94,225,237,154,97,225,238,158,102,225,239,161,107,225,239,165,110,225,240,168,114,226,241,172,118,226,241,176,122,226,241,181,126,226,242,183,130,227,243,186,135,227,243,190,139,227,244,194,143,227,244,197,147,228,244,200,150,228,245,204,154,228,245,207,157,228,245,210,161,229,246,212,164,229,246,215,167,229,246,217,169,229,246,220,172,230,247,221,174,230]);var Bf=128,JR=-1e4,eP=0,G0=50,YO=()=>1-511/512,KO=Ul([[50,.1015625],[500,.21875],[5e3,1-250/512],[5e4,.4140625]]),j0=class extends mr{constructor(t){super(t),this._passParameters=new Om,this._configuration=new Em,this._vao=null,this._vaoCount=0,this._fadeVao=null,this._fadeVaoCount=0,this._texV1=1;let e=t.view,i=Ue(e.spatialReference),{outerAtmosphereRimWidth:r,radius:s}=i;this._planetRadius=s,this._innerRimFactor=1+JR/s,this._middleRimFactor=1+eP/s,this._outerRimFactor=1+r/s,this._texV0=eP/r,this._texVScale=this._texV1-this._texV0;let a=e._stage.renderView.techniques;a.precompile(Fa,this._configuration),this._configuration.geometry=zn.Underground,a.precompile(Fa,this._configuration)}initialize(){this.addHandles(P(()=>this.view.environment.atmosphereEnabled,t=>t?this._enable():this._disable(),Ie))}destroy(){this._passParameters.texture=ge(this._passParameters.texture),this._fadeVao=ge(this._fadeVao),this._vao=ge(this._vao)}render(t){let e=t.find(({name:r})=>r===le.OPAQUE_ENVIRONMENT);this._update();let i=this.renderingContext;if(!this._passParameters.texture){let r=new Ot;r.wrapMode=Jt.CLAMP_TO_EDGE,r.flipped=!0,r.width=1,r.height=512,this._passParameters.texture=new Ft(i,r,XR)}if(this._passParameters.undergroundFadeAlpha<1){this._vao||(this._vao=this._createRibbon(i),this._vaoCount=Hs(this._vao,"geometry")),this._configuration.geometry=zn.Cone;let r=this.techniques.get(Fa,this._configuration);if(!r.compiled)return this.requestRender(oe.UPDATE),e;i.bindTechnique(r,this.bindParameters,this._passParameters),i.bindVAO(this._vao),i.drawArrays(ft.TRIANGLES,0,this._vaoCount)}if(this._passParameters.undergroundFadeAlpha>0){this._fadeVao||(this._fadeVao=ar(i),this._fadeVaoCount=Hs(this._fadeVao,"geometry")),this._configuration.geometry=zn.Underground;let r=this.techniques.get(Fa,this._configuration);if(!r.compiled)return this.requestRender(oe.UPDATE),e;i.bindTechnique(r,this.bindParameters,this._passParameters),i.bindVAO(this._fadeVao),i.drawArrays(ft.TRIANGLE_STRIP,0,this._fadeVaoCount)}return e}_update(){let t=this.bindParameters.camera,e=_(),i=this._planetRadius,r=ne(t.eye),s=r-i;if(s<0){let u=Math.min(-s/5e3,1);this._passParameters.undergroundFadeAlpha=u}else this._passParameters.undergroundFadeAlpha=0;let a=Math.max(G0,s),n=i+JR;this._passParameters.innerScale=XO(i+a,i,n)-1,this._passParameters.altitudeFade=ch(s),k(e,t.eye,(i+G0)/r),tP(e,t.center,t.up,i,this._passParameters.silhouette);let o=this._computeScreenRimWidth(t,e,t.up,this._passParameters.silhouette),l=YO(),h=KO(s),d=this._texV0+l*this._texVScale,m=this._texV0+o*h*this._texVScale;if(s>G0){tP(t.eye,t.center,t.up,i,this._passParameters.silhouette);let u=this._computeScreenRimWidth(t,t.eye,t.up,this._passParameters.silhouette),f=N((u-1.5)/(o-1.5),0,1);d=this._texV0+f*l*this._texVScale,m=this._texV0+Ae(this._texV1,o*h,f)*this._texVScale}hs(this._passParameters.texV,d,m)}_createRibbon(t){let e=Sp(3+3*Bf*3),i=new Uint32Array(3*Bf*5);e[0]=0,e[1]=0,e[2]=-1;for(let a=0;a<Bf;a++){let n=9*a+3;e[n]=a,e[n+1]=this._innerRimFactor,e[n+2]=-1,e[n+3]=a,e[n+4]=this._middleRimFactor,e[n+5]=0,e[n+6]=a,e[n+7]=this._outerRimFactor,e[n+8]=1;let o=3*a+1,l=a===Bf-1?1:o+3,h=15*a;i[h]=o,i[h+1]=o+1,i[h+2]=l+1,i[h+3]=l+1,i[h+4]=l,i[h+5]=o,i[h+6]=o+1,i[h+7]=o+2,i[h+8]=l+2,i[h+9]=l+2,i[h+10]=l+1,i[h+11]=o+1,i[h+12]=o,i[h+13]=l,i[h+14]=0}let r=iP.createBuffer(i.length),s=r.position;for(let a=0;a<i.length;++a){let n=3*i[a];s.set(a,0,e[n]),s.set(a,1,e[n+1]),s.set(a,2,e[n+2])}return new Lr(t,aa,new Map([["geometry",Ir(iP)]]),new Map([["geometry",wi.createVertex(t,Qi.STATIC_DRAW,r.buffer)]]))}_computeScreenRimWidth(t,e,i,r){return K(zh,r.center,r.v2),k(kf,zh,this._outerRimFactor),m1(z0,e,zh,i),ug(zh,z0,t.projectionMatrix,t.viewport,zh),ug(kf,z0,t.projectionMatrix,t.viewport,kf),It(zh,kf)/t.height}};function tP(t,e,i,r,s){let a=ne(t),n=r*Math.sqrt(a*a-r*r)/a,o=Math.sqrt(r*r-n*n),l=s.v1,h=s.v2;return k(s.center,t,o/a),Qe(l,t,e),Mi(l)<1&&Qe(l,t,i),k(l,l,n/ne(l)),Qe(h,l,t),k(h,h,n/ne(h)),n}j0=c([S("esri.views.3d.environment.MarsAtmosphere")],j0);var z0=Rt(),zh=_(),kf=_();function XO(t,e,i){return t*t/(Math.sqrt(t*t-e*e)*Math.sqrt(t*t-i*i)+e*i)}var iP=zr().vec3f(Et.POSITION),rP=j0;var Gf=class{constructor(e){this._totalCount=e,this._componentCountCache=-1,this._indexRanges=[0,e]}allVisible(){return this.componentCount===this._totalCount}allInvisible(){return this._indexRanges.length===0}isVisible(e){if(e<0||e>=this._totalCount)return!1;if(this.allVisible())return!0;{let i=this._indexRanges,r=0,s=i.length/2;if(e<i[2*r]||e>i[2*s]+i[2*s+1])return!1;for(;s-r>0;){let a=Math.floor(.5*(r+s)),n=i[2*a];if(e<n){if(s-r==1)return!1;s=a;continue}if(e<n+i[2*a+1])return!0;if(s-r==1)return!1;r=a+1}return!1}}get componentCount(){if(this._componentCountCache===-1){let e=this._indexRanges,i=0;for(let r=0;r<e.length;r+=2)i+=e[r+1];this._componentCountCache=i}return this._componentCountCache}reset(e){e==="all"||e.length===this._totalCount?this._indexRanges=[0,this._totalCount]:this._indexRanges=JO(e),this._componentCountCache=-1}forEachComponent(e){let i=this._indexRanges;for(let r=0;r<i.length;r+=2){let s=i[r],a=s+i[r+1];for(let n=s;n<a;n++)if(!e(n))return!1}return!0}forEachComponentRange(e){let i=this._indexRanges;for(let r=0;r<i.length;r+=2){let s=i[r];if(!e(s,s+i[r+1]))return!1}return!0}computeOffsetRanges(e){let i=new Array(this._indexRanges.length),r=this._indexRanges;for(let s=0;s<r.length;s+=2){let a=r[s],n=a+r[s+1],o=e[a],l=e[n];i[s]=o,i[s+1]=l-o}return i}};function JO(t){let e=new Array;if(t.length===0)return e;let i=t[0],r=1;for(let s=1;s<t.length;s++){let a=t[s];i+r===a?r+=1:(e.push(i),e.push(r),i=a,r=1)}return e.push(i),e.push(r),e}var zf=class{constructor(e,i){this.offsets=i,this._highlightsInOrder=[],this.pickability=null,this.componentHighlights=new Map,this.verticalOffsets=null,this.cachedGeometryRanges=null,this.cachedHighlightRangesMap=null,this.cachedShadowmapRanges=null;let r=this.count;this.visibility=new Gf(r),this.materialDataBuffer=e.getBuffer(r),this.materialDataIndices=new Uint16Array(r);for(let s=0;s<r;s++)this.materialDataIndices[s]=this.materialDataBuffer.acquireIndex()}destroy(){for(let e=0;e<this.count;e++)this.materialDataBuffer.releaseIndex(this.materialDataIndices[e])}get count(){return this.offsets.length-1}get geometryRanges(){return this.cachedGeometryRanges==null&&(this.cachedGeometryRanges=this.visibility.computeOffsetRanges(this.offsets)),this.cachedGeometryRanges}get highlightRangesMap(){return this.componentHighlights.size===0?null:(this._updateCachedHighlightRanges(),this.cachedHighlightRangesMap)}get shadowmapRanges(){return this.componentHighlights.size===0?this.geometryRanges:(this._updateCachedHighlightRanges(),this.cachedShadowmapRanges)}markHighlightsDirty(){this.cachedHighlightRangesMap=null,this.cachedShadowmapRanges=null}markVisibilityDirty(){this.cachedGeometryRanges=null,this.markHighlightsDirty()}updateHighlights(e){this._updateHighlightOrder(e)&&(this.markHighlightsDirty(),this._updateCachedHighlightRanges())}_updateHighlightOrder(e){let{_highlightsInOrder:i}=this,r=i.length!==e.length;i.length=Math.min(e.length,8);for(let s=0;s<e.length;++s){let a=e.at(s).name;i.length<s?(r=!0,i.push(a)):i[s]!==a&&(i[s]=a,r=!0)}return r}_updateCachedHighlightRanges(){if(this.cachedHighlightRangesMap==null||this.cachedShadowmapRanges==null){let{highlightRangesMap:e,shadowmapRangesMap:i}=e2(this.componentHighlights,this.visibility,this.offsets,this._highlightsInOrder);this.cachedHighlightRangesMap=e,this.cachedShadowmapRanges=i}}};function e2(t,e,i,r){let s=new Map,a=[];if(t.size>0){let n=i.length;e.forEachComponent(o=>{let l=!1;for(let h=r.length-1;h>=0;--h){let d=r[h];if((t.get(d)?.[o]??0)>0){let u=hp(s,d,()=>[]),f=i[o],g=i[o+1];u.push(f),u.push(g-f),l||=d===Ac;break}}return l||(n!==o-1&&(a.length>0&&a.push(i[n+1]-a[a.length-1]),a.push(i[o])),n=o),!0}),a.length>0&&a.push(i[n+1]-a[a.length-1])}return{highlightRangesMap:s,shadowmapRangesMap:a}}var jf=class{constructor(e,i,r,s,a,n){this.transform=e,this.toMapSpace=i,this.obb=r,this.componentData=s,this.renderable=a,this.intersectionGeometry=n,this.visible=!1,this.offsetObb=null}destroy(){this.intersectionGeometry=G(this.intersectionGeometry),this.renderable=G(this.renderable),this.componentData=G(this.componentData)}};function sP(t,e,i,r,s,a,n){let o=a-n,l=e-t,h=new Float64Array(4*l);for(let d=0;d<l;++d){let m=3*(d+t),u=s*i[m+0],f=r[u+0],g=r[u+1],y=o/(r[u+2]-n),v=f*y,w=g*y,b=s*i[m+1],R=r[b+0],C=r[b+1],x=o/(r[b+2]-n),T=R*x,M=C*x,E=s*i[m+2],O=r[E+0],Z=r[E+1],H=o/(r[E+2]-n),B=O*H,X=Z*H,I=4*d;h[I+0]=Math.min(v,T,B),h[I+1]=Math.min(w,M,X),h[I+2]=Math.max(v,T,B),h[I+3]=Math.max(w,M,X)}return h}function aP(t,e,i,r,s){let a=e-t,n=new Float64Array(4*a);for(let o=0;o<a;++o){let l=3*(o+t),h=s*i[l+0],d=r[h+0],m=r[h+1],u=s*i[l+1],f=r[u+0],g=r[u+1],y=s*i[l+2],v=r[y+0],w=r[y+1],b=4*o;n[b+0]=Math.min(d,f,v),n[b+1]=Math.min(m,g,w),n[b+2]=Math.max(d,f,v),n[b+3]=Math.max(m,g,w)}return n}function nP(t,e){return new(t2(t))(e)}function t2(t){return t<128?Uint8Array:t<32768?Uint16Array:t<1<<31?Uint32Array:Array}var jh=class{constructor(e,i){this.elementCount=e,this.model=i,this._elementIndexMap=null,this._bspNodes=[],this._generatedBVH=!1,this.localMode=i.localMode,this.planetCenterZ=i.planetCenterZ,this.geometryMinZ=i.geometryMinZ,this.planetCenter=xt(0,0,this.planetCenterZ),this.maxBspNodeDepth=i.maxBspNodeDepth??8,this.minElementCountForBVH=i.minElementCountForBVH??15,this.minBspNodeElementCount=i.minBspNodeElementCount??5}get elementIndexMap(){return this._ensureBVH(),this._elementIndexMap}get _skipBVH(){return this.elementCount<this.minElementCountForBVH||this.geometryMinZ<.5*this.planetCenterZ}_ensureBVH(){this._generatedBVH||this._skipBVH||this._bspNodes.length===0&&this._generateBsp()}intersectRay(e,i,r){this.elementCount<1||(this._skipBVH?this._intersectRayWithoutBVH(r):this._intersectRayWithBVH(e,i,r))}_intersectRayWithoutBVH(e){this._intersectRange(0,this.elementCount)}_intersectRange(e,i){this.model.intersectRange(e,i)}_intersectRayWithBVH(e,i,r){this._ensureBVH(),r?this._intersectGeometryWithBVHVerticalRay(e):this._intersectGeometryWithBVHGeneralRay(e,i)}_intersectGeometryWithBVHVerticalRay(e){let i=e[0],r=e[1];if(!this.localMode){let{geometryMinZ:n,planetCenterZ:o}=this,l=(n-o)/(e[2]-o);i=e[0]*l,r=e[1]*l}let{_bspNodes:s}=this,a=0;for(;a>=0;){let n=s[a],{d:o,dim:l,minIndexIndex:h,minMidIndexIndex:d,maxMidIndexIndex:m,maxIndexIndex:u,aabb2D:f}=n;if(i<f[0]||i>f[2]||r<f[1]||r>f[3])break;if(l===-1||n.child0===-1&&n.child1===-1){this._intersectRange(h,u);break}{this._intersectRange(d,m);let g=(l===0?i:r)-o;if(g<0){if(n.child0===-1){this._intersectRange(h,d);break}a=n.child0}else{if(!(g>0))break;if(n.child1===-1){this._intersectRange(m,u);break}a=n.child1}}}}_intersectGeometryWithBVHGeneralRay(e,i){let r=e[0],s=e[1],a=i[0],n=i[1],{geometryMinZ:o}=this;if(!this.localMode){let g=0,y=1,v=Math.min(.5*this.planetCenterZ,o),w=e[2],b=i[2];if(w<v&&b<v||(w<v&&(g=(v-w)/(b-w)),b<v&&(y=(v-w)/(b-w)),g>y))return;let R=(1-g)*e[0]+g*i[0],C=(1-g)*e[1]+g*i[1],x=(1-g)*e[2]+g*i[2],T=(1-y)*e[0]+y*i[0],M=(1-y)*e[1]+y*i[1],E=(1-y)*e[2]+y*i[2],{planetCenterZ:O}=this,Z=o-O,H=Z/(x-O);r=R*H,s=C*H;let B=Z/(E-O);a=T*B,n=M*B}let l=a-r,h=n-s,d=this._bspNodes,m=1;{let{aabb2D:g}=d[0],y=(b,R,C,x)=>{if(Math.abs(R)<1e-5*Math.max(x-C,1))return!1;let T=R>0,M=T?x:C,E=b+m*R;return(T?E<M:E>M)&&(m=Math.max((M-b)/R,m),!0)},v=()=>y(r,l,g[0],g[2]),w=()=>y(s,h,g[1],g[3]);Math.abs(l)>=Math.abs(h)?v()||w():w()||v()}let u=[0,0,m],f=0;for(;f<u.length;){let g=u[f],y=u[f+1],v=u[f+2];if(f+=3,y>v)continue;let w=d[g],{minIndexIndex:b,maxIndexIndex:R}=w,{child0:C,child1:x,minMidIndexIndex:T,maxMidIndexIndex:M,aabb2D:E,d:O,dim:Z}=w;{let H=r+y*l,B=r+v*l,X=Math.min(H,B),I=Math.max(H,B),A=E[0],re=E[2];if(I<A||re<X)continue;if(X<A){let U=(A-r)/l;l>0?y=Math.max(y,U):v=Math.min(v,U)}if(re<I){let U=(re-r)/l;l>0?v=Math.min(v,U):y=Math.max(y,U)}}{let H=s+y*h,B=s+v*h,X=Math.min(H,B),I=Math.max(H,B),A=E[1],re=E[3];if(I<A||re<X)continue;if(X<A){let U=(A-s)/h;h>0?y=Math.max(y,U):v=Math.min(v,U)}if(re<I){let U=(re-s)/h;h>0?v=Math.min(v,U):y=Math.max(y,U)}}if(C===-1&&x===-1)this._intersectRange(b,R);else{let H=Z===0?r:s,B=Z===0?l:h,X=H+y*B,I=H+v*B,A=Math.min(X,I),re=Math.max(X,I),U=N((O-H)/B,0,m);b<T&&A<=O&&(C!==-1?(u.push(C),u.push(B>=0?y:Math.max(y,U)),u.push(B>=0?Math.min(v,U):v)):this._intersectRange(b,T)),this._intersectRange(T,M),M<R&&O<=re&&(x!==-1?(u.push(x),u.push(B>=0?Math.max(y,U):y),u.push(B>=0?v:Math.min(v,U))):this._intersectRange(M,R))}}}_generateBsp(){let{elementCount:e}=this;if(e<1)return;let i=nP(e,e);this._elementIndexMap=i;for(let f=0;f<e;++f)i[f]=f;let r=this.model.getAabbs2D(),s=0,a=this._bspNodes;a.length=0;let{localMode:n}=this,o=!1;if(!n){let{planetCenterZ:f,geometryMinZ:g}=this;o=f>=0||g<.5*f}let l=[],h=(f,g,y,v,w)=>{l.push(f),l.push(g),l.push(y),l.push(v<0?-1:(w?0:1)+2*v)},{maxBspNodeDepth:d,minBspNodeElementCount:m}=this,u=(f,g,y,v,w)=>{let b=a.length;if(b>0&&(o||y>=d||g-f<m))return;let R=[0,0,0,0];a2(R,f,g,i,r);let{d:C,dim:x}=n?i2(R):r2(R),{rangeMidStart:T,rangeMidEnd:M}=s2(f,g,x,C,i,r),E=y===d-1,O=!E&&T>=f+m,Z=!E&&g>=M+m;if(O||Z||b===0){let H=new W0(f,T,M,g,x,C,R);if(O&&h(f,T,y+1,b,!0),Z&&h(M,g,y+1,b,!1),a.push(H),v!==-1){let B=a[v];w?B.child0=b:B.child1=b}}};for(h(0,e,0,-1,!1);s<l.length;){let f=l[s],g=l[s+1],y=l[s+2],v=l[s+3];s+=4;let w=v>>1;u(f,g,y,w,v-(w<<1)==0)}this._generatedBVH=!0}};function i2(t){let e=t[0],i=t[1],r=t[2],s=t[3],a,n;return r-e>=s-i?(n=.5*(e+r),a=0):(n=.5*(i+s),a=1),{d:n,dim:a}}function r2(t){let e=t[0],i=t[1],r=t[2],s=t[3],a,n;return r-e>=s-i?(a=0,n=.5*(e+r)):(a=1,n=.5*(i+s)),{dim:a,d:n}}function s2(t,e,i,r,s,a){let n=t;{let d=e;for(;n<d;){let m=s[n];oP(m,i,r,a)<0?++n:(--d,s[n]=s[d],s[d]=m)}}let o=n,l=n,h=e;for(;l<h;){let d=s[h-1];oP(d,i,r,a)>0?--h:(s[h-1]=s[l],s[l]=d,++l)}return{rangeMidStart:o,rangeMidEnd:h}}function oP(t,e,i,r){let s=4*t,a=r[s+0+e];return r[s+2+e]<i?-1:a>i?1:0}function a2(t,e,i,r,s){let a=1/0,n=1/0,o=-1/0,l=-1/0;for(let h=e;h<i;++h){let d=4*r[h];a=Math.min(a,s[d+0]),n=Math.min(n,s[d+1]),o=Math.max(o,s[d+2]),l=Math.max(l,s[d+3])}t[0]=a,t[1]=n,t[2]=o,t[3]=l}var W0=class{constructor(e,i,r,s,a,n,o){this.minIndexIndex=e,this.minMidIndexIndex=i,this.maxMidIndexIndex=r,this.maxIndexIndex=s,this.dim=a,this.d=n,this.aabb2D=o,this.child0=-1,this.child1=-1}};var Wf=class{constructor(e,i,r,s,a,n,o,l,h){this.componentIndex=e,this.vertexData=i,this.vertexStride=r,this.indexData=s,this.startTriangleNumber=a,this.endTriangleNumber=n,this.geometryMinZ=o,this.planetCenterZ=l,this.localMode=h,this.maxBspNodeDepth=8,this.minElementCountForBVH=20,this.minBspNodeElementCount=10,this.rayDirection=_(),this.ray0=_(),this.isVerticalRay=!1,this._triangleHitCallback=lP,this.totalElevationOffset=0,this.normalRequired=!1,this._bvh=new jh(n-a,this)}getAabbs2D(){return this.localMode?aP(this.startTriangleNumber,this.endTriangleNumber,this.indexData,this.vertexData,this.vertexStride):sP(this.startTriangleNumber,this.endTriangleNumber,this.indexData,this.vertexData,this.vertexStride,this.geometryMinZ,this.planetCenterZ)}get numTriangles(){return this.endTriangleNumber-this.startTriangleNumber}intersectRay(e,i,r,s,a,n){q(this.ray0,e),bt(this.rayDirection,i,e),this.isVerticalRay=r,this.totalElevationOffset=s,this.normalRequired=n,this._triangleHitCallback=a,this._bvh.intersectRay(e,i,r),this._triangleHitCallback=lP}intersectRange(e,i){let r=this._bvh.elementIndexMap;Q0(this.ray0,this.rayDirection,e,i,this.indexData,this.vertexData,this.vertexStride,this.totalElevationOffset,this.planetCenterZ,this.normalRequired,this._triangleHitCallback,r,this.startTriangleNumber)}getTriangleElevationOffset(e){return this.totalElevationOffset}};function Q0(t,e,i,r,s,a,n,o,l,h,d,m=null,u=0){o!==0?ib(t,e,i,r,s,a,n,o,l,h,d,m,u):$p(t,e,i,r,s,a,n,h,d,m,u)}function lP(){}function hP(t,e,i,r){if(i>=e)return t;t==null&&(t=n2());let s=t.isVisibleBit,a=t.data,n=cP(a),o=i/n|0,l=i-n*o,h=(e-1)/n|0,d=a,m=r===s;if(!(i<d.length*n)&&m){let u=o+1,f=Math.ceil(d.length*Rv),g=h+1,y=Math.max(u,f);y=Math.min(y,g),a=new Uint32Array(y),a.set(d)}return o<a.length&&(a[o]=l2(a[o],l,m)),t.data=a,t}function Vd(t,e){if(t==null)return!0;let{isVisibleBit:i,data:r}=t,s=cP(r);return e<r.length*s?o2(i,r,e,s):!t.isVisibleBit}function n2(t=!0){return{isVisibleBit:!t,data:new Uint32Array(0)}}function o2(t,e,i,r){let s=i/r|0,a=i-s*r;return h2(e[s],a)===t}function cP(t){return t.BYTES_PER_ELEMENT*8}function l2(t,e,i){return t&~(1<<e)|(i?1:0)<<e}function h2(t,e){return!!(t&1<<e)}var Qf=class{constructor(e,i,r,s,a,n,o,l){this.vertexData=e,this.vertexStride=i,this.indexData=r,this._components=s,this._componentAabbs3D=a,this.geometryMinZ=n,this.planetCenterZ=o,this.localMode=l,this.maxBspNodeDepth=6,this.minElementCountForBVH=10,this.minBspNodeElementCount=3,this._ray0=m2,this._ray1=u2,this._invDir=_(),this._componentVerticalOffsets=null,this._verticalOffset=null,this._tolerance=0,this._intersectionOptions=f2,this._callback=dP,this.rayDirectionC=_(),this._componentIndexMap=null,this._bvh=new jh(s.count,this),this.componentIntersectionData=new Array(s.count)}get numComponents(){return this._components.count}get minZGlobal(){return this.geometryMinZ-this.planetCenterZ}getAabbs2D(){return this.localMode?this.getAabbs2DLocal():this.getAabbs2DGlobal()}getAabbs2DGlobal(){let{numComponents:e,planetCenterZ:i,minZGlobal:r}=this,s=new Float64Array(4*e),a=this._componentAabbs3D;for(let n=0;n<e;++n){let o=6*n,l=a[o+0],h=a[o+1],d=a[o+2],m=a[o+3],u=a[o+4],f=r/(d-i),g=r/(a[o+5]-i),y=Math.min(l*f,l*g),v=Math.min(h*f,h*g),w=Math.max(m*f,m*g),b=Math.max(u*f,u*g),R=4*n;s[R+0]=y,s[R+1]=v,s[R+2]=w,s[R+3]=b}return s}getAabbs2DLocal(){let{numComponents:e}=this,i=new Float64Array(4*e),r=this._componentAabbs3D;for(let s=0;s<e;++s){let a=6*s,n=r[a+0],o=r[a+1],l=r[a+3],h=r[a+4],d=4*s;i[d+0]=n,i[d+1]=o,i[d+2]=l,i[d+3]=h}return i}intersectRay(e,i,r,s,a,n,o){let{isVerticalRay:l}=o;this._ray0=e,this._ray1=i,this._componentVerticalOffsets=r,this._verticalOffset=s,this._tolerance=n,this._intersectionOptions=o,this._componentIndexMap=this._bvh.elementIndexMap,rb(e,i,this._invDir),this._callback=a,this._bvh.intersectRay(e,i,l),this._callback=dP}intersectRange(e,i){let r=this._componentIndexMap,s=this._components,a=s.pickability,n=s.visibility;for(let o=e;o<i;++o){let l=r?r[o]:o;Vd(a,l)&&n.isVisible(l)&&this._intersectComponent(l)}}getComponentTriangleCount(e){let i=this._components.offsets,r=i[e]/3;return i[e+1]/3-r}getComponentAabb3D(e,i){let r=this._componentAabbs3D,s=6*e;return i[0]=r[s],i[1]=r[s+1],i[2]=r[s+2],i[3]=r[s+3],i[4]=r[s+4],i[5]=r[s+5],i}_intersectComponent(e){if(!Vd(this._components.pickability,e))return;let i=this.getComponentAabb3D(e,c2),r=!1,{localMode:s,_componentVerticalOffsets:a,_verticalOffset:n,_ray0:o,_ray1:l,_invDir:h,planetCenterZ:d,_tolerance:m,rayDirectionC:u,componentIntersectionData:f}=this,{isVerticalRay:g}=this._intersectionOptions,y=this._components.offsets,v=q(d2,o),w=q(p2,l),b=a?.[e]??0,R=b+(n?.offset??0);if(R!==0&&(s?(v[2]=o[2]-R,w[2]=l[2]-R,r=!0):n!=null&&(n.componentOffset=b)),n==null||r||R===0||n.applyToAabb(i),!sb(i,v,h,m))return;bt(u,w,v);let C=y[e]/3,x=y[e+1]/3,T=x-C,M=(X,I,A)=>{this._callback(X,I,e,A)},{vertexData:E,vertexStride:O,indexData:Z,_intersectionOptions:H}=this,{normalRequired:B}=H;if(T>_2){let X=f[e];X==null&&(X=new Wf(e,E,O,Z,C,x,this.geometryMinZ,d,s),f[e]=X),X.intersectRay(v,w,g,r?0:R,M,B)}else Q0(v,u,C,x,Z,E,O,r?0:R,d,B,M)}},c2=El(),d2=_(),p2=_(),m2=_(),u2=_(),dP=()=>{},f2=new Zl,_2=40;var $f=class{constructor(e,i,r){this.viewingMode=e,this.positionData=i,this._components=r,this.verticalOffset=null,this.componentVerticalOffsets=null,this._planetCenter=_(),this._componentBvh=null,this._aabb=[0,0,0,0,0,0],this._indices=i.indices?xp(i.indices):H1(i.positions.length/3),this._positions=i.positions}destroy(){this._positions=null,this._indices=null,this._perComponentAabbs=null,this._componentBvh=null}getComponentAabb(e,i){let r=this._ensureComponentAabbs(),s=6*e;return i[0]=r[s],i[1]=r[s+1],i[2]=r[s+2],i[3]=r[s+3],i[4]=r[s+4],i[5]=r[s+5],i}getComponentAabbs(){return this._ensureComponentAabbs()}_ensureComponentAabbs(){return this._perComponentAabbs||(this._perComponentAabbs=this._computePerComponentAabbs()),this._perComponentAabbs}getComponentPositions(e,i){i.indices=this._indices,i.data=this._positions,i.stride=3,i.startIndex=this._components.offsets[e],i.endIndex=this._components.offsets[e+1]}intersect(e,i,r,s,a,n,o,l){this.verticalOffset=s,this.componentVerticalOffsets=a;let{position:h}=n,d=bt(g2,e,h),m=bt(y2,i,h),u=Mp(v2,n.rotationScale);ds(d,d,u),ds(m,m,u);let f=Nl(b2,u);if(this.viewingMode===me.Global){let y=this._planetCenter;Gr(y,h),ds(y,y,u)}let g=(y,v,w,b)=>{l(w,y,b?ds(w2,b,f):null,v)};this._intersectComponents(d,m,a,s,g,r,o)}_computePerComponentAabbs(){let e=this._aabb,i=.5*(e[0]+e[3]),r=.5*(e[1]+e[4]),s=.5*(e[2]+e[5]),a=this._components.count,n=Sp(6*a),o=this._indices,l=this._positions,h=this._components.offsets,d=0,m=1/0,u=1/0,f=1/0,g=-1/0,y=-1/0,v=-1/0;for(let w=0;w<a;w++){let b=h[w],R=h[w+1],C=1/0,x=1/0,T=1/0,M=-1/0,E=-1/0,O=-1/0;if(b<R)for(let Z=b;Z<R;Z++){let H=3*o[Z],B=l[H],X=l[H+1],I=l[H+2];C=Math.min(C,B),x=Math.min(x,X),T=Math.min(T,I),M=Math.max(M,B),E=Math.max(E,X),O=Math.max(O,I)}else C=i,x=r,T=s,M=i,E=r,O=s;n[d++]=C,n[d++]=x,n[d++]=T,n[d++]=M,n[d++]=E,n[d++]=O,m=Math.min(m,C),u=Math.min(u,x),f=Math.min(f,T),g=Math.max(g,M),y=Math.max(y,E),v=Math.max(v,O)}return this._aabb[0]=m,this._aabb[1]=u,this._aabb[2]=f,this._aabb[3]=g,this._aabb[4]=y,this._aabb[5]=v,n}_intersectComponents(e,i,r,s,a,n,o){let l=this._componentBvh;l==null&&(l=new Qf(this._positions,3,this._indices,this._components,this._ensureComponentAabbs(),this.geometryMinZ,this.planetCenterZ,this.localMode),this._componentBvh=l),l.intersectRay(e,i,r,s,a,n,o)}get geometryMinZ(){return this._aabb[2]}get planetCenterZ(){return this._planetCenter[2]}get numTriangles(){return this._indices.length/3}get localMode(){return this.viewingMode===me.Local}get positions(){return this._positions}get indices(){return this._indices}get aabb(){return this._ensureComponentAabbs(),this._aabb}},g2=_(),y2=_(),v2=jr(),w2=_(),b2=jr();var Zf=class{constructor(e,i,r){this.material=e,this.geometry=i,this.meta=r}destroy(){this.material.dispose(),this.geometry.dispose()}};var Yf=class{constructor(e,i,r,s){this.vao=e,this.primitiveType=i,this.parameters=r,this.indexed=s}dispose(){this.vao.dispose()}};function gP(t,e){let i=new qi,{eye:r,frustum:s,viewForward:a}=t;e.forAll(n=>{let o=n.offsetObb!=null?n.offsetObb:n.obb,l=$(bt(es,o.center,r),a),h=o.projectedRadius(a);if(i.within(l-h)&&i.within(l+h))return;let d=R2(o,s);if(d===-1)return;if(d===0)return mn.far=l+h,mn.near=l-h,void i.union(mn);let m=Kf.pushNew();m.near=l-h,m.far=l+h,m.mask=d,m.object=n});for(let n=0;n<Kf.length;n++){let o=Kf.data[n];if(i.within(o.near)&&i.within(o.far))continue;mn.far=o.far,mn.near=1/0,S2(o.object.offsetObb!=null?o.object.offsetObb:o.object.obb,r,T2,h=>{let d=C2;for(let m=0;m<yP&&h.length>0;m++){if(!(o.mask&1<<m))continue;x2(s[m],h,d);let u=h;h=d,d=u}for(let m=0;m<h.length;m+=3){xe(Rr,h.data[m],h.data[m+1],h.data[m+2]);let u=$(bt(Rr,Rr,r),a);mn.near=Math.min(mn.near,u)}})===0&&(mn.near=0),i.union(mn)}return Kf.length=0,i}var Kf=new Xe({allocator:t=>t||{near:1/0,far:-1/0,mask:0,object:null},deallocator:t=>(t.object=null,t)}),mn=new qi,Rr=_(),hl=_(),T2=new Xe({deallocator:null}),C2=new Xe({deallocator:null});function x2(t,e,i){i.length=0;let r=e.length-3;$0(Rr,e,r);let s=$a(t,Rr);s<=0&&(i.push(Rr[0]),i.push(Rr[1]),i.push(Rr[2]));let a=0,n=s;for(;a<r;a+=3){$0(hl,e,a);let o=$a(t,hl);n*o<0&&(Ui(Rr,hl,Rr,o/(o-n)),Pr(i,Rr)),o<=0&&Pr(i,hl),n=o,q(Rr,hl)}n*s<0&&($0(hl,e,r),Ui(Rr,hl,Rr,s/(s-n)),Pr(i,Rr))}function $0(t,e,i){return xe(t,e.data[i],e.data[i+1],e.data[i+2])}function Pr(t,e){t.push(e[0]),t.push(e[1]),t.push(e[2])}function S2(t,e,i,r){iw(mP,t.quaternion),bt(es,e,t.center),I1(es,es,mP);let s=t.halfSize,a=8*((es[0]<-s[0]?-1:es[0]>s[0]?1:0)+3*(es[1]<-s[1]?-1:es[1]>s[1]?1:0)+9*(es[2]<-s[2]?-1:es[2]>s[2]?1:0)+13),n=pP[a];if(n===0)return n;z1(Xf,t.quaternion),Ep(Xf,Xf,t.halfSize);let o=(l,h)=>{let d=pP[a+h+1];return xe(l,((1&d)<<1)-1,(2&d)-1,((4&d)>>1)-1),ds(l,l,Xf),K(l,t.center,l)};return i.length=0,Pr(i,o(Z0,0)),Pr(i,o(uP,1)),Pr(i,o(es,2)),Pr(i,o(fP,3)),r(i),n===1||(i.length=0,Pr(i,Z0),Pr(i,fP),Pr(i,o(es,4)),Pr(i,o(_P,5)),r(i),n===2||(i.length=0,Pr(i,Z0),Pr(i,_P),Pr(i,o(es,6)),Pr(i,uP),r(i))),n}var pP=(()=>{let t=new Array(216),e=0,i=r=>{for(let s=0;s<r.length;s++)t[e+s]=r[s];e+=8};return i([3,0,6,2,3,1,5,4]),i([2,0,2,3,1,5,4,0]),i([3,1,0,2,3,7,5,4]),i([2,0,1,3,2,6,4,0]),i([1,0,1,3,2,0,0,0]),i([2,1,5,7,3,2,0,0]),i([3,2,0,1,3,7,6,4]),i([2,2,0,1,3,7,6,0]),i([3,3,0,1,5,7,6,2]),i([2,0,1,5,4,6,2,0]),i([1,0,1,5,4,0,0,0]),i([2,1,3,7,5,4,0,0]),i([1,0,2,6,4,0,0,0]),i([0,0,0,0,0,0,0,0]),i([1,1,3,7,5,0,0,0]),i([2,2,3,7,6,4,0,0]),i([1,2,3,7,6,0,0,0]),i([2,3,1,5,7,6,2,0]),i([3,4,0,1,5,7,6,2]),i([2,5,7,6,4,0,1,0]),i([3,5,0,1,3,7,6,4]),i([2,4,5,7,6,2,0,0]),i([1,4,5,7,6,0,0,0]),i([2,5,1,3,7,6,4,0]),i([3,6,0,2,3,7,5,4]),i([2,6,2,3,7,5,4,0]),i([3,7,6,2,3,1,5,4]),t})(),yP=4;function R2(t,e){let i=0;for(let r=0;r<yP;r++){let s=t.intersectPlane(e[r]);if(s>0)return-1;s===0&&(i|=1<<r)}return i}var Xf=jr(),mP=Cc(),es=_(),Z0=_(),uP=_(),fP=_(),_P=_();var Jf=class{constructor(e){this._objects=e}submit(e,i){this._objects.preSubmit(i),this._objects.visibleObjects.forAll(r=>r.renderable.material.submit(e,i,r))}queryDepthRange(e){return this._objects.visibleObjects.length?gP(e,this._objects.visibleObjects):null}get hasEmissions(){return this._objects.visibleObjects.some(e=>e.renderable.material.hasEmissions)}hasHighlightOptions(e){return this._objects.hasHighlightOptions(e)}};var e_=class{constructor(){this.externalColor=ni(),this.externalColorMixMode=kp.Multiply,this.castShadows=!0,this.pickable=!0,this.elevationOffset=0}};var t_=()=>pe.getLogger("esri.views.3d.webgl-engine.collections.Component.ComponentObjectCollection"),i_=class{constructor(e,i){this._renderManager=e,this._viewingMode=i,this._elevationRangeCacheVerticalOffset=NaN,this._elevationRangeCacheMin=NaN,this._elevationRangeCacheMax=NaN,this._activeHighlightOptions=new Map,this._visible=new Xe,this._hidden=new Xe,this._renderSubmit=new Jf(this),this._renderManager.register(this._renderSubmit),this._componentBufferManager=new KC(e.rctx,2+(On()?1:0))}destroy(){Wi(this._hidden.length===0&&this._visible.length===0,"ObjectCollection should be empty upon disposal"),this._componentBufferManager.destroy(),this._visible.forAll(e=>e.destroy()),this._hidden.forAll(e=>e.destroy()),this._visible.clear(),this._hidden.clear()}createObject(e){let i=e.geometry,r=new zf(this._componentBufferManager,xp(i.componentOffsets)),s=this._createRenderable(e,r),a=new $f(this._viewingMode,i.positionData,r),n=new jf(e.transform,e.toMapSpace,e.obb.clone(),r,s,a);return(n.visible?this._visible:this._hidden).push(n),n}destroyObject(e){let i=e;(i.visible?this._visible:this._hidden).removeUnordered(i),i.destroy(),this._notifyDirty()}setObjectVisibility(e,i){let r=e;i!==r.visible&&(i?(this._hidden.removeUnordered(r),this._visible.push(r)):(this._visible.removeUnordered(r),this._hidden.push(r)),r.visible=i,this._notifyDirty())}preSubmit(e){let i=e.camera.eye;this.visibleObjects.forAll(r=>r.renderable.meta.cameraDepthSquared=cs(i,r.obb.center))}getMaterial(e){return e.renderable.material}updateMaterial(e,i){let r=e.renderable.material;i(r),r.dirty&&this._notifyDirty()}setAllComponentVisibilities(e,i){let r=e;r.componentData.visibility.reset(i),r.componentData.markVisibilityDirty(),this._notifyDirty()}forEachVisibleComponent(e,i){return e.componentData.visibility.forEachComponent(i)}getComponentCount(e){let i=e,r=i.componentData.visibility.componentCount;return{visible:r,invisible:i.componentData.count-r}}setComponentData(e,i){let r=e,{renderable:s,componentData:a}=r,n=s.material,o=a.materialDataBuffer,l=a.materialDataIndices,h=new e_,d=o.textureBuffer,m=new Uint8Array(4),u=new Uint32Array(m.buffer),f=0,g=0,y=0,v=a.verticalOffsets,w=1/0,b=-1/0,R=!1,C=!1,x=0;for(let T=0;T<a.count;T++){i(T,h),f+=+(h.externalColor[3]<1),g+=+(h.externalColorMixMode===kp.Replace&&h.externalColor[3]===1),y+=+h.castShadows,vw(h.externalColor,h.externalColorMixMode,m),m[2]=254&m[2]|+h.castShadows,d.setData(l[T],0,m[0],m[1],m[2],m[3]),R||=T>0&&x!==u[0],x=u[0],C||=h.elevationOffset!==0,C&&v==null&&(v=new Array(T).fill(0)),v!=null&&(v[T]=h.elevationOffset),w=Math.min(w,h.elevationOffset),b=Math.max(b,h.elevationOffset),ww(h.elevationOffset,m),d.setData(l[T],1,m[0],m[1],m[2],m[3]);let M=h.objectAndLayerIdColor;M!=null&&d.setData(l[T],2,M[0],M[1],M[2],M[3]),h.pickable!==Vd(a.pickability,T)&&(a.pickability=hP(a.pickability,a.count,T,h.pickable))}a.verticalOffsets=C?v:null,r.offsetObb=C?dw(r.obb,w,b,this._viewingMode,r.offsetObb??r.obb.clone()):null,R||C||On()?(n.componentParameters=new vC,n.componentParameters.castShadows=Y0(y,a.count),n.componentParameters.transparent=Y0(f,a.count),n.componentParameters.opaqueOverride=Y0(g,a.count),n.componentParameters.texture=d,d.updateTexture()):(n.componentParameters=new yC,n.componentParameters.castShadows=h.castShadows?oh.All:oh.None,n.componentParameters.externalColor=h.externalColor,n.componentParameters.externalColorMixMode=h.externalColorMixMode),this._elevationRangeCacheVerticalOffset=NaN,this._notifyDirty()}getComponentAabb(e,i,r,s=!1){e.intersectionGeometry.getComponentAabb(i,r);let a=e,n=a.componentData.verticalOffsets;if(s||n==null)return r;let o=n[i];if(this._viewingMode===me.Local||o===0)return r[2]+=o,r[5]+=o,r;let l=Cg(o);return l.localOrigin=a.transform.position,l.applyToAabb(r)}getComponentObb(e){return e.obb}getObjectTransform(e){return e.transform}getComponentPositions(e,i,r){return e.intersectionGeometry.getComponentPositions(i,r)}expandRangeWithComponentObjectElevationRange(e,i,r,s){Number.isNaN(this._elevationRangeCacheVerticalOffset)||this._elevationRangeCacheVerticalOffset!==i||s.expandElevationRangeValues(this._elevationRangeCacheMin,this._elevationRangeCacheMax);let a=e,n=a.componentData,o=n.count,l=n.verticalOffsets,h=a.intersectionGeometry,d=this._viewingMode===me.Local,m=h.getComponentAabbs(),u=M2,f=1/0,g=-1/0;for(let y=0;y<o;y++){let v=6*y,w=l?.[y]??0,b=1/0,R=-1/0;if(d)b=m[v+2]+w+i,R=m[v+5]+w+i;else{if(u[0]=m[v],u[1]=m[v+1],u[2]=m[v+2],u[3]=m[v+3],u[4]=m[v+4],u[5]=m[v+5],w!==0){let M=Cg(w);M.localOrigin=a.transform.position,M.applyToAabb(u)}let C=Math.max(Math.abs(u[3]),Math.abs(u[0])),x=Math.max(Math.abs(u[4]),Math.abs(u[1])),T=i+u[5]+r;s.expandElevationRangeValues(i+u[2],Math.sqrt(C*C+x*x+T*T)-r)}s.expandElevationRangeValues(b,R),f=Math.min(f,b),g=Math.max(g,R)}this._elevationRangeCacheVerticalOffset=i,this._elevationRangeCacheMin=f,this._elevationRangeCacheMax=g}intersect(e,i,r,s,a,n,o){let l=e,{transform:h}=l,{position:d}=h;return a!=null&&(a.localOrigin=d),l.intersectionGeometry.intersect(i,r,s,a,l.componentData.verticalOffsets,h,n,o)}addEdges(e,i,r,s,a){let n=e,{indices:o,positions:l}=n.intersectionGeometry,h=n.componentData.offsets;return i.addComponentObject(n,l,o,h,r,s,a)}extractEdgeInformation(e,i,r){return Re(this,null,function*(){let s=e,a=s.componentData.visibility;if(a.allInvisible()){let{extractComponentsEdgeLocationsLayout:f}=yield import("./chunk-KVO6SZPT.js");return{buffer:f.createBuffer(0),origin:[0,0,0]}}let{indices:n,positions:o}=s.intersectionGeometry,l=s.componentData.offsets,{EdgeInputBufferLayout:h}=yield import("./chunk-X32EHZ6O.js"),d=h.createBuffer(o.length/3);lw(d.position.typedBuffer,o,d.position.typedBufferStride,3),$1(d.position,d.position,s.transform.rotationScale),this._setComponentIndices(d.componentIndex,n,l);let m=d.count,u=this._computeVisibilityIndices(n,a,l,m);return{origin:Or(s.transform.position),buffer:yield i.extractComponentsEdgeLocations({indices:u,indicesLength:u.length,skipDeduplicate:!0,data:d,writerSettings:{reducedPrecision:!1,variants:0}},r)}})}_setComponentIndices(e,i,r){let s=0;for(let a=0;a<r.length-1;a++){let n=r[a],o=r[a+1];for(let l=n;l<o;l++){let h=i?i[l]:l;e.set(h,s)}s++}}_computeVisibilityIndices(e,i,r,s){if(e&&i.allVisible())return e;let a=0;i.forEachComponentRange((l,h)=>(a+=r[h]-r[l],!0));let n=Av(e)?e?.BYTES_PER_ELEMENT===2||s<=65536?new Uint16Array(a):new Uint32Array(a):new Array(a),o=0;return i.forEachComponentRange((l,h)=>{let d=r[l],m=r[h];for(let u=d;u<m;u++)n[o++]=e?e[u]:u;return!0}),n}addComponentHighlight(e,i,r){let s=e.componentData,a=hp(s.componentHighlights,r,()=>new Uint32Array(s.count+1));{let n=this._activeHighlightOptions.get(r)??0;this._activeHighlightOptions.set(r,n+1)}a[i]++===0&&(s.markHighlightsDirty(),this._notifyDirty()),a[s.count]++}removeComponentHighlight(e,i,r){let{componentData:s}=e,a=s.componentHighlights.get(r);if(a===void 0)return void t_().warn("Removing non-existing highlight.");let n=a[i];if(n===0)return void t_().warn("Removing non-existing highlight.");this._removeActiveHighlight(r);let o=a[s.count];if(n>1)return a[i]=n-1,void(a[s.count]=o-1);a[i]=0,o===1?s.componentHighlights.delete(r):a[s.count]=o-1,s.markHighlightsDirty(),this._notifyDirty()}_removeActiveHighlight(e,i=1){let r=this._activeHighlightOptions.get(e);if(r===void 0)t_().warn("Removing non-existing highlight.");else{let s=r-i;s<0&&t_().warn("Removing non-existing highlight."),s<=0?this._activeHighlightOptions.delete(e):this._activeHighlightOptions.set(e,s)}}clearHighlights(e){let{componentData:i}=e,{componentHighlights:r}=i;if(r.size>0){for(let s of r)this._removeActiveHighlight(s[0],s[1][i.count]);r.clear(),i.markHighlightsDirty(),this._notifyDirty()}}hasHighlightOptions(e){return this._activeHighlightOptions.has(e)}getObjectGPUMemoryUsage(e){return e.renderable.meta.gpuMemoryEstimate}get visibleObjects(){return this._visible}_createRenderable(e,i){let r=this._renderManager.rctx,s=e.geometry,a=s.vertices.layoutParameters,n=wi.createVertex(r,Qi.STATIC_DRAW,s.vertices.data),o=s.indices?wi.createIndex(r,Qi.STATIC_DRAW,s.indices):null,l=Ir(nC(a)),h=new Uint16Array(s.vertices.count);for(let y=0;y<i.count;y++){let v=i.offsets[y],w=i.offsets[y+1],b=i.materialDataIndices[y];if(s.indices!=null)for(let R=v;R<w;R++)h[s.indices[R]]=b;else for(let R=v;R<w;R++)h[R]=b}let d=wi.createVertex(r,Qi.STATIC_DRAW,h.buffer),m=new gC(e.transform,e.toMapSpace),u=new Dw(r,fC,new Map([["data",l],["componentIndices",P2]]),new Map([["data",n],["componentIndices",d]]),o),f=new Yf(u,ft.TRIANGLES,a,o!=null),g={cameraDepthSquared:.5,gpuMemoryEstimate:n.usedMemory+d.usedMemory+(o!=null?o.usedMemory:0)};return new Zf(m,f,g)}_notifyDirty(){this._renderManager.notifyDirty()}},P2=Ir(zr().u16(Et.COMPONENTINDEX));function Y0(t,e){return t===e?oh.All:t===0?oh.None:oh.Some}var M2=El();var r_=class{constructor(e,i,r,s,a){this.rctx=e,this.viewingMode=i,this.stippleTextures=r,this.waterTextures=s,this.markerTextures=a}get spherical(){return this.viewingMode===me.Global}get doublePrecisionRequiresObfuscation(){return this.rctx.driverTest.doublePrecisionRequiresObfuscation.result}};var Wh=class extends Nr{constructor(t){super(t),this.consumes={required:["olid"]},this.produces="olid"}destroy(){}render(t){let e=t.find(({name:r})=>r==="olid"),i=this.renderingContext;return i.bindFramebuffer(e.fbo),i.clearFramebuffer(sr,!0,!0),this.view._stage.renderer.renderAllGeometry(j.ObjectAndLayerIdColor),i.clear(Lt.DEPTH|Lt.STENCIL),this.view._stage.renderer.renderHUD(vr.NotOccluded),e}};c([p()],Wh.prototype,"consumes",void 0),c([p()],Wh.prototype,"produces",void 0),Wh=c([S("esri.views.3d.webgl-engine.effects.geometry.ObjectAndLayerIDRenderNode")],Wh);var Qh=class extends Nr{constructor(t){super(t),this.consumes={required:[le.OCCLUDED]},this.produces=le.OCCLUDED,this._blit=new cm(t.view._stage.renderView.techniques,Ka.PremultipliedAlpha)}precompile(){let t=this.view._stage.renderer;t.plugins.plugins.forAll(e=>{t.precompileSlots(e,Y.OCCLUDED_TERRAIN,Y.TRANSPARENT_OCCLUDER_MATERIAL),e.material&&t.precompileOccludedSlots(e,vP)})}render(t){let e=t.find(({name:s})=>s===this.produces),i=this.view._stage.renderer,r=0;if(un.clear(),i.plugins.plugins.forAll(s=>{s.material&&s.queryRenderOccludedState(fi.OccludeAndTransparentStencil)&&(r|=fi.OccludeAndTransparentStencil,un.push(s))}),un.length>0&&(i.renderSlots(un,Y.OCCLUDER_MATERIAL),r&fi.OccludeAndTransparentStencil&&this._renderAndComposite(e,.5,()=>i.renderSlots(un,Y.TRANSPARENT_OCCLUDER_MATERIAL),!1,!1)),un.clear(),i.plugins.plugins.forAll(s=>{if(!s.material)return;let a=s.queryRenderOccludedState(fi.OccludeAndTransparent),n=s.queryRenderOccludedState(fi.Transparent),o=s.queryRenderOccludedState(fi.Opaque);(a||n||o)&&(r|=a?fi.OccludeAndTransparent:n?fi.Transparent:fi.Opaque,un.push(s))}),r|=i.plugins.renderOccludedFlags,!r)return e;for(let s of vP)r&s&&this._renderAndComposite(e,s===fi.Opaque?1:.5,()=>i.renderOccludedSlots(un,s),!0,qp.OutlineVisualElementMask);return un.clear(),e}_renderAndComposite(t,e,i,r,s){let a=this.renderingContext,{width:n,height:o}=t.fbo,l=this.fboCache.acquire(n,o,"tmp color"),h=r?this.fboCache.acquireDepth(bi.DEPTH_STENCIL_TEXTURE,n,o,"tmp depth"):t.getAttachment(Cp);l.attachDepth(h),a.bindFramebuffer(l.fbo),a.clearFramebuffer(sr,r,s),i(),l.detachDepth(),this._blit.blend(a,l,t,this.bindParameters,e),r&&h.release(),l.release()}};c([p()],Qh.prototype,"consumes",void 0),c([p()],Qh.prototype,"produces",void 0),Qh=c([S("esri.views.3d.webgl-engine.effects.geometry.RenderOccludedRenderNode")],Qh);var un=new Xe,vP=[fi.OccludeAndTransparent,fi.Transparent,fi.Opaque];var Ud=class extends Ne{constructor(e,i){super(e,i,new Le(JC,()=>import("./chunk-YPFTY3BU.js")))}initializePipeline(){return qe({blending:na(_t.ONE,_t.ZERO,_t.ONE_MINUS_SRC_COLOR,_t.ONE),depthTest:{func:Nt.ALWAYS},colorWrite:je})}};var s_=class extends Am{constructor(){super(...arguments),this.hazeStrength=1}},$h=class extends Ne{constructor(e,i){super(e,i,new Le(ex,()=>import("./chunk-LJTNK5GP.js")))}initializePipeline(e){return e.reduced?qe({blending:jl,depthTest:{func:Nt.ALWAYS},colorWrite:je}):qe({blending:na(_t.ONE,_t.ZERO,_t.ONE_MINUS_SRC_COLOR,_t.ONE),colorWrite:je})}};var cl=class extends Nn{constructor(){super(...arguments),this.reduced=!1}};c([ht()],cl.prototype,"reduced",void 0);var a_=class extends ll{constructor(t){super(t),this._compositingPassParameters=new XC,this._passParameters=new s_,this._hazeConfiguration=new cl,this._vao=null,this.requireGeometryDepth=!0,this._oldAmount=1,this._newAmount=1,this._amount=this._newAmount;let e=t.view._stage.renderView.techniques;e.precompile($h,new cl);let i=new cl;i.reduced=!0,e.precompile($h,i),e.precompile(Ud)}initialize(){this.addHandles([P(()=>this.view.environment.atmosphereEnabled,t=>t?this._enable():this._disable(),ye),P(()=>this.view._stage?.renderer.renderContext.bind.clouds.fadeFactor??1,t=>this._fade(t),ye),P(()=>this.view.environment.weather.type,t=>this._newAmount=t==="rainy"?0:1,ye),P(()=>this.view._stage.renderer?.fullResolutionAtmosphere,t=>this._hazeConfiguration.reduced=!t,ye)])}_fade(t){t>=1?(this._amount=this._newAmount,this._oldAmount=this._newAmount):this._amount=t<=0?this._oldAmount:Ae(this._oldAmount,this._newAmount,t)}destroy(){this._vao=ge(this._vao)}render(t){let e=t.find(({name:g})=>g===le.TRANSPARENT_ENVIRONMENT);if(!this.bindParameters.mainDepth)return e;let i=this.renderingContext;this._vao??=ar(i,Bn.Pos2Tex);let r=this.techniques.get($h,this._hazeConfiguration);if(!r.compiled)return e;let s=e.getAttachment(i.gl.DEPTH_STENCIL_ATTACHMENT);if(this._update(),!this._hazeConfiguration.reduced)return e.detachDepth(),i.bindFramebuffer(e.fbo),i.bindTechnique(r,this.bindParameters,this._passParameters),this._renderCommon(i),e.attachDepth(s),e;let a=this.techniques.get(Ud);if(!a.compiled)return e;let n=i.getViewport(),o=this.camera,l=ne(o.eye)-ir.radius,h,d=ir.atmosphereHeight;if(l<d){let g=Math.min(1,Math.max(0,l/d));h=Ae(.4,.5,g)}else{let g=Math.min(1,Math.max(0,(l-d)/(15*d)));h=Ae(.5,1,g)}let m=Ln(Math.round(h*o.fullViewport[2])),u=Ln(Math.round(h*o.fullViewport[3]));i.setViewport(0,0,m,u);let f=this.fboCache.acquire(m,u,"haze",zt.RGBA);return i.bindFramebuffer(f.fbo),i.clearFramebuffer([0,0,0,1],!0,!0),i.bindTechnique(r,this.bindParameters,this._passParameters),this._renderCommon(i),i.setViewport(n.x,n.y,n.width,n.height),this._compositingPassParameters.color=f.getTexture(),e.detachDepth(),i.bindFramebuffer(e.fbo),i.bindTechnique(a,this.bindParameters,this._compositingPassParameters),i.screen.draw(),e.attachDepth(s),f.release(),e}_renderCommon(t){this._vao!=null&&(t.bindVAO(this._vao),t.drawArrays(ft.TRIANGLE_STRIP,0,4))}_update(){let t=this.bindParameters.camera,e=Mi(t.eye),i=Math.sqrt(e),r=e-this._passParameters.radii[1]*this._passParameters.radii[1],s=N((i-this._passParameters.radii[0])/ir.atmosphereHeight,0,1);ls(this._passParameters.heightParameters,i,e,r,s);let a=this.view.basemapTerrain?.getLowerBoundRadius()??0;hs(this._passParameters.radii,a,a+ir.atmosphereHeight),this._passParameters.hazeStrength=Ae(Ae(.6,1,za(9500,10500,i-ir.radius)),1,this._amount)}};a_=c([S("esri.views.3d.webgl-engine.effects.haze.Haze")],a_);var n_=class extends Qp{constructor(){super(...arguments),this.shadowColor=rr(1,0,1,1),this.shadowOpacity=.2,this.occludedShadowOpacity=.1,this.opacityElevation=1,this.dayNightTerminator=1}},Hd=class extends Ne{constructor(e,i){super(e,i,new Le(tx,()=>import("./chunk-Q6JSFRCF.js"))),this.primitiveType=ft.TRIANGLE_STRIP}initializePipeline(){return qe({blending:oa,colorWrite:je,depthTest:null,depthWrite:null})}};var A2=1/512,E2=4e4,O2=5e4,dl=class extends Nr{constructor(t){super(t),this.produces=Tt.COMPOSITE,this.consumes={required:[Tt.COMPOSITE,"highlights"]},this._passParameters=new n_,this._maxOpacity=1,this._shadowDifference=.2}initialize(){this.addHandles([P(()=>this.view.highlightOptions.shadowOpacity,t=>{this._passParameters.shadowOpacity=t??$w,this._updateOccludedShadowOpacity(),this._ensureMaxOpacity()},ye),P(()=>this.view.highlightOptions.shadowDifference,t=>{this._shadowDifference=t??Zw,this._updateOccludedShadowOpacity(),this._ensureMaxOpacity()},ye),P(()=>this.view.highlightOptions.shadowColor,t=>{this._passParameters.shadowColor=Vl(t??Qw),this._ensureMaxOpacity()},ye)])}_updateOccludedShadowOpacity(){this._passParameters.occludedShadowOpacity=this._passParameters.shadowOpacity*(1-this._shadowDifference)}_ensureMaxOpacity(){let t=Math.max(this._passParameters.shadowOpacity,this._passParameters.occludedShadowOpacity);this._maxOpacity=t*this._passParameters.shadowColor[3],this.requestRender(oe.UPDATE)}precompile(){this.techniques.precompile(Hd)}render(t){let e=t.find(({name:s})=>s===Tt.COMPOSITE),i=this.bindParameters;if(!i.shadowHighlightsVisible||!i.depth||!this._ensureIfVisible(i.camera,i.lighting.mainLight.direction))return e;let r=this.techniques.get(Hd);if(r.compiled){this._passParameters.highlight=t.find(({name:a})=>a==="highlights")?.getTexture(),this._passParameters.origin=i.camera.center;let s=this.renderingContext;s.bindFramebuffer(e.fbo),s.bindTechnique(r,i,this._passParameters),s.screen.draw()}else this.requestRender(oe.UPDATE);return e}_ensureIfVisible(t,e){this._passParameters.opacityElevation=1-za(E2,O2,t.relativeElevation);let i=this.viewingMode===me.Global?z(wP,t.center):xe(wP,0,0,1),r=$(i,e);return this._passParameters.dayNightTerminator=za(0,1,N(30*r,0,1)),this._maxOpacity*this._passParameters.opacityElevation*this._passParameters.dayNightTerminator>=A2}};c([p()],dl.prototype,"produces",void 0),c([p()],dl.prototype,"consumes",void 0),c([p({constructOnly:!0})],dl.prototype,"viewingMode",void 0),dl=c([S("esri.views.3d.webgl-engine.effects.highlight.ShadowHighlight")],dl);var wP=_();var qd=class extends Ne{constructor(e,i){super(e,i,new Le(rx,()=>import("./chunk-FKPQGZTS.js")))}initializePipeline(){return qe({blending:Wl,depthTest:null,depthWrite:null,colorWrite:je})}};var go=class extends Nr{constructor(){super(...arguments),this.produces=le.MAGNIFIER,this.consumes={required:[le.MAGNIFIER]},this._imageSources=null,this._imageLoadTask=null,this._passParameters=new ix,this._vao=null,this._magnifier=null,this._tmpScreenPoint=mt(),this._tmpRenderPoint=a1()}initialize(){this.addHandles([P(()=>this.view.magnifier,t=>this._update(t),ye)])}_update(t){if(t===this._magnifier)return;this.removeAllHandles(),this._magnifier=t;let e=()=>{let i=this._validMagnifier;i?(this._loadResources(i),this.produces=le.MAGNIFIER):this.produces="disabled",this.requestRender()};this._magnifier&&this.addHandles(P(()=>this._magnifier?.version,e)),e()}get _validMagnifier(){return this._magnifier?.visible&&this._magnifier?.position&&this._magnifier?.size>0?this._magnifier:null}get _factor(){return this._magnifier?.factor||1}destroy(){this._magnifier=null,this._imageLoadTask!=null&&(this._imageLoadTask.task.abort(),this._imageLoadTask=null),this._disposeTextures(),this._vao=ge(this._vao)}_disposeTextures(){this._passParameters.mask=ge(this._passParameters.mask),this._passParameters.overlay=ge(this._passParameters.overlay),this._passParameters.input=ge(this._passParameters.input)}precompile(){this._imageSources&&this.techniques.precompile(qd)}render(t){let e=this._validMagnifier,i=t.find(({name:v})=>v===le.MAGNIFIER);if(e==null)return i;if(this._imageSources==null)return this.requestRender(oe.UPDATE),i;let r=this.renderingContext,s=this.camera.pixelRatio,a=Math.ceil(s*e.size);this._vao??=ar(r,Bn.Pos2,aa,0,1);let n=this.techniques.get(qd);if(this._ensureTextureResources(r,a),!n.compiled||!this._passParameters.input)return this.requestRender(oe.UPDATE),i;let o=Math.ceil(1/this._factor*a),l=this._passParameters.input;l.resize(o,o),Is(e.position,this._tmpScreenPoint);let h=this.camera.screenToRender(this._tmpScreenPoint,this._tmpRenderPoint),d=this.camera.fullWidth,m=this.camera.fullHeight,u=.5*o,f=.5*o;h[0]=N(h[0],u,d-u-1),h[1]=N(h[1],f,m-f-1);let g=Math.floor(h[0]-u),y=Math.floor(h[1]-f);return r.bindFramebuffer(i.fbo),n.program.bindTexture("textureInput",l),r.gl.copyTexImage2D(l.descriptor.target,0,l.descriptor.pixelFormat,g,y,o,o,0),this._passParameters.magnifier=e,r.bindTechnique(n,this.bindParameters,this._passParameters),r.bindVAO(this._vao),r.drawArrays(ft.TRIANGLE_STRIP,0,4),i}_loadResources(t){let{maskUrl:e,overlayUrl:i}=t;this._imageLoadTask?.maskUrl===e&&this._imageLoadTask?.overlayUrl===i||(this._imageLoadTask?.task.abort(),this._imageLoadTask=this._imageSources=null),this._imageSources||this._imageLoadTask||(this._imageLoadTask={maskUrl:e,overlayUrl:i,task:Js(r=>Re(this,null,function*(){let s=e==null||i==null?RT(r):null,a=e!=null?In(e,{signal:r}):s.then(o=>o.mask),n=i!=null?In(i,{signal:r}):s.then(o=>o.overlay);this._imageSources={mask:yield a,overlay:yield n}}))})}_ensureTextureResources(t,e){if(this._imageSources==null||this._passParameters.size===e&&this._passParameters.input&&this._passParameters.mask&&this._passParameters.overlay)return;this._disposeTextures(),this._imageSources.overlay.width=this._imageSources.mask.width=e,this._imageSources.overlay.height=this._imageSources.mask.height=e;let i=new Ot;i.internalFormat=St.RGBA,i.wrapMode=Jt.CLAMP_TO_EDGE,i.flipped=!0,i.preMultiplyAlpha=!cp(this._imageSources.overlay.src)||!t.driverTest.svgPremultipliesAlpha.result,this._passParameters.overlay=new Ft(t,i,this._imageSources.overlay),i.pixelFormat=i.internalFormat=St.ALPHA,i.preMultiplyAlpha=!1,this._passParameters.mask=new Ft(t,i,this._imageSources.mask),i.pixelFormat=i.internalFormat=St.RGBA,i.flipped=!1,this._passParameters.input=new Ft(t,i)}};c([p()],go.prototype,"produces",void 0),c([p()],go.prototype,"consumes",void 0),c([p()],go.prototype,"_imageSources",void 0),c([p()],go.prototype,"_imageLoadTask",void 0),go=c([S("esri.views.3d.webgl-engine.effects.magnifier.Magnifier")],go);var Bd=class extends Ne{constructor(e,i){super(e,i,new Le(sx,()=>import("./chunk-G6PFN4C5.js")))}initializePipeline(){return qe({colorWrite:je})}};var kd=class extends Ne{constructor(e,i){super(e,i,new Le(ax,()=>import("./chunk-D3BLD2TQ.js")))}initializePipeline(){return qe({colorWrite:je})}};var Gd=class extends Ne{constructor(e,i){super(e,i,new Le(nx,()=>import("./chunk-3B2TIAH4.js")))}initializePipeline(){return qe({colorWrite:je})}};var o_=class extends Dn{};var yo=class extends Nr{constructor(t){super(t),this.produces="disabled",this.consumes={required:[le.ANTIALIASING],optional:[Tt.COMPOSITE]},this._areaTexture=null,this._searchTexture=null,this._smaaParameters=new o_}initialize(){this.addHandles([P(()=>this.isEnabled(),t=>t?this.enable():this.disable(),ye)])}enable(){return Re(this,null,function*(){if(this.produces=le.ANTIALIASING,this._abortController||this._areaTexture&&this._searchTexture)return;this._abortController=new AbortController;let t=this._abortController.signal;try{let e=yield import("./chunk-5WXASA23.js");yield this._loadTextures(e,t),this.requestRender(oe.UPDATE)}catch{}this._abortController=null})}_loadTextures(t,e){return Re(this,null,function*(){Vi(e);let[i,r]=yield Promise.allSettled([In(t.areaTexture,{signal:e}),In(t.searchTexure,{signal:e})]);if(Vi(e),i.status!=="fulfilled"||r.status!=="fulfilled")return;let s=this.renderingContext;this._areaTexture=bP(s,yr.LINEAR,St.RGB,i.value),this._searchTexture=bP(s,yr.NEAREST,St.LUMINANCE,r.value)})}disable(){this.produces="disabled"}destroy(){this._searchTexture=ge(this._searchTexture),this._areaTexture=ge(this._areaTexture)}precompile(){this.techniques.precompile(Gd),this.techniques.precompile(Bd),this.techniques.precompile(kd)}render(t){let e=t.find(({name:u})=>u===le.ANTIALIASING);if(!this._areaTexture||!this._searchTexture)return this.requestRender(oe.UPDATE),e;let i=this.techniques.get(Gd),r=this.techniques.get(Bd),s=this.techniques.get(kd);if(!i.compiled||!r.compiled||!s.compiled)return this.requestRender(oe.UPDATE),e;let a=t.find(({name:u})=>u===Tt.COMPOSITE);if(!a)return e;let n=a.fbo.width,o=a.fbo.height,l=this.renderingContext;l.setViewport(0,0,n,o);let h=this.fboCache.acquire(n,o,"smaa edges",zt.RG);l.bindFramebuffer(h.fbo),l.setClearColor(0,0,0,1),l.clear(Lt.COLOR),this._smaaParameters.color=a.getTexture();let d=this.bindParameters;l.bindTechnique(i,d,this._smaaParameters),l.screen.draw();let m=this.fboCache.acquire(n,o,"smaa blend");return l.bindFramebuffer(m.fbo),l.setClearColor(0,0,1,1),l.clear(Lt.COLOR),this._smaaParameters.inputTexture=h.getTexture(),this._smaaParameters.areaTexture=this._areaTexture,this._smaaParameters.searchTexture=this._searchTexture,l.bindTechnique(r,d,this._smaaParameters),l.screen.draw(),h.release(),l.bindFramebuffer(e.fbo),l.setClearColor(0,1,0,1),l.clear(Lt.COLOR),this._smaaParameters.inputTexture=m.getTexture(),l.bindTechnique(s,d,this._smaaParameters),l.screen.draw(),m.release(),e}};function bP(t,e,i,r){let s=new Ot;return s.pixelFormat=i,s.wrapMode=Jt.CLAMP_TO_EDGE,s.width=r.width,s.height=r.height,s.samplingMode=e,new Ft(t,s,r)}c([p()],yo.prototype,"produces",void 0),c([p()],yo.prototype,"consumes",void 0),c([p({constructOnly:!0})],yo.prototype,"isEnabled",void 0),c([p()],yo.prototype,"_abortController",void 0),yo=c([S("esri.views.3d.webgl-engine.effects.smaa.SMAA")],yo);var l_=class extends Dn{constructor(){super(...arguments),this.modelMatrix=Rt()}},zd=class extends Ne{constructor(e,i){super(e,i,new Le(ox,()=>import("./chunk-NWQ2NMV4.js")))}initializePipeline(){return qe({blending:oa,depthTest:{func:Nt.LEQUAL},colorWrite:je})}};var h_=class extends mr{constructor(){super(...arguments),this._starData=null,this._loadDataTask=null,this._numPoints=0,this._passParameters=new l_}initialize(){this.addHandles([P(()=>this.view.environment.starsEnabled,t=>t?this._enable():this._disable(),Ie),P(()=>this.view.environment.lighting.type==="virtual"?null:this.view.environment.lighting.date,t=>this._update(t),ye)])}_enable(){super._enable(),this._loadDataTask=this._createLoadDataTask()}get loading(){return!!this._loadDataTask&&!this._loadDataTask.finished}destroy(){this._loadDataTask=Ar(this._loadDataTask),this._numPoints=0,this._vao=ge(this._vao),this._starData=null}precompile(){this.techniques.precompile(zd)}render(t){let e=t.find(({name:s})=>s===le.OPAQUE_ENVIRONMENT),i=this.renderingContext;if(this.loading)return this.requestRender(oe.UPDATE),e;if(!this._starData)return e;this._vao??=this._ensureResources(this._starData,i);let r=this.techniques.get(zd);return r.compiled?(i.bindTechnique(r,this.bindParameters,this._passParameters),i.bindVAO(this._vao),i.drawArrays(ft.POINTS,0,this._numPoints),e):(this.requestRender(oe.UPDATE),e)}_ensureResources(t,e){return this._numPoints=t.byteLength/CP,D2(e,new Float32Array(t,0,2*this._numPoints),new Uint8Array(t,2*this._numPoints*4,this._numPoints),this._numPoints)}_update(t){if(!t)return;let e=(t.getHours()/12+t.getMinutes()/60*(2/24)+t.getSeconds()/60*(2/1440)-.9972222)%2,i=2*I2(t),r=Al(this._passParameters.modelMatrix,H2);hg(r,r,-i*Math.PI),ns(r,U2,r),hg(r,r,-e*Math.PI),this.requestRender(oe.UPDATE)}_createLoadDataTask(){if(this._starData)return null;let t=Js(e=>Re(this,null,function*(){let{data:i}=yield zv("esri/views/3d/environment/resources/stars.wsv",{responseType:"array-buffer",signal:e});L2(i),this._starData=i}));return t.promise.catch(e=>{ss(e)||pe.getLogger(this).error(e)}).then(()=>{this.destroyed||this.requestRender(oe.UPDATE)}),t}};function D2(t,e,i,r){let s=TP.createBuffer(r),a=s.position,n=s.color,o=s.size;for(let l=0;l<r;l++){let h=e[2*l],d=e[2*l+1];a.set(l,0,-Math.cos(h)*Math.sin(d)),a.set(l,1,-Math.sin(h)*Math.sin(d)),a.set(l,2,-Math.cos(d));let m=F2(i[l]),u=N2(V2[m[1]]);n.set(l,0,255*u[0]),n.set(l,1,255*u[1]),n.set(l,2,255*u[2]),n.set(l,3,255),o.set(l,m[0])}return new Lr(t,aa,new Map([["geometry",Ir(TP)]]),new Map([["geometry",wi.createVertex(t,Qi.STATIC_DRAW,s.buffer)]]))}function I2(t){let e=t,i=new Date(t.getFullYear(),0,1,11,58,56);return(+e-+i)/(+new Date(t.getFullYear()+1,0,1,11,58,55)-+i)}function L2(t){if(!t)throw new si("stars:no-data-received","Failed to create stars because star catalogue is missing");let e=t.byteLength/CP;if(e%1!=0||e>5e4||e<5e3)throw new si("stars:invalid-data","Failed to create stars because star catalogue data is invalid")}function N2(t){return[parseInt(t.slice(0,2),16),parseInt(t.slice(2,4),16),parseInt(t.slice(4,6),16)]}function F2(t){return t>=192?[2.9,t-192]:t>=160?[2.5,t-160]:t>=128?[2,t-128]:t>=96?[1.5,t-96]:t>=64?[1,t-64]:t>=32?[.7,t-32]:[.4,t]}h_=c([S("esri.views.3d.webgl-engine.effects.stars.Stars")],h_);var V2=["9bb2ff","9eb5ff","aabfff","bbccff","ccd8ff ","dae2ff","e4e9ff","eeefff","f8f6ff","fff9fb","fff5ef","fff1e5","ffeddb","ffe9d2","ffe6ca","ffe3c3","ffe0bb","ffddb4","ffdaad","ffd6a5","ffd29c","ffcc8f","ffc178","ffa94b","ff7b00"],U2=fg(1,0,0,0,0,.9174771405229186,.39778850739794974,0,0,-.39778850739794974,.9174771405229186,0,0,0,0,1),H2=fg(1,0,0,0,0,.9174771405229186,-.39778850739794974,0,0,.39778850739794974,.9174771405229186,0,0,0,0,1),CP=9,TP=zr().vec3f(Et.POSITION).vec4u8(Et.COLOR).f32(Et.SIZE);var jd=class extends Ne{constructor(e,i){super(e,i,new Le(hx,()=>import("./chunk-CLP2LV7M.js")))}initializePipeline(){return qe({colorWrite:{r:!1,g:!0,b:!1,a:!1}})}};var c_=class{constructor(e,i){this._rctx=e,this._techniques=i,this._configuration=new Wb,this._passParameters=new Qb,this._hudParameters=new lx,this._configuration.blitMode=Ka.PremultipliedAlpha,this._techniques.precompile(Jl,this._configuration),this._configuration.hasOpacityFactor=!0,this._techniques.precompile(Jl,this._configuration),this._configuration.hasOpacityFactor=!1,this._configuration.blitMode=Ka.Alpha,this._techniques.precompile(Jl,this._configuration),this._configuration.blitMode=Ka.Depth,this._techniques.precompile(Jl,this._configuration),this._techniques.precompile(jd)}compositeHUD(e,i){this._hudParameters.texture=i;let r=this._techniques.get(jd);this._rctx.bindTechnique(r,e,this._hudParameters),this._rctx.screen.draw()}compositePreMultipliedAlpha(e,i,r=1){this._composite(e,i,Ka.PremultipliedAlpha,r)}composite(e,i){this._composite(e,i,Ka.Alpha,1)}blitDepthToLinearDepth(e,i){this._composite(e,i,Ka.Depth,1)}_composite(e,i,r,s){this._configuration.blitMode=r,this._configuration.hasOpacityFactor=s!==1,this._passParameters.texture=i,this._passParameters.opacity=s;let a=this._techniques.get(Jl,this._configuration);this._rctx.bindTechnique(a,e,this._passParameters),this._rctx.screen.draw()}};var d_=class{constructor(){this.declaredClass="esri.views.3d.webgl-engine.lib.ObjectAndLayerIdRenderHelper",this.colorZero=new mg(new ArrayBuffer(4)),this._layerToOidToColor=new Ec,this._colorToUID=new Map,this._layerUidToGraphicsUidToObjectId=new Ec,this._layerUidToId=new Map,this._layerUidToPopupEnabled=new Map}setUidToObjectAndLayerId(e,i,r,s,a,n=null,o=null,l=null){e&&i&&r&&s&&(this._layerUidToId.set(s,r),this._layerUidToPopupEnabled.set(s,a),a&&this._layerUidToGraphicsUidToObjectId.set(s,i,{objectId:e,attributeNodeId:n,attributeIndex:o,subLayerId:l}))}getObjectAndLayerIdColor(e){let i=this.getObjectAndLayerIdColorArray(e);return rr(i.get(0,1),i.get(0,2),i.get(0,3),255)}getObjectAndLayerIdColorArray(e){if(!e.layerUid||!e.graphicUid)return this.colorZero;let i=this._layerUidToPopupEnabled.get(e.layerUid);if(i===void 0)return this.colorZero;if(i===!1)return this.colorZero;let r=this._layerUidToGraphicsUidToObjectId.get(e.layerUid,e.graphicUid)?.objectId;if(!r)return this.colorZero;let s=this._layerToOidToColor.get(e.layerUid,r);if(!s){if(Yt("enable-feature:objectAndLayerId-screenshot-testing"))s=r;else for(;!s;){let n=Math.floor(16777214*Math.random())+1;this._colorToUID.has(n)||(s=n)}if(s>16777215)throw new Error("Object ID Overflow");this._layerToOidToColor.set(e.layerUid,r,s),this._colorToUID.set(s,e)}let a=new ArrayBuffer(4);return new DataView(a).setUint32(0,s,!1),new mg(a)}getColorToObjectAndLayerIdMapping(){let e=new Map;for(let[i,r]of this._colorToUID.entries()){let s=this._layerUidToGraphicsUidToObjectId.get(r.layerUid,r.graphicUid),a=this._layerUidToId.get(r.layerUid);s&&a&&e.set(i,s.attributeNodeId?{type:"object-and-layer-and-i3s-id",olid:s.objectId,lid:a,attrId:s.attributeNodeId,attrIdx:s.attributeIndex,subLayerId:s.subLayerId}:{type:"object-and-layer-id",olid:s.objectId,lid:a})}return e}};var Zh=class extends cx{constructor(e,i,r){super(e,r),this.attachment=i,this.name=""}dispose(){this.attachment.dispose()}get cachedMemory(){return this.attachment.usedMemory}};var p_=class extends Zh{constructor(e,i,r){super(e,i,r),this.attachment=i,this.type=ph.COLOR}};var Wd=class extends Zh{constructor(){super(...arguments),this.type=ph.DEPTH}};var Yh=class{constructor(e,i){this._last=new Xe,this._incarnation=0,this._cache=new xs(e,i)}destroy(){this._last?.forAll(e=>e.dispose()),this._last=null,this._cache.destroy()}set interactive(e){e&&!this._last?this._last=new Xe:e||(this._last?.forAll(i=>i.dispose()),this._last=null)}clean(){this._last?.filterInPlace(e=>!(e.incarnation<this._incarnation)||(this._cache.put(e.key,e),!1))}frame(){++this._incarnation}pop(e){if(this._last){let i=this._last.find(r=>r.key===e);if(i)return this._last.removeUnordered(i),i}return this._cache.pop(e)}put(e){e.incarnation=this._incarnation,this._last?this._last.push(e):this._cache.put(e.key,e)}get usedMemory(){return this._last?.reduce((e,i)=>e+i.cachedMemory,0)??0}};var g_=class{constructor(e){this.rctx=e,this._acquired=new Set,this._cache=new Yh(e.newCache,"FBOCache"),this._depthCache=new Yh(e.newCache,"DepthAttachmentCache"),this._colorCache=new Yh(e.newCache,"ColorAttachmentCache")}destroy(){this._cache.destroy(),this._depthCache.destroy(),this._colorCache.destroy()}clean(){this._cache.clean(),this._colorCache.clean(),this._depthCache.clean()}frameStart(){this._cache.frame(),this._colorCache.frame(),this._depthCache.frame(),this.debugCallback?.()}frameEnd(){let e=this.debugCallback;e&&this._acquired.forEach(i=>i.type===ph.FBO&&e(i.name,i.fbo,i.numberOfColorAttachments))}get usedMemory(){return Array.from(this._acquired.values()).reduce((e,i)=>e+("getTexture"in i?i.getTexture()?.usedMemory??0:i.cachedMemory),this._cache.usedMemory+this._colorCache.usedMemory+this._depthCache.usedMemory)}set interactive(e){this._cache.interactive=this._colorCache.interactive=this._depthCache.interactive=e}acquire(e,i,r,s=zt.RGBA){let a=K0(s,e,i),n=this._cache.pop(a);if(n){n.retain(),n.setName(r);let o=this.rctx.getBoundFramebufferObject();if(this.rctx.bindFramebuffer(n.fbo),this.rctx.setDrawBuffers([Hi.COLOR_ATTACHMENT0]),!n.fbo)throw new si("attempt to use a not existing framebuffer");this.rctx.unbindTexture(n.fbo.colorTexture),this.rctx.bindFramebuffer(o)}else n=new iy(a,r,new la(this.rctx,Bt(lt({},xP[s]),{width:e,height:i})),o=>{o??=bi.DEPTH_STENCIL_TEXTURE;let l=this._acquireDepth(o,n.fbo.width,n.fbo.height,`${n.name} depth`);return n.attachDepth(l),l.release(),n},(o,l,h)=>{l??=zt.RGBA;let d=this._acquireColor(l,e,i,h??`${n.name} color ${o}`);return this.rctx.unbindTexture(d.attachment),n.attachColor(d,o),d.release(),n},()=>{this.debugCallback?.(n.name,n.fbo,n.numberOfColorAttachments),this._acquired.delete(n),n.detachAll(),this._cache.put(n)});return this._trackHandle(n)}acquireDepth(e,i,r,s){return this._acquireDepth(e,i,r,s)}_acquireDepth(e,i,r,s){let a=K0(e,i,r),n=this._depthCache.pop(a);if(n)return n.retain(),n.name=s,this._trackHandle(n);let o=e===bi.DEPTH_STENCIL_TEXTURE?new Wd(a,new Ft(this.rctx,Bt(lt({},SP[e]),{width:i,height:r})),()=>{this._acquired.delete(o),this._depthCache.put(o)}):new Wd(a,new yb(this.rctx,Bt(lt({},SP[e]),{width:i,height:r})),()=>{this._acquired.delete(o),this._depthCache.put(o)});return o.name=s,this._trackHandle(o)}_acquireColor(e,i,r,s){let a=K0(e,i,r),n=this._colorCache.pop(a);if(n)return n.retain(),n.name=s,this._trackHandle(n);let o=new p_(a,new Ft(this.rctx,Bt(lt({},xP[e]),{width:i,height:r})),()=>{this._acquired.delete(o),this._colorCache.put(o)});return o.name=s,this._trackHandle(o)}_trackHandle(e){return this._acquired.add(e),e}},Va=new iy("default","default",null,()=>Va,()=>Va,()=>{});function K0(t,e,i){return`${t}x${e}x${i}`}Va.release=()=>!1;var m_=new Ot;m_.pixelFormat=St.RED,m_.internalFormat=Cn.R8,m_.wrapMode=Jt.CLAMP_TO_EDGE;var u_=new Ot;u_.pixelFormat=St.RG,u_.internalFormat=Cn.RG8,u_.wrapMode=Jt.CLAMP_TO_EDGE;var f_=new Ot;f_.internalFormat=Cn.RGBA4,f_.dataType=sa.UNSIGNED_SHORT_4_4_4_4,f_.wrapMode=Jt.CLAMP_TO_EDGE;var RP=new Ot;RP.wrapMode=Jt.CLAMP_TO_EDGE;var Qd=new Ot;Qd.wrapMode=Jt.CLAMP_TO_EDGE,Qd.samplingMode=yr.LINEAR_MIPMAP_LINEAR,Qd.hasMipmap=!0,Qd.maxAnisotropy=8;var $d=new Ot;$d.pixelFormat=St.RED,$d.dataType=sa.HALF_FLOAT,$d.internalFormat=Cn.R16F,$d.samplingMode=yr.NEAREST;var __=new Ot;__.dataType=sa.HALF_FLOAT,__.internalFormat=Cn.RGBA16F,__.samplingMode=yr.NEAREST;var xP={[zt.RED]:m_,[zt.RG]:u_,[zt.RGBA4]:f_,[zt.RGBA]:RP,[zt.RGBA_MIPMAP]:Qd,[zt.R16F]:$d,[zt.RGBA16F]:__},Kh=new Ot;Kh.pixelFormat=St.DEPTH_STENCIL,Kh.dataType=sa.UNSIGNED_INT_24_8,Kh.samplingMode=yr.NEAREST,Kh.wrapMode=Jt.CLAMP_TO_EDGE,Kh.internalFormat=St.DEPTH24_STENCIL8;var SP={[bi.DEPTH_STENCIL_TEXTURE]:Kh,[bi.DEPTH16_BUFFER]:new Jp(Tp.DEPTH_COMPONENT16,4)};var Xh;(function(t){t[t.FrontToBack=0]="FrontToBack",t[t.BackToFront=1]="BackToFront"})(Xh||(Xh={}));var As=class{constructor(e,i,r=Xh.FrontToBack){this._rctx=e,this._techniques=i,this._sorting=r,this._draws=new Xe({allocator:s=>s??{material:null,geometry:null,geometryRanges:null,bindDrawParams:null,depthSquaredHint:0,indexType:0}}),this._previouslyBoundDraw=new Map}submitDraw(e,i,r,s,a){let n=this._draws.pushNew();n.geometry=i,n.geometryRanges=r,n.material=e,n.depthSquaredHint=s,n.indexType=(i.indexed?i.vao.indexBuffer.indexType:null)??0,n.highlightName=a}acquire(e,i){return this._draws.map(r=>r.material.acquireTechnique(this._techniques,e,i,r.geometry.parameters))}dispatch(e,i,r){let s=this._rctx;this._previouslyBoundDraw.clear();let a=null,n=this._draws.length,o=i.highlight?.name;for(let l=0;l<n;l++){let h=this._draws.data[l];if(e.identifier===Ya.Highlight){let w=h.highlightName;if(w){if(w!==o)continue}else if(!o||!i.overlay?.hasHighlightOptions(o))continue}let d=r[l];d===a&&i.oitPass===Qr.NONE||(s.bindTechnique(d,i,e),a=d);let{geometryRanges:m,indexType:u,geometry:f,material:g}=h;s.bindVAO(f.vao),this._previouslyBoundDraw.get(d)!==g&&(d.program.bindDraw(i,e,g),this._previouslyBoundDraw.set(d,g));let y=m.length,{primitiveType:v}=f;for(let w=0;w<y;w+=2){let b=m[w],R=m[w+1];if(u!==0){let C=y_.get(u);s.drawElements(v,R,u,b*C)}else s.drawArrays(v,b,R)}}}prepareSubmit(){this._draws.clear()}finishSubmit(){let e=this._sorting===Xh.FrontToBack?1:-1;this._draws.sort((i,r)=>{let s=e*(i.depthSquaredHint-r.depthSquaredHint);return s!==0?s:i.geometry.vao.byteSize-r.geometry.vao.byteSize})}get count(){return this._draws.length}},y_=new Map;y_.set(Mo.UNSIGNED_BYTE,1),y_.set(Mo.UNSIGNED_SHORT,2),y_.set(Mo.UNSIGNED_INT,4);var v_=class{constructor(e){let i=e.renderContext.rctx,r=e.techniques;this.opaque=new As(i,r),this.transparent=new As(i,r,Xh.BackToFront),this.integratedMesh=new As(i,r),this.shadowMap=new As(i,r),this.highlight=new As(i,r),this.highlightIntegratedMesh=new As(i,r),this.highlightShadowMap=new As(i,r),this.viewshedShadowMap=new As(i,r),this.nonHighlightShadowMap=new As(i,r)}},Jh=class extends Pw{constructor(){super(...arguments),this.slicePlaneLocalOrigin=_(),this.origin=this.slicePlaneLocalOrigin,this.modelTransformation=null}};var w_=class extends Jh{constructor(){super(...arguments),this.identifier=Ya.Material,this.output=j.Color,this.transparent=!1}},b_=class extends Jh{constructor(){super(...arguments),this.identifier=Ya.ShadowMap}},T_=class extends Jh{constructor(){super(...arguments),this.identifier=Ya.Highlight}},C_=class extends Jh{constructor(){super(...arguments),this.identifier=Ya.ViewshedShadowMap}};var x_=class extends kl{constructor(){super({}),this.produces=new Map([[Y.OPAQUE_MATERIAL,t=>this._produces(t,Y.OPAQUE_MATERIAL)],[Y.TRANSPARENT_MATERIAL,t=>this._produces(t,Y.TRANSPARENT_MATERIAL)],[Y.INTEGRATED_MESH,t=>this._produces(t,Y.INTEGRATED_MESH)]]),this._materialPassParameters=new w_,this._shadowPassParameters=new b_,this._highlightPassParameters=new T_,this._viewshedPassParameters=new C_,this._systems=new Set}initializeRenderContext(t){this._context=t,this._passes=new v_(t)}get rctx(){return this._context.renderContext.rctx}uninitializeRenderContext(){}dispose(){this._context=null,this._systems.clear()}register(t){this._systems.add(t)}_produces(t,e){return!!this._invoke(t,e,i=>i.count>0)}prepareRender(t){if(this._systems.size!==0&&this._passes!=null){for(let e of Object.values(this._passes))e.prepareSubmit();this._systems.forEach(e=>e.submit(this._passes,t.bind));for(let e of Object.values(this._passes))e.finishSubmit()}}acquireTechniques(t){if(this._systems.size===0)return null;let e=t.output===j.Shadow||t.output===j.ShadowHighlight||t.output===j.ShadowExcludeHighlight?this._shadowPassParameters:t.output===j.ViewshedShadow?this._viewshedPassParameters:t.output===j.Highlight?this._highlightPassParameters:this._materialPassParameters,i=t.bind;return this._updateParameters(i.camera,e,i.slot===Y.TRANSPARENT_MATERIAL),this._materialPassParameters.output=t.output,this._invoke(t.output,t.bind.slot,(r,s)=>r.acquire(s,t.bind))}render(t,e){this._invoke(t.output,t.bind.slot,(i,r)=>i.dispatch(r,t.bind,e))}_invoke(t,e,i){if(this._passes==null)return null;switch(e){case Y.OPAQUE_MATERIAL:switch(t){case j.Color:case j.ColorEmission:case j.Depth:case j.Normal:case j.ObjectAndLayerIdColor:return i(this._passes.opaque,this._materialPassParameters);case j.Highlight:return i(this._passes.highlight,this._highlightPassParameters);case j.Shadow:return i(this._passes.shadowMap,this._shadowPassParameters);case j.ShadowHighlight:return i(this._passes.highlightShadowMap,this._shadowPassParameters);case j.ShadowExcludeHighlight:return i(this._passes.nonHighlightShadowMap,this._shadowPassParameters);case j.ViewshedShadow:return i(this._passes.viewshedShadowMap,this._viewshedPassParameters)}break;case Y.TRANSPARENT_MATERIAL:switch(t){case j.Color:case j.ColorEmission:case j.Depth:case j.Normal:case j.ObjectAndLayerIdColor:return i(this._passes.transparent,this._materialPassParameters)}break;case Y.INTEGRATED_MESH:switch(t){case j.Color:case j.ColorEmission:case j.Depth:case j.Normal:case j.ObjectAndLayerIdColor:return i(this._passes.integratedMesh,this._materialPassParameters);case j.Highlight:return i(this._passes.highlightIntegratedMesh,this._highlightPassParameters)}}return null}notifyDirty(){this._context.requestRender()}queryDepthRange(t){let e=new qi;return this._systems.forEach(i=>e.union(i.queryDepthRange(t))),e}get hasEmissions(){let t=!1;return this._systems.forEach(e=>t=e.hasEmissions||t),t}_updateParameters(t,e,i){let r=t.viewInverseTransposeMatrix;xe(X0,r[3],r[7],r[11]),J0.set(X0),q(e.transformWorldFromViewTH,J0.high),q(e.transformWorldFromViewTL,J0.low),q(e.slicePlaneLocalOrigin,X0),Rp(e.transformViewFromCameraRelativeRS,t.viewMatrix),Al(e.transformProjFromView,t.projectionMatrix),e.identifier===Ya.Material&&(this._materialPassParameters.transparent=i,Nl(PP,e.transformViewFromCameraRelativeRS),Mp(e.transformNormalViewFromGlobal,PP))}hasHighlightOptions(t){for(let e of this._systems)if(e.hasHighlightOptions(t))return!0;return!1}};x_=c([S("esri.views.3d.webgl-engine.core.renderPasses.RenderPassManager")],x_);var X0=_(),PP=jr(),J0=new _C;function MP(t){return t.name}var S_=class{constructor(e){this._context=e,this._nodes=new Xe}destroy(){this._nodes.forEach(e=>e.destroy()),this._nodes.clear()}add(e){this._nodes.push(e),bg&&console.log(`Registered render nodes: ${this._nodes.map(({declaredClass:i})=>i).join(", ")}`)}remove(e){this._nodes.remove(e),bg&&console.log(`Registered render nodes: ${this._nodes.map(({declaredClass:i})=>i).join(", ")}`)}produces(e){return this._nodes.some(({produces:i})=>i===e)}require(e,...i){let r=this._nodes,s=a=>r.reduce((n,{consumes:o,produces:l})=>n+(!o.required.includes(e)||a!=null&&l!==a?0:1),0);return i.length===0?s():i.reduce((a,n)=>a+s(n),0)}optional(e,...i){let r=this._nodes,s=a=>r.reduce((n,{consumes:o,produces:l})=>n+(!o.optional?.includes(e)||a!=null&&l!==a?0:1),0);return i.length===0?s():i.reduce((a,n)=>a+s(n),0)}updateAnimation(e){return this._nodes.reduce((i,r)=>r.updateAnimation(e)||i,!1)}precompile(...e){++this._context.techniques.precompiling;for(let i of e)this._nodes.forEach(r=>{r.produces===i&&r.precompile()});--this._context.techniques.precompiling}render(e,i,r=()=>{}){let s=e.name,a=this._nodes.filter(({produces:n})=>n===s);return a.length===0?MP(e)?e:Va:(a.forEach(n=>{let o=[e];for(let l of n.consumes.required){if(l===s)continue;let h=i.get(l);if(h)o.push(h);else if(l!=="emissive"||!i.get(s)?.hasAttachment(l))return void(r&&r(o))}if(n.consumes.optional)for(let l of n.consumes.optional){if(l===s)continue;let h=i.get(l);h&&o.push(h)}try{let l=n.doRender(o);l&&l!==e&&(s!==l.name&&(pe.getLogger(n).errorOnce(`RenderNode produced ${l.name}, expected ${s}`),l.setName(s)),e.release(),e=l,i.set(s,e))}catch(l){pe.getLogger(n).errorOnce(l)}r&&r(o)}),this._context.rctx.enforceState(),e)}requireGeometryDepth(){return this._nodes.some(e=>e.produces!=="disabled"&&e.requireGeometryDepth)}get test(){return{nodes:this._nodes}}};var R_=class{constructor(e){this.context=e,this._renderPlugins=new Xe,this._slots=new Array,this._version=fr(0);for(let i=0;i<Y.MAX_SLOTS;++i)this._slots[i]=[]}destroy(){this._renderPlugins.forEach(e=>e.destroy()),this._renderPlugins.clear()}get plugins(){return this._renderPlugins}add(e,i){let r=()=>{if(i?.aborted)throw e.uninitializeRenderContext(),er();this._renderPlugins.push(e),e.produces.forEach((a,n)=>this._slots[n].push(e)),this.context.requestRender(),this._version.value++},s=e.initializeRenderContext(this.context,i);if(Cl(s))return s.then(r);r()}remove(e){this._renderPlugins.removeUnordered(e),e.uninitializeRenderContext();for(let i=0;i<this._slots.length;++i)this._slots[i]=this._slots[i].filter(r=>r!==e);this.context.requestRender(),this._version.value++}prepareRender(){this._renderPlugins.forAll(e=>{e.prepareRender&&e.prepareRender(this.context.renderContext)})}updateAnimation(e){let i=!1;return this._renderPlugins.forAll(r=>i=r.updateAnimation?.(e)||i),i}precompile(...e){++this.context.techniques.precompiling;let i=this.context.renderContext.bind.slot;for(let r of e)this.context.renderContext.bind.slot=r,this._forEachRender(()=>{});this.context.renderContext.bind.slot=i,--this.context.techniques.precompiling}render(e,...i){for(let r of i)this.context.renderContext.bind.slot=r,this._forEachRender((s,a)=>s.render(this.context.renderContext,a,e))}_forEachRender(e){let i=this.context.renderContext.bind.slot,r=this.context.renderContext.output;this._slots[i].forEach(s=>{if(!s.produces.get(i)?.(r)||s.isDecoration&&!this.context.renderContext.bind.decorations)return;let n=s.acquireTechniques(this.context.renderContext);n&&e(s,n)})}queryDepthRange(e){let i=new qi;return this._renderPlugins.forAll(r=>{let s=r.queryDepthRange?.(e);i.union(s)}),i}get updating(){return this._version.value>=0&&this._renderPlugins.some(e=>e.running)}produces(e,...i){return i.some(r=>this._slots[r].some(s=>{let a=s.produces.get(r);return!!a&&a(e)}))}consumes(e){return this._renderPlugins.some(i=>i.consumes().required.includes(e))}hasHighlightOptions(e){return q2.some(i=>this._slots[i].some(r=>r.hasHighlightOptions(e)))}get hasDecorations(){return this._renderPlugins.some(e=>e.isDecoration)}get hasOccludees(){return this._renderPlugins.some(e=>e.hasOccludees)}get hasEmissions(){return this._renderPlugins.some(e=>e.hasEmissions)}get renderOccludedFlags(){return this._renderPlugins.reduce((e,i)=>e|i.renderOccludedFlags,fi.None)}get usedMemory(){return this._renderPlugins.reduce((e,i)=>i.material?e:e+(i.usedMemory??0),0)}get test(){}},q2=[Y.OPAQUE_MATERIAL,Y.TRANSPARENT_MATERIAL,Y.DRAPED_MATERIAL,Y.HUD_MATERIAL,Y.LABEL_MATERIAL];var ec=class extends Ne{constructor(e,i){super(e,i,new Le(px,()=>import("./chunk-GI5CQ3C7.js")))}initializePipeline(e){return qe({blending:oa,colorWrite:je,drawBuffers:e.hasEmission?{buffers:[Hi.COLOR_ATTACHMENT0,Hi.COLOR_ATTACHMENT1]}:{buffers:[Hi.COLOR_ATTACHMENT0]}})}};var Zd=class extends Nn{constructor(){super(...arguments),this.hasEmission=!1}};c([ht()],Zd.prototype,"hasEmission",void 0);var P_=class{constructor(e){this._techniques=e,this._parameters=new dx,this._configuration=new Zd,e.precompile(ec,this._configuration),this._configuration.hasEmission=!0,e.precompile(ec,this._configuration)}blend(e,i,r,s,a){this._parameters.colorTexture=i.getTexture(),a&&(this._parameters.emissionTexture=i.getTexture(Hi.COLOR_ATTACHMENT1),this._parameters.emissionFrontFaceTexture=r.getTexture(Hi.COLOR_ATTACHMENT1)),this._parameters.alphaTexture=i.getTexture(a?Hi.COLOR_ATTACHMENT2:Hi.COLOR_ATTACHMENT1),this._parameters.frontFaceTexture=r.getTexture(),this._configuration.hasEmission=a;let n=this._techniques.get(ec,this._configuration);e.bindTechnique(n,s,this._parameters),e.screen.draw()}};var M_=class{constructor(e,i){this._camera=e,this._dt=0,this._time=0,this._lastUpdate=0,this._lastUpdate=i,this._time=i}advance(e,i,r){let s=i-this._lastUpdate;this._dt=s/r,this._time=this._time+s,this._lastUpdate=i,this._camera=e}forceTime(e){this._lastUpdate=this._time=e,this._dt=0}get camera(){return this._camera}get dt(){return this._dt}get time(){return this._time}};var A_=class{constructor(){this._step=OP,this._dilation=1,this._firstIdleTime=0}frame(e,i){if(i?this._firstIdleTime===0&&(this._firstIdleTime=performance.now()):this._firstIdleTime=0,Yt("disable-feature:high-quality-idle"))this._dilation=1;else{let s=i?performance.now()-this._firstIdleTime:0;if(s>=AP+k2)return this._step=1/0,void(this._dilation=1);this._dilation=s>=AP?G2:1}let r=N(e/B2,OP,j2);this._step===1/0?this._step=r:this._step=this._step*EP+r*(1-EP)}get value(){return this._step}get timeDilation(){return this._dilation}clear(){this._step=this._firstIdleTime=0}},B2=.5,AP=12e4,k2=1e4,G2=10,EP=.9,z2=30,OP=1e3/1,j2=1e3/z2;var E_;(function(t){t[t.SHADOW_CASTERS=0]="SHADOW_CASTERS",t[t.FULL_SCENE=1]="FULL_SCENE"})(E_||(E_={}));var W2=1e4,iv=100,Q2=500,$2=500,Z2=.1;function LP(t,e,i,r=E_.SHADOW_CASTERS){let s=0;if(!e.some(n=>!!n.material&&(s+=n.numGeometries,s>=W2)))return tD.compute(t,e,r);let a=new qi;return i.forAll(n=>a.union(Y2(t,n))),a}function Y2(t,e){if(!e.visible)return;let i=new qi,r=e.getSpatialQueryAccelerator();return r?K2(i,t,r):X2(i,t,e.objects),i}function K2(t,e,i){let{eye:r,viewForward:s,frustum:a}=e,n=l=>l.visible,o=i.objectCount;if(o<Q2)Es.set(e.near,Math.min(t.near,e.far)),i.forEachInDepthRange(r,s,An.DepthOrder.FRONT_TO_BACK,Es,(l,h)=>{rv(t,e,l),Es.far=t.near,h.setRange(Es)},a,n),Es.set(Math.max(t.far,e.near),e.far),i.forEachInDepthRange(r,s,An.DepthOrder.BACK_TO_FRONT,Es,(l,h)=>{rv(t,e,l),Es.near=t.far,h.setRange(Es)},a,n);else{let l=Math.max(Math.min(o,$2),Math.ceil(o*Z2)),h=i.findClosest(s,An.DepthOrder.FRONT_TO_BACK,a,n,l),d=i.findClosest(s,An.DepthOrder.BACK_TO_FRONT,a,n,l);h&&d&&(DP(t,e,h.boundingVolumeWorldSpace.bounds),DP(t,e,d.boundingVolumeWorldSpace.bounds))}}function X2(t,e,i){tc.clear(),i.forAll(r=>{r.visible&&r.geometries.length!==0&&tc.add(r)}),tc.empty||(tc.sort(e),Es.set(e.near,Math.min(t.near,e.far)),tc.forEachInDepthRange(Es,An.DepthOrder.FRONT_TO_BACK,(r,s)=>{s<t.near&&rv(t,e,r)}),Es.set(Math.max(t.far,e.near),e.far),tc.forEachInDepthRange(Es,An.DepthOrder.BACK_TO_FRONT,(r,s,a)=>{t.far=Math.max(t.far,a)}))}function rv(t,e,i){if(!i.visible||!Rc(e.frustum,i.boundingVolumeWorldSpace.bounds))return;let r=i.transformation,s=eD;i.geometries.forEach(a=>{ns(s,r,a.transformation);let n=Np(s);NP(t,e,a.boundingInfo,s,n)})}function NP(t,e,i,r,s){if(i==null)return;At(Li,i.center,r);let{eye:a,viewForward:n}=e,o=n[0]*(Li[0]-a[0])+n[1]*(Li[1]-a[1])+n[2]*(Li[2]-a[2]);if(Li[3]=i.radius*s,!(o-Li[3]>t.near&&o+Li[3]<t.far)&&Rc(e.frustum,Li))if(i.radius>iv&&i.getChildren())for(let l of i.getChildren())NP(t,e,l,r,s);else ov.unionDepthRangeWithAABB(t,e.viewProjectionMatrix,r,i.bbMin,i.bbMax)}function DP(t,e,i){let r=e.eye,s=e.viewForward,a=(i[0]-r[0])*s[0]+(i[1]-r[1])*s[1]+(i[2]-r[2])*s[2];t.near=Math.min(t.near,a-i[3]),t.far=Math.max(t.far,a+i[3])}var sv=class{constructor(){this._items=new Xe({allocator:e=>e||{object:null,distance:0,near:0,far:0},deallocator:e=>(e.object=null,e.distance=0,e.near=0,e.far=0,e)})}get length(){return this._items.length}get empty(){return this._items.length===0}clear(){this._items.clear()}add(e){this._items.pushNew().object=e}sort(e){let i=e.eye,r=e.viewForward;this._items.forAll(s=>{let a=s.object.boundingVolumeWorldSpace.bounds,n=(a[0]-i[0])*r[0]+(a[1]-i[1])*r[1]+(a[2]-i[2])*r[2];s.distance=n,s.near=n-a[3],s.far=n+a[3]}),this._items.sort((s,a)=>s.distance-a.distance)}forEachInDepthRange(e,i,r){if(i===An.DepthOrder.FRONT_TO_BACK)for(let s=0;s<this._items.length;++s){let a=this._items.data[s];a.far<e.near||a.near>e.far||r(a.object,a.near,a.far)}else for(let s=this._items.length-1;s>=0;--s){let a=this._items.data[s];a.far<e.near||a.near>e.far||r(a.object,a.near,a.far)}}},av=class{constructor(){this._geometries=new Array,this._near=[],this._far=[],this._nearCandidates=[],this._farCandidates=[],this._looseRange=new qi(0,0)}compute(e,i,r){this._reset();let{viewMatrix:s}=e;i.forAll(h=>{h.forEachGeometry(d=>{if(!d.visible||r===E_.SHADOW_CASTERS&&!d.castShadow)return;let m=d.boundingSphere,u=s[2]*m[0]+s[6]*m[1]+s[10]*m[2]+s[14],f=u-m[3],g=u+m[3];this._geometries.push(d),this._near.push(-g),this._far.push(-f)})});let a=new qi;if(this._geometries.length===0)return a;for(let h=0;h<this._geometries.length;++h)this._near[h]>a.far&&(a.far=this._near[h]),this._near[h]>2&&this._far[h]<a.near&&(a.near=this._far[h]);let n=this._looseRange;n.near=Math.max(.5*a.near,2),n.far=2*a.far;let o=0,l=0;for(let h=0;h<this._geometries.length;++h)this._near[h]<a.near&&(this._near[h]>=n.near?a.near=this._near[h]:this._nearCandidates[o++]=h),this._far[h]>a.far&&(this._far[h]<=n.far?a.far=this._far[h]:this._farCandidates[l++]=h);if(this._nearCandidates.length===0&&this._farCandidates.length===0)return a;this._nearCandidates.sort((h,d)=>this._near[h]<this._near[d]?-1:this._near[h]>this._near[d]?1:0),this._farCandidates.sort((h,d)=>this._far[h]<this._far[d]?1:this._far[h]>this._far[d]?-1:0);for(let h=0;h<this._nearCandidates.length;++h){let d=this._nearCandidates[h];if(this._near[d]<a.near){let m=this._geometries[d],{boundingInfo:u,shaderTransformation:f}=m;this._includeNearBoundingInfoRec(e,u,f,a)}}for(let h=0;h<this._farCandidates.length;++h){let d=this._farCandidates[h];if(this._far[d]>a.far){let m=this._geometries[d],{boundingInfo:u,shaderTransformation:f}=m;this._includeFarBoundingInfoRec(e,u,f,a)}}return this._reset(),a}_reset(){this._geometries.length=0,this._near.length=0,this._far.length=0,this._nearCandidates.length=0,this._farCandidates.length=0}_isOutsideSidePlanes(e,i){let r=e,s=fw(e);return i[0][0]*r[0]+i[0][1]*r[1]+i[0][2]*r[2]+i[0][3]>s||i[1][0]*r[0]+i[1][1]*r[1]+i[1][2]*r[2]+i[1][3]>s||i[2][0]*r[0]+i[2][1]*r[1]+i[2][2]*r[2]+i[2][3]>s||i[3][0]*r[0]+i[3][1]*r[1]+i[3][2]*r[2]+i[3][3]>s}_includeNearBoundingInfoRec(e,i,r,s){if(i==null)return;let a=i.center;At(Li,a,r),Li[3]=i.radius*Np(r);let{frustum:n}=e;if(this._isOutsideSidePlanes(Li,n))return;let o=Li[0],l=Li[1],h=Li[2],d=Li[3],{viewMatrix:m}=e,u=m[2]*o+m[6]*l+m[10]*h+m[14],f=u+d;if(!(-(u-d)<2||-f>=s.near))if(-f>this._looseRange.near)s.near=-f;else{if(d>iv){let g=i.getChildren();if(g!==void 0){for(let y of g)this._includeNearBoundingInfoRec(e,y,r,s);return}}ov.unionDepthRangeWithAABB(s,e.viewProjectionMatrix,r,i.bbMin,i.bbMax)}}_includeFarBoundingInfoRec(e,i,r,s){if(i==null)return;let a=i.center;At(Li,a,r),Li[3]=i.radius*Np(r);let{frustum:n}=e;if(this._isOutsideSidePlanes(Li,n))return;let[o,l,h,d]=Li,{viewMatrix:m}=e,u=m[2]*o+m[6]*l+m[10]*h+m[14]-d;if(!(-u<=s.far))if(-u<this._looseRange.far)s.far=-u;else{if(d>iv){let f=i.getChildren();if(f!==void 0){for(let g of f)this._includeFarBoundingInfoRec(e,g,r,s);return}}ov.unionDepthRangeWithAABB(s,e.viewProjectionMatrix,r,i.bbMin,i.bbMax)}}},nv=class{constructor(){this._modelViewProj=Rt(),this._clipPosition=[ni(),ni(),ni(),ni(),ni(),ni(),ni(),ni()]}unionDepthRangeWithAABB(e,i,r,s,a){let n=this._modelViewProj;ns(n,i,r);let o=!1;for(let l=0;l<8;++l){let h=this._clipPosition[l],d=l===0||l===3||l===4||l===7?s[0]:a[0],m=l===0||l===1||l===4||l===5?s[1]:a[1],u=l<4?s[2]:a[2];h[0]=n[0]*d+n[4]*m+n[8]*u+n[12],h[1]=n[1]*d+n[5]*m+n[9]*u+n[13],h[2]=n[2]*d+n[6]*m+n[10]*u+n[14],h[3]=n[3]*d+n[7]*m+n[11]*u+n[15]}for(let l=0;l<12;++l){let h=J2(this._clipPosition[tv[l][0]],this._clipPosition[tv[l][1]],this._clipPosition[tv[l][2]]),d=!0;for(let m=0;m<h.length;++m)if(h[m][3]>=2){d=!1;break}if(!d){o=!0;for(let m=0;m<h.length;++m){let u=h[m][3];Number.isFinite(u)&&(e.near=Math.min(u,e.near),e.far=Math.max(u,e.far))}}}return o}};function J2(t,e,i){let r=[t,e,i];for(let s=0;s<4;++s){let a=r;r=[];for(let n=0;n<a.length;++n){let o=a[n],l=a[(n+1)%a.length];ev(l,s)?(ev(o,s)||r.push(IP(o,l,s)),r.push(l)):ev(o,s)&&r.push(IP(o,l,s))}}return r}function ev(t,e){return e===0?t[0]>=-t[3]:e===1?t[1]>=-t[3]:e===2?t[0]<=t[3]:e===3?t[1]<=t[3]:void Wi(!1)}function IP(t,e,i){let r=0;return i===0?r=(-t[3]-t[0])/(e[0]-t[0]+e[3]-t[3]):i===1?r=(-t[3]-t[1])/(e[1]-t[1]+e[3]-t[3]):i===2?r=(t[3]-t[0])/(e[0]-t[0]-e[3]+t[3]):i===3&&(r=(t[3]-t[1])/(e[1]-t[1]-e[3]+t[3])),C1(ni(),t,e,r)}var tv=[[0,1,3],[2,3,1],[1,5,2],[6,2,5],[5,4,6],[7,6,4],[4,0,7],[3,7,0],[3,2,7],[6,7,2],[4,5,0],[1,0,5]],Li=mi(),eD=Rt(),Es=new qi,tc=new sv,tD=new av,ov=new nv;var FP={idleOpacity:.8,navigatingOpacity:.4,maxDelta:.1,tiltFadeStart:20,tiltFadeEnd:30,altitudeStart:1e4,altitudeEnd:2e4};var O_=class{constructor(e){this._fbos=e,this._requiresEmission=!1,this._size=new kb(0,0),this._clearColor=ni()}dispose(){this._color=ai(this._color),this.releaseDepth()}initialize(e,i,r,s){this._size.width=e,this._size.height=i,Yl(this._size,this._fbos.rctx.parameters.maxTextureSize);let a=this._color;return this._color=null,this.releaseDepth(),this._requiresEmission=s,Dl(this._clearColor,r),a}releaseDepth(){this._color?.detachDepth(),this._depth=ai(this._depth)}update(e){let i=this._ensureColor();i.attachDepth(this.depth),this._color=e(i)}bind(){let e=this._color==null;if(this.color.attachDepth(this.depth),this._fbos.rctx.bindFramebuffer(this.color.fbo),e){let i=this._fbos.rctx;i.setClearStencil(0),i.setClearColor(this._clearColor[0],this._clearColor[1],this._clearColor[2],this._clearColor[3]),i.clear(Lt.COLOR|Lt.DEPTH|Lt.STENCIL),this._requiresEmission&&i.gl.clearBufferfv(i.gl.COLOR,1,Xp)}}_acquireColor(){return this._requiresEmission?this._fbos.acquire(this._size.width,this._size.height,"acquired-color").acquireColor(Hi.COLOR_ATTACHMENT1,zt.RGBA,"emissive"):this._fbos.acquire(this._size.width,this._size.height,"acquired-color")}_acquireDepth(){return this._fbos.acquireDepth(bi.DEPTH_STENCIL_TEXTURE,this._size.width,this._size.height,"depth")}get size(){return this._size}get color(){return this._ensureColor()}get depth(){return this._depth??=this._acquireDepth(),this._depth}_ensureColor(){return this._color??=this._acquireColor(),this._color}};var D_=class{constructor(){this._inputs=new Map}set(e,i){this._inputs.set(e,i)}get(e){return this._inputs.get(e)}has(e){return this._inputs.has(e)}release(e){this._inputs.get(e)?.release()&&this._inputs.delete(e)}};var Yd=class extends Ne{constructor(e,i){super(e,i,new Le(gx,()=>import("./chunk-ZODB54O6.js"))),this.primitiveType=ft.TRIANGLE_STRIP}initializePipeline(){return qe({blending:oa,colorWrite:je,depthTest:null,depthWrite:null})}};var VP=4e4,UP=5e4,lv=1/512,Kd=class extends te{constructor(t,e,i,r){super({}),this._techniques=t,this._rctx=e,this._data=i,this._requestRender=r,this._passParameters=new _x(this._data),this._configuration=new fx,this._enabled=!1,this._vao=ar(e)}dispose(){this._stop(),this._vao=ge(this._vao)}precompile(){this._showVisualization&&this._techniques.precompile(Yd,this._configuration)}render(t){if(!this._showVisualization)return;this._passParameters.sampleScale=1/this._data.computedSamples;let e=this._techniques.get(Yd,this._configuration);this._rctx.bindVAO(this._vao),this._rctx.bindTechnique(e,t,this._passParameters),this._rctx.drawArrays(e.primitiveType,0,Hs(this._vao,"geometry"))}setOptions(t){t.enabled!==void 0&&this._setEnabled(t.enabled),t.color!==void 0&&this._setColor(t.color),t.threshold!==void 0&&(this._threshold=t.threshold),t.visualization!==void 0&&(this._visualization=t.visualization),t.bandSize!==void 0&&(this._bandSize=t.bandSize),t.bandsEnabled!==void 0&&(this._bandsEnabled=t.bandsEnabled)}get opacityFromElevation(){return this._passParameters.opacityFromElevation}set opacityFromElevation(t){this._passParameters.opacityFromElevation!==t&&(this._passParameters.opacityFromElevation=t,this.notifyChange("opacityFromElevation"))}get _showVisualization(){return this._enabled&&this._data.computedSamples>0&&this.opacityFromElevation>lv}get _threshold(){return this._passParameters.threshold}set _threshold(t){this._threshold!==t&&(this._passParameters.threshold=t,this._requestRenderIfEnabled())}get _visualization(){return this._configuration.visualization}set _visualization(t){t!==this._visualization&&(this._configuration.visualization=t,this._requestRenderIfEnabled())}get _bandSize(){return this._passParameters.bandSize}set _bandSize(t){t!==this._bandSize&&(this._passParameters.bandSize=t,this._requestRenderIfEnabled())}get _bandsEnabled(){return this._configuration.bandsEnabled}set _bandsEnabled(t){t!==this._bandsEnabled&&(this._configuration.bandsEnabled=t,this._requestRenderIfEnabled())}_setColor(t){let e=this._passParameters.color;x1(t,e)||(Dl(this._passParameters.color,t),this._requestRenderIfEnabled())}_setEnabled(t){t!==this._enabled&&(t?this._start():this._stop())}_requestRenderIfEnabled(){this._enabled&&this._requestRender()}_start(){this._enabled=!0,this._requestRender()}_stop(){this._enabled=!1,this._requestRender()}};c([p()],Kd.prototype,"opacityFromElevation",null),Kd=c([S("esri.views.3d.webgl-engine.lib.ShadowCastRenderer")],Kd);var Xd=class extends Ne{constructor(e,i){super(e,i,new Le(ux,()=>import("./chunk-FHBZ5MTM.js"))),this.primitiveType=ft.TRIANGLE_STRIP}initializePipeline(){return qe({blending:Uw,colorWrite:je,depthTest:null,depthWrite:null})}};var ur=class extends te{constructor(t,e,i,r,s,a){super({}),this.fbos=t,this._techniques=e,this._stage=i,this._prepareForShadowMapPass=r,this._renderToShadowMap=s,this._requestRender=a,this._progress=0,this._sampleCount=0,this._passParameters=new Qp,this._cachedLightDirections=[],this._depthRange=qi.zero,this._previewing=!1,this._cameraForcedForScreenshot=!1,this._shadowAccumulatorKey="shadowAccumulator",this._rctx=t.rctx,this._bindParameters=new am(new nm(t,i.viewingMode)),this._bindParameters.shadowMap.enabled=!0,this._vao=ar(this._rctx),this._accumulationRenderer=new Kd(e,this._rctx,this,a);let n=this._stage.view.resourceController.scheduler;this.addHandles([n.registerTask(ut.SHADOW_ACCUMULATOR,this),P(()=>i.renderView,o=>{this.removeHandles(HP),o!=null&&this.addHandles(o.events.on("force-camera-for-screenshot",()=>this._cameraForcedForScreenshot=!0),HP)},ye),P(()=>this._previewing,()=>this._requestRenderIfEnabled(),we)],this._shadowAccumulatorKey),e.precompile(Xd)}normalizeCtorArgs(){return{}}dispose(){this._disable(),this.removeHandles(this._shadowAccumulatorKey),this._accumulationRenderer=ge(this._accumulationRenderer),this._bindParameters.shadowMap.dispose(),this._fbo=ge(this._fbo),this._vao=ge(this._vao),this._cachedLightDirections.length=0,this._sampleCount=0}get computedSamples(){return this._progress}get shadowCastTexture(){return this._fbo?.colorTexture}get accumulating(){return this._active&&this._previewing||this._refining}get _refining(){return this._active&&!this._doneAccumulating&&!this._previewing}get _active(){return this._fbo!=null&&this._sampleCount>0}get canAccumulate(){return this._bindParameters.depth!=null&&this._depthRange!==qi.zero&&this._opacityFromElevation>lv}get _doneAccumulating(){return this._progress>=this._sampleCount}get _lightDirections(){return this._cachedLightDirections}set _lightDirections(t){let e=this._cachedLightDirections;if(np(e,t,Tn))return;let i=Math.min(mx,t.length);e.length=i,this._sampleCount=i;for(let r=0;r<i;++r)e[r]=q(e[r]??_(),t[r]);this._invalidate()}get _opacityFromElevation(){return this._accumulationRenderer.opacityFromElevation}set _opacityFromElevation(t){this._accumulationRenderer.opacityFromElevation=t}get running(){return this._refining&&this.canAccumulate&&this._progress>0}runTask(t){for(this._prepareForShadowMapPass(this._bindParameters);!t.done&&!this._doneAccumulating;)this._accumulateShadow(),t.madeProgress();this._requestRender()}renderAccumulation(t,e,i,r){if(this._depthRange=e,this._updateCamera(i),this._bindParameters.contentCamera=r,this._bindParameters.depth=t,this._passParameters.origin=this._bindParameters.camera.center,this.notifyChange("canAccumulate"),!this.accumulating||!this.canAccumulate)return!1;(this._previewing||this._progress===0||this._cameraForcedForScreenshot)&&this._clear();let s=this._cameraForcedForScreenshot?this._sampleCount:Math.min(iD,this._sampleCount);s-=this._progress;for(let a=0;a<s;++a)this._accumulateShadow(),this._requestRender();return this._cameraForcedForScreenshot=!1,s>0}precompile(){this._accumulationRenderer.precompile()}render(t){this._accumulationRenderer.render(t)}setOptions(t){if(t.enabled!==void 0){let e=this._fbo!=null;t.enabled!==e&&(t.enabled?this._enable():this._disable())}t.previewing!==void 0&&(this._previewing=t.previewing),t.lightDirections!==void 0&&(this._lightDirections=t.lightDirections),this._accumulationRenderer.setOptions(t)}readAccumulatedShadow(t,e){return!this._active||!this._fbo||this._progress<1||t<0||t>=this._fbo.width||e<0||e>=this._fbo.height?0:(this._fbo.readPixels(t,e,1,1,St.RGBA,sa.UNSIGNED_BYTE,qP),qP[0]/this._progress)}_enable(){this._progress=0;let t=new Ot;t.pixelFormat=St.RED,t.internalFormat=Cn.R8,t.wrapMode=Jt.CLAMP_TO_EDGE,this._fbo=new la(this._rctx,t),this._requestRender()}_disable(){this._fbo=ge(this._fbo),this._requestRender()}_invalidate(){this._progress=0,this._requestRenderIfEnabled()}_clear(){this._rctx.bindFramebuffer(this._fbo),this._rctx.setClearColor(0,0,0,0),this._rctx.clear(Lt.COLOR),this._progress=0}_accumulateShadow(){this._renderToShadowMap(this._bindParameters,this._lightDirections[this._progress++],this._depthRange);let t=this._techniques.get(Xd);this._rctx.bindFramebuffer(this._fbo),this._rctx.bindTechnique(t,this._bindParameters,this._passParameters),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(t.primitiveType,0,Hs(this._vao,"geometry"))}_updateCamera(t){let e=this._fbo;if(e==null)return;let i=this._bindParameters.camera;t.equals(i)||i.copyFrom(t),e.resize(t.fullWidth,t.fullHeight),this._opacityFromElevation=1-za(VP,UP,t.relativeElevation)}_requestRenderIfEnabled(){this._fbo&&this._requestRender()}get test(){}};c([p()],ur.prototype,"_progress",void 0),c([p()],ur.prototype,"_sampleCount",void 0),c([p()],ur.prototype,"_fbo",void 0),c([p()],ur.prototype,"_depthRange",void 0),c([p()],ur.prototype,"_previewing",void 0),c([p()],ur.prototype,"_accumulationRenderer",void 0),c([p()],ur.prototype,"_refining",null),c([p()],ur.prototype,"_active",null),c([p()],ur.prototype,"canAccumulate",null),c([p()],ur.prototype,"_doneAccumulating",null),c([p()],ur.prototype,"_opacityFromElevation",null),c([p()],ur.prototype,"running",null),ur=c([S("esri.views.3d.webgl-engine.lib.ShadowAccumulator")],ur);var iD=6,HP="renderView",qP=new Uint8Array(4);var rD=Mc(),I_=class{constructor(){this._plane=Mc()}get plane(){return this._plane}set plane(e){Gl(e||rD,this._plane)}};function BP(t,e){let i=t.capabilities.disjointTimerQuery;return i==null?null:new hv(i,e)}var hv=class{constructor(e,i){this._timer=e,this._queryPool=new Array,this._queryResults=new Map,this._currentQuery=null,i.forEach(r=>{let s=this._timer.createQuery(),a=this._timer.createQuery();this._queryPool.push(s,a),this._queryResults.set(r,null)})}start(){wT||(this._currentQuery=this._queryPool.pop(),this._currentQuery!=null&&(this._timer.disjoint(),this._timer.beginTimeElapsed(this._currentQuery)))}stop(e){if(this._timer.disjoint()||this._currentQuery==null||!this._queryResults.has(e))return this.abort(),null;this._timer.endTimeElapsed();let i=this._queryResults.get(e);if(i==null)return this._queryResults.set(e,this._currentQuery),this._currentQuery=null,null;if(!this._timer.resultAvailable(i))return this._queryPool.unshift(this._currentQuery),this._currentQuery=null,null;let r=this._timer.getResult(i)/1e6;return this._queryPool.unshift(i),this._queryResults.set(e,this._currentQuery),this._currentQuery=null,r}abort(){this._currentQuery!=null&&(this._timer.deleteQuery(this._currentQuery),this._queryPool.unshift(this._timer.createQuery()),this._currentQuery=null)}dispose(){this._currentQuery!=null&&this._timer.deleteQuery(this._currentQuery),this._queryPool.forEach(e=>{this._timer.deleteQuery(e)}),this._queryResults.forEach(e=>{e!=null&&this._timer.deleteQuery(e)})}};var Gt;(function(t){t.OVERLAY="overlay",t.PREPARE="prepare",t.SHADOW_MAP="shadow map",t.DEPTH="depth",t.ACCUMULATED_SHADOWS="accumulated shadows",t.APPLY_ACCUMULATED_SHADOWS="apply accumulated shadows",t.OBJECT_AND_LAYER_ID_COLOR="object/layer id color",t.NORMALS="normals",t.SSAO="SSAO",t.HIGHLIGHTS="highlights",t.OPAQUE_EDGES="opaque edges",t.VOXEL="voxel",t.TRANSPARENT="transparent",t.TRANSPARENT_EDGES="transparent edges",t.HUD_VISIBILITY="HUD visibility",t.TRANSPARENT_TERRAIN="transparent terrain",t.TRANSPARENT_MATERIAL_WITHOUT_DEPTH="transparent material without depth",t.OPAQUE_ENVIRONMENT="opaque environment",t.TRANSPARENT_ENVIRONMENT="transparent environment",t.OCCLUDED="occluded",t.HUD="HUD",t.HUD_OCCLUDED="HUD occluded",t.FINISH="finish",t.FOCUS_AREA_MASK="focus area mask"})(Gt||(Gt={}));var cv=Object.values(Tt).concat(Object.values(le)).concat(Object.values(Gt)),kP="Total",L_=class{constructor(e){this._rctx=e,this._startTimeStampCPU=0,this._lastTimeStampCPU=0,this._totalCPUTime=new dc(kP),this._cpuTimeSamplers=new Map(cv.map(i=>[i,new dc(i)])),this._enableGPUTimer=0,this._totalGPUTime=new dc("GPU"),this._gpuTimeSamplers=new Map(cv.map(i=>[i,new dc(i)])),this._totalTime=0,this._totalFrameCount=0}get totalCPUTimeSampler(){return this._totalCPUTime}get cpuTimeSamplers(){return Array.from(this._cpuTimeSamplers.values())}get totalGPUTimeSampler(){return this._totalGPUTime}get gpuTimeSamplers(){return Array.from(this._gpuTimeSamplers.values())}get gpuSamplingEnabled(){return this._gpuTimerPool!=null}get totalTime(){return this._totalTime}get totalFrameCount(){return this._totalFrameCount}get elapsedTime(){return performance.now()-this._startTimeStampCPU}enableGPUPerformanceInfo(){if(this._gpuTimerPool==null){let i=[...cv,kP];this._gpuTimerPool=BP(this._rctx,i)}if(this._gpuTimerPool==null)return{hasGPUTimerSupport:!1,remove:()=>{}};++this._enableGPUTimer;let e=!1;return{hasGPUTimerSupport:!0,remove:()=>{e||(e=!0,--this._enableGPUTimer,this._enableGPUTimer===0&&(this._gpuTimerPool=ge(this._gpuTimerPool)))}}}startFrame(){this._startTimeStampCPU=this._lastTimeStampCPU=performance.now(),this._gpuTimerPool&&(this._gpuTimeSamplers.forEach(e=>e.push(0)),this._gpuTimerPool.start())}advance(e){let i=performance.now();if(this._cpuTimeSamplers.get(e).push(i-this._lastTimeStampCPU),this._lastTimeStampCPU=i,this._gpuTimerPool){let r=this._gpuTimerPool.stop(e);this._gpuTimeSamplers.get(e).set(r),this._gpuTimerPool.start()}}finishFrame(){if(this._gpuTimerPool){let i=this._gpuTimerPool.stop(Gt.FINISH);this._gpuTimeSamplers.get(Gt.FINISH).set(i),this._rctx.gl.flush()}let e=performance.now()-this._startTimeStampCPU;this._totalTime=this._totalTime+e,this._totalCPUTime.push(e),this._gpuTimerPool&&this._totalGPUTime.push(this.gpuTimeSamplers.reduce((i,r)=>i+(r.last||0),0)),++this._totalFrameCount}};var pl=class{constructor(e,i,r,s,a,n){this._stage=e,this._techniques=r,this._rctx=s,this._compositingHelper=a,this._requestRender=n,this._pluginsHas={hudElements:!1,water:!1},this._renderers=new Map,this.renderPassManager=new x_,this._isRendering=!1,this._inGlobeView=!1,this._backgroundColor=rr(0,0,0,1),this._sliceHelper=new I_,this._blit=null,this._oitblend=null,this._state=fr(Zt.IDLE),this._highQualityTransparencyEnabled=!0,this._ssrEnabled=!1,this._hasAnimations=!1,this._animationTimestep=new A_,this._loadEdgeViewTask=null,this._edgeViewCallbacks=[],this._reprojectionMatrixVersion=fr(0),this._lastFrameTime=0,this._renderHiddenTransparentEdges=()=>{},this._pluginInput=new D_,this._releaseNormals=o=>{o.some(({name:l})=>l==="normals")&&this._pluginInput.release("normals")},this._debugNeedsDepth=!1,this.fboCache=new g_(s),this._renderStateFeatures=fr(Vg(!Yt("disable-feature:high-quality-idle"),e.view.qualityProfile)),this._framebuffer=new O_(this.fboCache),this.performanceInfo=new L_(this._rctx),this._shadowMap=new nm(this.fboCache,e.viewingMode),this._shadowAccumulator=new ur(this.fboCache,r,e,o=>{let l=this.shadowsEnabled;this._shadowMap.enabled=!0,this._ensureBindParametersCamera(o.camera,o.contentCamera),this._plugins.prepareRender(),this._shadowMap.enabled=l},(o,l,h)=>{let d=this._stage.view.qualitySettings.maximumPixelRatio;o.shadowMap.start(o.camera,l,h,!0,d),this._renderShadowCascades(j.Shadow,o.shadowMap),o.shadowMap.finish(),o.camera.setGLViewport(this._rctx),this._ensureBindParametersCamera(o.camera,o.contentCamera)},n),this._renderContext=new Gb(this._rctx,this._shadowMap,r),this._nodes=new S_(this._renderContext),this._plugins=new R_({renderContext:this._renderContext,techniques:r,materials:i,requestRender:n,controller:e,fbos:this.fboCache,isFeatureEnabled:o=>this.isFeatureEnabled(o)}),this._plugins.add(this.renderPassManager),this._handles=[P(()=>this._stage.view.state.camera,()=>n(),ye),P(()=>ui.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES,o=>{this._renderHiddenTransparentEdges=o?()=>this._renderEdges(Oo.TRANSPARENT):()=>{},n()},Ie),P(()=>this._stage.view.environment.background?.color,o=>{let l=o?Vl(o):sr;ls(this._backgroundColor,l[0]*l[3],l[1]*l[3],l[2]*l[3],l[3]),n()},ye),P(()=>this._stage.view.state.camera.relativeElevation,o=>this._inGlobeView=(o??1/0)>=5e5,ye),P(()=>this._bindParameters.clouds.fadeFactor,()=>this._bindParameters.fadeLighting(),we),P(()=>this._bindParameters.clouds.data?.state,()=>n(),we),P(()=>this._stage.view.state.highlights,o=>{this._bindParameters.highlights=o,this._updateHighlights(),n()},Ie)]}destroy(){this._handles.forEach(e=>e.remove()),this._gpuTimerHandle=Pi(this._gpuTimerHandle),this._nodes.destroy(),this._framebuffer.dispose(),this._shadowMap.dispose(),this._shadowAccumulator.dispose(),this._loadEdgeViewTask=Ar(this._loadEdgeViewTask),this._edgeView=G(this._edgeView),this.renderPassManager.dispose(),this._releaseFBOs(),this._disposeOffscreenBuffers(),this.fboCache.destroy(),this._plugins.destroy(),this._renderers.clear(),this._blit=null,this._oitblend=null,ob.prune(),Yg.prune(),q1()}get renderContext(){return this._renderContext}get _bindParameters(){return this._renderContext.bind}get _framebufferSize(){return this._framebuffer.size}updateRenderFeatures(e=null,i=!Yt("disable-feature:high-quality-idle")){this._renderStateFeatures.value=Vg(i,e),this._requestRender()}isFeatureEnabled(e,i=this._state.value){return this._renderStateFeatures.value.get(i,e)??!1}setFeatureEnabled(e,i,r){this._renderStateFeatures.mutate(s=>s.set(i,e,r)),this._requestRender()}get _highQualityTransparency(){return this._highQualityTransparencyEnabled||this.isFeatureEnabled(fs.HighQualityTransparency)}get hasReflections(){return this._pluginsHas.water&&(this._ssrEnabled||this.isFeatureEnabled(fs.WaterReflection))}get _hasHighlights(){return this._plugins.produces(j.Highlight,Y.OPAQUE_MATERIAL,Y.TRANSPARENT_MATERIAL,Y.DRAPED_MATERIAL,Y.HUD_MATERIAL,Y.LABEL_MATERIAL)}hasHighlightOptions(e){return this._plugins.hasHighlightOptions(e)}get _hasHUDHighlights(){return this._plugins.produces(j.Highlight,Y.HUD_MATERIAL,Y.LABEL_MATERIAL)}get hasSSAO(){return(this._stage.view.qualitySettings.ambientOcclusion||this.isFeatureEnabled(fs.SSAO))&&!this._inGlobeView}get hasSMAA(){return this._stage.view.qualitySettings.antialiasingEnabled||this.isFeatureEnabled(fs.Antialiasing)}get fullResolutionAtmosphere(){return this._stage.view.qualitySettings.highResolutionAtmosphere||this.isFeatureEnabled(fs.HighResolutionAtmosphere)}_releaseFBOs(){this._bindParameters.ssr.lastFrameColor=ai(this._bindParameters.ssr.lastFrameColor),this._bindParameters.terrainDepth=ai(this._bindParameters.terrainDepth),this._bindParameters.geometryDepth=ai(this._bindParameters.geometryDepth)}_disposeOffscreenBuffers(){this._framebuffer.dispose(),this._disposeBindBuffers()}_disposeBindBuffers(){this._shadowMap.disposeOffscreenBuffers(),this._bindParameters.depth=ai(this._bindParameters.depth),this._bindParameters.hudVisibility=ai(this._bindParameters.hudVisibility)}get updating(){return this._edgeView!=null&&this._edgeView.updating||this._shadowAccumulator.running||this._plugins.updating||!this.isCameraFinal}loadEdgeView(){return this._loadEdgeViewTask||(this._loadEdgeViewTask=Js(e=>Re(this,null,function*(){let{EdgeView:i}=yield import("./chunk-HUVTQ7IQ.js");Vi(e);let r=this._edgeView=new i({rctx:this._rctx,renderSR:this._stage.view.renderSpatialReference,viewingMode:this._stage.viewingMode,techniques:this._techniques,setNeedsRender:()=>this._requestRender(),schedule:lD(this._stage.view.resourceController)});return this._handles.push(P(()=>r.updating,()=>this._requestRender(),we)),this._requestRender(),this._edgeViewCallbacks.forEach(s=>s(r)),this._edgeViewCallbacks.length=0,r}))),this._loadEdgeViewTask.promise}withEdgeView(e){this.loadEdgeView(),this._edgeView==null?this._edgeViewCallbacks.push(e):e(this._edgeView)}get edgeView(){return this._edgeView}get isCameraFinal(){return this._reprojectionMatrixVersion.value>=0&&_1(this._bindParameters.ssr.reprojectionMatrix,xn)}set _reprojectionMatrix(e){Pv(this._bindParameters.ssr.reprojectionMatrix,e)&&this._reprojectionMatrixVersion.value++}get shadowsEnabled(){return!!this._shadowMap?.enabled}setParameters(e){let{_shadowMap:i,_bindParameters:r}=this;if(e.qualitySettings?.reflections!==void 0&&this._ssrEnabled!==e.qualitySettings.reflections&&(this._ssrEnabled=e.qualitySettings.reflections,this._requestRender()),e.shadowMap!==void 0&&this._shadowMap.enabled!==e.shadowMap&&(this._shadowMap.enabled=e.shadowMap,this._requestRender()),e.shadowMapMaxCascades!==void 0&&i.maxCascades!==e.shadowMapMaxCascades&&(i.maxCascades=e.shadowMapMaxCascades,this._requestRender()),e.environment!=null){e.environment.weather!=null&&(this._bindParameters.weather=e.environment.weather,this._bindParameters.weatherVisible=!!e.weatherVisible);let s=e.environment.lighting.type!=="virtual";r.enableFillLights!==s&&(r.enableFillLights=s,this._requestRender())}e.highQualityTransparency!==void 0&&this._highQualityTransparencyEnabled!==e.highQualityTransparency&&(this._highQualityTransparencyEnabled=e.highQualityTransparency,this._requestRender()),e.shadowCast!==void 0&&this._shadowAccumulator.setOptions(e.shadowCast)}set slicePlane(e){this._sliceHelper.plane!==e&&(this._sliceHelper.plane=e,this._requestRender())}get plugins(){return this._plugins}getMaterialRenderer(e){return this._renderers.get(e)}get _hasOITSupport(){return this._rctx.driverTest.floatBufferBlend.result}get _oitEnabled(){return this._highQualityTransparency&&this._hasOITSupport}modify(e,i){this._isRendering&&console.warn("Renderer.modify called while rendering");let{adds:r,removes:s,updates:a}=e;r.length===0&&s.length===0&&a.length===0||(Aw(e).forEach((n,o)=>{if(i.done)return;let l=this._renderers.get(o);l==null&&n.adds.length>0&&(l=new Yg({material:o,highlightOrderMap:this._stage.view.state.highlightOrderMap}),l.initializeRenderContext(this._plugins.context),this._plugins.add(l),this._renderers.set(o,l)),l&&(l.modify(n),l.updateHighlights(this._stage.view.state.highlightOrderMap),l.numGeometries===0&&(this._renderers.delete(l.material),this._plugins.remove(l),l.destroy())),n.removes.forEach(h=>e.removes.removeUnordered(h)),n.adds.forEach(h=>e.adds.removeUnordered(h)),n.updates.forEach(h=>e.updates.removeUnordered(h)),i.madeProgress()}),this.updateHasFlags())}updateHasFlags(){let e=this._pluginsHas;e.hudElements=this._plugins.produces(j.Color,...ep),e.water=this._plugins.produces(j.Normal,Y.DRAPED_WATER),this._bindParameters.hasOccludees=this._plugins.hasOccludees,this._requestRender()}updateAnimation(e,i){this._animationTimer??=new M_(e.camera,i),this._animationTimer.advance(e.camera,i,this._animationTimeDilation),e.forcedAnimationTime!=null&&this._animationTimer.forceTime(e.forcedAnimationTime);let r=this._hasAnimations;return this._hasAnimations=this._plugins.updateAnimation(this._animationTimer),this._hasAnimations=this._nodes.updateAnimation(this._animationTimer)||this._hasAnimations,this._hasAnimations!==r&&(this._gpuTimerHandle=r?Pi(this._gpuTimerHandle):this.performanceInfo.enableGPUPerformanceInfo()),this._hasAnimations}get animationTimestep(){return this._animationTimestep.value}get _animationTimeDilation(){return this._animationTimestep.timeDilation}resetAnimation(){this._animationTimestep.clear()}tick(){this.fboCache.clean()}render(e,i,r=Vs.Default,s=!1){try{return this._isRendering=!0,this._render(e,i,r,s)}catch(a){console.error(`Exception during rendering: ${a}`)}finally{this._isRendering=!1}return new yd(this._pluginInput.get(Tt.FINAL),null)}_updateHUDOccludedFragmentOpacity(e,i){let{idleOpacity:r,navigatingOpacity:s,maxDelta:a,tiltFadeStart:n,tiltFadeEnd:o,altitudeStart:l,altitudeEnd:h}=FP,d=this._stage.view,m=d.stateManager.camera,u=d.qualitySettings.fadeDuration,f=e===Zt.IDLE?r:s,g=N((m.tilt-n)/(o-n),0,1),y=N((m.position.z??0-l)/(h-l),0,1),v=Ae(Ae(1,f,g),1,y),w=this._bindParameters.hudOccludedFragmentOpacity;if(u<=0||w===v||this._lastFrameTime===0||this._lastFrameTime>i)return this._bindParameters.hudOccludedFragmentOpacity=v,void(this._lastFrameTime=i);let b=i-this._lastFrameTime;this._lastFrameTime=i;let R=Math.min(Math.abs(r-s)*b/u,a);R>=Math.abs(v-w)?this._bindParameters.hudOccludedFragmentOpacity=v:(this._bindParameters.hudOccludedFragmentOpacity=w+Math.sign(v-w)*R,this._requestRender())}_render(e,i,r=Vs.Default,s){this.performanceInfo.startFrame(),this.fboCache.frameStart(),this.fboCache.interactive=r===Vs.Default,this._disposeBindBuffers();let{camera:a,contentCamera:n,mode:o,alignPixelEnabled:l}=e;this._state.value=o;let h=this._nodes.produces("magnifier-color"),d=this._nodes.produces(Tt.FINAL),m=this._nodes.require("emissive",Tt.FINAL,Tt.COMPOSITE)>0&&this._plugins.hasEmissions,u=m?j.ColorEmission:j.Color;this._renderContext.time=i,this._renderContext.output=u,this._bindParameters.oitPass=Qr.NONE,this._bindParameters.alignPixelEnabled=l,this._bindParameters.decorations=!s,this._bindParameters.mainDepth=null,this._bindParameters.slicePlane=this._sliceHelper.plane,this._bindParameters.viewshedEnabled=this._nodes.produces(le.VIEWSHED),this._renderOverlay(i),a.setGLViewport(this._rctx);let f=this._framebuffer,g=f.initialize(a.fullWidth,a.fullHeight,this._backgroundColor,m);this.hasReflections?(g?.setName("last frame color"),this._bindParameters.ssr.lastFrameColor=g):g?.release(),this._ensureBindParametersCamera(a,n),this._updateHUDOccludedFragmentOpacity(o,i),this._plugins.prepareRender(),this._bindParameters.shadowHighlightsVisible=this._needsShadowHighlight&&!s;let y=this._highQualityTransparency&&this._hasTransparentTerrain,v=this._plugins.produces(j.Color,...Jd);this._precompilePrepasses(),this.performanceInfo.advance(Gt.PREPARE);let w=this._computeDepthRange(a);this._renderShadowMap(a,this._bindParameters.lighting.mainLight.direction,w),this._ensureBindParametersCamera(a,n),this._pluginInput.set("normals",this._renderNormals()),this._renderRemainingGeometryDepth(),this._renderShadowAccumulation(w,a,n),this._ensureBindParametersSSR(i),this._precompileShaders(y,v,u),this._renderContext.output=u,f.bind(),this._bindParameters.mainDepth=f.depth.attachment;let b=this.plugins.produces(j.Color,...dv);b&&this._renderOpaqueGeometry(),f.update(H=>this._renderNodes(Tt.OPAQUE,H,b)),this.fboCache.debugCallback?.(Tt.OPAQUE,f.color.fbo),f.update(H=>this._renderNodes(le.OPAQUE_ENVIRONMENT,H)),this.fboCache.debugCallback?.(le.OPAQUE_ENVIRONMENT,f.color.fbo),this._renderTerrainDepth(y),this._renderEdges(Oo.OPAQUE),f.bind(),this._renderPlugins(Y.VOXEL,Gt.VOXEL),this._renderHiddenTransparentEdges(),v&&(this._oitEnabled?this._renderOIT(rc.Geometry,u):this._renderTransparentGeometry()),f.update(H=>this._renderNodes(Tt.TRANSPARENT,H,v)),this.fboCache.debugCallback?.(Tt.TRANSPARENT,f.color.fbo),this._renderGeometryDepth(y),this._renderHUDVisibility(),y||this._plugins.render(this._pluginInput,Y.LINE_CALLOUTS),this._renderEdges(Oo.TRANSPARENT);let R=this._hasTransparentTerrain?this._renderTransparentTerrain():null;R&&(this.performanceInfo.advance(Gt.TRANSPARENT_TERRAIN),this._bindParameters.hudVisibility&&(y?this._renderLineCallouts(vr.Occluded):(this._rctx.bindFramebuffer(this._bindParameters.hudVisibility?.fbo),this._compositingHelper.compositeHUD(this._bindParameters,R.getTexture())),this._renderHUD(vr.Occluded,f.color,u))),this._bindParameters.cullAboveTerrain=!1,R&&(f.bind(),this._compositingHelper.compositePreMultipliedAlpha(this._bindParameters,R.getTexture()),R.release(),y&&(this._renderEdges(Oo.OPAQUE),v&&(this._oitEnabled?this._renderOIT(rc.Geometry,u):this._renderTransparentGeometry(),this.performanceInfo.advance(Gt.TRANSPARENT)),this._renderEdges(Oo.TRANSPARENT))),this._bindParameters.ssao=ai(this._bindParameters.ssao),y&&this._renderLineCallouts(vr.NotOccluded),this._bindParameters.terrainDepthTest=!1,this._renderTransparentEnvironment(),this._pluginInput.set(le.FOCUSAREA,this._renderFocusAreaGeometry()),f.update(H=>this._renderNodes(le.TRANSPARENT_ENVIRONMENT,H)),f.update(H=>this._renderNodes(le.VIEWSHED,H)),f.update(H=>this._renderNodes(le.LASERLINES,H)),f.update(H=>this._renderNodes(le.OCCLUDED,H)),this._pluginInput.set("highlights",this._renderHighlightPrepass());let C=r===Vs.ObjectAndLayerID?this._renderObjectAndLayerIdColor():null;f.update(H=>this._renderNodes(Tt.COMPOSITE,H)),this._pluginInput.release(le.FOCUSAREA);let x=!(r!==Vs.Default||d||h&&!s),T=this._pluginInput.get(Tt.COMPOSITE),M=x?Va:this.fboCache.acquire(T.fbo.width,T.fbo.height,le.ANTIALIASING),E=this._nodes.produces(le.ANTIALIASING)?this._renderNodes(le.ANTIALIASING,M):this._blitFBO(T,M,!1),O;this._pluginInput.set(le.ANTIALIASING,E),this._hasHUDHighlights?(this._renderHUD(vr.NotOccluded,E,u),O=this._renderNodes(le.HIGHLIGHTS,E)):(O=this._renderNodes(le.HIGHLIGHTS,E),this._renderHUD(vr.NotOccluded,O,u));let Z=this._renderNodes(le.MAGNIFIER,O);return h&&!s&&r===Vs.Default&&!d&&this._blitFBO(Z),d?(Z.attachDepth(f.depth),this._blitFBO(this._renderNodes(Tt.FINAL,Z)),Z.detachDepth()):this._pluginInput.set(Tt.FINAL,Z),this._pluginInput.release("highlights"),this.onPostRender&&this.onPostRender(),this._releaseFBOs(),f.releaseDepth(),this._renderContext.lastFrameCamera.copyFrom(this._bindParameters.camera),this.fboCache.frameEnd(),this.performanceInfo.finishFrame(),r!==Vs.Default&&(this._releaseFBOs(),this._disposeOffscreenBuffers()),new yd(this._pluginInput.get(Tt.FINAL),C)}_precompileShaders(e,i,r){if(++this._plugins.context.techniques.precompiling,this._renderContext.output=r,this._precompileOpaqueGeometry(),this._nodes.precompile(le.OPAQUE_ENVIRONMENT),this._bindParameters.terrainDepthTest=e,this._bindParameters.cullAboveTerrain=e,this._renderContext.output=j.Depth,this._plugins.precompile(Y.TRANSPARENT_TERRAIN),e&&(this._precompileOpaqueGeometry(),this._precompileTransparentGeometry()),this._renderContext.output=r,this._plugins.precompile(Y.TRANSPARENT_TERRAIN),i&&(this._precompileTransparentGeometry(),this._hasTransparentTerrain&&(this._bindParameters.cullAboveTerrain=!1,this._precompileTransparentGeometry(),this._bindParameters.cullAboveTerrain=e)),this._nodes.precompile(le.FOCUSAREA),this._needsHUDVisibility&&this._plugins.precompile(Y.OCCLUSION_PIXELS),this._plugins.precompile(Y.LINE_CALLOUTS),this._precompileHUD(vr.Occluded),this._bindParameters.terrainDepthTest=!1,this._bindParameters.cullAboveTerrain=!1,this._nodes.precompile(le.VIEWSHED,le.LASERLINES,le.OCCLUDED,le.ANTIALIASING,le.HIGHLIGHTS),this._precompileHUD(vr.NotOccluded),this._hasHighlights){let s=this._bindParameters;s.highlights.forEach((a,n)=>{s.highlightLevel=n,this._precompileAllGeometry(j.Highlight)}),s.highlightLevel=null}this._nodes.precompile(Tt.COMPOSITE,le.MAGNIFIER),this._shadowAccumulator.precompile(),this._plugins.precompile(Y.TRANSPARENT_MATERIAL_WITHOUT_DEPTH),--this._plugins.context.techniques.precompiling}_updateHighlights(){let e=this._stage.view.state;this._renderers.forEach(i=>i.updateHighlights(e.highlightOrderMap))}_renderFocusAreaGeometry(){if(!this._nodes.produces(le.FOCUSAREA))return null;let{width:e,height:i}=this._framebufferSize,r=this.fboCache.acquire(e,i,le.FOCUSAREA);return r=this._nodes.render(r,this._pluginInput),this.performanceInfo.advance(Gt.FOCUS_AREA_MASK),r}_renderObjectAndLayerIdColor(){if(!this._nodes.produces("olid"))return null;let e=this._renderContext.output;++this._techniques.precompiling;let i=this._framebufferSize,r=this.fboCache.acquire(i.width,i.height,"olid");return r.acquireDepth(bi.DEPTH_STENCIL_TEXTURE),r=this._nodes.render(r,this._pluginInput),--this._techniques.precompiling,this.performanceInfo.advance(Gt.OBJECT_AND_LAYER_ID_COLOR),this._renderContext.output=e,r}finish(e){this._hasAnimations||this._animationTimestep.clear();let i=this.performanceInfo.gpuSamplingEnabled,r=e===oe.BACKGROUND;if(r||i){let s=r?this.performanceInfo.elapsedTime:0,a=0;i?a=this.performanceInfo.totalGPUTimeSampler.last:this._rctx.gl.finish();let n=Math.max(s,a);this._animationTimestep.frame(n,r)}}readMainDepth(e,i){let{mainDepth:r,camera:s}=this._bindParameters;if(!r)return;let a=this.fboCache.acquire(this._framebufferSize.width,this._framebufferSize.height,"linear-depth");this._rctx.bindFramebuffer(a.fbo),s.setGLViewport(this._rctx),this._rctx.setScissorRect(e[0],e[1],e[2],e[3]),this._rctx.setScissorTestEnabled(!0),this._rctx.clearFramebuffer(sr),this._compositingHelper.blitDepthToLinearDepth(this._bindParameters,r),this._rctx.setScissorTestEnabled(!1),this._rctx.setScissorRect(0,0,this._rctx.gl.canvas.width,this._rctx.gl.canvas.width),a.fbo?.readPixels(e[0],e[1],e[2],e[3],St.RGBA,sa.UNSIGNED_BYTE,i),a.release()}readHUDVisibility(e,i,r,s,a){this._bindParameters.hudVisibility?.fbo?.readPixels(e,i,r,s,St.RGBA,sa.UNSIGNED_BYTE,a)}readAccumulatedShadow(e){return this._shadowAccumulator.readAccumulatedShadow(e[0],e[1])}_renderEdges(e){let i=this._edgeView;if(!i?.shouldRender())return;let r=this._framebufferSize,s=this.fboCache.acquire(r.width,r.height,"edges"),a=()=>i.render(this._bindParameters,e),n=this._bindParameters.geometryDepth;this.renderToTargets(a,s,n??this._framebuffer.depth,sr),this._framebuffer.bind(),this._compositingHelper.composite(this._bindParameters,s.getTexture()),s.release(),this.performanceInfo.advance(e===Oo.OPAQUE?Gt.OPAQUE_EDGES:Gt.TRANSPARENT_EDGES)}_renderOverlay(e){this._bindParameters.overlay=this.overlay?.render(e),this._bindParameters.overlay&&this.performanceInfo.advance(Gt.OVERLAY)}_renderShadowMap(e,i,r){if(!this.shadowsEnabled)return;let s=this._shadowMap;s.start(e,i,r,this.isFeatureEnabled(fs.HighResolutionShadows),this._stage.view.qualitySettings.maximumPixelRatio),this._needsShadowHighlight?(this._renderShadowCascades(j.ShadowHighlight,this._shadowMap),s.moveSnapshot(Dg.Highlight),this._renderShadowCascades(j.ShadowExcludeHighlight,this._shadowMap),s.copySnapshot(Dg.ExcludeHighlight),this._renderShadowCascades(j.ShadowHighlight,this._shadowMap)):this._renderShadowCascades(j.Shadow),s.finish(),e.setGLViewport(this._rctx),this.performanceInfo.advance(Gt.SHADOW_MAP)}_precompileShadowCascades(e){for(let i of this._shadowMap.cascades)i.camera.setGLViewport(this._rctx),this._ensureBindParametersCamera(i.camera,i.camera),this._precompileAllGeometry(e)}_renderShadowCascades(e,i=this._shadowMap){for(let r of i.cascades)r.camera.setGLViewport(this._rctx),this._ensureBindParametersCamera(r.camera,r.camera),this.renderAllGeometry(e)}get _needsDepth(){return this._plugins.consumes(j.Depth)||this._nodes.requireGeometryDepth()||this.hasReflections||this._needsShadowHighlight||this._needsShadowAccumulation||this._debugNeedsDepth}_renderRemainingGeometryDepth(){let e=this._pluginInput.get("normals");if(e){let i=this._needsDepth?e.getAttachment(Cp):null;i?.retain(),this._pluginInput.set(le.SSAO,this._renderSSAO()),this._renderGeometryWithoutNormalsDepth(i)}else this._renderAllGeometryDepth()}_renderGeometryWithoutNormalsDepth(e){if(!this._needsDepth||!e)return void(this._bindParameters.depth=ai(this._bindParameters.depth));let i=this._framebufferSize,r=this.fboCache.acquire(i.width,i.height,"depth");r.attachDepth(e),e.release(),this._rctx.bindFramebuffer(r.fbo),this._rctx.clear(Lt.STENCIL),this._renderGeometryWithoutNormals(j.Depth),ai(this._bindParameters.depth),this._bindParameters.depth=r.obtainDepthTexture(),r.release(),this.performanceInfo.advance(Gt.DEPTH)}_renderAllGeometryDepth(){if(!this._needsDepth)return void(this._bindParameters.depth=ai(this._bindParameters.depth));let e=this._framebufferSize,i=this.fboCache.acquire(e.width,e.height,"depth").acquireDepth(bi.DEPTH_STENCIL_TEXTURE);this._rctx.bindFramebuffer(i.fbo),this._rctx.clear(Lt.DEPTH|Lt.STENCIL),this.renderAllGeometry(j.Depth),ai(this._bindParameters.depth),this._bindParameters.depth=i.obtainDepthTexture(),i.release(),this.performanceInfo.advance(Gt.DEPTH)}_renderTerrainDepth(e){if(this._bindParameters.terrainDepthTest=e,this._bindParameters.cullAboveTerrain=e,!e)return void(this._bindParameters.terrainDepth=ai(this._bindParameters.terrainDepth));let i=this._renderContext.output;this._renderContext.output=j.Depth;let r=this._framebufferSize,s=this.fboCache.acquire(r.width,r.height,"terrain depth").acquireDepth(bi.DEPTH_STENCIL_TEXTURE);this._rctx.bindFramebuffer(s.fbo),this._rctx.clear(Lt.DEPTH|Lt.STENCIL),this._renderTransparentTerrain(),ai(this._bindParameters.terrainDepth),this._bindParameters.terrainDepth=s.obtainDepthTexture(),this._renderContext.output=i,s.release()}_renderGeometryDepth(e){if(!e)return void(this._bindParameters.geometryDepth=ai(this._bindParameters.geometryDepth));let i=this._renderContext.output,{width:r,height:s}=this._framebufferSize,a=this.fboCache.acquire(r,s,"geometry depth").acquireDepth(bi.DEPTH_STENCIL_TEXTURE);this._rctx.bindFramebuffer(a.fbo),this._rctx.clear(Lt.DEPTH|Lt.STENCIL),this._renderOpaqueAndTransparentGeometry(j.Depth),this._renderContext.output=i,ai(this._bindParameters.geometryDepth),this._bindParameters.geometryDepth=a.obtainDepthTexture(),a.release()}get _needsDepthRange(){return this._shadowMap.enabled||this._needsShadowAccumulation}_computeDepthRange(e){if(!this._needsDepthRange)return qi.zero;let i=LP(e,this._plugins.plugins,this._stage.layers);return i.union(this._plugins.queryDepthRange(e)),i.near=Math.max(e.near,i.near),i.far=Math.min(e.far,i.far),i}get _normalsRequired(){let e=this._nodes.require("normals",Tt.FINAL,Tt.COMPOSITE,Tt.OPAQUE,Tt.TRANSPARENT,le.VIEWSHED,le.LASERLINES);return(this.hasSSAO?1:0)+e}_precompilePrepasses(){this._normalsRequired&&this._precompileAllGeometry(j.Normal),this._needsDepth&&this._precompileAllGeometry(j.Depth),this.shadowsEnabled&&(this._needsShadowHighlight?(this._precompileShadowCascades(j.ShadowHighlight),this._precompileShadowCascades(j.ShadowExcludeHighlight),this._precompileShadowCascades(j.ShadowHighlight)):this._precompileShadowCascades(j.Shadow)),this._needsShadowAccumulation&&this._precompileAllGeometry(j.Shadow)}_renderNormals(){let e=this._normalsRequired;if(e===0)return;let i=this._framebufferSize,r=this.fboCache.acquire(i.width,i.height,"normals",zt.RGBA);r.acquireDepth(bi.DEPTH_STENCIL_TEXTURE),this._rctx.bindFramebuffer(r.fbo),this._rctx.clearFramebuffer(sr,!0,!0),this._renderGeometryWithNormals(j.Normal);let s=this._nodes.optional("normals",Tt.FINAL,Tt.COMPOSITE,Tt.OPAQUE,Tt.TRANSPARENT,le.VIEWSHED);return r.retain(e+s-1),this.performanceInfo.advance(Gt.NORMALS),r}_renderSSAO(){let e=this._pluginInput.get("normals");if(!this.hasSSAO||!e)return void e?.detachDepth();Va.setName(le.SSAO);let i=this._nodes.render(Va,this._pluginInput);return this._bindParameters.ssao=i,e.detachDepth(),this._pluginInput.release("normals"),this.performanceInfo.advance(Gt.SSAO),i}_precompileAllGeometry(e){let i=this._renderContext.output;this._renderContext.output=e,this._precompileOpaqueGeometry(),this._precompileTransparentGeometry(),this._plugins.precompile(Y.TRANSPARENT_TERRAIN),this._renderContext.output=i}renderAllGeometry(e){this._renderContext.output=e,this._renderOpaqueAndTransparentGeometry(e),this._renderTransparentTerrain()}precompileSlots(e,...i){for(let r of i)this._bindParameters.slot=r,e.precompile(this._renderContext)}precompileOccludedSlots(e,i){for(let r of i)this._renderContext.renderOccludedMask=r,this.precompileSlots(e,...GP);this._renderContext.renderOccludedMask=Og}renderSlots(e,...i){for(let r of i)this._bindParameters.slot=r,e.forAll(s=>{let a=s.acquireTechniques(this._renderContext);a&&s.render(this._renderContext,a,this._pluginInput)})}renderOccludedSlots(e,i){this._renderContext.renderOccludedMask=i,this.plugins.renderOccludedFlags>fi.Occlude&&this._plugins.render(this._pluginInput,Y.OCCLUDED_TERRAIN),this.renderSlots(e,...GP),this._renderContext.renderOccludedMask=Og}renderHUD(e){this._bindParameters.hudRenderStyle=e,this._plugins.render(this._pluginInput,Y.HUD_MATERIAL)}precompileViewshedShadowMap(){this._precompileAllGeometry(j.ViewshedShadow)}renderViewshedShadowMap(e){let{camera:i,contentCamera:r}=this._bindParameters,s=this._renderContext.output;e.setGLViewport(this._rctx),this._ensureBindParametersCamera(e,e),this.renderAllGeometry(j.ViewshedShadow),this._ensureBindParametersCamera(i,r),this._bindParameters.camera.setGLViewport(this._rctx),this._renderContext.output=s}_renderOpaqueAndTransparentGeometry(e){this._renderContext.output=e,this._renderOpaqueGeometry(),this._renderTransparentGeometry()}_renderGeometryWithNormals(e){this._renderContext.output=e,this._plugins.render(this._pluginInput,...aD),this._renderTransparentTerrain()}_renderGeometryWithoutNormals(e){this._renderContext.output=e,this._plugins.render(this._pluginInput,...nD)}_precompileOpaqueGeometry(){this._plugins.precompile(...dv)}_renderOpaqueGeometry(){this._plugins.render(this._pluginInput,...dv)}_renderTransparentGeometry(){this._plugins.render(this._pluginInput,...Jd)}get _hasTransparentTerrain(){return this._plugins.produces(j.Color,Y.TRANSPARENT_TERRAIN)}_renderTransparentTerrain(){let e=()=>this._plugins.render(this._pluginInput,Y.TRANSPARENT_TERRAIN);if(!Gp(this._renderContext.output))return void e();let i=this._framebufferSize,r=this.fboCache.acquire(i.width,i.height,"transparent terrain");return this.renderToTargets(e,r,this._framebuffer.depth,sr),r}get _needsHUDVisibility(){return this._plugins.produces(this._renderContext.output,Y.OCCLUSION_PIXELS)}_renderHUDVisibility(){if(!this._needsHUDVisibility)return void(this._bindParameters.hudVisibility=ai(this._bindParameters.hudVisibility));let{width:e,height:i}=this._framebufferSize,r=this._bindParameters.hudVisibility;r?.fbo?.width===e&&r?.fbo?.height===i||(r?.release(),r=this.fboCache.acquire(e,i,"hud visibility",zt.RGBA4),this._bindParameters.hudVisibility=r);let s=this._bindParameters.geometryDepth;r.attachDepth(s||this._framebuffer.depth),this._rctx.bindFramebuffer(r.fbo),this._rctx.clearFramebuffer([0,1,0,1]),this._plugins.render(this._pluginInput,Y.OCCLUSION_PIXELS),r.detachDepth(),this._framebuffer.bind(),this.performanceInfo.advance(Gt.HUD_VISIBILITY)}_renderLineCallouts(e){if(this._bindParameters.hudRenderStyle=e,e===vr.Occluded){let i=()=>this._plugins.render(this._pluginInput,Y.LINE_CALLOUTS),r=this._framebufferSize,s=this.fboCache.acquireDepth(bi.DEPTH16_BUFFER,r.width,r.height,"line callouts");this.renderToTargets(i,this._framebuffer.color,s,void 0,!0,!0),s.release()}else this._plugins.render(this._pluginInput,Y.LINE_CALLOUTS)}_precompileHUD(e){if(this._precompileHUDOutput(e),this._hasHighlights){let i=this._renderContext.output;this._renderContext.output=j.Highlight,this._precompileHUDOutput(e),this._renderContext.output=i}}_precompileHUDOutput(e){let i=this._bindParameters.hudRenderStyle;this._bindParameters.hudRenderStyle=e,this._oitEnabled&&Gp(this._renderContext.output)?(this._bindParameters.oitPass=Qr.ColorAlpha,this._plugins.precompile(...ep),this._bindParameters.oitPass=Qr.FrontFace,this._plugins.precompile(...ep),this._bindParameters.oitPass=Qr.NONE):this._plugins.precompile(...ep),this._bindParameters.hudRenderStyle=i}_renderHUD(e,i,r){if(this._pluginsHas.hudElements){if(this._oitEnabled){let s=this._renderOIT(rc.HUD,r,e);this._rctx.bindFramebuffer(i.fbo),this._compositingHelper.compositePreMultipliedAlpha(this._bindParameters,s.getTexture()),s.release()}else if(this._renderContext.output=r,e===vr.Occluded){let s=()=>this._renderHUDElements(e),a=this._framebufferSize,n=this.fboCache.acquireDepth(bi.DEPTH16_BUFFER,a.width,a.height,"hud");this.renderToTargets(s,this._framebuffer.color,n,void 0,!0,!0),n.release()}else i.acquireDepth(bi.DEPTH16_BUFFER),this._rctx.bindFramebuffer(i.fbo),this._renderHUDElements(e),i.detachDepth();this.performanceInfo.advance(e===vr.Occluded?Gt.HUD_OCCLUDED:Gt.HUD)}}_renderHUDElements(e){this._bindParameters.hudRenderStyle=e,this._plugins.render(this._pluginInput,...ep)}get _needsShadowHighlight(){return this.shadowsEnabled&&this._plugins.produces(j.ShadowHighlight,Y.OPAQUE_MATERIAL)}_renderHighlightPrepass(){if(!this._hasHighlights)return;let{fboCache:e,_rctx:i,_bindParameters:r}=this,s=this._framebufferSize,a=e.acquire(s.width,s.height,"highlights",zt.RG);return a.acquireDepth(bi.DEPTH_STENCIL_TEXTURE),i.bindFramebuffer(a.fbo),i.clearFramebuffer(sr,!0),this._renderContext.output=j.Highlight,i.bindFramebuffer(a.fbo),Hb(i,e,s,r,()=>this._renderHighlightGeometries()),this.performanceInfo.advance(Gt.HIGHLIGHTS),a}_renderHighlightGeometries(){this._plugins.render(this._pluginInput,...oD),this._rctx.clear(Lt.DEPTH),this._renderHUDElements(vr.Both)}get _needsShadowAccumulation(){return this._shadowAccumulator.accumulating}_renderShadowAccumulation(e,i,r){this._needsShadowAccumulation&&this._bindParameters.depth&&this._shadowAccumulator.renderAccumulation(this._bindParameters.depth,e,i,r)&&this.performanceInfo.advance(Gt.ACCUMULATED_SHADOWS)}_precompileTransparentGeometry(){this._oitEnabled&&Gp(this._renderContext.output)?(this._bindParameters.oitPass=Qr.ColorAlpha,this._plugins.precompile(...Jd),this._bindParameters.oitPass=Qr.FrontFace,this._plugins.precompile(...Jd),this._bindParameters.oitPass=Qr.NONE):this._plugins.precompile(...Jd)}_renderOIT(e,i,r=vr.Both){let s=e===rc.HUD,a=this._framebufferSize,n=s?this.fboCache.acquire(a.width,a.height,"oit hud composite"):null,o=s?()=>this._renderHUDElements(r):()=>this._renderTransparentGeometry(),l=this._bindParameters,h=this._renderContext.output;this._renderContext.output=i,l.oitPass=Qr.ColorAlpha;let d=n?"oit hud color+alpha":"oit color+alpha",m=this.fboCache.acquire(a.width,a.height,d,zt.RGBA16F),u=i===j.ColorEmission;u&&m.acquireColor(Hi.COLOR_ATTACHMENT1,zt.RGBA16F,"emissive"),m.acquireColor(u?Hi.COLOR_ATTACHMENT2:Hi.COLOR_ATTACHMENT1,zt.R16F),n||m.attachDepth(this._framebuffer.depth),this._rctx.bindFramebuffer(m.fbo),this._rctx.clearFramebuffer([0,0,0,1]),u&&this._rctx.gl.clearBufferfv(this._rctx.gl.COLOR,1,Xp),o(),m.detachDepth(),l.oitPass=Qr.FrontFace;let f=this.fboCache.acquire(a.width,a.height,n?"oit hud front":"oit front");return u&&f.acquireColor(Hi.COLOR_ATTACHMENT1,zt.RGBA,"emissive"),n?f.acquireDepth(bi.DEPTH16_BUFFER):f.attachDepth(this._framebuffer.depth),this._rctx.bindFramebuffer(f.fbo),this._rctx.clearFramebuffer(sr,!!n),o(),f.detachDepth(),l.oitPass=Qr.NONE,n?(this._rctx.bindFramebuffer(n.fbo),this._rctx.setClearColor(0,0,0,1e-13),this._rctx.clear(Lt.COLOR)):this._framebuffer.bind(),this._oitblend??=new P_(this._techniques),this._oitblend.blend(this._rctx,m,f,l,u),n?.detachDepth(),f.release(),m.release(),this._renderContext.output=h,n}_renderTransparentEnvironment(){this._shadowAccumulator.render(this._bindParameters),this.performanceInfo.advance(Gt.APPLY_ACCUMULATED_SHADOWS),this._framebuffer.bind(),this._plugins.render(this._pluginInput,Y.TRANSPARENT_MATERIAL_WITHOUT_DEPTH),this.performanceInfo.advance(Gt.TRANSPARENT_MATERIAL_WITHOUT_DEPTH)}_renderPlugins(e,i){this._plugins.produces(this._renderContext.output,e)&&(this._plugins.render(this._pluginInput,e),this.performanceInfo.advance(i))}_renderNodes(e,i,r=!1){if(i.setName(e),this._pluginInput.set(e,i),!this._nodes.produces(e))return r&&this.performanceInfo.advance(e),i;let s=this._nodes.render(i,this._pluginInput,this._releaseNormals);return this.performanceInfo.advance(e),s}_blitFBO(e,i=Va,r=!0){return this._blit??=new cm(this._techniques),this._blit.blit(this._rctx,e,i,this._bindParameters),this._pluginInput.set(e.name,i),r&&e.release(),i}_ensureBindParametersCamera(e,i){this._bindParameters.camera=e,this._bindParameters.contentCamera=i}_ensureBindParametersSSR(e){if(this._bindParameters.ssr.lastFrameColor){this._ssrEnableTime==null&&(this._ssrEnableTime=e),this._renderContext.lastFrameCamera.equals(this._bindParameters.camera)?this._reprojectionMatrix=xn:(og(jP,this._bindParameters.camera.viewMatrix),og(zP,this._bindParameters.camera.projectionMatrix),ns(ic,jP,zP),ns(ic,this._renderContext.lastFrameCamera.viewMatrix,ic),ns(ic,this._renderContext.lastFrameCamera.projectionMatrix,ic),this._reprojectionMatrix=ic);let i=this._stage.view.qualitySettings.fadeDuration;this._bindParameters.ssr.fadeFactor=i>0?Math.min(i,e-this._ssrEnableTime)/i:1,this._bindParameters.ssr.fadeFactor<1&&this._requestRender()}else this._reprojectionMatrix=xn,this._ssrEnableTime=null}addRenderNode(e){this._nodes.add(e),this._requestRender()}removeRenderNode(e){this._nodes.remove(e),this._requestRender()}updateLighting(e,i,r,s){this._bindParameters.updateLighting(e,i,r,s),this._requestRender(oe.UPDATE)}get usedMemory(){return{fbos:this.fboCache.usedMemory,plugins:this._plugins.usedMemory,edges:this.edgeView?.usedMemory??0}}renderToTargets(e,i,r,s,a=!1,n=!1){i.attachDepth(r),this._rctx.bindFramebuffer(i.fbo),this._rctx.clearFramebuffer(s,a,n),e(),i.detachDepth()}get test(){}},rc;c([p({readOnly:!0})],pl.prototype,"fullResolutionAtmosphere",null),c([p()],pl.prototype,"_edgeView",void 0),c([p()],pl.prototype,"updating",null),function(t){t[t.Geometry=0]="Geometry",t[t.HUD=1]="HUD"}(rc||(rc={}));var aD=[Y.INTEGRATED_MESH,Y.OPAQUE_TERRAIN,Y.OPAQUE_MATERIAL,Y.TRANSPARENT_MATERIAL],nD=[Y.OPAQUE_MATERIAL_WITHOUT_NORMALS,Y.TRANSPARENT_MATERIAL_WITHOUT_NORMALS],dv=[Y.INTEGRATED_MESH,Y.OPAQUE_TERRAIN,Y.OPAQUE_MATERIAL,Y.OPAQUE_MATERIAL_WITHOUT_NORMALS],Jd=[Y.TRANSPARENT_MATERIAL,Y.TRANSPARENT_MATERIAL_WITHOUT_NORMALS],GP=[Y.OPAQUE_MATERIAL,Y.TRANSPARENT_MATERIAL,Y.TRANSPARENT_MATERIAL_WITHOUT_DEPTH],ep=[Y.LINE_CALLOUTS_HUD_DEPTH,Y.HUD_MATERIAL,Y.LABEL_MATERIAL],oD=[Y.TRANSPARENT_MATERIAL,Y.TRANSPARENT_MATERIAL_WITHOUT_NORMALS,Y.OPAQUE_MATERIAL,Y.OPAQUE_MATERIAL_WITHOUT_NORMALS,Y.TRANSPARENT_TERRAIN,Y.INTEGRATED_MESH,Y.OPAQUE_TERRAIN],zP=Rt(),jP=Rt(),ic=Rt();function lD(t){return e=>t.immediate.schedule(e)}var N_=class{constructor(e){this._rctx=e,this._vao=hD(e)}destroy(){this._vao=ge(this._vao)}draw(){this._vao!=null&&(this._rctx.bindVAO(this._vao),this._rctx.drawArrays(ft.TRIANGLES,0,3))}get test(){}};function hD(t,e=Vb,i=aa){let r=new Float32Array([-1,-1,3,-1,-1,3]);return new Lr(t,i,new Map([["geometry",e]]),new Map([["geometry",wi.createVertex(t,Qi.STATIC_DRAW,r)]]))}var F_=class{constructor(e,i,r){this._rctx=e,this._locations=i,this._layout=r,this._cache=new xs(e.newCache,"VAOCache")}dispose(){this._cache.destroy()}newVao(e){let i=e.toString(),r=this._cache.pop(i);return r||(r=new Lr(this._rctx,this._locations,new Map([["geometry",this._layout]]),new Map([["geometry",wi.createVertex(this._rctx,Qi.STATIC_DRAW)]])),r.vertexBuffers.get("geometry")?.setSize(e),r)}deleteVao(e){if(e==null)return;let i=e.byteSize.toString();this._cache.put(i,e)}};var tp=class extends CT{constructor(e,i){super(e,i),this._vaoCaches=new Ec,this._appleAmdDriverHelper=null,this._refCount=1,this._newCache=i.newCache,this.screen=new N_(this)}configure(e){super.configure(e),this._newCache=e.newCache}destroy(){this._vaoCaches?.forAll(e=>e.dispose()),this._vaoCaches?.clear(),--this._refCount>0||this.dispose()}ref(){++this._refCount}dispose(){super.dispose(),this._appleAmdDriverHelper?.dispose(),this.screen.destroy(),this._vaoCaches.forAll(e=>e.dispose()),this._vaoCaches.clear()}get newCache(){return this._newCache}getVaoCache(e,i){let r=Array.from(e).join("."),s=JSON.stringify(i),a=this._vaoCaches.get(r,s);if(a)return a;let n=new F_(this,e,i);return this._vaoCaches.set(r,s,n),n}bindTechnique(e,i,r,s){return this.useProgram(e.program),this.setPipelineState(e.getPipeline()),e.program.bind(i),r&&(e.program.bindPass(r,i),s&&e.program.bindDraw(i,r,s)),e.program}runAppleAmdDriverHelper(){this.driverTest.drawArraysRequiresIndicesTypeReset.result&&(this._appleAmdDriverHelper??=new TT(this),this._appleAmdDriverHelper.run())}get test(){}};function pv(t){return!!t.frameUpdate}var ml=class extends te{constructor(t){super({}),this._stage=t,this._textures=new Map,this._loadingCount=0,this._frameUpdates=new Map,this.events=new tr,this._frameTask=t.view.resourceController.scheduler.registerTask(ut.TEXTURE_UNLOAD)}normalizeCtorArgs(){return{}}destroy(){this._frameTask.remove(),this._stage.forEachOfType(Wp.Texture,t=>t.unload())}get updating(){return this._loadingCount>0||this._frameTask.updating}acquire(t){let e=this._textures.get(t);return e?(e.ref(),e.loadingPromise??e):this._createNewRef(t)}update(){let t=!1;this._frameUpdates.forEach(e=>{let i=e.texture.frameUpdate(e.previousToken);i>=0&&i!==e.previousToken&&(e.previousToken=i,t=!0)}),t&&this.events.emit("changed",oe.BACKGROUND)}_createNewRef(t){let e=this._stage.getObject(t);if(e==null)return null;let i=e.events.on("unloaded",()=>{i.remove(),this._onTextureUnloaded(t)}),r=new mv(t,()=>{this._frameTask.schedule(()=>{r.isUnreferenced&&e.unload()})});return this._textures.set(t,r),r.ref(),e.glTexture?(this._updateGLTexture(r,e.glTexture),pv(e)&&this._frameUpdates.set(t,{texture:e,previousToken:-1}),r):(this._loadingCount++,r.loadingPromise=this._stage.schedule(()=>{let s=e.load(this._stage.renderView.renderingContext),a=o=>(this._loadingCount--,r.loadingPromise=null,this._updateGLTexture(r,o),pv(e)&&this._frameUpdates.set(t,{texture:e,previousToken:-1}),r),n=o=>(this._loadingCount--,r.loadingPromise=null,ss(o)||pe.getLogger(this).error(o),null);return Cl(s)?s.then(a,n):a(s)}),r.loadingPromise)}_updateGLTexture(t,e){t.glTexture=e,this.events.emit("changed",oe.UPDATE)}_onTextureUnloaded(t){this._textures.delete(t),this._frameUpdates.delete(t)}};c([p()],ml.prototype,"_loadingCount",void 0),c([p()],ml.prototype,"_frameTask",void 0),c([p()],ml.prototype,"updating",null),ml=c([S("esri.views.3d.webgl-engine.lib.TextureRepository")],ml);var mv=class{constructor(e,i){this.id=e,this._release=i,this._refCount=0}get isUnreferenced(){return this._refCount===0}ref(){++this._refCount}release(){--this._refCount,this._refCount>0||(this._refCount!==0?(pe.getLogger("esri.views.3d.webgl-engine.lib.TextureRepository.RefCountedTextureImpl").error("Cannot dereference texture that has no references!"),this._refCount=0):this._release())}};function WP(t,e){return new Tb(i=>xb(i,t),i=>i,e)}var sc=class extends te{constructor(){super(...arguments),this._passParameters=new uv,this._resourcesTask=null}get passParameters(){return this._passParameters}destroy(){this._resourcesTask=Ar(this._resourcesTask),this._passParameters.waveNormal=ge(this._passParameters.waveNormal),this._passParameters.wavePerturbation=ge(this._passParameters.wavePerturbation)}get updating(){return!!this._resourcesTask&&!this._resourcesTask.finished}ensureResources(t){return this._resourcesTask||(this._resourcesTask=Js(e=>Re(this,null,function*(){yield Promise.allSettled([this._loadImageResource(t,X_("esri/images/materials/water/normals.jpg"),i=>this._passParameters.waveNormal=i,e),this._loadImageResource(t,X_("esri/images/materials/water/perturbation.jpg"),i=>this._passParameters.wavePerturbation=i,e)])}))),this._resourcesTask.finished?gg.LOADED:gg.LOADING}_loadImageResource(t,e,i,r){return Re(this,null,function*(){try{let s=yield In(e,{signal:r});Vi(r);let a=new Ot(s.width,s.height);a.pixelFormat=St.RGB,a.samplingMode=yr.LINEAR_MIPMAP_LINEAR,a.hasMipmap=!0,a.maxAnisotropy=8,i(new Ft(t,a,s))}catch(s){pe.getLogger(this).error("Failed to load water material normal texture.",s)}})}};c([p()],sc.prototype,"_resourcesTask",void 0),c([p({type:Boolean,readOnly:!0})],sc.prototype,"updating",null),sc=c([S("esri.views.3d.webgl-engine.materials.internal.WaterTextureRepository")],sc);var uv=class extends Dn{};var cD=new Map;function V_(){return cD}var U_=class{constructor(e,i){this.parameters=e,this.fbos=i}},H_=class{constructor(e,i,r){this._rctx=e,this._renderFunctions=i,this._forceCameraHook=r,this.supersample=!0,this._screenshotQueue=new Array}destroy(){this._rctx=null}takeScreenshot(e){return Re(this,null,function*(){yield this._renderFunctions.prepareOverlay(),this._renderFunctions.requestRenderScene(oe.BACKGROUND);let i=xl();return this._screenshotQueue.push({settings:e,resolver:i}),i.promise})}update(e,i){for(let r of this._screenshotQueue){if(this._rctx==null){r.resolver.reject();continue}let s=Bt(lt({},r.settings),{pixelRatio:r.settings.pixelRatio*e.parameters.camera.pixelRatio}),a=this._renderScreenshot(e,s,i);r.resolver(a)}this._screenshotQueue.length=0}_renderScreenshotOverlay(e,i,r){e.width=i.width,e.height=i.height;let s=e.getContext("2d"),a=r.pixelRatio;return s.save(),s.translate(0,i.height),s.scale(1,-1),r.region&&s.translate(-r.region.x,-r.region.y),s.scale(a,a),i=this._renderFunctions.renderOverlay(e,r.disableDecorations,i),s.restore(),i}_readbackScreenshot(e,i){return e.resample?this._readbackScreenshotResampled(Bt(lt({},e),{resample:e.resample}),i):this._readbackScreenshotImmediate(e,i)}_readbackScreenshotResampled(e,i){let{framebufferWidth:r,framebufferHeight:s,region:a,resample:n}=e,o=this._ensureScreenshotEncodeCanvas(),l=Ip(r,s,o);this._rctx.gl.readPixels(0,0,r,s,St.RGBA,Mo.UNSIGNED_BYTE,new Uint8Array(l.data.buffer)),i(),l=this._renderScreenshotOverlay(o,l,Bt(lt({},e),{region:void 0}));let h=Ip(a.width,a.height,o);return xT(l,h,!0,n.region.x,s-(n.region.y+n.region.height),n.region.width,n.region.height)}_readbackScreenshotImmediate(e,i){let{framebufferHeight:r,region:s}=e,a=this._ensureScreenshotEncodeCanvas(),n=Ip(s.width,s.height,a);return this._rctx.gl.readPixels(s.x,r-(s.y+s.height),s.width,s.height,St.RGBA,Mo.UNSIGNED_BYTE,new Uint8Array(n.data.buffer)),i(),this._renderScreenshotOverlay(a,n,e)}_renderScreenshot(e,i,r){let s=e.parameters.camera,a={width:i.framebufferWidth,height:i.framebufferHeight};Yl(a,Math.min(this._rctx.parameters.maxTextureSize,this._rctx.parameters.maxRenderbufferSize));let n=!1,o=a.width!==s.fullWidth||a.height!==s.fullHeight,l=i.ignorePadding&&s.pixelRatio!==i.pixelRatio,h=o||i.disableDecorations||l||i.objectAndLayerIdColor,d=null,m=null;if(h){let y=s.clone();if(i.ignorePadding){let C=S1(y.padding);for(let x=0;x<4;x++)C[x]=Math.round(C[x]/y.pixelRatio*i.pixelRatio);y.padding=C}y.fullWidth=a.width,y.fullHeight=a.height,y.pixelRatio=i.pixelRatio;let v=s.fovX-y.fovX,w=s.fovY-y.fovY;v<0&&v<w?y.fovX=s.fovX:w<0&&w<v&&(y.fovY=s.fovY);let b={camera:y,contentCamera:y,mode:Zt.IDLE,alignPixelEnabled:!0,contentPixelRatio:y.pixelRatio,forcedAnimationTime:e.parameters.forcedAnimationTime};this._forceCameraHook(b),n=!0;let R=this._renderFunctions.renderScene(b,r,i.objectAndLayerIdColor?Vs.ObjectAndLayerID:Vs.Screenshot,i.disableDecorations);m=R.screen,d=R.olid}let u=()=>{this._rctx.bindFramebuffer(null),m?.release()};this._rctx.bindFramebuffer(m?.fbo);let f=this._readbackScreenshot(i,u),g=null;if(i.objectAndLayerIdColor){let y=()=>{this._rctx.bindFramebuffer(null),d?.release()};this._rctx.bindFramebuffer(d?.fbo),g=this._readbackScreenshot(i,y),this._rctx.bindFramebuffer(null)}if(h&&!this._rctx.contextAttributes.alpha)for(let y=3;y<f.data.length;y+=4)f.data[y]=255;if(g&&!this._rctx.contextAttributes.alpha)for(let y=3;y<g.data.length;y+=4)g.data[y]=255;return n&&this._forceCameraHook(e.parameters),[f,g]}_ensureScreenshotEncodeCanvas(){return this._screenshotEncodeCanvas??=document.createElement("canvas"),this._screenshotEncodeCanvas}};var QP={enabled:!1,disposeContextCache:()=>{let t=V_();t.forEach(e=>e.dispose()),t.clear()}};var Ni=class extends te{constructor(t){super(t),this.events=new tr,this.waterTextures=new sc,this.olidRenderHelper=On()?new d_:null,this._needsUpdate=!0,this._needsRender=!0,this._idleSuspend=!0,this._needsWaterReflectionUpdate=!1,this._lastAnimationUpdate=0,this._savedFadeDuration=0;let e=t.stage;try{this._initializeContext(e)}catch(s){return void console.error("Failed to initialize context",s)}let{memoryController:i}=e.view.resourceController;this.stippleTextures=Cb(this._rctx,i),this.markerTextures=WP(this._rctx,i),this._techniques=new Zb(new r_(this._rctx,e.viewingMode,this.stippleTextures,this.waterTextures,this.markerTextures)),this._textures=new ml(e),this.addHandles(this._textures.events.on("changed",s=>this.requestRender(s))),this._materials=new qb(this._textures,this._techniques,()=>this.requestRender(),()=>this.requestRender()),this._compositingHelper=new c_(this._rctx,this._techniques),this.renderer=new pl(e,this._materials,this._techniques,this._rctx,this._compositingHelper,s=>this.requestRender(s)),this.addHandles([P(()=>e.view.ready,s=>{s&&this._createRenderNodes()},Ie),P(()=>this.waterTextures?.updating,()=>this.requestRender(),Ie),P(()=>e.view.qualityProfile,s=>this.renderer?.updateRenderFeatures(s),ye)]);let r={renderScene:(s,a,n,o)=>this.renderer.render(s,a,n,o),requestRenderScene:s=>this.requestRender(s),prepareOverlay:()=>e.options.screenshot.prepareOverlay(),renderOverlay:(s,a,n)=>e.options.screenshot.renderOverlay(s,a,n)};this._screenshotManager=new H_(this._rctx,r,s=>this.events.emit("force-camera-for-screenshot",s)),this._registerFrameTask(e)}destroy(){let t=this.stage?.container;t?.contains(this._canvas)&&t.removeChild(this._canvas),this._frameTask=Pi(this._frameTask),this._techniques=G(this._techniques),this._componentObjects=G(this._componentObjects),this._screenshotManager=G(this._screenshotManager),G(this.renderer),this._textures=G(this._textures),G(this.waterTextures),G(this.markerTextures),G(this.stippleTextures),this._canvas=null,this._rctx=G(this._rctx)}_createRenderNodes(){let{view:t,viewingMode:e}=this.stage;new h_({view:t}),up(t.spatialReference)||(e===me.Local?new qf({view:t}):mp(t.spatialReference)?new rP({view:t}):(new Vf({view:t}),new Uf({view:t}),new a_({view:t}),new Hf({view:t}))),new Gw({view:t,isEnabled:()=>this.renderer.hasSSAO}),new yo({view:t,isEnabled:()=>this.renderer.hasSMAA}),new go({view:t}),new Ub({view:t}),new dl({view:t,viewingMode:e}),new Qh({view:t}),On()&&new Wh({view:t})}requestRender(t=oe.UPDATE){this._needsRender=!0,t===oe.UPDATE&&(this._needsUpdate=!0)}get updating(){return this._needsUpdate||this._needsWaterReflectionUpdate||this.renderer.updating||this._textures.updating||this.waterTextures.updating}get textures(){return this._textures}get techniques(){return this._techniques}get compositingHelper(){return this._compositingHelper}setIdleSuspend(t){this._idleSuspend!==t&&(this._idleSuspend=t,this.requestRender())}get renderingContext(){return this._rctx}get capabilities(){return this._rctx.capabilities}get canvas(){return this._canvas}takeScreenshot(t){return this._screenshotManager.takeScreenshot(t).then(e=>e[0])}takeScreenshotWithOID(t){return t.objectAndLayerIdColor=!0,this._screenshotManager.takeScreenshot(t)}getAlpha(){return!!this._rctx.contextAttributes.alpha}getMinimalDepthForArea(t,e,i,r,s,a=s){let n=r.constrainWindowSize(e,i,s*r.pixelRatio,a*r.pixelRatio),o=this._ensureLinearDepthArrayBuffer(n);this.renderer.readMainDepth(n,o);let l=(d,m,u)=>Y1(m,d)*(u[1]-u[0])+u[0],h=Number.MAX_VALUE;for(let d=0;d<n[2]*n[3];d++){let m=l(4*d,o,r.nearFar);h>m&&m!==r.nearFar[0]&&m!==r.nearFar[1]&&(h=m)}if(t){let d=t.pickDepth(e*r.pixelRatio,i*r.pixelRatio,r);d!=null&&h>d&&d!==r.nearFar[0]&&d!==r.nearFar[1]&&(h=d)}return h===Number.MAX_VALUE?void 0:h}_ensureLinearDepthArrayBuffer(t){let e=4*t[2]*t[3];return(this._tmpDepthBuffer==null||this._tmpDepthBuffer.byteLength<e)&&(this._tmpDepthBuffer=new Uint8Array(e)),this._tmpDepthBuffer}reloadShaders(){return Re(this,null,function*(){af(),yield this._techniques.reloadAll(),this.renderer.overlay?.reloadShaders(),this.requestRender()})}_registerFrameTask(t){let e=t.view.state,i=!1,r=oe.BACKGROUND,s=!1,a={preRender:({time:n})=>{i=this.updating,r=this._needsUpdate?oe.UPDATE:oe.BACKGROUND,t.commitSyncLayers(),n=this._testTime??n,(n-this._lastAnimationUpdate>this.renderer.animationTimestep||e.forcedAnimationTime!=null||i||this._needsRender)&&(this.renderer.updateAnimation(e,n)&&this.requestRender(oe.BACKGROUND),this._lastAnimationUpdate=n)},render:({time:n})=>{if((this._needsRender||!this._idleSuspend||!this.renderer.isCameraFinal||this._needsWaterReflectionUpdate)&&e.camera.fullWidth>0&&e.camera.fullHeight>0){let o=this._needsUpdate&&this._idleSuspend&&this.renderer.isCameraFinal;this._needsRender=!1,this._needsUpdate=!1,this._needsWaterReflectionUpdate=!1,n=this._testTime??n,this.renderer.render(e,n),s=!0,o&&this.renderer.hasReflections&&(this.requestRender(oe.BACKGROUND),this._needsWaterReflectionUpdate=!0)}},update:({time:n})=>{this._textures.update();let o=new U_(e,this.renderer.fboCache);n=this._testTime??n,this._screenshotManager.update(o,n)},finish:()=>{s&&(this.renderer.finish(e.mode===Zt.IDLE?r:oe.UPDATE),s=!1)}};this._frameTask=Sl(a)}_initializeContext(t){let{options:e}=t,i=e.canvas??document.createElement("canvas");i.setAttribute("style","width: 100%; height:100%; display:block;"),this._canvas=i;let r={alpha:e.alpha||!1,premultipliedAlpha:!0,antialias:!1,depth:!0,stencil:e.stencil??!0,powerPreference:"high-performance",preserveDrawingBuffer:e.preserveDrawingBuffer??!1},s=i.getContext("webgl2",r);if(s==null)return void pe.getLogger(this).error("A WebGL2 context could not be created.");this._rctx=dD(s,t),this._loadShaderOnlyExtensions(),!e.alpha&&this._rctx.contextAttributes.alpha&&pe.getLogger(this).error("WebGL context has alpha channel even though no alpha channel was requested");let{container:a}=t;!this._rctx.contextAttributes.alpha&&Yt("safari")>=11&&(a.style.backgroundColor="black"),a.contains(i)||a.appendChild(i)}_loadShaderOnlyExtensions(){this._rctx.capabilities.enable("textureFloatLinear")}get _viewingMode(){return this.stage.viewingMode}getObjectAndLayerIdColor(t){return this.olidRenderHelper?.getObjectAndLayerIdColor(t)}get componentObjectCollection(){return this._componentObjects==null&&(this._componentObjects=new i_(this.renderer.renderPassManager,this._viewingMode)),this._componentObjects}set componentObjectCollection(t){this._componentObjects=t}updateQualitySettings(t){this._testTime!=null&&(this._savedFadeDuration=t.fadeDuration,t.fadeDuration=0)}set testTime(t){this._testTime=t,t==null?this.stage.view.qualitySettings.fadeDuration=this._savedFadeDuration:this.updateQualitySettings(this.stage.view.qualitySettings)}get testTime(){return this._testTime}};function dD(t,e){let i=(s,a)=>e.view.resourceController.memoryController.newCache(s,a),r={disabledExtensions:e.options.deactivatedWebGLExtensions||{},debugWebGLExtensions:e.options.debugWebGLExtensions||{},maxAnisotropy:8,newCache:i};if(QP.enabled){let s=$P.get(t);return s?(s.configure(r),s.ref(),s):(s=new tp(t,r),$P.set(t,s),s.ref(),s)}return new tp(t,r)}c([p({type:Boolean,readOnly:!0})],Ni.prototype,"updating",null),c([p({constructOnly:!0})],Ni.prototype,"stage",void 0),c([p()],Ni.prototype,"_rctx",void 0),c([p()],Ni.prototype,"_canvas",void 0),c([p()],Ni.prototype,"stippleTextures",void 0),c([p()],Ni.prototype,"markerTextures",void 0),c([p()],Ni.prototype,"waterTextures",void 0),c([p({readOnly:!0})],Ni.prototype,"olidRenderHelper",void 0),c([p()],Ni.prototype,"_textures",void 0),c([p({readOnly:!0})],Ni.prototype,"renderer",void 0),c([p()],Ni.prototype,"_screenshotManager",void 0),c([p()],Ni.prototype,"componentObjectCollection",null),c([p()],Ni.prototype,"_componentObjects",void 0),c([p()],Ni.prototype,"_needsUpdate",void 0),c([p()],Ni.prototype,"_needsWaterReflectionUpdate",void 0),Ni=c([S("esri.views.3d.webgl-engine.parts.RenderView")],Ni);var $P=V_();var ts=class extends te{constructor(t){super(t),this._model=new Od,this._layers=new Xe,this._asyncChangeSet=new wg,this._syncChangeSet=new wg,this._layerSyncSet=new Set}initialize(){this._set("renderView",new Ni({stage:this})),this._frameTask=this.view.resourceController.scheduler.registerTask(ut.STAGE,this),this.addHandles(this._frameTask)}destroy(){this.renderView.destroy()}get viewingMode(){return this.view.state.viewingMode}get updating(){return this.running||this.renderView.updating||this._frameTask.updating}get renderer(){return this.renderView?.renderer}add(t){this._model.add(t),Kl(t)&&this._addLayer(t),this.renderView.requestRender()}remove(t){t!=null&&!this.destroyed&&this._model.remove(t)&&(Kl(t)&&this._removeLayer(t),this.renderView.requestRender())}addMany(t){t!=null&&(this._model.addMany(t),this.renderView.requestRender())}removeMany(t){t!=null&&(this._model?.removeMany(t),this.renderView?.requestRender())}forEachOfType(t,e){this._model.forEachOfType(t,e)}handleEvent(t,e){this.destroyed||(this._model.dirtySet[t](e),this.renderView.requestRender())}get running(){return this._model.dirtySet.dirty||!this._asyncChangeSet.empty}runTask(t){if(this._frameTask.processQueue(t),this._commit(t),!t.hasProgressed)return Xt}_commit(t){let e=this._model.dirtySet;this._asyncChangeSet.empty||t.done||(this.renderer.modify(this._asyncChangeSet,t),this.renderView.requestRender(),t.madeProgress()),this._layers.forAll(i=>{if(t.done)return;let r=this._layerSyncSet.has(i.id)||i.updatePolicy===em.SYNC,s=r?this._syncChangeSet:this._asyncChangeSet;e.commitLayer(i.id,s),this._layerSyncSet.delete(i.id),s.empty||(this.renderer.modify(s,r?Dr:t),this.renderView.requestRender(),t.madeProgress())}),this._syncChangeSet.empty||(this.renderer.modify(this._syncChangeSet,Dr),this.renderView.requestRender(),t.madeProgress()),this._layers.forAll(i=>{t.done||this._layerSyncSet.has(i.id)||i.updatePolicy!==em.ASYNC||(e.commitLayer(i.id,this._asyncChangeSet),this._asyncChangeSet.empty||(this.renderer.modify(this._asyncChangeSet,t),this.renderView.requestRender(),t.madeProgress()))}),this._layerSyncSet.clear(),this.notifyChange("running")}commitSyncLayers(){let t=this._model.dirtySet;this._layers.forAll(e=>{this._layerSyncSet.has(e.id)||e.updatePolicy===em.SYNC?(t.commitLayer(e.id,this._syncChangeSet),this._layerSyncSet.delete(e.id)):t.commitSyncUpdates(e.id,this._syncChangeSet)});for(let e of this._layerSyncSet)t.commitLayer(e,this._syncChangeSet);this._layerSyncSet.clear(),this._syncChangeSet.empty||(this.renderer.modify(this._syncChangeSet,Dr),this.renderView.requestRender())}_commitLayer(t){this._model.dirtySet.commitLayer(t.id,this._syncChangeSet),this._layerSyncSet.delete(t.id),this._syncChangeSet.empty||(this.renderer.modify(this._syncChangeSet,Dr),this.renderView.requestRender())}schedule(t,e){return this._frameTask.schedule(t,e)}reschedule(t,e){return this._frameTask.reschedule(t,e)}syncLayer(t){this._layerSyncSet.add(t),this.renderView.requestRender()}getObject(t){return this._model.getObject(t)}get layers(){return this._layers}_addLayer(t){this._layers.includes(t)||this._layers.push(t)}_removeLayer(t){this._commitLayer(t),this._layers.removeUnordered(t)!=null&&(this._model.dirtySet.getResidentRenderGeometries(t.id,this._syncChangeSet.removes),this.renderer.modify(this._syncChangeSet,Dr))}addRenderPlugin(t,e){let i=this.renderer.plugins.add(t,e),r=()=>{Xy(t)&&this.view.sceneIntersectionHelper.addIntersectionHandler(t)};if(Cl(i))return i.then(r);r()}removeRenderPlugin(t){this.destroyed||(Xy(t)&&this.view.sceneIntersectionHelper.removeIntersectionHandler(t),this.renderer.plugins.remove(t))}get performanceInfo(){return this._model.getStats()}get test(){}};c([p({constructOnly:!0})],ts.prototype,"view",void 0),c([p({constructOnly:!0})],ts.prototype,"options",void 0),c([p({readOnly:!0})],ts.prototype,"viewingMode",null),c([p({constructOnly:!0})],ts.prototype,"container",void 0),c([p({readOnly:!0})],ts.prototype,"updating",null),c([p({constructOnly:!0})],ts.prototype,"_model",void 0),c([p()],ts.prototype,"renderView",void 0),c([p({readOnly:!0})],ts.prototype,"renderer",null),c([p({readOnly:!0})],ts.prototype,"running",null),ts=c([S("esri.views.3d.webgl-engine.Stage")],ts);var q_=new Set,ZP=()=>pe.getLogger("esri/views/support/TextureCompressionHelper");function YP(t,e){return Ft.compressionWorkerHandle??=new Af(qT(e)),q_.has(t)?ZP().warn("Repeated texture compression worker initialization by the same view."):q_.add(t),Ft.compressionWorkerHandle}function KP(t){Ft.compressionWorkerHandle&&(q_.delete(t)||ZP().warn("Unknown view attempted to destroy the texture compression worker."),q_.size||(G(Ft.compressionWorkerHandle),Ft.compressionWorkerHandle=null))}var B_=class extends wm{constructor(t){super(t),this.components=["attribution","zoom","navigation-toggle","compass"]}};c([p()],B_.prototype,"components",void 0),B_=c([S("esri.views.ui.3d.DefaultUI3D")],B_);var fv=B_;var ie=class extends sT(nT(aT(oT))){constructor(t){super(t),this._userClippingArea=null,this._clippingArea=null,this._initialDefaultSpatialReference=null,this._overrideDefaultEnvironmentOnly=!0,this._createGraphicsViewController=null,this._resolveWhenReady=[],this._propertiesPool=new wr({slicePlane:Iw},this),this._resourceController=qS(this),this._defaultToMapOptions={include:new Set},this._defaultHitTestOptions={exclude:new Set},this.deconflictor=new Uu({view:this}),this.labeler=new aC({view:this,deconflictor:this.deconflictor.labels}),this.sharedSymbolResources=null,this.analyses=new Hg,this.basemapTerrain=null,this.elevationProvider=null,this.canvas=null,this.constraints=new Wn,this.environment=new zo,this.environmentManager=new $r,this.floors=new Ba,this.fullOpacity=1,this.graphicsView=null,this.analysisViewManager=new Tx({view:this}),this.groundView=null,this.map=null,this.screenSizePerspectiveEnabled=!0,this.state=new FS({view:this}),this.spatialReference=null,this.alphaCompositingEnabled=!1,this.preserveDrawingBufferEnabled=!1,this.supersampleScreenshotsEnabled=!0,this.type="3d",this.ui=new fv,this._numUpdating=0,this._lastUpdateTime=0,this.updatingProgress=.5,this.focusAreas=new AT({view:this}),db();let e=(i=null)=>{i!=null&&i.type===J_.MOVE||(this._updatingChanged(),this.map&&this.map.allLayers.forEach(r=>Re(this,null,function*(){try{yield r.when()}catch{}this._updatingChanged()})))};this.addHandles([Er(()=>this.map?.allLayers,"after-changes",i=>e(i),{onListenerAdd:()=>e(),onListenerRemove:()=>e(),sync:!0}),this.allLayerViews.on("after-changes",i=>this._updateUpdatingMonitors(i)),P(()=>this.map,i=>{i&&"load"in i&&i.load&&i.load().catch(()=>{})})]),this.inputManager=new cS({view:this}),this.stateManager=new jt({view:this})}initialize(){if(Yt("enable-feature:esri-compress-textures")){let e=YP(this,this.resourceController);this.addResolvingPromise(e.promise)}this.groundView=new rT({view:this}),this._updateUpdatingMonitors();let t=()=>this._updateDefaultToMapOptions();this.addHandles(Er(()=>this.map?.allLayers,"after-changes",t,{onListenerAdd:t,onListenerRemove:t})),this.updatingHandles.add(()=>this.qualitySettings.memoryLimit,e=>{this.resourceController&&(this.resourceController.memoryController.maxMemory=e)},Ie),this.updatingHandles.add(()=>this.qualitySettings.additionalCacheMemory,e=>{this.resourceController&&(this.resourceController.memoryController.additionalCacheMemory=e)},Ie),this.updatingHandles.add(()=>this.qualitySettings.frameRate??0,e=>Vv(e>0?1e3/Math.ceil(e):0),Ie),this.updatingHandles.add(()=>this.map?.ground,t,ye),this.updatingHandles.add(()=>this.map?.ground?.opacity,()=>this._updateDefaultHitTestOptions(),ye),this.addHandles(P(()=>this.spatialReference,()=>this.notifyChange("clippingArea"),we))}destroy(){this.destroyed||(KP(this),this.updatingHandles.removeAll(),this.invalidate(),this.activeTool=null,this.layerViewManager.clear(),this._set("analysisViewManager",G(this.analysisViewManager)),this._exitSurface(),this._disposeGraphicsView(),this.sharedSymbolResources=G(this.sharedSymbolResources),this._set("labeler",G(this.labeler)),this._set("deconflictor",G(this.deconflictor)),this._resourceController=G(this._resourceController),this._set("stateManager",G(this.stateManager)),this._set("inputManager",G(this.inputManager)),this.state.destroy(),this.highlights.destroy(),this._propertiesPool.destroy(),this.removeHandles("updatingMonitors"),this._set("environmentManager",G(this.environmentManager)),this._set("environment",G(this.environment)),this.groundView=G(this.groundView),this._exitBasemapTerrain(),this._stage?.destroy())}get renderSpatialReference(){return this.renderCoordsHelper?.spatialReference}get basemapSpatialReference(){return this.basemapTerrain?.spatialReference}get animation(){return this.state?.animation}get camera(){return this.stateManager?.camera}set camera(t){this.stateManager&&(this.stateManager.camera=t)}get contentCamera(){return this.stateManager?.contentCamera}set contentCamera(t){this.stateManager&&(this.stateManager.contentCamera=t)}installContentCameraReset(t={sticky:!1}){return this.stateManager.installContentCameraReset(t)}get center(){return this.stateManager?.center}set center(t){this.stateManager&&(this.stateManager.center=t)}get clippingArea(){if(this.viewingMode==="global")return null;let t=this.map,e=this._userClippingArea||Z_(t,"clippingArea");return!this._userClippingArea&&!Z_(t,"clippingEnabled")||e==null?(this._clippingArea=null,null):e instanceof kr?this.spatialReference&&(e=k_(e,this.spatialReference),e==null)?(pe.getLogger(this).error("#clippingArea","setting clippingArea with incompatible SpatialReference"),this._clippingArea):(e=e.clone(),e.intersection(this._groundAndLayersExtent)==null&&(e.xmin=e.xmax,e.ymin=e.ymax),e.zmin=void 0,e.zmax=void 0,e.equals(this._clippingArea)||(this._clippingArea=e),this._clippingArea):(pe.getLogger(this).error("#clippingArea","only clippingArea geometries of type Extent are supported"),this._clippingArea)}set clippingArea(t){this.ready&&this.viewingMode==="global"&&t!=null?pe.getLogger(this).error("#clippingArea=","Clipping area is only supported in local viewingMode"):this._userClippingArea=t}get renderDataExtent(){if(this.state.viewingMode===me.Global)return null;let t=this.renderSpatialReference,e=this.dataExtent;return e==null||t==null||e.spatialReference.equals(t)?e:k_(e,t)}get tileInfo(){return this.basemapTerrain?.tilingScheme?.toTileInfo()}get dataExtent(){let t=this._groundAndLayersExtent,e=this.spatialReference||Kt.WGS84,i=k_(this.clippingArea,e);i!=null&&(t=t!=null?t.intersection(i):i);let r=this._get("dataExtent");return t!=null&&t.equals(r)?r:t}get _groundAndLayersExtent(){let t=this.spatialReference||Kt.WGS84,e,i=a=>{let n=k_(a,t);n!=null&&(e!=null?e.union(n):e=n.clone())},r=this.basemapTerrain;if(r?.spatialReference){let a=r.groundExtent;i(new kr({xmin:a[0],ymin:a[1],zmin:0,xmax:a[2],ymax:a[3],zmax:0,spatialReference:r.spatialReference}))}if(this.map){let a=n=>{n.fullExtent==null||n.type==="graphics"&&n.internal||i(n.fullExtent)};this.map.allLayers.forEach(n=>a(n))}if(e==null)return null;e.hasZ?(e.zmin=Math.min(0,e.zmin??0),e.zmax=Math.max(0,e.zmax??0)):(e.zmin=0,e.zmax=0);let s=this._get("_groundAndLayersExtent");return e.equals(s)?s:e}castEnvironment(t){return t?t instanceof zo?t:t instanceof Mm?this.environment?.cloneWithWebsceneEnvironment(t)??zo.fromWebsceneEnvironment(t):kv(zo,t):new zo}get extent(){return this.stateManager?.extent}set extent(t){this.stateManager&&(this.stateManager.extent=t)}get screenCenter(){return this.stateManager?.screenCenter}get frustum(){return this.stateManager?.frustum}get initialExtentRequired(){return this.stateManager&&!this.stateManager.hasInitialView}get defaultsFromMapSettings(){return{required:{tileInfo:!1,heightModelInfo:!0,extent:!1}}}get interacting(){return this.navigating||(this.toolViewManager?.interacting??!1)}get stationary(){return!this.animation&&!this.resizing&&(this.state?.stationary??!0)}get navigating(){return this.state?.navigating??!1}get padding(){return this.stateManager?.padding}set padding(t){this.stateManager&&(this.stateManager.padding=t)}set qualityProfile(t){Eh.isValidProfile(t)&&(Eh.apply(t,this.qualitySettings),this._stage?.renderView.updateQualitySettings(this.qualitySettings),this._set("qualityProfile",t))}get qualityProfile(){return this._get("qualityProfile")||Eh.getDefaultProfile()}set slicePlane(t){if(this._stage!=null&&(this._stage.renderer.slicePlane=t),t==null)return void this._set("slicePlane",null);let e=this._propertiesPool.get("slicePlane");Gl(t,e),this._set("slicePlane",e)}get typeSpecificPreconditionsReady(){return!!this.viewingMode&&!!this.stateManager?.preinit(this.spatialReference)}get resolution(){return this.spatialReference!=null?tw(this.scale,this.spatialReference):0}get scale(){return this.stateManager?.scale}set scale(t){this.stateManager&&(this.stateManager.scale=t)}get heightModelInfo(){let t=this.getDefaultHeightModelInfo();return t!=null?Yv.deriveUnitFromSR(t,this.spatialReference):null}get updating(){if(this.destroyed)return!1;let t=0,e=this.layerViewManager.updating,i=e?this.layerViewManager.updatingRemaining:0;this.allLayerViews.forEach(s=>{if(s.isFulfilled()){if(s.updating){if(e=!0,s.suspended||Fc(s))return;++i,t+=s.updatingProgress}}else++i});for(let s of this._updatingObjects)s!=null&&s.updating&&(i+=.1,t+=.5*.1);for(let s of this._updatingObjectsWithProgress)s!=null&&s.updating&&(++i,t+=s.updatingProgress);let r=!this.stateManager.test.updatingIgnoreRenderState&&this.state.updating;if(e=!!(e||i>0||this.updatingHandles.updating||!this.ready||!this.stationary||r||this._createGraphicsViewController||this.inputManager?.updating||this.map?.allLayers?.some(s=>!s.isFulfilled())||this.textures?.updating),e?(this._numUpdating=Math.max(i,this._numUpdating),t+=this._numUpdating-i):this._numUpdating=0,this._numUpdating>0?t/=this._numUpdating:t=e?0:1,this._get("updatingProgress")!==t){let s=performance.now();if(t<1){let a=Math.min((s-this._lastUpdateTime)/2e3,1);t=this.updatingProgress*(1-a)+t*a}this._set("updatingProgress",t),this._lastUpdateTime=e&&t<1?s:0}return e}get _updatingObjects(){return[this.graphicsView,this.basemapView,this._resourceController,this._stage,this.featureTiles,this.pointsOfInterest,this.environmentManager,this.overlay,this._featureTreeDebugger,this.toolViewManager,this.analysisViewManager]}get _updatingObjectsWithProgress(){return[this.deconflictor,this.labeler,this.basemapTerrain]}get viewingMode(){let t=this._predeterminedViewingMode;if(t!=null)return Bp(t);let e=this.spatialReference;return e?this.defaultsFromMap?.viewingMode!=null&&e.equals(this.defaultsFromMap.spatialReference)?Bp(this.defaultsFromMap.viewingMode):Mg(e,me.Global)?"global":"local":"global"}set viewingMode(t){this.ready?pe.getLogger(this).error("#viewingMode","viewingMode cannot be set once view is ready"):this._overrideIfSome("viewingMode",t)}get viewpoint(){return this.stateManager?.viewpoint}set viewpoint(t){this.stateManager&&(this.stateManager.viewpoint=t)}get visibleArea(){return this.stateManager?.visibleArea}get zoom(){return this.stateManager.zoom}set zoom(t){this.stateManager&&(this.stateManager.zoom=t)}get highlightOptions(){return this.highlights.find(({name:t})=>t===Ac)??new Rg}set highlightOptions(t){for(let e=0;e<this.highlights.length;++e)if(this.highlights.at(e).name===Ac)return void this.highlights.items[e].assignFrom(t)}get resourceController(){return this._resourceController}get quality(){return this._resourceController?.memoryController?.memoryFactor??1}get resolutionScale(){return Math.sqrt(Math.min(1,this.quality/.75))}get performanceInfo(){return new HC(this)}on(t,e,i,r){return this.viewEvents.on(t,e,i,r)||super.on(t,e)}hasEventListener(t){return super.hasEventListener(t)||this.viewEvents.hasHandler(t)}toMap(t,e){if(!this.ready)return pe.getLogger(this).error("#toMap()","Scene view cannot be used before it is ready"),null;let i=Fg(t)?Ng(this,t):t;return bC(this,i,e,this._defaultToMapOptions)}toScreen(t){if(!this.ready)return pe.getLogger(this).error("#toScreen()","Scene view cannot be used before it is ready"),null;let e=(t.z==null?vb(this.elevationProvider,t):null)??0;return Sn(t,G_,this.renderSpatialReference,e),this.state.camera.projectToScreen(G_,_v),gp(_v[0],_v[1])}pixelSizeAt(t,e){if(!this.ready)return pe.getLogger(this).error("#pixelSizeAt()","Scene view cannot be used before it is ready"),null;if(!t)return 0;let i=this.renderSpatialReference;Sn(t,G_,i);let r=this.state.camera.computeScreenPixelSizeAt(G_);return e&&i!==e?r*uc(i)/uc(e):r}overlayPixelSizeInMapUnits(t){let e=this.basemapTerrain.overlayManager;return e?e.overlayPixelSizeInMapUnits(t,()=>this.pixelSizeAt(t)):1}hitTest(t,e){if(!this.ready)return pe.getLogger(this).error("#hitTest()","Scene view cannot be used before it is ready"),null;let i=Fg(t)?Ng(this,t):t;return wC(this,i,e,this._defaultHitTestOptions)}popupHitTest(t){return Re(this,null,function*(){return HS(this,t)})}goTo(t,e){return this.updatingHandles.addPromise(this.stateManager.goTo(t,e))}whenAnalysisView(t){return Re(this,null,function*(){if(t.parent==null)throw new si("view:no-analysisview-for-analysis","The analysis has not been added to view.analyses",{analysis:t});switch(t.parent.type){case"line-of-sight":case"dimension":case"viewshed":return(yield this.whenLayerView(t.parent)).whenAnalysisView();default:return this.analysisViewManager.whenAnalysisView(t)}})}whenLayerView(t){return super.whenLayerView(t)}takeScreenshot(t){return Re(this,null,function*(){let e=yield this._completeSettings(t);yield this.whenReady();let i=yield this._stage.renderView.takeScreenshot(e);return(yield import("./chunk-G3Z2BBMJ.js")).encode(i,e,this._pixelFormat())})}_takeScreenshot(t){return Re(this,null,function*(){let e=yield this._completeSettings(t);yield this.whenReady();let i=yield this._stage.renderView.takeScreenshot(e);return(yield import("./chunk-G3Z2BBMJ.js")).encodeData(i,this._pixelFormat())})}_takeScreenshotWithObjectAndLayerId(t){return Re(this,null,function*(){let e=yield this._completeSettings(t);yield this.whenReady();let i=yield this._stage.renderView.takeScreenshotWithOID(e),{encodeData:r}=yield import("./chunk-G3Z2BBMJ.js");return[r(i[0],this._pixelFormat()),r(i[1],this._pixelFormat())]})}_completeSettings(t){return Re(this,null,function*(){let{toRenderSettings:e,screenshotSuperSampleSettings:i}=yield import("./chunk-G3Z2BBMJ.js"),r=e(t,this);return r.pixelRatio/=this.state.pixelRatio,i(r,this.supersampleScreenshotsEnabled,this.padding)})}_pixelFormat(){return{flipY:!0,premultipliedAlpha:this._stage.renderView.getAlpha()}}get test(){}takeScreenshotWithObjectAndLayerId(t){return Re(this,null,function*(){if(!On())throw new si("360vr:objectAndLayerId-rendering-disabled","has enable-feature:objectAndLayerId-rendering must be true");let{encode:e}=yield import("./chunk-G3Z2BBMJ.js"),i=yield this._completeSettings(t);yield this.whenReady();let r=yield this._stage.renderView.takeScreenshotWithOID(i),s=e(r[0],i,this._pixelFormat()),a=yield this._completeSettings(t);return a.format="png",[s,e(r[1],a,this._pixelFormat())]})}getColorToObjectAndLayerIdMapping(){let t=this._stage.renderView.olidRenderHelper;if(t)return t.getColorToObjectAndLayerIdMapping();throw new si("360vr:objectAndLayerId-rendering-disabled","has enable-feature:objectAndLayerId-rendering must be true")}addUpdatingPromise(t){return this.updatingHandles.addPromise(t)}importLayerView(t){return sy.importLayerView(t)}hasLayerViewModule(t){return sy.hasLayerViewModule(t)}forceDOMReadyCycle(){this.forceReadyCycle()}getDefaultSpatialReference(){return this.map&&"initialViewProperties"in this.map&&this.map.initialViewProperties?.spatialReference||this.defaultsFromMap?.spatialReference||this.defaultsFromMap?.ready&&this._initialDefaultSpatialReference||null}validate(){return Re(this,null,function*(){let t=UT(this.type),e=Yt("safari");if(e&&e<9&&(t=new si("sceneview:browser-not-supported","This browser is not supported by SceneView (Safari < 9)",{type:"safari",requiredVersion:9,detectedVersion:e})),t!=null)throw pe.getLogger(this).warn("#validate()",t.message),t})}get _predeterminedViewingMode(){let t=this._isOverridden("viewingMode")?this._get("viewingMode"):(this.map&&"initialViewProperties"in this.map?this.map.initialViewProperties?.viewingMode:null)??null;return t!=null?Sc(t):null}getSpatialReferenceSupport(t,e){let i=this._predeterminedViewingMode;if(i!=null)return this._validateSpatialReferenceForViewingMode(t,e,i)?{constraints:this._makeSpatialReferenceConstraints(t,e,i)}:null;let r=this._validateSpatialReferenceForViewingMode(t,e,me.Local),s=this._validateSpatialReferenceForViewingMode(t,e,me.Global);return r||s?r&&s?{constraints:this._makeSpatialReferenceConstraints(t,e,null)}:r?{constraints:this._makeSpatialReferenceConstraints(t,e,me.Local)}:{constraints:this._makeSpatialReferenceConstraints(t,e,me.Global)}:null}_validateSpatialReferenceForViewingMode(t,e,i){return!!Mg(t,i)&&(e==null||!!rg(e)||(!yn(e)||Fo(e,t,i)!=null)&&(!ig(e)||i!==me.Global))}_makeSpatialReferenceConstraints(t,e,i){if(e==null)return[{spatialReference:t,viewingMode:i}];let{isWebMercator:r,isWGS84:s}=t;return rg(e)&&(r||s)?!s||i===me.Local||JT(e.tileInfo,e.fullExtent,t,me.Global)===null?[{spatialReference:t,viewingMode:i},{spatialReference:Kt.WebMercator,viewingMode:i}]:[{spatialReference:r?Kt.WGS84:Kt.WebMercator,viewingMode:i}]:yn(e)||ig(e)||!r&&!s?yn(e)&&r&&i!==me.Global?[{spatialReference:t,viewingMode:i},{spatialReference:Kt.WGS84,viewingMode:me.Local}]:[{spatialReference:t,viewingMode:i}]:[{spatialReference:t,viewingMode:i},{spatialReference:r?Kt.WGS84:Kt.WebMercator,viewingMode:i}]}_validateSpatialReference(t){let e=this.getSpatialReferenceSupport(t)!=null,i=this._predeterminedViewingMode;return e||(i!=null?pe.getLogger(this).warnOnce(`Spatial reference defined on view not supported in ${Bp(i)} viewing mode.`):t.isGeographic&&pe.getLogger(this).warnOnce("Spatial reference is geographic but not supported.")),e}whenReady(){return new Promise(t=>{this.ready?t(this):this._resolveWhenReady.push(t)})}trackGraphicState(t){if(!t.graphic)return pe.getLogger(this).error("trackGraphicState","GraphicState.graphic must not be null or undefined to start tracking"),null;let e=this.getViewForGraphic(t.graphic),i=null,r=!1,s=a=>{!r&&a!=null&&"processor"in a&&a.processor?.type==="graphics-3d"&&a.processor.graphicsCore&&(i=a.processor.graphicsCore.trackGraphicState(t))};return e!=null?s(e):this.whenViewForGraphic(t.graphic,{waitForLayer:!0}).then(a=>s(a),()=>{}).catch(()=>{}),is(()=>{r=!0,i!=null&&(i.remove(),i=null)})}maskOccludee(t){if(!t)return pe.getLogger(this).error("maskOccludee","GraphicState.graphic must not be null or undefined to mask an occludee"),null;let e=this.getViewForGraphic(t),i=null,r=!1,s=a=>{!r&&a!=null&&Tw(a)&&(i=a.maskOccludee(t))};return e!=null?s(e):this.whenViewForGraphic(t,{waitForLayer:!0}).then(a=>s(a),()=>{}).catch(()=>{}),is(()=>{r=!0,i!=null&&(i.remove(),i=null)})}getViewForGraphic(t){return t.layer===this.graphics?this.graphicsView:t.layer?this.allLayerViews.filter(e=>e.type!=="media-3d").find(e=>e.layer===t.layer):null}graphicChanged(t){this.graphicsView!=null&&this.graphicsView.graphicChanged(t)}whenViewForGraphic(t,e){return Re(this,null,function*(){if(t.layer===this)return yield pc(()=>this.graphicsView),this.graphicsView;if(!t.layer||!this.map)throw new si("no-view-for-graphic");return e&&e.waitForLayer&&!this.map.allLayers.includes(t.layer)?new Promise((i,r)=>{let s=this.map.allLayers.on("change",a=>{a.added.includes(t.layer)&&(s.remove(),this.whenLayerView(t.layer).then(i,r))})}):this.whenLayerView(t.layer)})}_initBasemapTerrain(){this._set("basemapTerrain",new GR({view:this})),this._set("elevationProvider",new Ah({view:this})),this.elevationProvider.register("ground",this.basemapTerrain)}_exitBasemapTerrain(){this.basemapTerrain&&(this.elevationProvider.unregister(this.basemapTerrain),this.elevationProvider.destroy(),this._set("elevationProvider",null),this.basemapTerrain.destroy(),this._set("basemapTerrain",null))}_initGlobe(){this._initCoordinateSystem(),this.state.createInitialCamera(),this._initBasemapTerrain(),this._set("pointsOfInterest",new dr({view:this})),this._set("featureTiles",new xi({renderCoordsHelper:this.renderCoordsHelper,cameraOnSurface:this.pointsOfInterest.cameraOnSurface,focus:this.pointsOfInterest.focus,tilingSchemeOwner:this.basemapTerrain,viewState:this.state,scheduler:this._resourceController.scheduler,terrain:this.basemapTerrain}));let t=()=>{let e=this.basemapTerrain?.extent;if(this.clippingArea||e)if(e&&this.basemapTerrain.spatialReference){let i=this.basemapTerrain.extent!=null&&this.basemapTerrain.spatialReference!=null?pg(e1(this.basemapTerrain.extent,this.basemapTerrain.spatialReference),this.spatialReference):null;this.clippingArea?this.featureTiles.filterExtent=this.clippingArea.intersection(i):this.featureTiles.filterExtent=i}else this.featureTiles.filterExtent=this.clippingArea;else this.featureTiles.filterExtent=null};this.addHandles([this.updatingHandles.add(()=>ui.FEATURE_TILE_TREE_SHOW_TILES,e=>{e&&this.featureTiles&&!this._featureTreeDebugger?this.updatingHandles.addPromise(import("./chunk-X7JOHPJJ.js")).then(({FeatureTileTree3DDebugger:i})=>{!this._featureTreeDebugger&&ui.FEATURE_TILE_TREE_SHOW_TILES&&(this._featureTreeDebugger=new i({view:this}))}):e||!this._featureTreeDebugger||ui.FEATURE_TILE_TREE_SHOW_TILES||(this._featureTreeDebugger.destroy(),this._featureTreeDebugger=null)},ye),this.updatingHandles.add(()=>this.clippingArea,t,ye),this.updatingHandles.add(()=>this.basemapTerrain.extent,t,ye)],"feature-tiles"),this.stateManager.init()}_exitGlobe(){this.featureTiles&&(this.stateManager.exit(),this.removeHandles("render-coords-helper"),this.removeHandles("feature-tiles"),this._set("featureTiles",G(this.featureTiles)),this._set("pointsOfInterest",G(this.pointsOfInterest)),this._exitBasemapTerrain(),this.state.reset(),this._exitCoordinateSystem())}_initCoordinateSystem(){if(this.spatialReference){let t=this.spatialReference,e=this.state.isGlobal,i=hb(e,t);i!==this.renderSpatialReference&&(this._set("renderCoordsHelper",cb.create(this.state.viewingMode,i)),e||this.addHandles(P(()=>this.basemapTerrain?.extent,r=>{let s=this.renderCoordsHelper.spatialReference;r==null||r[0]===0&&r[1]===0&&r[2]===0&&r[3]===0||!om(r,this.basemapTerrain.spatialReference,XP,s)||(this.renderCoordsHelper.extent=XP)},we),"render-coords-helper"),this.sceneIntersectionHelper&&this.sceneIntersectionHelper.setTolerance($l/this.renderCoordsHelper.unitInMeters))}else this._set("renderCoordsHelper",null)}_exitCoordinateSystem(){this.removeHandles("render-coords-helper"),this._set("renderCoordsHelper",null)}_updatingChanged(){this.notifyChange("updating")}_updateUpdatingMonitors(t=null){t!=null&&t.type===J_.MOVE||(this.removeHandles("updatingMonitors"),this.allLayerViews.forEach(e=>{e.destroyed||(this.addHandles(P(()=>[e.updating,e.updatingProgress],()=>this._updatingChanged(),we),"updatingMonitors"),e.when(()=>this._updatingChanged(),()=>this._updatingChanged()))}),this._updatingChanged())}_prepareScreenshotOverlay(){return Re(this,null,function*(){this.overlay&&(yield this.overlay.prepare())})}_renderScreenshotOverlay(t,e,i){if(!this.overlay||!this.overlay.hasVisibleItems)return i;let r=t.getContext("2d");return r.putImageData(i,0,0),this.overlay.renderCanvas(t,{disableDecorations:e}),r.getImageData(0,0,i.width,i.height)}_initStage(){let t={deactivatedWebGLExtensions:this.deactivatedWebGLExtensions,debugWebGLExtensions:this.debugWebGLExtensions,alpha:this.alphaCompositingEnabled,preserveDrawingBuffer:this.preserveDrawingBufferEnabled,canvas:this.renderCanvas,screenshot:{prepareOverlay:()=>this._prepareScreenshotOverlay(),renderOverlay:(r,s,a)=>this._renderScreenshotOverlay(r,s,a)}},e=new ju(this.state.viewingMode,r=>this._stage.layers.forAll(r),this);this._set("sceneIntersectionHelper",e);let i=jv(this.surface);this._stage=new ts({view:this,options:t,container:i}),this._stage.renderer.slicePlane=this.slicePlane,this.addHandles([this.updatingHandles.add(()=>this.qualitySettings.highQualityTransparency,r=>this._stage.renderer.setParameters({highQualityTransparency:r}),Ie),this.on("pointer-move",()=>this._stage?.renderer.resetAnimation()),Dv(this._stage.renderView.canvas,"webglcontextlost",r=>{this.fatalError=new si("webgl-context-lost",r.statusMessage)})],"stage"),this.renderCoordsHelper&&this.sceneIntersectionHelper.setTolerance($l/this.renderCoordsHelper.unitInMeters),this._set("canvas",this._stage.renderView.canvas)}_exitStage(){this._set("sceneIntersectionHelper",null),this._stage=G(this._stage),this.removeHandles("stage"),this._set("canvas",null)}_initSurface(t){this._exitSurface(),this._initStage(),this._initGlobe(),this.sharedSymbolResources=new tf({view:this,viewingMode:t,resourceController:this._resourceController,pointsOfInterest:this.pointsOfInterest,viewState:this.state})}_exitSurface(){this.sharedSymbolResources&&(this.sharedSymbolResources.objectResourceCache.destroy(),this.sharedSymbolResources.destroy(),this.sharedSymbolResources=null,this._exitGlobe(),this._exitStage())}_createGraphicsViewIfNeeded(){if(this.graphicsView||this._createGraphicsViewController||this.graphics.length===0)return;this.removeHandles("graphics-view"),this._createGraphicsViewController=new AbortController;let t=()=>{this._createGraphicsViewController=null,this._updatingChanged()};this._createGraphicsViewAsync(this._createGraphicsViewController.signal).then(t,t),this._updatingChanged()}_createGraphicsViewAsync(t){return Re(this,null,function*(){let e=(yield import("./chunk-3FXQN5UN.js")).default;Vi(t),yield pc(()=>this.basemapTerrain?.ready,t),this._set("graphicsView",new e({view:this}))})}_disposeGraphicsView(){this._createGraphicsViewController&&(this._createGraphicsViewController.abort(),this._createGraphicsViewController=null),this.removeHandles("graphics-view"),this.graphicsView!=null&&(this.removeHandles(this.graphicsView.processor.layer.id),this.graphicsView.destroy(),this._set("graphicsView",null))}_startup(){let t=Sc(this.viewingMode);t===me.Global&&(this._clippingArea=null),this._initSurface(t),this._set("ready",!0),this.addHandles(Er(()=>this.graphics,"after-changes",()=>this._createGraphicsViewIfNeeded()),"graphics-view"),this._createGraphicsViewIfNeeded();let e=this.map&&"initialViewProperties"in this.map?this.map.initialViewProperties:null,i=e?.environment;i&&(this._overrideDefaultEnvironmentOnly?ry(this.environment,i):this.environment=this.environment.cloneWithWebsceneEnvironment(i)),this.timeExtent=e?.timeExtent,this.labeler.setup(),this.environmentManager.connectView(this),this.inputManager.connect(),this._set("textures",new co(this._stage,this.resourceController.scheduler));let r=this._resolveWhenReady;this._resolveWhenReady=[],r.forEach(s=>s(this))}_teardown(){this._initialDefaultSpatialReference=null,this.inputManager.disconnect(),this.environmentManager.disconnectView(),this._overrideDefaultEnvironmentOnly=!1,this.labeler.dispose(),this._disposeGraphicsView(),this.removeHandles("graphics-view"),this._set("textures",G(this.textures)),this._exitSurface(),this._set("ready",!1)}_updateDefaultToMapOptions(){if(this._defaultToMapOptions.include.clear(),this.map){this.map.ground&&this._defaultToMapOptions.include.add(Za);for(let t of this.map.allLayers.items)fc(t.type)&&this._defaultToMapOptions.include.add(t.uid)}}_updateDefaultHitTestOptions(){if(this._defaultHitTestOptions.exclude.clear(),this.map){this.map.ground&&this.map.ground.opacity<1&&this._defaultHitTestOptions.exclude.add(Za);for(let t of this.map.allLayers.items)fc(t.type)&&t.opacity<1&&this._defaultHitTestOptions.exclude.add(t.uid)}}};function k_(t,e){return t!=null&&A1(t.spatialReference,e)?pg(t,e):null}ie.type="3d",c([p()],ie.prototype,"_userClippingArea",void 0),c([p()],ie.prototype,"_resourceController",void 0),c([p()],ie.prototype,"_stage",void 0),c([p({readOnly:!0})],ie.prototype,"deconflictor",void 0),c([p({readOnly:!0})],ie.prototype,"labeler",void 0),c([p(fb(Hg,"analyses"))],ie.prototype,"analyses",void 0),c([p({type:Gs,readOnly:!0})],ie.prototype,"animation",null),c([p({readOnly:!0})],ie.prototype,"basemapTerrain",void 0),c([p({readOnly:!0})],ie.prototype,"elevationProvider",void 0),c([p()],ie.prototype,"camera",null),c([p({type:ms})],ie.prototype,"contentCamera",null),c([p({readOnly:!0})],ie.prototype,"canvas",void 0),c([p({type:_r})],ie.prototype,"center",null),c([p({type:kr})],ie.prototype,"clippingArea",null),c([p({type:Wn})],ie.prototype,"constraints",void 0),c([p({type:kr,readOnly:!0})],ie.prototype,"renderDataExtent",null),c([p({readOnly:!0})],ie.prototype,"tileInfo",null),c([p({type:kr,readOnly:!0})],ie.prototype,"dataExtent",null),c([p({type:kr,readOnly:!0})],ie.prototype,"_groundAndLayersExtent",null),c([p({type:zo})],ie.prototype,"environment",void 0),c([ea("environment")],ie.prototype,"castEnvironment",null),c([p({readOnly:!0})],ie.prototype,"environmentManager",void 0),c([p({type:kr})],ie.prototype,"extent",null),c([p({type:Ba})],ie.prototype,"floors",void 0),c([p()],ie.prototype,"screenCenter",null),c([p()],ie.prototype,"frustum",null),c([p({type:Number,readOnly:!0})],ie.prototype,"fullOpacity",void 0),c([p({readOnly:!0})],ie.prototype,"graphicsView",void 0),c([p({readOnly:!0})],ie.prototype,"analysisViewManager",void 0),c([p()],ie.prototype,"groundView",void 0),c([p({type:Boolean})],ie.prototype,"initialExtentRequired",null),c([p()],ie.prototype,"defaultsFromMapSettings",null),c([p()],ie.prototype,"interacting",null),c([p()],ie.prototype,"stationary",null),c([p()],ie.prototype,"navigating",null),c([p()],ie.prototype,"map",void 0),c([p()],ie.prototype,"padding",null),c([p({type:dr,readOnly:!0})],ie.prototype,"pointsOfInterest",void 0),c([p({type:xi,readOnly:!0})],ie.prototype,"featureTiles",void 0),c([p()],ie.prototype,"_featureTreeDebugger",void 0),c([p({type:Boolean})],ie.prototype,"screenSizePerspectiveEnabled",void 0),c([p({constructOnly:!0})],ie.prototype,"deactivatedWebGLExtensions",void 0),c([p({constructOnly:!0})],ie.prototype,"debugWebGLExtensions",void 0),c([p({constructOnly:!0})],ie.prototype,"renderCanvas",void 0),c([p({constructOnly:!0})],ie.prototype,"state",void 0),c([p({readOnly:!0})],ie.prototype,"inputManager",void 0),c([p({readOnly:!0})],ie.prototype,"stateManager",void 0),c([p({type:["low","medium","high"]})],ie.prototype,"qualityProfile",null),c([p({type:Jy,get(){let t=this._get("qualitySettings");return t||(t=new Jy,Eh.apply(this.qualityProfile,t)),t}})],ie.prototype,"qualitySettings",void 0),c([p()],ie.prototype,"slicePlane",null),c([p({readOnly:!0})],ie.prototype,"typeSpecificPreconditionsReady",null),c([p({readOnly:!0})],ie.prototype,"renderCoordsHelper",void 0),c([p({readOnly:!0})],ie.prototype,"sceneIntersectionHelper",void 0),c([p({type:Number,dependsOn:["scale","spatialReference"],readOnly:!0})],ie.prototype,"resolution",null),c([p({type:Number})],ie.prototype,"scale",null),c([p()],ie.prototype,"heightModelInfo",null),c([p()],ie.prototype,"spatialReference",void 0),c([p({type:Boolean,constructOnly:!0})],ie.prototype,"alphaCompositingEnabled",void 0),c([p({constructOnly:!0})],ie.prototype,"preserveDrawingBufferEnabled",void 0),c([p({type:Boolean})],ie.prototype,"supersampleScreenshotsEnabled",void 0),c([p({readOnly:!0})],ie.prototype,"type",void 0),c([p(),ea(t=>t instanceof wm?t:Bv(fv,t))],ie.prototype,"ui",void 0),c([p({type:Boolean,readOnly:!0,dependsOn:["graphicsView.updating","basemapView.updating","basemapTerrain.updating","layerViewManager.updating","layerViewManager.updatingRemaining","_resourceController.updating","_stage.updating","featureTiles.updating","pointsOfInterest.updating","environmentManager.updating","overlay.updating","updatingHandles.updating","featureTreeDebugger.updating","labeler.updating","deconflictor.updating","ready","stationary","inputManager.updating","toolViewManager.updating","analysisViewManager.updating","state.updating","textures.updating"]})],ie.prototype,"updating",null),c([p()],ie.prototype,"_updatingObjects",null),c([p()],ie.prototype,"_updatingObjectsWithProgress",null),c([p({type:Number,readOnly:!0,dependsOn:["updating"]})],ie.prototype,"updatingProgress",void 0),c([p({type:["global","local"]})],ie.prototype,"viewingMode",null),c([p({type:Fn})],ie.prototype,"viewpoint",null),c([p({readOnly:!0})],ie.prototype,"visibleArea",null),c([p({type:Number})],ie.prototype,"zoom",null),c([p({type:Rg})],ie.prototype,"highlightOptions",null),c([p({readOnly:!0})],ie.prototype,"quality",null),c([p({readOnly:!0})],ie.prototype,"resolutionScale",null),c([p()],ie.prototype,"textures",void 0),ie=c([S("esri.views.SceneView")],ie);var G_=_(),_v=mt(),XP=kt(),TTe=ie;export{TTe as a};
