import{a as tt}from"./chunk-EWXFVWVM.js";import{a as q}from"./chunk-PKB5DBGQ.js";import{c as Ye,d as et}from"./chunk-CCSZEQ2U.js";import{a as de}from"./chunk-AGCOSXCD.js";import{a as ce}from"./chunk-INQWSZ53.js";import{a as X}from"./chunk-ZNLN6K7Z.js";import{a as Xe}from"./chunk-TZIYAVGB.js";import{a as Qe}from"./chunk-IGTLRSDU.js";import{a as Be,b as Je}from"./chunk-6GAANBZQ.js";import{d as $e}from"./chunk-4JIR4MZV.js";import{a as j}from"./chunk-62UTK67Z.js";import{a as V}from"./chunk-63BBKXWS.js";import{a as L}from"./chunk-AXZXNRJJ.js";import{a as Ue}from"./chunk-H7EBUK3L.js";import{a as Ge,b as pe,c as he}from"./chunk-DXT3NBO5.js";import{b as Q}from"./chunk-JA4ASPSI.js";import{a as Ze}from"./chunk-TUUOR3MF.js";import{h as Ne,i as We,j as ze}from"./chunk-YTAJKLRN.js";import{a as le}from"./chunk-QCZ3ZIGQ.js";import{g as je,h as I}from"./chunk-XR5FT7TQ.js";import{a as J}from"./chunk-LORHDXEB.js";import{a as x}from"./chunk-JQAW4OB5.js";import{b as ne}from"./chunk-2HYVVLKS.js";import{a as Ae}from"./chunk-D3CUKSGS.js";import{a as Ke}from"./chunk-QK56OQGR.js";import{a as De}from"./chunk-CELWVZPW.js";import{d as qe}from"./chunk-OLOKUDVI.js";import{b as se}from"./chunk-EQZWYK27.js";import{a as oe}from"./chunk-IR6XCBC4.js";import{m as He}from"./chunk-ZQIC5NFT.js";import{a as Pe}from"./chunk-7F5DJLJT.js";import{d as Oe}from"./chunk-NJWTSROP.js";import{a as Ie}from"./chunk-GHKL3NOH.js";import{a as xe}from"./chunk-4N4D2YQX.js";import{a as Ce,i as Le}from"./chunk-MVHHPJM7.js";import{a as _,b as re,c as B,e as Fe,i as ae,k as A}from"./chunk-TG45K3WR.js";import{f as $}from"./chunk-RAI4DTMT.js";import{b as y}from"./chunk-ACP3S2CH.js";import{a as U}from"./chunk-T7DXJKX7.js";import{a}from"./chunk-QGVBCWUY.js";import{H as b,y as Se}from"./chunk-MYO4NP2N.js";import{b as z,e as s}from"./chunk-NFIPKH6V.js";import{l as m}from"./chunk-5QEXLALV.js";import{a as Ee,c as Re}from"./chunk-P6QFA5MM.js";import{b as ve,d as Me}from"./chunk-BWO7LS2H.js";import{d as Ve}from"./chunk-HEVQSRJ2.js";import{F as ke,L as ie,b as R,d as C,e as H,j as Te,o as te,p as Z,r as be,u as G,y as K}from"./chunk-4PTIEWMT.js";import{b as E}from"./chunk-YOFFGXOB.js";import{g}from"./chunk-XRGPJ3QY.js";import{a as _e,l as ee,y as we}from"./chunk-QBWJMFH5.js";import{a as f,b as T,f as v}from"./chunk-VTHXE323.js";var D=class extends Ge{constructor(e){super(e),this.addHandles(this.on("before-add",t=>{t.item!=null&&t.item.parent===this.owner&&(g.getLogger(this).warn("Analysis inside the collection must be unique. Not adding this element again."),t.preventDefault())}))}_own(e){e.parent=this.owner}_release(e){e.parent=null}};D=a([m("esri.support.AnalysesCollection")],D);function yt(e){return"tryRecycleWith"in e}function ft(e){return e!=null&&typeof e=="object"&&"layerViews"in e}var ue=class{constructor(t,i,r){this.layer=t,this.view=i,this.layerViewImporter=r,this._controller=new AbortController,this._deferred=ie(),this._started=!1,this.done=!1,this.promise=this._deferred.promise,G(this._controller.signal,()=>{let o=new E("cancelled:layerview-create","layerview creation cancelled",{layer:t});this._deferred.reject(o)})}tryRecycle(t){if(!this.done||!this.layerView||!yt(this.layerView))return null;let i=this.layer.type,r=this._controller.signal;for(let o=0;o<t.length;o++){let l=t[o];if(l.type!==i)continue;let n=this.layerView.tryRecycleWith(l,{signal:r});if(n){t.splice(o,1),this.layer=l;let p=this.layerView,h=p.view;return this.promise=Promise.race([n.then(()=>(Z(this._controller.signal),l.emit("layerview-destroy",{view:h,layerView:p}),h.emit("layerview-destroy",{view:h,layerView:p}),l.emit("layerview-create",{view:h,layerView:p}),h.emit("layerview-create",{view:h,layerView:p}),p)),new Promise((d,w)=>G(this._controller.signal,()=>w(te())))]),this.promise}}return null}destroy(){this._controller.abort();let{layerView:t}=this;if(t){let{layer:i,view:r}=this;i.emit("layerview-destroy",{view:r,layerView:t}),r.emit("layerview-destroy",{layer:i,layerView:t})}this.done=!0,this.layer=null,this.layerView=null,this.view=null,this.layerViewImporter=null,this._map=null}start(){return v(this,null,function*(){if(this._started)return;this._started=!0;let{_controller:{signal:t},layer:i,view:r}=this;this._map=r.map;try{let o,l;if(yield i.load({signal:t}),i.prefetchResources&&(yield i.prefetchResources({signal:t})),gt(i))o=yield i.createLayerView(r,{signal:t});else{if(!this.layerViewImporter.hasLayerViewModule(i))throw new E("layer:view-not-supported","No layerview implementation was found");let h=yield this.layerViewImporter.importLayerView(i);Z(t),o="default"in h?new h.default({layer:i,view:r}):new h({layer:i,view:r})}let n=()=>{l=C(l),o.destroyed||o.destroy(),o.layer=null,o.parent=null,o.view=null,this.done=!0};l=G(t,n),Z(t);try{yield o.when()}catch(h){throw n(),h}if(!this._map?.allLayers?.includes(i))return n(),void this._deferred.reject(new E("view:no-layerview-for-layer","The layer has been removed from the map",{layer:i}));this.layerView=o,i.emit("layerview-create",{view:r,layerView:o}),r.emit("layerview-create",{layer:i,layerView:o}),this.done=!0,this._deferred.resolve(o)}catch(o){i.emit("layerview-create-error",{view:r,error:o}),r.emit("layerview-create-error",{layer:i,error:o}),this.done=!0,this._deferred.reject(new E("layerview:create-error","layerview creation failed",{layer:i,error:o}))}})}},M=class extends b{constructor(e){super(e),this._layerLayerViewInfoMap=new Map,this._recyclingInfoMap=new Map,this._watchUpdatingTracking=new x,this.supportsGround=!0,this._preloadLayerViewModules=()=>{let t=this.view.map?.allLayers;if(t)for(let i of t)this.layerViewImporter.hasLayerViewModule(i)&&this.layerViewImporter.importLayerView(i)},this._reschedule=()=>this.destroyed?Promise.reject():(this._workPromise==null&&(this._workPromise=ie(),this._workPromise.promise.catch(()=>{})),this.removeHandles("reschedule"),this.addHandles(Ve(this._doWork),"reschedule"),this._workPromise.promise),this._doWork=()=>{if(this.destroyed)return;let t=this.view.map;if(this._map!==t&&(this.clear(),this._map=t),this._workPromise==null)return void this.notifyChange("updating");this.removeHandles("reschedule"),this.removeHandles("collection-change");let i=new Set,r=[],o=this.view.ready,l=p=>{if(p!=null){for(let h of p)if(h){i.add(h);let d=this._layerLayerViewInfoMap.get(h);d&&o?d.start():d||this._recyclingInfoMap.has(h)||r.push(h),"layers"in h&&h.layers&&l(h.layers)}}};for(let p of this._rootCollectionNames)l(z(this,p));for(let[p,h]of this._layerLayerViewInfoMap)if(!i.has(p)){this._layerLayerViewInfoMap.delete(h.layer);let d=h.tryRecycle(r);d?(this.notifyChange("updating"),this._recyclingInfoMap.set(h.layer,h),d.then(()=>{this.notifyChange("updating"),this._recyclingInfoMap.delete(h.layer),this._layerLayerViewInfoMap.set(h.layer,h),this._reschedule()}).catch(()=>{this.notifyChange("updating"),this._recyclingInfoMap.delete(h.layer),h.destroy(),this._reschedule()})):h.destroy()}for(let[p,h]of this._recyclingInfoMap)i.has(p)||(this.notifyChange("updating"),this._recyclingInfoMap.delete(h.layer),h.destroy());for(let p of r)this._createLayerView(p);this._refreshCollections();let n=[t?.ground?.layers,t?.basemap?.baseLayers,t?.basemap?.referenceLayers,t?.layers].filter(p=>!!p);i.forEach(p=>"layers"in p&&n.push(p.layers)),this.addHandles(n.map(p=>this._watchUpdatingTracking.addOnCollectionChange(()=>p,this._reschedule)),"collection-change"),this._workPromise.resolve(),this._workPromise=null}}initialize(){this.addHandles([B(()=>this.view?.map?.allLayers,"change",this._preloadLayerViewModules,{onListenerAdd:this._preloadLayerViewModules}),_(()=>{let e=this.view,t=e?.map;return[t?.basemap,t?.ground,t?.layers,e?.ready]},()=>this._reschedule(),A)]),this._preloadLayerViewModules(),this._reschedule()}destroy(){this.clear(),Q(this._recyclingInfoMap),Q(this._layerLayerViewInfoMap),this._watchUpdatingTracking.destroy(),this._map=null,this._workPromise!=null&&(this._workPromise.reject(te()),this._workPromise=null)}get _layersToLayerViews(){let e=[["view.map.basemap.baseLayers","view.basemapView.baseLayerViews"],["view.map.layers","view.layerViews"],["view.map.basemap.referenceLayers","view.basemapView.referenceLayerViews"]];return this.supportsGround&&e.push(["view.map.ground.layers","view.groundView.layerViews"]),new Map(e)}get _rootCollectionNames(){return Array.from(this._layersToLayerViews.keys())}get updating(){return this._workPromise!=null||this._watchUpdatingTracking.updating||Ee(this._layerLayerViewInfoMap,e=>!e.done)||this._recyclingInfoMap.size>0}get updatingRemaining(){let e=0;for(let t of this._layerLayerViewInfoMap.values())t.done||++e;return e}clear(){this.destroyed||(Q(this._layerLayerViewInfoMap),this._refreshCollections())}whenLayerView(e){return v(this,null,function*(){if(yield this._reschedule(),!this._layerLayerViewInfoMap.has(e)){if(this._recyclingInfoMap.has(e))return this._recyclingInfoMap.get(e).promise;throw new E("view:no-layerview-for-layer","No layerview has been found for the layer",{layer:e})}return this._layerLayerViewInfoMap.get(e).promise})}isCreatingLayerViewsForLayer(e,t){this.commitProperty("updatingRemaining");let i=this._layerLayerViewInfoMap.get(e);if(!i?.done)return!0;let r=i.layerView;return!(!r||!t||r.parent===t)||!!(i.done&&r&&"layers"in e&&e.layers?.length)&&e.layers.some(o=>this.isCreatingLayerViewsForLayer(o,r))}_refreshCollections(){for(let[e,t]of this._layersToLayerViews)this._populateLayerViewsOwners(z(this,e),z(this,t),this.view);this.notifyChange("updating"),this.notifyChange("updatingRemaining")}_populateLayerViewsOwners(e,t,i){if(!e||!t)return void(t&&t.removeAll());let r=0;for(let o of e){let l=this._layerLayerViewInfoMap.get(o);if(!l?.layerView)continue;let n=l.layerView;n.layer=o,n.parent=i,t.at(r)!==n&&t.splice(r,0,n),"layers"in o&&ft(n)&&this._populateLayerViewsOwners(o.layers,n.layerViews,n),r+=1}r<t.length&&t.splice(r,t.length)}_createLayerView(e){e.load().catch(()=>{}),this.layerViewImporter.hasLayerViewModule(e)&&this.layerViewImporter.importLayerView(e);let t=new ue(e,this.view,this.layerViewImporter);t.promise.then(()=>this._refreshCollections(),i=>{i&&(K(i)||i.name==="cancelled:layerview-create")||g.getLogger(this).error(`Failed to create layerview for layer title:'${e.title??"no title"}', id:'${e.id??"no id"}' of type '${e.type}'.`,{layer:e,error:i}),this._refreshCollections()}),this._layerLayerViewInfoMap.set(e,t),this.view.ready&&t.start(),this.notifyChange("updating"),this.notifyChange("updatingRemaining")}};a([s()],M.prototype,"_workPromise",void 0),a([s({readOnly:!0})],M.prototype,"_watchUpdatingTracking",void 0),a([s({readOnly:!0})],M.prototype,"_layersToLayerViews",null),a([s({readOnly:!0})],M.prototype,"_rootCollectionNames",null),a([s()],M.prototype,"layerViewImporter",void 0),a([s()],M.prototype,"supportsGround",void 0),a([s({readOnly:!0})],M.prototype,"updating",null),a([s({readOnly:!0})],M.prototype,"updatingRemaining",null),a([s({constructOnly:!0})],M.prototype,"view",void 0),M=a([m("esri.views.LayerViewManager")],M);var it=M;function gt(e){return e.createLayerView!==Ke.prototype.createLayerView}var S=class extends U.EventedAccessor{constructor(e){super(e),this._selectionMap=new Ie,this._sources=new y,this._trashCan=[],this._layerEditHandles=new y,this._vizTaskId=0,this.showHighlight=!0,this.highlightName="default"}initialize(){this.addHandles([_(()=>[this.view,this.showHighlight],()=>this._refreshVisualization()),B(()=>this.sources,"change",t=>{let i=this._selectionMap;for(let r of t.removed)i.delete(r);this._refreshListeners(),this._refreshVisualization()},{onListenerAdd:()=>this._refreshListeners()})]);let e=new y;this.view.when().then(()=>{this.view.map&&(this.view.map.allLayers.flatten(t=>"sublayers"in t&&t.sublayers?t.sublayers:null).forEach(t=>{(q(t)&&!je(t)||I(t))&&e.add(t)}),this.sources=e)})}destroy(){this._layerEditHandles.drain(C)}get selections(){return Array.from(this._selectionMap.entries()).map(e=>{let[t,i]=e;return{layer:t,selection:[...i.selection]}})}get count(){let e=0;for(let t of this._selectionMap.values())e+=t.selection.length;return e}get hasSelection(){return this.count>0}get sources(){return this._sources}set sources(e){J(e,this._sources)}getSelectedFeatures(r){return v(this,arguments,function*(e,t={},i="layerView"){let{view:o,selections:l}=this,n=(e!==void 0?l.filter(p=>e.includes(p.layer)):l).filter(p=>p.selection.length>0).map(p=>v(this,null,function*(){let{layer:h,selection:d}=p,w=I(h)?h.parent:h;if(w==null||!at(w))return null;if(i==="layer")return ot(w,d,t);if(rt(w))return null;let P=yield o.whenLayerView(w).catch(()=>null);return P?ot(P,d,t):null}));return(yield Promise.all(n)).filter(p=>p!=null)})}updateSelection(e){let t=new Map;for(let[o,l]of this._selectionMap)t.set(o,[...l.selection]);let i=!1,r=e.current.concat(e.added);for(let o of r){let l=o.sourceLayer,n=o.getObjectId();if(this.sources.includes(l)&&(q(l)||I(l))&&n!==null){let p=Re(t,l,()=>[]);p.includes(n)||(p.push(n),i=!0)}}for(let o of e.removed){let l=o.sourceLayer,n=o.getObjectId();if(this.sources.includes(l)&&(q(l)||I(l))&&n!==null){let p=t.get(l),h=p?.indexOf(n);h!==void 0&&h>=0&&(p?.splice(h,1),i=!0)}}if(i){let{_selectionMap:o,_trashCan:l}=this,n=[];for(let[p,h]of t){let d=o.get(p);d!==void 0&&l.push(d),o.set(p,{selection:h}),n.push(f({layer:p,selection:h},ee(d!==void 0?d.selection:[],h)))}this._onSelectionChange(n)}}setSelection(e,t){this._setSelection(e,t)}getSelection(e){return this._selectionMap.get(e)?.selection}appendToSelection(e,t){let i=this._selectionMap.get(e),r=i!==void 0?[...i.selection]:[];for(let o of t)r.includes(o)||r.push(o);this._setSelection(e,r)}removeFromSelection(e,t){let i=this._selectionMap.get(e);if(!i)return;let r=[];for(let o of i.selection)t.includes(o)||r.push(o);this._setSelection(e,r)}toggleInSelection(e,t){let i=this._selectionMap.get(e);if(!i||i.selection.length===0)return void this._setSelection(e,t);let r=new Set(i.selection),o=new Set(t),l=Se(r,o);this._setSelection(e,Array.from(l))}clear(){let e=this._selectionMap.values();this._trashCan.push(...e);let t=[];for(let[i,r]of this._selectionMap.entries())t.push({layer:i,added:[],removed:[...r.selection],selection:[]});this._selectionMap.clear(),this._onSelectionChange(t)}_onSelectionChange(e){this._refreshVisualization(),this.emit("selection-change",{view:this.view,changes:e})}_refreshVisualization(){if(this.view==null||this.sources==null)return;for(this._vizTaskId++;this._trashCan.length>0;)this._trashCan.pop()?.highlightHandle?.remove();let{sources:e,view:t,_selectionMap:i,showHighlight:r}=this,o=this._vizTaskId;for(let l of e){let n=i.get(l),p=I(l)?l.parent:l;if(p!=null&&at(p)){if(rt(p))continue;t.whenLayerView(p).then(h=>{n?.highlightHandle?.remove(),n!=null&&r&&o===this._vizTaskId&&"highlight"in h&&typeof h.highlight=="function"&&n.selection.length>0&&(n.highlightHandle=h.highlight(n.selection,this.highlightName))}).catch(()=>{n?.highlightHandle?.remove()})}}}_refreshListeners(){this._layerEditHandles.drain(C);for(let e of this.sources){let t=I(e)?e.parent:e;if(t!=null&&q(t)){let i=t.on("edits",r=>{this._handleEditChanges(r,e)});this._layerEditHandles.push(i)}}}_handleEditChanges(e,t){if(e.deletedFeatures!==void 0&&e.deletedFeatures.length>0&&this._selectionMap.has(t)){let i=e.deletedFeatures.filter(r=>r.error==null).map(r=>r.objectId).filter(we);this.removeFromSelection(t,i)}}_setSelection(e,t){if(!this.sources.includes(e))throw new Error(`Cannot set selection on layer ${e.title} because it is not in 'sources'`);let i=this._selectionMap.get(e);if(i===void 0||!_t(i,{selection:t})){i!==void 0&&this._trashCan.push(i),this._selectionMap.set(e,{selection:[...t]});let r=f({layer:e,selection:[...t]},ee(i!==void 0?i.selection:[],t));this._onSelectionChange([r])}}};a([s({readOnly:!0,nonNullable:!0})],S.prototype,"selections",null),a([s({readOnly:!0,nonNullable:!0})],S.prototype,"count",null),a([s({constructOnly:!0,nonNullable:!0})],S.prototype,"view",void 0),a([s({readOnly:!0,nonNullable:!0})],S.prototype,"hasSelection",null),a([s()],S.prototype,"showHighlight",void 0),a([s()],S.prototype,"sources",null),a([s()],S.prototype,"highlightName",void 0),S=a([m("esri.views.SelectionManager")],S);var rt=e=>I(e)?e.parent?.isTable===!0:e.isTable,mt=e=>e.layer!==void 0,at=e=>e?.when!==void 0,_t=(e,t)=>{if(e==null&&t==null)return!0;if(e!=null&&t==null||e==null&&t!=null)return!1;if(e!=null&&t!=null&&e.selection!=null&&t.selection!=null){let i=[...e.selection],r=[...t.selection];if(i.length!==r.length)return!1;i.sort(),r.sort();for(let o=0;o<i.length;o++)if(i[o]!==r[o])return!1}return!0},ot=(r,o,...l)=>v(void 0,[r,o,...l],function*(e,t,i={}){let n;if(mt(e)){let p=e;n=p===void 0?null:yield p.queryFeatures(new ne(T(f({},i),{objectIds:t}))).then(h=>({data:h,layer:e.layer}))}else{let p=e;n=p===void 0?null:yield p.queryFeatures(new ne(T(f({},i),{objectIds:t}))).then(h=>({data:h,layer:p}))}return n}),st=S;function nt(e){return[e.on("before-add",t=>{let i=t.item;if(i==null||e.includes(i))return g.getLogger("esri.views.interactive.interactiveToolUtils").warn("Tool is either already in the list of tools or tool is `null`. Not adding tool."),void t.preventDefault();i.onAdd()}),e.on("after-remove",t=>{let i=t.item;i.active&&(i.view.activeTool=null),i.destroy()})]}function N(e){return e.visible&&e.getEditableFlag!=null&&e.getEditableFlag(j.USER)&&e.getEditableFlag(j.MANAGER)}var Y=class{constructor(){this._pointerLocations=new Map,this._hoveredManipulators=new Map,this._grabbedManipulators=new Map,this._draggedManipulators=new Map,this._stopDrag=!1,this._externallyDragging=!1,this._revertToNullActiveTool=!1,this._cursor=null}get cursor(){return this._cursor}hasFocusedManipulators(){return this._grabbedManipulators.size>0||this._draggedManipulators.size>0}handleInputEvent(t,i){let r=()=>t.stopPropagation();switch(t.type){case"pointer-move":pt(t.pointerType)&&this._pointerLocations.set(t.pointerId,{x:t.x,y:t.y,pointerType:t.pointerType});break;case"drag":this._grabbedManipulators.size>0?this._stopDrag=!0:t.action==="start"?this._externallyDragging=!0:t.action==="end"&&(this._externallyDragging=!1),this._stopDrag&&(r(),t.action==="end"&&(this._stopDrag=!1));break;case"pointer-down":{if(!ht(t))break;let o=V(t),l=F(o,t.pointerType,i.forEachTool);if(l==null)break;let n=l.manipulator,p=l.tool;n==null||p==null||!n.interactive||n.grabbable&&n.grabbableForEvent(t)||!n.grabbing||n.dragging||this._releaseManipulatorBeforeDragging(n,t,i),n!=null&&p!=null&&n.interactive&&n.grabbable&&n.grabbableForEvent(t)&&!n.grabbing&&(this._grabbedManipulators.set(t.pointerId,{manipulator:n,tool:p,start:o,pointerType:t.pointerType}),this._grabbedManipulators.size===1&&i.activeTool==null&&(this._revertToNullActiveTool=!0,i.setActiveTool(l.tool)),n.grabbing=!0,n.events.emit("grab-changed",{action:"start",pointerType:t.pointerType,screenPoint:o}),r());break}case"pointer-up":this._draggedManipulators.has(t.pointerId)||this._handlePointerEnd(t,i);break;case"pointer-drag":{if(!ht(t))break;let o=this._grabbedManipulators.get(t.pointerId),l=o?.manipulator,n=o?.tool;if(l==null||n==null)break;let p=V(t);p.x=se(p.x,0,i.view.width),p.y=se(p.y,0,i.view.height);let h=o.start,d=this._draggedManipulators.get(t.pointerId);switch(t.action){case"start":case"update":t.action!=="update"&&this._grabbedManipulators.size!==1||(l.dragging=!0,d?l.events.emit("drag",{action:"update",start:h,screenPoint:p}):l.events.emit("drag",{action:"start",start:h,screenPoint:p,pointerType:t.pointerType}),this._draggedManipulators.set(t.pointerId,{tool:n,manipulator:l,start:h}));break;case"end":l.dragging=!1,d&&l.events.emit("drag",{action:"end",start:h,screenPoint:p}),this._draggedManipulators.delete(t.pointerId),this._handlePointerEnd(t,i)}r();break}case"immediate-click":{let o=V(t),l=F(o,t.pointerType,i.forEachTool);if(wt(t)||i.forEachTool(d=>{if((l==null||l.tool!==d||d.automaticManipulatorSelection)&&d.manipulators){let w=!1;d.manipulators.forEach(({manipulator:P})=>{P.selected&&(P.selected=!1,w=!0)}),w&&d.onManipulatorSelectionChanged&&d.onManipulatorSelectionChanged()}}),l==null)break;let{manipulator:n,tool:p}=l;if(!n.interactive)break;n.selectable&&p.automaticManipulatorSelection&&(n.selected=!n.selected,p.onManipulatorSelectionChanged&&p.onManipulatorSelectionChanged());let h=t.native.shiftKey;n.events.emit("immediate-click",{screenPoint:o,button:t.button,pointerType:t.pointerType,shiftKey:h,stopPropagation:r}),ye(n,r);break}case"click":{let o=V(t),l=F(o,t.pointerType,i.forEachTool),n=l?.manipulator;if(n==null||!n.interactive)break;let p=t.native.shiftKey;n.events.emit(t.type,{screenPoint:o,button:t.button,pointerType:t.pointerType,shiftKey:p}),r();break}case"double-click":{let o=V(t),l=F(o,t.pointerType,i.forEachTool),n=l!=null?l.manipulator:null;if(n==null||!n.interactive)break;let p=t.native.shiftKey;n.events.emit("double-click",{screenPoint:o,button:t.button,pointerType:t.pointerType,shiftKey:p,stopPropagation:r}),ye(n,r);break}case"immediate-double-click":{let o=V(t),l=F(o,t.pointerType,i.forEachTool),n=l!=null?l.manipulator:null;if(n==null||!n.interactive)break;let p=t.native.shiftKey;n.events.emit("immediate-double-click",{screenPoint:o,button:t.button,pointerType:t.pointerType,shiftKey:p,stopPropagation:r}),t.pointerType==="mouse"&&ye(n,r);break}}this._onFocusChange(i.forEachTool)}_releaseManipulatorBeforeDragging(t,i,r){t.grabbing=!1,t.events.emit("grab-changed",{action:"end",pointerType:i.pointerType,screenPoint:V(i)}),this._grabbedManipulators.forEach(({manipulator:o},l)=>{o===t&&this._grabbedManipulators.delete(l)}),this._afterManipulatorRelease(r.setActiveTool)}_handlePointerEnd(t,i){let r=this._grabbedManipulators.get(t.pointerId)?.manipulator;r!=null&&r.grabbing&&(r.grabbing=!1,r.events.emit("grab-changed",{action:"end",pointerType:t.pointerType,screenPoint:V(t)}),this._grabbedManipulators.delete(t.pointerId),this._afterManipulatorRelease(i.setActiveTool))}_onFocusChange(t){this._updateCursor(),this._updateFocusedManipulatorTools(t)}_updateCursor(){this._grabbedManipulators.size>0?this._cursor=lt(this._grabbedManipulators)||"grabbing":this._hoveredManipulators.size>0?this._cursor=lt(this._hoveredManipulators)||"pointer":this._cursor=null}_updateFocusedManipulatorTools(t){let i=new Set,r=new Set;this._grabbedManipulators.forEach(({tool:o})=>{i.add(o)}),this._hoveredManipulators.forEach(({tool:o})=>{r.add(o)}),t(o=>{o.hasGrabbedManipulators=i.has(o),o.hasHoveredManipulators=r.has(o);let l=this._grabbedManipulators.values(),n=ve(l,({tool:p})=>p===o);o.firstGrabbedManipulator=n!=null?n.manipulator:null})}clearPointers(t,{forEachTool:i,setActiveTool:r},o=!0,l){let n=(p,h)=>p===t&&(l==null||l===h);this._grabbedManipulators.forEach(({tool:p,manipulator:h,pointerType:d},w)=>{n(p,h)&&(this._grabbedManipulators.delete(w),h.grabbing=!1,h.events.emit("grab-changed",{action:"end",screenPoint:null,pointerType:d}))}),this._draggedManipulators.forEach(({tool:p,manipulator:h},d)=>{n(p,h)&&(this._draggedManipulators.delete(d),h.dragging=!1,h.events.emit("drag",{action:"cancel"}))}),o&&this._hoveredManipulators.forEach(({tool:p,manipulator:h},d)=>{n(p,h)&&(this._hoveredManipulators.delete(d),h.hovering=!1)}),this._afterManipulatorRelease(r),this._onFocusChange(i)}updateHoveredStateFromKnownPointers(t){this._pointerLocations.forEach((i,r)=>{this._updateHoveredStateForPointerAtScreenPosition(qe(i.x,i.y),r,i.pointerType,t)})}handleHoverEvent(t,i){let r=t.type;r!=="pointer-up"&&r!=="immediate-click"&&r!=="pointer-move"||!pt(t.pointerType)||(r!=="pointer-up"&&this._externallyDragging?this._clearHoveredManipulatorStates(t.pointerId):this._updateHoveredStateForPointerAtScreenPosition(V(t),t.pointerId,t.pointerType,i))}_updateHoveredStateForPointerAtScreenPosition(t,i,r,o){let l=F(t,r,o),n=this._hoveredManipulators.get(i)?.manipulator;l==null||l.manipulator.interactive||(l=null),l!=null&&n===l.manipulator||(n!=null&&(n.hovering=!1),l!=null?(l.manipulator.hovering=!0,this._hoveredManipulators.set(i,l)):this._hoveredManipulators.delete(i),this._onFocusChange(o))}_afterManipulatorRelease(t){this._grabbedManipulators.size===0&&this._revertToNullActiveTool&&(t(null),this._revertToNullActiveTool=!1)}_clearHoveredManipulatorStates(t){this._hoveredManipulators.forEach(({manipulator:i},r)=>{t===r&&(this._hoveredManipulators.delete(t),i.hovering=!1)})}};function lt(e){for(let{manipulator:t}of e.values())if(t!=null&&t.interactive){if(t.grabbing&&t.grabCursor)return t.grabCursor;if(t.cursor)return t.cursor}return null}function F(e,t,i){let r=null;return i(o=>{if(o.manipulators==null||!N(o))return!1;let l=o.manipulators.intersect(e,t);return l!=null&&(r={tool:o,manipulator:l},!0)}),r}function pt(e){return e==="mouse"}function ht(e){return e.pointerType!=="mouse"||e.button===0}function wt(e){return!!e.native.shiftKey}function ye(e,t){e?.consumesClicks&&t()}var ct="attached",fe="tools",vt=1e3,k=class extends b{constructor(e){super(e),this._updatingHandles=new x,this._clock=Te,this._manipulatorState=new Y,this.tools=new y,this.cursor=null,this._interacting=!1,this._interactingTimeout=vt,this._interactingTimeoutHandle=null,this._forEachTool=t=>{for(let i of this.tools.items)if(t(i))return}}initialize(){this.addHandles([this.view.on(Be,e=>{this._handleInputEvent(e)},$e.TOOL),...nt(this.tools),this.tools.on("before-add",({item:e})=>{this._updateToolEditableFlag(e)}),this.tools.on("before-remove",({item:e})=>{this._manipulatorState.clearPointers(e,this._manipulatorStateEventArgs),this._updateCursor()}),this.tools.on("change",()=>{this._refreshToolWatchers()})])}destroy(){this.activeTool=null,this.tools.drain(e=>e.destroy()),this._clearInteractingTimeout(),this._interacting=!1,this._updatingHandles.destroy()}get _manipulatorStateEventArgs(){return{forEachTool:this._forEachTool,activeTool:this.activeTool,setActiveTool:e=>{this.activeTool=e},view:this.view}}set activeTool(e){if(e!=null&&!this.view.ready)return void g.getLogger(this).error("Cannot set active tool while view is not ready.");if(e===this.activeTool)return;let t=this.activeTool;this._set("activeTool",e),t?.deactivate(),e?.activate(),this._removeIncompleteTools(e);for(let i of this.tools){this._updateToolEditableFlag(i);let r=N(i);this.activeTool!=null&&r||this._manipulatorState.clearPointers(i,this._manipulatorStateEventArgs,!r)}this._updateCursor()}get updating(){return this._updatingHandles.updating||this.tools.some(e=>e.updating)}get interacting(){return this._interacting}_clearInteractingTimeout(){this._interactingTimeoutHandle=C(this._interactingTimeoutHandle)}_startInteractingTimeout(){this._clearInteractingTimeout(),this._interactingTimeoutHandle=this._clock.setTimeout(()=>this._interacting=!1,this._interactingTimeout)}attach(){this.view.type==="3d"?this.addHandles([_(()=>{let{state:e}=this.view;return"camera"in e&&e.camera},()=>this._forEachManipulator(e=>e.onViewChange())),this.view.elevationProvider?.on("elevation-change",e=>this._forEachManipulator(t=>t.onElevationChange(e)))],ct):this.addHandles(_(()=>this.view.extent,()=>this._forEachManipulator(e=>e.onViewChange())))}detach(){this.activeTool=null,this.tools.removeAll(),this.removeHandles(ct),this._clearInteractingTimeout(),this._interacting=!1}_forEachManipulator(e){this._forEachTool(t=>{t.manipulators&&t.manipulators.forEach(({manipulator:i})=>e(i,t))})}_handleInputEvent(e){let t=!1,i=T(f({},e),{stopPropagation:()=>{t=!0,e.stopPropagation()}});this.activeTool!=null?this.activeTool.handleInputEvent&&this.activeTool.handleInputEvent(i):this._forEachTool(r=>{!t&&r.visible&&r.handleInputEvent(i)}),!t&&e.type==="key-down"&&e.key==="Escape"&&this.activeTool&&(e.stopPropagation(),this.activeTool=null),this._manipulatorState.handleInputEvent(i,this._manipulatorStateEventArgs),t||this.activeTool==null||this.activeTool.handleInputEventAfter(i),this._manipulatorState.handleHoverEvent(i,this._forEachTool),this._updateCursor(),e.type==="pointer-move"&&(this._manipulatorState.hasFocusedManipulators()||this.activeTool)&&(this._interacting=!0,this._startInteractingTimeout())}_refreshToolWatchers(){this.removeHandles(fe),this._forEachTool(e=>{if(e instanceof b){let t=_(()=>[e.cursor,e.visible,e.editable],()=>{N(e)||this._manipulatorState.clearPointers(e,this._manipulatorStateEventArgs),this._updateCursor()});this.addHandles(t,fe)}e.manipulators&&this.addHandles([e.manipulators.on("after-remove",t=>{this._manipulatorState.clearPointers(e,this._manipulatorStateEventArgs,!0,t.item.manipulator)}),e.manipulators.on("change",()=>{this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool),this._updateCursor()})],fe)}),this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool),this._updateCursor()}_updateToolEditableFlag(e){e.setEditableFlag?.(j.MANAGER,this.activeTool==null||e===this.activeTool)}_updateCursor(){let e=this._manipulatorState.cursor;e==null&&this._forEachTool(t=>!(t.cursor==null||!t.visible)&&(e=t.cursor,!0)),this._get("cursor")!==e&&this._set("cursor",e)}_removeIncompleteTools(e){this.tools.filter(t=>(e==null||t!==e)&&!t.created&&t.removeIncompleteOnCancel).forEach(t=>{this.tools.remove(t)})}get test(){}};a([s({constructOnly:!0,nonNullable:!0})],k.prototype,"view",void 0),a([s({value:null})],k.prototype,"activeTool",null),a([s({readOnly:!0,type:y})],k.prototype,"tools",void 0),a([s({readOnly:!0})],k.prototype,"cursor",void 0),a([s({readOnly:!0})],k.prototype,"updating",null),a([s()],k.prototype,"_interacting",void 0),a([s({readOnly:!0})],k.prototype,"interacting",null),k=a([m("esri.views.ToolViewManager")],k);function dt(){return new(y.ofType(L))([new L({name:Ne}),new L({name:We,color:ze})])}var u=class extends b{constructor(e){super(e),this.required={extent:!1,heightModelInfo:!1,tileInfo:!1},this.defaultSpatialReference=null,this.userSpatialReference=null,this.sourcePreloadCount=10,this.priorityCollection=null,this.requiresExtentInSpatialReference=!0,this.suspended=!1,this._projectExtentTask={task:null,input:null,output:null,spatialReference:null}}destroy(){this._projectExtentTask.task&&(this._projectExtentTask.task=H(this._projectExtentTask.task)),this._set("map",null)}get ready(){return!this._spatialReferenceTask.updating&&!this._tileInfoTask.updating&&!this._extentTask.updating}get heightModelInfoReady(){return!this._heightModelInfoTask.updating}get spatialReference(){return this.userSpatialReference??this._spatialReferenceTask.spatialReference}get extent(){return this._extentTask.extent}get heightModelInfo(){return this._heightModelInfoTask.heightModelInfo}get vcsWkid(){return this._heightModelInfoTask.vcsWkid}get latestVcsWkid(){return this._heightModelInfoTask.latestVcsWkid}get viewingMode(){return this.userSpatialReference==null||this.userSpatialReference.equals(this._spatialReferenceTask.spatialReference)?this._spatialReferenceTask.viewingMode:null}get tileInfo(){return this._tileInfoTask.tileInfo}get mapCollections(){let e=this.map?.(),t=[];return this.priorityCollection!=null&&t.push(this.priorityCollection),t.push({parent:e?.basemap,layers:e?.basemap?.baseLayers},{layers:e?.layers},{parent:e?.ground,layers:e?.ground?.layers},{parent:e?.basemap,layers:e?.basemap?.referenceLayers}),t}get _spatialReferenceTask(){if(this.suspended)return this._get("_spatialReferenceTask")??{updating:!1};let e;if(this._collectLayers(this.mapCollections,i=>{let r=this._getSupportedSpatialReferences(i);if(r.length>0){let o=this._narrowDownSpatialReferenceCandidates(e,r);o!=null&&(e=o)}return e?.length===1})&&e?.length!==1)return{updating:!0};let t=this._pickSpatialReferenceCandidate(e);return{spatialReference:t?.spatialReference??null,viewingMode:t?.viewingMode??null,updating:!1}}get _tileInfoTask(){if(!this.required.tileInfo)return this._get("_tileInfoTask")??{updating:!1};let e=this.map?.(),t=this.spatialReference;if(!t)return{updating:this._spatialReferenceTask.updating};let i,r=this._collectLayers([{parent:e?.basemap,layers:e?.basemap?.baseLayers},{layers:e?.layers}],o=>!(!("tileInfo"in o)||!o.tileInfo?.spatialReference.equals(t))&&(i=o,!0),o=>"tileInfo"in o);return i?{tileInfo:i.tileInfo,updating:!1}:{updating:r}}get _heightModelInfoTask(){if(!this.required.heightModelInfo||this.suspended&&this._get("_heightModelInfoTask")?.heightModelInfo)return this._get("_heightModelInfoTask")??{updating:!1};let e={},t=this._collectLayers(this.mapCollections,i=>{let r=Ye(i);return!!r&&(e={heightModelInfo:r,vcsWkid:i.spatialReference?.vcsWkid,latestVcsWkid:i.spatialReference?.latestVcsWkid},!0)},i=>et(i));return T(f({},e),{updating:t})}get _extentCandidatesTask(){if(this.suspended||!this.required.extent)return this._get("_extentCandidatesTask")??{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};let e=[],t=this._collectLayers(this.mapCollections,i=>{let r="fullExtents"in i&&i.fullExtents||(i.fullExtent!=null?[i.fullExtent]:[]),o=this.requiresExtentInSpatialReference?null:r[0],l=r.find(n=>n.spatialReference.equals(this.spatialReference))??o;if(l)return e.push({extent:l,layer:i}),!0;if(this._getSupportedSpatialReferences(i).length>0)for(let n of r)e.push({extent:n,layer:i});return!1});return{candidates:e,updating:t}}get _extentTask(){let{candidates:e,updating:t}=this._extentCandidatesTask;if(t)return{updating:t};if(e==null||e.length===0)return{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};let i=this._pickExtentCandidate(e),r=this.spatialReference;return i.extent.equals(this._projectExtentTask.input)&&r.equals(this._projectExtentTask.spatialReference)?{extent:this._projectExtentTask.output,updating:this._projectExtentTask.task!=null&&!this._projectExtentTask.task.finished}:(this._projectExtentTask.task!=null&&(this._projectExtentTask.task=H(this._projectExtentTask.task)),this._projectExtentTask={input:i.extent.clone(),output:null,spatialReference:r.clone(),task:$(o=>v(this,null,function*(){try{let l=yield tt(i.extent,r,"portalItem"in i.layer?i.layer.portalItem:void 0,o);this._projectExtentTask=T(f({},this._projectExtentTask),{task:null,output:l})}catch{if(be(o))return;this._projectExtentTask=T(f({},this._projectExtentTask),{task:null})}}))},{updating:!0})}_narrowDownSpatialReferenceCandidates(e,t){if(e==null)return t;let i=new Array;for(let r of e)for(let o of t){if(!r.spatialReference.equals(o.spatialReference))continue;let l=Mt(r.viewingMode,o.viewingMode);if(l!==!1){i.push({spatialReference:r.spatialReference,viewingMode:l});break}}return i.length>0?i:null}_pickSpatialReferenceCandidate(e){let t=this.defaultSpatialReference;return e==null||e.length<1?t?{spatialReference:t,viewingMode:null}:null:(t!=null&&e.length>1&&e.some(({spatialReference:i})=>i.equals(t))&&(e=e.filter(({spatialReference:i})=>i.equals(t))),e.length>1&&e.some(({viewingMode:i})=>i!==le.Local)&&(e=e.filter(({viewingMode:i})=>i!==le.Local)),e[0])}_getSupportedSpatialReferences(e){let t="supportedSpatialReferences"in e&&e.supportedSpatialReferences||(e.spatialReference?[e.spatialReference]:[]);if(t.length===0)return[];let i=[];for(let r of t){let o=this.getSpatialReferenceSupport(r,e);if(o!=null){let l=o.constraints??[{spatialReference:r,viewingMode:null}];for(let{spatialReference:n,viewingMode:p}of l)this.requiresExtentInSpatialReference&&this.userSpatialReference!=null&&!n.equals(this.userSpatialReference)||i.push({spatialReference:n,viewingMode:p})}}return i}_pickExtentCandidate(e){let t=this.spatialReference;return e.find(({extent:i})=>t.equals(i.spatialReference))||e[0]}_collectLayers(e,t,i=()=>!0){switch(this._loadMaybe(this.map?.())){case"loading":return!0;case"failed":return!1}let r=new ge(i,t);for(let o of e)if(this._collectCollection(o,r),r.done||r.preloading===this.sourcePreloadCount)break;return r.updating}_collectCollection(e,t){if(e.layers){switch(this._loadMaybe(e.parent)){case"loading":return t.updating=!0,void++t.preloading;case"failed":return}for(let i of e.layers)if(t.layerFilter(i)){switch(this._loadMaybe(i)){case"failed":continue;case"loading":t.updating=!0,++t.preloading;break;case"loaded":if(t.updating||(t.done=t.pushLayer(i)),t.done||t.preloading===this.sourcePreloadCount)break;"layers"in i&&this._collectCollection({layers:i.layers},t)}if(t.done||t.preloading===this.sourcePreloadCount)break}}}_loadMaybe(e){return e&&"loadStatus"in e&&e.loadStatus!=null?e.loadStatus==="not-loaded"?(e.load().catch(t=>{K(t)}),"loading"):e.loadStatus:"loaded"}};a([s()],u.prototype,"required",void 0),a([s({constructOnly:!0})],u.prototype,"map",void 0),a([s({constructOnly:!0})],u.prototype,"getSpatialReferenceSupport",void 0),a([s()],u.prototype,"defaultSpatialReference",void 0),a([s()],u.prototype,"userSpatialReference",void 0),a([s()],u.prototype,"sourcePreloadCount",void 0),a([s()],u.prototype,"priorityCollection",void 0),a([s()],u.prototype,"requiresExtentInSpatialReference",void 0),a([s()],u.prototype,"suspended",void 0),a([s({readOnly:!0})],u.prototype,"ready",null),a([s({readOnly:!0})],u.prototype,"heightModelInfoReady",null),a([s({readOnly:!0})],u.prototype,"spatialReference",null),a([s({readOnly:!0})],u.prototype,"extent",null),a([s({readOnly:!0})],u.prototype,"heightModelInfo",null),a([s({readOnly:!0})],u.prototype,"vcsWkid",null),a([s({readOnly:!0})],u.prototype,"latestVcsWkid",null),a([s({readOnly:!0})],u.prototype,"viewingMode",null),a([s({readOnly:!0})],u.prototype,"tileInfo",null),a([s({readOnly:!0})],u.prototype,"mapCollections",null),a([s({readOnly:!0})],u.prototype,"_spatialReferenceTask",null),a([s({readOnly:!0})],u.prototype,"_tileInfoTask",null),a([s({readOnly:!0})],u.prototype,"_heightModelInfoTask",null),a([s({readOnly:!0})],u.prototype,"_extentCandidatesTask",null),a([s()],u.prototype,"_extentTask",null),a([s()],u.prototype,"_projectExtentTask",void 0),u=a([m("esri.views.support.DefaultsFromMap")],u);var ge=class{constructor(t,i){this.layerFilter=t,this.pushLayer=i,this.preloading=-1,this.updating=!1,this.done=!1}};function Mt(e,t){return e!=null?t!=null?e===t&&e:e:t}var O=class extends b{constructor(e){super(e),this.featureTitleFields=!1,this.utilityNetworkFields=!1,this.globalIdField=!1}};a([s()],O.prototype,"featureTitleFields",void 0),a([s()],O.prototype,"utilityNetworkFields",void 0),a([s()],O.prototype,"globalIdField",void 0),O=a([m("esri.views.support.RequiredFieldsOptions")],O);var ut=O;var W,c=W=class extends U.EventedMixin(xe.EsriPromiseMixin(b)){constructor(e){super(e),this._userSpatialReference=null,this._cursor=null,this.handles=new Me,this.updatingHandles=new x,this.allLayerViews=new Ze({getCollections:()=>[this.basemapView?.baseLayerViews,this.groundView?.layerViews,this.layerViews,this.basemapView?.referenceLayerViews],getChildrenFunction:Tt}),this.groundView=null,this.basemapView=null,this.displayFilterEnabled=!0,this.fatalError=null,this.graphics=new he,this.analyses=new D,this.typeSpecificPreconditionsReady=!0,this.layerViews=new y,this.magnifier=new ce,this.padding={left:0,top:0,right:0,bottom:0},this.ready=!1,this._readyStateWaitingTask=null,this.supportsGround=!0,this.type=null,this.scale=null,this.updating=!1,this.initialExtentRequired=!0,this.input=new Xe,this.navigation=new de,this.layerViewManager=null,this.analysisViewManager=null,this.isHeightModelInfoRequired=!1,this.width=null,this.height=null,this.resizing=!1,this.suspended=!1,this.viewEvents=new Je(this),this.persistableViewModels=new y,this.requiredFieldsOptions=new ut,this._isValid=!1,this._readyCycleForced=!1,this._lockedSpatialReference=null,this._userTimeZone=null,this._lockedTimeZone=null,this._userTimeExtent=null,this._lockedTimeExtent=null,this.theme=null,this.handles.add(_(()=>this.preconditionsReady,t=>{let i=this.ready;if(t?(this._lockedSpatialReference=this.spatialReference,this._lockedTimeZone=this.timeZone,this._lockedTimeExtent=this.timeExtent,W.views.add(this)):(this._lockedSpatialReference=null,W.views.remove(this)),this.notifyChange("spatialReference"),!t&&i)this.toolViewManager?.detach(),this.analysisViewManager!=null&&this.analysisViewManager.detach(),this.layerViewManager?.clear(),this._teardown();else if(t&&!i){try{this._startup()}catch(r){return void queueMicrotask(()=>{this.fatalError=new E("startup-error",null,r)})}this.analysisViewManager!=null&&this.analysisViewManager.attach(),this.toolViewManager.attach()}},ae))}initialize(){this.addResolvingPromise(Promise.all([this.loadAsyncDependencies(),this.validate()]).then(()=>(this._isValid=!0,Fe(()=>this.ready)))),this.basemapView=new Qe({view:this}),this.layerViewManager=new it({view:this,layerViewImporter:{importLayerView:e=>this.importLayerView(e),hasLayerViewModule:e=>this.hasLayerViewModule(e)},supportsGround:this.supportsGround}),this.toolViewManager=new k({view:this}),this.selectionManager=new st({view:this}),this.addHandles([re(()=>this.readyState==="map-content-error"&&!this.spatialReference,()=>{g.getLogger(this).warn("#spatialReference","no spatial reference could be derived from the currently added map layers")}),_(()=>this.initialExtentRequired,e=>this.defaultsFromMap.required=T(f({},this.defaultsFromMap.required),{extent:e}),A),_(()=>this.ready,e=>{this.defaultsFromMap&&(this.defaultsFromMap.suspended=e,this.defaultsFromMap.userSpatialReference=e?this.spatialReference:this._userSpatialReference)},ae),_(()=>this._userSpatialReference,e=>{this.defaultsFromMap&&(this.defaultsFromMap.userSpatialReference=e)},A)])}destroy(){this.destroyed||(W.views.remove(this),this.viewEvents.destroy(),this.allLayerViews.destroy(),this.navigation&&(this.navigation.destroy(),this._set("navigation",null)),this.graphics=R(this.graphics),this.analyses=R(this.analyses),this.defaultsFromMap.destroy(),this._set("defaultsFromMap",null),R(this.analysisViewManager),this.toolViewManager=R(this.toolViewManager),this.layerViewManager=R(this.layerViewManager),this.selectionManager=R(this.selectionManager),this.basemapView=R(this.basemapView),this.groundView?.destroy(),this.layerViews?.forEach(e=>e.destroy()),this.layerViews.length=0,this.invalidate(),this._emitter.clear(),this.handles.destroy(),this.map=R(this.map),this.updatingHandles.destroy())}_startup(){this._set("ready",!0)}_teardown(){this._set("ready",!1)}whenReady(){return Promise.resolve(this)}toMap(){return g.getLogger(this).error("#toMap()","Not implemented on this instance of View"),null}get activeTool(){return this.toolViewManager?.activeTool}set activeTool(e){this.toolViewManager&&(this.toolViewManager.activeTool=e)}get animation(){return this._get("animation")}set animation(e){this._set("animation",e)}get center(){return null}get defaultsFromMapSettings(){return{}}get defaultsFromMap(){return new u(f({required:{tileInfo:!1,heightModelInfo:!1,extent:!1},map:()=>this.map,getSpatialReferenceSupport:(e,t)=>this.getSpatialReferenceSupport(e,t)},this.defaultsFromMapSettings))}get extent(){return this._get("extent")}set extent(e){this._set("extent",e)}get heightModelInfo(){return this.getDefaultHeightModelInfo()}get highlights(){return this._get("highlights")??dt()}set highlights(e){this._set("highlights",J(e,this._get("highlights"),y.ofType(L)))}get interacting(){return this.navigating}get navigating(){return!1}get preconditionsReady(){return!(this.fatalError||!this._isValid||this._readyCycleForced||!this.map||oe.isLoadable(this.map)&&!this.map.loaded||this.width===0||this.height===0||!this.spatialReference||!this._validateSpatialReference(this.spatialReference)||!this._lockedSpatialReference&&!this.defaultsFromMap?.ready||!this.typeSpecificPreconditionsReady)}get resolution(){return 0}set map(e){e!==this._get("map")&&(e?.destroyed&&(g.getLogger(this).warn("#map","The provided map is already destroyed",{map:e}),e=null),oe.isLoadable(e)&&e.load().catch(()=>{}),this.constructed&&!this.destroyed&&(this.forceReadyCycle(),this._lockedSpatialReference=null),this._set("map",e))}get readyState(){if(this.destroyed)return this._get("readyState");if(!this.map)return"missing-map";if("container"in this&&!this.container)return"missing-container";if(this.fatalError)return"rendering-error";if((this.defaultsFromMap?.ready??!1)&&!this.spatialReference){let e=!("loaded"in this.map)||this.map.loaded,t=this.map.ground.loaded,i=this.map.basemap?.loaded??!0;return e&&i&&t&&!this.map?.allLayers.length?"empty-map":(this._readyStateWaitingTask||(this._readyStateWaitingTask=$(r=>ke(_e("view-readyState-waiting-delay"),null,r)),this.addHandles(this._readyStateWaitingTask),this.addHandles(this._readyStateWaitingTask,"ready-state-task")),this._readyStateWaitingTask?.finished?"map-content-error":"loading")}return this._readyStateWaitingTask=H(this._readyStateWaitingTask),this.removeHandles("ready-state-task"),this.ready?"ready":"loading"}get spatialReference(){let e=this._userSpatialReference||this._lockedSpatialReference||this.getDefaultSpatialReference()||null;if(e&&this.defaultsFromMap?.required?.heightModelInfo){let t=e.clone();return t.vcsWkid=this.defaultsFromMap.vcsWkid,t.latestVcsWkid=this.defaultsFromMap.latestVcsWkid,t}return e}set spatialReference(e){let t=!Oe(e,this._get("spatialReference"));this._set("_userSpatialReference",e),t&&(this._set("spatialReference",e),this._spatialReferenceChanged(e))}_spatialReferenceChanged(e){}get stationary(){return!this.animation&&!this.navigating&&!this.resizing}get timeExtent(){return this._userTimeExtent??this._lockedTimeExtent??this.getDefaultTimeExtent()??null}set timeExtent(e){this._userTimeExtent=e}get timeZone(){return this._userTimeZone??this._lockedTimeZone??this.getDefaultTimeZone()??Ce}set timeZone(e){this._userTimeZone=e,Le(e)||g.getLogger(this).warn("#timeZone",`the parsed value '${e}' may not be a valid IANA time zone`)}get tools(){return this.toolViewManager?.tools}get initialExtent(){return this.defaultsFromMap?.extent}get cursor(){return this.toolViewManager?.cursor??this._cursor??"default"}set cursor(e){this._cursor=e,this.notifyChange("cursor")}get size(){return[this.width,this.height]}get effectiveTheme(){return this.theme??new X}whenLayerView(e){return this.layerViewManager?.whenLayerView(e)??Promise.reject()}getDefaultSpatialReference(){return this.defaultsFromMap?.spatialReference}getDefaultHeightModelInfo(){return(this.map&&"heightModelInfo"in this.map?this.map.heightModelInfo:void 0)??this.defaultsFromMap?.heightModelInfo??null}getDefaultTimeZone(){return null}getDefaultTimeExtent(){return null}importLayerView(e){throw new E("importLayerView() not implemented")}hasLayerViewModule(e){return!1}validate(){return v(this,null,function*(){})}loadAsyncDependencies(){return v(this,null,function*(){})}invalidate(){this._isValid=!1}getSpatialReferenceSupport(){return{constraints:null}}_validateSpatialReference(e){return this.getSpatialReferenceSupport(e)!=null}when(e,t){return this.isResolved()&&!this.ready&&g.getLogger(this).warn("#when()","Calling view.when() while the view is no longer ready but was already resolved once will resolve immediately. Use reactiveUtils.whenOnce(() => view.ready).then(...) instead."),super.when(e,t)}forceReadyCycle(){this.ready&&(re(()=>this.destroyed||this.preconditionsReady===!1,()=>this._readyCycleForced=!1,{once:!0}),this._readyCycleForced=!0)}addAndActivateTool(e){this.toolViewManager.tools.add(e),this.activeTool=e}tryFatalErrorRecovery(){this.fatalError=null}};c.views=new y,a([s()],c.prototype,"_userSpatialReference",void 0),a([s()],c.prototype,"activeTool",null),a([s({readOnly:!0})],c.prototype,"allLayerViews",void 0),a([s()],c.prototype,"groundView",void 0),a([s()],c.prototype,"animation",null),a([s()],c.prototype,"basemapView",void 0),a([s()],c.prototype,"center",null),a([s()],c.prototype,"defaultsFromMapSettings",null),a([s()],c.prototype,"defaultsFromMap",null),a([s()],c.prototype,"displayFilterEnabled",void 0),a([s()],c.prototype,"fatalError",void 0),a([s({type:He})],c.prototype,"extent",null),a([s(pe(he,"graphics"))],c.prototype,"graphics",void 0),a([s(pe(D,"analyses"))],c.prototype,"analyses",void 0),a([s({readOnly:!0,type:Ae})],c.prototype,"heightModelInfo",null),a([s({type:y.ofType(L)})],c.prototype,"highlights",null),a([s({readOnly:!0})],c.prototype,"interacting",null),a([s({readOnly:!0})],c.prototype,"navigating",null),a([s({readOnly:!0,dependsOn:["fatalError","_isValid","_readyCycleForced","map","map.loaded?","width","height","spatialReference","_lockedSpatialReference","defaultsFromMap.ready","typeSpecificPreconditionsReady"]})],c.prototype,"preconditionsReady",null),a([s({readOnly:!0})],c.prototype,"typeSpecificPreconditionsReady",void 0),a([s({type:y,readOnly:!0})],c.prototype,"layerViews",void 0),a([s()],c.prototype,"resolution",null),a([s({type:ce})],c.prototype,"magnifier",void 0),a([s({value:null,type:Ue})],c.prototype,"map",null),a([s()],c.prototype,"padding",void 0),a([s({readOnly:!0})],c.prototype,"ready",void 0),a([s()],c.prototype,"_readyStateWaitingTask",void 0),a([s({readOnly:!0})],c.prototype,"readyState",null),a([s({type:Pe})],c.prototype,"spatialReference",null),a([s()],c.prototype,"stationary",null),a([s({readOnly:!0})],c.prototype,"supportsGround",void 0),a([s({type:De})],c.prototype,"timeExtent",null),a([s({type:String,nonNullable:!0})],c.prototype,"timeZone",null),a([s()],c.prototype,"tools",null),a([s()],c.prototype,"toolViewManager",void 0),a([s({readOnly:!0})],c.prototype,"type",void 0),a([s({type:Number})],c.prototype,"scale",void 0),a([s({readOnly:!0})],c.prototype,"updating",void 0),a([s({readOnly:!0})],c.prototype,"initialExtentRequired",void 0),a([s({readOnly:!0})],c.prototype,"initialExtent",null),a([s()],c.prototype,"cursor",null),a([s({readOnly:!0})],c.prototype,"input",void 0),a([s({type:de,nonNullable:!0})],c.prototype,"navigation",void 0),a([s()],c.prototype,"layerViewManager",void 0),a([s()],c.prototype,"analysisViewManager",void 0),a([s()],c.prototype,"selectionManager",void 0),a([s()],c.prototype,"width",void 0),a([s()],c.prototype,"height",void 0),a([s({readOnly:!0})],c.prototype,"resizing",void 0),a([s({value:null,readOnly:!0})],c.prototype,"size",null),a([s({readOnly:!0})],c.prototype,"suspended",void 0),a([s({readOnly:!0})],c.prototype,"viewEvents",void 0),a([s({readOnly:!0})],c.prototype,"persistableViewModels",void 0),a([s()],c.prototype,"_isValid",void 0),a([s()],c.prototype,"_readyCycleForced",void 0),a([s()],c.prototype,"_lockedSpatialReference",void 0),a([s()],c.prototype,"_userTimeZone",void 0),a([s()],c.prototype,"_lockedTimeZone",void 0),a([s()],c.prototype,"_userTimeExtent",void 0),a([s()],c.prototype,"_lockedTimeExtent",void 0),a([s({type:X})],c.prototype,"theme",void 0),a([s({readOnly:!0,type:X})],c.prototype,"effectiveTheme",null),c=W=a([m("esri.views.View")],c);var me=globalThis.$arcgis;me&&!me.views&&Object.defineProperty(me,"views",{configurable:!1,enumerable:!0,writable:!1,value:c.views});var da=c;function Tt(e){return e.layerViews}export{D as a,da as b};
