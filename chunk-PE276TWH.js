import{d as B}from"./chunk-BMZ3PE5Y.js";import{a as ee}from"./chunk-EHG7JRYJ.js";import{a as _}from"./chunk-FNY6LFKI.js";import{a as W}from"./chunk-5ODXFRPI.js";import{a as G}from"./chunk-SMVNQSZ4.js";import{a as se}from"./chunk-Z2QGLRDB.js";import{a as te}from"./chunk-7IDFDPA3.js";import{a as X,c as Y}from"./chunk-VL2YL74P.js";import{a as Q}from"./chunk-P2AJD2R2.js";import{a as J}from"./chunk-QML26MQC.js";import{m as K}from"./chunk-N3HRYLNW.js";import{a as Z}from"./chunk-6OQYVEQJ.js";import{u as D,x as ie}from"./chunk-KALOJIUA.js";import{b as N}from"./chunk-KMMTNF7G.js";import{a as T}from"./chunk-MIS6QMFE.js";import{a as x}from"./chunk-DKGGDYJI.js";import{a as M}from"./chunk-PEW2PLAN.js";import{a as j}from"./chunk-CX5IFQZJ.js";import{a as L}from"./chunk-G4DZJMGT.js";import{a as k,b as H}from"./chunk-PVDFCTA4.js";import{a as O}from"./chunk-TG45K3WR.js";import{a as u}from"./chunk-QGVBCWUY.js";import{e as a}from"./chunk-NFIPKH6V.js";import{l as z}from"./chunk-5QEXLALV.js";import{e as $,j as A}from"./chunk-P6QFA5MM.js";import{b as C}from"./chunk-YOFFGXOB.js";import{g as P}from"./chunk-XRGPJ3QY.js";import{a as R}from"./chunk-6MRUJ2UW.js";import{b as p}from"./chunk-2LI2GKBQ.js";import{a as F,b as E,f as S}from"./chunk-VTHXE323.js";var w,re="esri.renderers.UniqueValueRenderer",c=()=>P.getLogger(re),le="uvInfos-watcher",oe="uvGroups-watcher",ae=",",fe=A(_);function de(e){let{field1:t,field2:s,field3:i,fieldDelimiter:l,uniqueValueInfos:o,valueExpression:n}=e,f=!(!t||!s);return[{classes:(o??[]).map(d=>{let{symbol:m,label:y,value:v,description:b}=d,[q,g,I]=f?v?.toString()?.split(l||"")||[]:[v],h=[];return(t||n)&&h.push(q),s&&h.push(g),i&&h.push(I),{symbol:m,label:y,values:[h],description:b}})}]}function V(e){return e!=null&&e!==""&&(typeof e!="string"||e.trim()!==""&&e.toLowerCase()!=="<null>")||(e=null),e+""}var r=w=class extends W(Q){constructor(e){super(e),this._valueInfoMap={},this._isDefaultSymbolDerived=!1,this._isInfosSource=null,this.type="unique-value",this.backgroundFillSymbol=null,this.orderByClassesEnabled=!1,this.valueExpressionTitle=null,this.legendOptions=null,this.defaultLabel=null,this.portal=null,this.styleOrigin=null,this.diff={uniqueValueInfos(t,s){if(!t&&!s)return;if(!t||!s)return{type:"complete",oldValue:t,newValue:s};let i=!1,l={type:"collection",added:[],removed:[],changed:[],unchanged:[]};for(let o=0;o<s.length;o++){let n=t.find(f=>f.value===s[o].value);n?B(n,s[o])?(l.changed.push({type:"complete",oldValue:n,newValue:s[o]}),i=!0):l.unchanged.push({oldValue:n,newValue:s[o]}):(l.added.push(s[o]),i=!0)}for(let o=0;o<t.length;o++)s.find(n=>n.value===t[o].value)||(l.removed.push(t[o]),i=!0);return i?l:void 0}},this._set("uniqueValueInfos",[]),this._set("uniqueValueGroups",[])}get _cache(){return{compiledFunc:null}}set field(e){this._set("field",e),this._updateFieldDelimiter(),this._updateUniqueValues()}castField(e){return e==null||typeof e=="function"?e:$(e)}writeField(e,t,s,i){typeof e=="string"?t[s]=e:i?.messages?i.messages.push(new C("property:unsupported","UniqueValueRenderer.field set to a function cannot be written to JSON")):c().error(".field: cannot write field to JSON since it's not a string value")}set field2(e){this._set("field2",e),this._updateFieldDelimiter(),this._updateUniqueValues()}set field3(e){this._set("field3",e),this._updateUniqueValues()}set valueExpression(e){this._set("valueExpression",e),this._updateUniqueValues()}set defaultSymbol(e){this._isDefaultSymbolDerived=!1,this._set("defaultSymbol",e)}set fieldDelimiter(e){this._set("fieldDelimiter",e),this._updateUniqueValues()}readPortal(e,t,s){return s.portal||x.getDefault()}readStyleOrigin(e,t,s){if(t.styleName)return Object.freeze({styleName:t.styleName});if(t.styleUrl){let i=k(t.styleUrl,s);return Object.freeze({styleUrl:i})}}writeStyleOrigin(e,t,s,i){e.styleName?t.styleName=e.styleName:e.styleUrl&&(t.styleUrl=H(e.styleUrl,i))}set uniqueValueGroups(e){this.styleOrigin?c().error("#uniqueValueGroups=","Cannot modify unique value groups of a UniqueValueRenderer created from a web style"):(this._set("uniqueValueGroups",e),this._updateInfosFromGroups(),this._isInfosSource=!1,this._watchUniqueValueGroups())}set uniqueValueInfos(e){this.styleOrigin?c().error("#uniqueValueInfos=","Cannot modify unique value infos of a UniqueValueRenderer created from a web style"):(this._set("uniqueValueInfos",e),this._updateValueInfoMap(),this._updateGroupsFromInfos(),this._isInfosSource=!0,this._watchUniqueValueInfos())}addUniqueValueInfo(e,t){if(this.styleOrigin)return void c().error("#addUniqueValueInfo()","Cannot modify unique value infos of a UniqueValueRenderer created from a web style");let s;s=typeof e=="object"?fe(e):new _({value:e,symbol:K(t)}),this.uniqueValueInfos?.push(s),this._valueInfoMap[V(s.value)]=s,this._updateGroupsFromInfos(),this._isInfosSource=!0,this._watchUniqueValueInfos()}removeUniqueValueInfo(e){if(this.styleOrigin)return void c().error("#removeUniqueValueInfo()","Cannot modify unique value infos of a UniqueValueRenderer created from a web style");let t=this.uniqueValueInfos;if(t)for(let s=0;s<t.length;s++){let i=t[s];if(String(i.value)===String(e)){delete this._valueInfoMap[V(e)],t.splice(s,1);break}}this._updateGroupsFromInfos(),this._isInfosSource=!0,this._watchUniqueValueInfos()}getUniqueValueInfo(e,t){return S(this,null,function*(){let s=t;return this.valueExpression&&t?.arcade==null&&(s=E(F({},s),{arcade:yield N()})),this._getUniqueValueInfo(e,s)})}getSymbol(e,t){return this.valueExpression&&t?.arcade==null?void c().error("#getSymbol()","Please use getSymbolAsync if valueExpression is used"):this._getUniqueValueInfo(e,t)?.symbol||this.defaultSymbol}getSymbolAsync(e,t){return S(this,null,function*(){let s=t;if(this.valueExpression&&s?.arcade==null){let l=yield N(),{arcadeUtils:o}=l;o.hasGeometryOperations(this.valueExpression)&&(yield o.enableGeometryOperations()),s=E(F({},s),{arcade:l})}return this._getUniqueValueInfo(e,s)?.symbol||this.defaultSymbol})}get symbols(){let e=[];for(let t of this.uniqueValueInfos??[])t.symbol&&e.push(t.symbol);return this.defaultSymbol&&e.push(this.defaultSymbol),e}getAttributeHash(){return this.visualVariables?.reduce((e,t)=>e+t.getAttributeHash(),"")??""}getMeshHash(){let e=JSON.stringify(this.backgroundFillSymbol),t=JSON.stringify(this.defaultSymbol),s=this.uniqueValueInfos?.reduce((i,l)=>i+l.getMeshHash(),"");return`${e}.${t}.${s}.${`${this.field}.${this.field2}.${this.field3}.${this.fieldDelimiter}`}.${this.valueExpression}`}clone(){let e=new w({field:this.field,field2:this.field2,field3:this.field3,defaultLabel:this.defaultLabel,defaultSymbol:p(this.defaultSymbol),orderByClassesEnabled:this.orderByClassesEnabled,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,fieldDelimiter:this.fieldDelimiter,visualVariables:p(this.visualVariables),legendOptions:p(this.legendOptions),authoringInfo:p(this.authoringInfo),backgroundFillSymbol:p(this.backgroundFillSymbol)});this._isDefaultSymbolDerived&&(e._isDefaultSymbolDerived=!0),e._set("portal",this.portal);let t=p(this.uniqueValueInfos),s=p(this.uniqueValueGroups);return this.styleOrigin&&(e._set("styleOrigin",Object.freeze(p(this.styleOrigin))),Object.freeze(t),Object.freeze(s)),e._set("uniqueValueInfos",t),e._updateValueInfoMap(),e._set("uniqueValueGroups",s),e._isInfosSource=this._isInfosSource,e._watchUniqueValueInfosAndGroups(),e}get arcadeRequired(){return this.arcadeRequiredForVisualVariables||!!this.valueExpression}collectRequiredFields(e,t){return S(this,null,function*(){let s=[this.collectVVRequiredFields(e,t),this.collectSymbolFields(e,t)];yield Promise.all(s)})}collectSymbolFields(e,t){return S(this,null,function*(){let s=[...this.symbols.map(i=>i.collectRequiredFields(e,t)),ie(e,t,this.valueExpression)];D(e,t,this.field),D(e,t,this.field2),D(e,t,this.field3),yield Promise.all(s)})}populateFromStyle(){return J(this.styleOrigin,{portal:this.portal}).then(e=>{let t=[];return this._valueInfoMap={},e?.data&&Array.isArray(e.data.items)&&e.data.items.forEach(s=>{let i=new Z({styleUrl:e.styleUrl,styleName:e.styleName,portal:this.portal,name:s.name});this.defaultSymbol||s.name!==e.data.defaultItem||(this.defaultSymbol=i,this._isDefaultSymbolDerived=!0);let l=new _({value:s.name,symbol:i});t.push(l),this._valueInfoMap[V(s.name)]=l}),this._set("uniqueValueInfos",Object.freeze(t)),this._updateGroupsFromInfos(!0),this._isInfosSource=null,this._watchUniqueValueInfos(),!this.defaultSymbol&&this.uniqueValueInfos?.length&&(this.defaultSymbol=this.uniqueValueInfos[0].symbol,this._isDefaultSymbolDerived=!0),this})}_updateFieldDelimiter(){this.field&&this.field2&&!this.fieldDelimiter&&this._set("fieldDelimiter",ae)}_updateUniqueValues(){this._isInfosSource!=null&&(this._isInfosSource?this._updateGroupsFromInfos():this._updateInfosFromGroups())}_updateValueInfoMap(){this._valueInfoMap={};let{uniqueValueInfos:e}=this;if(e)for(let t of e)this._valueInfoMap[V(t.value)]=t}_watchUniqueValueInfosAndGroups(){this._watchUniqueValueInfos(),this._watchUniqueValueGroups()}_watchUniqueValueInfos(){this.removeHandles(le);let{uniqueValueInfos:e}=this;if(e){let t=[];for(let s of e)t.push(O(()=>({symbol:s.symbol,value:s.value,label:s.label,description:s.description}),(i,l)=>{i!==l&&(this._updateGroupsFromInfos(),this._isInfosSource=!0)},{sync:!0}));this.addHandles(t,le)}}_watchUniqueValueGroups(){this.removeHandles(oe);let{uniqueValueGroups:e}=this;if(e){let t=[];for(let s of e){t.push(O(()=>({classes:s.classes}),(i,l)=>{i!==l&&(this._updateInfosFromGroups(),this._isInfosSource=!1)},{sync:!0}));for(let i of s.classes??[])t.push(O(()=>({symbol:i.symbol,values:i.values,label:i.label,description:i.description}),(l,o)=>{l!==o&&(this._updateInfosFromGroups(),this._isInfosSource=!1)},{sync:!0}))}this.addHandles(t,oe)}}_updateInfosFromGroups(){if(!this.uniqueValueGroups)return this._set("uniqueValueInfos",null),this._updateValueInfoMap(),void this._watchUniqueValueInfos();let e=[],{field:t,field2:s,field3:i,fieldDelimiter:l,uniqueValueGroups:o,valueExpression:n}=this;if(!t&&!n)return this._set("uniqueValueInfos",e),this._updateValueInfoMap(),void this._watchUniqueValueInfos();let f=!(!t||!s);for(let d of o)for(let m of d.classes??[]){let{symbol:y,label:v,values:b,description:q}=m;for(let g of b??[]){let{value:I,value2:h,value3:ue}=g,U=[I];s&&U.push(h),i&&U.push(ue);let ne=f?U.join(l||""):U[0]??void 0;e.push(new _({symbol:y,label:v,value:ne,description:q}))}}this._set("uniqueValueInfos",e),this._updateValueInfoMap(),this._watchUniqueValueInfos()}_updateGroupsFromInfos(e=!1){if(!this.uniqueValueInfos)return this._set("uniqueValueGroups",null),void this._watchUniqueValueGroups();let{field:t,field2:s,valueExpression:i,fieldDelimiter:l,uniqueValueInfos:o}=this;if(!t&&!i||!o.length)return this._set("uniqueValueGroups",[]),void this._watchUniqueValueGroups();let n=!(!t||!s),f=o.map(m=>{let{symbol:y,label:v,value:b,description:q}=m,[g,I,h]=n?b?.toString()?.split(l||"")||[]:[b];return new se({symbol:y,label:v,description:q,values:[new te({value:g,value2:I,value3:h})]})}),d=[new G({classes:f})];e&&Object.freeze(d),this._set("uniqueValueGroups",d),this._watchUniqueValueGroups()}_getUniqueValueInfo(e,t){return this.valueExpression?this._getUnqiueValueInfoForExpression(e,t):this._getUnqiueValueInfoForFields(e)}_getUnqiueValueInfoForExpression(e,t){let{viewingMode:s,scale:i,spatialReference:l,arcade:o,timeZone:n}=t??{},f=this._cache.compiledFunc,d=o.arcadeUtils;if(!f){let y=d.createSyntaxTree(this.valueExpression);f=d.createFunction(y),this._cache.compiledFunc=f}let m=d.executeFunction(f,d.createExecContext(e,d.getViewInfo({viewingMode:s,scale:i,spatialReference:l}),n));return this._valueInfoMap[V(m)]}_getUnqiueValueInfoForFields(e){let t=this.field,s=e.attributes,i;if(this.field2){let l=this.field2,o=this.field3,n=[];t&&n.push(s[t]),l&&n.push(s[l]),o&&n.push(s[o]),i=n.join(this.fieldDelimiter||"")}else t&&(i=s[t]);return this._valueInfoMap[V(i)]}static fromPortalStyle(e,t){let s=new w(t?.properties);s._set("styleOrigin",Object.freeze({styleName:e})),s._set("portal",t?.portal||x.getDefault());let i=s.populateFromStyle();return i.catch(l=>{c().error(`#fromPortalStyle('${e}'[, ...])`,"Failed to create unique value renderer from style name",l)}),i}static fromStyleUrl(e,t){let s=new w(t?.properties);s._set("styleOrigin",Object.freeze({styleUrl:e}));let i=s.populateFromStyle();return i.catch(l=>{c().error(`#fromStyleUrl('${e}'[, ...])`,"Failed to create unique value renderer from style URL",l)}),i}};u([a({readOnly:!0})],r.prototype,"_cache",null),u([T({uniqueValue:"unique-value"})],r.prototype,"type",void 0),u([a(Y)],r.prototype,"backgroundFillSymbol",void 0),u([a({value:null,json:{type:String,read:{source:"field1"},write:{target:"field1"}}})],r.prototype,"field",null),u([L("field")],r.prototype,"castField",null),u([j("field")],r.prototype,"writeField",null),u([a({type:String,value:null,json:{write:!0}})],r.prototype,"field2",null),u([a({type:String,value:null,json:{write:!0}})],r.prototype,"field3",null),u([a({type:Boolean,json:{name:"drawInClassOrder",default:!1,write:!0,origins:{"web-scene":{write:!1}}}})],r.prototype,"orderByClassesEnabled",void 0),u([a({type:String,value:null,json:{write:!0}})],r.prototype,"valueExpression",null),u([a({type:String,json:{write:!0}})],r.prototype,"valueExpressionTitle",void 0),u([a({type:ee,json:{write:!0}})],r.prototype,"legendOptions",void 0),u([a({type:String,json:{write:!0}})],r.prototype,"defaultLabel",void 0),u([a(R(F({},X),{json:{write:{overridePolicy(){return{enabled:!this._isDefaultSymbolDerived}}},origins:{"web-scene":{write:{overridePolicy(){return{enabled:!this._isDefaultSymbolDerived}}}}}}}))],r.prototype,"defaultSymbol",null),u([a({type:String,value:null,json:{write:!0}})],r.prototype,"fieldDelimiter",null),u([a({type:x,readOnly:!0})],r.prototype,"portal",void 0),u([M("portal",["styleName"])],r.prototype,"readPortal",null),u([a({readOnly:!0,json:{write:{enabled:!1,overridePolicy:()=>({enabled:!0})}}})],r.prototype,"styleOrigin",void 0),u([M("styleOrigin",["styleName","styleUrl"])],r.prototype,"readStyleOrigin",null),u([j("styleOrigin",{styleName:{type:String},styleUrl:{type:String}})],r.prototype,"writeStyleOrigin",null),u([a({type:[G],json:{read:{source:["uniqueValueGroups","uniqueValueInfos"],reader:(e,t,s)=>(t.uniqueValueGroups||de(t)).map(i=>G.fromJSON(i,s))},write:{overridePolicy(){return this.styleOrigin?{enabled:!1}:{enabled:!0}}}}})],r.prototype,"uniqueValueGroups",null),u([a({type:[_],json:{read:!1,write:{isRequired:!0,overridePolicy(){return this.styleOrigin?{enabled:!1}:{enabled:!0,isRequired:!0}}}}})],r.prototype,"uniqueValueInfos",null),r=w=u([z(re)],r);var ze=r;export{ze as a};
